"use strict";function wavParserWorker(a){a=a||window.Worker,this.url=this.getWorkerURL(),this.worker=new a(this.url)}function espsParserWorker(a){a=a||window.Worker,this.url=this.getWorkerURL(),this.worker=new a(this.url)}function textGridParserWorker(a){a=a||window.Worker,this.url=this.getWorkerURL(),this.worker=new a(this.url)}function spectroDrawingWorker(a){a=a||window.Worker,this.url=this.getWorkerURL(),this.worker=new a(this.url)}function ssffParserWorker(a){a=a||window.Worker,this.url=this.getWorkerURL(),this.worker=new a(this.url)}ArrayBuffer.prototype.subarray=function(a,b){for(var c=new ArrayBuffer(b),d=new Int8Array(c),e=new Int8Array(this),f=0;b>f;f++)d[f]=e[a+f];return c},angular.module("emuwebApp",["ui","ngAnimate","angular.filter","btford.markdown"]).config(["$locationProvider",function(a){a.html5Mode(!0)}]),angular.module("emuwebApp").service("ConfigProviderService",["$q","viewState",function(a,b){var c={};return c.vals={},c.design={},c.curDbConfig={},c.initDbConfig={},c.embeddedVals={audioGetUrl:"",labelGetUrl:"",labelType:"",fromUrlParams:!1},c.setDesign=function(a){angular.copy(a,c.design)},c.setVals=function(a){$.isEmptyObject(c.vals)?c.vals=a:angular.forEach(Object.keys(a),function(b){angular.isArray(c.vals[b])?(c.vals[b]=[],angular.forEach(a[b],function(a){c.vals[b].push(a)})):angular.forEach(Object.keys(a[b]),function(d){void 0!==c.vals[b][d]?c.vals[b][d]=a[b][d]:console.error("BAD ENTRY IN CONFIG! Key1: "+b+" key2: "+d)})})},c.getDelta=function(b){var d=a.defer(),e=c.getDeltas(b,c.initDbConfig);return d.resolve(e),d.promise},c.getDeltas=function(a,b){var d={};return angular.forEach(a,function(a,e){angular.equals(a,b[e])||(Array.isArray(a)?(d[e]=[],angular.copy(a,d[e])):"object"==typeof a?(d[e]={},d[e]=c.getDeltas(a,b[e])):"clear"!==e&&"openDemoDB"!==e&&"specSettings"!==e&&(d[e]=a))}),d},c.getSsffTrackConfig=function(a){var b;return void 0!==c.curDbConfig.ssffTrackDefinitions&&angular.forEach(c.curDbConfig.ssffTrackDefinitions,function(c){c.name===a&&(b=c)}),b},c.getLimsOfTrack=function(a){var d={};return angular.forEach(c.vals.perspectives[b.curPerspectiveIdx].signalCanvases.contourLims,function(b){b.ssffTrackName===a&&(d=b)}),d},c.getContourColorsOfTrack=function(a){var d;return angular.forEach(c.vals.perspectives[b.curPerspectiveIdx].signalCanvases.contourColors,function(b){b.ssffTrackName===a&&(d=b)}),d},c.getAssignment=function(a){var d={};return angular.forEach(c.vals.perspectives[b.curPerspectiveIdx].signalCanvases.assign,function(b){b.signalCanvasName===a&&(d=b)}),d},c.getLevelDefinition=function(a){var b={};return angular.forEach(c.curDbConfig.levelDefinitions,function(c){c.name===a&&(b=c)}),b},c.setPerspectivesOrder=function(a,b){void 0!==c.vals&&void 0!==c.vals.perspectives&&void 0!==c.vals.perspectives[a]&&void 0!==c.vals.perspectives[a].levelCanvases&&(c.vals.perspectives[a].levelCanvases.order=b)},c.getStrRep=function(a){var b;switch(a){case 8:b="BACKSPACE";break;case 9:b="TAB";break;case 13:b="ENTER";break;case 16:b="SHIFT";break;case 18:b="ALT";break;case 32:b="SPACE";break;case 37:b="←";break;case 39:b="→";break;case 38:b="↑";break;case 40:b="↓";break;case 42:b="+";break;case 43:b="+";break;case 45:b="-";break;case 95:b="-";break;default:b=String.fromCharCode(a)}return b},c}]),angular.module("emuwebApp").controller("MainController",["$scope","$rootScope","$log","$compile","$timeout","$q","$window","$document","$location","viewState","HistoryService","Iohandlerservice","Soundhandlerservice","ConfigProviderService","fontScaleService","Ssffdataservice","LevelService","Textgridparserservice","Espsparserservice","Binarydatamaniphelper","Wavparserservice","Ssffparserservice","Drawhelperservice","Validationservice","Appcachehandler","loadedMetaDataService","dbObjLoadSaveService","appStateService","DataService","modalService","browserDetector",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E){a.cps=n,a.hists=k,a.fontImage=o,a.levServ=q,a.dataServ=C,a.vs=j,a.ssffds=p,a.shs=m,a.dhs=w,a.wps=u,a.io=l,a.ach=y,a.lmds=z,a.connectBtnLabel="connect",a.tmp={},a.dbLoaded=!1,a.is2dCancasesHidden=!0,a.windowWidth=g.outerWidth,a.internalVars={},a.internalVars.showAboutHint=!1,a.ach.checkForNewVersion(),angular.element(g).bind("resize",function(){q.deleteEditArea(),j.setWindowWidth(g.outerWidth),j.hierarchyState.isShown()&&++j.hierarchyState.resize,a.$digest()}),angular.element(g).bind("keyup",function(b){(b.keyCode===n.vals.keyMappings.shift||b.keyCode===n.vals.keyMappings.alt)&&(k.addCurChangeObjToUndoStack(),a.$digest())}),angular.element(g).bind("blur",function(a){j.focusOnEmuWebApp=!1}),angular.element(h).bind("blur",function(a){j.focusOnEmuWebApp=!1}),angular.element(g).bind("focus",function(a){j.focusOnEmuWebApp=!0}),angular.element(h).bind("focus",function(a){j.focusOnEmuWebApp=!0}),window.onbeforeunload=function(){return""===n.embeddedVals.audioGetUrl&&z.getBundleList().length>0&&!n.vals.main.autoConnect?"Do you really wish to leave/reload the EMU-webApp? All unsaved changes will be lost...":void 0},a.$on("connectionDisrupted",function(a,b){B.resetToInitState()}),a.$on("resetToInitState",function(){a.loadDefaultConfig()}),a.$on("reloadToInitState",function(b,c){a.loadDefaultConfig(),j.url=c.url,j.somethingInProgressTxt="Connecting to server...",j.somethingInProgress=!0,l.wsH.initConnect(c.url).then(function(b){"error"===b.type?D.open("views/error.html","Could not connect to websocket server: "+c.url).then(function(){B.resetToInitState()}):a.handleConnectedToWSserver(c)})});var F=i.search();F.audioGetUrl&&F.labelGetUrl&&F.labelType&&(n.embeddedVals.audioGetUrl=F.audioGetUrl,n.embeddedVals.labelGetUrl=F.labelGetUrl,n.embeddedVals.labelType=F.labelType,n.embeddedVals.fromUrlParams=!0),a.loadFilesForEmbeddedApp=function(){n.embeddedVals.audioGetUrl&&(n.vals.activeButtons.openDemoDB=!1,l.httpGetPath(n.embeddedVals.audioGetUrl,"arraybuffer").then(function(a){j.showDropZone=!1;var b=n.embeddedVals.audioGetUrl;z.setCurBndlName(b.substr(0,b.lastIndexOf(".")).substr(b.lastIndexOf("/")+1,b.length)),j.getsubmenuOpen()&&j.toggleSubmenu(n.design.animation.period),j.somethingInProgressTxt="Loading DB config...",l.httpGetPath("configFiles/embedded_emuwebappConfig.json").then(function(b){j.curPerspectiveIdx=0,n.setVals(b.data.EMUwebAppConfig),delete b.data.EMUwebAppConfig;var c=x.validateJSO("emuwebappConfigSchema",n.vals);c===!0?(n.embeddedVals.fromUrlParams&&(n.vals.main.catchMouseForKeyBinding=!1),n.curDbConfig=b.data,c=x.validateJSO("DBconfigFileSchema",n.curDbConfig),c===!0?(j.somethingInProgress=!0,j.somethingInProgressTxt="Parsing WAV file...",u.parseWavArrBuf(a.data).then(function(a){var b=a;j.curViewPort.sS=0,j.curViewPort.eS=b.Data.length,j.resetSelect(),m.wavJSO=b,l.httpGetPath(n.embeddedVals.labelGetUrl,"utf-8").then(function(a){j.somethingInProgressTxt="Parsing "+n.embeddedVals.labelType+" file...",l.parseLabelFile(a.data,n.embeddedVals.labelGetUrl,"embeddedTextGrid",n.embeddedVals.labelType).then(function(a){var b=a;C.setData(b);var c=[],d=[];b.levels.forEach(function(a){c.push(a.name),d.push({name:a.name,type:a.type,attributeDefinitions:{name:a.name,type:"string"}})}),n.curDbConfig.levelDefinitions=d,j.setCurLevelAttrDefs(n.curDbConfig.levelDefinitions),n.vals.perspectives[j.curPerspectiveIdx].levelCanvases.order=c,j.somethingInProgressTxt="Done!",j.somethingInProgress=!1,j.setState("labeling")},function(a){D.open("views/error.html","Error parsing wav file: "+a.status.message)})},function(a){D.open("views/error.html","Could not get label file: "+n.embeddedVals.labelGetUrl+" ERROR "+JSON.stringify(a,null,4))})},function(a){D.open("views/error.html","Error parsing wav file: "+a.status.message)})):D.open("views/error.html","Error validating / checking DBconfig: "+JSON.stringify(c,null,4))):D.open("views/error.html","Error validating ConfigProviderService.vals (emuwebappConfig data) after applying changes of newly loaded config (most likely due to wrong entry...): "+JSON.stringify(c,null,4))},function(a){D.open("views/error.html","Could not get embedded_config.json: "+a)})},function(a){D.open("views/error.html","Could not get audio file:"+n.embeddedVals.audioGetUrl+" ERROR: "+JSON.stringify(a,null,4))}))},a.loadDefaultConfig=function(){j.somethingInProgress=!0,j.somethingInProgressTxt="Loading schema files",x.loadSchemas().then(function(b){x.setSchemas(b),l.httpGetDefaultDesign().success(function(b){n.setDesign(b),l.httpGetDefaultConfig().success(function(b){j.somethingInProgressTxt="Validating emuwebappConfig";var c=x.validateJSO("emuwebappConfigSchema",b);c===!0?(n.setVals(b),angular.copy(a.cps.vals,a.cps.initDbConfig),a.handleDefaultConfigLoaded(),a.loadFilesForEmbeddedApp(),a.checkIfToShowWelcomeModal(),j.somethingInProgress=!1):D.open("views/error.html","Error validating / checking emuwebappConfigSchema: "+JSON.stringify(c,null,4)).then(function(){B.resetToInitState()})}).error(function(a,b,c,d){D.open("views/error.html","Could not get defaultConfig for EMU-webApp:  status: "+b+" header: "+c+" config "+d).then(function(){B.resetToInitState()})})}).error(function(a,b,c,d){D.open("views/error.html","Could not get defaultConfig for EMU-webApp:  status: "+b+" header: "+c+" config "+d).then(function(){B.resetToInitState()})})},function(a){D.open("views/error.html","Error loading schema file: "+JSON.stringify(a,null,4)).then(function(){B.resetToInitState()})})},a.loadDefaultConfig(),a.checkIfToShowWelcomeModal=function(b){var c=localStorage.getItem("haveShownWelcomeModal");E.isBrowser.PhantomJS()||null!==c||(localStorage.setItem("haveShownWelcomeModal","true"),a.internalVars.showAboutHint=!0)},a.getCurBndlName=function(){return z.getCurBndlName()},a.handleDefaultConfigLoaded=function(){j.getsubmenuOpen()||j.toggleSubmenu(n.design.animation.period);var b=i.search();(n.vals.main.autoConnect||"true"===b.autoConnect)&&l.wsH.initConnect(n.vals.main.serverUrl).then(function(b){"error"===b.type?D.open("views/error.html","Could not connect to websocket server: "+n.vals.main.serverUrl):a.handleConnectedToWSserver({session:null,reload:null})}),j.setspectroSettings(n.vals.spectrogramSettings.windowSizeInSecs,n.vals.spectrogramSettings.rangeFrom,n.vals.spectrogramSettings.rangeTo,n.vals.spectrogramSettings.dynamicRange,n.vals.spectrogramSettings.window,n.vals.spectrogramSettings.drawHeatMapColors,n.vals.spectrogramSettings.preEmphasisFilterFactor,n.vals.spectrogramSettings.heatMapColorAnchors),j.setTransitionTime(n.design.animation.period)},a.handleConnectedToWSserver=function(b){var c=b.session,d=b.reload;j.showDropZone=!1,n.vals.main.comMode="WS",n.vals.activeButtons.openDemoDB=!1,j.somethingInProgress=!0,j.somethingInProgressTxt="Checking protocol...",l.getProtocol().then(function(b){"EMU-webApp-websocket-protocol"===b.protocol&&"0.0.2"===b.version?(j.somethingInProgressTxt="Checking user management...",l.getDoUserManagement().then(function(b){"NO"===b?a.innerHandleConnectedToWSserver({session:c,reload:d}):D.open("views/loginModal.html").then(function(b){b?a.innerHandleConnectedToWSserver({session:c,reload:d}):B.resetToInitState()})})):D.open("views/error.html","Could not connect to websocket server: "+n.vals.main.serverUrl+'. It does not speak the same protocol as this client. Its protocol answer was: "'+b.protocol+'" with the version: "'+b.version+'"').then(function(){B.resetToInitState()})})},a.innerHandleConnectedToWSserver=function(a){var b=a.session,c=a.reload;j.somethingInProgressTxt="Loading DB config...",l.httpGetDefaultDesign().success(function(a){n.setDesign(a),l.getDBconfigFile().then(function(a){j.curPerspectiveIdx=0,n.setVals(a.EMUwebAppConfig),delete a.EMUwebAppConfig;var d=x.validateJSO("emuwebappConfigSchema",n.vals);d===!0?(n.curDbConfig=a,j.setCurLevelAttrDefs(n.curDbConfig.levelDefinitions),d=x.validateJSO("DBconfigFileSchema",a),d===!0?(j.somethingInProgressTxt="Loading bundle list...",l.getBundleList().then(function(a){d=z.setBundleList(a),n.vals.activeButtons.clear=!0,n.vals.activeButtons.specSettings=!0,d===!0?(null===b&&(b=z.getBundleList()[0]),A.loadBundle(b),c&&z.openCollapseSession(b.session)):D.open("views/error.html","Error validating bundleList: "+JSON.stringify(d,null,4)).then(function(){B.resetToInitState()})})):D.open("views/error.html","Error validating / checking DBconfig: "+JSON.stringify(d,null,4)).then(function(){B.resetToInitState()})):D.open("views/error.html","Error validating ConfigProviderService.vals (emuwebappConfig data) after applying changes of newly loaded config (most likely due to wrong entry...): "+JSON.stringify(d,null,4)).then(function(){B.resetToInitState()})})})},a.toggleCollapseSession=function(b){a.uniqSessionList[b].collapsed=!a.uniqSessionList[b].collapsed},a.getEnlarge=function(a){var b=n.vals.perspectives[j.curPerspectiveIdx].signalCanvases.order.length,c=50;return-1==j.getenlarge()?"auto":1===b?"auto":2===b?j.getenlarge()==a?"70%":"27%":j.getenlarge()==a?c+"%":(95-c)/(b-1)+"%"},a.cursorInTextField=function(){j.setcursorInTextField(!0)},a.cursorOutOfTextField=function(){j.setcursorInTextField(!1)},a.addLevelSegBtnClick=function(){if(j.getPermission("addLevelSegBtnClick")){var a=0;void 0!==C.data.levels&&(a=C.data.levels.length);var b="levelNr"+a,c={items:[],name:b,type:"SEGMENT"};if(void 0===j.getCurAttrDef(b)){var d={name:b,type:"EVENT",attributeDefinitions:{name:b,type:"string"}};j.setCurLevelAttrDefs(d)}q.insertLevel(c,a,j.curPerspectiveIdx),k.addObjToUndoStack({type:"ANNOT",action:"INSERTLEVEL",level:c,id:a,curPerspectiveIdx:j.curPerspectiveIdx}),j.selectLevel(!1,n.vals.perspectives[j.curPerspectiveIdx].levelCanvases.order,q)}},a.addLevelPointBtnClick=function(){if(j.getPermission("addLevelPointBtnClick")){var a=0;void 0!==C.data.levels&&(a=C.data.levels.length);var b="levelNr"+a,c={items:[],name:b,type:"EVENT"};if(void 0===j.getCurAttrDef(b)){var d={name:b,type:"EVENT",attributeDefinitions:{name:b,type:"string"}};j.setCurLevelAttrDefs(d)}q.insertLevel(c,a,j.curPerspectiveIdx),k.addObjToUndoStack({type:"ANNOT",action:"INSERTLEVEL",level:c,id:a,curPerspectiveIdx:j.curPerspectiveIdx}),j.selectLevel(!1,n.vals.perspectives[j.curPerspectiveIdx].levelCanvases.order,q)}},a.renameSelLevelBtnClick=function(){j.getPermission("renameSelLevelBtnClick")&&(void 0!==j.getcurClickLevelName()?D.open("views/renameLevel.html",j.getcurClickLevelName()):D.open("views/error.html","Rename Error : Please choose a Level first !"))},a.downloadTextGridBtnClick=function(){j.getPermission("downloadTextGridBtnClick")&&r.asyncToTextGrid().then(function(a){a=a.replace(/\t/g,"    "),D.open("views/export.html",z.getCurBndl().name+".TextGrid",a)})},a.downloadAnnotationBtnClick=function(){j.getPermission("downloadAnnotationBtnClick")&&x.validateJSO("emuwebappConfigSchema",C.getData())&&D.open("views/export.html",z.getCurBndl().name+"_annot.json",angular.toJson(C.getData(),!0))},a.spectSettingsBtnClick=function(){j.getPermission("spectSettingsChange")&&D.open("views/spectSettings.html")},a.connectBtnClick=function(){j.getPermission("connectBtnClick")&&D.open("views/connectModal.html").then(function(b){b&&(j.somethingInProgressTxt="Connecting to server...",j.somethingInProgress=!0,j.url=b,l.wsH.initConnect(b).then(function(c){"error"===c.type?D.open("views/error.html","Could not connect to websocket server: "+b).then(function(){B.resetToInitState()}):a.handleConnectedToWSserver({session:null,reload:null})}))})},a.openDemoDBbtnClick=function(b){j.getPermission("openDemoBtnDBclick")&&(a.dropdown=!1,n.vals.activeButtons.openDemoDB=!1,z.setDemoDbName(b),j.showDropZone=!1,j.somethingInProgress=!0,j.setState("loadingSaving"),n.vals.main.comMode="DEMO",j.somethingInProgressTxt="Loading DB config...",l.httpGetDefaultDesign().success(function(a){n.setDesign(a),l.getDBconfigFile(b).then(function(a){var c=a.data;j.curPerspectiveIdx=0,n.setVals(c.EMUwebAppConfig),delete c.EMUwebAppConfig;var d=x.validateJSO("emuwebappConfigSchema",n.vals);d===!0?(n.curDbConfig=c,j.setCurLevelAttrDefs(n.curDbConfig.levelDefinitions),d=x.validateJSO("DBconfigFileSchema",n.curDbConfig),d===!0?(j.somethingInProgressTxt="Loading bundle list...",l.getBundleList(b).then(function(a){var b=a.data;z.setBundleList(b),n.vals.activeButtons.clear=!0,n.vals.activeButtons.specSettings=!0,A.loadBundle(z.getBundleList()[0])},function(a){D.open("views/error.html","Error loading bundle list of "+b+": "+a.data+" STATUS: "+a.status).then(function(){B.resetToInitState()})})):D.open("views/error.html","Error validating / checking DBconfig: "+JSON.stringify(d,null,4)).then(function(){B.resetToInitState()})):D.open("views/error.html","Error validating ConfigProviderService.vals (emuwebappConfig data) after applying changes of newly loaded config (most likely due to wrong entry...): "+JSON.stringify(d,null,4)).then(function(){B.resetToInitState()})},function(a){D.open("views/error.html","Error loading DB config of "+b+": "+a.data+" STATUS: "+a.status).then(function(){B.resetToInitState()})})}))},a.aboutBtnClick=function(){j.getPermission("aboutBtnClick")&&D.open("views/help.html")},a.showHierarchyBtnClick=function(){j.hierarchyState.isShown()||(j.hierarchyState.toggleHierarchy(),D.open("views/showHierarchyModal.html"))},a.showEditDBconfigBtnClick=function(){D.open("views/tabbed.html").then(function(b){b===!1||(x.validateJSO("emuwebappConfigSchema",b)?a.cps.getDelta(b).then(function(b){l.saveConfiguration(angular.toJson(b,!0)).then(function(b){0!==k.movesAwayFromLastSave&&"DEMO"!==n.vals.main.comMode?D.open("views/confirmModal.html","Do you wish to clear all loaded data and if connected disconnect from the server? CAUTION: YOU HAVE UNSAVED CHANGES! These will be lost if you confirm.").then(function(a){a&&B.reloadToInitState()}):B.reloadToInitState(a.lmds.getCurBndl())})}):D.open("views/error.html","Sorry, there were errors in your configuration."))})},a.clearBtnClick=function(){var a;a=0!==k.movesAwayFromLastSave&&"DEMO"!==n.vals.main.comMode?"Do you wish to clear all loaded data and if connected disconnect from the server? CAUTION: YOU HAVE UNSAVED CHANGES! These will be lost if you confirm.":"Do you wish to clear all loaded data and if connected disconnect from the server? You have NO unsaved changes so no changes will be lost.",D.open("views/confirmModal.html",a).then(function(a){a&&B.resetToInitState()})},a.cmdZoomAll=function(){j.getPermission("zoom")&&(q.deleteEditArea(),j.setViewPort(0,m.wavJSO.Data.length))},a.cmdZoomIn=function(){j.getPermission("zoom")&&(q.deleteEditArea(),j.zoomViewPort(!0))},a.cmdZoomOut=function(){j.getPermission("zoom")&&(q.deleteEditArea(),j.zoomViewPort(!1))},a.cmdZoomLeft=function(){j.getPermission("zoom")&&(q.deleteEditArea(),j.shiftViewPort(!1))},a.cmdZoomRight=function(){j.getPermission("zoom")&&(q.deleteEditArea(),j.shiftViewPort(!0))},a.cmdZoomSel=function(){j.getPermission("zoom")&&(q.deleteEditArea(),j.setViewPort(j.curViewPort.selectS,j.curViewPort.selectE))},a.cmdPlayView=function(){j.getPermission("playaudio")&&(m.playFromTo(j.curViewPort.sS,j.curViewPort.eS),j.animatePlayHead(j.curViewPort.sS,j.curViewPort.eS))},a.cmdPlaySel=function(){j.getPermission("playaudio")&&(m.playFromTo(j.curViewPort.selectS,j.curViewPort.selectE),j.animatePlayHead(j.curViewPort.selectS,j.curViewPort.selectE))},a.cmdPlayAll=function(){j.getPermission("playaudio")&&(m.playFromTo(0,m.wavJSO.Data.length),j.animatePlayHead(0,m.wavJSO.Data.length))},a.changePerspective=function(a){for(var b,c=0;c<n.vals.perspectives.length;c++)a.name===n.vals.perspectives[c].name&&(b=c);j.curPerspectiveIdx=b,j.setRightsubmenuOpen(!j.getRightsubmenuOpen())},a.getPerspectiveColor=function(a){var b;return b=-1===j.curPerspectiveIdx||a.name===n.vals.perspectives[j.curPerspectiveIdx].name?"emuwebapp-curSelPerspLi":"emuwebapp-perspLi"}}]),angular.module("emuwebApp").directive("level",["$timeout","$animate","viewState","ConfigProviderService","Drawhelperservice","HistoryService","fontScaleService","modalService","LevelService","loadedMetaDataService",function(a,b,c,d,e,f,g,h,i,j){return{templateUrl:"views/level.html",restrict:"E",scope:{level:"=",idx:"="},link:function(a,k,l){var m=k.find("canvas");a.open=l.open,a.vs=c,a.hists=f,a.cps=d,a.modal=h,a.lmds=j;var n=k.find("div");a.levelDef=d.getLevelDefinition(a.level.name),a.backgroundCanvas={background:d.design.color.lightGrey},a.$watch("vs.lastUpdate",function(b,c){b!=c&&a.redraw()}),a.$watch("vs.curViewPort",function(b,c){c.sS!==b.sS||c.eS!==b.eS||c.windowWidth!==b.windowWidth?(a.drawLevelDetails(),a.drawLevelMarkup()):a.drawLevelMarkup()},!0),a.$watch("vs.curMouseX",function(b,c){a.vs.getcurMouseLevelName()===a.level.name&&(a.drawLevelDetails(),a.drawLevelMarkup())},!0),a.$watch("vs.curClickLevelName",function(b,c){void 0!==b&&a.drawLevelMarkup()},!0),a.$watch("vs.movingBoundarySample",function(){a.level.name===a.vs.curMouseLevelName&&a.drawLevelDetails(),a.drawLevelMarkup()},!0),a.$watch("vs.movingBoundary",function(){a.drawLevelMarkup()},!0),a.$watch("hists.movesAwayFromLastSave",function(){a.drawLevelDetails(),a.drawLevelMarkup()},!0),a.$watch("lmds.getCurBndl()",function(b,c){(b.name!==c.name||b.session!==c.session)&&(a.drawLevelDetails(),a.drawLevelMarkup())},!0),a.redraw=function(){a.drawLevelDetails(),a.drawLevelMarkup()},a.changeCurAttrDef=function(c,d){var e=a.vs.getCurAttrDef(a.level.name);e!==c&&(a.vs.setCurAttrDef(a.level.name,c,d),k.hasClass("emuwebapp-level-animation")||(a.vs.setEditing(!1),i.deleteEditArea(),b.addClass(n,"emuwebapp-level-animation").then(function(){b.removeClass(n,"emuwebapp-level-animation"),a.drawLevelDetails(),a.drawLevelMarkup()})))},a.getAttrDefBtnColor=function(b){var c,d=a.vs.getCurAttrDef(a.level.name);return c=b===d?{background:"-webkit-radial-gradient(50% 50%, closest-corner, rgba(0, 0, 0, 1), rgba(0, 0, 0, 0) 60%)"}:{"background-color":"white"}},a.updateView=function(){$.isEmptyObject(a.cps)||a.drawLevelDetails()},k.bind("mouseleave",function(){a.vs.setcurMouseItem(void 0,void 0,void 0),a.drawLevelMarkup()}),a.drawLevelDetails=function(){var b=1*d.design.font.small.size.slice(0,-2),c=a.vs.getCurAttrDef(a.level.name),e="25px"===k.parent().css("height")?!1:!0;if(!$.isEmptyObject(a.level)&&!$.isEmptyObject(a.vs)&&!$.isEmptyObject(a.cps)){var f=m[0].getContext("2d");f.clearRect(0,0,m[0].width,m[0].height);var h,i,j;h=a.vs.getSampleDist(m[0].width);var l=f.canvas.height/f.canvas.offsetHeight;a.level.name===c?e?g.drawUndistortedTextTwoLines(f,a.level.name,"("+a.level.type+")",b,d.design.font.small.family,4,f.canvas.height/2-b*l,d.design.color.black,!0):(b-=2,g.drawUndistortedText(f,a.level.name,b,d.design.font.small.family,4,f.canvas.height/2-b*l/2,d.design.color.black)):g.drawUndistortedTextTwoLines(f,a.level.name+":"+c,"("+a.level.type+")",b,d.design.font.small.family,4,f.canvas.height/2-b*l,d.design.color.black,!0);var n=(a.vs.getcurMouseItem(),a.vs.getcurClickItems(),a.vs.getcurClickLevelName(),-1),o=f.measureText("m").width*g.scaleX,p=f.measureText("0").width*g.scaleX;if("SEGMENT"===a.level.type){f.fillStyle=d.design.color.black;var q=a.level.items;q.forEach(function(h){if(++n,h.sampleStart>=a.vs.curViewPort.sS&&h.sampleStart<=a.vs.curViewPort.eS||h.sampleStart+h.sampleDur>a.vs.curViewPort.sS&&h.sampleStart+h.sampleDur<a.vs.curViewPort.eS||h.sampleStart<a.vs.curViewPort.sS&&h.sampleStart+h.sampleDur>a.vs.curViewPort.eS){var k;if(h.labels.forEach(function(a){a.name===c&&(k=a.value)}),i=a.vs.getPos(m[0].width,h.sampleStart),j=a.vs.getPos(m[0].width,h.sampleStart+h.sampleDur+1),f.fillStyle=d.design.color.black,f.fillRect(i,0,2,m[0].height/2),f.fillStyle=d.design.color.grey,f.fillRect(j,m[0].height/2,2,m[0].height),f.font=b-2+"px "+d.design.font.small.family,void 0!==k&&j-i>o*k.length&&(e?g.drawUndistortedText(f,k,b-2,d.design.font.small.family,i+(j-i)/2-f.measureText(k).width/2-2,m[0].height/2-(b-2)+2,d.design.color.black):g.drawUndistortedText(f,k,b-2,d.design.font.small.family,i+(j-i)/2-f.measureText(k).width/2-2,m[0].height/2-b+2,d.design.color.black)),a.open&&void 0!==k&&0!==k.length){var l=i+(j-i)/2,q=m[0].height/4;f.strokeStyle=d.design.color.black,f.beginPath(),f.moveTo(i,q),f.lineTo(l,q),f.lineTo(l,q+5),f.stroke(),q=m[0].height/4*3,f.strokeStyle=d.design.color.grey,f.beginPath(),f.moveTo(j,q),f.lineTo(l,q),f.lineTo(l,q-5),f.stroke()}j-i>p*h.sampleStart.toString().length&&e&&g.drawUndistortedText(f,h.sampleStart,b-2,d.design.font.small.family,i+3,0,d.design.color.grey);var r="dur: "+h.sampleDur+" ";j-i>p*r.length&&e&&g.drawUndistortedText(f,r,b-2,d.design.font.small.family,j-f.measureText(r).width*g.scaleX,m[0].height/4*3,d.design.color.grey)}})}else if("EVENT"===a.level.type){f.fillStyle=d.design.color.black;var r;a.level.items.forEach(function(i){if(i.samplePoint>a.vs.curViewPort.sS&&i.samplePoint<a.vs.curViewPort.eS){r=Math.round(a.vs.getPos(m[0].width,i.samplePoint)+h/2);var j;i.labels.forEach(function(a){a.name===c&&(j=a.value)}),f.fillStyle=d.design.color.black,f.fillRect(r,0,1,m[0].height/2-m[0].height/10),f.fillRect(r,m[0].height/2+m[0].height/10,1,m[0].height/2-m[0].height/10),g.drawUndistortedText(f,j,b-2,d.design.font.small.family,r-5,m[0].height/3,d.design.color.black),e&&g.drawUndistortedText(f,i.samplePoint,b-2,d.design.font.small.family,r+5,0,d.design.color.grey)}})}}},a.drawLevelMarkup=function(){var b=m[1].getContext("2d");b.clearRect(0,0,m[1].width,m[1].height),a.level.name===a.vs.getcurClickLevelName()&&(b.fillStyle=d.design.color.transparent.grey,b.fillRect(0,0,m[0].width,m[0].height)),e.drawMovingBoundaryLine(b),e.drawCurViewPortSelected(b);var c,f,g,h,i;c=a.vs.getPos(m[1].width,a.vs.curViewPort.selectS),f=a.vs.getPos(m[1].width,a.vs.curViewPort.selectE),g=a.vs.getSampleDist(m[1].width);var j=a.vs.getcurMouseItem(),k=a.vs.getcurMouseisFirst(),l=a.vs.getcurMouseisLast(),n=a.vs.getcurClickItems(),o=a.vs.getcurClickLevelName();void 0!==n&&a.level.name===o&&n.length>0&&n.forEach(function(e){void 0!==e&&(void 0!==e.sampleStart?(c=Math.round(a.vs.getPos(m[0].width,e.sampleStart)),f=Math.round(a.vs.getPos(m[0].width,e.sampleStart+e.sampleDur+1))):(c=Math.round(a.vs.getPos(m[0].width,e.samplePoint)+g/2),c-=5,f=c+10),b.fillStyle=d.design.color.transparent.yellow,b.fillRect(c,0,f-c,m[0].height),b.fillStyle=d.design.color.black)}),i=a.vs.getcurMouseItem(),a.level.items.length>0&&void 0!==i&&void 0!==j&&a.level.name===a.vs.getcurMouseLevelName()&&(b.fillStyle=d.design.color.blue,k===!0?"SEGMENT"===a.vs.getcurMouseLevelType()&&(i=a.level.items[0],c=Math.round(a.vs.getPos(m[1].width,i.sampleStart)),b.fillRect(c,0,3,m[1].height)):l===!0?"SEGMENT"===a.vs.getcurMouseLevelType()&&(i=a.level.items[a.level.items.length-1],c=Math.round(a.vs.getPos(m[1].width,i.sampleStart+i.sampleDur+1)),b.fillRect(c,0,3,m[1].height)):"SEGMENT"===a.vs.getcurMouseLevelType()?(c=Math.round(a.vs.getPos(m[1].width,i.sampleStart)),b.fillRect(c,0,3,m[1].height)):(c=Math.round(a.vs.getPos(m[1].width,i.samplePoint)),h=g/2,b.fillRect(c+h,0,3,m[1].height)),b.fillStyle=d.design.color.black)}}}}]),angular.module("emuwebApp").directive("osci",["$timeout","viewState","Soundhandlerservice","ConfigProviderService","Drawhelperservice","loadedMetaDataService",function(a,b,c,d,e,f){return{templateUrl:"views/osci.html",replace:!0,restrict:"E",scope:{},controller:["$scope",function(a){a.changeAttrDef=function(){}}],link:function(g,h,i){var j=h.find("canvas").length,k=h.find("canvas")[0],l=h.find("canvas")[j-1];g.order=i.order,g.trackName=i.trackName,g.cps=d,g.viewState=b,g.lmds=f,g.$watch("viewState.lastUpdate",function(a,b){a!=b&&g.drawVpOsciMarkup(g,d,!0)}),g.$watch("viewState.timelineSize",function(){a(g.redraw,d.design.animation.duration)}),g.$watch("viewState.curPerspectiveIdx",function(){g.drawVpOsciMarkup(g,d,!0)},!0),g.$watch("viewState.playHeadAnimationInfos",function(){$.isEmptyObject(c)||$.isEmptyObject(c.wavJSO)||g.drawPlayHead(g,d)},!0),g.$watch("viewState.movingBoundarySample",function(a){$.isEmptyObject(c)||$.isEmptyObject(c.wavJSO)||g.drawVpOsciMarkup(g,d,!0)},!0),g.$watch("viewState.movingBoundary",function(){$.isEmptyObject(c)||$.isEmptyObject(c.wavJSO)||g.drawVpOsciMarkup(g,d,!0)},!0),g.$watch("viewState.curViewPort",function(a,f){if(!$.isEmptyObject(c)&&!$.isEmptyObject(c.wavJSO)){if(f.sS!==a.sS||f.eS!==a.eS){var h=e.calculatePeaks(b,k,c.wavJSO.Data);e.osciPeaks=h,e.freshRedrawDrawOsciOnCanvas(b,k,e.osciPeaks,c.wavJSO.Data,d)}g.drawVpOsciMarkup(g,d,!0)}},!0),g.$watch("lmds.getCurBndl()",function(a,f){if(a.name!==f.name||a.session!==f.session){var g=e.calculatePeaks(b,k,c.wavJSO.Data);e.osciPeaks=g,e.freshRedrawDrawOsciOnCanvas(b,k,e.osciPeaks,c.wavJSO.Data,d)}},!0),g.redraw=function(){g.drawVpOsciMarkup(g,d,!0)},g.drawPlayHead=function(a,c){var e=l.getContext("2d");e.clearRect(0,0,k.width,k.height);var f=b.getPos(l.width,b.playHeadAnimationInfos.sS),g=b.getPos(l.width,b.playHeadAnimationInfos.curS);e.fillStyle=d.design.color.transparent.grey,e.fillRect(f,0,g-f,k.height),a.drawVpOsciMarkup(a,c,!1)},g.drawVpOsciMarkup=function(a,b,c){var d=l.getContext("2d");c&&d.clearRect(0,0,l.width,l.height),e.drawMovingBoundaryLine(d),e.drawViewPortTimes(d,!0),e.drawCurViewPortSelected(d,!0)}}}}]),angular.module("emuwebApp").directive("preview",["viewState","Soundhandlerservice","Drawhelperservice","ConfigProviderService",function(a,b,c,d){return{templateUrl:"views/preview.html",restrict:"E",scope:{currentBundleName:"@"},link:function(e,f){var g=f.find("canvas")[0],h=f.find("canvas")[1],i=!1;e.vs=a,e.shs=b,e.backgroundCanvas={background:"#eee",border:"1px solid gray",width:"100%",height:"100%"},e.$watch("vs.curViewPort",function(a,c){$.isEmptyObject(b.wavJSO)||(c.sS!==a.sS||c.eS!==a.eS)&&e.drawPreview()},!0),e.$watch("currentBundleName",function(){if($.isEmptyObject(b.wavJSO)||(i=!1,e.backgroundCanvas={background:d.design.color.lightGrey,border:"1px solid gray",width:"100%",height:"100%"},e.drawPreview()),""===e.currentBundleName){var a=g.getContext("2d"),c=h.getContext("2d");a.clearRect(0,0,g.width,g.height),c.clearRect(0,0,g.width,g.height)}},!0),e.drawPreview=function(){if(i)e.drawVpOsciMarkup(a,g,d);else{var f=c.calculatePeaks(a,g,b.wavJSO.Data);c.osciPeaks=f,c.freshRedrawDrawOsciOnCanvas(a,g,c.osciPeaks,b.wavJSO.Data,d),i=!0,e.drawVpOsciMarkup(a,g,d)}},e.drawVpOsciMarkup=function(a,c,e){var f=h.getContext("2d"),g=h.width/b.wavJSO.Data.length*a.curViewPort.sS,i=h.width/b.wavJSO.Data.length*a.curViewPort.eS;f.clearRect(0,0,h.width,h.height),f.fillStyle=d.design.color.transparent.grey,f.fillRect(g,0,i-g,h.height),f.strokeStyle=d.design.color.transparent.black,f.beginPath(),f.moveTo(g,0),f.lineTo(g,h.height),f.moveTo(i,0),f.lineTo(i,h.height),f.closePath(),f.stroke()}}}}]),angular.module("emuwebApp").directive("bundleListSideBar",["HistoryService",function(a){return{templateUrl:"views/bundleListSideBar.html",restrict:"E",replace:!0,scope:{},link:function(b,c,d){b.comment="",b.finishedEditing=function(b,c,d){a.addObjToUndoStack({type:"WEBAPP",action:"FINISHED",finished:b,key:c,index:d})},b.updateHistory=function(c,d,e){a.updateCurChangeObj({type:"WEBAPP",action:"COMMENT",initial:b.comment,comment:c.comment,key:d,index:e})},b.endHistory=function(){a.addCurChangeObjToUndoStack()},b.startHistory=function(a){b.comment=a.comment}}}}]),angular.module("emuwebApp").directive("spectro",["$timeout","viewState","ConfigProviderService","Drawhelperservice","fontScaleService","Soundhandlerservice","mathHelperService","loadedMetaDataService",function(a,b,c,d,e,f,g,h){return{templateUrl:"views/spectro.html",restrict:"E",replace:!0,scope:{},link:function(i,j,k){i.shs=f,i.order=k.order,i.vs=b,i.cps=c,i.dhs=d,i.lmds=h,i.trackName=k.trackName,i.canvas0=j.find("canvas")[0],i.canvas1=j.find("canvas")[j.find("canvas").length-1],i.context=i.canvas0.getContext("2d"),i.markupCtx=i.canvas1.getContext("2d"),i.alpha=.16,i.devicePixelRatio=window.devicePixelRatio||1,i.primeWorker=new spectroDrawingWorker,i.$watch("vs.timelineSize",function(){$.isEmptyObject(i.shs)||$.isEmptyObject(i.shs.wavJSO)||a(i.clearAndDrawSpectMarkup,c.design.animation.duration)}),i.$watch("viewState.lastUpdate",function(a,b){a==b||$.isEmptyObject(i.shs)||$.isEmptyObject(i.shs.wavJSO)||i.clearAndDrawSpectMarkup();
}),i.$watch("vs.submenuOpen",function(){$.isEmptyObject(i.shs)||$.isEmptyObject(i.shs.wavJSO)||a(i.clearAndDrawSpectMarkup,c.design.animation.duration)}),i.$watch("vs.curViewPort",function(a,b){$.isEmptyObject(i.shs)||$.isEmptyObject(i.shs.wavJSO)||((b.sS!==a.sS||b.eS!==a.eS)&&i.redraw(),i.clearAndDrawSpectMarkup())},!0),i.$watch("vs.movingBoundarySample",function(){$.isEmptyObject(i.shs)||$.isEmptyObject(i.shs.wavJSO)||i.clearAndDrawSpectMarkup()},!0),i.$watch("vs.movingBoundary",function(){$.isEmptyObject(i.shs)||$.isEmptyObject(i.shs.wavJSO)||i.clearAndDrawSpectMarkup()},!0),i.$watch("vs.spectroSettings",function(){$.isEmptyObject(i.shs)||$.isEmptyObject(i.shs.wavJSO)||(i.setupEvent(),i.redraw())},!0),i.$watch("lmds.getCurBndl()",function(a,b){$.isEmptyObject(i.shs)||$.isEmptyObject(i.shs.wavJSO)||(a.name!==b.name||a.session!==b.session)&&i.redraw()},!0),i.redraw=function(){i.markupCtx.clearRect(0,0,i.canvas1.width,i.canvas1.height),i.drawSpectro(i.shs.wavJSO.Data)},i.drawSpectro=function(a){i.killSpectroRenderingThread(),i.startSpectroRenderingThread(a)},i.calcSamplesPerPxl=function(){return(i.vs.curViewPort.eS+1-i.vs.curViewPort.sS)/i.canvas0.width},i.clearAndDrawSpectMarkup=function(){i.markupCtx.clearRect(0,0,i.canvas1.width,i.canvas1.height),i.drawSpectMarkup()},i.drawSpectMarkup=function(){i.dhs.drawMovingBoundaryLine(i.markupCtx),i.dhs.drawCurViewPortSelected(i.markupCtx,!1),i.dhs.drawMinMaxAndName(i.markupCtx,"",i.vs.spectroSettings.rangeFrom,i.vs.spectroSettings.rangeTo,2)},i.killSpectroRenderingThread=function(){i.context.fillStyle=c.design.color.lightGrey,i.context.fillRect(0,0,i.canvas0.width,i.canvas0.height),i.dhs.drawCurViewPortSelected(i.markupCtx,!1),e.drawUndistortedText(i.context,"rendering...",.75*c.design.font.small.size.slice(0,-2),c.design.font.small.family,10,50,c.design.color.black,!0),null!==i.primeWorker&&(i.primeWorker.kill(),i.primeWorker=null)},i.setupEvent=function(){var a=i.context.createImageData(i.canvas0.width,i.canvas0.height);i.primeWorker.says(function(b){if(void 0===b.status){if(i.calcSamplesPerPxl()===b.samplesPerPxl){var c=new Uint8ClampedArray(b.img);a.data.set(c),i.context.putImageData(a,0,0),i.drawSpectMarkup()}}else console.error("Error rendering spectrogram:",b.status.message)})},i.startSpectroRenderingThread=function(a){if(a.length>0){i.primeWorker=new spectroDrawingWorker;var b=[],c=g.calcClosestPowerOf2Gt(i.shs.wavJSO.SampleRate*i.vs.spectroSettings.windowSizeInSecs);512>c&&(c=512),b=a.subarray(i.vs.curViewPort.sS,i.vs.curViewPort.eS);var d=[],e=[],f=i.shs.wavJSO.SampleRate*i.vs.spectroSettings.windowSizeInSecs;i.vs.curViewPort.sS<f/2||(d=a.subarray(i.vs.curViewPort.sS-f/2,i.vs.curViewPort.sS)),i.vs.curViewPort.eS+c/2-1>=i.shs.wavJSO.Data.length||(e=a.subarray(i.vs.curViewPort.eS,i.vs.curViewPort.eS+c/2-1));var h=new Float32Array(d.length+b.length+e.length);h.set(d),h.set(b,d.length),h.set(e,d.length+b.length),b=i.vs.curViewPort.sS>=c/2?a.subarray(i.vs.curViewPort.sS-c/2,i.vs.curViewPort.eS+c):a.subarray(i.vs.curViewPort.sS,i.vs.curViewPort.eS+c),i.setupEvent(),i.primeWorker.tell({windowSizeInSecs:i.vs.spectroSettings.windowSizeInSecs,fftN:c,alpha:i.alpha,upperFreq:i.vs.spectroSettings.rangeTo,lowerFreq:i.vs.spectroSettings.rangeFrom,samplesPerPxl:i.calcSamplesPerPxl(),window:i.vs.spectroSettings.window,imgWidth:i.canvas0.width,imgHeight:i.canvas0.height,dynRangeInDB:i.vs.spectroSettings.dynamicRange,pixelRatio:i.devicePixelRatio,sampleRate:i.shs.wavJSO.SampleRate,transparency:i.cps.vals.spectrogramSettings.transparency,audioBuffer:h,audioBufferChannels:i.shs.wavJSO.NumChannels,drawHeatMapColors:i.vs.spectroSettings.drawHeatMapColors,preEmphasisFilterFactor:i.vs.spectroSettings.preEmphasisFilterFactor,heatMapColorAnchors:i.vs.spectroSettings.heatMapColorAnchors},[h.buffer])}}}}}]),angular.module("emuwebApp").controller("ExportCtrl",["$scope","modalService","browserDetector","viewState","HistoryService",function(a,b,c,d,e){a.firefox=c.isBrowser.Firefox(),a.getBlob=function(){var c;try{c=new Blob([b.dataExport],{type:"text/plain"})}catch(d){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,c=new BlobBuilder,c.append(a.exportData),c=c.getBlob()}return c},a.updateHistoryService=function(){e.movesAwayFromLastSave=0},a.cursorInTextField=function(){d.setEditing(!0),d.setcursorInTextField(!0)},a.cursorOutOfTextField=function(){d.setEditing(!1),d.setcursorInTextField(!1)},a["export"]=function(){var c;c="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(a.getBlob()):URL.createObjectURL(a.getBlob()),a.SaveToDisk(c,b.dataIn),b.close()},a.SaveToDisk=function(b,c){var d=document.createElement("a");if(a.firefox)d.setAttribute("download",c),d.href=b,d.innerHTML="",d.style.display="none",document.body.appendChild(d),d.click();else{d.href=b,d.target="_blank",d.download=c||"unknown";var e=document.createEvent("Event");e.initEvent("click",!0,!0),d.dispatchEvent(e),(window.URL||window.webkitURL).revokeObjectURL(d.href)}a.updateHistoryService()}}]),angular.module("emuwebApp").factory("viewState",["$rootScope","$timeout","$window","Soundhandlerservice","DataService","StandardFuncsService",function(a,b,c,d,e,f){var g={},h={BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10},i={DEMO:1,WS:2,EMBEDDED:3},j={absolute:1,relative:2},k={OSCI:1,SPEC:2},l={DOTS:1,EPG:2};return g.curLevelAttrDefs=[],g.initialize=function(){g.curViewPort={sS:0,eS:0,selectS:-1,selectE:-1,movingS:-1,movingE:-1,dragBarActive:!1,dragBarHeight:-1,windowWidth:void 0},g.spectroSettings={windowSizeInSecs:-1,rangeFrom:-1,rangeTo:-1,dynamicRange:-1,window:-1,drawHeatMapColors:-1,preEmphasisFilterFactor:-1},g.playHeadAnimationInfos={sS:-1,eS:-1,curS:null,endFreezeSample:-1},g.hierarchyState={hierarchyShown:!1,selectedItemID:void 0,selectedLinkFromID:void 0,selectedLinkToID:void 0,editValue:void 0,inputFocus:!1,collapseInfo:{},scaleFactor:1,translate:[0,0],contextMenuID:void 0,newLinkFromID:void 0,path:[],rotated:!1,playing:0,resize:0,contextMenuIsOpen:function(){return void 0!==g.hierarchyState.contextMenuID},closeContextMenu:function(){g.hierarchyState.contextMenuID=void 0},getContextMenuID:function(){return g.hierarchyState.contextMenuID},setContextMenuID:function(a){g.hierarchyState.contextMenuID=a},getInputFocus:function(){return g.hierarchyState.inputFocus},setInputFocus:function(a){g.hierarchyState.inputFocus=a},getEditValue:function(){return g.hierarchyState.editValue},setEditValue:function(a){g.hierarchyState.editValue=a},reset:function(){g.hierarchyState.selectedItemID=void 0,g.hierarchyState.selectedLinkFromID=void 0,g.hierarchyState.selectedLinkToID=void 0,g.hierarchyState.editValue=void 0,g.hierarchyState.inputFocus=!1,g.hierarchyState.collapseInfo={},g.hierarchyState.scaleFactor=1,g.hierarchyState.translate=[0,0],g.hierarchyState.contextMenuID=void 0,g.hierarchyState.newLinkFromID=void 0},isRotated:function(){return g.hierarchyState.rotated},toggleRotation:function(){g.hierarchyState.rotated=!g.hierarchyState.rotated},toggleHierarchy:function(){g.hierarchyState.hierarchyShown=!g.hierarchyState.hierarchyShown,g.hierarchyState.hierarchyShown===!1&&f.traverseAndClean(e.getData())},isShown:function(){return g.hierarchyState.hierarchyShown},getCollapsed:function(a){return"undefined"==typeof g.hierarchyState.collapseInfo[a]?!1:"boolean"==typeof g.hierarchyState.collapseInfo[a].collapsed?g.hierarchyState.collapseInfo[a].collapsed:!1},getCollapsePosition:function(a){return"undefined"==typeof g.hierarchyState.collapseInfo[a]?void 0:"object"==typeof g.hierarchyState.collapseInfo[a].collapsePosition?g.hierarchyState.collapseInfo[a].collapsePosition:void 0},getNumCollapsedParents:function(a){return"undefined"==typeof g.hierarchyState.collapseInfo[a]?0:"number"==typeof g.hierarchyState.collapseInfo[a].numCollapsedParents?g.hierarchyState.collapseInfo[a].numCollapsedParents:0},setCollapsed:function(a,b){"undefined"==typeof g.hierarchyState.collapseInfo[a]&&(g.hierarchyState.collapseInfo[a]={}),g.hierarchyState.collapseInfo[a].collapsed=b},setCollapsePosition:function(a,b){"undefined"==typeof g.hierarchyState.collapseInfo[a]&&(g.hierarchyState.collapseInfo[a]={}),g.hierarchyState.collapseInfo[a].collapsePosition=b},setNumCollapsedParents:function(a,b){"undefined"==typeof g.hierarchyState.collapseInfo[a]&&(g.hierarchyState.collapseInfo[a]={}),g.hierarchyState.collapseInfo[a].numCollapsedParents=b}},g.timelineSize=-1,g.somethingInProgress=!1,g.somethingInProgressTxt="",g.historyActionTxt="",g.editing=!1,g.cursorInTextField=!1,g.saving=!0,g.submenuOpen=!1,g.rightSubmenuOpen=!1,g.curClickItems=[],g.curMousePosSample=0,g.curMouseLevelName=void 0,g.curMouseLevelType=void 0,g.curClickLevelName=void 0,g.curClickLevelType=void 0,g.lastPcm=void 0,g.curPreselColumnSample=2,g.curCorrectionToolNr=void 0,g.curClickLevelIndex=void 0,g.start=null,g.TransitionTime=void 0,g.showDropZone=!0,g.movingBoundary=!1,g.movingBoundarySample=void 0,g.focusInTextField=!1,g.curTaskPercCompl=0,g.curPerspectiveIdx=-1,g.mouseInEmuWebApp=!1,g.focusOnEmuWebApp=!0,g.lastKeyCode=void 0,g.lastUpdate=void 0,g.url=void 0,g.pageSize=500,g.currentPage=void 0,g.states=[],g.states.noDBorFilesloaded={permittedActions:["connectBtnClick","openDemoBtnDBclick","aboutBtnClick"]},g.states.loadingSaving={permittedActions:[]},g.states.labeling={permittedActions:["zoom","playaudio","spectSettingsChange","addLevelSegBtnClick","addLevelPointBtnClick","renameSelLevelBtnClick","downloadTextGridBtnClick","downloadAnnotationBtnClick","spectSettingsChange","clearBtnClick","labelAction","toggleSideBars","saveBndlBtnClick","showHierarchyBtnClick","editDBconfigBtnClick","aboutBtnClick"]},g.states.modalShowing=g.states.loadingSaving,g.prevState=g.states.noDBorFilesloaded,g.curState=g.states.noDBorFilesloaded,g.curLevelAttrDefs=[]},g.initialize(),g.getPermission=function(a){return g.curState.permittedActions.indexOf(a)>-1},g.setWindowWidth=function(a){this.curViewPort.windowWidth=a},g.setState=function(a){g.prevState=g.curState,"string"==typeof a?g.curState=g.states[a]:g.curState=a},g.updatePlayHead=function(b){d.isPlaying&&c.requestAnimationFrame(g.updatePlayHead),null===g.start&&(g.start=b);var e=Math.floor(b-g.start)/1e3*d.wavJSO.SampleRate;g.playHeadAnimationInfos.curS=Math.floor(g.playHeadAnimationInfos.sS+e),d.isPlaying&&g.playHeadAnimationInfos.curS<=g.playHeadAnimationInfos.eS?(-1!==g.playHeadAnimationInfos.curS&&(g.curMousePosSample=g.playHeadAnimationInfos.curS),a.$apply()):(g.curMousePosSample=g.playHeadAnimationInfos.endFreezeSample,g.playHeadAnimationInfos.sS=-1,g.playHeadAnimationInfos.eS=-1,g.playHeadAnimationInfos.curS=0,g.start=null)},g.animatePlayHead=function(a,b){g.playHeadAnimationInfos.sS=a,g.playHeadAnimationInfos.eS=b,g.playHeadAnimationInfos.endFreezeSample=b,g.playHeadAnimationInfos.curS=a,c.requestAnimationFrame(g.updatePlayHead)},g.select=function(a,b){g.curViewPort.selectS=a,g.curViewPort.selectE=b},g.resetSelect=function(){g.curViewPort.selectS=-1,g.curViewPort.selectE=-1},g.getViewPort=function(){return g.curViewPort},g.setspectroSettings=function(a,b,c,d,e,f,h,i){g.spectroSettings.windowSizeInSecs=a,g.spectroSettings.rangeFrom=parseInt(b,10),g.spectroSettings.rangeTo=parseInt(c,10),g.spectroSettings.dynamicRange=parseInt(d,10),g.setWindowFunction(e),g.spectroSettings.drawHeatMapColors=f,g.spectroSettings.preEmphasisFilterFactor=h,g.spectroSettings.heatMapColorAnchors=i},g.getSelect=function(){return[g.curViewPort.selectS,g.curViewPort.selectE]},g.selectDependent=function(a,b){a<this.curViewPort.selectS&&(this.curViewPort.selectS=a),b>this.curViewPort.selectE&&(this.curViewPort.selectE=b)},g.selectLevel=function(a,b,c){var d,e=g.getcurClickLevelName();if(void 0===e)return a?(d=c.getLevelDetails(b[b.length-1]),void g.setcurClickLevel(d.name,d.type,b.length-1)):(d=c.getLevelDetails(b[0]),void g.setcurClickLevel(d.name,d.type,0));var f;b.forEach(function(a,b){a===e&&(f=b)}),void 0===f?(d=c.getLevelDetails(b[0]),g.setcurClickLevel(d.name,d.type,0),g.curClickItems=[],g.selectBoundary()):a?f+1<b.length&&(d=c.getLevelDetails(b[f+1]),g.setcurClickLevel(d.name,d.type,b.idxOfNow+1),g.curClickItems=[],g.selectBoundary()):f-1>=0&&(d=c.getLevelDetails(b[f-1]),g.setcurClickLevel(d.name,d.type,b.idxOfNow-1),g.curClickItems=[],g.selectBoundary())},g.setWindowFunction=function(a){switch(a){case"BARTLETT":g.spectroSettings.window=h.BARTLETT;break;case"BARTLETTHANN":g.spectroSettings.window=h.BARTLETTHANN;break;case"BLACKMAN":g.spectroSettings.window=h.BLACKMAN;break;case"COSINE":g.spectroSettings.window=h.COSINE;break;case"GAUSS":g.spectroSettings.window=h.GAUSS;break;case"HAMMING":g.spectroSettings.window=h.HAMMING;break;case"HANN":g.spectroSettings.window=h.HANN;break;case"LANCZOS":g.spectroSettings.window=h.LANCZOS;break;case"RECTANGULAR":g.spectroSettings.window=h.RECTANGULAR;break;case"TRIANGULAR":g.spectroSettings.window=h.TRIANGULAR;break;default:g.spectroSettings.window=h.BARTLETTHANN}},g.getWindowFunctions=function(){return h},g.getCommunicationModes=function(){return i},g.getTimeModes=function(){return j},g.getSignalTypes=function(){return k},g.getTwoDimTypes=function(){return l},g.getdragBarActive=function(){return this.curViewPort.dragBarActive},g.setdragBarActive=function(a){this.curViewPort.dragBarActive=a},g.getdragBarHeight=function(){return this.curViewPort.dragBarHeight},g.setdragBarHeight=function(a){this.curViewPort.dragBarHeight=a},g.getPos=function(a,b){return a*(b-this.curViewPort.sS)/(this.curViewPort.eS-this.curViewPort.sS+1)},g.getSampleDist=function(a){return this.getPos(a,this.curViewPort.sS+1)-this.getPos(a,this.curViewPort.sS)},g.toggleSubmenu=function(a){this.submenuOpen=!this.submenuOpen,b(function(){var a=new Date;g.lastUpdate=a.getTime()},a)},g.getsubmenuOpen=function(){return this.submenuOpen},g.setsubmenuOpen=function(a){this.submenuOpen=a},g.setenlarge=function(a){this.timelineSize=a},g.getenlarge=function(){return this.timelineSize},g.getTransitionTime=function(){return this.TransitionTime},g.setTransitionTime=function(a){this.TransitionTime=a},g.getRightsubmenuOpen=function(){return this.rightSubmenuOpen},g.setRightsubmenuOpen=function(a){this.rightSubmenuOpen=a},g.setcurClickLevel=function(a,b,c){g.setcurClickLevelName(a,c),g.setcurClickLevelType(b)},g.setcurClickLevelType=function(a){this.curClickLevelType=a},g.getcurClickLevelType=function(){return this.curClickLevelType},g.setcurClickLevelName=function(a,b){this.curClickLevelName=a,this.curClickLevelIndex=b},g.getcurClickLevelName=function(){return this.curClickLevelName},g.getcurClickLevelIndex=function(){return this.curClickLevelIndex},g.getcurClickNeighbours=function(){return this.curClickNeighbours},g.setcurMouseLevelName=function(a){this.curMouseLevelName=a},g.getcurMouseLevelName=function(){return this.curMouseLevelName},g.setcurMouseLevelType=function(a){this.curMouseLevelType=a},g.getcurMouseLevelType=function(){return this.curMouseLevelType},g.setcurMouseItem=function(a,b,c,d,e){this.curMouseItem=a,this.curMouseX=c,this.curMouseNeighbours=b,this.curMouseisFirst=d,this.curMouseisLast=e},g.getcurMouseItem=function(){return this.curMouseItem},g.getcurMouseisFirst=function(){return this.curMouseisFirst},g.getcurMouseisLast=function(){return this.curMouseisLast},g.getcurMouseNeighbours=function(){return this.curMouseNeighbours},g.getItemsInSelection=function(a){var b=[],c=g.curViewPort.selectS,d=g.curViewPort.selectE;return angular.forEach(a,function(a){a.name===g.getcurClickLevelName()&&angular.forEach(a.items,function(a){a.sampleStart>=c&&a.sampleStart+a.sampleDur<=d&&b.push(a),a.samplePoint>=c&&a.samplePoint<=d&&b.push(a)})}),b.sort(g.sortbystart)},g.setcurClickItem=function(a){null!==a&&void 0!==a?(g.curClickItems=[],g.curClickItems.push(a),g.selectBoundary()):g.curClickItems=[]},g.selectBoundary=function(){if(g.curClickItems.length>0){var a=g.curClickItems[0].sampleStart||g.curClickItems[0].samplePoint,b=g.curClickItems[g.curClickItems.length-1].sampleStart+g.curClickItems[g.curClickItems.length-1].sampleDur||g.curClickItems[0].samplePoint;g.curClickItems.forEach(function(c){c.sampleStart<=a&&(a=c.sampleStart),c.sampleStart+c.sampleDur>=b&&(b=c.sampleStart+c.sampleDur)}),g.select(a,b+1)}},g.setcurClickItemMultiple=function(a,b,c){0==g.curClickItems.length||void 0===g.curClickItems||null===g.curClickItems?(g.curClickItems=[],g.curClickItems.push(a)):-1===g.curClickItems.indexOf(a)&&(g.curClickItems.indexOf(b)>=0||g.curClickItems.indexOf(c)>=0)?(g.curClickItems.push(a),g.curClickItems.sort(g.sortbystart)):(g.curClickItems=[],g.curClickItems.push(a))},g.sortbystart=function(a,b){return a.sampleStart>b.sampleStart||a.samplePoint>b.samplePoint?1:a.sampleStart<b.sampleStart||a.samplePoint<b.samplePoint?-1:0},g.getselectedRange=function(){return this.curClickItems.length>1?{start:this.curClickItems[0].sampleStart,end:this.curClickItems[this.curClickItems.length-1].sampleStart+this.curClickItems[this.curClickItems.length-1].sampleDur}:1===this.curClickItems.length?void 0!==this.curClickItems[0].sampleStart?{start:this.curClickItems[0].sampleStart,end:this.curClickItems[0].sampleStart+this.curClickItems[0].sampleDur}:{start:this.curClickItems[0].samplePoint,end:this.curClickItems[0].samplePoint}:{start:-1,end:-1}},g.getcurClickItems=function(){return this.curClickItems},g.getselected=function(){return this.curClickItems},g.isEditing=function(){return this.editing},g.setEditing=function(a){this.editing=a},g.getLasPcm=function(){return this.lastPcm},g.setLastPcm=function(a){this.lastPcm=a},g.getcursorInTextField=function(){return this.cursorInTextField},g.setcursorInTextField=function(a){this.cursorInTextField=a},g.isSavingAllowed=function(){return this.saving},g.setSavingAllowed=function(a){this.saving=a},g.countSelected=function(){return this.curClickItems.length},g.getCurrentSample=function(a){return this.curViewPort.sS+(this.curViewPort.eS-this.curViewPort.sS)*a},g.getCurrentPercent=function(a){return a*(100/(this.curViewPort.eS-this.curViewPort.sS)/100)},g.getSamplesPerPixelVal=function(a){var b=parseFloat(this.curViewPort.sS),c=parseFloat(this.curViewPort.eS);return(c-b)/a.originalEvent.target.width},g.getViewPortStartTime=function(){return 1*this.curViewPort.sS/d.wavJSO.SampleRate-.5/d.wavJSO.SampleRate},g.getViewPortEndTime=function(){return 1*this.curViewPort.eS/d.wavJSO.SampleRate+.5/d.wavJSO.SampleRate},g.getSelectedStartTime=function(){return 1*this.curViewPort.selectS/d.wavJSO.SampleRate-.5/d.wavJSO.SampleRate},g.getSelectedEndTime=function(){return 1*this.curViewPort.selectE/d.wavJSO.SampleRate+.5/d.wavJSO.SampleRate},g.setViewPort=function(a,b){var c=this.curViewPort.sS,e=this.curViewPort.eS;void 0!==a&&(this.curViewPort.sS=Math.round(a)),void 0!==b&&(this.curViewPort.eS=Math.round(b)),c>this.curViewPort.sS&&e>this.curViewPort.eS&&this.curViewPort.sS<0&&(this.curViewPort.sS=0,this.curViewPort.eS=e+Math.abs(this.curViewPort.sS)),c<this.curViewPort.sS&&e<this.curViewPort.eS&&this.curViewPort.eS>d.wavJSO.Data.length&&(this.curViewPort.sS=c,this.curViewPort.eS=d.wavJSO.Data.length),this.curViewPort.sS<0&&(this.curViewPort.sS=0),this.curViewPort.eS>d.wavJSO.Data.length&&(this.curViewPort.eS=d.wavJSO.Data.length),this.curViewPort.eS-this.curViewPort.sS<4&&(this.curViewPort.sS=c,this.curViewPort.eS=e)},g.zoomViewPort=function(a,b){var c,d,e,f=this.getcurMouseItem(),h=this.curViewPort.eS-this.curViewPort.sS,i=!1;if(void 0!==f){this.getcurMouseisFirst()?f=b.getItemDetails(g.getcurMouseLevelName(),0):this.getcurMouseisLast()&&(f=b.getLastItem(g.getcurMouseLevelName()),i=!0),e="SEGMENT"===this.getcurMouseLevelType()?i?f.sampleStart+f.sampleDur:f.sampleStart:f.samplePoint;var j=e-this.curViewPort.sS,k=this.curViewPort.eS-e;a?(c=this.curViewPort.sS+.5*j,d=this.curViewPort.eS-.5*k):(c=this.curViewPort.sS-.5*j,d=this.curViewPort.eS+.5*k)}else a?(c=this.curViewPort.sS+~~(h/4),d=this.curViewPort.eS-~~(h/4)):(c=this.curViewPort.sS-~~(h/4),d=this.curViewPort.eS+~~(h/4));this.setViewPort(c,d)},g.shiftViewPort=function(a){var b,c;a?(b=this.curViewPort.sS+~~((this.curViewPort.eS-this.curViewPort.sS)/4),c=this.curViewPort.eS+~~((this.curViewPort.eS-this.curViewPort.sS)/4)):(b=this.curViewPort.sS-~~((this.curViewPort.eS-this.curViewPort.sS)/4),c=this.curViewPort.eS-~~((this.curViewPort.eS-this.curViewPort.sS)/4)),this.setViewPort(b,c)},g.setCurLevelAttrDefs=function(a){angular.forEach(a,function(a){g.curLevelAttrDefs.push({levelName:a.name,curAttrDefName:a.name})})},g.setCurAttrDef=function(a,b,c){angular.forEach(g.curLevelAttrDefs,function(d){d.levelName===a&&(d.curAttrDefName=b,d.curAttrDefIndex=c)})},g.getCurAttrDef=function(a){var b;return angular.forEach(g.curLevelAttrDefs,function(c){c.levelName===a&&(b=c.curAttrDefName)}),b},g.getCurAttrIndex=function(a){var b;return angular.forEach(g.curLevelAttrDefs,function(c){c.levelName===a&&(b=void 0===c.curAttrDefIndex?0:c.curAttrDefIndex)}),b},g.setlastKeyCode=function(a){this.lastKeyCode=a},g.getX=function(a){return(a.offsetX||a.originalEvent.layerX)*(a.originalEvent.target.width/a.originalEvent.target.clientWidth)},g.getY=function(a){return(a.offsetY||a.originalEvent.layerY)*(a.originalEvent.target.height/a.originalEvent.target.clientHeight)},g.resetToInitState=function(){g.initialize()},g.getColorOfAnchor=function(a,b){var c={"background-color":"rgb("+a[b][0]+","+a[b][1]+","+a[b][2]+")",width:"10px",height:"10px"};return c},g.numberOfPages=function(a){return Math.ceil(a/g.pageSize)},g}]),angular.module("emuwebApp").directive("trackMouseInLevel",["$document","viewState","LevelService","ConfigProviderService","HistoryService","Soundhandlerservice",function(a,b,c,d,e,f){return{restrict:"A",replace:!0,scope:{levelName:"=",levelType:"="},link:function(a,g,h){a.lastEventClick=void 0,a.lastEventMove=void 0,a.lastNeighboursMove=void 0,a.lastPCM=void 0,a.curMouseSampleNrInView=void 0,a.order=h.trackMouseInLevel,g.bind("click",function(b){b.preventDefault(),a.setLastMove(b,!0),a.setLastClick(b)}),g.bind("contextmenu",function(b){b.preventDefault(),a.setLastMove(b,!0),a.setLastRightClick(b)}),g.bind("dblclick",function(b){a.setLastMove(b,!0),d.vals.restrictions.editItemName?a.setLastDblClick(b):a.setLastClick(b)}),g.bind("mousemove",function(g){if(b.focusOnEmuWebApp){if(!b.getdragBarActive()){var h=!0,i=b.getSamplesPerPixelVal(g);a.curMouseSampleNrInView=b.getX(g)*i;var j=a.curMouseSampleNrInView-a.lastPCM;if(1>=i){var k=c.getClosestItem(a.curMouseSampleNrInView+b.curViewPort.sS,a.levelName,f.wavJSO.Data.length);if("SEGMENT"===a.levelType)if(k.isFirst===!0&&k.isLast===!1)j=Math.ceil(a.curMouseSampleNrInView+b.curViewPort.sS-c.getItemDetails(a.levelName,0).sampleStart);else if(k.isFirst===!1&&k.isLast===!0){var l=c.getLastItem(a.levelName);j=Math.ceil(a.curMouseSampleNrInView+b.curViewPort.sS-l.sampleStart-l.sampleDur)}else j=Math.ceil(a.curMouseSampleNrInView+b.curViewPort.sS-c.getItemFromLevelById(a.levelName,k.nearest.id).sampleStart);else j=Math.ceil(a.curMouseSampleNrInView+b.curViewPort.sS-c.getItemFromLevelById(a.levelName,k.nearest.id).samplePoint-.5)}else j=Math.round(a.curMouseSampleNrInView-a.lastPCM)}var m=0;switch(m=void 0===g.buttons?g.which:g.buttons){case 1:break;case 2:break;case 3:break;default:if(!b.getdragBarActive()){var n=b.getcurMouseItem();if(d.vals.restrictions.editItemSize&&g.shiftKey){if(c.deleteEditArea(),void 0!==n){if(b.movingBoundary=!0,"SEGMENT"===a.levelType){if(b.getcurMouseisFirst()||b.getcurMouseisLast()){var o;b.getcurMouseisFirst()?(o=c.getItemDetails(a.levelName,0),b.movingBoundarySample=o.sampleStart+j):b.getcurMouseisLast()&&(o=c.getLastItem(a.levelName),b.movingBoundarySample=o.sampleStart+o.sampleDur+j)}else b.movingBoundarySample=n.sampleStart+j,o=n;c.moveBoundary(a.levelName,o.id,j,b.getcurMouseisFirst(),b.getcurMouseisLast()),e.updateCurChangeObj({type:"ANNOT",action:"MOVEBOUNDARY",name:a.levelName,id:o.id,movedBy:j,isFirst:b.getcurMouseisFirst(),isLast:b.getcurMouseisLast()})}else o=n,b.movingBoundarySample=n.samplePoint+j,c.moveEvent(a.levelName,o.id,j),e.updateCurChangeObj({type:"ANNOT",action:"MOVEEVENT",name:a.levelName,id:o.id,movedBy:j});a.lastPCM=a.curMouseSampleNrInView,b.setLastPcm(a.lastPCM),b.selectBoundary(),h=!1}}else d.vals.restrictions.editItemSize&&g.altKey?(c.deleteEditArea(),"SEGMENT"==a.levelType?(o=b.getcurClickItems(),void 0!==o[0]&&(c.moveSegment(a.levelName,o[0].id,o.length,j),e.updateCurChangeObj({type:"ANNOT",action:"MOVESEGMENT",name:a.levelName,id:o[0].id,length:o.length,movedBy:j})),a.lastPCM=a.curMouseSampleNrInView,b.setLastPcm(a.lastPCM),b.selectBoundary()):"EVENT"==a.levelType&&(o=b.getcurClickItems(),void 0!==o[0]&&angular.forEach(o,function(b){c.moveEvent(a.levelName,b.id,j),e.updateCurChangeObj({type:"ANNOT",action:"MOVEEVENT",name:a.levelName,id:b.id,movedBy:j})}),a.lastPCM=a.curMouseSampleNrInView,b.setLastPcm(a.lastPCM),b.selectBoundary())):b.movingBoundary=!1}}b.getdragBarActive()||a.setLastMove(g,h)}}),g.bind("mousedown",function(c){b.movingBoundary=!0,a.setLastMove(c,!0)}),g.bind("mouseup",function(c){b.movingBoundary=!1,a.setLastMove(c,!0)}),g.bind("mouseout",function(c){b.movingBoundary=!1,a.setLastMove(c,!0)}),a.setLastClick=function(d){a.curMouseSampleNrInView=b.getX(d)*b.getSamplesPerPixelVal(d),c.deleteEditArea(),b.setEditing(!1),a.lastEventClick=c.getClosestItem(a.curMouseSampleNrInView+b.curViewPort.sS,a.levelName,f.wavJSO.Data.length),b.setcurClickLevel(a.levelName,a.levelType,a.order),void 0!==a.lastEventClick.current&&void 0!==a.lastEventClick.nearest&&(c.setlasteditArea("_"+a.lastEventClick.current.id),c.setlasteditAreaElem(g.parent()),b.setcurClickItem(a.lastEventClick.current),b.selectBoundary()),a.lastPCM=a.curMouseSampleNrInView,b.setLastPcm(a.lastPCM),a.$apply()},a.setLastRightClick=function(d){if(b.getcurClickLevelName()!==a.levelName&&a.setLastClick(d),a.curMouseSampleNrInView=b.getX(d)*b.getSamplesPerPixelVal(d),c.deleteEditArea(),a.lastEventClick=c.getClosestItem(a.curMouseSampleNrInView+b.curViewPort.sS,a.levelName,f.wavJSO.Data.length),void 0!==a.lastEventClick.current&&void 0!==a.lastEventClick.nearest){var e=c.getItemInTime(b.getcurClickLevelName(),a.lastEventClick.current.id,!0),g=c.getItemInTime(b.getcurClickLevelName(),a.lastEventClick.current.id,!1);b.setcurClickLevel(a.levelName,a.levelType,a.$index),b.setcurClickItemMultiple(a.lastEventClick.current,e,g),b.selectBoundary()}a.lastPCM=a.curMouseSampleNrInView,b.setLastPcm(a.lastPCM),a.$apply()},a.setLastDblClick=function(d){a.curMouseSampleNrInView=b.getX(d)*b.getSamplesPerPixelVal(d),a.lastEventClick=c.getClosestItem(a.curMouseSampleNrInView+b.curViewPort.sS,a.levelName,f.wavJSO.Data.length);var e="25px"===g.parent().css("height")?!1:!0;e||g.parent().parent().find("div")[3].click(),void 0!==a.lastEventClick.current&&void 0!==a.lastEventClick.nearest&&b.getPermission("labelAction")&&("SEGMENT"===a.levelType?a.lastEventClick.current.sampleStart>=b.curViewPort.sS&&a.lastEventClick.current.sampleStart+a.lastEventClick.current.sampleDur<=b.curViewPort.eS&&(b.setcurClickLevel(a.levelName,a.levelType,a.$index),b.setcurClickItem(a.lastEventClick.current),c.setlasteditArea("_"+a.lastEventClick.current.id),c.setlasteditAreaElem(g.parent()),b.setEditing(!0),c.openEditArea(a.lastEventClick.current,g.parent(),a.levelType)):(b.setcurClickLevel(a.levelName,a.levelType,a.$index),b.setcurClickItem(a.lastEventClick.current),c.setlasteditArea("_"+a.lastEventClick.current.id),c.setlasteditAreaElem(g.parent()),b.setEditing(!0),c.openEditArea(a.lastEventClick.current,g.parent(),a.levelType),b.setEditing(!0))),a.lastPCM=a.curMouseSampleNrInView,b.setLastPcm(a.lastPCM),a.$apply()},a.setLastMove=function(d,e){a.curMouseSampleNrInView=b.getX(d)*b.getSamplesPerPixelVal(d),a.lastEventMove=c.getClosestItem(a.curMouseSampleNrInView+b.curViewPort.sS,a.levelName,f.wavJSO.Data.length),e&&void 0!==a.lastEventMove.current&&void 0!==a.lastEventMove.nearest&&(a.lastNeighboursMove=c.getItemNeighboursFromLevel(a.levelName,a.lastEventMove.nearest.id,a.lastEventMove.nearest.id),b.setcurMouseItem(a.lastEventMove.nearest,a.lastNeighboursMove,a.lastPCM,a.lastEventMove.isFirst,a.lastEventMove.isLast)),b.setcurMouseLevelName(a.levelName),b.setcurMouseLevelType(a.levelType),a.lastPCM=a.curMouseSampleNrInView,b.setLastPcm(a.lastPCM),a.$apply()}}}}]),angular.module("emuwebApp").directive("handleglobalkeystrokes",["$timeout","viewState","modalService","HierarchyManipulationService","Soundhandlerservice","ConfigProviderService","HistoryService","LevelService","DataService","LinkService","AnagestService",function(a,b,c,d,e,f,g,h,i,j,k){return{restrict:"A",link:function(a,d){$(document).bind("keyup",function(c){var d=c.keyCode?c.keyCode:c.which;b.isEditing()&&!b.getcursorInTextField()&&a.applyKeyCodeUp(d,c)}),$(document).bind("keydown",function(b){if(!a.firefox){var c=b.keyCode?b.keyCode:b.which;(8==c||9==c||27==c||37==c||38==c||39==c||40==c||32==c)&&a.applyKeyCode(c,b)}}),$(document).bind("keypress",function(b){var c=b.keyCode?b.keyCode:b.which;a.applyKeyCode(c,b)}),a.applyKeyCodeUp=function(c,d){a.$apply(function(){if(c!==f.vals.keyMappings.esc&&c!==f.vals.keyMappings.createNewItemAtSelection){var a=$("."+h.getlasteditArea()),d=a.val();b.setSavingAllowed(!0);var e=b.getCurAttrIndex(b.getcurClickLevelName()),g=f.getLevelDefinition(b.getcurClickLevelName()),i={};void 0!==g.attributeDefinitions&&g.attributeDefinitions.length>0&&(i=f.getLevelDefinition(b.getcurClickLevelName()).attributeDefinitions[e]),void 0!==i.legalLabels&&d.length>0&&i.legalLabels.indexOf(d)<0&&b.setSavingAllowed(!1),b.isSavingAllowed()?a.css({"background-color":"rgba(255,255,0,1)"}):a.css({"background-color":"rgba(255,0,0,1)"})}})},a.applyKeyCode=function(d,l){a.$apply(function(){if(!f.vals.main.catchMouseForKeyBinding||b.mouseInEmuWebApp)if(b.setlastKeyCode(d),b.hierarchyState.isShown()&&void 0!==b.hierarchyState)if(b.hierarchyState.getInputFocus()){if(d===f.vals.keyMappings.hierarchyCommitEdit){var m,n=b.hierarchyState.getContextMenuID(),o=h.getItemByID(n),p=h.getLevelName(n),q=b.getCurAttrIndex(p),r=f.getLevelDefinition(p).attributeDefinitions[q].legalLabels,s=b.hierarchyState.getEditValue();m=void 0!==o.labels[q]?o.labels[q].value:"",void 0!==s&&s!==m?(void 0===r||s.length>0&&r.indexOf(s)>=0)&&(h.renameLabel(p,n,q,s),g.addObjToUndoStack({type:"ANNOT",action:"RENAMELABEL",name:p,id:n,attrIndex:q,oldValue:m,newValue:s}),b.hierarchyState.closeContextMenu()):b.hierarchyState.closeContextMenu()}d===f.vals.keyMappings.hierarchyCancelEdit&&b.hierarchyState.closeContextMenu()}else{if(d===f.vals.keyMappings.hierarchyDeleteLink&&l.preventDefault(),d===f.vals.keyMappings.hierarchyPlayback&&(l.preventDefault(),b.hierarchyState.playing+=1,console.log("hierarchyPlayback")),d===f.vals.keyMappings.hierarchyRotate&&b.hierarchyState.toggleRotation(),d===f.vals.keyMappings.hierarchyDeleteLink){var t=j.deleteLink(b.hierarchyState.selectedLinkFromID,b.hierarchyState.selectedLinkToID);-1!==t&&g.addObjToUndoStack({type:"HIERARCHY",action:"DELETELINK",fromID:b.hierarchyState.selectedLinkFromID,toID:b.hierarchyState.selectedLinkToID,position:t})}if(d===f.vals.keyMappings.hierarchyDeleteItem){var u=h.deleteItemWithLinks(b.hierarchyState.selectedItemID);void 0!==u.item&&g.addObjToUndoStack({type:"HIERARCHY",action:"DELETEITEM",item:u.item,levelName:u.levelName,position:u.position,deletedLinks:u.deletedLinks})}if(d===f.vals.keyMappings.hierarchyAddItemBefore){var v=h.addItem(b.hierarchyState.selectedItemID,!0);-1!==v&&g.addObjToUndoStack({type:"HIERARCHY",action:"ADDITEM",newID:v,neighborID:b.hierarchyState.selectedItemID,before:!0})}if(d===f.vals.keyMappings.hierarchyAddItemAfter){var v=h.addItem(b.hierarchyState.selectedItemID,!1);-1!==v&&g.addObjToUndoStack({type:"HIERARCHY",action:"ADDITEM",newID:v,neighborID:b.hierarchyState.selectedItemID,before:!1})}d===f.vals.keyMappings.undo&&g.undo(),d===f.vals.keyMappings.redo&&g.redo(),l.shiftKey||d!==f.vals.keyMappings.esc&&d!==f.vals.keyMappings.showHierarchy||c.close()}else if(b.isEditing()){var w=$("."+h.getlasteditArea());
if(!b.isSavingAllowed()&&d===f.vals.keyMappings.createNewItemAtSelection){var x=f.getLevelDefinition(b.getcurClickLevelName()).attributeDefinitions[b.getCurAttrIndex(b.getcurClickLevelName())].legalLabels;l.preventDefault(),l.stopPropagation(),h.deleteEditArea(),b.setEditing(!1),c.open("views/error.html",'Editing Error: Sorry, characters allowed on this Level are "'+JSON.stringify(x)+'"')}if(b.isSavingAllowed()&&d===f.vals.keyMappings.createNewItemAtSelection){var y=h.getItemFromLevelById(b.getcurClickLevelName(),h.getlastID()),q=b.getCurAttrIndex(b.getcurClickLevelName()),m="";void 0!==y.labels[q]&&(m=y.labels[q].value),h.renameLabel(b.getcurClickLevelName(),h.getlastID(),b.getCurAttrIndex(b.getcurClickLevelName()),w.val()),g.addObjToUndoStack({type:"ANNOT",action:"RENAMELABEL",name:b.getcurClickLevelName(),id:h.getlastID(),attrIndex:q,oldValue:m,newValue:w.val()}),h.deleteEditArea(),b.setEditing(!1),b.setcurClickItem(h.getItemFromLevelById(b.getcurClickLevelName(),h.getlastID()))}d===f.vals.keyMappings.esc&&(h.deleteEditArea(),b.setEditing(!1))}else if(b.getcursorInTextField()===!1){if(h.deleteEditArea(),0===b.curState.permittedActions.length&&d===f.vals.keyMappings.esc&&c.force===!1&&c.close(),d===f.vals.keyMappings.showHierarchy&&f.vals.activeButtons.showHierarchy&&b.curState!==b.states.noDBorFilesloaded&&(b.hierarchyState.isShown()?c.close():(b.hierarchyState.toggleHierarchy(),c.open("views/showHierarchyModal.html"))),d===f.vals.keyMappings.zoomAll&&b.getPermission("zoom")&&b.setViewPort(0,e.wavJSO.Data.length),d===f.vals.keyMappings.zoomIn&&b.getPermission("zoom")&&b.zoomViewPort(!0,h),d===f.vals.keyMappings.zoomOut&&b.getPermission("zoom")&&b.zoomViewPort(!1,h),d===f.vals.keyMappings.zoomSel&&b.getPermission("zoom")&&b.setViewPort(b.curViewPort.selectS,b.curViewPort.selectE),d===f.vals.keyMappings.shiftViewPortLeft&&b.getPermission("zoom")&&b.shiftViewPort(!1),d===f.vals.keyMappings.shiftViewPortRight&&b.getPermission("zoom")&&b.shiftViewPort(!0),d===f.vals.keyMappings.playEntireFile&&b.getPermission("playaudio")&&f.vals.restrictions.playback&&(e.playFromTo(0,e.wavJSO.Data.length),b.animatePlayHead(0,e.wavJSO.Data.length)),d===f.vals.keyMappings.playAllInView&&b.getPermission("playaudio")&&f.vals.restrictions.playback&&(e.playFromTo(b.curViewPort.sS,b.curViewPort.eS),b.animatePlayHead(b.curViewPort.sS,b.curViewPort.eS)),d===f.vals.keyMappings.playSelected&&b.getPermission("playaudio")&&f.vals.restrictions.playback&&(e.playFromTo(b.curViewPort.selectS,b.curViewPort.selectE),b.animatePlayHead(b.curViewPort.selectS,b.curViewPort.selectE)),d===f.vals.keyMappings.selectFirstContourCorrectionTool&&b.getPermission("labelAction")&&f.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=1),d===f.vals.keyMappings.selectSecondContourCorrectionTool&&b.getPermission("labelAction")&&f.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=2),d===f.vals.keyMappings.selectThirdContourCorrectionTool&&b.getPermission("labelAction")&&f.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=3),d===f.vals.keyMappings.selectFourthContourCorrectionTool&&b.getPermission("labelAction")&&f.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=4),d===f.vals.keyMappings.selectNoContourCorrectionTool&&b.getPermission("labelAction")&&f.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=void 0),d===f.vals.keyMappings.levelUp&&b.getPermission("labelAction")&&b.selectLevel(!1,f.vals.perspectives[b.curPerspectiveIdx].levelCanvases.order,h),d===f.vals.keyMappings.levelDown&&b.getPermission("labelAction")&&b.selectLevel(!0,f.vals.perspectives[b.curPerspectiveIdx].levelCanvases.order,h),d===f.vals.keyMappings.snapBoundaryToNearestTopBoundary&&b.getPermission("labelAction")&&f.vals.restrictions.editItemSize){var z=b.getcurMouseItem(),p=b.getcurMouseLevelName(),A=b.getcurMouseLevelType(),B=b.getcurMouseNeighbours(),C=h.snapBoundary(!0,p,z,B,A);C===!1||("EVENT"===A?g.updateCurChangeObj({type:"ANNOT",action:"MOVEEVENT",name:p,id:z.id,movedBy:C}):"SEGMENT"===A&&g.updateCurChangeObj({type:"ANNOT",action:"MOVEBOUNDARY",name:p,id:z.id,movedBy:C,position:0}),g.addCurChangeObjToUndoStack())}if(d===f.vals.keyMappings.snapBoundaryToNearestBottomBoundary&&b.getPermission("labelAction")&&f.vals.restrictions.editItemSize){var z=b.getcurMouseItem(),p=b.getcurMouseLevelName(),A=b.getcurMouseLevelType(),B=b.getcurMouseNeighbours(),C=h.snapBoundary(!1,p,z,B,A);0==C||("EVENT"===A?g.updateCurChangeObj({type:"ANNOT",action:"MOVEEVENT",name:p,id:z.id,movedBy:C}):"SEGMENT"===A&&g.updateCurChangeObj({type:"ANNOT",action:"MOVEBOUNDARY",name:p,id:z.id,movedBy:C,position:0}),g.addCurChangeObjToUndoStack())}if(d===f.vals.keyMappings.snapBoundaryToNearestZeroCrossing&&b.getPermission("labelAction")&&f.vals.restrictions.editItemSize){var D;if(D="SEGMENT"===b.getcurMouseLevelType()?h.calcDistanceToNearestZeroCrossing(b.getcurMouseItem().sampleStart):h.calcDistanceToNearestZeroCrossing(b.getcurMouseItem().samplePoint),0!==D){var E=b.getcurMouseItem(),F=(b.getcurMouseNeighbours(),b.getcurMouseLevelName());h.moveBoundary(F,E.id,D,0),g.updateCurChangeObj({type:"ANNOT",action:"MOVEBOUNDARY",name:F,id:E.id,movedBy:D,position:0}),g.addCurChangeObjToUndoStack()}}if(d===f.vals.keyMappings.expandSelSegmentsRight&&b.getPermission("labelAction")&&f.vals.restrictions.editItemSize)if(void 0===b.getcurClickLevelName())c.open("views/error.html","Expand Segments Error: Please select a Level first");else if(0===b.getselected().length)c.open("views/error.html","Expand Segments Error: Please select one or more Segments first");else{var G=parseInt(f.vals.labelCanvasConfig.addTimeValue,10);"relative"===f.vals.labelCanvasConfig.addTimeMode&&(G=f.vals.labelCanvasConfig.addTimeValue*(e.wavJSO.Data.length/100)),h.expandSegment(!0,b.getcurClickItems(),b.getcurClickLevelName(),G),g.addObjToUndoStack({type:"ANNOT",action:"EXPANDSEGMENTS",name:b.getcurClickLevelName(),item:b.getcurClickItems(),rightSide:!0,changeTime:G}),b.selectBoundary()}if(d===f.vals.keyMappings.expandSelSegmentsLeft&&b.getPermission("labelAction")&&f.vals.restrictions.editItemSize)if(void 0===b.getcurClickLevelName())c.open("views/error.html","Expand Segments Error: Please select a Level first");else if(0===b.getselected().length)c.open("views/error.html","Expand Segments Error: Please select one or more Segments first");else{if("absolute"===f.vals.labelCanvasConfig.addTimeMode)var G=parseInt(f.vals.labelCanvasConfig.addTimeValue,10);else if("relative"===f.vals.labelCanvasConfig.addTimeMode)var G=f.vals.labelCanvasConfig.addTimeValue*(e.wavJSO.Data.length/100);else c.open("views/error.html","Expand Segements Error: Error in Configuration (Value labelCanvasConfig.addTimeMode)");h.expandSegment(!1,b.getcurClickItems(),b.getcurClickLevelName(),G),g.addObjToUndoStack({type:"ANNOT",action:"EXPANDSEGMENTS",name:b.getcurClickLevelName(),item:b.getcurClickItems(),rightSide:!1,changeTime:G}),b.selectBoundary()}if(d===f.vals.keyMappings.shrinkSelSegmentsLeft&&b.getPermission("labelAction")&&f.vals.restrictions.editItemSize)if(void 0===b.getcurClickLevelName())c.open("views/error.html","Expand Segments Error: Please select a Level first");else if(0===b.getselected().length)c.open("views/error.html","Expand Segments Error: Please select one or more Segments first");else{if("absolute"===f.vals.labelCanvasConfig.addTimeMode)var G=parseInt(f.vals.labelCanvasConfig.addTimeValue,10);else if("relative"===f.vals.labelCanvasConfig.addTimeMode)var G=f.vals.labelCanvasConfig.addTimeValue*(e.wavJSO.Data.length/100);else c.open("views/error.html","Expand Segements Error: Error in Configuration (Value labelCanvasConfig.addTimeMode)");h.expandSegment(!0,b.getcurClickItems(),b.getcurClickLevelName(),-G),g.addObjToUndoStack({type:"ANNOT",action:"EXPANDSEGMENTS",name:b.getcurClickLevelName(),item:b.getcurClickItems(),rightSide:!0,changeTime:-G}),b.selectBoundary()}if(d===f.vals.keyMappings.shrinkSelSegmentsRight&&b.getPermission("labelAction")&&f.vals.restrictions.editItemSize)if(void 0===b.getcurClickLevelName())c.open("views/error.html","Expand Segments Error: Please select a Level first");else if(0===b.getselected().length)c.open("views/error.html","Expand Segments Error: Please select one or more Segments first");else{if("absolute"===f.vals.labelCanvasConfig.addTimeMode)var G=parseInt(f.vals.labelCanvasConfig.addTimeValue,10);else if("relative"===f.vals.labelCanvasConfig.addTimeMode)var G=f.vals.labelCanvasConfig.addTimeValue*(e.wavJSO.Data.length/100);else c.open("views/error.html","Expand Segements Error: Error in Configuration (Value labelCanvasConfig.addTimeMode)");h.expandSegment(!1,b.getcurClickItems(),b.getcurClickLevelName(),-G),g.addObjToUndoStack({type:"ANNOT",action:"EXPANDSEGMENTS",name:b.getcurClickLevelName(),item:b.getcurClickItems(),rightSide:!1,changeTime:-G}),b.selectBoundary()}if(d===f.vals.keyMappings.toggleSideBarLeft&&b.getPermission("toggleSideBars")&&f.vals.activeButtons.openMenu&&b.toggleSubmenu(f.design.animation.period),d===f.vals.keyMappings.toggleSideBarRight&&b.getPermission("toggleSideBars")&&f.vals.activeButtons.openMenu&&b.setRightsubmenuOpen(!b.getRightsubmenuOpen()),d===f.vals.keyMappings.selectItemsInSelection&&b.getPermission("labelAction")&&(void 0===b.getcurClickLevelName()?c.open("views/error.html","Selection Error : Please select a Level first"):(b.curClickItems=[],angular.forEach(b.getItemsInSelection(i.data.levels),function(a){var c=h.getItemInTime(b.getcurClickLevelName(),a.id,!0),d=h.getItemInTime(b.getcurClickLevelName(),a.id,!1);b.setcurClickItemMultiple(a,c,d)}),b.selectBoundary())),d===f.vals.keyMappings.selPrevItem&&b.getPermission("labelAction")&&b.getcurClickItems().length>0){var H=b.getcurClickItems()[0].id,I=b.getcurClickItems()[b.getcurClickItems().length-1].id,J=h.getItemNeighboursFromLevel(b.getcurClickLevelName(),H,I);void 0!==J.left&&(void 0!==J.left.sampleStart?J.left.sampleStart>b.curViewPort.sS&&(l.shiftKey?(b.setcurClickItemMultiple(J.left),h.setlasteditArea("_"+J.left.id),b.selectBoundary()):(b.setcurClickItem(J.left),h.setlasteditArea("_"+J.left.id))):J.left.samplePoint>b.curViewPort.sS&&(l.shiftKey?(b.setcurClickItemMultiple(J.left),h.setlasteditArea("_"+J.left.id),b.selectBoundary()):(b.setcurClickItem(J.left),h.setlasteditArea("_"+J.left.id))))}if(d===f.vals.keyMappings.selNextItem&&b.getPermission("labelAction")&&b.getcurClickItems().length>0){var H=b.getcurClickItems()[0].id,I=b.getcurClickItems()[b.getcurClickItems().length-1].id,J=h.getItemNeighboursFromLevel(b.getcurClickLevelName(),H,I);if(void 0!==J.right){var K=0,L=0;void 0!==J.right.sampleStart&&(K=J.right.sampleStart,L=J.right.sampleDur),void 0!==J.right.samplePoint&&(K=J.right.samplePoint,L=0),0!==K&&K+L<b.curViewPort.eS&&(l.shiftKey?(b.setcurClickItemMultiple(J.right),h.setlasteditArea("_"+J.right.id),b.selectBoundary()):(b.setcurClickItem(J.right),h.setlasteditArea("_"+J.right.id)))}}if(d===f.vals.keyMappings.selNextPrevItem&&b.getPermission("labelAction")&&b.getcurClickItems().length>0){var H=b.getcurClickItems()[0].id,I=b.getcurClickItems()[b.getcurClickItems().length-1].id,J=h.getItemNeighboursFromLevel(b.getcurClickLevelName(),H,I);l.shiftKey?void 0!==J.left&&(void 0!==J.left.sampleStart?J.left.sampleStart>=b.curViewPort.sS&&(b.setcurClickItem(J.left),h.setlasteditArea("_"+J.left.id)):J.left.samplePoint>=b.curViewPort.sS&&(b.setcurClickItem(J.left,J.left.id),h.setlasteditArea("_"+J.left.id))):void 0!==J.right&&(void 0!==J.right.sampleStart?J.right.sampleStart+J.right.sampleDur<=b.curViewPort.eS&&(b.setcurClickItem(J.right),h.setlasteditArea("_"+J.right.id)):J.right.samplePoint<b.curViewPort.eS&&(b.setcurClickItem(J.right),h.setlasteditArea("_"+J.right.id)))}if(d===f.vals.keyMappings.createNewItemAtSelection)if(c.isOpen)c.confirmContent();else if(void 0===b.curClickLevelIndex)c.open("views/error.html","Modify Error: Please select a Segment or Event Level first.");else if(b.getPermission("labelAction")&&f.vals.restrictions.addItem)if(b.getselectedRange().start===b.curViewPort.selectS&&b.getselectedRange().end===b.curViewPort.selectE)1===b.getcurClickItems().length?b.getselectedRange().start>=b.curViewPort.sS&&b.getselectedRange().end<=b.curViewPort.eS&&(b.setEditing(!0),h.openEditArea(b.getcurClickItems()[0],h.getlasteditAreaElem(),b.getcurClickLevelType()),a.cursorInTextField()):c.open("views/error.html","Modify Error: Please select a single Segment.");else if(-1==b.curViewPort.selectE&&-1==b.curViewPort.selectS)c.open("views/error.html","Error : Please select a Segment or Point to modify it's name. Or select a level plus a range in the viewport in order to insert a new Segment.");else{var E=h.getClosestItem(b.curViewPort.selectS,b.getcurClickLevelName(),e.wavJSO.Data.length).current;if("SEGMENT"===b.getcurClickLevelType())if(void 0===E){var M=h.insertSegment(b.getcurClickLevelName(),b.curViewPort.selectS,b.curViewPort.selectE,f.vals.labelCanvasConfig.newSegmentName);M.ret?g.addObjToUndoStack({type:"ANNOT",action:"INSERTSEGMENTS",name:b.getcurClickLevelName(),start:b.curViewPort.selectS,end:b.curViewPort.selectE,ids:M.ids,segName:f.vals.labelCanvasConfig.newSegmentName}):c.open("views/error.html","Error : You are not allowed to insert a Segment here.")}else if(E.sampleStart===b.curViewPort.selectS&&E.sampleStart+E.sampleDur+1===b.curViewPort.selectE)b.setcurClickLevel(b.getcurClickLevelName(),b.getcurClickLevelType(),a.$index),b.setcurClickItem(E.current),h.setlasteditArea("_"+E.id),h.openEditArea(E,h.getlasteditAreaElem(),b.getcurClickLevelType()),b.setEditing(!0);else{var M=h.insertSegment(b.getcurClickLevelName(),b.curViewPort.selectS,b.curViewPort.selectE,f.vals.labelCanvasConfig.newSegmentName);M.ret?g.addObjToUndoStack({type:"ANNOT",action:"INSERTSEGMENTS",name:b.getcurClickLevelName(),start:b.curViewPort.selectS,end:b.curViewPort.selectE,ids:M.ids,segName:f.vals.labelCanvasConfig.newSegmentName}):c.open("views/error.html","Error : You are not allowed to insert a Segment here.")}else{var N=f.getLevelDefinition(b.getcurClickLevelName());if("undefined"==typeof N.anagestConfig){var O=h.insertEvent(b.getcurClickLevelName(),b.curViewPort.selectS,f.vals.labelCanvasConfig.newEventName);O.alreadyExists?(b.setcurClickLevel(b.getcurClickLevelName(),b.getcurClickLevelType(),a.$index),b.setcurClickItem(E.current),h.setlasteditArea("_"+E.id),h.openEditArea(E,h.getlasteditAreaElem(),b.getcurClickLevelType()),b.setEditing(!0)):g.addObjToUndoStack({type:"ANNOT",action:"INSERTEVENT",name:b.getcurClickLevelName(),start:b.curViewPort.selectS,id:O.id,pointName:f.vals.labelCanvasConfig.newEventName})}else k.insertAnagestEvents()}}if(d===f.vals.keyMappings.undo&&b.getPermission("labelAction")&&g.undo(),d===f.vals.keyMappings.redo&&b.getPermission("labelAction")&&g.redo(),d===f.vals.keyMappings.deletePreselBoundary&&b.getPermission("labelAction")){l.preventDefault();var E=b.getcurMouseItem(),P=b.getcurClickItems(),Q=b.getcurMouseisFirst(),R=b.getcurMouseisLast(),F=b.getcurMouseLevelName(),S=b.getcurMouseLevelType();if(l.shiftKey){if(f.vals.restrictions.deleteItem&&void 0!==P&&P.length>0)if("SEGMENT"===b.getcurClickLevelType()){var T=h.deleteSegments(F,P[0].id,P.length);g.updateCurChangeObj({type:"ANNOT",action:"DELETESEGMENTS",name:F,id:P[0].id,length:P.length,deletedSegment:T});var U=j.deleteLinkSegment(P);g.updateCurChangeObj({type:"ANNOT",action:"DELETELINKSEGMENT",name:F,segments:P,deletedLinks:U}),g.addCurChangeObjToUndoStack();var V=h.getClosestItem(b.getLasPcm()+b.curViewPort.sS,F,e.wavJSO.Data.length);if(void 0!==V.current&&void 0!==V.nearest){var J=h.getItemNeighboursFromLevel(p,V.nearest.id,V.nearest.id);b.setcurMouseItem(V.nearest,J,b.getLasPcm(),V.isFirst,V.isLast)}b.setcurClickItem(T.clickSeg)}else c.open("views/error.html","Delete Error: You can not delete Segments on Point Levels.")}else if(f.vals.restrictions.deleteItemBoundary&&void 0!==E){var W=h.getItemNeighboursFromLevel(F,E.id,E.id);if("SEGMENT"===S){var T=h.deleteBoundary(F,E.id,Q,R);g.updateCurChangeObj({type:"ANNOT",action:"DELETEBOUNDARY",name:F,id:E.id,isFirst:Q,isLast:R,deletedSegment:T});var U;void 0!==W.left?(U=j.deleteLinkBoundary(E.id,W.left.id),g.updateCurChangeObj({type:"ANNOT",action:"DELETELINKBOUNDARY",name:F,id:E.id,neighbourId:W.left.id,deletedLinks:U})):(U=j.deleteLinkBoundary(E.id,-1),g.updateCurChangeObj({type:"ANNOT",action:"DELETELINKBOUNDARY",name:F,id:E.id,neighbourId:-1,deletedLinks:U})),g.addCurChangeObjToUndoStack();var V=h.getClosestItem(b.getLasPcm()+b.curViewPort.sS,F,e.wavJSO.Data.length);if(void 0!==V.current&&void 0!==V.nearest){var J=h.getItemNeighboursFromLevel(p,V.nearest.id,V.nearest.id);b.setcurMouseItem(V.nearest,J,b.getLasPcm(),V.isFirst,V.isLast)}b.setcurClickItem(T.clickSeg)}else{var X=h.deleteEvent(F,E.id);if(X!==!1){g.updateCurChangeObj({type:"ANNOT",action:"DELETEEVENT",name:F,start:X.samplePoint,id:X.id,pointName:X.labels[0].value}),g.addCurChangeObjToUndoStack();var V=h.getClosestItem(b.getLasPcm()+b.curViewPort.sS,F,e.wavJSO.Data.length);if(void 0!==V.current&&void 0!==V.nearest){var J=h.getItemNeighboursFromLevel(p,V.nearest.id,V.nearest.id);b.setcurMouseItem(V.nearest,J,b.getLasPcm(),V.isFirst,V.isLast)}}else b.setcurMouseItem(void 0,void 0,void 0,void 0,void 0)}}}l.metaKey||l.ctrlKey||(l.preventDefault(),l.stopPropagation())}})},a.safeApply=function(a){var b=this.$root.$$phase;"$apply"==b||"$digest"==b?a&&"function"==typeof a&&a():this.$apply(a)},a.$on("$destroy",function(){$(window).off("keydown")})}}}]),angular.module("emuwebApp").directive("delete",["modalService",function(a){return{restrict:"A",link:function(b,c,d){c.bind("click",function(){b.vs.setcurClickLevelName(b.level.name,d["delete"]),b.vs.setcurClickLevel(b.level.name,b.level.type,b.order),a.open("views/deleteLevel.html",b.level.name)})}}}]),angular.module("emuwebApp").directive("resize",["LevelService","viewState",function(a,b){return{restrict:"A",link:function(c,d){var e=d.parent().parent(),f=0,g=e.find(d.parent().children()[0]),h=(e.find(d.parent().children()[1]),e.find(d.parent().children()[2]));d.bind("click",function(){a.deleteEditArea(),b.setEditing(!1),c.open?(c.open=!1,f=e.css("height"),e.css({height:"25px"}),c.cps.vals.activeButtons.deleteSingleLevel&&g.hide(),c.cps.vals.activeButtons.saveSingleLevel&&h.hide()):(c.open=!0,e.css({height:f}),c.cps.vals.activeButtons.deleteSingleLevel&&g.show(),c.cps.vals.activeButtons.saveSingleLevel&&h.show()),c.updateView()})}}}]),angular.module("emuwebApp").directive("enlarge",["$rootScope","viewState","ConfigProviderService",function(a,b,c){return{restrict:"A",link:function(d,e,f){d.$watch("viewState.curPerspectiveIdx",function(){$.isEmptyObject(c.vals.perspectives)||$.isEmptyObject(b.curPerspectiveIdx)||(1===c.vals.perspectives[b.curPerspectiveIdx].signalCanvases.order.length?e.hide():e.show())},!0);var g=!1;e.bind("click",function(){g?(g=!1,b.setenlarge(-1)):(g=!0,b.setenlarge(f.enlarge)),a.$apply()})}}}]),angular.module("emuwebApp").directive("save",["modalService","Espsparserservice",function(a,b){return{restrict:"A",link:function(c,d,e){d.bind("click",function(){c.vs.setcurClickLevelName(c.level.name,e.save),b.asyncParseJSO(c.level.name).then(function(b){a.open("views/export.html",name+"_esps.txt",b)})})}}}]),angular.module("emuwebApp").directive("slideToggle",function(){return{restrict:"A",scope:{isOpen:"=slideToggle"},link:function(a,b,c){var d=parseInt(c.slideToggleDuration,10)||200;a.isOpen||b.stop().slideToggle(0),a.$watch("isOpen",function(a,c){a!==c&&b.stop().slideToggle(d)})}}}),angular.module("emuwebApp").directive("previewtrack",["viewState","Soundhandlerservice",function(a,b){return{restrict:"A",scope:{},link:function(c,d){var e=-1;d.bind("click",function(d){if(!$.isEmptyObject(b.wavJSO)){var f=a.curViewPort.eS-a.curViewPort.sS;e=a.getX(d)*(b.wavJSO.Data.length/d.originalEvent.target.width),0>e-f/2?e=Math.ceil(f/2):e+f/2>b.wavJSO.Data.length&&(e=Math.floor(b.wavJSO.Data.length-f/2)),a.isEditing()||c.$apply(function(){a.setViewPort(e-f/2,e+f/2)})}}),d.bind("mousedown",function(c){$.isEmptyObject(b.wavJSO)||(e=a.getX(c)*(b.wavJSO.Data.length/c.originalEvent.target.width))}),d.bind("mousemove",function(d){var f=0;switch(f=void 0===d.buttons?d.which:d.buttons){case 1:if(-1!==e){var g=a.curViewPort.eS-a.curViewPort.sS;e=a.getX(d)*(b.wavJSO.Data.length/d.originalEvent.target.width),a.isEditing()||c.$apply(function(){a.setViewPort(e-g/2,e+g/2)})}}}),d.bind("mouseup",function(){e=-1}),d.bind("mouseout",function(){e=-1})}}}]),angular.module("emuwebApp").service("Iohandlerservice",["$rootScope","$http","$location","$q","HistoryService","viewState","Soundhandlerservice","Ssffparserservice","Wavparserservice","Textgridparserservice","ConfigProviderService","Espsparserservice","Ssffdataservice","Websockethandler","DragnDropDataService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){var p={};return p.wsH=n,p.httpGetDefaultConfig=function(){var a=b.get("configFiles/default_emuwebappConfig.json");return a},p.httpGetDefaultDesign=function(){var a=b.get("configFiles/default_emuwebappDesign.json");return a},p.httpGetPath=function(a,c){var d=b.get(a,{responseType:c});return d},p.getProtocol=function(){var a;return"CORS"===k.vals.main.comMode?alert("CORS version of getProtocol not implemented"):"WS"===k.vals.main.comMode&&(a=n.getProtocol()),a},p.getDoUserManagement=function(){var a;return"CORS"===k.vals.main.comMode?alert("CORS version of getDoUserManagement not implemented"):"WS"===k.vals.main.comMode&&(a=n.getDoUserManagement()),a},p.logOnUser=function(a,b){var c;return"CORS"===k.vals.main.comMode?alert("CORS version of logOnUser not implemented"):"WS"===k.vals.main.comMode&&(c=n.logOnUser(a,b)),c},p.getDBconfigFile=function(a){var c;return"CORS"===k.vals.main.comMode?alert("CORS version of getDBconfigFile not implemented"):"WS"===k.vals.main.comMode?c=n.getDBconfigFile():"DEMO"===k.vals.main.comMode&&(c=b.get("demoDBs/"+a+"/"+a+"_DBconfig.json")),c},p.getBundleList=function(a){var c;return"CORS"===k.vals.main.comMode?alert("CORS version of getBundleList not implemented"):"WS"===k.vals.main.comMode?c=n.getBundleList():"DEMO"===k.vals.main.comMode&&(c=b.get("demoDBs/"+a+"/"+a+"_bundleList.json")),c},p.getBundle=function(a,c,d){var e;return"CORS"===k.vals.main.comMode?alert("CORS version of getBundle not implemented"):"EMBEDDED"===k.vals.main.comMode?e=o.getBundle(a,c):"WS"===k.vals.main.comMode?e=n.getBundle(a,c):"DEMO"===k.vals.main.comMode&&(e=b.get("demoDBs/"+d+"/"+a+"_bndl.json")),e},p.saveBundle=function(a){var b;return"CORS"===k.vals.main.comMode?alert("CORS version of saveBundle not implemented"):"WS"===k.vals.main.comMode&&(b=n.saveBundle(a)),b},p.saveConfiguration=function(a){var b;return"CORS"===k.vals.main.comMode?alert("CORS version of saveBundle not implemented"):"WS"===k.vals.main.comMode&&(b=n.saveConfiguration(a)),b},p.parseLabelFile=function(a,b,c,e){var f;if("ESPS"===e)f=l.asyncParseEsps(a,k.embeddedVals.labelGetUrl,"embeddedESPS");else if("TEXTGRID"===e)f=j.asyncParseTextGrid(a,k.embeddedVals.labelGetUrl,"embeddedTEXTGRID");else if("annotJSON"===e){var g=d.defer();f=g.promise,g.resolve(angular.fromJson(a))}return f},p}]),angular.module("emuwebApp").service("Soundhandlerservice",["$document",function(a){function b(){try{window.AudioContext=window.AudioContext||window.webkitAudioContext,c=new AudioContext}catch(a){alert("Error loading the AudioContext (could mean your browser doesn't support the HTML5 webaudio API):"+a)}}var c,d,e={};return e.wavJSO={},e.isPlaying=!1,e.decodeAndPlay=function(a){"undefined"==typeof c&&b(),c.decodeAudioData(a,function(a){d=c.createBufferSource(),d.buffer=a,d.connect(c.destination),d.start(0),d.onended=function(){e.isPlaying=!1}},function(a){alert(a)})},e.extractRelPartOfWav=function(a,b){var c=e.wavJSO.BitsPerSample/8,d=e.wavJSO.origArrBuf.subarray(0,44),f=e.wavJSO.origArrBuf.subarray(44,e.wavJSO.Data.length*c),g=new DataView(d);g.setUint32(40,(b-a)*c,!0);var h=f.subarray(a*c,(b-a)*c),i=new Uint8Array(d.byteLength+h.byteLength);return i.set(new Uint8Array(d),0),i.set(new Uint8Array(h),d.byteLength),i.buffer},e.playFromTo=function(a,b){var c=this.extractRelPartOfWav(a,b);e.isPlaying?(e.isPlaying=!1,d.stop(0)):(e.isPlaying=!0,c.byteLength>44&&e.decodeAndPlay(c))},e}]),angular.module("emuwebApp").directive("drawssff",["$timeout","viewState","ConfigProviderService","Ssffdataservice","HistoryService","fontScaleService","loadedMetaDataService",function(a,b,c,d,e,f,g){return{restrict:"A",scope:{},link:function(h,i,j){h.trackName=j.ssffTrackname,h.assTrackName="",h.lastDraw=Date.now(),h.vs=b,h.hists=e,h.ssffds=d,h.cps=c,h.lmds=g,j.$observe("ssffTrackname",function(a){h.trackName=a}),h.$watch("vs.curViewPort",function(a,b){(b.sS!==a.sS||b.eS!==a.eS)&&h.handleUpdate(),b.windowWidth!==a.windowWidth&&h.handleUpdate(),b.dragBarHeight!==a.dragBarHeight&&h.handleUpdate()},!0),h.$watch("vs.curPerspectiveIdx",function(a,b){h.handleUpdate()},!0),h.$watch("vs.curCorrectionToolNr",function(a,b){h.handleUpdate()},!0),h.$watch("hists.movesAwayFromLastSave",function(a,b){h.handleUpdate()},!0),h.$watch("ssffds.data.length",function(a,b){h.handleUpdate()},!0),h.$watch("vs.spectroSettings",function(a,b){h.handleUpdate()},!0),h.$watch("vs.submenuOpen",function(b,d){b!==d&&a(h.handleUpdate,c.design.animation.duration)}),h.$watch("vs.timelineSize",function(b,d){b!==d&&a(h.handleUpdate,c.design.animation.duration/10)}),h.$watch("lmds.getCurBndl()",function(a,b){(a.name!==b.name||a.session!==b.session)&&h.handleUpdate()},!0),h.handleUpdate=function(){var a=i[0].getContext("2d");if(a.clearRect(0,0,i[0].width,i[0].height),$.isEmptyObject(d.data))a.clearRect(0,0,i[0].width,i[0].height);else if(0!==d.data.length&&(h.assTrackName="",c.vals.perspectives[b.curPerspectiveIdx].signalCanvases.assign.forEach(function(a,e){if(a.signalCanvasName===h.trackName){h.assTrackName=a.ssffTrackName;var f=c.getSsffTrackConfig(a.ssffTrackName),g=d.getColumnOfTrack(f.name,f.columnName),j=d.getSampleRateAndStartTimeOfTrack(f.name),k=c.getLimsOfTrack(f.name);h.drawValues(b,i[0],c,g,j.sampleRate,j.startTime,k)}}),h.assTrackName="","OSCI"!==h.trackName&&"SPEC"!==h.trackName)){var e=c.getSsffTrackConfig(h.trackName),f=d.getColumnOfTrack(e.name,e.columnName),g=d.getSampleRateAndStartTimeOfTrack(e.name),j=c.getLimsOfTrack(e.name);h.drawValues(b,i[0],c,f,g.sampleRate,g.startTime,j)}},h.drawValues=function(a,b,d,e,g,i,j){var k,l,m=b.getContext("2d");"SPEC"===h.trackName&&"FORMANTS"===h.assTrackName?(k=a.spectroSettings.rangeFrom,l=a.spectroSettings.rangeTo):(k=e._minVal,l=e._maxVal);var n=a.getViewPortStartTime(),o=a.getViewPortEndTime(),p=Math.round(n*g+i),q=Math.round(o*g+i),r=q-p,s=e.values.slice(p,p+r);if(r<b.width&&r>=2){var t,u,v,w;angular.forEach(s[0],function(d,f){if($.isEmptyObject(j)||f>=j.minContourIdx&&f<=j.maxContourIdx){if($.isEmptyObject(j))m.strokeStyle="hsl("+f*(360/s[0].length)+",80%, 50%)",m.fillStyle="hsl("+f*(360/s[0].length)+",80%, 50%)";else{var r=j.maxContourIdx-j.minContourIdx+1;m.strokeStyle="hsl("+f*(360/r)+",80%, 50%)",m.fillStyle="hsl("+f*(360/r)+",80%, 50%)"}var x=c.getContourColorsOfTrack(h.assTrackName);if(void 0!==x&&void 0!==x.colors[f]&&(m.strokeStyle=c.vals.perspectives[a.curPerspectiveIdx].signalCanvases.contourColors[0].colors[f],m.fillStyle=c.vals.perspectives[a.curPerspectiveIdx].signalCanvases.contourColors[0].colors[f]),a.curCorrectionToolNr-1===f&&"SPEC"===h.trackName&&"FORMANTS"===h.assTrackName&&(m.strokeStyle=c.design.color.green,m.fillStyle=c.design.color.green),m.beginPath(),p>=1){var y=e.values[p-1],z=y[f];v=p-1,w=1/g*v+i,t=(w-n)/(o-n)*b.width,u=b.height-(z-k)/(l-k)*b.height,m.moveTo(t,u)}if(angular.forEach(s,function(a,c){v=p+c,w=1/g*v+i,t=(w-n)/(o-n)*b.width,u=b.height-(a[f]-k)/(l-k)*b.height,m.arc(t,u-1,2,0,2*Math.PI,!1),m.lineTo(t,u)}),q<e.values.length-1){var A=e.values[q+1],B=A[f];v=q+1,w=1/g*v+i,t=(w-n)/(o-n)*b.width,u=b.height-(B-k)/(l-k)*b.height,m.lineTo(t,u)}m.stroke()}})}else m.strokeStyle="red",2>=r?f.drawUndistortedTextTwoLines(m,"Zoom out to","see contour(s)",c.design.font.small.size.slice(0,-2)/1.05,c.design.font.small.family,b.width/2-m.measureText("see contour(s)").width*m.canvas.width/m.canvas.offsetWidth/2,25,c.design.color.transparent.red):f.drawUndistortedTextTwoLines(m,"Zoom in to","see contour(s)",c.design.font.small.size.slice(0,-2)/1.05,c.design.font.small.family,b.width/2-m.measureText("see contour(s)").width*m.canvas.width/m.canvas.offsetWidth/2,25,c.design.color.transparent.red)}}}}]),angular.module("emuwebApp").service("Ssffparserservice",["$q",function(a){var b,c={},d=new ssffParserWorker;return d.says(function(a){"SUCCESS"===a.status.type?b.resolve(a):b.reject(a)},!1),c.asyncParseSsffArr=function(c){return b=a.defer(),d.tell({cmd:"parseArr",ssffArr:c}),b.promise},c.asyncJso2ssff=function(c){return b=a.defer(),d.tell({cmd:"jso2ssff",jso:JSON.stringify(c)}),b.promise},c}]),angular.module("emuwebApp").directive("mouseTrackAndCorrectionTool",["viewState","ConfigProviderService","Ssffdataservice","Drawhelperservice","HistoryService","Soundhandlerservice",function(a,b,c,d,e,f){return{restrict:"A",scope:{},link:function(g,h,i){var j,k,l,m,n,o,p=h[0],q=p.getContext("2d");i.$observe("ssffTrackname",function(a){a&&(n=a)}),i.$observe("bundleName",function(a){a&&(o=a,$.isEmptyObject(c.data)||0!==c.data.length&&(k=b.getSsffTrackConfig("FORMANTS"),void 0!==k&&(l=c.getColumnOfTrack(k.name,k.columnName),m=c.getSampleRateAndStartTimeOfTrack(k.name))))}),h.bind("mousedown",function(b){a.curViewPort.movingS=Math.round(a.getX(b)*a.getSamplesPerPixelVal(b)+a.curViewPort.sS),a.curViewPort.movingE=a.curViewPort.movingS,a.select(a.curViewPort.movingS,a.curViewPort.movingE),g.switchMarkupContext(b),g.$apply()}),h.bind("mousemove",function(d){var f=0;f=void 0===d.buttons?d.which:d.buttons;var i=a.getX(d);switch(a.curMousePosSample=Math.round(a.curViewPort.sS+i/h[0].width*(a.curViewPort.eS-a.curViewPort.sS)),f){case 0:if(a.getPermission("labelAction")&&(g.switchMarkupContext(d),!($.isEmptyObject(c.data)||0===c.data.length||a.getdragBarActive()||void 0===a.curCorrectionToolNr||a.getdragBarActive()||$.isEmptyObject(b.getAssignment(n))))){void 0===k&&(k=b.getSsffTrackConfig("FORMANTS")),l=c.getColumnOfTrack(k.name,k.columnName),m=c.getSampleRateAndStartTimeOfTrack(k.name);var j=a.getViewPortStartTime(),o=a.getViewPortEndTime(),r=Math.round(j*m.sampleRate+m.startTime),s=Math.round(o*m.sampleRate+m.startTime),t=s-r,u=l.values.slice(r,r+t),v=j+a.getX(d)/d.originalEvent.target.width*(o-j),w=Math.round((v+m.startTime)*m.sampleRate)-1,x=1/m.sampleRate*w+m.startTime;if(0>w-r||w-r>=u.length)return;a.curPreselColumnSample=w-r;var y=(x-j)/(o-j)*p.width,z=p.height-u[a.curPreselColumnSample][a.curCorrectionToolNr-1]/(a.spectroSettings.rangeTo-a.spectroSettings.rangeFrom)*p.height;if(q.strokeStyle="black",q.fillStyle="black",q.beginPath(),q.arc(y,z-1,2,0,2*Math.PI,!1),q.closePath(),q.stroke(),q.fill(),d.shiftKey){var A=angular.copy(u[a.curPreselColumnSample][a.curCorrectionToolNr-1]),B=a.spectroSettings.rangeTo-a.getY(d)/d.originalEvent.target.height*a.spectroSettings.rangeTo;u[a.curPreselColumnSample][a.curCorrectionToolNr-1]=a.spectroSettings.rangeTo-a.getY(d)/d.originalEvent.target.height*a.spectroSettings.rangeTo;var C=e.updateCurChangeObj({type:"SSFF",trackName:k.name,sampleBlockIdx:r+a.curPreselColumnSample,sampleIdx:a.curCorrectionToolNr-1,oldValue:A,newValue:B});for(var D in C)x=1/m.sampleRate*C[D].sampleBlockIdx+m.startTime,y=(x-j)/(o-j)*p.width,z=p.height-C[D].newValue/(a.spectroSettings.rangeTo-a.spectroSettings.rangeFrom)*p.height,q.strokeStyle="red",q.fillStyle="red",q.beginPath(),q.arc(y,z-1,2,0,2*Math.PI,!1),q.closePath(),q.stroke(),q.fill()}}break;case 1:a.getdragBarActive()||g.setSelectDrag(d)}g.$apply()}),h.bind("mouseleave",function(b){$.isEmptyObject(f)||$.isEmptyObject(f.wavJSO)||a.getdragBarActive()||a.getPermission("labelAction")&&g.switchMarkupContext(b,!1)}),g.switchMarkupContext=function(e,f){if(q.clearRect(0,0,p.width,p.height),"OSCI"==i.ssffTrackname)d.drawViewPortTimes(q,!0),d.drawCurViewPortSelected(q,!0);else if("SPEC"==i.ssffTrackname)d.drawCurViewPortSelected(q,!1),
d.drawMinMaxAndName(q,"",a.spectroSettings.rangeFrom,a.spectroSettings.rangeTo,2);else{var g=b.getSsffTrackConfig(i.ssffTrackname),h=c.getColumnOfTrack(g.name,g.columnName);d.drawCurViewPortSelected(q,!1),d.drawMinMaxAndName(q,i.ssffTrackname,h._minVal,h._maxVal,2)}f!==!1&&b.vals.restrictions.drawCrossHairs&&d.drawCrossHairs(q,e,a.spectroSettings.rangeFrom,a.spectroSettings.rangeTo,"Hz",i.ssffTrackname),d.drawMovingBoundaryLine(q)},g.setSelectDrag=function(b){j=Math.round(a.getX(b)*a.getSamplesPerPixelVal(b)+a.curViewPort.sS),j>a.curViewPort.movingS?a.curViewPort.movingE=j:a.curViewPort.movingS=j,a.select(a.curViewPort.movingS,a.curViewPort.movingE),g.$apply()}}}}]),angular.module("emuwebApp").service("Drawhelperservice",["viewState","ConfigProviderService","Soundhandlerservice","fontScaleService","Ssffdataservice","mathHelperService",function(a,b,c,d,e,f){function g(a,b,c){return a.measureText(b).width*c}function h(a,b,c,d){return void 0!==b&&b.toString().length>c.toString().length?g(a,b,d):g(a,c,d)}function i(a,c,d,e,f,g,h){var i=g.getContext("2d"),j=1,k=Math.round(d*(g.height/e)),l=c*j,m=Math.round((g.height-k)/2),n=Math.round(f*(g.height/e)),o=(c-1)*j,p=Math.round((g.height-n)/2);i.strokeStyle=b.design.color.black,i.moveTo(o,p),i.lineTo(l,m)}var j={};return j.osciPeaks=[],j.calculatePeaks=function(a,b,c){var d,e=(a.curViewPort.eS+1-a.curViewPort.sS)/b.width,f=1,g=[],h=1/0,i=-(1/0);if(1>=e)d=0===a.curViewPort.sS?c.subarray(a.curViewPort.sS,a.curViewPort.eS+2):c.subarray(a.curViewPort.sS-1,a.curViewPort.eS+2),h=Math.min.apply(Math,d),i=Math.max.apply(Math,d),g=Array.prototype.slice.call(d);else{d=c.subarray(a.curViewPort.sS,a.curViewPort.eS);for(var j=0;j<b.width;j++){for(var k=0,l=0;f>l;l++){for(var m=d.subarray(j*e,(j+1)*e),n=0,o=0,p=m.length;p>o;o++)n+=m[o];k+=n/m.length}g[j]=k,k>i&&(i=k)}}return{peaks:g,minPeak:h,maxPeak:i,samplePerPx:e}},j.freshRedrawDrawOsciOnCanvas=function(a,c,d,e,f){var g=c.getContext("2d");if(g.clearRect(0,0,c.width,c.height),d.peaks&&d.samplePerPx>=1)g.beginPath(),d.peaks.forEach(function(b,e){0!==e&&i(a,e,b,d.maxPeak,d.peaks[e-1],c,f)}),g.stroke();else if(d.samplePerPx<1){var h=1/d.samplePerPx/2,j=a.curViewPort.sS;g.strokeStyle=b.design.color.black,g.fillStyle=b.design.color.black;var k;if(0===a.curViewPort.sS){for(g.moveTo(h,(d.peaks[0]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height),k=0;k<d.peaks.length;k++)g.lineTo(k/d.samplePerPx+h,(d.peaks[k]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height);for(g.stroke(),k=0;k<d.peaks.length;k++)g.beginPath(),g.arc(k/d.samplePerPx+h,(d.peaks[k]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height-3,4,0,2*Math.PI,!1),g.stroke(),g.fill(),f.vals.restrictions.drawSampleNrs&&(g.strokeText(j,k/d.samplePerPx+h,(d.peaks[k]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height-10),j+=1)}else{for(g.beginPath(),g.moveTo(-h,c.height-(d.peaks[0]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height),k=1;k<=d.peaks.length;k++)g.lineTo(k/d.samplePerPx-h,c.height-((d.peaks[k]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height+3));for(g.stroke(),k=1;k<=d.peaks.length;k++)g.beginPath(),g.arc(k/d.samplePerPx-h,c.height-(d.peaks[k]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height-3,4,0,2*Math.PI,!1),g.stroke(),g.fill(),f.vals.restrictions.drawSampleNrs&&(g.fillText(j,k/d.samplePerPx-h,c.height-(d.peaks[k]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height-10),j+=1)}}if(f.vals.restrictions.drawZeroLine)if(g.strokeStyle=b.design.color.blue,g.fillStyle=b.design.color.blue,d.samplePerPx>=1)g.beginPath(),g.moveTo(0,c.height/2),g.lineTo(c.width,c.height/2),g.stroke(),g.fillText("0",5,c.height/2-5,c.width);else{var l=c.height-(0-d.minPeak)/(d.maxPeak-d.minPeak)*c.height;g.beginPath(),g.moveTo(0,l),g.lineTo(c.width,l),g.stroke(),g.fill(),g.fillText("0",5,c.height-(0-d.minPeak)/(d.maxPeak-d.minPeak)*c.height-5,c.width)}},j.drawMovingBoundaryLine=function(c){var d,e;if(e=a.getSampleDist(c.canvas.width),d="SEGMENT"===a.getcurMouseLevelType()?0:e/2,a.movingBoundary){c.fillStyle=b.design.color.blue;var f=Math.round(a.getPos(c.canvas.width,a.movingBoundarySample));a.getcurMouseisLast()?c.fillRect(f+e,0,1,c.canvas.height):c.fillRect(f+d,0,1,c.canvas.height)}},j.drawCurViewPortSelected=function(e,i){var j,k,l,m,n=1*b.design.font.small.size.slice(0,-2);k=a.getSampleDist(e.canvas.width),j="seg"===a.getcurMouseLevelType()?0:k/2;var o=a.getPos(e.canvas.width,a.curViewPort.selectS),p=a.getPos(e.canvas.width,a.curViewPort.selectE);if(o===p)e.fillStyle=b.design.color.transparent.black,e.fillRect(o+j,0,2,e.canvas.height),i&&a.curViewPort.sS!==a.curViewPort.selectS&&-1!==a.curViewPort.selectS&&(m=e.canvas.width/e.canvas.offsetWidth,l=h(e,a.curViewPort.selectS,f.roundToNdigitsAfterDecPoint(a.curViewPort.selectS/c.wavJSO.SampleRate,6),m),d.drawUndistortedTextTwoLines(e,a.curViewPort.selectS,f.roundToNdigitsAfterDecPoint(a.curViewPort.selectS/c.wavJSO.SampleRate,6),n,b.design.font.small.family,p+5,0,b.design.color.black,!0));else if(e.fillStyle=b.design.color.transparent.grey,e.fillRect(o,0,p-o,e.canvas.height),e.strokeStyle=b.design.color.transparent.black,e.beginPath(),e.moveTo(o,0),e.lineTo(o,e.canvas.height),e.moveTo(p,0),e.lineTo(p,e.canvas.height),e.closePath(),e.stroke(),i&&(m=e.canvas.width/e.canvas.offsetWidth,l=h(e,a.curViewPort.selectS,f.roundToNdigitsAfterDecPoint(a.curViewPort.selectS/c.wavJSO.SampleRate,6),m),d.drawUndistortedTextTwoLines(e,a.curViewPort.selectS,f.roundToNdigitsAfterDecPoint(a.curViewPort.selectS/c.wavJSO.SampleRate,6),n,b.design.font.small.family,o-l-5,0,b.design.color.black,!1),d.drawUndistortedTextTwoLines(e,a.curViewPort.selectE,f.roundToNdigitsAfterDecPoint(a.curViewPort.selectE/c.wavJSO.SampleRate,6),n,b.design.font.small.family,p+5,0,b.design.color.black,!0),l=g(e,f.roundToNdigitsAfterDecPoint((a.curViewPort.selectE-a.curViewPort.selectS)/c.wavJSO.SampleRate,6),m),p-o>l)){var q=a.curViewPort.selectE-a.curViewPort.selectS-1,r=f.roundToNdigitsAfterDecPoint((a.curViewPort.selectE-a.curViewPort.selectS)/c.wavJSO.SampleRate,6);l=h(e,q,r,m),d.drawUndistortedTextTwoLines(e,q,r,n,b.design.font.small.family,o+(p-o)/2-l/2,0,b.design.color.black,!1)}},j.drawCrossHairs=function(c,g,h,i,j,k){if(b.vals.restrictions.drawCrossHairs){var l=1*b.design.font.small.size.slice(0,-2);c.strokeStyle=b.design.color.transparent.red,c.fillStyle=b.design.color.transparent.red;var m=a.getX(g),n=a.getY(g);c.font=b.design.font.small.size+"px "+b.design.font.small.family;var o=f.roundToNdigitsAfterDecPoint(i-n/c.canvas.height*i,2),p=c.measureText(o+j).width*d.scaleX,q=Math.round(a.curViewPort.sS+m/c.canvas.width*(a.curViewPort.eS-a.curViewPort.sS)),r=f.roundToNdigitsAfterDecPoint(a.getViewPortStartTime()+m/c.canvas.width*(a.getViewPortEndTime()-a.getViewPortStartTime()),6);if(void 0!==i||void 0!==h)if("OSCI"==k)c.beginPath(),c.moveTo(m,0),c.lineTo(m,c.canvas.height),c.stroke();else if("SPEC"==k)d.drawUndistortedText(c,o+j,l,b.design.font.small.family,5,n,b.design.color.transparent.red,!0),d.drawUndistortedText(c,o+j,l,b.design.font.small.family,c.canvas.width-5-p*(c.canvas.width/c.canvas.offsetWidth),n,b.design.color.transparent.red,!0),c.beginPath(),c.moveTo(0,n),c.lineTo(5,n+5),c.moveTo(0,n),c.lineTo(c.canvas.width,n),c.lineTo(c.canvas.width-5,n+5),c.moveTo(m,0),c.lineTo(m,c.canvas.height),c.stroke();else{var s=b.getSsffTrackConfig(k),t=e.getColumnOfTrack(s.name,s.columnName);o=t._maxVal-n/c.canvas.height*(t._maxVal-t._minVal),o=f.roundToNdigitsAfterDecPoint(o,2),d.drawUndistortedText(c,o,l,b.design.font.small.family,5,n,b.design.color.transparent.red,!0),d.drawUndistortedText(c,o,l,b.design.font.small.family,c.canvas.width-5-p*(c.canvas.width/c.canvas.offsetWidth),n,b.design.color.transparent.red,!0),c.beginPath(),c.moveTo(0,n),c.lineTo(5,n+5),c.moveTo(0,n),c.lineTo(c.canvas.width,n),c.lineTo(c.canvas.width-5,n+5),c.moveTo(m,0),c.lineTo(m,c.canvas.height),c.stroke()}d.drawUndistortedTextTwoLines(c,q,r,l,b.design.font.small.family,m+5,0,b.design.color.transparent.red,!0)}},j.drawMinMaxAndName=function(a,c,e,g,h){a.strokeStyle=b.design.color.black,a.fillStyle=b.design.color.black;var i=1*b.design.font.small.size.slice(0,-2),j=a.canvas.height/a.canvas.offsetHeight,k=3*b.design.font.small.size.slice(0,-2)/4,l=k*j;a.beginPath(),a.moveTo(0,0),a.lineTo(5,5),a.moveTo(0,a.canvas.height),a.lineTo(5,a.canvas.height-5),a.stroke(),a.closePath(),""!==c&&d.drawUndistortedText(a,c,i,b.design.font.small.family,0,a.canvas.height/2-i*j/2,b.design.color.black),void 0!==g&&d.drawUndistortedText(a,"max: "+f.roundToNdigitsAfterDecPoint(g,h),k,b.design.font.small.family,5,5,b.design.color.grey),void 0!==e&&d.drawUndistortedText(a,"min: "+f.roundToNdigitsAfterDecPoint(e,h),k,b.design.font.small.family,5,a.canvas.height-l-5,b.design.color.grey)},j.drawViewPortTimes=function(e){e.strokeStyle=b.design.color.black,e.fillStyle=b.design.color.black,e.font=b.design.font.small.size+" "+b.design.font.small.family;var g=1*b.design.font.small.size.slice(0,-2);e.beginPath(),e.moveTo(0,0),e.lineTo(5,5),e.moveTo(e.canvas.width,0),e.lineTo(e.canvas.width-5,5),e.closePath(),e.stroke();var i,j,k,l=e.canvas.width/e.canvas.offsetWidth;e.canvas.height/e.canvas.offsetHeight,a.curViewPort&&(i=f.roundToNdigitsAfterDecPoint(a.curViewPort.sS/c.wavJSO.SampleRate,6),j=f.roundToNdigitsAfterDecPoint(a.curViewPort.eS/c.wavJSO.SampleRate,6),d.drawUndistortedTextTwoLines(e,a.curViewPort.sS,i,g,b.design.font.small.family,5,5,b.design.color.black,!0),k=h(e,a.curViewPort.eS,j,l),d.drawUndistortedTextTwoLines(e,a.curViewPort.eS,j,g,b.design.font.small.family,e.canvas.width-k-5,0,b.design.color.black,!1))},j}]),angular.module("emuwebApp").service("HistoryService",["$log","$compile","Ssffdataservice","LevelService","LinkService","ConfigProviderService","viewState","Soundhandlerservice","loadedMetaDataService",function(a,b,c,d,e,f,g,h,i){function j(a,b){Object.keys(a).forEach(function(g){var h=a[g];if("SSFF"===h.type)if(b){k.setHistoryActionText(!0,"SSFF manipulation");var j=f.getSsffTrackConfig(h.trackName),l=c.getColumnOfTrack(j.name,j.columnName);l.values[h.sampleBlockIdx][h.sampleIdx]=h.oldValue}else{k.setHistoryActionText(!1,"SSFF manipulation");var j=f.getSsffTrackConfig(h.trackName),l=c.getColumnOfTrack(j.name,j.columnName);l.values[h.sampleBlockIdx][h.sampleIdx]=h.newValue}else if("WEBAPP"===h.type){var m=!1;switch(h.action){case"COMMENT":b?(m=!0,i.setBndlComment(h.initial,h.key,h.index)):i.setBndlComment(h.comment,h.key,h.index);break;case"FINISHED":b?(m=!0,i.setBndlFinished(!h.finished,h.key,h.index)):i.setBndlFinished(h.finished,h.key,h.index)}}else if("ANNOT"===h.type){var m=!1;switch(h.action){case"MOVEBOUNDARY":b?(m=!0,d.moveBoundary(h.name,h.id,-h.movedBy,h.isFirst,h.isLast)):d.moveBoundary(h.name,h.id,h.movedBy,h.isFirst,h.isLast);break;case"MOVESEGMENT":b?(m=!0,d.moveSegment(h.name,h.id,h.length,-h.movedBy)):d.moveSegment(h.name,h.id,h.length,h.movedBy);break;case"MOVEEVENT":b?(m=!0,d.moveEvent(h.name,h.id,-h.movedBy)):d.moveEvent(h.name,h.id,h.movedBy);break;case"RENAMELABEL":b?(m=!0,d.renameLabel(h.name,h.id,h.attrIndex,h.oldValue)):d.renameLabel(h.name,h.id,h.attrIndex,h.newValue);break;case"RENAMELEVEL":b?(m=!0,d.renameLevel(h.newname,h.name,h.curPerspectiveIdx)):d.renameLevel(h.name,h.newname,h.curPerspectiveIdx);break;case"DELETELEVEL":b?(m=!0,d.insertLevel(h.level,h.id,h.curPerspectiveIdx)):d.deleteLevel(h.id,h.curPerspectiveIdx);break;case"DELETEBOUNDARY":b?(m=!0,d.deleteBoundaryInvers(h.name,h.id,h.isFirst,h.isLast,h.deletedSegment)):d.deleteBoundary(h.name,h.id,h.isFirst,h.isLast);break;case"DELETESEGMENTS":b?(m=!0,d.deleteSegmentsInvers(h.name,h.id,h.length,h.deletedSegment)):d.deleteSegments(h.name,h.id,h.length);break;case"DELETEEVENT":b?(m=!0,d.insertEvent(h.name,h.start,h.pointName,h.id)):d.deleteEvent(h.name,h.id);break;case"DELETELINKSTO":b?(m=!0,e.insertLinksTo(h.deletedLinks)):e.deleteLinksTo(h.id);break;case"DELETELINKBOUNDARY":b?(m=!0,e.deleteLinkBoundaryInvers(h.deletedLinks)):e.deleteLinkBoundary(h.id,h.neighbourId);break;case"DELETELINKSEGMENT":b?(m=!0,e.deleteLinkSegmentInvers(h.deletedLinks)):e.deleteLinkSegment(h.segments);break;case"INSERTLEVEL":b?(m=!0,d.deleteLevel(h.id,h.curPerspectiveIdx)):d.insertLevel(h.level,h.id,h.curPerspectiveIdx);break;case"INSERTSEGMENTS":b?(m=!0,d.insertSegmentInvers(h.name,h.start,h.end,h.segName)):d.insertSegment(h.name,h.start,h.end,h.segName,h.ids);break;case"INSERTEVENT":b?(m=!0,d.deleteEvent(h.name,h.id)):d.insertEvent(h.name,h.start,h.pointName,h.id);break;case"INSERTLINKSTO":b?(m=!0,e.deleteLinksTo(h.parentID,h.childIDs)):e.insertLinksTo(h.parentID,h.childIDs);break;case"EXPANDSEGMENTS":b?(m=!0,d.expandSegment(h.rightSide,h.item,h.name,-h.changeTime)):d.expandSegment(h.rightSide,h.item,h.name,h.changeTime)}k.setHistoryActionText(m,h.action)}else if("HIERARCHY"===h.type){var m=!1;switch(h.action){case"DELETELINK":b?(m=!0,e.insertLinkAt(h.fromID,h.toID,h.position)):e.deleteLink(h.fromID,h.toID);break;case"DELETEITEM":b?(m=!0,d.deleteItemWithLinksInvers(h.item,h.levelName,h.position,h.deletedLinks)):d.deleteItemWithLinks(h.item.id);break;case"ADDITEM":b?(m=!0,d.addItemInvers(h.newID)):d.addItem(h.neighborID,h.before,h.newID);break;case"ADDLINK":b?(m=!0,e.deleteLink(h.link.fromID,h.link.toID)):e.insertLink(h.link.fromID,h.link.toID);break;case"PUSHITEM":b?(m=!0,d.addItemInvers(h.newID)):d.pushNewItem(h.level,h.newID)}k.setHistoryActionText(m,h.action)}})}var k={};k.movesAwayFromLastSave=0;var l=[],m=[],n={};return k.updateCurChangeObj=function(a){var b;if("SSFF"===a.type)b=String(a.type+"#"+a.trackName)+"#"+String(a.sampleBlockIdx)+"#"+String(a.sampleIdx),n[b]?(a.oldValue=n[b].oldValue,n[b]=a):n[b]=a;else if("WEBAPP"===a.type)b=String(a.type+"#"+a.action+"#"+a.key+"#"+a.index),n[b]?(a.comment=n[b].comment,n[b]=a):n[b]=a;else if("ANNOT"===a.type)switch(a.action){case"MOVEBOUNDARY":case"MOVEEVENT":case"MOVESEGMENT":case"INSERTEVENT":case"DELETEEVENT":b=String(a.type+"#"+a.action+"#"+a.name+"#"+a.id),n[b]?(a.movedBy+=n[b].movedBy,n[b]=a):n[b]=a;break;case"INSERTLINKSTO":case"DELETELINKSTO":case"DELETELINKBOUNDARY":case"DELETELINKSEGMENT":case"DELETEBOUNDARY":case"DELETESEGMENTS":b=String(a.type+"#"+a.action+"#"+a.name),n[b]?(a.oldValue=n[b].oldValue,n[b]=a):n[b]=a}return n},k.addCurChangeObjToUndoStack=function(){m=[],$.isEmptyObject(n)||(l.push(n),k.movesAwayFromLastSave+=1),a.info(n),n={}},k.addObjToUndoStack=function(a){m=[];var b={},c=String(a.type+"#"+a.action+"#"+a.name+"#"+a.id);b[c]=angular.copy(a),$.isEmptyObject(b)||(l.push(b),k.movesAwayFromLastSave+=1),n={}},k.undo=function(){if(l.length>0){var a=angular.copy(l[l.length-1]);m.push(a),j(a,!0),l.pop(),k.movesAwayFromLastSave-=1}},k.redo=function(){if(m.length>0){var a=angular.copy(m[m.length-1]);l.push(a),j(a,!1),m.pop(),k.movesAwayFromLastSave+=1}},k.getNrOfPossibleUndos=function(){return l.length},k.getCurrentStack=function(){return{undo:l,redo:m}},k.setHistoryActionText=function(a,b){var c="<i>UNDO</i> &#8594; ";a||(c="<i>REDO</i> &#8592; "),g.historyActionTxt=c+b},k.resetToInitState=function(){l=[],m=[],n={},k.movesAwayFromLastSave=0},k}]),angular.module("emuwebApp").service("Wavparserservice",["$q",function(a){var b,c={},d=new wavParserWorker;return d.says(function(a){"SUCCESS"===a.status.type?b.resolve(a.data):b.reject(a)}),c.parseWavArrBuf=function(c){return b=a.defer(),d.tell({cmd:"parseBuf",buffer:c}),b.promise},c}]),angular.module("emuwebApp").service("Textgridparserservice",["$q","DataService","viewState","Soundhandlerservice",function(a,b,c,d){var e,f={},g=new textGridParserWorker;return g.says(function(a){"SUCCESS"===a.status.type?e.resolve(a.data):e.reject(a.data)},!1),f.asyncToTextGrid=function(){return e=a.defer(),g.tell({cmd:"toTextGrid",levels:b.getData().levels,sampleRate:d.wavJSO.SampleRate,buffLength:d.wavJSO.Data.length}),e.promise},f.asyncParseTextGrid=function(b,c,f){return e=a.defer(),g.tell({cmd:"parseTG",textGrid:b,sampleRate:d.wavJSO.SampleRate,annotates:c,name:f}),e.promise},f}]),angular.module("emuwebApp").factory("uuid",function(){function a(a){var b=(Math.random().toString(16)+"000000000").substr(2,8);return a?"-"+b.substr(0,4)+"-"+b.substr(4,4):b}var b={};return b["new"]=function(){return a()+a(!0)+a(!0)+a()},b.newHash=function(){return a()+a(!0)+a(!0)+a()},b.empty=function(){return"00000000-0000-0000-0000-000000000000"},b}),angular.module("emuwebApp").factory("browserDetector",function(){var a={};return a.isMobile={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return a.isMobile.Android()||a.isMobile.BlackBerry()||a.isMobile.iOS()||a.isMobile.Opera()||a.isMobile.Windows()}},a.isBrowser={Firefox:function(){return navigator.userAgent.match(/Firefox/i)},Chrome:function(){return navigator.userAgent.match(/Chrome/i)},InternetExplorer:function(){return navigator.userAgent.match(/MSIE/i)},Opera:function(){return navigator.userAgent.match(/Opera/i)},PhantomJS:function(){return navigator.userAgent.match(/PhantomJS/i)},any:function(){return a.isBrowser.Firefox()||a.isBrowser.Chrome()||a.isBrowser.InternetExplorer()||a.isBrowser.Opera()||a.isBrowser.PhantomJS()}},a.isMobileDevice=function(){var b=a.isMobile.any();return null===b?!1:b.length>0?!0:!1},a.isDesktopDevice=function(){var b=a.isBrowser.any();return null===b?!1:b.length>0?!0:!1},a}),angular.module("emuwebApp").service("fontScaleService",function(){var a={};return a.lastTextWidth=null,a.spaceTop=0,a.scaleY=0,a.scaleX=0,a.drawUndistortedText=function(b,c,d,e,f,g,h){a.scaleY=b.canvas.height/b.canvas.offsetHeight,a.scaleX=b.canvas.width/b.canvas.offsetWidth,b.save(),b.font=d+"px "+e,b.scale(a.scaleX,a.scaleY),b.fillStyle=h,b.fillText(c,f/a.scaleX,(g+d+a.spaceTop)/a.scaleY),b.scale(1,1),b.restore()},a.drawUndistortedTextTwoLines=function(b,c,d,e,f,g,h,i,j){if(a.scaleY=b.canvas.height/b.canvas.offsetHeight,a.scaleX=b.canvas.width/b.canvas.offsetWidth,b.save(),b.font=e+"px "+f,b.fillStyle=i,b.scale(a.scaleX,a.scaleY),j)b.fillText(c,g/a.scaleX,h+e+a.spaceTop),b.fillText(d,g/a.scaleX,h+2*e+a.spaceTop);else{var k=b.measureText(c).width,l=b.measureText(d).width;k>l?(b.fillText(c,g/a.scaleX,h+e+a.spaceTop),b.fillText(d,(g+(k-l))/a.scaleX,h+2*e+a.spaceTop)):(b.fillText(c,(g+(l-k))/a.scaleX,h+e+a.spaceTop),b.fillText(d,g/a.scaleX,h+2*e+a.spaceTop))}b.restore()},a}),angular.module("emuwebApp").service("Espsparserservice",["$q","LevelService","Soundhandlerservice",function(a,b,c){var d,e={},f=new espsParserWorker;return f.says(function(a){"SUCCESS"===a.status.type?d.resolve(a.data):d.reject(a.data)},!1),e.asyncParseEsps=function(b,e,g){return d=a.defer(),f.tell({cmd:"parseESPS",esps:b,sampleRate:c.wavJSO.SampleRate,annotates:e,name:g}),d.promise},e.asyncParseJSO=function(e){return d=a.defer(),f.tell({cmd:"parseJSO",level:b.getLevelDetails(e),sampleRate:c.wavJSO.SampleRate}),d.promise},e}]),angular.module("emuwebApp").controller("LoginCtrl",["$scope","$rootScope","$http","ConfigProviderService","Iohandlerservice","viewState","modalService",function(a,b,c,d,e,f,g){a.loginData={username:"",password:"",errorMsg:""},a.tryLogin=function(){e.logOnUser(a.loginData.username,a.loginData.password).then(function(b){"LOGGEDON"===b?g.confirm():a.loginData.errorMsg="ERROR: "+b})},a.cursorInTextField=function(){f.setEditing(!0),f.setcursorInTextField(!0)},a.cursorOutOfTextField=function(){f.setEditing(!1),f.setcursorInTextField(!1)},a.cancel=function(){g.close()}}]),angular.module("emuwebApp").service("Ssffdataservice",["viewState","Soundhandlerservice","ConfigProviderService",function(a,b,c){var d={};return d.data=[],d.getFile=function(a){var b;return void 0!==c.curDbConfig.ssffTrackDefinitions&&c.curDbConfig.ssffTrackDefinitions.forEach(function(c){c.name===a&&d.data.forEach(function(a){a.fileExtension===c.fileExtension&&(b=a)})}),b},d.getColumnOfTrack=function(a,b){var c,e=d.getFile(a);return void 0!==e?(e.Columns.forEach(function(a){a.name===b&&(c=a)}),c):void 0},d.getSampleRateAndStartTimeOfTrack=function(a){var b={},c=d.getFile(a);return void 0!==c?(b.sampleRate=c.sampleRate,b.startTime=c.startTime,b):void 0},d.calculateSamplePosInVP=function(a,c,d){var e=a/c+d,f=Math.round(e*b.wavJSO.SampleRate);return f},d}]),angular.module("emuwebApp").service("DataService",function(){var a={};return a.data={},a.maxItemID=0,a.getData=function(){return a.data},a.setLevelData=function(b){a.data.levels=b},a.getLevelData=function(){return a.data.levels},a.getLevelOrder=function(b){return void 0!==a.data.levels?a.data.levels.sort(function(a,c){return b.indexOf(a.name)-b.indexOf(c.name)}):void 0},a.getLevelDataAt=function(b){return a.data.levels[b]},a.insertLevelDataAt=function(b,c){a.data.levels.splice(b,0,c)},a.deleteLevelDataAt=function(b){a.data.levels.splice(b,1)},a.getLinkData=function(){return a.data.links},a.setLinkData=function(b){a.data.links=b},a.insertLinkData=function(b){a.data.links.push(b)},a.deleteLinkDataAt=function(b){a.data.links.splice(b,1)},a.insertLinkDataAt=function(b,c){a.data.links.splice(b,0,c)},a.changeLinkDataAt=function(b,c,d){a.data.links[b].fromID=c,a.data.links[b].toID=d},a.setData=function(b){angular.copy(b,a.data),angular.forEach(a.data.levels,function(b){b.items.forEach(function(b){b.id>a.maxItemID&&(a.maxItemID=b.id)})})},a.getNewId=function(){return a.maxItemID+=1,a.maxItemID},a.raiseId=function(b){a.maxItemID+=b},a.lowerId=function(b){a.maxItemID-=b},a}),angular.module("emuwebApp").service("LevelService",["$q","DataService","LinkService","ConfigProviderService","Soundhandlerservice","viewState","Ssffdataservice","ArrayHelperService",function(a,b,c,d,e,f,g,h){function i(a,b){var c;return angular.forEach(b,function(b,d){b.name===a&&(c=d)}),c}var j={};return j.lasteditArea=null,j.lasteditAreaElem=null,j.getLevelDetails=function(a){var c=null;return angular.forEach(b.getLevelData(),function(b){b.name===a&&(c=b)}),c},j.getLevelsByType=function(a){var c=[];return angular.forEach(b.getLevelData(),function(b){a.indexOf(b.type)>=0&&c.push(b)}),c},j.getOrderById=function(a,c){var d=null;return angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a,b){a.id===c&&(d=b)})}),d},j.getIdByOrder=function(a,c){var d=null;return angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a,b){b===c&&(d=a.id)})}),d},j.getItemDetails=function(a,c){var d=null;return angular.forEach(b.getLevelData(),function(b){b.name===a&&(d=b.items[c])}),d},j.getLastItem=function(a){var c=null;return angular.forEach(b.getLevelData(),function(b){b.name===a&&(c=b.items[b.items.length-1])}),c},j.getNextItem=function(a,c){var d=null;return angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a,e){a.id===c&&(d=b.items[e+1])})}),d},j.getItemInTime=function(a,c,d){var e=null,f=1/0,g=j.getItemFromLevelById(a,c);if(null!==g){var h=g.sampleStart||g.samplePoint;angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a){var b=a.sampleStart||a.samplePoint;d?b>h&&f>=b-h&&(f=b-h,e=a):h>b&&f>=h-b&&(f=h-b,e=a)})})}return e},j.getItemFromLevelById=function(a,c){var d=null;return angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a){a.id==c&&(d=a)})}),d},j.getAllLabelsOfLevel=function(a){var b=f.getCurAttrDef(a.name),c=[];return angular.forEach(a.items,function(a){var d=a.labels.map(function(a){return a.name}).indexOf(b);d>=0&&c.push(a.labels[d].value)}),c},j.getLevelName=function(a){var c=null;return angular.forEach(b.getLevelData(),function(b){var d=b.items.map(function(a){return a.id}).indexOf(a);d>=0&&(c=b.name)}),c},j.getLevelAndItem=function(a){var b=j.getLevelName(a);return null!==b?{level:j.getLevelDetails(b),item:j.getItemByID(a)}:null},j.getItemByID=function(a){var c=void 0;return angular.forEach(b.getLevelData(),function(b){var d=b.items.map(function(a){return a.id}).indexOf(a);d>=0&&(c=b.items[d])}),c},j.getItemsFromLevelByIdAndLength=function(a,b,c){for(var d=[],e=b,f=0;c>f;f++){var g=j.getItemFromLevelById(a,e);e=j.getNextItem(a,g.id),d.push(g)}return d},j.getlasteditAreaElem=function(){return j.lasteditAreaElem},j.setlasteditAreaElem=function(a){j.lasteditAreaElem=a},j.setlasteditArea=function(a){j.lasteditArea=a},j.getlasteditArea=function(){return j.lasteditArea},j.getlastID=function(){return j.lasteditArea.substr(1)},j.deleteEditArea=function(){null!==j.getlasteditArea()&&$("."+j.getlasteditArea()).remove(),f.editing=!1},j.openEditArea=function(a,b,c){var d=f.getcurClickLevelName(),e=f.getCurAttrDef(d),g=i(e,a.labels),h=b.find("canvas").context.getContext("2d"),k=h.canvas.clientWidth,l=h.canvas.offsetLeft,m=h.canvas.offsetTop,n=h.canvas.clientHeight-1,o=10;void 0!==g&&a.labels[g].value.length>0&&(o=7*a.labels[g].value.length);var p="";if(a.labels.length>0&&(p=void 0!==a.labels[g]?a.labels[g].value:""),"SEGMENT"===c){var q=Math.floor(f.getPos(k,a.sampleStart)+l),r=Math.ceil(f.getPos(k,a.sampleStart+a.sampleDur+1)+l),s=r-q;j.createEditAreaElement(b,q,m,r-q,n,a.labels[g].value,a.id)}else{var q=f.getPos(k,a.samplePoint)+l-o/2,r=f.getPos(k,a.samplePoint)+l+o/2,s=r-q;2*o>s&&(s=2*o),j.createEditAreaElement(b,q,m,s,n,p,a.id)}j.createSelection(b.find("textarea")[0],0,p.length)},j.createSelection=function(a,b,c){if(a.createTextRange){var d=a.createTextRange();d.collapse(!0),d.moveStart("character",b),d.moveEnd("character",c),d.select()}else a.setSelectionRange?a.setSelectionRange(b,c):a.selectionStart&&(a.selectionStart=b,a.selectionEnd=c);a.focus()},j.createEditAreaElement=function(a,b,c,d,e,f,g){var h="_"+g;a.prepend($("<textarea>").attr({id:h,"class":h+" emuwebapp-label-edit","ng-model":"message",autofocus:"true"}).css({left:Math.round(b+2)+"px",top:Math.round(c+1)+"px",width:Math.round(d)-2+"px",height:Math.round(e)-20+"px","padding-top":Math.round(e/3+1)+"px"}).text(f))},j.insertItemDetails=function(a,c,e,g,h,i){var j,k=d.getLevelDefinition(c).attributeDefinitions,l=f.getCurAttrDef(c);void 0===k&&(k=[]),angular.forEach(b.getLevelData(),function(b){if(b.name===c){if("SEGMENT"==b.type)if(j={id:a,sampleStart:h,sampleDur:i,labels:[]},k.length>0)for(var d=0;d<k.length;d++)k[d].name===l?j.labels.push({name:k[d].name,value:g}):j.labels.push({name:k[d].name,value:g});else j.labels.push({name:c,value:g});else if("EVENT"==b.type)if(j=void 0!==h?{id:a,samplePoint:h,labels:[]}:{id:a,labels:[]},k.length>0)for(var d=0;d<k.length;d++)k[d].name===l?j.labels.push({name:k[d].name,value:g}):j.labels.push({name:k[d].name,value:g});else j.labels.push({name:c,value:g});b.items.splice(e,0,j)}})},j.updateSegment=function(a,c,d,e,f,g){angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a){a.id==c&&(void 0!==f&&(a.sampleStart=f),void 0!==g&&(a.sampleDur=g),void 0!==d&&(a.labels[e].value=d))})})},j.updatePoint=function(a,c,d,e,f){angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a){a.id==c&&(a.samplePoint=f,void 0===e?a.labels[0].value=d:a.labels[e].value=d)})})},j.getItemNeighboursFromLevel=function(a,c,d){var e=void 0,f=void 0;return angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a,g){a.id==c&&(e=b.items[g-1]),a.id==d&&(f=b.items[g+1])})}),{left:e,right:f}},j.getClosestItem=function(a,b,c){var d=j.getLevelDetails(b),e=void 0,f=void 0,g=void 0,h=void 0;if(void 0!==d&&null!==d&&d.items.length>0)if(e=f=d.items[0],g=!0,h=!1,"SEGMENT"===d.type)angular.forEach(d.items,function(b,c){a>=b.sampleStart-.5&&(a<=b.sampleStart+b.sampleDur+.5&&(a-b.sampleStart>=b.sampleDur/2?void 0!==d.items[c+1]?(e=d.items[c],f=d.items[c+1],h=!1):(h=!0,e=f=d.items[d.items.length-1]):(h=!1,e=f=d.items[c])),g=!1),a>=b.sampleStart-.5&&(a<=b.sampleStart+b.sampleDur+.5?e=b:(h=!0,e=f=d.items[d.items.length-1]))});else{var i=0,k=0;g=!1,h=!1,angular.forEach(d.items,function(b,g){k=g<d.items.length-1?b.samplePoint+(d.items[g+1].samplePoint-d.items[g].samplePoint)/2:c,i=g>0?b.samplePoint-(d.items[g].samplePoint-d.items[g-1].samplePoint)/2:0,k>=a&&a>=i&&(e=f=b)})}return{current:e,nearest:f,isFirst:g,isLast:h}},j.deleteLevel=function(a,c){var e=b.getLevelDataAt(a);return b.deleteLevelDataAt(a),d.vals.perspectives[c].levelCanvases.order.splice(a,1),e},j.insertLevel=function(a,c,e){void 0===b.getLevelData()&&b.setLevelData([]),b.insertLevelDataAt(c,a),d.vals.perspectives[e].levelCanvases.order.splice(c,0,a.name)},j.renameLabel=function(a,b,c,d){j.updateSegment(a,b,d,c)},j.renameLevel=function(a,c,e){angular.forEach(b.getLevelData(),function(b){b.name===a&&(b.name=c,angular.forEach(f.curLevelAttrDefs,function(b,c){b.curAttrDefName===a&&b.levelName===a&&f.curLevelAttrDefs.slice(c,1)}),f.curLevelAttrDefs.push({curAttrDefName:c,levelName:c}),angular.forEach(b.items,function(a){a.labels[0].name=c}))}),d.vals.perspectives[e].levelCanvases.order[d.vals.perspectives[e].levelCanvases.order.indexOf(a)]=c},j.deleteSegmentsInvers=function(a,c,d,e){var g,h,k,l=f.getCurAttrDef(a);k=0,angular.forEach(b.getLevelData(),function(b){if(b.name===a){k=e.order;for(h in e.segments)b.items.splice(k++,0,e.segments[h])}});var m=j.getItemNeighboursFromLevel(a,e.segments[0].id,e.segments[e.segments.length-1].id);void 0!==m.left&&void 0===m.right?(g=i(l,m.left.labels),j.updateSegment(a,m.left.id,m.left.labels[g].value,g,m.left.sampleStart,m.left.sampleDur-e.timeRight)):void 0===m.left&&void 0!==m.right?(g=i(l,m.right.labels),j.updateSegment(a,m.right.id,m.right.labels[g].value,g,m.right.sampleStart+e.timeLeft,m.right.sampleDur-e.timeLeft)):void 0===m.left&&void 0===m.right||(g=i(l,m.left.labels),j.updateSegment(a,m.left.id,m.left.labels[g].value,g,m.left.sampleStart,m.left.sampleDur-e.timeLeft),j.updateSegment(a,m.right.id,m.right.labels[g].value,g,m.right.sampleStart+e.timeRight,m.right.sampleDur-e.timeRight))},j.deleteSegments=function(a,c,d){for(var e=j.getItemFromLevelById(a,c),g=j.getOrderById(a,c),h=j.getItemDetails(a,g+d-1),k=j.getItemNeighboursFromLevel(a,e.id,h.id),l=0,m=0,n=null,o=null,p=null,q=f.getCurAttrDef(a),r=i(q,e.labels),s=g;g+d>s;s++)l+=j.getItemDetails(a,s).sampleDur+1;return l%2==0?(l/=2,m=l):(l=Math.ceil(l/2),m=l-1),angular.forEach(b.getLevelData(),function(b){b.name===a&&angular.forEach(b.items,function(a,e){a.id==c&&(n=e,o=b.items.splice(n,d))})}),void 0!==k.left&&void 0===k.right?(j.updateSegment(a,k.left.id,void 0,r,k.left.sampleStart,k.left.sampleDur+m),p=k.left):void 0===k.left&&void 0!==k.right?(j.updateSegment(a,k.right.id,void 0,r,k.right.sampleStart-l,k.right.sampleDur+l),p=k.right):void 0===k.left&&void 0===k.right?f.setcurMouseItem(void 0,void 0,void 0):(j.updateSegment(a,k.left.id,void 0,r,k.left.sampleStart,k.left.sampleDur+l),j.updateSegment(a,k.right.id,void 0,r,k.right.sampleStart-m,k.right.sampleDur+m),p=k.left),{order:n,segments:o,timeLeft:l,timeRight:m,clickSeg:p}},j.insertSegmentInvers=function(a,c,d,e){var f,g=!0;return angular.forEach(b.getLevelData(),function(b){if(b.name===a)if(c==d){var e=-1;if(angular.forEach(b.items,function(a,b){c==a.sampleStart&&(e=b,g=!0)}),g){var h=0;void 0!==b.items[e]&&(h=b.items[e].sampleDur+1),void 0!==b.items[e-1]&&(b.items[e-1].sampleDur+=h),b.items.splice(e,1)}}else{var e=-1;angular.forEach(b.items,function(a,b){c==a.sampleStart&&(e=b,g=!0)}),g&&(void 0===b.items[e+1]?b.items.splice(e-1,2):void 0===b.items[e-1]?b.items.splice(e,2):(h=b.items[e].sampleDur+1,f=b.items[e+1].sampleDur+1,b.items[e-1].sampleDur+=h+f,b.items.splice(e,2)))}}),g},j.insertSegment=function(a,c,d,e,f){var g=!0;return angular.forEach(b.getLevelData(),function(h){if(h.name===a)if(c==d){if(0==h.items.length)return{ret:!1,ids:f};void 0===f&&(f=[],f[0]=b.getNewId());var i=-1;if(c<h.items[0].sampleStart){var k=h.items[0].sampleStart-c;j.insertItemDetails(f[0],a,0,e,c,k-1)}else if(c>h.items[h.items.length-1].sampleStart+h.items[h.items.length-1].sampleDur){var l=h.items[h.items.length-1].sampleStart+h.items[h.items.length-1].sampleDur+1;j.insertItemDetails(f[0],a,h.items.length,e,l,c-l)}else if(angular.forEach(h.items,function(a,b){c>=a.sampleStart&&c<=a.sampleStart+a.sampleDur&&(i=b),
a.sampleStart==c&&(g=!1),a.sampleStart+a.sampleDur+1==c&&(g=!1)}),g){var k=c-h.items[i].sampleStart-1;j.insertItemDetails(f[0],a,i+1,e,c,h.items[i].sampleDur-k-1),h.items[i].sampleDur=k}}else if(void 0===f&&(f=[],f[0]=b.getNewId(),f[1]=b.getNewId()),0==h.items.length)j.insertItemDetails(f[0],a,0,e,c,d-c-1);else if(d<h.items[0].sampleStart){var k=h.items[0].sampleStart-d-1,m=d-c-1;j.insertItemDetails(f[0],a,0,e,d,k),j.insertItemDetails(f[1],a,0,e,c,m)}else if(c>h.items[h.items.length-1].sampleStart+h.items[h.items.length-1].sampleDur){var k=c-(h.items[h.items.length-1].sampleStart+h.items[h.items.length-1].sampleDur)-1,m=d-c-1,n=h.items.length;j.insertItemDetails(f[0],a,n,e,h.items[h.items.length-1].sampleStart+h.items[h.items.length-1].sampleDur,k),j.insertItemDetails(f[1],a,n+1,e,c,m)}else{var i=-1,o=-1;if(angular.forEach(h.items,function(a,b){c>=a.sampleStart&&c<=a.sampleStart+a.sampleDur&&(i=b),d>=a.sampleStart&&d<=a.sampleStart+a.sampleDur&&(o=b)}),g=i===o,g&&-1!==i){var k=c-h.items[i].sampleStart-1,m=d-c-1;j.insertItemDetails(f[0],a,i+1,e,c,m),j.insertItemDetails(f[1],a,i+2,e,d,h.items[i].sampleDur-k-1-m-1),h.items[i].sampleDur=k}}}),{ret:g,ids:f}},j.insertEvent=function(a,c,d,e){var f=!1,g=void 0,h=void 0;return angular.forEach(b.getLevelData(),function(b){b.name===a&&"EVENT"===b.type&&(h=b.items.length>0?b.items[0].samplePoint:0,angular.forEach(b.items,function(a,b){Math.floor(c)===Math.floor(a.samplePoint)&&(f=!0),c>a.samplePoint&&(g=b+1)}))}),f||(void 0===e&&(e=b.getNewId()),j.insertItemDetails(e,a,g,d,c)),{alreadyExists:f,id:e}},j.deleteEvent=function(a,c){var d=!1;return angular.forEach(b.getLevelData(),function(b){b.name===a&&"EVENT"==b.type&&angular.forEach(b.items,function(a,e){d||c==a.id&&(d=a,b.items.splice(e,1))})}),d},j.deleteBoundary=function(a,c,d,e){var f=j.getItemFromLevelById(a,c),g=null,h=null,i=null,k=null;return angular.forEach(b.getLevelData(),function(b){b.name===a&&(g=b.items[0],angular.forEach(b.items,function(a,c){if("SEGMENT"===b.type&&f.sampleStart==a.sampleStart&&f.sampleDur==a.sampleDur)if(0===c&&d)b.items.splice(c,1),h=c,i=a,k=b.items[0];else if(c===b.items.length-1&&e)b.items.splice(c,1),h=c,i=a,k=b.items[b.items.length-1];else{for(var j=0;j<g.labels.length;j++)g.labels[j].value+=a.labels[j].value;g.sampleDur+=a.sampleDur+1,b.items.splice(c,1),h=c,i=a,k=g}g=a}),null==k&&(k=b.items[0]))}),{order:h,event:i,clickSeg:k}},j.deleteBoundaryInvers=function(a,c,d,e,f){angular.forEach(b.getLevelData(),function(b){if(b.name===a){b.items.splice(f.order,0,f.event);var c=f.event.labels[0].value;d||e||(c=b.items[f.order-1].labels[0].value.slice(0,b.items[f.order-1].labels[0].value.length-f.event.labels[0].value.length),b.items[f.order-1].labels[0].value=c,b.items[f.order-1].sampleDur-=f.event.sampleDur+1)}})},j.snapBoundary=function(a,c,d,e,f){var g,h,i,j,k=1/0,l=void 0;return"SEGMENT"==f?i=d.sampleStart:"EVENT"==f&&(i=d.samplePoint),angular.forEach(b.getLevelData(),function(d,e){if(d.name===c){if(a){if(!(e>=1))return!1;g=b.getLevelData()[e-1]}else{if(!(e<b.getLevelData().length-1))return!1;g=b.getLevelData()[e+1]}g.items.forEach(function(a,b){"SEGMENT"==g.type?j=a.sampleStart:"EVENT"==g.type&&(j=a.samplePoint),h=Math.abs(i-j),k>h&&(k=h,l=j-i)})}}),void 0!==l?("SEGMENT"==f?this.moveBoundary(c,d.id,l,0):"EVENT"==f&&this.moveEvent(c,d.id,l),l):!1},j.moveBoundary=function(a,b,c,d,g){var h=j.getItemFromLevelById(a,b),k=f.getCurAttrDef(a),l=i(k,h.labels),m=j.getItemNeighboursFromLevel(a,b,b);if(d){var n=m.right;void 0!==n?h.sampleStart+c>=0&&h.sampleStart+c<n.sampleStart&&j.updateSegment(a,h.id,void 0,l,h.sampleStart+c,h.sampleDur-c):h.sampleStart+c>=0&&h.sampleDur-c>=0&&h.sampleStart+h.sampleDur+c<=e.wavJSO.Data.length&&j.updateSegment(a,h.id,void 0,l,h.sampleStart+c,h.sampleDur-c)}else if(g)h.sampleDur+c>=0&&h.sampleDur+h.sampleStart+c<=e.wavJSO.Data.length&&j.updateSegment(a,h.id,void 0,l,h.sampleStart,h.sampleDur+c);else if(void 0===m.left){var n=m.right;void 0!==n?h.sampleStart+c>=0&&h.sampleStart+c<n.sampleStart&&j.updateSegment(a,h.id,void 0,l,h.sampleStart+c,h.sampleDur-c):h.sampleStart+c>=0&&h.sampleStart+h.sampleDur+c<=e.wavJSO.Data.length&&j.updateSegment(a,h.id,void 0,l,h.sampleStart+c,h.sampleDur-c)}else{var o=m.left;o.sampleDur+c>=0&&h.sampleStart+c>=0&&h.sampleDur-c>=0&&(j.updateSegment(a,m.left.id,void 0,l,o.sampleStart,o.sampleDur+c),j.updateSegment(a,h.id,void 0,l,h.sampleStart+c,h.sampleDur-c))}},j.moveEvent=function(a,d,g){var h=j.getItemFromLevelById(a,d),k=f.getCurAttrDef(a),l=i(k,h.labels);if(c.isLinked(d)){var m=j.getItemNeighboursFromLevel(a,d,d);h.samplePoint+g>0&&h.samplePoint+g<=e.wavJSO.Data.length&&(void 0!==m.left&&void 0!==m.right?h.samplePoint+g>m.left.samplePoint&&h.samplePoint+g<m.right.samplePoint&&j.updatePoint(a,h.id,h.labels[0].value,l,h.samplePoint+g):void 0===m.left&&void 0===m.right?j.updatePoint(a,h.id,h.labels[0].value,l,h.samplePoint+g):void 0===m.left&&void 0!==m.right?h.samplePoint+g>0&&h.samplePoint+g<m.right.samplePoint&&j.updatePoint(a,h.id,h.labels[0].value,l,h.samplePoint+g):void 0!==m.left&&void 0===m.right&&h.samplePoint+g>m.left.samplePoint&&h.samplePoint+g<=e.wavJSO.Data.length&&j.updatePoint(a,h.id,h.labels[0].value,l,h.samplePoint+g))}else h.samplePoint+g>0&&h.samplePoint+g<=e.wavJSO.Data.length&&j.updatePoint(a,h.id,h.labels[0].value,l,h.samplePoint+g),angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.sort(f.sortbystart)})},j.orderPoints=function(a,b){return a.samplePoint>b.samplePoint?1:a.samplePoint<b.samplePoint?-1:0},j.moveSegment=function(a,b,c,d){var g=j.getOrderById(a,b),h=j.getItemDetails(a,g),k=j.getItemDetails(a,g+c-1);if(null!==h&&null!==k){var l=j.getItemNeighboursFromLevel(a,h.id,k.id),m=f.getCurAttrDef(a),n=i(m,h.labels);if(void 0===l.left&&void 0!==l.right){var o=j.getItemFromLevelById(a,l.right.id);if(h.sampleStart+d>0&&l.right.sampleDur-d>=0){j.updateSegment(a,o.id,void 0,n,o.sampleStart+d,o.sampleDur-d);for(var p=g;g+c>p;p++){var q=j.getItemDetails(a,p);j.updateSegment(a,q.id,void 0,n,q.sampleStart+d,q.sampleDur)}}}else if(void 0===l.right&&void 0!==l.left){var r=j.getItemFromLevelById(a,l.left.id);if(l.left.sampleDur+d>=0&&k.sampleStart+k.sampleDur+d<e.wavJSO.Data.length){j.updateSegment(a,r.id,void 0,n,r.sampleStart,r.sampleDur+d);for(var p=g;g+c>p;p++){var q=j.getItemDetails(a,p);j.updateSegment(a,q.id,void 0,n,q.sampleStart+d,q.sampleDur)}}}else if(void 0!==l.right&&void 0!==l.left){var s=j.getItemFromLevelById(a,l.left.id),t=j.getItemFromLevelById(a,l.right.id);if(s.sampleDur+d>=0&&t.sampleDur-d>=0){j.updateSegment(a,s.id,void 0,n,s.sampleStart,s.sampleDur+d),j.updateSegment(a,t.id,void 0,n,t.sampleStart+d,t.sampleDur-d);for(var p=g;g+c>p;p++){var q=j.getItemDetails(a,p);j.updateSegment(a,q.id,void 0,n,q.sampleStart+d,q.sampleDur)}}}else if(void 0===l.right&&void 0===l.left){var u=j.getItemDetails(a,g),v=j.getItemDetails(a,g+c-1);if(u.sampleStart+d>0&&v.sampleDur+v.sampleStart+d<e.wavJSO.Data.length)for(var p=g;g+c>p;p++){var q=j.getItemDetails(a,p);j.updateSegment(a,q.id,void 0,n,q.sampleStart+d,q.sampleDur)}}}},j.expandSegment=function(a,b,c,d){var g,h=0,k=j.getItemNeighboursFromLevel(c,b[0].id,b[b.length-1].id),l=(d*b.length,f.getCurAttrDef(c)),m=i(l,b[0].labels),n=!0;if(a)if(void 0===k.right){var o=b[b.length-1].sampleStart+b[b.length-1].sampleDur+d*b.length;o<=e.wavJSO.Data.length&&angular.forEach(b,function(a){g=j.getItemFromLevelById(c,a.id),j.updateSegment(c,g.id,void 0,m,g.sampleStart+h,g.sampleDur+d),h+=d})}else angular.forEach(b,function(a){a.sampleDur+1+d<0&&(n=!1)}),n&&k.right.sampleDur-d*b.length>0&&(angular.forEach(b,function(a){g=j.getItemFromLevelById(c,a.id),j.updateSegment(c,g.id,void 0,m,g.sampleStart+h,g.sampleDur+d),h+=d}),j.updateSegment(c,k.right.id,void 0,m,k.right.sampleStart+h,k.right.sampleDur-h));else if(void 0===k.left){var p=j.getItemDetails(c,0);p.sampleStart+d*(b.length+1)>0&&angular.forEach(b,function(a){g=j.getItemFromLevelById(c,a.id),j.updateSegment(c,g.id,void 0,g.sampleStart-d,m,g.sampleDur+d)})}else angular.forEach(b,function(a){a.sampleDur+1+d<0&&(n=!1)}),n&&k.left.sampleDur-d*b.length>0&&(h=0,angular.forEach(b,function(a,e){g=j.getItemFromLevelById(c,a.id),h=-(b.length-e)*d,j.updateSegment(c,g.id,void 0,m,g.sampleStart+h,g.sampleDur+d)}),j.updateSegment(c,k.left.id,void 0,m,k.left.sampleStart,k.left.sampleDur-b.length*d))},j.calcDistanceToNearestZeroCrossing=function(a){for(var b=1/0,c=1/0,d=a;d<e.wavJSO.Data.length-1;d++)if(e.wavJSO.Data[d]>=0&&e.wavJSO.Data[d+1]<0||e.wavJSO.Data[d]<0&&e.wavJSO.Data[d+1]>=0){b=d-a;break}for(var d=a;d>1;d--)if(e.wavJSO.Data[d]>=0&&e.wavJSO.Data[d-1]<0||e.wavJSO.Data[d]<0&&e.wavJSO.Data[d-1]>=0){c=d-a;break}var f;return f=Math.abs(c)<Math.abs(b)?c:b+1},j.pushNewItem=function(a,c){var e=j.getLevelDetails(a);if(console.debug(a,e,c),"ITEM"===e.type){if("number"==typeof c)var f={id:c,labels:[]};else var f={id:b.getNewId(),labels:[]};for(var g=d.getLevelDefinition(e.name).attributeDefinitions,h=0;h<g.length;++h)"STRING"===g[h].type?f.labels.push({name:g[h].name,value:""}):f.labels.push({name:g[h].name,value:null});return e.items.push(f),f.id}return-1},j.addItem=function(a,c,e){if(void 0===a)return-1;if("boolean"!=typeof c)return-1;var f=j.getLevelAndItem(a);if(null===f)return console.debug("Could not find item with id:",a),-1;var g=f.level,h=f.item;if("ITEM"===g.type){var i,k=g.items.indexOf(h);if(i=c===!0?k:k+1,void 0===e)var l={id:b.getNewId(),labels:[]};else var l={id:e,labels:[]};for(var m=d.getLevelDefinition(g.name).attributeDefinitions,n=0;n<m.length;++n)"STRING"===m[n].type?l.labels.push({name:m[n].name,value:""}):l.labels.push({name:m[n].name,value:null});return g.items.splice(i,0,l),l.id}return-1},j.addItemInvers=function(a){for(var c=b.getLevelData(),d=0;d<c.length;++d)for(var e=0;e<c[d].items.length;++e)if(c[d].items[e].id===a)return void c[d].items.splice(e,1)},j.deleteItemWithLinks=function(a){var c={item:void 0,levelName:void 0,position:void 0,deletedLinks:[]},d=j.getLevelAndItem(a);if(null===d)return c;var e=d.level,f=d.item;if("ITEM"!==e.type)return c;console.log("Deleting item:",f,"From level:",e),c.item=f,c.levelName=e.name,c.position=e.items.indexOf(f),e.items.splice(e.items.indexOf(f),1);for(var g=b.getLinkData(),h=g.length-1;h>=0;--h)(g[h].fromID===a||g[h].toID===a)&&(console.log("Deleting link",h),c.deletedLinks.push(g[h]),g.splice(h,1));return c},j.deleteItemWithLinksInvers=function(a,c,d,e){j.getLevelDetails(c).items.splice(d,0,a);for(var f=0;f<e.length;++f)b.insertLinkData(e[f])},j}]),angular.module("emuwebApp").service("LinkService",["DataService",function(a){var b={};return b.insertLink=function(b,c){a.insertLinkData({fromID:b,toID:c})},b.insertLinkAt=function(b,c,d){a.insertLinkDataAt(d,{fromID:b,toID:c})},b.deleteLink=function(b,c){var d=-1;return angular.forEach(a.getLinkData(),function(e,f){e.fromID===b&&e.toID===c&&(a.deleteLinkDataAt(f),d=f)}),d},b.linkExists=function(b,c){var d=!1;return angular.forEach(a.getLinkData(),function(a,e){a.fromID===b&&a.toID===c&&(d=!0)}),d},b.hasParents=function(b){var c=!1;return angular.forEach(a.getLinkData(),function(a,d){a.toID===b&&(c=!0)}),c},b.hasChildren=function(b){var c=!1;return angular.forEach(a.getLinkData(),function(a,d){a.fromID===b&&(c=!0)}),c},b.isLinked=function(a){return b.hasChildren(a)||b.hasParents(a)},b.insertLinksTo=function(a,c){angular.forEach(c,function(c){b.insertLink(a,c)})},b.deleteLinksTo=function(a,c){var d=[];return angular.forEach(c,function(c){b.deleteLink(a,c),d.push({fromID:a,toID:c})}),d},b.insertLinksFrom=function(a,c){angular.forEach(a,function(a){b.insertLink(a,c)})},b.deleteLinksFrom=function(a,c){var d=[];return angular.forEach(a,function(a){d.push({fromID:a,toID:c}),b.deleteLink(a,c)}),d},b.getLinksTo=function(b){var c=[];return angular.forEach(a.getLinkData(),function(a,d){a.toID===b&&c.push({link:a,order:d})}),c},b.getLinksFrom=function(b){var c=[];return angular.forEach(a.getLinkData(),function(a,d){a.fromID===b&&c.push({link:a,order:d})}),c},b.changeLinkTo=function(b,c,d){angular.forEach(a.getLinkData(),function(e,f){e.fromID===b&&e.toID===c&&a.changeLinkDataAt(f,b,d)})},b.changeLinkFrom=function(b,c,d){angular.forEach(a.getLinkData(),function(e,f){e.fromID===b&&e.toID===c&&a.changeLinkDataAt(f,d,c)})},b.deleteLinkSegment=function(a){var c=[],d=[];return angular.forEach(a,function(a){angular.forEach(b.getLinksTo(a.id),function(a){c.push({fromID:a.link.fromID,toID:a.link.toID}),b.deleteLink(a.link.fromID,a.link.toID)}),angular.forEach(b.getLinksFrom(a.id),function(a){d.push({fromID:a.link.fromID,toID:a.link.toID}),b.deleteLink(a.link.fromID,a.link.toID)})}),{linksTo:c,linksFrom:d}},b.deleteLinkSegmentInvers=function(a){angular.forEach(a.linksTo,function(a){b.insertLink(a.fromID,a.toID)}),angular.forEach(a.linksFrom,function(a){b.insertLink(a.fromID,a.toID)})},b.deleteLinkBoundary=function(a,c){var d=[],e=[],f=0;return c>0?(angular.forEach(b.getLinksTo(a),function(e){b.linkExists(e.link.fromID,c)?(f=b.deleteLink(e.link.fromID,a),d.push({fromID:e.link.fromID,toID:a,deleted:!0,order:f,neighbourID:0})):(b.changeLinkTo(e.link.fromID,a,c),d.push({fromID:e.link.fromID,toID:a,deleted:!1,order:f,neighbourID:c}))}),angular.forEach(b.getLinksFrom(a),function(d){b.linkExists(c,d.link.toID)?(f=b.deleteLink(a,d.link.toID),e.push({fromID:a,toID:d.link.toID,deleted:!0,order:f,neighbourID:0})):(b.changeLinkFrom(a,d.link.toID,c),e.push({fromID:a,toID:d.link.toID,deleted:!1,order:f,neighbourID:c}))})):(angular.forEach(b.getLinksTo(a),function(c){f=b.deleteLink(c.link.fromID,a),d.push({fromID:c.link.fromID,toID:a,deleted:!0,order:f,neighbourID:0})}),angular.forEach(b.getLinksFrom(a),function(c){f=b.deleteLink(a,c.link.toID),e.push({fromID:a,toID:c.link.toID,deleted:!0,order:f,neighbourID:0})})),{linksTo:d,linksFrom:e}},b.deleteLinkBoundaryInvers=function(a){angular.forEach(a.linksTo,function(a){a.deleted?b.insertLinkAt(a.fromID,a.toID,a.order):b.changeLinkTo(a.fromID,a.neighbourID,a.toID)}),angular.forEach(a.linksFrom,function(a){a.deleted?b.insertLinkAt(a.fromID,a.toID,a.order):b.changeLinkFrom(a.neighbourID,a.toID,a.fromID)})},b}]),angular.module("emuwebApp").service("Websockethandler",["$q","$rootScope","$location","$timeout","HistoryService","Ssffparserservice","ConfigProviderService","viewState","Wavparserservice","Soundhandlerservice","Espsparserservice","uuid","Binarydatamaniphelper","Ssffdataservice","modalService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){function p(a){z=!0,b.$apply(y.resolve(a))}function q(a){u(angular.fromJson(a.data))}function r(a){console.error("WEBSOCKET ERROR!!!!!"),b.$apply(y.resolve(a))}function s(a){!a.wasClean&&z&&o.open("views/error.html","A non clean disconnect to the server occurred! This probably means that the server is down. Please check the server and reconnect!").then(function(){b.$broadcast("connectionDisrupted")}),z=!1,console.log("WEBSOCKET closed!!!!!")}function t(b){var c=a.defer(),e=v();return x[e]={time:new Date,cb:c},b.callbackID=e,w.ws.send(angular.toJson(b)),d(function(){var a={callbackID:e,status:{type:"ERROR:TIMEOUT",message:"Sent request of type: "+b.type+" timed out after "+g.vals.main.serverTimeoutInterval+"ms!  Please check the server..."}};u(a)},g.vals.main.serverTimeoutInterval),c.promise}function u(a){var c=a;if(x.hasOwnProperty(c.callbackID)){switch(c.type){case"getESPSfile":alert("espsfile");break;case"getSSFFfile":alert("ssfffile")}"SUCCESS"===c.status.type?b.$apply(x[c.callbackID].cb.resolve(c.data)):(w.closeConnect(),b.$broadcast("resetToInitState"),b.$apply(o.open("views/error.html","Communication error with server! Error message is: "+c.status.message))),delete x[c.callbackID]}else"ERROR:TIMEOUT"===c.status.type||o.open("views/error.html","What just happened? You should not be here...")}function v(){var a=l["new"]();return a}var w={},x={};w.ws={};var y={},z=!1;return w.initConnect=function(b){var c=a.defer();return w.ws=new WebSocket(b),w.ws.onopen=p,w.ws.onmessage=q,w.ws.onerror=r,w.ws.onclose=s,y=c,c.promise},w.isConnected=function(){return z},w.closeConnect=function(){w.isConnected()?(w.ws.onclose=function(){},w.ws.close()):console.log("WEBSOCKET ERROR: was not connected!")},w.getProtocol=function(){var a={type:"GETPROTOCOL"},b=t(a);return b},w.getDoUserManagement=function(){var a={type:"GETDOUSERMANAGEMENT"},b=t(a);return b},w.logOnUser=function(a,b){var c={type:"LOGONUSER",userName:a,pwd:b},d=t(c);return d},w.getDBconfigFile=function(){var a={type:"GETGLOBALDBCONFIG"},b=t(a);return b},w.getBundleList=function(){var a={type:"GETBUNDLELIST"},b=t(a);return b},w.getBundle=function(a,b){var c={type:"GETBUNDLE",name:a,session:b},d=t(c);return d},w.saveBundle=function(a){var b={type:"SAVEBUNDLE",data:a},c=t(b);return c},w.saveConfiguration=function(a){var b={type:"SAVEDBCONFIG",data:a},c=t(b);return c},w.disconnectWarning=function(){var a={type:"DISCONNECTWARNING"},b=t(a);return b},w.getDoEditDBConfig=function(){var a={type:"GETDOEDITDBCONFIG"},b=t(a);return b},w.editDBConfig=function(a,b){var c={type:"EDITDBCONFIG",subtype:a,data:b},d=t(c);return d},w}]),angular.module("emuwebApp").service("Binarydatamaniphelper",function(){var a={};return a.base64ToArrayBuffer=function(a){for(var b=window.atob(a),c=b.length,d=new Uint8Array(c),e=0;c>e;e++){var f=b.charCodeAt(e);d[e]=f}return d.buffer},a.arrayBufferToBase64=function(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;d>e;e++)b+=String.fromCharCode(c[e]);return window.btoa(b)},a}),angular.module("emuwebApp").service("Appcachehandler",["$http","modalService",function(a,b){var c={},d=window.applicationCache;return c.handleUpdatereadyEvent=function(){b.open("views/confirmModal.html","A new version of the EMU-WebApp is available and has already been downloaded and cached in your browser. Would you like to use it? CAUTION: A reload will delete all current changes... TIP: the next time you use the EMU-webApp you will automatically use the updated version)").then(function(a){a?(localStorage.removeItem("haveShownWelcomeModal"),d.swapCache(),window.location.reload()):localStorage.removeItem("haveShownWelcomeModal")})},d.addEventListener("updateready",c.handleUpdatereadyEvent,!1),c.checkForNewVersion=function(){0!==d.status&&3!==d.status&&(console.log("INFO: appCache.status: "+d.status),d.update())},c}]),angular.module("emuwebApp").controller("spectSettingsCtrl",["$scope","modalService","viewState","DataService","mathHelperService","Soundhandlerservice",function(a,b,c,d,e,f){a.vs=c,a.options=Object.keys(a.vs.getWindowFunctions()),a.selWindowInfo={},a.selWindowInfo.name=Object.keys(a.vs.getWindowFunctions())[a.vs.spectroSettings.window-1],a.errorID=[],a.upperBoundary="",a.modalVals={rangeFrom:a.vs.spectroSettings.rangeFrom,rangeTo:a.vs.spectroSettings.rangeTo,dynamicRange:a.vs.spectroSettings.dynamicRange,windowSizeInSecs:a.vs.spectroSettings.windowSizeInSecs,window:a.vs.spectroSettings.window,drawHeatMapColors:a.vs.spectroSettings.drawHeatMapColors,preEmphasisFilterFactor:a.vs.spectroSettings.preEmphasisFilterFactor,heatMapColorAnchors:c.spectroSettings.heatMapColorAnchors,_fftN:512,_windowSizeInSamples:f.wavJSO.SampleRate*a.vs.spectroSettings.windowSizeInSecs},a.cursorInTextField=function(){c.setEditing(!0),c.setcursorInTextField(!0)},a.cursorOutOfTextField=function(){c.setEditing(!1),c.setcursorInTextField(!1)},a.calcWindowSizeInSamples=function(){a.modalVals._windowSizeInSamples=f.wavJSO.SampleRate*a.modalVals.windowSizeInSecs},a.calcFftN=function(){var b=e.calcClosestPowerOf2Gt(a.modalVals._windowSizeInSamples);512>b&&(b=512),a.modalVals._fftN=b},a.calcWindowSizeVals=function(){a.calcWindowSizeInSamples(),a.calcFftN()},a.reset=function(){a.errorID=[],a.modalVals={rangeFrom:a.vs.spectroSettings.rangeFrom,rangeTo:a.vs.spectroSettings.rangeTo,dynamicRange:a.vs.spectroSettings.dynamicRange,windowSizeInSecs:a.vs.spectroSettings.windowSizeInSecs,window:a.vs.spectroSettings.window,drawHeatMapColors:a.vs.spectroSettings.drawHeatMapColors,preEmphasisFilterFactor:a.vs.spectroSettings.preEmphasisFilterFactor,heatMapColorAnchors:c.spectroSettings.heatMapColorAnchors,_fftN:512,_windowSizeInSamples:f.wavJSO.SampleRate*a.vs.spectroSettings.windowSizeInSecs},b.close()},a.cssError=function(b,c){return a.errorID[b]?{background:"#f00"}:void 0!==c&&a.errorID[c]?{background:"#f00"}:void 0},a.htmlError=function(b){return a.errorID[b]},a.saveSpectroSettings=function(){var b=!1;a.errorID.forEach(function(a){a===!0&&(b=!0)}),b||(c.setspectroSettings(a.modalVals.windowSizeInSecs,a.modalVals.rangeFrom,a.modalVals.rangeTo,a.modalVals.dynamicRange,a.selWindowInfo.name,a.modalVals.drawHeatMapColors,a.modalVals.preEmphasisFilterFactor,a.modalVals.heatMapColorAnchors),a.reset())},a.checkSpectroSettings=function(){a.modalVals.heatMapColorAnchors[0][0]%1!==0||a.modalVals.heatMapColorAnchors[0][1]%1!==0||a.modalVals.heatMapColorAnchors[0][2]%1!==0||a.modalVals.heatMapColorAnchors[1][0]%1!==0||a.modalVals.heatMapColorAnchors[1][1]%1!==0||a.modalVals.heatMapColorAnchors[1][2]%1!==0||a.modalVals.heatMapColorAnchors[2][0]%1!==0||a.modalVals.heatMapColorAnchors[2][1]%1!==0||a.modalVals.heatMapColorAnchors[2][2]%1!==0?a.errorID[8]=!0:a.errorID[8]=!1,isNaN(a.modalVals.preEmphasisFilterFactor*f.wavJSO.SampleRate)?a.errorID[7]=!0:a.errorID[7]=!1,isNaN(f.wavJSO.SampleRate*a.modalVals.windowSizeInSecs)?a.errorID[6]=!0:a.errorID[6]=!1,a.modalVals.dynamicRange%1!==0?a.errorID[5]=!0:a.errorID[5]=!1,a.modalVals.rangeFrom%1!==0?a.errorID[4]=!0:a.errorID[4]=!1,a.modalVals.rangeTo%1!==0?a.errorID[3]=!0:a.errorID[3]=!1,a.modalVals.rangeFrom<0?a.errorID[2]=!0:a.errorID[2]=!1,a.upperBoundary=d.data.sampleRate/2,a.modalVals.rangeTo>a.upperBoundary?a.errorID[1]=!0:a.errorID[1]=!1}}]),angular.module("emuwebApp").filter("regex",function(){return function(a,b){for(var c=new RegExp(b.toLowerCase()),d=[],e=0;e<a.length;e++)c.test(a[e].name.toLowerCase())&&d.push(a[e]);return d}}),angular.module("emuwebApp").filter("levelsFilter",["ConfigProviderService","viewState",function(a,b){return function(c){if(c){for(var d,e=new RegExp("SEGMENT|EVENT"),f=[],g=0;g<c.length;g++)e.test(c[g].type)&&void 0!==a.vals.perspectives[b.curPerspectiveIdx].levelCanvases&&(d=a.vals.perspectives[b.curPerspectiveIdx].levelCanvases.order.indexOf(c[g].name),-1!==d&&f.push(c[g]));return f}}}]),angular.module("emuwebApp").controller("ModalCtrl",["$scope","ArrayHelperService","browserDetector","modalService","viewState","LevelService","HistoryService","ConfigProviderService",function(a,b,c,d,e,f,g,h){a.cps=h,a.vs=e,a.data=void 0,a.mySelect=null,a.cursorInTextField=function(){e.setEditing(!0),e.setcursorInTextField(!0)},a.cursorOutOfTextField=function(){e.setEditing(!1),e.setcursorInTextField(!1)},a.saveChanges=function(a){d.close()},a.discardChanges=function(a){d.close()},a.saveURL=function(){var b=a.getURLs();-1===b.indexOf(d.dataOut)&&b.push(d.dataOut),localStorage.setItem("urls",JSON.stringify(b)),a.myUrls=b,a.mySelect=a.myUrls[0]},a.getURLs=function(){var a=localStorage.getItem("urls"),b=[];return c.isBrowser.PhantomJS()||null===a||(b=JSON.parse(a)),b},a.setCurrentURL=function(a){d.dataOut=a},a.deleteURL=function(b){var c=a.getURLs();-1!==c.indexOf(b)&&c.splice(c.indexOf(b),1),localStorage.setItem("urls",JSON.stringify(c)),a.myUrls=c,a.mySelect=a.myUrls[0]},a.renameLevel=function(){f.renameLevel(d.dataIn,a.data,e.curPerspectiveIdx),g.addObjToUndoStack({type:"ANNOT",action:"RENAMELEVEL",newname:a.data,name:d.dataIn,curPerspectiveIdx:e.curPerspectiveIdx}),d.close()},a.deleteLevel=function(a){var b=f.getLevelDetails(e.getcurClickLevelName());f.deleteLevel(e.getcurClickLevelIndex(),e.curPerspectiveIdx),g.addObjToUndoStack({type:"ANNOT",action:"DELETELEVEL",level:b,id:e.getcurClickLevelIndex(),curPerspectiveIdx:e.curPerspectiveIdx}),d.close()}}]),angular.module("emuwebApp").directive("showMenu",["$animate",function(a){return{restrict:"A",link:function(b,c,d){b.$watch(d.showMenu,function(b){b?(a.addClass(c,"emuwebapp-expandWidthTo200px"),a.removeClass(c,"emuwebapp-shrinkWidthTo0px")):(a.removeClass(c,"emuwebapp-expandWidthTo200px"),a.addClass(c,"emuwebapp-shrinkWidthTo0px"))})}}}]),angular.module("emuwebApp").directive("showTwod",["$animate",function(a){return{restrict:"A",link:function(b,c,d){b.$watch(d.showTwod,function(b){b?a.addClass(c,".slideIn2dCanvases"):a.removeClass(c,".slideIn2dCanvases")})}}}]),angular.module("emuwebApp").animation(".slideIn2dCanvases",function(){return{addClass:function(a,b){a.addClass("slide2dCanvases")},removeClass:function(a,b){a.removeClass("slide2dCanvases")}}}),angular.module("emuwebApp").directive("bgSplitter",["$rootScope","viewState",function(a,b){return{restrict:"E",replace:!0,transclude:!0,scope:{showTwoDimCans:"@"},template:'<div class="emuwebapp-split-panes vertical" ng-transclude></div>',controller:["$scope",function(a){a.panes=[],a.bottomRightResizePane,this.addPane=function(b){if(a.panes.length>1)throw"splitters can only have two panes";return a.panes.push(b),a.panes.length},this.setBottomRightResizePane=function(b){a.bottomRightResizePane=b}}],link:function(c,d,e){var f=!1,g=!1,h=!1,i=angular.element('<div id="emuwebapp-split-handler" class="emuwebapp-split-handler"><span></span></div>'),j=c.panes[0],k=c.panes[1],l=c.bottomRightResizePane,m=angular.element('<div class="topBorder"></div>'),n=angular.element('<div class="leftBorder"></div>'),o=angular.element('<div class="corner"></div>');l.elem.prepend(n),l.elem.prepend(m),l.elem.prepend(o);var p=j.minSize||0,q=k.minSize||0,r=!1,s=!1;j.elem.after(i),e.$observe("showTwoDimCans",function(a){"false"===a?c.bottomRightResizePane.elem.hide():c.bottomRightResizePane.elem.show()}),d.bind("mousemove",function(c){if(s){k.elem[0].scrollHeight>k.elem[0].clientHeight+1?j.elem.css("overflow-y","scroll"):j.elem.css("overflow-y","hidden");var e=d[0].getBoundingClientRect(),m=0;if(r){var n=e.bottom-e.top;if(m=c.clientY-e.top,p>m)return;if(q>n-m)return;i.css("top",m+"px"),j.elem.css("height",m+"px"),k.elem.css("top",m+"px"),b.setdragBarHeight(m),a.$digest()}if(f){var n=e.bottom-e.top;if(m=c.clientY-e.top,10>=m||10>=n-m)return;l.elem.css("top",m+"px");var o=n-m;l.elem.css("height",o+"px")}if(g){var t=e.right-e.left;if(m=c.clientX-e.left,10>=m||10>=t-m)return;var o=t-m;l.elem.css("width",o+"px")}if(h){var n=e.bottom-e.top;if(m=c.clientY-e.top,10>=m||10>=n-m)return;l.elem.css("top",m+"px");var o=n-m;l.elem.css("height",o+"px");var t=e.right-e.left;if(m=c.clientX-e.left,10>=m||10>=t-m)return;var o=t-m;l.elem.css("width",o+"px")}}}),i.bind("mousedown",function(c){c.preventDefault(),s=!0,r=!0,b.setdragBarActive(!0),a.$digest()}),m.bind("mousedown",function(c){c.preventDefault(),s=!0,f=!0,b.setdragBarActive(!0),a.$digest()}),n.bind("mousedown",function(c){c.preventDefault(),s=!0,g=!0,b.setdragBarActive(!0),a.$digest()}),o.bind("mousedown",function(c){c.preventDefault(),s=!0,h=!0,b.setdragBarActive(!0),a.$digest()}),angular.element(document).bind("mouseup",function(c){s=!1,r=!1,f=!1,g=!1,h=!1,b.setdragBarActive(!1),a.$digest()})}}}]).directive("bgPane",function(){return{restrict:"E",require:"^bgSplitter",replace:!0,transclude:!0,scope:{minSize:"=",type:"@",showTwoDimCans:"@"},template:'<div class="{{typeclass}}" ng-transclude></div>',link:function(a,b,c,d){"emuwebapp-2d-map"!==a.type?(a.elem=b,a.index=d.addPane(a),a.typeclass="split-pane"+a.index):(a.elem=b,a.index=3,a.typeclass="emuwebapp-2d-map",d.setBottomRightResizePane(a))}}}),angular.module("emuwebApp").directive("ssffTrack",["$timeout","viewState","ConfigProviderService","loadedMetaDataService",function(a,b,c,d){return{templateUrl:"views/ssffTrack.html",restrict:"E",link:function(b,e,f){var g,h=e.find("canvas").length,i=(e.find("canvas")[1],e.find("canvas")[h-1]),j=i.getContext("2d");b.lmds=d,f.$observe("trackName",function(a){a&&(g=a)}),b.order=f.order,b.$watch("vs.lastUpdate",function(a,c){a!=c&&b.drawSsffTrackMarkup()}),b.$watch("vs.timelineSize",function(){a(b.drawSsffTrackMarkup,c.design.animation.duration)}),b.$watch("vs.curViewPort",function(){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||b.drawSsffTrackMarkup()},!0),b.$watch("ssffds.data.length",function(){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||b.drawSsffTrackMarkup()},!0),b.$watch("vs.movingBoundary",function(){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||b.drawSsffTrackMarkup()},!0),b.$watch("vs.movingBoundarySample",function(){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||b.drawSsffTrackMarkup()},!0),b.$watch("lmds.getCurBndl()",function(a,c){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||(a.name!==c.name||a.session!==c.session)&&b.drawSsffTrackMarkup()},!0),b.drawSsffTrackMarkup=function(){if(!$.isEmptyObject(b.ssffds.data)&&0!==b.ssffds.data.length){j.clearRect(0,0,j.canvas.width,j.canvas.height),b.dhs.drawMovingBoundaryLine(j),b.dhs.drawCurViewPortSelected(j,!1);var a=b.cps.getSsffTrackConfig(g),c=b.ssffds.getColumnOfTrack(a.name,a.columnName);b.dhs.drawMinMaxAndName(j,g,c._minVal,c._maxVal,2)}}}}}]),angular.module("emuwebApp").directive("progressThing",["$animate",function(a){return{template:'<div class="emuwebapp-progressThing">{{vs.somethingInProgressTxt}}</div>',restrict:"E",replace:!0,link:function(b,c,d){d.$observe("showThing",function(b){"true"===b?(a.removeClass(c,"emuwebapp-shrinkHeightTo0px"),a.removeClass(c,"emuwebapp-animationStopped"),a.addClass(c,"emuwebapp-expandHeightTo20px"),a.addClass(c,"emuwebapp-animationRunning")):(a.removeClass(c,"emuwebapp-expandHeightTo20px"),a.removeClass(c,"emuwebapp-animationRunning"),a.addClass(c,"emuwebapp-shrinkHeightTo0px"),a.addClass(c,"emuwebapp-animationStopped"))})}}}]),angular.module("emuwebApp").directive("historyActionPopup",["$animate","$timeout","ConfigProviderService",function(a,b,c){return{template:'<div class="emuwebapp-history"><div ng-bind-html="vs.historyActionTxt"></div></div>',restrict:"E",replace:!0,link:function(d,e,f){d.cps=c,d.$watch("vs.historyActionTxt",function(){""!==d.vs.historyActionTxt&&a.addClass(e,"emuwebapp-history-fade").then(function(){d.$apply(),b(function(){a.removeClass(e,"emuwebapp-history-fade").then(function(){b(function(){d.vs.historyActionTxt=""},d.cps.design.animation.period),d.$apply()})},d.cps.design.animation.period)})},!0)}}}]),angular.module("emuwebApp").directive("dragout",["DataService","loadedMetaDataService","browserDetector","ConfigProviderService",function(a,b,c,d){return{restrict:"A",replace:!0,scope:{name:"@"},link:function(e,f,g){e.cps=d;var h=f[0],i=document.createElement("img");i.src="img/save.svg",i.width="35",i.height="35",e.generateURL=function(){return e.getURL(angular.toJson(a.getData(),!0))},e.isActive=function(){return g.name===b.getCurBndl().name?!0:!1},e.getURL=function(a){var b;return b="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(e.getBlob(a)):URL.createObjectURL(e.getBlob(a))},e.getBlob=function(a){var b;try{b=new Blob([a],{type:"text/plain"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,b=new BlobBuilder,b.append(a),b=b.getBlob()}return b},h.addEventListener("dragstart",function(a){if(console.log("dragstart"),e.isActive()){this.classList.add("drag");var b=e.generateURL();if(c.isBrowser.Firefox()||c.isBrowser.Chrome()){var d=document.createElement("div");d.appendChild(i),document.querySelector("body").appendChild(d),a.dataTransfer.setDragImage(d,-8,-8),a.dataTransfer.effectAllowed="move",a.dataTransfer.setData("DownloadURL","application/json:"+g.name+"_annot.json:"+b)}}else a.preventDefault(),console.log("dropping inactive bundles is not allowed");return!1},!1),h.addEventListener("dragend",function(a){return console.log("dragend"),e.isActive()&&(this.classList.remove("drag"),a.preventDefault()),!1},!1)}}}]),angular.module("emuwebApp").directive("emuhierarchy",["viewState","HistoryService","DataService","LevelService","HierarchyManipulationService","HierarchyLayoutService","Soundhandlerservice","ConfigProviderService","$timeout",function(a,b,c,d,e,f,g,h,i){return{template:'<div class="emuwebapp-hierarchy-container" ng-mousemove="checkLink($event)"></div>',
restrict:"E",scope:{vertical:"=",playing:"="},replace:!0,link:function(j,k,l){j.selectedItem,j.selectedLink,j.newLinkSrc,j.offsetX=25,j.offsetY=30,j.vertOffsetX=150,j.vertOffsetY=25,j.transition={duration:750,links:!1,nodes:!1,rotation:!1,contextMenu:!1},j.scaleExtent=[.5,10],j.panningLimit=.95,j.allowCrossAxisZoom=!1,j.allowCrossAxisPan=!1,j.timeAxisStartPosition=void 0,j.timeAxisEndPosition=void 0,j.crossAxisStartPosition=void 0,j.crossAxisEndPosition=void 0,j.northernBoundary=void 0,j.southernBoundary=void 0,j.westernBoundary=void 0,j.easternBoundary=void 0,j.zoomTimeoutPromise=null,j.lastScaleFactor=1,j.viewState=a,j.hierarchyState=a.hierarchyState,j.historyService=b,j.cps=h,j.$watch("hierarchyState.path",function(a,b){a!==b&&(console.debug("Rendering due to path change: ",a),j.hierarchyState.newLinkFromID=void 0,j.render())},!1),j.$watch("vertical",function(a,b){a!==b&&(console.debug("Rendering due to rotation: ",a),j.rotate())},!1),j.$watch("viewState.curLevelAttrDefs",function(a,b){a!==b&&(console.debug("Rendering due to attribute change: ",a),j.render())},!0),j.$watch("playing",function(a,b){a!==b&&(console.debug("Play() triggered",a,j.selectedItem),"undefined"!=typeof j.selectedItem&&0!==a&&j.play(j.selectedItem))},!0),j.$watch("historyService.movesAwayFromLastSave",function(a,b){a!==b&&(console.debug("history service is active, rendering"),j.render())},!1),j.$watch("hierarchyState.newLinkFromID",function(a,b){a!==b&&(j.newLinkSrc=d.getItemByID(a),j.render())},!1),j.$watch("viewState.hierarchyState.isShown()",function(a){a===!0&&(console.debug("Hierarchy modal activated, rendering"),j.render())},!1),j.$watch("hierarchyState.contextMenuID",function(a,b){a!==b&&j.render()},!1),j.$watch("hierarchyState.resize",function(a,b){console.debug("Rendering due to window resize"),a!==b&&j.render()},!1),j.selectItem=function(b){j.selectedItem=b,a.hierarchyState.selectedItemID=b.id},j.selectLink=function(b){j.selectedLink=b,a.hierarchyState.selectedLinkFromID=b.fromID,a.hierarchyState.selectedLinkToID=b.toID},j.zoom=function(){j.limitPanning(),a.hierarchyState.translate=j.zoomListener.translate(),a.hierarchyState.scaleFactor=j.zoomListener.scale(),j.svg.attr("transform",j.getOrientatedTransform(!0)),j.captionLayer.attr("transform",j.getOrientatedLevelCaptionLayerTransform),j.captionLayer.selectAll("g.emuhierarchy-levelcaption").attr("transform",j.getOrientatedLevelCaptionTransform),null!==j.zoomTimeoutPromise&&(i.cancel(j.zoomTimeoutPromise),j.zoomTimeoutPromise=null),j.zoomTimeoutPromise=i(j.render,200)},j.limitPanning=function(){var a=j.zoomListener.translate()[0],b=j.zoomListener.translate()[1];j.vertical?(j.allowCrossAxisPan?(b>j.southernBoundary-j.crossAxisStartPosition&&(b=j.southernBoundary-j.crossAxisStartPosition),b<j.northernBoundary-j.crossAxisEndPosition&&(b=j.northernBoundary-j.crossAxisEndPosition)):b=0,a>j.easternBoundary-j.timeAxisStartPosition&&(a=j.easternBoundary-j.timeAxisStartPosition),a<j.westernBoundary-j.timeAxisEndPosition&&(a=j.westernBoundary-j.timeAxisEndPosition)):(j.allowCrossAxisPan?(a>j.easternBoundary-j.crossAxisStartPosition&&(a=j.easternBoundary-j.crossAxisStartPosition),a<j.westernBoundary-j.crossAxisEndPosition&&(a=j.westernBoundary-j.crossAxisEndPosition)):a=0,b>j.southernBoundary-j.timeAxisStartPosition&&(b=j.southernBoundary-j.timeAxisStartPosition),b<j.northernBoundary-j.timeAxisEndPosition&&(b=j.northernBoundary-j.timeAxisEndPosition)),j.zoomListener.translate([a,b])},j.rotate=function(){var a=j.zoomListener.translate();if(j.vertical===!0)var b=a[1]/j.timeAxisEndPosition,c=a[0]/j.crossAxisEndPosition;else var b=a[0]/j.timeAxisEndPosition,c=a[1]/j.crossAxisEndPosition;j.render(),b*=j.timeAxisEndPosition,c*=j.crossAxisEndPosition,j.vertical===!0?j.zoomListener.translate([b,c]):j.zoomListener.translate([c,b]),j.limitPanning(),j.zoomListener.event(j.svg)},j.getOrientatedTransform=function(a){var b="";if(j.vertical?(b+="translate("+j.zoomListener.translate()[0]+","+j.zoomListener.translate()[1]+")",b+="scale(-1,1),rotate(90)"):(b+="translate("+j.zoomListener.translate()[0]+","+j.zoomListener.translate()[1]+")",b+="rotate(0)"),a===!0){var c=j.zoomListener.scale()/j.lastScaleFactor;b+=j.allowCrossAxisZoom?"scale("+c+")":"scale(1,"+c+")"}return b},j.getOrientatedNodeTransform=function(a){return j.vertical?"scale(-1,1)rotate(90)":"rotate(0)"},j.getOrientatedLinkStrokeWidth=function(a){return"2px"},j.getOrientatedGhostLinkStrokeWidth=function(a){return"15px"},j.getNodeText=function(b){for(var c=a.getCurAttrDef(d.getLevelName(b.id)),e=0;e<b.labels.length;++e)if(b.labels[e].name===c)return b.labels[e].value;return console.debug("Likely a bug: Did not find the label selected for display","Selected level:",c,"Node: ",b),"NO VALUE"},j.getLevelCaptionText=function(b){var c=a.getCurAttrDef(b);return b===c?b:b+":"+c},j.getOrientatedNodeCollapseText=function(b){return j.vertical?a.hierarchyState.getCollapsed(b.id)?"↓":"↑":a.hierarchyState.getCollapsed(b.id)?"→":"←"},j.getOrientatedTextTransform=function(a){},j.getOrientatedTextAnchor=function(a){return j.vertical?"middle":"begin"},j.getOrientatedTextX=function(a){return j.vertical?0:10},j.getOrientatedTextY=function(a){return j.vertical?"1.45em":"0.35em"},j.getOrientatedLevelCaptionLayerTransform=function(a){return j.vertical?"translate(0, "+j.zoomListener.translate()[1]+")":"translate("+j.zoomListener.translate()[0]+", 0)"},j.getOrientatedLevelCaptionTransform=function(b){var c=angular.copy(a.hierarchyState.path).reverse();return j.vertical?"translate(25, "+j.depthToX(c.indexOf(b))+")":"translate("+j.depthToX(c.indexOf(b))+", 20)"},j.getOrientatedAddItemButtonTransform=function(a){return j.vertical,"translate(-12, -5)"},j.getOrientatedTimeLevelBackgroundTransform=function(a){return j.vertical?"translate("+(j.vertOffsetX-25)+",-8)":"translate(-8,"+(j.offsetY-20)+")"},j.getOrientatedTimeLevelBackgroundWidth=function(a){return j.vertical?"100%":"15px"},j.getOrientatedTimeLevelBackgroundHeight=function(a){return j.vertical?"15px":"100%"},j.getOrientatedMousePosition=function(a){return j.vertical?[a[1]-j.zoomListener.translate()[1],a[0]-j.zoomListener.translate()[0]]:[a[0]-j.zoomListener.translate()[0],a[1]-j.zoomListener.translate()[1]]},j.getPath=function(a){return"M"+a._fromX+" "+a._fromY+"Q"+a._fromX+" "+a._toY+" "+a._toX+" "+a._toY},j.getPreviewPath=function(){var a={x:j.newLinkSrc._x,y:j.newLinkSrc._y},b={x:j.selectedItem._x,y:j.selectedItem._y};return"M"+a.x+" "+a.y+"Q"+a.x+" "+b.y+" "+b.x+" "+b.y},j.getPreviewColor=function(){var b=e.checkLinkValidity(a.hierarchyState.path,j.newLinkSrc.id,j.selectedItem.id);return b.valid?"green":3===b.reason&&(b=e.checkLinkValidity(a.hierarchyState.path,j.selectedItem.id,j.newLinkSrc.id),b.valid)?"green":"red"},j.getLabelLegalnessColor=function(b){var c=j.svg.select(".emuhierarchy-contextmenu input")[0][0],e=d.getLevelName(b.id),f=a.getCurAttrIndex(e),g=j.cps.getLevelDefinition(e).attributeDefinitions[f].legalLabels;return void 0===g||c.value.length>0&&g.indexOf(c.value)>=0?"lightgreen":"red"},j.svgOnMouseMove=function(a){if(void 0!==j.newLinkSrc){var b=j.getOrientatedMousePosition(d3.mouse(this)),c=b[0],d=b[1];j.svg.select("path.emuhierarchy-newlink").attr("d","M"+j.newLinkSrc._x+","+j.newLinkSrc._y+" L"+c+","+d)}},j.svgOnClick=function(b){void 0!==a.hierarchyState.contextMenuID&&j.$apply(function(){a.hierarchyState.contextMenuID=void 0})},j.nodeOnClick=function(b){console.debug("Clicked node",b),void 0===a.hierarchyState.contextMenuID&&(d3.event.stopPropagation(),a.hierarchyState.contextMenuID=b.id,a.hierarchyState.setEditValue(j.getNodeText(b)),j.$apply(function(){j.render()})),a.hierarchyState.contextMenuID===b.id&&d3.event.stopPropagation()},j.nodeOnPlayClick=function(a){j.play(a)},j.nodeOnCollapseClick=function(b){console.debug("collapsing",b),f.toggleCollapse(b,a.hierarchyState.path),j.render()},j.nodeOnMouseOver=function(a){j.selectItem(a),j.renderSelectionOnly()},j.nodeOnInput=function(b){var c=j.svg.select(".emuhierarchy-contextmenu input")[0][0];a.hierarchyState.setEditValue(c.value),c.style.backgroundColor=j.getLabelLegalnessColor(b)},j.nodeOnFocusIn=function(b){a.hierarchyState.inputFocus=!0},j.nodeOnFocusOut=function(b){a.hierarchyState.inputFocus=!1},j.linkOnMouseOver=function(a){j.selectLink(a),j.renderSelectionOnly()},j.addButtonOnClick=function(a){var b=d.pushNewItem(a);-1!==b&&j.historyService.addObjToUndoStack({type:"HIERARCHY",action:"PUSHITEM",newID:b,level:a}),j.$apply()},j.play=function(b){var c=a.hierarchyState.path[0];if("undefined"==typeof c)return void console.debug("Likely a bug: There is no path selection. Not executing play():",b);for(var e,h=d.getLevelDetails(c).type,i=null,j=null,k=[b];k.length>0;){if(e=k.pop(),e.labels[0].name===c)if("EVENT"===h)(e.samplePoint<i||null===i)&&(i=e.samplePoint),(e.samplePoint>j||null===j)&&(j=e.samplePoint);else if("SEGMENT"===h){(e.sampleStart<i||null===i)&&(i=e.sampleStart);var l=e.sampleStart+e.sampleDur;(l>j||null===j)&&(j=l)}k=k.concat(f.findChildren(e,a.hierarchyState.path))}return console.debug("Node info for playback: ",h,b,i,j),null===i||null===j?void console.debug("No time information found for node, aborting playback",b):void g.playFromTo(i,j)},j.depthToX=function(b){if(j.vertical)var c=j.height,d=j.vertOffsetY;else var c=j.width,d=j.offsetX;var e=b/a.hierarchyState.path.length*c;return j.allowCrossAxisZoom&&(e*=j.zoomListener.scale()),e+=d},j.posInLevelToY=function(a){if(j.vertical)var b=j.vertOffsetX,c=j.width-b;else var b=j.offsetY,c=j.height-b;var d=a*c*j.zoomListener.scale();return d+=b},j.element=k,j.width=0,j.height=0,j.background="",void 0!==j.cps.design.color&&(j.background=j.cps.design.color.lightGrey),j.zoomListener=d3.behavior.zoom().scaleExtent(j.scaleExtent).on("zoom",j.zoom),j.svg=d3.select(k[0]).append("svg").attr("width","100%").attr("height","100%").style("background-color",j.background).call(j.zoomListener).on("dblclick.zoom",null).on("mousemove",j.svgOnMouseMove).on("click",j.svgOnClick).append("g"),j.shiftMode=!1,j.checkLink=function(c){if(c.shiftKey&&!j.shiftMode&&void 0===a.hierarchyState.newLinkFromID&&(a.hierarchyState.newLinkFromID=a.hierarchyState.selectedItemID,j.shiftMode=!0),!c.shiftKey&&j.shiftMode){j.shiftMode=!1;var d=e.addLink(a.hierarchyState.path,a.hierarchyState.newLinkFromID,a.hierarchyState.selectedItemID);a.hierarchyState.newLinkFromID=void 0,null!==d&&b.addObjToUndoStack({type:"HIERARCHY",action:"ADDLINK",link:d})}},j.captionLayer=j.svg.append("g").style("z-index",5),j.timeArrow=j.svg.append("g").append("text").text("time →"),j.scaleFactorDisplay=j.svg.append("g"),j.scaleFactorDisplay.append("text"),j.svg=j.svg.append("g").style("z-index",1),j.zoomListener.translate(a.hierarchyState.translate),j.zoomListener.scale(a.hierarchyState.scaleFactor),j.renderSelectionOnly=function(){j.svg.selectAll("circle.emuhierarchy-nodeCircle").style("fill",function(a){var b=h.design.color.white;return"undefined"!=typeof j.selectedItem&&a.id===j.selectedItem.id&&(b=h.design.color.blue),b}),j.svg.selectAll("path.emuhierarchy-link").style("stroke",function(a){return j.selectedLink===a?h.design.color.yellow:h.design.color.grey}),j.svg.select(".emuhierarchy-newlinkpreview").attr("d",j.getPreviewPath).style("stroke",j.getPreviewColor)},j.render=function(){j.lastScaleFactor=j.zoomListener.scale();var b;j.width=parseInt(d3.select(j.element[0]).style("width"),10),j.height=parseInt(d3.select(j.element[0]).style("height"),10),j.transition.rotation?j.svg.transition().duration(j.transition.duration).attr("transform",j.getOrientatedTransform()):j.svg.attr("transform",j.getOrientatedTransform()),j.vertical?j.timeArrow.attr("transform","translate("+j.width/2+","+(j.height-10)+")"):j.timeArrow.attr("transform","translate("+(j.width-20)+","+j.height/2+")rotate(90)"),j.vertical?(j.scaleFactorDisplay.attr("transform","translate("+j.width+", 20)"),j.scaleFactorDisplay.select("text").attr("text-anchor","end").text("Zoom: "+Math.round(100*j.zoomListener.scale())+" %")):(j.scaleFactorDisplay.attr("transform","translate(0, "+j.height+")"),j.scaleFactorDisplay.select("text").attr("text-anchor","start").text("Zoom: "+Math.round(100*j.zoomListener.scale())+" %")),j.captionLayer.attr("transform",j.getOrientatedLevelCaptionLayerTransform);var e=j.captionLayer.selectAll("g.emuhierarchy-levelcaption").data(a.hierarchyState.path,function(a){return a}),g=e.enter(),h=e.exit();g=g.append("g").attr("class","emuhierarchy-levelcaption"),g.append("text");var i=g.filter(function(a){var b=d.getLevelDetails(a).type;return"ITEM"===b}).append("g").attr("class","emuhierarchy-addbutton").attr("transform",j.getOrientatedAddItemButtonTransform).on("click",j.addButtonOnClick);i.append("circle").style("fill",j.cps.design.color.blue).attr("r",8),i.append("path").style("stroke",j.cps.design.color.white).attr("d","M0,-6 V6 M-6,0 H6"),g.filter(function(a){var b=d.getLevelDetails(a).type;return"SEGMENT"===b||"EVENT"===b}).append("rect").attr("class","emuhierarchy-timelevelbackground").style("fill",j.cps.design.color.transparent.grey),e.attr("transform",j.getOrientatedLevelCaptionTransform),e.select("text").text(j.getLevelCaptionText),e.select(".emuhierarchy-timelevelbackground").attr("transform",j.getOrientatedTimeLevelBackgroundTransform).style("width",j.getOrientatedTimeLevelBackgroundWidth).style("height",j.getOrientatedTimeLevelBackgroundHeight),j.transition.rotation?h=h.transition().duration(j.transition.duration).remove():h.remove(),h.select("text").style("fill-opacity",0);var k=[];f.calculateWeightsBottomUp(a.hierarchyState.path);for(var b=0;b<a.hierarchyState.path.length;++b)for(var l=d.getLevelDetails(a.hierarchyState.path[b]).items,m=0;m<l.length;++m)l[m]._visible&&k.push(l[m]);var n=d.getItemByID(a.hierarchyState.selectedItemID),o=d.getItemByID(a.hierarchyState.contextMenuID),p=d.getItemByID(a.hierarchyState.selectedLinkFromID),q=d.getItemByID(a.hierarchyState.selectedLinkToID);void 0===n||n._visible||(console.debug("Unselecting node"),a.hierarchyState.selectedItemID=void 0),void 0===p||p._visible||(console.debug("Unselecting link"),a.hierarchyState.selectedLinkFromID=void 0,a.hierarchyState.selectedLinkToID=void 0),void 0===q||q._visible||(console.debug("Unselecting link"),a.hierarchyState.selectedLinkFromID=void 0,a.hierarchyState.selectedLinkToID=void 0),void 0===o||o._visible||(console.debug("Closing context menu (node became invisible)"),a.hierarchyState.contextMenuID=void 0);for(var r=[],s=c.getData().links,t=0;t<s.length;++t)for(var b=0;b<a.hierarchyState.path.length-1;++b){var u=d.getItemFromLevelById(a.hierarchyState.path[b],s[t].toID),v=d.getItemFromLevelById(a.hierarchyState.path[b+1],s[t].fromID);null!==u&&null!==v&&u._visible&&!a.hierarchyState.getCollapsed(v.id)&&v._visible&&r.push(s[t])}k.forEach(function(a){a._x=j.depthToX(a._depth),a._y=j.posInLevelToY(a._posInLevel)}),r.forEach(function(a){a._fromX=j.depthToX(a._fromDepth),a._fromY=j.posInLevelToY(a._fromPosInLevel),a._toX=j.depthToX(a._toDepth),a._toY=j.posInLevelToY(a._toPosInLevel)});var w=j.svg.selectAll("g.emuhierarchy-node").data(k,function(a){return a.id}),x=w.enter(),y=w.exit();x=x.append("g").attr("class","emuhierarchy-node").attr("pointer-events","mouseover").on("click",j.nodeOnClick).on("mouseover",j.nodeOnMouseOver);var z=x.append("circle").attr("class","emuhierarchy-nodeCircle").style("stroke",j.cps.design.color.grey);j.transition.nodes?z.attr("r",0).transition().duration(j.transition.duration).attr("r",4.5):z.attr("r",4.5),x.append("text").attr("class","emuhierarchy-nodeText"),x.attr("transform",function(b){var c=a.hierarchyState.getCollapsePosition(b.id);if("undefined"!=typeof c){var d=c[0],e=c[1];return a.hierarchyState.setCollapsePosition(b.id,void 0),"translate("+d+","+e+")"+j.getOrientatedNodeTransform()}}),y=j.transition.nodes?y.transition().duration(j.transition.duration).attr("transform",function(b){var c=a.hierarchyState.getCollapsePosition(b.id);if("undefined"!=typeof c){var d=c[0],e=c[1];return a.hierarchyState.setCollapsePosition(b.id,void 0),"translate("+d+","+e+")"}return"translate(0,0)"}).remove():y.attr("transform",function(b){var c=a.hierarchyState.getCollapsePosition(b.id);if("undefined"!=typeof c){var d=c[0],e=c[1];return a.hierarchyState.setCollapsePosition(b.id,void 0),"translate("+d+","+e+")"}return"translate(0,0)"}).remove(),y.select("text").style("fill-opacity",0),w.select("text").attr("x",j.getOrientatedTextX).attr("y",j.getOrientatedTextY).attr("text-anchor",j.getOrientatedTextAnchor).attr("transform",j.getOrientatedTextTransform).text(j.getNodeText),w.select("circle.emuhierarchy-nodeCircle").style("fill",function(a){var b=j.cps.design.color.white;return"undefined"!=typeof j.selectedItem&&a.id===j.selectedItem.id&&(b=j.cps.design.color.blue),b}).style("stroke",function(b){return a.hierarchyState.getCollapsed(b.id)?j.cps.design.color.red:j.cps.design.color.grey}),j.transition.nodes?w.transition().duration(j.transition.duration).attr("transform",function(a){return"translate("+a._x+","+a._y+")"+j.getOrientatedNodeTransform()}):w.attr("transform",function(a){return"translate("+a._x+","+a._y+")"+j.getOrientatedNodeTransform()}),void 0===a.hierarchyState.contextMenuID&&j.svg.selectAll(".emuhierarchy-contextmenu").remove();var A=j.svg.select(".emuhierarchy-contextmenu");if(null===A[0][0]){A=w.filter(function(b){return b.id===a.hierarchyState.contextMenuID}).append("g").attr("class","emuhierarchy-contextmenu"),A.append("circle").style("fill","darkgrey").attr("r",50).style("cursor","default"),j.transition.contextMenu&&A.style("opacity",0).transition().duration(j.transition.duration).style("opacity",.5),A.append("text").text(j.getOrientatedNodeCollapseText).attr("x",-25).attr("y",-25).attr("text-anchor","middle").on("click",j.nodeOnCollapseClick),j.transition.contextMenu&&A.style("opacity",0).transition().duration(j.transition.duration).style("opacity",1),A.append("text").text("play").attr("x",-25).attr("y",25).attr("text-anchor","middle").on("click",j.nodeOnPlayClick),j.transition.contextMenu&&A.style("opacity",0).transition().duration(j.transition.duration).style("opacity",1);var B=A.append("foreignObject").attr("height",30).attr("x",10).attr("y",-15).attr("width",0);j.transition.contextMenu?B.transition().duration(j.transition.duration).attr("width",100):B.attr("width",100),B.append("xhtml:body").append("input").attr("value",j.getNodeText).style("width","100%").style("height","100%").style("outline","none").style("border","0").style("background-color",j.getLabelLegalnessColor).on("input",j.nodeOnInput).on("focusin",j.nodeOnFocusIn).on("focusout",j.nodeOnFocusOut),0!==B[0].length&&(B.select("input")[0][0].focus(),B.select("input")[0][0].select())}else j.svg.select(".emuhierarchy-contextmenu text").text(j.getOrientatedNodeCollapseText);j.svg.selectAll(".emuhierarchy-node").sort(function(b,c){return b.id===a.hierarchyState.contextMenuID?1:c.id===a.hierarchyState.contextMenuID?-1:0});var C=j.svg.selectAll(".emuhierarchy-linkgroup").data(r,function(a){return"s"+a.fromID+"t"+a.toID}),D=C.enter(),E=C.exit();D=D.insert("g",":first-child").attr("class","emuhierarchy-linkgroup"),D.append("path").attr("class","emuhierarchy-ghostlink").style("stroke-width",j.getOrientatedGhostLinkStrokeWidth).on("mouseover",j.linkOnMouseOver),D.append("path").attr("class","emuhierarchy-link").style("stroke-width",j.getOrientatedLinkStrokeWidth),j.transition.links&&D.style("opacity",0).transition().duration(j.transition.duration).style("opacity",1),j.transition.links?E.transition().duration(j.transition.duration).style("opacity",0).remove():E.remove(),C.selectAll(".emuhierarchy-link").style("stroke",function(a){return j.selectedLink===a?j.cps.design.color.yellow:j.cps.design.color.grey}),j.transition.links?C.selectAll(".emuhierarchy-link").transition().duration(j.transition.duration).attr("d",j.getPath).style("stroke-width",j.getOrientatedLinkStrokeWidth).style("opacity",1):C.selectAll(".emuhierarchy-link").attr("d",j.getPath).style("stroke-width",j.getOrientatedLinkStrokeWidth),C.selectAll(".emuhierarchy-ghostlink").attr("d",j.getPath),j.svg.selectAll(".emuhierarchy-newlink").remove(),j.svg.selectAll(".emuhierarchy-newlinkpreview").remove(),void 0!==j.newLinkSrc&&(j.svg.append("path").attr("class","emuhierarchy-newlink").style("stroke","black").style("stroke-width",j.getOrientatedLinkStrokeWidth),j.svg.append("path").attr("class","emuhierarchy-newlinkpreview").attr("d",j.getPreviewPath).style("stroke",j.getPreviewColor).style("stroke-width",j.getOrientatedLinkStrokeWidth)),j.vertical?(j.northernBoundary=j.vertOffsetY+j.height*(1-j.panningLimit),j.southernBoundary=j.height*j.panningLimit,j.westernBoundary=j.vertOffsetX+j.width*(1-j.panningLimit),j.easternBoundary=j.width*j.panningLimit):(j.northernBoundary=j.offsetY+j.height*(1-j.panningLimit),j.southernBoundary=j.height*j.panningLimit,j.westernBoundary=j.offsetX+j.width*(1-j.panningLimit),j.easternBoundary=j.width*j.panningLimit),j.timeAxisStartPosition=j.svg.node().getBBox().y,j.timeAxisEndPosition=j.timeAxisStartPosition+j.svg.node().getBBox().height,j.crossAxisStartPosition=j.svg.node().getBBox().x,j.crossAxisEndPosition=j.crossAxisStartPosition+j.svg.node().getBBox().width}}}}]),angular.module("emuwebApp").directive("epg",["viewState",function(a){return{template:'<div class="emuwebapp-twoDimCanvasContainer"><canvas width="512" height="512"></canvas></div>',restrict:"E",replace:!0,link:function(a,b,c){var d,e,f,g=b.find("canvas")[0];a.$watch("vs.curViewPort",function(b,c){$.isEmptyObject(a.cps.vals)||$.isEmptyObject(a.ssffds.data)||0!==a.ssffds.data.length&&(c.sS!==b.sS||c.eS!==b.eS)&&a.drawEpgGrid(a)},!0),a.$watch("vs.curMousePosSample",function(b,c){$.isEmptyObject(a.cps.vals)||$.isEmptyObject(a.ssffds.data)||0!==a.ssffds.data.length&&a.drawEpgGrid(a)},!0),a.drawEpgGrid=function(a){var b=g.getContext("2d");d=a.cps.getSsffTrackConfig("EPG"),e=a.ssffds.getColumnOfTrack(d.name,d.columnName),f=a.ssffds.getSampleRateAndStartTimeOfTrack(d.name),b.clearRect(0,0,g.width,g.height),b.fillStyle="green",b.strokeStyle=a.cps.design.color.black,b.font=a.cps.design.font.input.size.slice(0,-2)+"px "+a.cps.design.font.input.family;var c,h=g.width/8,i=g.height/8,j=1/f.sampleRate-f.startTime,k=Math.round(a.vs.curMousePosSample/a.shs.wavJSO.SampleRate/j),l=angular.copy(e.values[k]);l.reverse(),angular.forEach(l,function(a,d){for(c=a.toString(2).split("").reverse();c.length<8;)c.push("0");c.forEach(function(a,c){"1"===a?(b.fillStyle="grey",b.fillRect(c*h+5,i*d+5,h-10,i-10)):(b.fillStyle="white",b.fillRect(c*h+5,i*d+5,h-10,i-10))})}),a.fontImage.drawUndistortedTextTwoLines(b,"EPG","Frame:"+k,3*a.cps.design.font.input.size.slice(0,-2)/4,a.cps.design.font.input.family,5,0,a.cps.design.color.black,!0)}}}}]),angular.module("emuwebApp").directive("dots",["viewState","ConfigProviderService","Ssffdataservice","fontScaleService","Soundhandlerservice","loadedMetaDataService","mathHelperService",function(a,b,c,d,e,f,g){return{template:'<div class="emuwebapp-twoDimCanvasContainer"><canvas class="emuwebapp-twoDimCanvasStatic" width="512" height="512"></canvas><canvas class="emuwebapp-twoDimCanvasDots" width="512" height="512"></canvas></div>',restrict:"E",replace:!0,scope:{},link:function(h,i,j){h.cps=b,h.ssffds=c,h.vs=a,h.fontImage=d,h.shs=e,h.lmds=f,h.mhs=g;var k=i.find("canvas")[0],l=i.find("canvas")[1],m=1/0,n=-(1/0),o=1/0,p=-(1/0),q=Math.PI/180*0,r=Math.PI/180*360;h.$watch("ssffds.data.length",function(){$.isEmptyObject(h.cps.vals)||$.isEmptyObject(h.ssffds.data)||0!==h.ssffds.data.length&&h.drawDots()},!0),h.$watch("vs.curViewPort",function(a,b){$.isEmptyObject(h.cps.vals)||$.isEmptyObject(h.ssffds.data)||0!==h.ssffds.data.length&&(b.sS!==a.sS||b.eS!==a.eS)&&h.drawDots()},!0),h.$watch("vs.curMousePosSample",function(){$.isEmptyObject(h.cps.vals)||$.isEmptyObject(h.ssffds.data)||0!==h.ssffds.data.length&&h.drawDots()},!0),h.$watch("vs.curPerspectiveIdx",function(){m=1/0,n=-(1/0),o=1/0,p=-(1/0)},!0),h.$watch("lmds.getCurBndl()",function(a){m=1/0,n=-(1/0),o=1/0,p=-(1/0)},!0),h.setGlobalMinMaxVals=function(){for(var a=h.cps.vals.perspectives[h.vs.curPerspectiveIdx].twoDimCanvases.twoDimDrawingDefinitions[0],b=0;b<a.dots.length;b++){var c=h.cps.getSsffTrackConfig(a.dots[b].xSsffTrack),d=h.ssffds.getColumnOfTrack(c.name,c.columnName);d._minVal<m&&(m=d._minVal),d._maxVal>n&&(n=d._maxVal),c=h.cps.getSsffTrackConfig(a.dots[b].ySsffTrack);var e=h.ssffds.getColumnOfTrack(c.name,c.columnName);e._minVal<o&&(o=e._minVal),e._maxVal>p&&(p=e._maxVal)}a.staticDots.forEach(function(a){a.xCoordinates.forEach(function(b,c){m>b&&(m=b),b>n&&(n=b),a.yCoordinates[c]<o&&(o=a.yCoordinates[c]),a.yCoordinates[c]>p&&(p=a.yCoordinates[c])})}),angular.forEach(a.staticContours,function(a){var b=h.cps.getSsffTrackConfig(a.xSsffTrack),c=h.ssffds.getColumnOfTrack(b.name,b.columnName);c._minVal<m&&(m=c._minVal),c._maxVal>n&&(n=c._maxVal),b=h.cps.getSsffTrackConfig(a.ySsffTrack);var d=h.ssffds.getColumnOfTrack(b.name,b.columnName);d._minVal<o&&(o=d._minVal),d._maxVal>p&&(p=d._maxVal)})},h.drawStaticContour=function(){var a=k.getContext("2d");a.clearRect(0,0,k.width,k.height);for(var b=h.cps.vals.perspectives[h.vs.curPerspectiveIdx].twoDimCanvases.twoDimDrawingDefinitions[0],c=0;c<b.staticContours.length;c++){var d=h.cps.getSsffTrackConfig(b.staticContours[c].xSsffTrack),e=h.ssffds.getColumnOfTrack(d.name,d.columnName);d=h.cps.getSsffTrackConfig(b.staticContours[c].ySsffTrack);for(var f=h.ssffds.getColumnOfTrack(d.name,d.columnName),g=void 0,i=void 0,j=0;j<e.values.length;j++){var l=h.ssffds.getSampleRateAndStartTimeOfTrack(b.staticContours[c].xSsffTrack),s=h.ssffds.getSampleRateAndStartTimeOfTrack(b.staticContours[c].ySsffTrack);if(l.sampleRate!==s.sampleRate||l.startSample!==s.startSample)return void alert("xsRaSt.sampleRate !== ysRaSt.sampleRate || xsRaSt.startSample !== ysRaSt.startSample");var t=(e.values[j][b.staticContours[c].xContourNr]-m)/(n-m)*k.width,u=k.height-(f.values[j][b.staticContours[c].yContourNr]-o)/(p-o)*k.height;a.strokeStyle=b.staticContours[c].color,a.fillStyle=b.staticContours[c].color,a.beginPath(),a.arc(t,u,2,q,r,!0),a.fill(),j>=1&&b.staticContours[c].connect&&(a.beginPath(),a.moveTo(g,i),a.lineTo(t,u),a.stroke()),g=t,i=u}}},h.drawDots=function(){m===1/0&&(h.setGlobalMinMaxVals(),void 0!==h.cps.vals.perspectives[h.vs.curPerspectiveIdx].twoDimCanvases.twoDimDrawingDefinitions[0].staticContours&&h.drawStaticContour());var a=l.getContext("2d");a.clearRect(0,0,l.width,l.height);var b=a.canvas.width/a.canvas.offsetWidth,c=a.canvas.height/a.canvas.offsetHeight;a.beginPath(),a.moveTo(0,0),a.lineTo(5,5),a.moveTo(0,l.height),a.lineTo(5,l.height-5),a.moveTo(l.width,l.height),a.lineTo(l.width-5,l.height-5),a.stroke(),a.closePath();var d=3*h.cps.design.font.input.size.slice(0,-2)/4;h.fontImage.drawUndistortedText(a,"yMax: "+h.mhs.roundToNdigitsAfterDecPoint(p,2),d,h.cps.design.font.input.family,5,5,h.cps.design.color.black),h.fontImage.drawUndistortedTextTwoLines(a,"yMin: "+h.mhs.roundToNdigitsAfterDecPoint(o,2),"xMin: "+h.mhs.roundToNdigitsAfterDecPoint(m,2),d,h.cps.design.font.input.family,5,l.height-d*c*2-5,h.cps.design.color.black,!0);var e=a.measureText("xMax: "+h.mhs.roundToNdigitsAfterDecPoint(n,5)).width*b;h.fontImage.drawUndistortedText(a,"xMax: "+h.mhs.roundToNdigitsAfterDecPoint(n,2),d,h.cps.design.font.input.family,l.width-e-5,l.height-d*c-5,h.cps.design.color.black);var f,g=h.cps.vals.perspectives[h.vs.curPerspectiveIdx].twoDimCanvases.twoDimDrawingDefinitions[0],i=h.ssffds.getSampleRateAndStartTimeOfTrack(g.dots[0].xSsffTrack),j=h.ssffds.getSampleRateAndStartTimeOfTrack(g.dots[0].ySsffTrack),k=(1/i.sampleRate,h.vs.curMousePosSample/h.shs.wavJSO.SampleRate);f=i.startTime===1/i.sampleRate/2?Math.round(k*i.sampleRate):Math.round(k*i.sampleRate+(i.startTime-1/i.sampleRate/2)*i.sampleRate);var q=h.cps.getSsffTrackConfig(g.dots[0].xSsffTrack),r=h.ssffds.getColumnOfTrack(q.name,q.columnName);f>r.values.length-1&&(f=r.values.length-1),e=a.measureText("frame: "+f).width*b;var s=90;a.save(),a.rotate(s*Math.PI/180),h.fontImage.drawUndistortedText(a,"frame: "+f,h.cps.design.font.input.size.slice(0,-2)-4,h.cps.design.font.input.family,l.width/2-e/2,-l.height,h.cps.design.color.black),a.restore();for(var t=Math.PI/180*0,u=Math.PI/180*360,v=[],w=0;w<g.dots.length;w++){var q=h.cps.getSsffTrackConfig(g.dots[w].xSsffTrack),r=h.ssffds.getColumnOfTrack(q.name,q.columnName);q=h.cps.getSsffTrackConfig(g.dots[w].ySsffTrack);var x=h.ssffds.getColumnOfTrack(q.name,q.columnName);if(r.values.length!==x.values.length)return void alert("columns do not have same length or length of one not 1");var i=h.ssffds.getSampleRateAndStartTimeOfTrack(g.dots[w].xSsffTrack),j=h.ssffds.getSampleRateAndStartTimeOfTrack(g.dots[w].ySsffTrack);if(i.sampleRate!==j.sampleRate||i.startSample!==j.startSample)return void alert("xsRaSt.sampleRate !== ysRaSt.sampleRate || xsRaSt.startSample !== ysRaSt.startSample");var y=(r.values[f][g.dots[w].xContourNr]-m)/(n-m)*l.width,z=l.height-(x.values[f][g.dots[w].yContourNr]-o)/(p-o)*l.height;a.strokeStyle=g.dots[w].color,a.beginPath(),a.arc(y,z,20,t,u,!0),a.stroke(),a.closePath(),a.beginPath(),a.arc(y,z,2,t,u,!0),a.fill(),a.closePath(),h.fontImage.drawUndistortedText(a,g.dots[w].name,h.cps.design.font.input.size.slice(0,-2)-4,h.cps.design.font.input.family,y,z-5,h.cps.design.color.black),v.push({name:g.dots[w].name,x:y,y:z})}var A,B;g.connectLines.forEach(function(b){v.forEach(function(a){a.name===b.fromDot&&(A=a),a.name===b.toDot&&(B=a)}),a.strokeStyle=b.color,a.beginPath(),a.moveTo(A.x,A.y),a.lineTo(B.x,B.y),a.stroke(),a.closePath()});var t=Math.PI/180*0,u=Math.PI/180*360;g.staticDots.forEach(function(b){a.strokeStyle=b.color,a.fillStyle=b.color;var c=(b.xNameCoordinate-m)/(n-m)*l.width,d=l.height-(b.yNameCoordinate-o)/(p-o)*l.height;h.fontImage.drawUndistortedText(a,b.name,h.cps.design.font.input.size.slice(0,-2)-4,h.cps.design.font.input.family,c,d,b.color),b.xCoordinates.forEach(function(c,d){var e=(c-m)/(n-m)*l.width,f=l.height-(b.yCoordinates[d]-o)/(p-o)*l.height;if(a.beginPath(),a.arc(e,f,2,t,u,!0),a.fill(),a.closePath(),b.connect&&d>=1){var g=(b.xCoordinates[d-1]-m)/(n-m)*l.width,h=l.height-(b.yCoordinates[d-1]-o)/(p-o)*l.height;a.beginPath(),a.moveTo(g,h),a.lineTo(e,f),a.stroke(),a.closePath()}})})}}}}]),angular.module("emuwebApp").directive("myDropZone",["$animate","$compile","DragnDropService","browserDetector","appStateService","modalService",function(a,b,c,d,e,f){return{templateUrl:"views/myDropZone.html",restrict:"E",replace:!0,scope:{},link:function(a,b,g){a.dropTextDefault="Drop your files here (.wav files; .wav & annotJSON file pairs; .wav & TextGrid file pairs) or click here to do the same with a file dialog",a.dropTextErrorFileType="Error: Could not parse file. The following file types are supported: .WAV .TEXTGRID _annot.json",a.dropTextErrorAPI="Sorry ! The File APIs are not supported in your browser.",a.dropAllowed="Drop file(s) to start loading !",a.dropParsingWaiting=".TextGrid loaded! Please load .WAV file in order to start!",a.dropParsingWAV=".WAV loaded! Proceeding without annotation data.",a.dropParsingWaitingAnnot="Annotation file loaded! Please load .WAV file in order to start!",a.dropFirefoxWarning="Sorry ! Firefox does not support dropping folders ! please drop single or multiple files !",a.dropText=a.dropTextDefault,a.dropClass="",a.dropClassDefault="",a.dropClassOver="over",a.dropClassError="error",a.count=0,a.handles=[],a.bundles=[],a.bundleNames=[],a.updateQueueLength=function(b){a.count+=b},a.enqueueFileAddition=function(b){var c=b.name.substring(b.name.lastIndexOf("_")+1,b.name.lastIndexOf(".")).toUpperCase(),e=b.name.substr(b.name.lastIndexOf(".")+1).toUpperCase(),f="";f="ANNOT"===c?b.name.substr(0,b.name.lastIndexOf("_")):b.name.substr(0,b.name.lastIndexOf("."));var g=a.bundleNames.indexOf(f);-1===g&&(a.bundleNames.push(f),g=a.bundleNames.indexOf(f),a.bundles[g]=[],a.bundles[g][0]=f),"WAV"===e?(a.bundles[g][1]=b,a.handles.push(b),a.dropClass=a.dropClassDefault,a.dropText=a.dropParsingWAV):"TEXTGRID"===e?(a.bundles[g][2]={},
a.bundles[g][2].file=b,a.bundles[g][2].type="textgrid",a.handles.push(b),a.dropClass=a.dropClassDefault,a.dropText=a.dropParsingWaiting):"JSON"===e&&"ANNOT"===c?(a.bundles[g][2]={},a.bundles[g][2].file=b,a.bundles[g][2].type="annotation",a.handles.push(b),a.dropClass=a.dropClassDefault,a.dropText=a.dropParsingWaitingAnnot):(d.isBrowser.Firefox()&&0===b.size?(a.dropClass=a.dropClassError,a.dropText=a.dropFirefoxWarning):(a.dropClass=a.dropClassError,a.dropText=a.dropTextErrorFileType),a.handles=[],a.bundles=[],a.bundleNames=[],a.count=0),d.isBrowser.Firefox()||a.$digest(),void 0!==a.bundles[g]&&a.startRendering()},a.startRendering=function(){a.count===a.handles.length&&(c.setData(a.bundles)===!1&&f.open("views/error.html","Sorry you dropped too many bundles ("+a.handles.length+"). The maximum currently allowed is: "+c.maxDroppedBundles).then(function(){e.resetToInitState()}),a.handles=[],a.bundles=[],a.bundleNames=[],a.count=0,a.dropText=a.dropTextDefault,a.dropClass=a.dropClassDefault)},a.loadFiles=function(b){a.updateQueueLength(b.length);for(var c=0;c<b.length;c++){var d=b[c];if(".DS_Store"===d.name)a.updateQueueLength(-1);else{var e,f;if(d.isFile||d.isDirectory)e=d;else if(d.getAsEntry)e=d.getAsEntry();else{if(!d.webkitGetAsEntry){if("function"==typeof d.getAsFile){a.enqueueFileAddition(d.getAsFile());continue}if(File&&d instanceof File){a.enqueueFileAddition(d);continue}a.updateQueueLength(-1);continue}e=d.webkitGetAsEntry()}e?e.isFile?e.file(function(b){a.enqueueFileAddition(b)},function(a){console.warn(a)}):e.isDirectory&&(f=e.createReader(),f.readEntries(function(b){a.loadFiles(b),a.updateQueueLength(-1)},function(a){console.warn(a)})):updateQueueLength(-1)}}},a.dropFiles=function(b){b.stopPropagation(),b.preventDefault(),a.$apply(function(){if(window.File&&window.FileReader&&window.FileList&&window.Blob){if(void 0!==b.originalEvent){if(d.isBrowser.Firefox())var c=b.originalEvent.dataTransfer.files;else var c=b.originalEvent.dataTransfer.items;a.loadFiles(c)}}else f.open("views/error.html",a.dropTextErrorAPI).then(function(b){a.dropText=a.dropTextDefault,a.dropClass=a.dropClassDefault,e.resetToInitState()})})},a.dragEnterLeave=function(b){b.preventDefault(),a.$apply(function(){a.dropText=a.dropTextDefault,a.dropClass=a.dropClassDefault})},a.handleDragOver=function(b){b.preventDefault(),a.$apply(function(){a.dropText=a.dropAllowed,a.dropClass=a.dropClassOver})},b.bind("drop",function(b){a.dropFiles(b)}),b.bind("dragover",function(b){a.handleDragOver(b)}),b.bind("dragenter",function(b){a.dragEnterLeave(b)}),b.bind("dragleave",function(b){a.dragEnterLeave(b)}),b.bind("click",function(a){b.context.children[1].children[0].click()})}}}]),angular.module("emuwebApp").directive("myDropZoneInput",["$animate","browserDetector","appStateService",function(a,b,c){return{templateUrl:"views/myDropZoneInput.html",restrict:"E",scope:{},link:function(a,b,c){a.acceptGrid=".TextGrid",a.acceptWav="audio/wav",a.acceptJson="application/json",a.acceptBoth=a.acceptWav+","+a.acceptGrid+","+a.acceptJson,a.acceptFile=a.acceptBoth,a.handleFilesonChange=function(){var c=b.context.children.fileDialog;a.$parent.loadFiles(c.files)},b.bind("change",function(b){a.handleFilesonChange(b)}),b.bind("click",function(a){var b=angular.element("input");void 0!==b[1]&&b[1].click()})}}}]),angular.module("emuwebApp").directive("emuwebapp",["viewState","Iohandlerservice","ConfigProviderService",function(a,b,c){return{templateUrl:"views/emuwebapp.html",restrict:"E",scope:{audioGetUrl:"@",labelGetUrl:"@",labelType:"@"},link:function(b,d,e){d.bind("mouseenter",function(b){a.mouseInEmuWebApp=!0}),d.bind("mouseleave",function(b){a.mouseInEmuWebApp=!1}),e.$observe("audioGetUrl",function(a){void 0!==a&&""!==a&&(c.embeddedVals.audioGetUrl=a)}),e.$observe("labelGetUrl",function(a){void 0!==a&&""!==a&&(c.embeddedVals.labelGetUrl=a)}),e.$observe("labelType",function(a){void 0!==a&&""!==a&&(c.embeddedVals.labelType=a)})}}}]),angular.module("emuwebApp").service("Validationservice",["$http","$q","ConfigProviderService",function(a,b,c){function d(a,b){var c=!0;return b.levelDefinitions.forEach(function(b){for(var c=a.indexOf(b.name);-1!==c;)a.splice(c,1),c=a.indexOf(b.name)}),0!==a.length&&(c="Following levels are not defined: "+a),c}function e(a,b){var c=!0,d=a.indexOf("OSCI");return-1!==d&&a.splice(d,1),d=a.indexOf("SPEC"),-1!==d&&a.splice(d,1),b.ssffTrackDefinitions.forEach(function(b){for(var c=a.indexOf(b.name);-1!==c;)a.splice(c,1),c=a.indexOf(b.name)}),0!==a.length&&(c="Following ssffTracks are not defined: "+a),c}var f={},g=[],h=["annotationFileSchema","emuwebappConfigSchema","DBconfigFileSchema","bundleListSchema","bundleSchema","designSchema"];return f.semCheckLoadedConfigs=function(a,b){var f=!0,g=!0;b.levelDefinitions.forEach(function(a,b){a.attributeDefinitions.forEach(function(c,d){var e=0;a.attributeDefinitions.forEach(function(a){c.name===a.name&&(e+=1)}),e>1&&(f="Error in DBconfig /levelDefinitions["+b+"]/attributeDefinitions["+d+"] duplicate attribute definitions found for this entry!",g=!1)})}),a.perspectives.forEach(function(a){if(g){var h=e(angular.copy(a.signalCanvases.order),b);h!==!0&&(f="Error in EMUwebAppConfig/perspectives/signalCanvases/order! References to undefined ssffTracks are present. "+h,g=!1);var i=[];a.signalCanvases.assign.forEach(function(c){if(g){i.push(c.ssffTrackName),c.signalCanvasName===c.ssffTrackName&&(f="Error in EMUwebAppConfig/perspectives/signalCanvases/assign! Assignment to self is not possible! signalCanvasesName: "+c.signalCanvasName,g=!1),("OSCI"===c.ssffTrackName||"SPEC"===c.ssffTrackName)&&(f="Error in EMUwebAppConfig/perspectives/signalCanvases/assign! Assignment of OSCI or SPEC is not possible!",g=!1),h=e([c.signalCanvasName,c.ssffTrackName],b),h!==!0&&(f="Error in EMUwebAppConfig/perspectives/signalCanvases/assign! References to undefined ssffTracks are present. "+h,g=!1);var d=a.signalCanvases.order.indexOf(c.signalCanvasName);-1===d&&(f="Error in EMUwebAppConfig/perspectives/signalCanvases/assign! References to ssffTracks that are not displayed (not in order array of that perspective) are: "+c.signalCanvasName,g=!1)}}),a.signalCanvases.contourLims.forEach(function(c){if(g){h=e([c.ssffTrackName],b),h!==!0&&(f="Error in EMUwebAppConfig/perspectives/signalCanvases/contourLims! References to undefined ssffTracks are present. "+h,g=!1);var d=a.signalCanvases.order.concat(i).indexOf(c.ssffTrackName);-1===d&&(f="Error in EMUwebAppConfig/perspectives/signalCanvases/contourLims! References to ssffTracks that are not displayed (not in order array of that perspective) are: "+c.ssffTrackName,g=!1)}});var j=d(angular.copy(a.levelCanvases.order),b);j!==!0&&(f="Error in EMUwebAppConfig/perspectives/levelCanvases/order! References to undefined levels are present. "+j,g=!1),a.levelCanvases.order.forEach(function(a){if(g){var b=c.getLevelDefinition(a);"SEGMENT"!==b.type&&"EVENT"!==b.type&&(f="Error in EMUwebAppConfig/perspectives/levelCanvases/order! Configured to display levels of type ITEM as levels containing time information (ITEM level in order array). LevelName: "+a,g=!1)}}),void 0!==a.twoDimCanvases&&void 0!==a.twoDimCanvases.twoDimDrawingDefinitions&&a.twoDimCanvases.twoDimDrawingDefinitions.forEach(function(a){if(g){var c=[];a.dots.forEach(function(a){g&&(c.push(a.name),h=e([a.xSsffTrack,a.ySsffTrack],b),h!==!0&&(f="Error in EMUwebAppConfig/perspectives/twoDimCanvases/twoDimDrawingDefinitions/dots! References to undefined ssffTracks are present. "+h,g=!1))}),a.connectLines.forEach(function(a){if(g){var b=c.indexOf(a.fromDot);-1===b&&(f="Error in EMUwebAppConfig/perspectives/twoDimCanvases/twoDimDrawingDefinitions/connectLines! References dots in fromDot that are not defined. dots.name: "+a.fromDot,g=!1),b=c.indexOf(a.toDot),-1===b&&(f="Error in EMUwebAppConfig/perspectives/twoDimCanvases/twoDimDrawingDefinitions/connectLines! References dots in toDot that are not defined. dots.name: "+a.toDot,g=!1)}}),a.staticDots.forEach(function(a){g&&a.xCoordinates.length!==a.yCoordinates.length&&(f="Error in EMUwebAppConfig/perspectives/twoDimCanvases/twoDimDrawingDefinitions/staticDots! xCoordinates and yCoordinates are not of the same length!",g=!1)})}})}});var h=[],i=[];b.levelDefinitions.forEach(function(a){void 0!==a.anagestConfig&&(h.push(a.anagestConfig.verticalPosSsffTrackName),h.push(a.anagestConfig.velocitySsffTrackName),i.push(a.anagestConfig.autoLinkLevelName))});var j=d(i,b);j!==!0&&(f="Error in DBconfig/levelDefinitions/anagestConfig/autoLinkLevelName! References to undefined levels are present. "+j);var k=e(h,b);return k!==!0&&(f="Error in DBconfig/levelDefinitions/anagestConfig/verticalPosSsffTrackName || velocitySsffTrackName! References to undefined ssffTracks are present. "+k),f},f.loadSchemas=function(){var c,d=[];return angular.forEach(h,function(b){c="schemaFiles/"+b+".json",d.push(a.get(c))}),b.all(d)},f.setSchemas=function(a){angular.forEach(a,function(a){g.push({name:a.config.url,data:a.data}),"schemaFiles/annotationFileSchema.json"===a.config.url&&tv4.addSchema(a.config.url,a.data)})},f.getSchema=function(a){var b=void 0;return angular.forEach(g,function(c){c.name==="schemaFiles/"+a+".json"&&(b=c)}),b},f.validateJSO=function(a,b){var d,e=f.getSchema(a);if(void 0!==e&&tv4.validate(b,e.data))if("DBconfigFileSchema"===a){var g=f.semCheckLoadedConfigs(c.vals,c.curDbConfig);d=g===!0?!0:g}else d=!0;else d=void 0===e?"Schema: "+a+" is currently undefined! This is probably due to a misnamed schema file on the server...":tv4.error;return d},f}]),angular.module("emuwebApp").controller("ShowhierarchyCtrl",["$scope","viewState","modalService","ConfigProviderService","LevelService","HierarchyLayoutService","StandardFuncsService",function(a,b,c,d,e,f,g){a.paths={possible:[],possibleAsStr:[],selected:""},a.vs=b,a.standardFuncServ=g,angular.forEach(d.curDbConfig.levelDefinitions,function(b){"ITEM"!==b.type&&(a.paths.possible=a.paths.possible.concat(f.findPaths(b.name)))}),angular.forEach(a.paths.possible,function(b,c){var d=g.reverseCopy(b);0===c&&(a.paths.selected=d.join(" → ")),a.paths.possibleAsStr.push(d.join(" → "))}),a.$watch("paths.selected",function(c){b.hierarchyState.path=a.paths.possible[a.getSelIdx()]},!1),a.getSelIdx=function(){var b=a.paths.possibleAsStr.indexOf(a.paths.selected);return b},a.rotateHierarchy=function(){b.hierarchyState.toggleRotation()},a.getRotation=function(){return b.hierarchyState.isRotated()},a.playSelection=function(){++b.hierarchyState.playing},a.getPlaying=function(){return b.hierarchyState.playing},a.isCurrentAttrDef=function(a,c){return b.getCurAttrDef(a)===c?!0:!1},a.setCurrentAttrDef=function(a,c,d){b.setCurAttrDef(a,c,d)},a.getAllAttrDefs=function(a){var b=d.getLevelDefinition(a);return b.attributeDefinitions},a.cancel=function(){c.close()}}]),angular.module("emuwebApp").service("HierarchyLayoutService",["viewState","ConfigProviderService","LevelService","DataService",function(a,b,c,d){var e={};return e.findPaths=function(a,b){if("undefined"==typeof b)var b=[a];else b=b.concat([a]);var c=this.findParentLevels(a);if(0===c.length)return[b];for(var d=[],f=0;f<c.length;++f)d=d.concat(e.findPaths(c[f],b));return d},e.findParentLevels=function(a){for(var c=[],d=0;d<b.curDbConfig.linkDefinitions.length;++d)b.curDbConfig.linkDefinitions[d].sublevelName===a&&c.push(b.curDbConfig.linkDefinitions[d].superlevelName);return c},e.calculateWeightsBottomUp=function(a){var b,f;for(e.findParents(a),e.findVisibility(a),b=0;b<a.length;++b){var g=c.getLevelDetails(a[b]);for(g._weight=0,f=0;f<g.items.length;++f)g.items[f]._visible===!1?g.items[f]._weight=.35:g.items[f]._weight=1,g._weight+=g.items[f]._weight;var h=0;for(f=0;f<g.items.length;++f){g.items[f]._posInLevel=(h+g.items[f]._weight/2)/g._weight,h+=g.items[f]._weight,g.items[f]._depth=a.length-b-1;for(var i=d.getData().links,j=0;j<i.length;++j)i[j].toID===g.items[f].id&&(i[j]._toPosInLevel=g.items[f]._posInLevel,i[j]._toDepth=g.items[f]._depth),i[j].fromID===g.items[f].id&&(i[j]._fromPosInLevel=g.items[f]._posInLevel,i[j]._fromDepth=g.items[f]._depth)}}},e.findChildren=function(a,b){var e=[],f=c.getLevelName(a.id);if(null===f)return console.log("Likely a bug: failed to find a node's level",a),[];for(var g=null,h=0;h<b.length-1;++h)if(b[h+1]===f){g=b[h];break}if(null===g)return[];for(var i=0;i<d.getData().links.length;++i)if(d.getData().links[i].fromID===a.id)for(var j=0;j<d.getData().levels.length;++j)if(d.getData().levels[j].name===g)for(var k=0;k<d.getData().levels[j].items.length;++k)d.getData().levels[j].items[k].id===d.getData().links[i].toID&&e.push(d.getData().levels[j].items[k]);return e},e.findParents=function(a){var b,d,f,g;for(b=0;b<a.length;++b)for(g=c.getLevelDetails(a[b]),d=0;d<g.items.length;++d)g.items[d]._parents=[];for(b=0;b<a.length;++b)for(g=c.getLevelDetails(a[b]),d=0;d<g.items.length;++d){var h=e.findChildren(g.items[d],a);for(f=0;f<h.length;++f)h[f]._parents.push(g.items[d])}},e.findVisibility=function(b){if(void 0!==b&&b.length>0){for(var d,f=[],g=0;g<b.length;++g){d=c.getLevelDetails(b[g]);for(var h=0;h<d.items.length;++h)0===d.items[h]._parents.length&&f.push(d.items[h])}var i,j=[];for(j=j.concat(f);j.length>0;)i=j.pop(),j=j.concat(e.findChildren(i,b)),i._visible=!1;for(j=[],j=j.concat(f);j.length>0;)i=j.pop(),a.hierarchyState.getCollapsed(i.id)||(j=j.concat(e.findChildren(i,b))),i._visible=!0}},e.toggleCollapse=function(b,c){var d=!a.hierarchyState.getCollapsed(b.id);a.hierarchyState.setCollapsed(b.id,d);for(var f,g=e.findChildren(b,c);g.length>0;){f=g.pop(),g=g.concat(e.findChildren(f,c));var h=a.hierarchyState.getNumCollapsedParents(f.id);d?a.hierarchyState.setNumCollapsedParents(f.id,h+1):a.hierarchyState.setNumCollapsedParents(f.id,h-1),a.hierarchyState.setCollapsePosition(f.id,[b._x,b._y])}},e}]),angular.module("emuwebApp").service("ArrayHelperService",["$q",function(a){var b={};return b.convertToAbsValues=function(a){for(var b=0;b<a.length;b++)a[b]=Math.abs(a[b]);return a},b.multiplyEachElement=function(a,b){for(var c=0;c<a.length;c++)a[c]=a[c]*b;return a},b.interp2points=function(a,b,c,d,e){return b+(d-b)*((e-a)/(c-a))},b.findMinMax=function(a,b){var c,d;if("min"===b){c=1/0;for(var e=0;e<a.length;e++)a[e]<c&&(c=a[e],d=e)}else if("max"===b){c=-(1/0);for(var e=0;e<a.length;e++)a[e]>c&&(c=a[e],d=e)}return{val:c,idx:d}},b.flattenArrayOfArray=function(a){var b=[];return b=b.concat.apply(b,a)},b.convertArrayToXYjsoArray=function(a){for(var b=[],c=0;c<a.length;c++)b.push({x:c,y:a[c]});return b},b}]),angular.module("emuwebApp").service("AnagestService",["$q","$log","viewState","LevelService","LinkService","ConfigProviderService","Ssffdataservice","ArrayHelperService","modalService","HistoryService","DataService",function(a,b,c,d,e,f,g,h,i,j,k){var l,m={};return m.insertAnagestEvents=function(){var l=a.defer(),n=c.getItemsInSelection(k.data.levels);if(0!==n.length)return i.open("views/error.html","There are already events in the selected area! This is not permitted...").then(function(){l.reject()}),l;var o=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.verticalPosSsffTrackName,p=f.getSsffTrackConfig(o),q=g.getColumnOfTrack(p.name,p.columnName),r=g.getSampleRateAndStartTimeOfTrack(p.name),s=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.velocitySsffTrackName,t=f.getSsffTrackConfig(s),u=g.getColumnOfTrack(t.name,t.columnName);if(g.getSampleRateAndStartTimeOfTrack(t.name),1!==q.length||1!==u.length)return i.open("views/error.html","UPS... the column length of of one of the tracks is != 1 this means something is badly configured in the DB!!!").then(function(){l.reject()}),l;var v=h.flattenArrayOfArray(q.values),w=h.flattenArrayOfArray(u.values),x=[NaN,NaN],y=[NaN,NaN],z=[NaN,NaN],A=[NaN,NaN];w=h.convertToAbsValues(w);var B=c.getSelectedStartTime(),C=c.getSelectedEndTime(),D=Math.round(B*r.sampleRate+r.startTime),E=Math.round(C*r.sampleRate+r.startTime),F=E-D,G=v.slice(D,D+F),H=w.slice(D,D+F),I=h.findMinMax(G,"max");A[0]=I.idx;var J=h.findMinMax(H.slice(0,A[0]+1),"max");y[0]=J.idx;var K=h.findMinMax(H.slice(0,y[0]+1),"min");return b.info("Looking for gesture onset"),m.interactiveFindThresholds(H.slice(0,y[0]+1),K.val,J.val,f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.threshold,1,"Looking for gesture onset").then(function(a){var k=a;x[0]=k;var n=h.findMinMax(H.slice(y[0],A[0]+1),"min"),o=n.idx+y[0];b.info("Looking for nucleus onset"),m.interactiveFindThresholds(H.slice(y[0],o+1),n.val,J.val,f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.threshold,-1,"Looking for nucleus onset").then(function(a){var k=a;z[0]=k+y[0];var n=h.findMinMax(H.slice(A[0]),"max");y[1]=n.idx+A[0];var p=h.findMinMax(H.slice(A[0],y[1]+1),"min");o=p.idx+A[0],b.info("Looking for nucleus offset"),m.interactiveFindThresholds(H.slice(o,y[1]+1),p.val,n.val,f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.threshold,1,"Looking for nucleus offset").then(function(a){var k=a;z[1]=k+o;var p=h.findMinMax(H.slice(y[1]),"min");o=p.idx+y[1],b.info("Looking for gesture offset"),m.interactiveFindThresholds(H.slice(y[1],o+1),p.val,n.val,f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.threshold,-1,"Looking for gesture offset").then(function(a){var b=a;x[1]=b+y[1];var h;x[0]=g.calculateSamplePosInVP(D+x[0],r.sampleRate,r.startTime),x[1]=g.calculateSamplePosInVP(D+x[1],r.sampleRate,r.startTime),h=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.gestureOnOffsetLabels[0];var k=d.insertEvent(c.getcurClickLevelName(),x[0],h);j.updateCurChangeObj({type:"ANNOT",action:"INSERTEVENT",name:c.getcurClickLevelName(),start:x[0],id:k.id,pointName:h}),h=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.gestureOnOffsetLabels[1];var m=d.insertEvent(c.getcurClickLevelName(),x[1],h);j.updateCurChangeObj({type:"ANNOT",action:"INSERTEVENT",name:c.getcurClickLevelName(),start:x[1],id:m.id,pointName:h}),y[0]=g.calculateSamplePosInVP(D+y[0],r.sampleRate,r.startTime),y[1]=g.calculateSamplePosInVP(D+y[1],r.sampleRate,r.startTime),h=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.maxVelocityOnOffsetLabels[0];var n=d.insertEvent(c.getcurClickLevelName(),y[0],h);j.updateCurChangeObj({type:"ANNOT",action:"INSERTEVENT",name:c.getcurClickLevelName(),start:y[0],id:n.id,pointName:h}),h=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.maxVelocityOnOffsetLabels[1];var o=d.insertEvent(c.getcurClickLevelName(),y[1],h);j.updateCurChangeObj({type:"ANNOT",action:"INSERTEVENT",name:c.getcurClickLevelName(),start:y[1],id:o.id,pointName:h}),z[0]=g.calculateSamplePosInVP(D+z[0],r.sampleRate,r.startTime),z[1]=g.calculateSamplePosInVP(D+z[1],r.sampleRate,r.startTime),h=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.constrictionPlateauBeginEndLabels[0];var p=d.insertEvent(c.getcurClickLevelName(),z[0],h);j.updateCurChangeObj({type:"ANNOT",action:"INSERTEVENT",name:c.getcurClickLevelName(),start:z[0],id:p.id,pointName:h}),h=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.constrictionPlateauBeginEndLabels[1];var q=d.insertEvent(c.getcurClickLevelName(),z[1],h);j.updateCurChangeObj({type:"ANNOT",action:"INSERTEVENT",name:c.getcurClickLevelName(),start:z[1],id:q.id,pointName:h}),A[0]=g.calculateSamplePosInVP(D+A[0],r.sampleRate,r.startTime),h=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.maxConstrictionLabel;var s=d.insertEvent(c.getcurClickLevelName(),A[0],h);j.updateCurChangeObj({type:"ANNOT",action:"INSERTEVENT",name:c.getcurClickLevelName(),start:A[0],id:s.id,pointName:h});var t=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.autoLinkLevelName,u=d.getLevelDetails(t),v=d.getAllLabelsOfLevel(u);i.open("views/SelectLabelModal.html",v,void 0,!0).then(function(a){if(a!==!1){var b=[k.id,m.id,n.id,o.id,p.id,q.id,s.id];e.insertLinksTo(u.level.items[a].id,b),j.updateCurChangeObj({type:"ANNOT",action:"INSERTLINKSTO",name:u.level.name,parentID:u.level.items[a].id,childIDs:b}),j.addCurChangeObjToUndoStack()}}),l.resolve()})})})},function(){}),l.promise},m.interactiveFindThresholds=function(b,c,d,e,f,g){var j=c+(d-c)*e,k=f;j*=k;for(var m=h.multiplyEachElement(b,k),n=m.length,o=m.slice(1,n),p=0,q=n-1,r=[],s=0;s<m.length;s++)o[s]>=j&&m[s]<j&&r.push(s);for(var t=[],s=0;s<r.length;s++)r[s]>=p&&r[s]<=q&&t.push(s);if(t.length>1){l=a.defer();var u={};u.description=g,u.options=[],u.y=m,u.minVal=c,u.maxVal=d,u.threshold=e;for(var s=0;s<r.length;s++)u.options.push({thresholdIdx:r[s],thresholdValue:m[s]});return i.open("views/SelectThresholdModal.html",u,void 0,!0).then(function(a){console.log(a);var b=r[t[a]];b=h.interp2points(m[b],b,m[b+1],b+1,j),l.resolve(b)}),l.promise}if(0===t.length)return l=a.defer(),i.open("views/error.html","Could not find any values that step over the threshold!!").then(function(){l.reject("Could not find any values that step over the threshold!!")}),l.promise;l=a.defer();var v=r[t[0]];return v=h.interp2points(m[v],v,m[v+1],v+1,j),l.resolve(v),l.promise},m}]),angular.module("emuwebApp").service("DragnDropDataService",["$q","ConfigProviderService","modalService",function(a,b,c){var d={};return d.convertedBundles=[],d.sessionDefault="",d.getBundle=function(b,c){var e=a.defer();return angular.forEach(d.convertedBundles,function(a,c){if(a.name===b){var d=angular.copy(a);delete d.name,e.resolve({status:200,data:d})}}),e.promise},d.resetToInitState=function(){d.convertedBundles=[],d.sessionDefault=""},d.setDefaultSession=function(a){d.sessionDefault=a},d.getDefaultSession=function(){return d.sessionDefault},d}]),angular.module("emuwebApp").service("DragnDropService",["$q","$rootScope","modalService","DataService","Validationservice","ConfigProviderService","DragnDropDataService","Iohandlerservice","viewState","Soundhandlerservice","Binarydatamaniphelper","browserDetector","Wavparserservice","Textgridparserservice","loadedMetaDataService","LevelService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){var q={};return q.drandropBundles=[],q.bundleList=[],q.sessionName="File(s)",q.maxDroppedBundles=10,q.setData=function(a){var b=0;return angular.forEach(a,function(a,c){q.setDragnDropData(a[0],c,"wav",a[1]),void 0!==a[2]&&q.setDragnDropData(a[0],c,"annotation",a[2]),b=c}),b<=q.maxDroppedBundles?void q.convertDragnDropData(q.drandropBundles,0).then(function(){return o.setBundleList(q.bundleList),o.setCurBndlName(q.bundleList[g.sessionDefault]),o.setDemoDbName(q.bundleList[g.sessionDefault]),q.handleLocalFiles(),!0}):!1},q.resetToInitState=function(){delete q.drandropBundles,q.drandropBundles=[],delete q.bundleList,q.bundleList=[],q.sessionName="File(s)",q.maxDroppedBundles=10,g.resetToInitState(),o.resetToInitState()},q.setDragnDropData=function(a,b,c,d){g.setDefaultSession(b),void 0===q.drandropBundles[b]&&(q.drandropBundles[b]={},g.convertedBundles[b]={},g.convertedBundles[b].name=a,q.bundleList.push({name:a,session:q.sessionName})),"wav"===c?q.drandropBundles[b].wav=d:"annotation"===c&&(q.drandropBundles[b].annotation=d)},q.getDragnDropData=function(a,b){return"wav"===b?q.drandropBundles[a].wav:"annotation"===b?q.drandropBundles[a].annotation:!1},q.generateDrop=function(a){var b;return b="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(q.getBlob(a)):URL.createObjectURL(q.getBlob(a))},q.getBlob=function(a){var b;try{b=new Blob([a],{type:"text/plain"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,b=new BlobBuilder,b.append(a),b=b.getBlob()}return b},q.convertDragnDropData=function(b,c){var d,e=a.defer(),h=q.drandropBundles[c],i=new FileReader,o=new FileReader;return b.length>c?(void 0!==h.wav&&(i.readAsArrayBuffer(h.wav),i.onloadend=function(a){a.target.readyState==FileReader.DONE&&(d=l.isBrowser.Firefox()?a.target.result:a.currentTarget.result,m.parseWavArrBuf(d).then(function(a){void 0===g.convertedBundles[c]&&(g.convertedBundles[c]={}),g.convertedBundles[c].mediaFile={},j.wavJSO=a,g.convertedBundles[c].mediaFile.data=k.arrayBufferToBase64(a.origArrBuf),g.convertedBundles[c].mediaFile.encoding="BASE64",g.convertedBundles[c].ssffFiles=[];var d=h.wav.name.substr(0,h.wav.name.lastIndexOf("."));void 0===h.annotation?(g.convertedBundles[c].annotation={levels:[],links:[],sampleRate:a.SampleRate,annotates:d,name:d},q.convertDragnDropData(b,c+1).then(function(){delete q.drandropBundles,q.drandropBundles=[],e.resolve()})):"textgrid"===h.annotation.type?(o.readAsText(h.annotation.file),o.onloadend=function(a){a.target.readyState==FileReader.DONE&&n.asyncParseTextGrid(a.currentTarget.result,h.wav.name,d).then(function(a){g.convertedBundles[c].annotation=a,q.convertDragnDropData(b,c+1).then(function(){e.resolve()})})}):"annotation"===h.annotation.type&&(f.vals.activeButtons.showHierarchy=!0,o.readAsText(h.annotation.file),o.onloadend=function(a){a.target.readyState==FileReader.DONE&&(g.convertedBundles[c].annotation=angular.fromJson(a.currentTarget.result),q.convertDragnDropData(b,c+1).then(function(){e.resolve()}))})}))}),e.promise):(e.resolve(),e.promise)},q.handleLocalFiles=function(){var a,b,n=g.convertedBundles[g.sessionDefault].mediaFile.data,r=k.base64ToArrayBuffer(n);b=void 0!==g.convertedBundles[g.sessionDefault].annotation?g.convertedBundles[g.sessionDefault].annotation:{levels:[],links:[]},i.showDropZone=!1,i.setState("loadingSaving"),i.somethingInProgress=!0,i.somethingInProgressTxt="Loading local File: "+n.name,h.httpGetPath("configFiles/standalone_emuwebappConfig.json").then(function(h){i.curPerspectiveIdx=0,f.setVals(h.data.EMUwebAppConfig),delete h.data.EMUwebAppConfig,a=e.validateJSO("emuwebappConfigSchema",f.vals),a===!0&&(f.curDbConfig=h.data,i.somethingInProgressTxt="Parsing WAV file...",m.parseWavArrBuf(r).then(function(a){var h=a;i.curViewPort.sS=0,i.curViewPort.eS=h.Data.length,i.curViewPort.selectS=-1,i.curViewPort.selectE=-1,i.curClickSegments=[],i.curClickLevelName=void 0,i.curClickLevelType=void 0,o.setCurBndl(g.convertedBundles[g.sessionDefault]),i.resetSelect(),i.curPerspectiveIdx=0,d.setData(b);var k=[],m=[];b.levels.forEach(function(a){("SEGMENT"===a.type||"EVENT"===a.type)&&(k.push(a.name),m.push({name:a.name,type:a.type,attributeDefinitions:{name:a.name,type:"string"}}))}),f.curDbConfig.levelDefinitions=m,i.setCurLevelAttrDefs(f.curDbConfig.levelDefinitions),f.setPerspectivesOrder(i.curPerspectiveIdx,k),j.wavJSO=h,i.somethingInProgressTxt="Parsing SSFF files...";var n=e.validateJSO("annotationFileSchema",b);n===!0?(d.setLinkData(b.links),i.setState("labeling"),i.somethingInProgress=!1,i.somethingInProgressTxt="Done!"):c.open("views/error.html","Error validating annotation file: "+JSON.stringify(n,null,4)).then(function(){q.resetToInitState()}),l.isBrowser.PhantomJS()||i.selectLevel(!1,f.vals.perspectives[i.curPerspectiveIdx].levelCanvases.order,p)},function(a){c.open("views/error.html","Error parsing wav file: "+a).then(function(){q.resetToInitState()})}))}),i.somethingInProgress=!1},q}]),angular.module("emuwebApp").directive("lineChart",function(){return{restrict:"E",scope:{data:"=",threshold:"="},link:function(a,b,c){a.$watch("data",function(){a.render(a.data)},!0);var d={top:20,right:20,bottom:20,left:40},e=400-d.left-d.right,f=200-d.top-d.bottom,g=d3.select(b[0]).append("svg").attr("width",e+d.left+d.right).attr("height",f+d.top+d.bottom).append("g").attr("transform","translate("+d.left+","+d.top+")"),h=d3.scale.linear().range([0,e]),i=d3.scale.linear().range([f,0]),j=d3.svg.axis().scale(h).tickSize(5).tickSubdivide(!0),k=d3.svg.axis().scale(i).orient("left"),l=d3.svg.line().x(function(a){return h(a.x)}).y(function(a){return i(a.y)}).interpolate("linear");a.render=function(b){h.domain([d3.min(b,function(a){return a.x}),d3.max(b,function(a){return a.x})]),i.domain([d3.min(b,function(a){return a.y}),d3.max(b,function(a){return a.y})]),g.selectAll("g.axis").remove(),g.append("g").attr("class","x axis").attr("transform","translate(0,"+f+")").call(j),g.append("g").attr("class","y axis").call(k),g.append("svg:path").attr("d",l(b)).attr("stroke","red").attr("stroke-width",1).attr("fill","none"),g.append("svg:line").attr("x1",5).attr("y1",5).attr("x2",200).attr("y2",200).attr("class","label-line"),g.append("line").attr({x1:h(a.threshold),y1:0,x2:h(a.threshold),y2:f}).attr("stroke","steelblue").attr("class","verticalLine")}}}}),angular.module("emuwebApp").directive("hint",function(){return{templateUrl:"views/hint.html",replace:!0,restrict:"E",link:function(a,b,c){a.hideMe=function(){a.internalVars.showAboutHint=!a.internalVars.showAboutHint,a.aboutBtnClick()}}}}),angular.module("emuwebApp").directive("perspectives",function(){return{templateUrl:"views/perspectives.html",replace:!0,restrict:"E",link:function(a,b,c){}}}),angular.module("emuwebApp").service("loadedMetaDataService",["Validationservice",function(a){function b(a){var b,c=[];return a.forEach(function(a,d){c[a.session]={collapsed:!0},0===d&&(b=a.session)}),c[b].collapsed=!1,c}function c(a){return a.forEach(function(a,b){void 0===i[a.session]&&(i[a.session]=[]),i[a.session].push(a)}),i}var d={},e=[],f=[],g={},h="",i={};return d.setBundleList=function(d){var g=a.validateJSO("bundleListSchema",d);return g===!0&&(f=d,e=b(f),i=c(f)),g},d.getBundleList=function(){return f},d.getRendOptBndlList=function(){return i},d.getCurBndl=function(){return g},d.setCurBndl=function(a){g=a},d.setBndlComment=function(a,b,c){i[b][c].comment=a},d.setBndlFinished=function(a,b,c){i[b][c].finishedEditing=a},d.getCurBndlName=function(){return g.name},d.setCurBndlName=function(a){g.name=a},d.setDemoDbName=function(a){h=a},d.getDemoDbName=function(){return h},d.toggleCollapseSession=function(a){console.log(a),void 0===e[a]&&(e[a]={}),e[a].collapsed=!e[a].collapsed,Object.keys(e).forEach(function(b){b!==a&&(e[b].collapsed=!0)})},d.openCollapseSession=function(a){console.log(a),e[a]={},e[a].collapsed=!1,Object.keys(e).forEach(function(b){b!==a&&(e[b].collapsed=!0)})},d.getSessionCollapseState=function(a){return void 0===e[a]?void 0:e[a].collapsed},d.resetToInitState=function(){e=[],f=[],g={},i={}},d}]),angular.module("emuwebApp").controller("bundleListSideBarCtrl",["$scope","viewState","HistoryService","loadedMetaDataService","dbObjLoadSaveService","ConfigProviderService",function(a,b,c,d,e,f){a.vs=b,a.lmds=d,a.dolss=e,a.cps=f,a.filterText="",a.vs.pageSize=500,a.vs.currentPage=0,a.turn=function(b){b?a.vs.currentPage++:a.vs.currentPage--},a.uttIsDisabled=function(a){return a.name===d.getCurBndl().name?!1:!0},a.getBndlColor=function(a){var b;return b=0!==c.movesAwayFromLastSave?{"background-color":"#f00",color:"white"}:{"background-color":"#999",color:"black"},a.name===d.getCurBndl().name?b:void 0},a.isSessionDefined=function(a){return"undefined"===a?!1:!0}}]),angular.module("emuwebApp").service("dbObjLoadSaveService",["$log","$q","DataService","viewState","HistoryService","loadedMetaDataService","Ssffdataservice","Iohandlerservice","Binarydatamaniphelper","Wavparserservice","Soundhandlerservice","Ssffparserservice","Validationservice","LevelService","modalService","ConfigProviderService","appStateService","StandardFuncsService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){var s={};return s.loadBundle=function(a){if(0!==e.movesAwayFromLastSave&&"DEMO"!==p.vals.main.comMode){var b=f.getCurBndl();a!==b&&o.open("views/saveChanges.html",b.session+":"+b.name).then(function(b){"saveChanges"===b?s.saveBundle().then(function(){s.loadBundle(a)}):"discardChanges"===b&&(e.resetToInitState(),s.loadBundle(a))})}else a!==f.getCurBndl()&&(e.resetToInitState(),d.hierarchyState.reset(),n.deleteEditArea(),d.setEditing(!1),d.setState("loadingSaving"),d.somethingInProgress=!0,d.somethingInProgressTxt="Loading bundle: "+a.name,g.data=[],h.getBundle(a.name,a.session,f.getDemoDbName()).then(function(b){200===b.status&&(b=b.data);var e=m.validateJSO("bundleSchema",b);if(e===!0){var h;h=i.base64ToArrayBuffer(b.mediaFile.data),d.somethingInProgressTxt="Parsing WAV file...",j.parseWavArrBuf(h).then(function(e){var h=e;d.curViewPort.sS=0,d.curViewPort.eS=h.Data.length,d.curViewPort.selectS=-1,d.curViewPort.selectE=-1,d.curClickSegments=[],
d.curClickLevelName=void 0,d.curClickLevelType=void 0,d.resetSelect(),k.wavJSO=h,d.somethingInProgressTxt="Parsing SSFF files...",l.asyncParseSsffArr(b.ssffFiles).then(function(e){g.data=e.data,c.setData(b.annotation),f.setCurBndl(a),d.selectLevel(!1,p.vals.perspectives[d.curPerspectiveIdx].levelCanvases.order,n),d.setState("labeling"),d.somethingInProgress=!1,d.somethingInProgressTxt="Done!"},function(a){o.open("views/error.html","Error parsing SSFF file: "+a.status.message).then(function(){q.resetToInitState()})})},function(a){o.open("views/error.html","Error parsing wav file: "+a.status.message).then(function(){q.resetToInitState()})})}else o.open("views/error.html","Error validating annotation file: "+JSON.stringify(e,null,4)).then(function(){q.resetToInitState()})},function(a){a.data?o.open("views/error.html","Error loading bundle: "+a.data).then(function(){q.resetToInitState()}):o.open("views/error.html","Error loading bundle: "+a.status.message).then(function(){q.resetToInitState()})}))},s.saveBundle=function(){if(d.getPermission("saveBndlBtnClick")){var c=b.defer();d.somethingInProgress=!0,d.setState("loadingSaving");var e={};d.somethingInProgressTxt="Creating bundle json...",e.ssffFiles=[];var f=g.getFile("FORMANTS");return void 0!==f?l.asyncJso2ssff(f).then(function(a){e.ssffFiles.push({fileExtension:f.fileExtension,encoding:"BASE64",data:i.arrayBufferToBase64(a.data)}),s.getAnnotationAndSaveBndl(e,c)},function(a){o.open("views/error.html","Error converting javascript object to SSFF file: "+a.status.message),c.reject()}):s.getAnnotationAndSaveBndl(e,c),c.promise}a.info("Action: menuBundleSaveBtnClick not allowed!")},s.getAnnotationAndSaveBndl=function(b,g){d.somethingInProgressTxt="Validating annotJSON ...";var i=m.validateJSO("annotationFileSchema",c.getData());i!==!0&&(a.warn("PROBLEM: trying to save bundle but bundle is invalid. traverseAndClean() will be called."),a.error(i)),r.traverseAndClean(c.getData()),b.annotation=c.getData(),b.mediaFile={encoding:"BASE64",data:""};var j=f.getCurBndl();"undefined"!=typeof j.session&&(b.session=j.session),"undefined"!=typeof j.finishedEditing&&(b.finishedEditing=j.finishedEditing),"undefined"!=typeof j.comment&&(b.comment=j.comment),d.somethingInProgressTxt="Validating bundle ...",i=m.validateJSO("bundleSchema",b),i!==!0?(a.error("GRAVE PROBLEM: trying to save bundle but bundle is invalid. traverseAndClean() HAS ALREADY BEEN CALLED."),a.error(i),o.open("views/error.html","Somehow the data for this bundle has been corrupted. This is most likely a nasty and diffucult to spot bug. If you are at the IPS right now, please contact an EMU developer immediately. The Validation error is: "+JSON.stringify(i,null,4)).then(function(){d.somethingInProgressTxt="",d.somethingInProgress=!1,d.setState("labeling"),g.reject()})):(d.somethingInProgressTxt="Saving bundle...",h.saveBundle(b).then(function(){d.somethingInProgressTxt="Done!",d.somethingInProgress=!1,e.movesAwayFromLastSave=0,g.resolve(),d.setState("labeling")},function(a){o.open("views/error.html","Error saving bundle: "+a.status.message).then(function(){q.resetToInitState()}),g.reject()}))},s}]),angular.module("emuwebApp").service("appStateService",["$log","$rootScope","DragnDropService","DragnDropDataService","viewState","Iohandlerservice","loadedMetaDataService","Soundhandlerservice","DataService","Ssffdataservice","HistoryService",function(a,b,c,d,e,f,g,h,i,j,k){var l={};return l.resetToInitState=function(){f.wsH.isConnected()&&f.wsH.disconnectWarning().then(function(b){a.info("Closing websocket connection to server"),f.wsH.closeConnect()}),g.resetToInitState(),h.wavJSO={},i.setData({}),d.resetToInitState(),c.resetToInitState(),j.data=[],k.resetToInitState(),e.setState("noDBorFilesloaded"),e.somethingInProgress=!1,e.resetToInitState(),k.resetToInitState(),e.showDropZone=!0,b.$broadcast("resetToInitState")},l.reloadToInitState=function(a){f.wsH.closeConnect();var l=e.url;g.resetToInitState(),h.wavJSO={},i.setData({}),d.resetToInitState(),c.resetToInitState(),j.data=[],k.resetToInitState(),e.setState("noDBorFilesloaded"),e.somethingInProgress=!1,k.resetToInitState(),e.resetToInitState(),b.$broadcast("reloadToInitState",{url:l,session:a,reload:!0})},l}]),wavParserWorker.prototype={getWorkerScript:function(){var a="";return a+="("+this.workerInit+")(this);"},workerInit:function(a){ArrayBuffer.prototype.subarray=function(a,b){for(var c=new ArrayBuffer(b),d=new Int8Array(c),e=new Int8Array(this),f=0;b>f;f++)d[f]=e[a+f];return c},a.ab2str=function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c]);return String.fromCharCode.apply(null,b)},a.wav2jso=function(b){var c,d,e,f={};return c=0,d=b.subarray(c,4),e=new Uint8Array(d),f.ChunkID=a.ab2str(e),"RIFF"!==f.ChunkID?{status:{type:"ERROR",message:"Wav read error: ChunkID not RIFF but "+f.ChunkID}}:(c=4,d=b.subarray(c,4),e=new Uint32Array(d),f.ChunkSize=e[0],c=8,d=b.subarray(c,4),e=new Uint8Array(d),f.Format=a.ab2str(e),"WAVE"!==f.Format?{status:{type:"ERROR",message:"Wav read error: Format not WAVE but "+f.Format}}:(c=12,d=b.subarray(c,4),e=new Uint8Array(d),f.Subchunk1ID=a.ab2str(e),"fmt "!==f.Subchunk1ID?{status:{type:"ERROR",message:"Wav read error: Subchunk1ID not fmt  but "+f.Subchunk1ID}}:(c=16,d=b.subarray(c,4),e=new Uint32Array(d),f.Subchunk1Size=e[0],16!==f.Subchunk1Size?{status:{type:"ERROR",message:"Wav read error: Subchunk1Size not 16 but "+f.Subchunk1Size}}:(c=20,d=b.subarray(c,2),e=new Uint16Array(d),f.AudioFormat=e[0],1!==f.AudioFormat?{status:{type:"ERROR",message:"Wav read error: AudioFormat not 1 but "+f.AudioFormat}}:(c=22,d=b.subarray(c,2),e=new Uint16Array(d),f.NumChannels=e[0],1!==f.NumChannels?{status:{type:"ERROR",message:"Wav read error: NumChannels not 1 but "+f.NumChannels}}:(c=24,d=b.subarray(c,4),e=new Uint32Array(d),f.SampleRate=e[0],c=28,d=b.subarray(c,4),e=new Uint32Array(d),f.ByteRate=e[0],c=32,d=b.subarray(c,2),e=new Uint16Array(d),f.BlockAlign=e[0],c=34,d=b.subarray(c,2),e=new Uint16Array(d),f.BitsPerSample=e[0],16!==f.BitsPerSample?{status:{type:"ERROR",message:"Wav read error: BitsPerSample not 16 but "+f.BitsPerSample}}:(c=36,d=b.subarray(c,4),e=new Uint8Array(d),f.Subchunk2ID=a.ab2str(e),"data"!==f.Subchunk2ID?{status:{type:"ERROR",message:"Wav read error: Subchunk2ID not data but "+f.Subchunk2ID}}:(c=40,d=b.subarray(c,4),e=new Uint32Array(d),f.Subchunk2Size=e[0],c=44,d=b.subarray(c,f.Subchunk2Size),e=new Int16Array(d),f.Data=new Float32Array(e),f.origArrBuf=b,f))))))))},a.onmessage=function(b){if(void 0!==b.data)switch(b.data.cmd){case"parseBuf":var c=a.wav2jso(b.data.buffer);void 0===c.status?a.postMessage({status:{type:"SUCCESS",message:""},data:c}):a.postMessage(c);break;default:a.postMessage({status:{type:"ERROR",message:"Unknown command sent to wavParserWorker"}})}else a.postMessage({status:{type:"ERROR",message:"Undefined message was sent to wavParserWorker"}})}},getWorkerURL:function(){var a,b;try{a=new Blob([this.getWorkerScript()],{type:"application/javascript"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,a=new BlobBuilder,a.append(textGridParserWorker),a=a.getBlob()}return b="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(a):URL.createObjectURL(a)},kill:function(){this.worker&&this.worker.terminate(),this.url&&URL.revokeObjectURL(this.url)},tell:function(a){this.worker&&this.worker.postMessage(a)},says:function(a){this.worker&&this.worker.addEventListener("message",function(b){a(b.data)})}},espsParserWorker.prototype={getWorkerScript:function(){var a="";return a+="("+this.workerInit+")(this);"},workerInit:function(a){a.toJSO=function(a,b,c,d){var e={};e.name=c,e.annotates=b,e.sampleRate=d,e.levels=[],a=a.replace(/([ \t]*\r?\n)+/g,"\n"),a=a.replace(/[ \t]+/g," ");for(var f,g=a.split("\n"),h=0;h<g.length;h++)if("#"===g[h]){f=h;break}e.levels[0]={},e.levels[0].name=c,e.levels[0].items=[];var i,j=1,k=g[f+1].split(/\s+/);if("H#"!==k[k.length-1]?e.levels[0].type="EVENT":e.levels[0].type="SEGMENT","EVENT"===e.levels[0].type)for(h=f+1;h<g.length-1;h++)k=g[h].split(/\s+/),e.levels[0].items.push({id:j,labels:[{name:c,value:k[k.length-1]}],samplePoint:Math.floor(k[1]*d)}),j+=1;else for(j+=1,h=f+2;h<g.length-1;h++)k=g[h].split(/\s+/),i=g[h-1].split(/\s+/),e.levels[0].items.push({id:j,labels:[{name:c,value:k[k.length-1]}],sampleStart:Math.floor(i[1]*d),sampleDur:Math.floor(k[1]*d)-Math.floor(i[1]*d)-1}),j+=1;return e},a.toESPS=function(a,b,c){var d="";d+="signal "+b+"\n",d+="nfields 1\n",d+="#\n";for(var e,f=0;f<a.length;f++)e=""===a[f].labels[0].value&&0===f?"H#":a[f].labels[0].value,d+="	"+String((a[f].sampleStart+a[f].sampleDur)/c)+"	125	"+e+"\n";return d},a.onmessage=function(b){if(void 0!==b.data){var c;switch(b.data.cmd){case"parseESPS":c=a.toJSO(b.data.esps,b.data.annotates,b.data.name,b.data.sampleRate),void 0===c.type?a.postMessage({status:{type:"SUCCESS",message:""},data:c}):a.postMessage(c);break;case"parseJSO":c=a.toESPS(b.data.level.items,b.data.level.name,b.data.sampleRate),void 0===c.type?a.postMessage({status:{type:"SUCCESS",message:""},data:c}):a.postMessage(c);break;default:a.postMessage({status:{type:"ERROR",message:"Unknown command sent to espsParserWorker"}})}}else a.postMessage({status:{type:"ERROR",message:"Undefined message was sent to espsParserWorker"}})}},getWorkerURL:function(){var a,b;try{a=new Blob([this.getWorkerScript()],{type:"application/javascript"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,a=new BlobBuilder,a.append(textGridParserWorker),a=a.getBlob()}return b="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(a):URL.createObjectURL(a)},kill:function(){this.worker&&this.worker.terminate(),this.url&&URL.revokeObjectURL(this.url)},tell:function(a){this.worker&&this.worker.postMessage(a)},says:function(a){this.worker&&this.worker.addEventListener("message",function(b){a(b.data)})}},textGridParserWorker.prototype={getWorkerScript:function(){var a="";return a+="("+this.workerInit+")(this);"},workerInit:function(a){a.l1='File type = "ooTextFile"',a.l2='Object class = "TextGrid"',a.localID=0,a.testForGapsInLabelJSO=function(a){for(var b=0,c=0;c<a.levels.length;c++)if("SEGMENT"===a.levels[c].type)for(var d=0;d<a.levels[c].items.length-1;d++)a.levels[c].items[d].sampleStart+a.levels[c].items[d].sampleDur+1!==a.levels[c].items[d+1].sampleStart&&(b+=1)},a.findTimeOfMinSample=function(){return 0},a.findTimeOfMaxSample=function(a,b){return a/b},a.toJSO=function(b,c,d,e){var f="123abcABCCBAcba321";b=b.replace(/([ \t]*\r?\n)+/g,"\n"),b=b.replace(/("[^\n]*")/g,function(a,b){var c=b.replace(/\s+/g,f);return c}),b=b.replace(/[\t ]+/g,"");var g=new RegExp(f,"g");b=b.replace(g," ");var h,i,j,k,l=b.split("\n"),m=!0,n=[],o={name:d,annotates:c,sampleRate:e,levels:[],links:[]};if(l[0].replace(/\s+/g,"")===a.l1.replace(/\s+/g,"")&&l[1].replace(/\s+/g,"")===a.l2.replace(/\s+/g,"")){for(var p=2;p<l.length;p++){var q=l[p];if("item[]:"!==q){if(!m)if(0===q.indexOf("item[")&&(i=l[p+2].split(/=/)[1].replace(/"/g,""),'"IntervalTier"'===l[p+1].split(/=/)[1]?(h="SEGMENT",o.levels.push({name:i,type:h,items:[]})):'"TextTier"'===l[p+1].split(/=/)[1]&&(h="EVENT",o.levels.push({name:i,type:h,items:[]}))),o.levels.length>0&&"SEGMENT"===o.levels[o.levels.length-1].type&&0===q.indexOf("intervals")&&0!==q.indexOf("intervals:")){var r=Math.floor(l[p+1].split(/=/)[1]*e),s=Math.floor(l[p+2].split(/=/)[1]*e);k=l[p+3].split(/=/)[1].replace(/"/g,"");var n=[];n.push({name:o.levels[o.levels.length-1].name,value:k}),o.levels[o.levels.length-1].items.push({id:a.localID,sampleStart:r,sampleDur:s-r-1,labels:n}),++a.localID}else o.levels.length>0&&"EVENT"===o.levels[o.levels.length-1].type&&0===q.indexOf("points")&&0!==q.indexOf("points:")&&(j=l[p+1].split(/=/)[1]*e,k=l[p+2].split(/=/)[1].replace(/"/g,""),n=[],n.push({name:o.levels[o.levels.length-1].name,value:k}),o.levels[o.levels.length-1].items.push({id:a.localID,samplePoint:Math.round(j),labels:n}),++a.localID)}else m=!1}return a.testForGapsInLabelJSO(o),o}return{status:{type:"ERROR",message:"bad header in TextGrid file!!! The header has to be: "+a.l1+"\n"+a.l2}}},a.toTextGrid=function(b,c,d){var e="",f="\n",g="	";e=e+a.l1+f+a.l2+f+f,e=e+"xmin = "+a.findTimeOfMinSample()+f,e=e+"xmax = "+a.findTimeOfMaxSample(c,d)+f,e=e+"levels? <exists>"+f,e=e+"size = "+b.length+f,e=e+"item []:"+f;for(var h=0;h<b.length;h++){var i=b[h];e=e+g+"item ["+h+"]:"+f,"SEGMENT"===i.type?e=e+g+g+'class = "IntervalTier"'+f:"EVENT"===i.type&&(e=e+g+g+'class = "TextTier"'+f),e=e+g+g+'name = "'+i.name+'"'+f,e=e+g+g+"xmin = "+a.findTimeOfMinSample()+f,e=e+g+g+"xmax = "+a.findTimeOfMaxSample(c,d)+f,"SEGMENT"===i.type?e=e+g+g+"intervals: size = "+i.items.length+f:"EVENT"===i.type&&(e=e+g+g+"points: size = "+i.items.length+f);for(var j,k=0;k<i.items.length;k++){var l=k+1;"SEGMENT"===i.type?(e=e+g+g+g+"intervals ["+l+"]:"+f,0!==i.items[k].sampleStart?(j=i.items[k].sampleStart/d+1/d/2,e=e+g+g+g+g+"xmin = "+j+f):e=e+g+g+g+g+"xmin = 0"+f,k<i.items.length-1?(j=(i.items[k].sampleStart+i.items[k].sampleDur)/d+1/d/2,e=e+g+g+g+g+"xmax = "+j+f):e=e+g+g+g+g+"xmax = "+a.findTimeOfMaxSample(c,d)+f,e=e+g+g+g+g+'text = "'+i.items[k].labels[0].value+'"'+f):"EVENT"===i.type&&(e=e+g+g+g+"points["+l+"]:"+f,e=e+g+g+g+g+"time = "+i.items[k].samplePoint/d+f,e=e+g+g+g+g+'mark = "'+i.items[k].labels[0].value+'"'+f)}}return e},a.onmessage=function(b){if(void 0!==b.data){var c;switch(b.data.cmd){case"parseTG":c=a.toJSO(b.data.textGrid,b.data.annotates,b.data.name,b.data.sampleRate),void 0===c.status?a.postMessage({status:{type:"SUCCESS",message:""},data:c}):a.postMessage(c);break;case"toTextGrid":c=a.toTextGrid(b.data.levels,b.data.buffLength,b.data.sampleRate),void 0===c.status?a.postMessage({status:{type:"SUCCESS",message:""},data:c}):a.postMessage(c);break;default:a.postMessage({status:{type:"ERROR",message:"Unknown command sent to textGridParserWorker"}})}}else a.postMessage({status:{type:"ERROR",message:"Undefined message was sent to textGridParserWorker"}})}},getWorkerURL:function(){var a,b;try{a=new Blob([this.getWorkerScript()],{type:"application/javascript"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,a=new BlobBuilder,a.append(textGridParserWorker),a=a.getBlob()}return b="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(a):URL.createObjectURL(a)},kill:function(){this.worker&&this.worker.terminate(),this.url&&URL.revokeObjectURL(this.url)},tell:function(a){this.worker&&this.worker.postMessage(a)},says:function(a){this.worker&&this.worker.addEventListener("message",function(b){a(b.data)})}},spectroDrawingWorker.prototype={getWorkerScript:function(){var a="";return a+="("+this.workerInit+")(this);"},workerInit:function(a){a.executed=!1,a.PI=3.141592653589793,a.TWO_PI=6.283185307179586,a.totalMax=0,a.dynRangeInDB=50,a.myWindow={BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10},a.imgWidth=0,a.imgHeight=0,a.upperFreq=0,a.lowerFreq=0,a.pixelRatio=1,a.heatMapColorAnchors=[[255,0,0],[0,255,0],[0,0,0]],a.samplesPerPxl=0,a.sampleRate=0,a.preEmphasisFilterFactor=.97,a.transparency=0,a.drawHeatMapColors=!1,a.N=0,a.windowSizeInSecs=.01,a.audioBuffer=void 0,a.audioBufferChannels=0,a.wFunction=0,a.myFFT=void 0,a.pixelHeight=1,a.internalalpha=1,a.maxPsd=0,a.HzStep=0,a.paint=[],a.sin=void 0,a.cos=void 0,a.ceilingFreqFftIdx=0,a.floorFreqFftIdx=0,a.resultImgArr=void 0,a.toLinearLevel=function(a){return Math.pow(10,a/10)},a.log10=function(a){return Math.log(a)/2.302585092994046},a.magnitude=function(a,b){return Math.sqrt(a*a+b*b)},a.FFT=function(){var b,c,d,e=a.N;if(b=parseInt(Math.log(e)/.6931471805599453,10),e!==1<<b&&console.log("ERROR : FFT length must be power of 2"),void 0===a.cos||e!==a.N)for(a.cos=new Float32Array(e/2),d=0;e/2>d;d++)a.cos[d]=Math.cos(-2*a.PI*d/e);if(void 0===a.sin||e!==a.N)for(a.sin=new Float32Array(e/2),d=0;e/2>d;d++)a.sin[d]=Math.sin(-2*a.PI*d/e);this.applyWindowFuncAndPreemph=function(b,d,e,f){switch(this.alpha=d,b){case a.myWindow.BARTLETT:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionBartlett(f,c);break;case a.myWindow.BARTLETTHANN:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionBartlettHann(f,c);break;case a.myWindow.BLACKMAN:for(this.alpha=this.alpha||.16,c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionBlackman(f,c,d);break;case a.myWindow.COSINE:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionCosine(f,c);break;case a.myWindow.GAUSS:for(this.alpha=this.alpha||.25,c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionGauss(f,c,d);break;case a.myWindow.HAMMING:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionHamming(f,c);break;case a.myWindow.HANN:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionHann(f,c);break;case a.myWindow.LANCZOS:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionLanczos(f,c);break;case a.myWindow.RECTANGULAR:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionRectangular(f,c);break;case a.myWindow.TRIANGULAR:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionTriangular(f,c)}return e},this.wFunctionBartlett=function(a,b){return 2/(a-1)*((a-1)/2-Math.abs(b-(a-1)/2))},this.wFunctionBartlettHann=function(b,c){return.62-.48*Math.abs(c/(b-1)-.5)-.38*Math.cos(a.TWO_PI*c/(b-1))},this.wFunctionBlackman=function(b,c,d){var e=(1-d)/2,f=.5,g=d/2;return e-f*Math.cos(a.TWO_PI*c/(b-1))+g*Math.cos(4*a.PI*c/(b-1))},this.wFunctionCosine=function(b,c){return Math.cos(a.PI*c/(b-1)-a.PI/2)},this.wFunctionGauss=function(a,b,c){return Math.pow(Math.E,-.5*Math.pow((b-(a-1)/2)/(c*(a-1)/2),2))},this.wFunctionHamming=function(b,c){return.54-.46*Math.cos(a.TWO_PI*c/(b-1))},this.wFunctionHann=function(b,c){return.5*(1-Math.cos(a.TWO_PI*c/(b-1)))},this.wFunctionLanczos=function(b,c){var d=2*c/(b-1)-1;return Math.sin(a.PI*d)/(a.PI*d)},this.wFunctionRectangular=function(){return 1},this.wFunctionTriangular=function(a,b){return 2/a*(a/2-Math.abs(b-(a-1)/2))},this.applyPreEmph=function(b,c){return b-a.preEmphasisFilterFactor*c},this.fft=function(c,d){var f,g,h,i,j,k,l,m,n,o;for(g=0,j=e/2,f=1;e-1>f;f++){for(i=j;g>=i;)g-=i,i/=2;g+=i,g>f&&(n=c[f],c[f]=c[g],c[g]=n,n=d[f],d[f]=d[g],d[g]=n)}for(i=0,j=1,f=0;b>f;f++)for(i=j,j+=j,k=0,g=0;i>g;g++)for(l=a.cos[k],m=a.sin[k],k+=1<<b-f-1,h=g;e>h;h+=j)n=l*c[h+i]-m*d[h+i],o=m*c[h+i]+l*d[h+i],c[h+i]=c[h]-n,d[h+i]=d[h]-o,c[h]=c[h]+n,d[h]=d[h]+o}},a.convertToHeatmap=function(a,b,c,d){var e=d.length-1,f=(c-a)/(b-a)*e,g=Math.floor(f),h=Math.min.apply(null,[Math.floor(f)+1,e]),i=d[g],j=d[h],k=f-g;return{r:Math.floor(i[0]+k*(j[0]-i[0])),g:Math.floor(i[1]+k*(j[1]-i[1])),b:Math.floor(i[2]+k*(j[2]-i[2]))}},a.drawVerticalLineOfSpectogram=function(b){var c,d,e,f,g=a.pixelHeight,h=2*Math.pow(a.paint[b][1],2)/a.N,i=10*a.log10(h/a.maxPsd),j=(i+a.dynRangeInDB)/a.dynRangeInDB;j>1?j=1:0>j&&(j=0);for(var k=0;k<a.paint[b].length;k++){var l=j;h=2*Math.pow(a.paint[b][k],2)/a.N,i=10*a.log10(h/a.maxPsd),j=(i+a.dynRangeInDB)/a.dynRangeInDB,j>1&&(j=1),0>j&&(j=0);var m=j;if(a.pixelHeight>=1)for(var n=0;n<a.pixelHeight;n++){var o=l+(m-l)/g*n;if(c=255-Math.round(255*o),e=Math.floor(b),f=Math.floor(a.imgHeight-(a.pixelHeight*(k-2)+n)),d=4*(e+f*a.imgWidth),a.drawHeatMapColors)if(isNaN(c))a.resultImgArr[d+0]=c,a.resultImgArr[d+1]=c,a.resultImgArr[d+2]=c,a.resultImgArr[d+3]=a.transparency;else{var p=a.convertToHeatmap(0,255,c,a.heatMapColorAnchors);a.resultImgArr[d+0]=p.r,a.resultImgArr[d+1]=p.g,a.resultImgArr[d+2]=p.b,a.resultImgArr[d+3]=a.transparency}else a.resultImgArr[d+0]=c,a.resultImgArr[d+1]=c,a.resultImgArr[d+2]=c,a.resultImgArr[d+3]=a.transparency}else c=255-Math.round(255*m),e=Math.floor(b),f=Math.floor(a.imgHeight-a.pixelHeight*(k-2)),d=4*(e+f*a.imgWidth),a.resultImgArr[d+0]=c,a.resultImgArr[d+1]=c,a.resultImgArr[d+2]=c,a.resultImgArr[d+3]=a.transparency}},a.calcMagnitudeSpectrum=function(b,c){for(var d=new Float32Array(a.N),e=new Float32Array(a.N),f=new Float32Array(a.ceilingFreqFftIdx-a.floorFreqFftIdx),g=0;c>g;g++)e[g]=a.audioBuffer[b+g];a.myFFT.applyWindowFuncAndPreemph(a.wFunction,a.internalalpha,e,c),a.myFFT.fft(e,d);for(var h=0;h<=a.ceilingFreqFftIdx-a.floorFreqFftIdx;h++)f[h]=a.magnitude(e[h+a.floorFreqFftIdx],d[h+a.floorFreqFftIdx]),a.totalMax<f[h]&&(a.totalMax=f[h]);return f},a.renderSpectrogram=function(){if(!a.executed){a.executed=!0;var b=a.sampleRate*a.windowSizeInSecs;a.myFFT=new a.FFT,a.paint=new Array(a.imgWidth),a.HzStep=a.sampleRate/2/(a.N/2),a.ceilingFreqFftIdx=Math.ceil(a.upperFreq/a.HzStep),a.floorFreqFftIdx=Math.floor(a.lowerFreq/a.HzStep),a.pixelHeight=a.imgHeight/(a.ceilingFreqFftIdx-a.floorFreqFftIdx-2),"undefined"==typeof Uint8ClampedArray&&(Uint8ClampedArray=Uint8Array),a.resultImgArr=new Uint8ClampedArray(Math.ceil(a.imgWidth*a.imgHeight*4));for(var c=0;c<a.imgWidth;c++)a.paint[c]=a.calcMagnitudeSpectrum(Math.round(c*a.samplesPerPxl),b),a.maxPsd=2*Math.pow(a.totalMax,2)/a.N;for(var d=0;d<a.imgWidth;d++)a.drawVerticalLineOfSpectogram(d);a.postMessage({window:a.wFunction,samplesPerPxl:a.samplesPerPxl,pixelHeight:a.pixelHeight,pixelRatio:a.pixelRatio,width:a.imgWidth,height:a.imgHeight,img:a.resultImgArr.buffer},[a.resultImgArr.buffer]),a.myFFT=null,a.executed=!1}},a.onmessage=function(b){if(void 0!==b.data){var c=!0,d="",e=b.data;if(void 0!==e.windowSizeInSecs?a.windowSizeInSecs=e.windowSizeInSecs:(d="windowSizeInSecs",c=!1),void 0!==e.fftN?a.N=e.fftN:(d="fftN",c=!1),void 0!==e.alpha?a.internalalpha=e.alpha:(d="alpha",c=!1),void 0!==e.upperFreq?a.upperFreq=e.upperFreq:(d="upperFreq",c=!1),void 0!==e.lowerFreq?a.lowerFreq=e.lowerFreq:(d="lowerFreq",c=!1),void 0!==e.samplesPerPxl?a.samplesPerPxl=e.samplesPerPxl:(d="samplesPerPxl",c=!1),void 0!==e.window)switch(e.window){case 1:a.wFunction=a.myWindow.BARTLETT;break;case 2:a.wFunction=a.myWindow.BARTLETTHANN;break;case 3:a.wFunction=a.myWindow.BLACKMAN;break;case 4:a.wFunction=a.myWindow.COSINE;break;case 5:a.wFunction=a.myWindow.GAUSS;break;case 6:a.wFunction=a.myWindow.HAMMING;break;case 7:a.wFunction=a.myWindow.HANN;break;case 8:a.wFunction=a.myWindow.LANCZOS;break;case 9:a.wFunction=a.myWindow.RECTANGULAR;break;case 10:a.wFunction=a.myWindow.TRIANGULAR}else d="window",c=!1;void 0!==e.imgWidth?a.imgWidth=e.imgWidth:(d="imgWidth",c=!1),void 0!==e.imgHeight?a.imgHeight=e.imgHeight:(d="imgHeight",c=!1),void 0!==e.dynRangeInDB?a.dynRangeInDB=e.dynRangeInDB:(d="dynRangeInDB",c=!1),void 0!==e.pixelRatio?a.pixelRatio=e.pixelRatio:(d="pixelRatio",c=!1),void 0!==e.sampleRate?a.sampleRate=e.sampleRate:(d="sampleRate",c=!1),void 0!==e.audioBufferChannels?a.audioBufferChannels=e.audioBufferChannels:(d="audioBufferChannels",c=!1),void 0!==e.transparency?a.transparency=e.transparency:(d="transparency",c=!1),void 0!==e.audioBuffer?a.audioBuffer=e.audioBuffer:(d="audioBuffer",c=!1),void 0!==e.drawHeatMapColors?a.drawHeatMapColors=e.drawHeatMapColors:(d="drawHeatMapColors",c=!1),void 0!==e.preEmphasisFilterFactor?a.preEmphasisFilterFactor=e.preEmphasisFilterFactor:(d="preEmphasisFilterFactor",c=!1),void 0!==e.heatMapColorAnchors?a.heatMapColorAnchors=e.heatMapColorAnchors:(d="heatMapColorAnchors",c=!1),c?a.renderSpectrogram():a.postMessage({status:{type:"ERROR",message:d+" is undefined"}})}else a.postMessage({status:{type:"ERROR",message:"Undefined message was sent to spectroDrawingWorker"}})}},getWorkerURL:function(){var a,b;try{a=new Blob([this.getWorkerScript()],{type:"application/javascript"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,a=new BlobBuilder,a.append(spectroDrawingWorker),a=a.getBlob()}return b="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(a):URL.createObjectURL(a)},kill:function(){this.worker&&this.worker.terminate(),this.url&&("object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.revokeObjectURL(this.url):URL.revokeObjectURL(this.url))},tell:function(a){this.worker&&this.worker.postMessage(a)},says:function(a){this.worker&&this.worker.addEventListener("message",function(b){a(b.data)})}},ssffParserWorker.prototype={getWorkerScript:function(){var a="";return a+="("+this.workerInit+")(this);"},workerInit:function(a){var b={},c="SSFF -- (c) SHLRC\n",d="Machine IBM-PC\n",e="-----------------\n";b.fileExtension="",b.sampleRate=-1,b.startTime=-1,b.origFreq=-1,b.Columns=[],function(){function b(a){var b,c,e,f,g,h;for(e=a.length,c=0,b="";e>c;){if(f=255&a.charCodeAt(c++),c===e){b+=d.charAt(f>>2),b+=d.charAt((3&f)<<4),b+="==";break}if(g=a.charCodeAt(c++),c===e){b+=d.charAt(f>>2),b+=d.charAt((3&f)<<4|(240&g)>>4),b+=d.charAt((15&g)<<2),b+="=";break}h=a.charCodeAt(c++),b+=d.charAt(f>>2),b+=d.charAt((3&f)<<4|(240&g)>>4),b+=d.charAt((15&g)<<2|(192&h)>>6),b+=d.charAt(63&h)}return b}function c(a){var b,c,d,f,g,h,i;for(h=a.length,g=0,i="";h>g;){do b=e[255&a.charCodeAt(g++)];while(h>g&&-1===b);if(-1===b)break;do c=e[255&a.charCodeAt(g++)];while(h>g&&-1===c);if(-1===c)break;i+=String.fromCharCode(b<<2|(48&c)>>4);do{if(d=255&a.charCodeAt(g++),61===d)return i;d=e[d]}while(h>g&&-1===d);if(-1===d)break;i+=String.fromCharCode((15&c)<<4|(60&d)>>2);do{if(f=255&a.charCodeAt(g++),61===f)return i;f=e[f]}while(h>g&&-1===f);if(-1===f)break;i+=String.fromCharCode((3&d)<<6|f)}return i}var d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e=new Array(-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1);a.btoa||(a.btoa=b),a.atob||(a.atob=c)}(),a.base64ToArrayBuffer=function(b){for(var c=a.atob(b),d=c.length,e=new Uint8Array(d),f=0;d>f;f++){var g=c.charCodeAt(f);e[f]=g}return e.buffer},a.round=function(a,b){if(1>b||b>14)return!1;var c=Math.pow(10,b),d=(Math.round(a*c)/c).toString();return-1===d.indexOf(".")&&(d+="."),d+=c.toString().substring(1),d.substring(0,d.indexOf(".")+b+1)},a.stringToUint=function(a){for(var b=a.split(""),c=[],d=0;d<b.length;d++)c.push(b[d].charCodeAt(0));return new Uint8Array(c)},a.Uint8Concat=function(a,b){var c=a.length,d=new Uint8Array(c+b.length);return d.set(a),d.set(b,c),d},a.ssff2jso=function(a,f){b.fileExtension=f,b.Columns=[];var g=new Uint8Array(a),h=new DataView(a),i="";if("TextDecoder"in this){var j=new TextDecoder("ASCII");i=j.decode(h)}else for(var k=0;k<g.length;k++)i+=String.fromCharCode(g[k]);var l=i.split(/^/m);if(l[0]!==c)return{status:{type:"ERROR",message:"SSFF parse error: first line != SSFF -- (c) SHLRC in file with fileExtension "+f}};if(l[1]!==d)return{status:{type:"ERROR",message:"SSFF parse error: machineID != Machine IBM-PC in file with fileExtension "+f}};b.sampleRate=void 0,b.startTime=void 0;for(var m=0;l[m]!==e;)"Record_Freq"===l[m].split(/[ ,]+/)[0]&&(b.sampleRate=parseFloat(l[m].split(/[ ,]+/)[1].replace(/(\r\n|\n|\r)/gm,""))),"Start_Time"===l[m].split(/[ ,]+/)[0]&&(b.startTime=parseFloat(l[m].split(/[ ,]+/)[1].replace(/(\r\n|\n|\r)/gm,""))),m+=1;if(void 0===b.sampleRate||void 0===b.startTime)return{status:{type:"ERROR",message:"SSFF parse error: Required fields Record_Freq or Start_Time not set in file with fileExtension "+f}};for(var n=4;n<l.length&&("Original_Freq"===l[n].split(/[ ,]+/)[0]&&(b.origFreq=parseFloat(l[n].split(/[ ,]+/)[2].replace(/(\r\n|\n|\r)/gm,""))),l[n]!==e);n++){var o=l[n].split(/[ ]+/);"Column"===o[0]&&b.Columns.push({name:o[1],ssffdatatype:o[2],length:parseInt(o[3].replace(/(\r\n|\n|\r)/gm,""),10),values:[],_minVal:1/0,_maxVal:-(1/0)})}for(var p,q,r,s,t,u=l.slice(0,n+1).join("").length;u<g.length;)for(n=0;n<b.Columns.length;n++)if("DOUBLE"===b.Columns[n].ssffdatatype)r=8*b.Columns[n].length,q=a.subarray(u,r),"undefined"==typeof Float64Array&&(Float64Array=Float32Array),p=new Float64Array(q),b.Columns[n].values.push(Array.prototype.slice.call(p)),u+=r,s=Math.min.apply(null,Array.prototype.slice.call(p)),t=Math.max.apply(null,Array.prototype.slice.call(p)),s<b.Columns[n]._minVal&&(b.Columns[n]._minVal=s),t>b.Columns[n]._maxVal&&(b.Columns[n]._maxVal=t);else if("FLOAT"===b.Columns[n].ssffdatatype)r=4*b.Columns[n].length,q=a.subarray(u,r),p=new Float32Array(q),b.Columns[n].values.push(Array.prototype.slice.call(p)),u+=r,s=Math.min.apply(null,Array.prototype.slice.call(p)),t=Math.max.apply(null,Array.prototype.slice.call(p)),s<b.Columns[n]._minVal&&(b.Columns[n]._minVal=s),t>b.Columns[n]._maxVal&&(b.Columns[n]._maxVal=t);else if("SHORT"===b.Columns[n].ssffdatatype)r=2*b.Columns[n].length,q=a.subarray(u,r),p=new Uint16Array(q),b.Columns[n].values.push(Array.prototype.slice.call(p)),u+=r,s=Math.min.apply(null,Array.prototype.slice.call(p)),t=Math.max.apply(null,Array.prototype.slice.call(p)),s<b.Columns[n]._minVal&&(b.Columns[n]._minVal=s),t>b.Columns[n]._maxVal&&(b.Columns[n]._maxVal=t);else{if("BYTE"!==b.Columns[n].ssffdatatype)return{status:{type:"ERROR",message:"Unsupported column type! Only DOUBLE, FLOAT, SHORT, BYTE column types are currently supported in file with fileExtension "+f}};r=1*b.Columns[n].length,q=a.subarray(u,r),p=new Uint8Array(q),b.Columns[n].values.push(Array.prototype.slice.call(p)),u+=r}return b},a.jso2ssff=function(b){var f=c+d;f+="Record_Freq "+a.round(b.sampleRate,1)+"\n",f+="Start_Time "+b.startTime+"\n",b.Columns.forEach(function(a){f+="Column "+a.name+" "+a.ssffdatatype+" "+a.length+"\n"}),f+="Original_Freq DOUBLE "+a.round(b.origFreq,1)+"\n",f+=e;var g=0,h=!1;if(b.Columns.forEach(function(a){"SHORT"===a.ssffdatatype?g+=2*a.length:h=!0}),h)return{status:{type:"ERROR",message:"Unsupported column type! Only SHORT columns supported for now!"}};var i=g*b.Columns[0].values.length,j=new ArrayBuffer(i),k=new DataView(j),l=new Uint8Array(a.stringToUint(f)),m=0;if(b.Columns[0].values.forEach(function(a,c){b.Columns.forEach(function(a){"SHORT"===a.ssffdatatype?a.values[c].forEach(function(a){k.setInt16(m,a,!0),m+=2}):h=!0})}),h)return{status:{type:"ERROR",message:"Unsupported column type! Only SHORT columns supported for now!"}};var n=new Uint8Array(k.buffer);return l=new a.Uint8Concat(l,n),{status:{type:"SUCCESS",message:""},data:l.buffer}},a.parseArr=function(b){for(var c,d=!0,e=[],f=0;f<b.length;f++){c={};var g;if(g=a.base64ToArrayBuffer(b[f].data),c=a.ssff2jso(g,b[f].fileExtension),void 0!==c.status)return d=!1,c;e.push(JSON.parse(JSON.stringify(c)))}return d?{status:{type:"SUCCESS",message:""},data:e}:{status:{type:"ERROR",message:"Error in parseArr() with: "+JSON.stringify(b)}}},ArrayBuffer.prototype.subarray=function(a,b){for(var c=new ArrayBuffer(b),d=new Int8Array(c),e=new Int8Array(this),f=0;b>f;f++)d[f]=e[a+f];return c},a.onmessage=function(b){if(void 0!==b.data)switch(b.data.cmd){case"parseArr":a.postMessage(a.parseArr(b.data.ssffArr));break;case"jso2ssff":a.postMessage(a.jso2ssff(JSON.parse(b.data.jso)));break;default:a.postMessage({status:{type:"ERROR",message:"Unknown command sent to ssffParserWorker"}})}else a.postMessage({status:{type:"ERROR",message:"Undefined message was sent to ssffParserWorker"}})}},getWorkerURL:function(){var a,b;try{a=new Blob([this.getWorkerScript()],{type:"application/javascript"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,a=new BlobBuilder,a.append(textGridParserWorker),a=a.getBlob()}return b="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(a):URL.createObjectURL(a)},kill:function(){this.worker&&(this.worker.terminate(),this.worker=void 0),this.url&&("object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.revokeObjectURL(this.url):URL.revokeObjectURL(this.url),this.url=void 0)},tell:function(a){this.worker&&this.worker.postMessage(a)},says:function(a){
this.worker&&this.worker.addEventListener("message",function(b){a(b.data)})}},angular.module("emuwebApp").service("mathHelperService",function(){var a={};return a.calcClosestPowerOf2Gt=function(a){for(var b=0;Math.pow(2,b)<a;)b+=1;return Math.pow(2,b)},a.roundToNdigitsAfterDecPoint=function(a,b){(1>b||b>14)&&console.error("error in call of round function!!");var c=Math.pow(10,b),d=(Math.round(a*c)/c).toString();return-1===d.indexOf(".")&&(d+="."),d+=c.toString().substring(1),parseFloat(d.substring(0,d.indexOf(".")+b+1))},a}),angular.module("emuwebApp").directive("modal",["$animate","modalService",function(a,b){return{restrict:"E",templateUrl:"views/modal.html",replace:!0,scope:{},link:function(a,c,d){a.templateUrl="",a.modal=b,a.isOpen=!1,a.force=!1,a.dataIn="",a.$watch("modal.isOpen",function(d,e){void 0!==d&&(a.templateUrl=b.getTemplateUrl(),a.dataIn=b.dataIn,a.force=b.force,d?c[0].classList.add("emuwebapp-modal-open"):c[0].classList.remove("emuwebapp-modal-open"))}),a.$watch("modal.templateUrl",function(c,d){void 0!==c&&(a.templateUrl=c,a.dataIn=b.dataIn,a.force=b.force)})}}}]),angular.module("emuwebApp").service("modalService",["$q","ArrayHelperService","viewState",function(a,b,c){var d={};return d.isOpen=!1,d.templateUrl="",d.defer=void 0,d.deferChange=void 0,d.force=!1,d.dataOut=void 0,d.dataIn=void 0,d.dataExport=void 0,d.open=function(e,f,g,h){return void 0!==f&&(d.dataIn=f,void 0!==f.y&&(d.dataIn.chartData=b.convertArrayToXYjsoArray(f.y))),void 0!==g&&(d.dataExport=g),void 0!==h&&(d.force=h),d.defer=a.defer(),d.templateUrl=e,c.setState("modalShowing"),d.isOpen=!0,d.defer.promise},d.changeModal=function(b,c,e,f){return void 0!==c&&(d.dataIn=c),void 0!==e&&(d.dataExport=e),void 0!==f&&(d.force=f),d.deferChange=a.defer(),d.templateUrl=b,d.deferChange.promise},d.error=function(a){d.dataIn=a,d.templateUrl="views/error.html",c.setState("modalShowing")},d.close=function(){c.setEditing(!1),c.setState(c.prevState),d.isOpen=!1,c.hierarchyState.isShown()&&c.hierarchyState.toggleHierarchy(),d.defer.resolve(!1)},d.closeAndResolve=function(a){c.setEditing(!1),c.setState(c.prevState),d.isOpen=!1,d.defer.resolve(a)},d.confirm=function(){c.setEditing(!1),c.setState(c.prevState),d.isOpen=!1,d.defer.resolve(!0)},d.select=function(a){d.closeAndResolve(a)},d.confirmContent=function(){c.setEditing(!1),c.setState(c.prevState),d.isOpen=!1,d.defer.resolve(d.dataOut)},d.getTemplateUrl=function(){return d.templateUrl},d}]),angular.module("emuwebApp").controller("TabbedCtrl",["$scope","$timeout","ConfigProviderService","Validationservice","viewState","modalService",function(a,b,c,d,e,f){a.cps=c,a.vs=e,a.tree=[{title:"Perspectives Configuration",url:"views/config/perspectives.html"},{title:"Spectrogram Settings",url:"views/config/spectro.html"},{title:"Expert Settings",url:"views/config/expert.html"}],a.cps=c,a.modal=f,a.schema=d.getSchema("emuwebappConfigSchema").data.properties,a.modal.dataOut=angular.copy(c.vals),a.warning="",a.init=function(){a.options=Object.keys(e.getWindowFunctions()),a.timeMode=Object.keys(e.getTimeModes()),a.comMode=Object.keys(e.getCommunicationModes()),a.signalTypes=Object.keys(e.getSignalTypes()),a.levelTypes=[],angular.forEach(c.curDbConfig.ssffTrackDefinitions,function(b,c){a.signalTypes.push(b.name)}),angular.forEach(c.curDbConfig.levelDefinitions,function(b,c){("SEGMENT"===b.type||"EVENT"===b.type)&&a.levelTypes.push(b.name)}),a.currentSignal=a.signalTypes[0],a.levelTypes.length>0&&(a.currentLevel=a.levelTypes[0])},a.onClickTab=function(b){b.url!==!1&&(a.currentTabUrl=b.url)},a.getType=function(b,c){var d=void 0;return angular.forEach(a.schema,function(a,e){e===b&&angular.forEach(a.properties,function(a,b){b===c&&(d=a.type)})}),d},a.up=function(b,c,d){var e=a.modal.dataOut.perspectives[b];if(c>0)if(0===d){var f=e.signalCanvases.order[c-1];e.signalCanvases.order[c-1]=e.signalCanvases.order[c],e.signalCanvases.order[c]=f}else if(1===d){var f=e.levelCanvases.order[c-1];e.levelCanvases.order[c-1]=e.levelCanvases.order[c],e.levelCanvases.order[c]=f}},a.down=function(b,c,d){var e=a.modal.dataOut.perspectives[b];if(0===d){if(void 0!==e.signalCanvases.order[c+1]){var f=e.signalCanvases.order[c+1];e.signalCanvases.order[c+1]=e.signalCanvases.order[c],e.signalCanvases.order[c]=f}}else if(1===d&&void 0!==e.levelCanvases.order[c+1]){var f=e.levelCanvases.order[c+1];e.levelCanvases.order[c+1]=e.levelCanvases.order[c],e.levelCanvases.order[c]=f}},a.del=function(b,c,d){var e=a.modal.dataOut.perspectives[b];if(void 0!==e.signalCanvases.assign)for(var f=!1,g="",h=0;h<e.signalCanvases.assign.length;h++)e.signalCanvases.assign[h].signalCanvasName===e.signalCanvases.order[c]&&(f=!0,g=e.signalCanvases.assign[h].signalCanvasName),e.signalCanvases.assign[h].ssffTrackName===e.signalCanvases.order[c]&&(f=!0,g=e.signalCanvases.assign[h].ssffTrackName);f?a.showWarning('Could not delete "'+g+'" because of internal dependencies !'):e.signalCanvases.order.splice(c,1)},a.showWarning=function(c){a.warningSignal=!0,a.warning=c,b(function(){a.warningSignal=!1},2e3)},a.perspDelete=function(b){delete a.modal.dataOut.perspectives.splice(b,1)},a.signalAdd=function(b,c){var d=a.modal.dataOut.perspectives[b];void 0===d.signalCanvases.order&&(d.signalCanvases.order=[]),-1===d.signalCanvases.order.indexOf(c)?d.signalCanvases.order.push(c):a.showWarning('Signal "'+level+'" already existing')},a.levelAdd=function(b,c){var d=a.modal.dataOut.perspectives[b];void 0===d.levelCanvases.order&&(d.levelCanvases.order=[]),-1===d.levelCanvases.order.indexOf(c)?d.levelCanvases.order.push(c):a.showWarning('Level "'+c+'" already existing')},a.perspAdd=function(){var b={name:"new Perspective",signalCanvases:[],levelCanvases:{order:[]},twoDimCanvases:[]};a.modal.dataOut.perspectives.splice(a.modal.dataOut.perspectives.length,0,b)},a.cursorInTextField=function(){e.setEditing(!0),e.setcursorInTextField(!0)},a.cursorOutOfTextField=function(){e.setEditing(!1),e.setcursorInTextField(!1)},a.onClickTab(a.tree[0]),a.init()}]),angular.module("emuwebApp").controller("TabbedHelpCtrl",["$scope","ConfigProviderService","Iohandlerservice",function(a,b,c){a.cps=b,a.tree=[],c.httpGetPath("manual/index.json").then(function(b){a.tree=b.data,console.log(a.tree),a.onClickTab(a.tree[0]),a.tree[0].expanded=!0}),a.onClickTab=function(b){b.expanded=!b.expanded,b.url!==!1&&("md"===b.url.substr(b.url.lastIndexOf(".")+1).toLowerCase()?(a.isMDFile=!0,a.currentTabUrl=b.url):(a.isMDFile=!1,a.currentTabUrl=b.url))},a.hasChildren=function(a){return void 0!==a.nodes&&a.nodes.length>0?!0:!1}}]),angular.module("emuwebApp").service("HierarchyManipulationService",["$q","HierarchyLayoutService","DataService","LevelService","ConfigProviderService","ArrayHelperService",function(a,b,c,d,e,f){var g={};return g.addLink=function(a,b,d){var e=g.checkLinkValidity(a,b,d);if(e.valid){var f={fromID:b,toID:d};return c.insertLinkData(f),f}if(console.debug("Not adding invalid link:",b,"->",d," (Error code:",e.reason,")"),3===e.reason){if(e=g.checkLinkValidity(a,d,b),e.valid){console.debug("Adding reverse link instead");var f={fromID:d,toID:b};return c.insertLinkData(f),f}return null}return null},g.checkLinkValidity=function(a,f,g){var h={valid:!0,reason:0},i=c.getLinkData();if(f===g)return h.valid=!1,h.reason=1,h;for(var j=0;j<i.length;++j)if(i[j].fromID===f&&i[j].toID===g)return h.valid=!1,h.reason=2,h;var k=d.getLevelName(f),l=d.getLevelName(g),m=a.indexOf(k);if(a[m-1]!==l)return h.valid=!1,h.reason=3,h;for(var n,j=0;j<e.curDbConfig.linkDefinitions.length;++j)e.curDbConfig.linkDefinitions[j].sublevelName===l&&e.curDbConfig.linkDefinitions[j].superlevelName===k&&(n=e.curDbConfig.linkDefinitions[j].type);if(void 0===n)return consle.debug("LIKELY A BUG: link to be added (",f,"->",g,") has been found to be a part of the currently selected path but the link between the respective levels could not be found."),h.valid=!1,h.reason=3,h;if("ONE_TO_MANY"===n||"ONE_TO_ONE"===n){var o=d.getItemByID(g);if(o._parents.length>0)return h.valid=!1,h.reason=4,h}if("ONE_TO_ONE"===n){var p=d.getItemByID(f),q=b.findChildren(p,a);if(q.length>0)return h.valid=!1,h.reason=4,h}for(var r,s=void 0,t=void 0,u=d.getLevelAndItem(f).level,v=d.getLevelAndItem(g).level,w=d.getOrderById(k,f),x=d.getOrderById(l,g),y=0;void 0===s;){if(y-=1,r=u.items[w+y],void 0===r){s=0;break}console.debug("found preceding sibling",r.id,r.labels[0]);for(var q=b.findChildren(r,a),j=0;j<q.length;++j){var z=d.getOrderById(l,q[j].id);(void 0===s||z>s)&&(s=z)}}for(y=0;void 0===t;){if(y+=1,r=u.items[w+y],void 0===r){t=v.items.length-1;break}console.debug("found successive sibling",r.id,r.labels[0]);var q=b.findChildren(r,a);if(0!==q.length)for(var j=0;j<q.length;++j){var z=d.getOrderById(l,q[j].id);(void 0===t||t>z)&&(t=z)}}return console.debug("child must be within",s,t),s>x||x>t?(h.valid=!1,h.reason=5,h):h},g}]),angular.module("emuwebApp").service("StandardFuncsService",function(){var a={};return a.traverseAndClean=function(b){for(var c in b)"_"===c.substr(0,1)&&delete b[c],null!==b[c]&&"object"==typeof b[c]&&a.traverseAndClean(b[c])},a.reverseCopy=function(a){var b=angular.copy(a);return b.reverse(),b},a}),angular.module("emuwebApp").filter("startFrom",function(){return function(a,b){return b=+b,a.slice(b)}}),angular.module("emuwebApp").controller("ManualCtrl",["$scope","ConfigProviderService",function(a,b){a.listOfMarkdownFiles=[{title:"Introduction",url:"manual/Introduction.md"},{title:"EMU-webApp-websocket-protocol",url:"manual/EMU-webApp-websocket-protocol.md"},{title:"Labeling articulatory data",url:"manual/Labeling-articulatory-data.md"}],a.curMdFile=a.listOfMarkdownFiles[0],a.setCurrentMdFile=function(b){a.curMdFile=b},a.isCurrentMdFile=function(c){return console.log(c),console.log(a.curMdFile.url),c===a.curMdFile.url?{"background-color":b.design.color.white,color:b.design.color.black,"font-weight":"500"}:{"background-color":b.design.color.blue,color:b.design.color.white,"font-weight":"400"}}}]);