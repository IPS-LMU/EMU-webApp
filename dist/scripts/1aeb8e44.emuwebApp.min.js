"use strict";ArrayBuffer.prototype.subarray=function(a,b){for(var c=new ArrayBuffer(b),d=new Int8Array(c),e=new Int8Array(this),f=0;b>f;f++)d[f]=e[a+f];return c},angular.module("emuwebApp",["ui","ui.bootstrap","ngAnimate"]).config(["$locationProvider",function(a){a.html5Mode(!0)}]),angular.module("emuwebApp").service("ConfigProviderService",["viewState",function(a){var b={};return b.vals={},b.curDbConfig={},b.embeddedVals={audioGetUrl:"",labelGetUrl:"",labelType:"",fromUrlParams:!1},b.setVals=function(a){$.isEmptyObject(b.vals)?b.vals=a:angular.forEach(Object.keys(a),function(c){angular.isArray(b.vals[c])?(b.vals[c]=[],angular.forEach(a[c],function(a){b.vals[c].push(a)})):angular.forEach(Object.keys(a[c]),function(d){void 0!==b.vals[c][d]?b.vals[c][d]=a[c][d]:console.error("BAD ENTRY IN CONFIG! Key1: "+c+" key2: "+d)})})},b.getSsffTrackConfig=function(a){var c;return void 0!==b.curDbConfig.ssffTrackDefinitions&&angular.forEach(b.curDbConfig.ssffTrackDefinitions,function(b){b.name===a&&(c=b)}),c},b.getLimsOfTrack=function(c){var d={};return angular.forEach(b.vals.perspectives[a.curPerspectiveIdx].signalCanvases.contourLims,function(a){a.ssffTrackName===c&&(d=a)}),d},b.getContourColorsOfTrack=function(c){var d;return angular.forEach(b.vals.perspectives[a.curPerspectiveIdx].signalCanvases.contourColors,function(a){a.ssffTrackName===c&&(d=a)}),d},b.getAssignment=function(c){var d={};return angular.forEach(b.vals.perspectives[a.curPerspectiveIdx].signalCanvases.assign,function(a){a.signalCanvasName===c&&(d=a)}),d},b.getLevelDefinition=function(a){var c={};return angular.forEach(b.curDbConfig.levelDefinitions,function(b){b.name===a&&(c=b)}),c},b}]),angular.module("emuwebApp").controller("MainCtrl",["$scope","$rootScope","$modal","$log","$compile","$timeout","$q","$window","$document","$location","viewState","HistoryService","Iohandlerservice","Soundhandlerservice","ConfigProviderService","fontScaleService","Ssffdataservice","LevelService","dialogService","Textgridparserservice","Espsparserservice","Binarydatamaniphelper","Wavparserservice","Ssffparserservice","Drawhelperservice","Validationservice","Appcachehandler",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A){a.cps=o,a.hists=l,a.fontImage=p,a.levServ=r,a.vs=k,a.dials=s,a.ssffds=q,a.shs=n,a.dhs=y,a.wps=w,a.io=m,a.ach=A,a.connectBtnLabel="connect",a.tmp={},a.dbLoaded=!1,a.is2dCancasesHidden=!0,a.bundleList=[],a.curUserName="",a.curBndl={},a.lastclickedutt=null,a.filterText="",a.windowWidth=h.outerWidth,a.demoDbName="",a.firefox=navigator.userAgent.match(/Firefox/i)?!0:!1,a.ach.checkForNewVersion(),angular.element(h).bind("resize",function(){r.deleteEditArea(),k.setWindowWidth(h.outerWidth),a.$digest()}),angular.element(h).bind("keyup",function(b){(b.keyCode===o.vals.keyMappings.shift||b.keyCode===o.vals.keyMappings.alt)&&(l.addCurChangeObjToUndoStack(),a.$digest())}),window.onbeforeunload=function(){return""===o.embeddedVals.audioGetUrl&&a.bundleList.length>0&&!o.vals.main.autoConnect?"Do you really wish to leave/reload the EMU-webApp? All unsaved changes will be lost...":void 0},a.$on("connectionDisrupted",function(){a.resetToInitState()});var B=j.search();B.audioGetUrl&&B.labelGetUrl&&B.labelType&&(o.embeddedVals.audioGetUrl=B.audioGetUrl,o.embeddedVals.labelGetUrl=B.labelGetUrl,o.embeddedVals.labelType=B.labelType,o.embeddedVals.fromUrlParams=!0),a.loadFilesForEmbeddedApp=function(){o.embeddedVals.audioGetUrl&&m.httpGetPath(o.embeddedVals.audioGetUrl,"arraybuffer").then(function(b){k.showDropZone=!1;var c=o.embeddedVals.audioGetUrl;a.curBndl.name=c.substr(0,c.lastIndexOf(".")).substr(c.lastIndexOf("/")+1,c.length),k.getsubmenuOpen()&&k.togglesubmenuOpen(o.vals.colors.transitionTime),k.somethingInProgressTxt="Loading DB config...",m.httpGetPath("configFiles/embedded_emuwebappConfig.json").then(function(a){k.curPerspectiveIdx=0,o.setVals(a.data.EMUwebAppConfig),delete a.data.EMUwebAppConfig;var c=z.validateJSO("emuwebappConfigSchema",o.vals);c===!0?(o.embeddedVals.fromUrlParams&&(o.vals.main.catchMouseForKeyBinding=!1),o.curDbConfig=a.data,c=z.validateJSO("DBconfigFileSchema",o.curDbConfig),c===!0?(k.somethingInProgress=!0,k.somethingInProgressTxt="Parsing WAV file...",w.parseWavArrBuf(b.data).then(function(a){var b=a;k.curViewPort.sS=0,k.curViewPort.eS=b.Data.length,k.resetSelect(),n.wavJSO=b,m.httpGetPath(o.embeddedVals.labelGetUrl,"utf-8").then(function(a){k.somethingInProgressTxt="Parsing "+o.embeddedVals.labelType+" file...",m.parseLabelFile(a.data,o.embeddedVals.labelGetUrl,"embeddedTextGrid",o.embeddedVals.labelType).then(function(a){var b=a.data;r.setData(b);var c=[],d=[];b.levels.forEach(function(a){c.push(a.name),d.push({name:a.name,type:a.type,attributeDefinitions:{name:a.name,type:"string"}})}),o.curDbConfig.levelDefinitions=d,k.setCurLevelAttrDefs(o.curDbConfig.levelDefinitions),o.vals.perspectives[k.curPerspectiveIdx].levelCanvases.order=c,k.somethingInProgressTxt="Done!",k.somethingInProgress=!1,k.setState("labeling")},function(a){s.open("views/error.html","ModalCtrl","Error parsing wav file: "+a.status.message)})},function(a){s.open("views/error.html","ModalCtrl","Could not get label file: "+o.embeddedVals.labelGetUrl+" ERROR "+JSON.stringify(a,null,4))})},function(a){s.open("views/error.html","ModalCtrl","Error parsing wav file: "+a.status.message)})):s.open("views/error.html","ModalCtrl","Error validating DBconfig: "+JSON.stringify(c,null,4))):s.open("views/error.html","ModalCtrl","Error validating ConfigProviderService.vals (emuwebappConfig data) after applying changes of newly loaded config (most likely due to wrong entry...): "+JSON.stringify(c,null,4))},function(a){s.open("views/error.html","ModalCtrl","Could not get embedded_config.json: "+a)})},function(a){s.open("views/error.html","ModalCtrl","Could not get audio file:"+o.embeddedVals.audioGetUrl+" ERROR: "+JSON.stringify(a,null,4))})},a.loadDefaultConfig=function(){k.somethingInProgress=!0,k.somethingInProgressTxt="Loading schema files",z.loadSchemas().then(function(b){z.setSchemas(b),m.httpGetDefaultConfig().success(function(b){k.somethingInProgressTxt="Validating emuwebappConfig";var c=z.validateJSO("emuwebappConfigSchema",b);c===!0?(o.setVals(b),a.handleDefaultConfigLoaded(),a.loadFilesForEmbeddedApp(),k.somethingInProgress=!1):s.open("views/error.html","ModalCtrl","Error validating emuwebappConfigSchema: "+JSON.stringify(c,null,4)).then(function(){a.resetToInitState()})}).error(function(b,c,d,e){s.open("views/error.html","ModalCtrl","Could not get defaultConfig for EMU-webApp:  status: "+c+" header: "+d+" config "+e).then(function(){a.resetToInitState()})})},function(b){s.open("views/error.html","ModalCtrl","Error loading schema file: "+JSON.stringify(b,null,4)).then(function(){a.resetToInitState()})})},a.loadDefaultConfig(),a.handleDefaultConfigLoaded=function(){k.getsubmenuOpen()||k.togglesubmenuOpen(o.vals.colors.transitionTime),o.vals.main.autoConnect&&m.wsH.initConnect(o.vals.main.serverUrl).then(function(b){"error"===b.type?s.open("views/error.html","ModalCtrl","Could not connect to websocket server: "+o.vals.main.defaultServerUrl):a.handleConnectedToWSserver()}),k.setspectroSettings(o.vals.spectrogramSettings.N,o.vals.spectrogramSettings.rangeFrom,o.vals.spectrogramSettings.rangeTo,o.vals.spectrogramSettings.dynamicRange,o.vals.spectrogramSettings.window,o.vals.spectrogramSettings.drawHeatMapColors,o.vals.spectrogramSettings.preEmphasisFilterFactor,o.vals.spectrogramSettings.heatMapColorAnchors),k.setTransitionTime(o.vals.colors.transitionTime/1e3)},a.handleConnectedToWSserver=function(){k.showDropZone=!1,o.vals.main.comMode="WS",k.somethingInProgress=!0,k.somethingInProgressTxt="Checking protocol...",m.getProtocol().then(function(b){"EMU-webApp-websocket-protocol"===b.protocol&&"0.0.1"===b.version?(k.somethingInProgressTxt="Checking user management...",m.getDoUserManagement().then(function(b){"NO"===b?a.innerHandleConnectedToWSserver():s.open("views/loginModal.html","LoginCtrl").then(function(b){b?a.innerHandleConnectedToWSserver():a.resetToInitState()})})):s.open("views/error.html","ModalCtrl","Could not connect to websocket server: "+o.vals.main.serverUrl+'. It does not speak the same protocol as this client. Its protocol answer was: "'+b.protocol+'" with the version: "'+b.version+'"').then(function(){a.resetToInitState()})})},a.innerHandleConnectedToWSserver=function(){k.somethingInProgressTxt="Loading DB config...",m.getDBconfigFile().then(function(b){k.curPerspectiveIdx=0,o.setVals(b.EMUwebAppConfig),delete b.EMUwebAppConfig;var c=z.validateJSO("emuwebappConfigSchema",o.vals);c===!0?(o.curDbConfig=b,k.setCurLevelAttrDefs(o.curDbConfig.levelDefinitions),c=z.validateJSO("DBconfigFileSchema",b),c===!0?(k.somethingInProgressTxt="Loading bundle list...",m.getBundleList().then(function(b){c=z.validateJSO("bundleListSchema",b),c===!0?(a.bundleList=b,a.menuBundleClick(a.bundleList[0])):s.open("views/error.html","ModalCtrl","Error validating bundleList: "+JSON.stringify(c,null,4)).then(function(){a.resetToInitState()})})):s.open("views/error.html","ModalCtrl","Error validating DBconfig: "+JSON.stringify(c,null,4)).then(function(){a.resetToInitState()})):s.open("views/error.html","ModalCtrl","Error validating ConfigProviderService.vals (emuwebappConfig data) after applying changes of newly loaded config (most likely due to wrong entry...): "+JSON.stringify(c,null,4)).then(function(){a.resetToInitState()})})},a.menuBundleClick=function(b){0!==l.movesAwayFromLastSave&&"DEMO"!==o.vals.main.comMode?b!==a.curBndl&&(a.lastclickedutt=b,s.open("views/saveChanges.html","ModalCtrl",b.name).then(function(c){"saveChanges"===c?a.menuBundleSaveBtnClick().then(function(){a.menuBundleClick(b)}):"discardChanges"===c&&(l.resetToInitState(),a.menuBundleClick(b))})):b!==a.curBndl&&(l.resetToInitState(),k.setState("loadingSaving"),k.somethingInProgress=!0,k.somethingInProgressTxt="Loading bundle: "+b.name,q.data=[],m.getBundle(b.name,a.demoDbName).then(function(c){200===c.status&&(c=c.data);var d;d=v.base64ToArrayBuffer(c.mediaFile.data),k.somethingInProgressTxt="Parsing WAV file...",w.parseWavArrBuf(d).then(function(d){var e=d;k.curViewPort.sS=0,k.curViewPort.eS=e.Data.length,k.curViewPort.selectS=-1,k.curViewPort.selectE=-1,k.curClickSegments=[],k.curClickLevelName=void 0,k.curClickLevelType=void 0,k.resetSelect(),n.wavJSO=e,k.somethingInProgressTxt="Parsing SSFF files...",x.asyncParseSsffArr(c.ssffFiles).then(function(d){q.data=d.data;var e=z.validateJSO("annotationFileSchema",c.annotation);e===!0?(r.setData(c.annotation),a.curBndl=b,k.setState("labeling"),k.somethingInProgress=!1,k.somethingInProgressTxt="Done!"):s.open("views/error.html","ModalCtrl","Error validating annotation file: "+JSON.stringify(e,null,4)).then(function(){a.resetToInitState()})},function(b){s.open("views/error.html","ModalCtrl","Error parsing SSFF file: "+b.status.message).then(function(){a.resetToInitState()})})},function(b){s.open("views/error.html","ModalCtrl","Error parsing wav file: "+b.status.message).then(function(){a.resetToInitState()})})},function(b){b.data?s.open("views/error.html","ModalCtrl","Error loading bundle: "+b.data).then(function(){a.resetToInitState()}):s.open("views/error.html","ModalCtrl","Error loading bundle: "+b.status.message).then(function(){a.resetToInitState()})}))},a.menuBundleSaveBtnClick=function(){if(k.getPermission("saveBndlBtnClick")){var b=g.defer();k.somethingInProgress=!0,k.setState("loadingSaving");var c={};k.somethingInProgressTxt="Creating bundle json...",c.ssffFiles=[];var e={};return q.data.forEach(function(a){"FORMANTS"===a.ssffTrackName&&(e=a)}),$.isEmptyObject(e)?a.getAnnotationAndSaveBndl(c,b):x.asyncJso2ssff(e).then(function(d){c.ssffFiles.push({ssffTrackName:e.ssffTrackName,encoding:"BASE64",data:v.arrayBufferToBase64(d.data)}),a.getAnnotationAndSaveBndl(c,b)},function(a){s.open("views/error.html","ModalCtrl","Error converting javascript object to ssff file: "+a.status.message),b.reject()}),b.promise}d.info("Action: menuBundleSaveBtnClick not allowed!")},a.getAnnotationAndSaveBndl=function(b,c){b.annotation=r.getData(),k.somethingInProgressTxt="Saving bundle...",m.saveBundle(b).then(function(){k.somethingInProgressTxt="Done!",k.somethingInProgress=!1,l.movesAwayFromLastSave=0,c.resolve(),k.setState("labeling")},function(b){s.open("views/error.html","ModalCtrl","Error saving bundle: "+b.status.message).then(function(){a.resetToInitState()}),c.reject()})},a.uttIsDisabled=function(b){return b.name===a.curBndl.name?!1:!0},a.getEnlarge=function(a){var b=o.vals.perspectives[k.curPerspectiveIdx].signalCanvases.order.length,c=50;return-1==k.getenlarge()?"auto":1===b?"auto":2===b?k.getenlarge()==a?"70%":"27%":k.getenlarge()==a?c+"%":(98-c)/(b-1)+"%"},a.getBndlColor=function(b){var c;return c=0!==l.movesAwayFromLastSave?{"background-color":"#f00",color:"white"}:{"background-color":"#999",color:"black"},b.name===a.curBndl.name?c:void 0},a.cursorInTextField=function(){k.focusInTextField=!0},a.cursorOutOfTextField=function(){k.focusInTextField=!1},a.openSubmenu=function(){k.togglesubmenuOpen(o.vals.colors.transitionTime)},a.addLevelSegBtnClick=function(){if(k.getPermission("addLevelSegBtnClick")){var a=0;void 0!==r.data.levels&&(a=r.data.levels.length);var b="levelNr"+a,c={items:[{id:r.getNewId(),sampleStart:0,sampleDur:n.wavJSO.Data.length,labels:[{name:b,value:o.vals.labelCanvasConfig.newSegmentName}]}],name:b,type:"SEGMENT"};if(void 0===k.getCurAttrDef(b)){var d={name:b,type:"EVENT",attributeDefinitions:{name:b,type:"string"}};k.setCurLevelAttrDefs(d)}r.addLevel(c,a,k.curPerspectiveIdx),l.addObjToUndoStack({type:"ESPS",action:"ADDLEVEL",level:c,id:a,curPerspectiveIdx:k.curPerspectiveIdx})}else console.log("action currently not allowed")},a.addLevelPointBtnClick=function(){if(k.getPermission("addLevelPointBtnClick")){var a=0;void 0!==r.data.levels&&(a=r.data.levels.length);var b="levelNr"+a,c={items:[{id:r.getNewId(),samplePoint:Math.round(n.wavJSO.Data.length/2),labels:[]}],name:b,type:"EVENT"};if(c.items[0].labels.push({name:b,value:o.vals.labelCanvasConfig.newEventName}),void 0===k.getCurAttrDef(b)){var d={name:b,type:"EVENT",attributeDefinitions:{name:b,type:"string"}};k.setCurLevelAttrDefs(d)}r.addLevel(c,a,k.curPerspectiveIdx),l.addObjToUndoStack({type:"ESPS",action:"ADDLEVEL",level:c,id:a,curPerspectiveIdx:k.curPerspectiveIdx})}else console.log("action currently not allowed")},a.renameSelLevelBtnClick=function(){k.getPermission("renameSelLevelBtnClick")?void 0!==k.getcurClickLevelName()?s.open("views/renameLevel.html","ModalCtrl",k.getcurClickLevelName()):s.open("views/error.html","ModalCtrl","Rename Error : Please choose a Level first !"):console.log("action currently not allowed")},a.downloadTextGridBtnClick=function(){k.getPermission("downloadTextGridBtnClick")?t.asyncToTextGrid().then(function(b){s.openExport("views/export.html","ExportCtrl",b.data,a.curBndl.name+".TextGrid")}):console.log("action currently not allowed")},a.spectSettingsBtnClick=function(){k.getPermission("spectSettingsChange")?s.open("views/spectSettings.html","spectSettingsCtrl",""):console.log("action currently not allowed")},a.connectBtnClick=function(){k.getPermission("connectBtnClick")?s.open("views/connectModal.html","WsconnectionCtrl").then(function(b){b&&m.wsH.initConnect(b).then(function(c){"error"===c.type?s.open("views/error.html","ModalCtrl","Could not connect to websocket server: "+b):a.handleConnectedToWSserver()})}):console.log("action currently not allowed")},a.openDemoDBbtnClick=function(b){k.getPermission("openDemoBtnDBclick")&&(a.demoDbName=b,k.showDropZone=!1,k.somethingInProgress=!0,k.setState("loadingSaving"),o.vals.main.comMode="DEMO",k.somethingInProgressTxt="Loading DB config...",m.getDBconfigFile(b).then(function(c){var d=c.data;k.curPerspectiveIdx=0,o.setVals(d.EMUwebAppConfig),delete d.EMUwebAppConfig;var e=z.validateJSO("emuwebappConfigSchema",o.vals);e===!0?(o.curDbConfig=d,k.setCurLevelAttrDefs(o.curDbConfig.levelDefinitions),e=z.validateJSO("DBconfigFileSchema",o.curDbConfig),e===!0?(k.somethingInProgressTxt="Loading bundle list...",m.getBundleList(b).then(function(b){var c=b.data;e=z.validateJSO("bundleListSchema",c),e===!0?(a.bundleList=c,a.menuBundleClick(a.bundleList[0])):s.open("views/error.html","ModalCtrl","Error validating bundleList: "+JSON.stringify(e,null,4)).then(function(){a.resetToInitState()})},function(c){s.open("views/error.html","ModalCtrl","Error loading bundle list of "+b+": "+c.data+" STATUS: "+c.status).then(function(){a.resetToInitState()})})):s.open("views/error.html","ModalCtrl","Error validating DBconfig: "+JSON.stringify(e,null,4)).then(function(){a.resetToInitState()})):s.open("views/error.html","ModalCtrl","Error validating ConfigProviderService.vals (emuwebappConfig data) after applying changes of newly loaded config (most likely due to wrong entry...): "+JSON.stringify(e,null,4)).then(function(){a.resetToInitState()})},function(c){s.open("views/error.html","ModalCtrl","Error loading DB config of "+b+": "+c.data+" STATUS: "+c.status).then(function(){a.resetToInitState()})}))},a.aboutBtnClick=function(){s.open("views/about.html","AboutCtrl")},a.clearBtnClick=function(){var b;b=0!==l.movesAwayFromLastSave&&"DEMO"!==o.vals.main.comMode?"Do you wish to clear all loaded data and if connected disconnect from the server? CAUTION: YOU HAVE UNSAVED CHANGES! These will be lost if you confirm.":"Do you wish to clear all loaded data and if connected disconnect from the server? You have NO unsaved changes so no changes will be lost.",s.open("views/confirmModal.html","ConfirmmodalCtrl",b).then(function(b){b&&a.resetToInitState()})},a.resetToInitState=function(){m.wsH.isConnected()&&m.wsH.disconnectWarning().then(function(){d.info("Closing websocket connection to server"),m.wsH.closeConnect()}),a.curBndl={},a.bundleList=[],n.wavJSO={},r.data={},q.data=[],l.resetToInitState(),k.setState("noDBorFilesloaded"),a.$broadcast("resetToInitState"),k.somethingInProgress=!1,k.resetToInitState(),k.showDropZone=!0,a.loadDefaultConfig()},a.cmdZoomAll=function(){k.getPermission("zoom")?(r.deleteEditArea(),k.setViewPort(0,n.wavJSO.Data.length)):console.log("action currently not allowed")},a.cmdZoomIn=function(){k.getPermission("zoom")?(r.deleteEditArea(),k.zoomViewPort(!0)):console.log("action currently not allowed")},a.cmdZoomOut=function(){k.getPermission("zoom")?(r.deleteEditArea(),k.zoomViewPort(!1)):console.log("action currently not allowed")},a.cmdZoomLeft=function(){k.getPermission("zoom")?(r.deleteEditArea(),k.shiftViewPort(!1)):console.log("action currently not allowed")},a.cmdZoomRight=function(){k.getPermission("zoom")?(r.deleteEditArea(),k.shiftViewPort(!0)):console.log("action currently not allowed")},a.cmdZoomSel=function(){k.getPermission("zoom")?(r.deleteEditArea(),k.setViewPort(k.curViewPort.selectS,k.curViewPort.selectE)):console.log("action currently not allowed")},a.cmdPlayView=function(){k.getPermission("playaudio")?(n.playFromTo(k.curViewPort.sS,k.curViewPort.eS),k.animatePlayHead(k.curViewPort.sS,k.curViewPort.eS)):console.log("action currently not allowed")},a.cmdPlaySel=function(){k.getPermission("playaudio")?(n.playFromTo(k.curViewPort.selectS,k.curViewPort.selectE),k.animatePlayHead(k.curViewPort.selectS,k.curViewPort.selectE)):console.log("action currently not allowed")},a.cmdPlayAll=function(){k.getPermission("playaudio")?(n.playFromTo(0,n.wavJSO.Data.length),k.animatePlayHead(0,n.wavJSO.Data.length)):console.log("action currently not allowed")},a.changePerspective=function(a){for(var b,c=0;c<o.vals.perspectives.length;c++)a.name===o.vals.perspectives[c].name&&(b=c);k.curPerspectiveIdx=b,k.setRightsubmenuOpen(!k.getRightsubmenuOpen())},a.getPerspectiveColor=function(a){var b;return b=-1===k.curPerspectiveIdx||a.name===o.vals.perspectives[k.curPerspectiveIdx].name?"emuwebapp-curSelPerspLi":"emuwebapp-perspLi"}}]),angular.module("emuwebApp").controller("FileCtrl",["$scope","Binarydatamaniphelper","Textgridparserservice","ConfigProviderService","Validationservice",function(a,b,c,d,e){a.newfiles=[],a.wav={},a.grid={},a.curBndl={},a.resetToInitState=function(){a.newfiles=[],a.wav={},a.grid={},a.curBndl={},a.dropText=a.dropDefault},a.$on("resetToInitState",function(){a.resetToInitState()}),a.handleLocalFiles=function(){a.$parent.vs.showDropZone=!1,a.$parent.cps.vals.main.comMode="FileAPI",a.$parent.vs.setState("loadingSaving"),a.$parent.hists.resetToInitState(),a.$parent.vs.somethingInProgress=!0,a.$parent.vs.somethingInProgressTxt="Loading local File: "+a.wav.name,a.$parent.ssffds.data=[],a.$parent.levServ.data={},a.$parent.vs.somethingInProgressTxt="Parsing WAV file...";var b=new FileReader;b.readAsArrayBuffer(a.wav),b.onloadend=function(b){b.target.readyState==FileReader.DONE&&a.$parent.io.httpGetPath("configFiles/standalone_emuwebappConfig.json").then(function(f){a.$parent.vs.curPerspectiveIdx=0,a.$parent.cps.setVals(f.data.EMUwebAppConfig),delete f.data.EMUwebAppConfig;var g=e.validateJSO("emuwebappConfigSchema",d.vals);if(g===!0){a.$parent.cps.curDbConfig=f.data,a.curBndl={},a.curBndl.name=a.wav.name.substr(0,a.wav.name.lastIndexOf(".")),a.$parent.bundleList.push(a.curBndl),a.$parent.curBndl=a.curBndl;var h;h=a.firefox?b.target.result:b.currentTarget.result,a.$parent.wps.parseWavArrBuf(h).then(function(b){if(a.$parent.vs.curViewPort.sS=0,a.$parent.vs.curViewPort.eS=b.Data.length,a.$parent.vs.resetSelect(),a.$parent.vs.curPerspectiveIdx=0,a.$parent.shs.wavJSO=b,$.isEmptyObject(a.grid))a.$parent.vs.setState("labeling"),a.$parent.vs.somethingInProgress=!1,a.$parent.vs.somethingInProgressTxt="Done!";else{var e=new FileReader;e.readAsText(a.grid),e.onloadend=function(b){if(b.target.readyState==FileReader.DONE){var e=a.wav.name.substr(0,a.wav.name.lastIndexOf("."));c.asyncParseTextGrid(b.currentTarget.result,a.wav.name,e).then(function(b){var c=b.data;a.$parent.levServ.setData(c);var e=[],f=[];c.levels.forEach(function(a){e.push(a.name),f.push({name:a.name,type:a.type,attributeDefinitions:{name:a.name,type:"string"}})}),a.$parent.cps.curDbConfig.levelDefinitions=f,a.$parent.vs.setCurLevelAttrDefs(d.curDbConfig.levelDefinitions),a.$parent.cps.vals.perspectives[a.$parent.vs.curPerspectiveIdx].levelCanvases.order=e,a.$parent.vs.somethingInProgressTxt="Done!",a.$parent.vs.somethingInProgress=!1,a.$parent.vs.setState("labeling")})}},function(b){a.$parent.dials.open("views/error.html","ModalCtrl","Error parsing textgrid file: "+b.status.message)}}})}else a.$parent.dials.open("views/error.html","ModalCtrl","Error validating ConfigProviderService.vals (emuwebappConfig data) : "+JSON.stringify(g,null,4))},function(b){a.$parent.dials.open("views/error.html","ModalCtrl","Error parsing wav file: "+b.status.message)})}},a.traverseFileTreeChrome=function(b,c){if(c=c||"",b.isFile)b.file(function(b){var c=b.name.substr(b.name.lastIndexOf(".")+1).toUpperCase();"WAV"===c?(a.wav=b,a.handleLocalFiles()):"TEXTGRID"===c?a.grid=b:(a.other=b,a.$parent.dials.open("views/error.html","ModalCtrl","Error: Unknown File Type for File "+a.other.name).then(function(){a.resetToInitState(),a.$parent.resetToInitState()}))});else if(b.isDirectory){var d=b.createReader();d.readEntries(function(d){for(var e=0;e<d.length;e++)a.traverseFileTreeChrome(d[e],c+b.name+"/")})}},a.traverseFileTreeFirefox=function(b,c){if(c=c||"",b.size>0){var d=b.name.substr(b.name.lastIndexOf(".")+1).toUpperCase();"WAV"===d?(a.wav=b,a.handleLocalFiles()):"TEXTGRID"===d?a.grid=b:(a.other=b,a.$parent.dials.open("views/error.html","ModalCtrl","Error: Unknown File Type for File "+a.other.name).then(function(){a.resetToInitState(),a.$parent.resetToInitState()}))}else if(b.isDirectory){var e=b.createReader();e.readEntries(function(d){for(var e=0;e<d.length;e++)a.traverseFileTreeFirefox(d[e],c+b.name+"/")})}}}]),angular.module("emuwebApp").directive("level",["$animate","viewState","ConfigProviderService","Drawhelperservice","HistoryService","fontScaleService","dialogService","LevelService",function(a,b,c,d,e,f,g,h){return{templateUrl:"views/level.html",restrict:"E",scope:{level:"=",idx:"="},link:function(i,j,k){function l(a,b,c){var d=c.vals.font.fontPxSize,e=b.getCurAttrDef(i.level.name);if($.isEmptyObject(a))return void console.log("undef levelDetails");if($.isEmptyObject(b))return void console.log("undef viewState");if($.isEmptyObject(c))return void console.log("undef config");i.open||(d-=1);var g=n[0].getContext("2d");g.clearRect(0,0,n[0].width,n[0].height);var h,j,k,l;h=b.getSampleDist(n[0].width);var m=g.canvas.height/g.canvas.offsetHeight;l=a.name===e?f.getTextImageTwoLines(g,a.name,"("+a.type+")",d,c.vals.font.fontType,c.vals.colors.labelColor,!0):f.getTextImageTwoLines(g,a.name+":"+e,"("+a.type+")",d,c.vals.font.fontType,c.vals.colors.labelColor,!0),g.drawImage(l,0,g.canvas.height/2-d*m);var o=(b.getcurMouseSegment(),b.getcurClickSegments(),b.getcurClickLevelName(),-1),p=(f.getTextImage(g,"m",d-2,c.vals.font.fontType,c.vals.colors.labelColor),f.getLastImageWidth()),q=(f.getTextImage(g,"0",d-4,c.vals.font.fontType,c.vals.colors.endBoundaryColor),f.getLastImageWidth());if("SEGMENT"===a.type){g.fillStyle=c.vals.colors.startBoundaryColor;var r=a.items;r.forEach(function(a){if(++o,a.sampleStart>=b.curViewPort.sS&&a.sampleStart<=b.curViewPort.eS||a.sampleStart+a.sampleDur>b.curViewPort.sS&&a.sampleStart+a.sampleDur<b.curViewPort.eS||a.sampleStart<b.curViewPort.sS&&a.sampleStart+a.sampleDur>b.curViewPort.eS){var h;if(a.labels.forEach(function(a){a.name===e&&(h=a.value)}),j=b.getPos(n[0].width,a.sampleStart),k=b.getPos(n[0].width,a.sampleStart+a.sampleDur+1),g.fillStyle=c.vals.colors.startBoundaryColor,g.fillRect(j,0,2,n[0].height/2),g.fillStyle=c.vals.colors.endBoundaryColor,g.fillRect(k,n[0].height/2,2,n[0].height),void 0!==h&&k-j>p*h.length){l=f.getTextImage(g,h,d-2,c.vals.font.fontType,c.vals.colors.labelColor);var m=f.getLastImageWidth(),r=j+(k-j)/2-m/2;i.open?g.drawImage(l,0,0,l.width,l.height,r,n[0].height/2-(d-2),l.width,l.height):g.drawImage(l,0,0,l.width,l.height,r,0,l.width,l.height)}if(i.open){var s=j+(k-j)/2,t=n[0].height/4;g.strokeStyle=c.vals.colors.startBoundaryColor,g.beginPath(),g.moveTo(j,t),g.lineTo(s,t),g.lineTo(s,t+5),g.stroke(),t=n[0].height/4*3,g.strokeStyle=c.vals.colors.endBoundaryColor,g.beginPath(),g.moveTo(k,t),g.lineTo(s,t),g.lineTo(s,t-5),g.stroke()}if(k-j>q*a.sampleStart.toString().length){var u=f.getTextImage(g,a.sampleStart,d-4,c.vals.font.fontType,c.vals.colors.endBoundaryColor);g.drawImage(u,0,0,l.width,l.height,j+3,0,l.width,l.height)}if(k-j>q*(5+a.sampleDur.toString().length)){var v=f.getTextImage(g,"dur: "+a.sampleDur,d-4,c.vals.font.fontType,c.vals.colors.endBoundaryColor),w=f.getLastImageWidth();g.drawImage(v,0,0,l.width,l.height,k-w,n[0].height/4*3,l.width,l.height)}}})}else if("EVENT"===a.type){g.fillStyle=c.vals.colors.startBoundaryColor;var s;a.items.forEach(function(a){if(a.samplePoint>b.curViewPort.sS&&a.samplePoint<b.curViewPort.eS){s=Math.round(b.getPos(n[0].width,a.samplePoint)+h/2);var i;a.labels.forEach(function(a){a.name===e&&(i=a.value)}),g.fillStyle=c.vals.colors.startBoundaryColor,g.fillRect(s,0,1,n[0].height/2-n[0].height/10),g.fillRect(s,n[0].height/2+n[0].height/10,1,n[0].height/2-n[0].height/10),l=f.getTextImage(g,i,d-2,c.vals.font.fontType,c.vals.colors.labelColor),g.drawImage(l,0,0,l.width,l.height,s-5,n[0].height/3,l.width,l.height),l=f.getTextImage(g,a.samplePoint,d-4,c.vals.font.fontType,c.vals.colors.endBoundaryColor),g.drawImage(l,0,0,l.width,l.height,s+5,0,l.width,l.height)}})}}function m(a,b,c){var e=n[1].getContext("2d");e.clearRect(0,0,n[1].width,n[1].height),a.name===b.getcurClickLevelName()&&(e.fillStyle=c.vals.colors.selectedLevelColor,e.fillRect(0,0,n[0].width,n[0].height)),d.drawMovingBoundaryLine(e),d.drawCurViewPortSelected(e);var f,g,h,i,j;f=b.getPos(n[1].width,b.curViewPort.selectS),g=b.getPos(n[1].width,b.curViewPort.selectE),h=b.getSampleDist(n[1].width);var k=b.getcurMouseSegment(),l=b.getcurMouseisFirst(),m=b.getcurMouseisLast(),o=b.getcurClickSegments(),p=b.getcurClickLevelName();void 0!==o&&a.name===p&&o.length>0&&o.forEach(function(a){void 0!==a&&(void 0!==a.sampleStart?(f=Math.round(b.getPos(n[0].width,a.sampleStart)),g=Math.round(b.getPos(n[0].width,a.sampleStart+a.sampleDur+1))):(f=Math.round(b.getPos(n[0].width,a.samplePoint)+h/2),f-=5,g=f+10),e.fillStyle=c.vals.colors.selectedSegmentColor,e.fillRect(f,0,g-f,n[0].height),e.fillStyle=c.vals.colors.startBoundaryColor)}),j=b.getcurMouseSegment(),void 0!==j&&void 0!==k&&a.name===b.getcurMouseLevelName()&&(e.fillStyle=c.vals.colors.selectedBoundaryColor,l===!0?"SEGMENT"===b.getcurMouseLevelType()&&(j=a.items[0],f=Math.round(b.getPos(n[1].width,j.sampleStart)),e.fillRect(f,0,3,n[1].height)):m===!0?"SEGMENT"===b.getcurMouseLevelType()&&(j=a.items[a.items.length-1],f=Math.round(b.getPos(n[1].width,j.sampleStart+j.sampleDur+1)),e.fillRect(f,0,3,n[1].height)):"SEGMENT"===b.getcurMouseLevelType()?(f=Math.round(b.getPos(n[1].width,j.sampleStart)),e.fillRect(f,0,3,n[1].height)):(f=Math.round(b.getPos(n[1].width,j.samplePoint)),i=h/2,e.fillRect(f+i,0,3,n[1].height)),e.fillStyle=c.vals.colors.startBoundaryColor)}var n=j.find("canvas");i.open=k.open,i.vs=b,i.hists=e,i.cps=c,i.dials=g;var o=j.find("div");i.levelDef=c.getLevelDefinition(i.level.name),i.backgroundCanvas={background:c.vals.colors.levelColor},i.$on("refreshTimeline",function(){l(i.level,b,c),m(i.level,b,c)}),i.$watch("vs.curViewPort",function(a,d){d.sS!==a.sS||d.eS!==a.eS||d.windowWidth!==a.windowWidth?(l(i.level,b,c),m(i.level,b,c)):m(i.level,b,c)},!0),i.$watch("vs.curMouseX",function(){b.getcurMouseLevelName()===i.level.name&&(l(i.level,b,c),m(i.level,b,c))},!0),i.$watch("vs.curClickLevelName",function(a){void 0!==a&&m(i.level,b,c)},!0),i.$watch("vs.movingBoundarySample",function(){l(i.level,b,c),m(i.level,b,c)},!0),i.$watch("vs.movingBoundary",function(){m(i.level,b,c)},!0),i.$watch("hists.movesAwayFromLastSave",function(){l(i.level,b,c),m(i.level,b,c)},!0),i.changeCurAttrDef=function(c,d){var e=b.getCurAttrDef(i.level.name);e!==c&&(b.setCurAttrDef(i.level.name,c,d),j.hasClass("emuwebapp-levelCanvasContainer-animate")||(b.focusInTextField=!1,h.deleteEditArea(),a.addClass(o,"emuwebapp-levelCanvasContainer-animate",i.finishedAnim)))},i.finishedAnim=function(){a.removeClass(o,"emuwebapp-levelCanvasContainer-animate"),l(i.level,b,c),m(i.level,b,c)},i.getAttrDefBtnColor=function(a){var c,d=b.getCurAttrDef(i.level.name);return c=a===d?{background:"-webkit-radial-gradient(50% 50%, closest-corner, rgba(0, 0, 0, 1), rgba(0, 0, 0, 0) 60%)"}:{"background-color":"white"}},i.updateView=function(){return $.isEmptyObject(i.cps)?void console.log("undef viewState"):void l(i.level,i.vs,i.cps)},j.bind("mouseleave",function(){b.setcurMouseSegment(void 0,void 0,void 0),m(i.level,b,c)})}}}]),angular.module("emuwebApp").directive("osci",["$timeout","viewState","Soundhandlerservice","ConfigProviderService","Drawhelperservice",function(a,b,c,d,e){return{templateUrl:"views/osci.html",replace:!0,restrict:"E",scope:{},controller:["$scope",function(a){a.changeAttrDef=function(){alert("sadf")}}],link:function(f,g,h){function i(a,c){var e=m.getContext("2d");e.clearRect(0,0,l.width,l.height);var f=b.getPos(m.width,b.playHeadAnimationInfos.sS),g=b.getPos(m.width,b.playHeadAnimationInfos.curS);e.fillStyle=d.vals.colors.selectedAreaColor,e.fillRect(f,0,g-f,l.height),j(a,c,!1)}function j(a,b,c){var d=m.getContext("2d");c&&d.clearRect(0,0,m.width,m.height),e.drawMovingBoundaryLine(d),e.drawViewPortTimes(d,!0),e.drawCurViewPortSelected(d,!0)}var k=g.find("canvas").length,l=g.find("canvas")[0],m=g.find("canvas")[k-1];f.order=h.order,f.trackName=h.trackName,f.cps=d,f.viewState=b,f.$on("refreshTimeline",function(){$.isEmptyObject(c)||$.isEmptyObject(c.wavJSO)||j(f,d,!0)}),f.$watch("viewState.timelineSize",function(){a(f.redraw,10)}),f.$watch("viewState.curPerspectiveIdx",function(){j(f,d,!0)},!0),f.$watch("viewState.playHeadAnimationInfos",function(){$.isEmptyObject(c)||$.isEmptyObject(c.wavJSO)||i(f,d)},!0),f.$watch("viewState.movingBoundarySample",function(){$.isEmptyObject(c)||$.isEmptyObject(c.wavJSO)||j(f,d,!0)
},!0),f.$watch("viewState.movingBoundary",function(){$.isEmptyObject(c)||$.isEmptyObject(c.wavJSO)||j(f,d,!0)},!0),f.$watch("viewState.curViewPort",function(a,g){if(!$.isEmptyObject(c)&&!$.isEmptyObject(c.wavJSO)){if(g.sS!==a.sS||g.eS!==a.eS){var h=e.calculatePeaks(b,l,c.wavJSO.Data);e.osciPeaks=h,e.freshRedrawDrawOsciOnCanvas(b,l,e.osciPeaks,c.wavJSO.Data,d)}j(f,d,!0)}},!0),f.redraw=function(){j(f,d,!0)}}}}]),angular.module("emuwebApp").directive("preview",["viewState","Soundhandlerservice","Drawhelperservice","ConfigProviderService",function(a,b,c,d){return{templateUrl:"views/preview.html",restrict:"E",scope:{currentBundleName:"@"},link:function(e,f){function g(){if(k)h(a,i,d);else{var e=c.calculatePeaks(a,i,b.wavJSO.Data);c.osciPeaks=e,c.freshRedrawDrawOsciOnCanvas(a,i,c.osciPeaks,b.wavJSO.Data,d),k=!0,h(a,i,d)}}function h(a,c,d){var e=j.getContext("2d"),f=j.width/b.wavJSO.Data.length*a.curViewPort.sS,g=j.width/b.wavJSO.Data.length*a.curViewPort.eS;e.clearRect(0,0,j.width,j.height),e.fillStyle=d.vals.colors.selectedAreaColor,e.fillRect(f,0,g-f,j.height),e.strokeStyle=d.vals.colors.selectedBorderColor,e.beginPath(),e.moveTo(f,0),e.lineTo(f,j.height),e.moveTo(g,0),e.lineTo(g,j.height),e.closePath(),e.stroke()}var i=f.find("canvas")[0],j=f.find("canvas")[1],k=!1;e.vs=a,e.shs=b,e.backgroundCanvas={background:"#eee",border:"1px solid gray",width:"100%",height:"100%"},e.$watch("vs.curViewPort",function(a,c){$.isEmptyObject(b.wavJSO)||(c.sS!==a.sS||c.eS!==a.eS)&&g()},!0),e.$watch("currentBundleName",function(){if($.isEmptyObject(b.wavJSO)||(k=!1,e.backgroundCanvas={background:d.vals.colors.levelColor,border:"1px solid gray",width:"100%",height:"100%"},g()),""===e.currentBundleName){var a=i.getContext("2d"),c=j.getContext("2d");a.clearRect(0,0,i.width,i.height),c.clearRect(0,0,i.width,i.height)}},!0)}}}]),angular.module("emuwebApp").directive("bundleListSideBar",["$animate","viewState",function(a){return{templateUrl:"views/bundleListSideBar.html",restrict:"E",replace:!0,link:function(b,c){b.$watch("vs.submenuOpen",function(){b.vs.submenuOpen?(a.removeClass(c,"emuwebapp-shrinkWidthTo0px"),a.addClass(c,"emuwebapp-expandWidthTo240px")):a.addClass(c,"emuwebapp-shrinkWidthTo0px")},!0)}}}]),angular.module("emuwebApp").directive("spectro",["$timeout","fontScaleService",function(a,b){return{templateUrl:"views/spectro.html",restrict:"E",replace:!0,link:function(c,d,e){function f(){r=(c.vs.curViewPort.eS+1-c.vs.curViewPort.sS)/m.width}function g(a){a&&q.clearRect(0,0,n.width,n.height),c.dhs.drawMovingBoundaryLine(q),c.dhs.drawCurViewPortSelected(q,!1),c.dhs.drawMinMaxAndName(q,"",c.vs.spectroSettings.rangeFrom,c.vs.spectroSettings.rangeTo,2)}function h(){p.fillStyle=c.cps.vals.colors.levelColor,p.fillRect(0,0,m.width,m.height),c.dhs.drawCurViewPortSelected(q,!1);var a=b.getTextImage(p,"rendering...",.75*c.cps.vals.font.fontPxSize,c.cps.vals.font.fontType,c.cps.vals.colors.labelColor,!0);p.drawImage(a,10,50),null!==u&&(u.terminate(),u=null)}function i(){f();var a=p.createImageData(m.width,m.height);u.addEventListener("message",function(b){if(r===b.data.myStep){var c=new Uint8ClampedArray(b.data.img);a.data.set(c),p.putImageData(a,0,0),g()}})}function j(a){h(),k(a)}function k(a){f(),u=new Worker(t);var b;b=new Float32Array(c.vs.curViewPort.sS>=c.vs.spectroSettings.windowLength/2?a.subarray(c.vs.curViewPort.sS-c.vs.spectroSettings.windowLength/2,c.vs.curViewPort.eS+c.vs.spectroSettings.windowLength):a.subarray(c.vs.curViewPort.sS,c.vs.curViewPort.eS+c.vs.spectroSettings.windowLength)),i(),u.postMessage({N:c.vs.spectroSettings.windowLength,alpha:o,freq:c.vs.spectroSettings.rangeTo,freqLow:c.vs.spectroSettings.rangeFrom,start:c.vs.curViewPort.sS,end:c.vs.curViewPort.eS,myStep:r,window:c.vs.spectroSettings.window,width:m.width,height:m.height,dynRangeInDB:c.vs.spectroSettings.dynamicRange,pixelRatio:s,sampleRate:c.shs.wavJSO.SampleRate,streamChannels:c.shs.wavJSO.NumChannels,transparency:c.cps.vals.spectrogramSettings.transparency,stream:b.buffer,drawHeatMapColors:c.vs.spectroSettings.drawHeatMapColors,preEmphasisFilterFactor:c.vs.spectroSettings.preEmphasisFilterFactor,heatMapColorAnchors:c.vs.spectroSettings.heatMapColorAnchors},[b.buffer])}c.order=e.order;var l=d.find("canvas").length,m=d.find("canvas")[0],n=d.find("canvas")[l-1],o=.16,p=m.getContext("2d"),q=n.getContext("2d"),r=0;window.URL=window.URL||window.webkitURL;var s=window.devicePixelRatio||1,t="scripts/workers/spectroWorker.js",u=new Worker(t);c.$watch("vs.timelineSize",function(){$.isEmptyObject(c.shs)||$.isEmptyObject(c.shs.wavJSO)||a(c.redraw,5)}),c.$watch("vs.curViewPort",function(a,b){$.isEmptyObject(c.shs)||$.isEmptyObject(c.shs.wavJSO)||((b.sS!==a.sS||b.eS!==a.eS)&&c.redraw(),g(!0))},!0),c.$watch("vs.movingBoundarySample",function(){$.isEmptyObject(c.shs)||$.isEmptyObject(c.shs.wavJSO)||(q.clearRect(0,0,n.width,n.height),g())},!0),c.$watch("vs.movingBoundary",function(){$.isEmptyObject(c.shs)||$.isEmptyObject(c.shs.wavJSO)||g(!0)},!0),c.$watch("vs.spectroSettings",function(){$.isEmptyObject(c.shs)||$.isEmptyObject(c.shs.wavJSO)||(i(),c.redraw())},!0),c.redraw=function(){f(),q.clearRect(0,0,n.width,n.height),j(c.shs.wavJSO.Data)}}}}]),angular.module("emuwebApp").controller("ExportCtrl",["$scope","dialogService","exportData","exportName","viewState","HistoryService",function(a,b,c,d,e,f){a.exportData=c,a.exportName=d,a.firefox=navigator.userAgent.match(/Firefox/i)?!0:!1,a.cancel=function(){b.close()},a.getBlob=function(){return new Blob([a.exportData],{type:"text/plain"})},a.export=function(){a.SaveToDisk(URL.createObjectURL(a.getBlob()),a.exportName),b.close()},a.updateHistoryService=function(){f.movesAwayFromLastSave=0},a.cursorInTextField=function(){e.focusInTextField=!0},a.cursorOutOfTextField=function(){e.focusInTextField=!1},a.SaveToDisk=function(b,c){var d=document.createElement("a");if(a.firefox)d.setAttribute("download",c),d.href=b,d.innerHTML="",d.style.display="none",document.body.appendChild(d),d.click();else{d.href=b,d.target="_blank",d.download=c||"unknown";var e=document.createEvent("Event");e.initEvent("click",!0,!0),d.dispatchEvent(e),(window.URL||window.webkitURL).revokeObjectURL(d.href)}a.updateHistoryService()}}]),angular.module("emuwebApp").factory("viewState",["$rootScope","$timeout","$window","Soundhandlerservice",function(a,b,c,d){var e={},f={BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10},g=[];return e.initialize=function(){e.curViewPort={sS:0,eS:0,selectS:-1,selectE:-1,dragBarActive:!1,dragBarHeight:-1,windowWidth:void 0},e.spectroSettings={windowLength:-1,rangeFrom:-1,rangeTo:-1,dynamicRange:-1,window:-1,drawHeatMapColors:-1,preEmphasisFilterFactor:-1},e.playHeadAnimationInfos={sS:-1,eS:-1,curS:null,endFreezeSample:-1},e.timelineSize=-1,e.somethingInProgress=!1,e.somethingInProgressTxt="",e.curClickSegments=[],e.editing=!1,e.submenuOpen=!1,e.rightSubmenuOpen=!1,e.curMousePosSample=0,e.curMouseLevelName=void 0,e.curMouseLevelType=void 0,e.curClickLevelName=void 0,e.curClickLevelType=void 0,e.curPreselColumnSample=2,e.curCorrectionToolNr=void 0,e.curClickLevelIndex=void 0,e.start=null,e.TransitionTime=void 0,e.showDropZone=!0,e.movingBoundary=!1,e.movingBoundarySample=void 0,e.focusInTextField=!1,e.curTaskPercCompl=0,e.curPerspectiveIdx=-1,e.mouseInEmuWebApp=!1,e.states=[],e.states.noDBorFilesloaded={permittedActions:["connectBtnClick","openDemoBtnDBclick"]},e.states.loadingSaving={permittedActions:[]},e.states.labeling={permittedActions:["zoom","playaudio","spectSettingsChange","addLevelSegBtnClick","addLevelPointBtnClick","renameSelLevelBtnClick","downloadTextGridBtnClick","spectSettingsChange","clearBtnClick","labelAction","toggleSideBars","saveBndlBtnClick"]},e.states.modalShowing=e.states.loadingSaving,e.prevState=e.states.noDBorFilesloaded,e.curState=e.states.noDBorFilesloaded,g=[]},e.initialize(),e.getPermission=function(a){return e.curState.permittedActions.indexOf(a)>-1},e.setWindowWidth=function(a){this.curViewPort.windowWidth=a},e.setState=function(a){e.prevState=e.curState,e.curState="string"==typeof a?e.states[a]:a},e.updatePlayHead=function(b){d.player.isPlaying&&c.requestAnimationFrame(e.updatePlayHead),null===e.start&&(e.start=b);var f=Math.floor(b-e.start)/1e3*d.wavJSO.SampleRate;e.playHeadAnimationInfos.curS=Math.floor(e.playHeadAnimationInfos.sS+f),d.player.isPlaying&&e.playHeadAnimationInfos.curS<=e.playHeadAnimationInfos.eS?(-1!==e.playHeadAnimationInfos.curS&&(e.curMousePosSample=e.playHeadAnimationInfos.curS),a.$apply()):(e.curMousePosSample=e.playHeadAnimationInfos.endFreezeSample,e.playHeadAnimationInfos.sS=-1,e.playHeadAnimationInfos.eS=-1,e.playHeadAnimationInfos.curS=0,e.start=null)},e.animatePlayHead=function(a,b){e.playHeadAnimationInfos.sS=a,e.playHeadAnimationInfos.eS=b,e.playHeadAnimationInfos.endFreezeSample=b,e.playHeadAnimationInfos.curS=a,c.requestAnimationFrame(e.updatePlayHead)},e.select=function(a,b){e.curViewPort.selectS=a,e.curViewPort.selectE=b},e.resetSelect=function(){e.curViewPort.selectS=-1,e.curViewPort.selectE=-1},e.getViewPort=function(){return e.curViewPort},e.setspectroSettings=function(a,b,c,d,f,g,h,i){e.spectroSettings.windowLength=parseInt(a,10),e.spectroSettings.rangeFrom=parseInt(b,10),e.spectroSettings.rangeTo=parseInt(c,10),e.spectroSettings.dynamicRange=parseInt(d,10),e.setWindowFunction(f),e.spectroSettings.drawHeatMapColors=g,e.spectroSettings.preEmphasisFilterFactor=h,e.spectroSettings.heatMapColorAnchors=i},e.getSelect=function(){return[e.curViewPort.selectS,e.curViewPort.selectE]},e.selectDependent=function(a,b){a<this.curViewPort.selectS&&(this.curViewPort.selectS=a),b>this.curViewPort.selectE&&(this.curViewPort.selectE=b)},e.selectLevel=function(a,b,c){var d,f=e.getcurClickLevelName();if(void 0===f&&!a)return d=c.getLevelDetails(b[0]),void e.setcurClickLevel(d.level.name,d.level.type,0);if(void 0===f&&a)return d=c.getLevelDetails(b[b.length-1]),void e.setcurClickLevel(d.level.name,d.level.type,b.length-1);var g;b.forEach(function(a,b){a===f&&(g=b)}),a?g+1<b.length&&(d=c.getLevelDetails(b[g+1]),e.setcurClickLevel(d.level.name,d.level.type,b.idxOfNow+1),e.curClickSegments=[],e.selectBoundary()):g-1>=0&&(d=c.getLevelDetails(b[g-1]),e.setcurClickLevel(d.level.name,d.level.type,b.idxOfNow-1),e.curClickSegments=[],e.selectBoundary())},e.setWindowFunction=function(a){switch(a){case"BARTLETT":e.spectroSettings.window=f.BARTLETT;break;case"BARTLETTHANN":e.spectroSettings.window=f.BARTLETTHANN;break;case"BLACKMAN":e.spectroSettings.window=f.BLACKMAN;break;case"COSINE":e.spectroSettings.window=f.COSINE;break;case"GAUSS":e.spectroSettings.window=f.GAUSS;break;case"HAMMING":e.spectroSettings.window=f.HAMMING;break;case"HANN":e.spectroSettings.window=f.HANN;break;case"LANCZOS":e.spectroSettings.window=f.LANCZOS;break;case"RECTANGULAR":e.spectroSettings.window=f.RECTANGULAR;break;case"TRIANGULAR":e.spectroSettings.window=f.TRIANGULAR;break;default:e.spectroSettings.window=f.BARTLETTHANN}},e.getWindowFunctions=function(){return f},e.getdragBarActive=function(){return this.curViewPort.dragBarActive},e.setdragBarActive=function(a){this.curViewPort.dragBarActive=a},e.getdragBarHeight=function(){return this.curViewPort.dragBarHeight},e.setdragBarHeight=function(a){this.curViewPort.dragBarHeight=a},e.getPos=function(a,b){return a*(b-this.curViewPort.sS)/(this.curViewPort.eS-this.curViewPort.sS+1)},e.getSampleDist=function(a){return this.getPos(a,this.curViewPort.sS+1)-this.getPos(a,this.curViewPort.sS)},e.togglesubmenuOpen=function(c){this.submenuOpen=!this.submenuOpen,b(function(){a.$broadcast("refreshTimeline")},c,!1)},e.getsubmenuOpen=function(){return this.submenuOpen},e.setsubmenuOpen=function(a){this.submenuOpen=a},e.setenlarge=function(a){this.timelineSize=a},e.getenlarge=function(){return this.timelineSize},e.getTransitionTime=function(){return this.TransitionTime},e.setTransitionTime=function(a){this.TransitionTime=a},e.getRightsubmenuOpen=function(){return this.rightSubmenuOpen},e.setRightsubmenuOpen=function(a){this.rightSubmenuOpen=a},e.setcurClickLevel=function(a,b,c){this.setcurClickLevelName(a,c),this.setcurClickLevelType(b)},e.setcurClickLevelType=function(a){this.curClickLevelType=a},e.getcurClickLevelType=function(){return this.curClickLevelType},e.setcurClickLevelName=function(a,b){this.curClickLevelName=a,this.curClickLevelIndex=b},e.getcurClickLevelName=function(){return this.curClickLevelName},e.getcurClickLevelIndex=function(){return this.curClickLevelIndex},e.getcurClickNeighbours=function(){return this.curClickNeighbours},e.setcurMouseLevelName=function(a){this.curMouseLevelName=a},e.getcurMouseLevelName=function(){return this.curMouseLevelName},e.setcurMouseLevelType=function(a){this.curMouseLevelType=a},e.getcurMouseLevelType=function(){return this.curMouseLevelType},e.setcurMouseSegment=function(a,b,c,d,e){this.curMouseSegment=a,this.curMouseX=c,this.curMouseNeighbours=b,this.curMouseisFirst=d,this.curMouseisLast=e},e.getcurMouseSegment=function(){return this.curMouseSegment},e.getcurMouseisFirst=function(){return this.curMouseisFirst},e.getcurMouseisLast=function(){return this.curMouseisLast},e.getcurMouseNeighbours=function(){return this.curMouseNeighbours},e.selectSegmentsInSelection=function(a){e.curClickSegments=[];var b=1/0,c=-1/0,d=this.getItemsInSelection(a);angular.forEach(d,function(a){a.sampleStart<b&&(b=a.sampleStart),a.sampleStart+a.sampleDur+1>c&&(c=a.sampleStart+a.sampleDur+1),e.setcurClickSegmentMultiple(a)}),e.curViewPort.selectS=b,e.curViewPort.selectE=c},e.getItemsInSelection=function(a){var b=[],c=e.curViewPort.selectS,d=e.curViewPort.selectE;return angular.forEach(a,function(a){a.name===e.getcurClickLevelName()&&angular.forEach(a.items,function(a){a.sampleStart>=c&&a.sampleStart+a.sampleDur<=d&&b.push(a),a.samplePoint>=c&&a.samplePoint<=d&&b.push(a)})}),b},e.setcurClickSegment=function(a){null!==a&&void 0!==a?(e.curClickSegments=[],e.curClickSegments.push(a),e.selectBoundary()):e.curClickSegments=[]},e.selectBoundary=function(){if(e.curClickSegments.length>0){var a,b;a=void 0!==e.curClickSegments[0].sampleStart?e.curClickSegments[0].sampleStart:e.curClickSegments[0].samplePoint,b=e.curClickSegments[e.curClickSegments.length-1].sampleStart+e.curClickSegments[e.curClickSegments.length-1].sampleDur||e.curClickSegments[0].samplePoint,e.curClickSegments.forEach(function(c){c.sampleStart<=a&&(a=c.sampleStart),c.sampleStart+c.sampleDur>=b&&(b=c.sampleStart+c.sampleDur)}),e.select(a,b+1)}},e.setcurClickSegmentMultiple=function(a){var b=!0,c=a.sampleStart,d=c+a.sampleDur+1;e.curClickSegments.forEach(function(f){var g=f.sampleStart===d?!0:!1,h=f.sampleStart+f.sampleDur+1===c?!0:!1;(g||h)&&-1===e.curClickSegments.indexOf(a)&&(e.curClickSegments.push(a),b=!1)}),b?(e.curClickSegments=[],e.curClickSegments.push(a)):e.curClickSegments.sort(e.sortbyid)},e.sortbyid=function(a,b){return a.sampleStart>b.sampleStart?1:a.sampleStart<b.sampleStart?-1:0},e.getselectedRange=function(){return this.curClickSegments.length>1?{start:this.curClickSegments[0].sampleStart,end:this.curClickSegments[this.curClickSegments.length-1].sampleStart+this.curClickSegments[this.curClickSegments.length-1].sampleDur}:1===this.curClickSegments.length?void 0!==this.curClickSegments[0].sampleStart?{start:this.curClickSegments[0].sampleStart,end:this.curClickSegments[0].sampleStart+this.curClickSegments[0].sampleDur}:{start:this.curClickSegments[0].samplePoint,end:this.curClickSegments[0].samplePoint}:{start:-1,end:-1}},e.getcurClickSegments=function(){return this.curClickSegments},e.getfirstClickSegment=function(){return e.curClickSegments.length>0?e.curClickSegments[0]:void 0},e.getselected=function(){return this.curClickSegments},e.isEditing=function(){return this.editing},e.setEditing=function(a){this.editing=a},e.countSelected=function(){return this.curClickSegments.length},e.getCurrentSample=function(a){return this.curViewPort.sS+(this.curViewPort.eS-this.curViewPort.sS)*a},e.getCurrentPercent=function(a){return a*(100/(this.curViewPort.eS-this.curViewPort.sS)/100)},e.getSamplesPerPixelVal=function(a){var b=parseFloat(this.curViewPort.sS),c=parseFloat(this.curViewPort.eS);return(c-b)/a.originalEvent.target.width},e.round=function(a,b){(1>b||b>14)&&console.error("error in call of round function!!");var c=Math.pow(10,b),d=(Math.round(a*c)/c).toString();return-1===d.indexOf(".")&&(d+="."),d+=c.toString().substring(1),parseFloat(d.substring(0,d.indexOf(".")+b+1))},e.getViewPortStartTime=function(){return 1*this.curViewPort.sS/d.wavJSO.SampleRate-.5/d.wavJSO.SampleRate},e.getViewPortEndTime=function(){return 1*this.curViewPort.eS/d.wavJSO.SampleRate+.5/d.wavJSO.SampleRate},e.getSelectedStartTime=function(){return 1*this.curViewPort.selectS/d.wavJSO.SampleRate-.5/d.wavJSO.SampleRate},e.getSelectedEndTime=function(){return 1*this.curViewPort.selectE/d.wavJSO.SampleRate+.5/d.wavJSO.SampleRate},e.setViewPort=function(a,b){var c=this.curViewPort.sS,e=this.curViewPort.eS;void 0!==a&&(this.curViewPort.sS=Math.round(a)),void 0!==b&&(this.curViewPort.eS=Math.round(b)),c>this.curViewPort.sS&&e>this.curViewPort.eS&&this.curViewPort.sS<0&&(this.curViewPort.sS=0,this.curViewPort.eS=e+Math.abs(this.curViewPort.sS)),c<this.curViewPort.sS&&e<this.curViewPort.eS&&this.curViewPort.eS>d.wavJSO.Data.length&&(this.curViewPort.sS=c,this.curViewPort.eS=d.wavJSO.Data.length),this.curViewPort.sS<0&&(this.curViewPort.sS=0),this.curViewPort.eS>d.wavJSO.Data.length&&(this.curViewPort.eS=d.wavJSO.Data.length),this.curViewPort.eS-this.curViewPort.sS<4&&(this.curViewPort.sS=c,this.curViewPort.eS=e)},e.zoomViewPort=function(a,b){var c,d,f,g=this.getcurMouseSegment(),h=this.curViewPort.eS-this.curViewPort.sS,i=!1;if(void 0!==g){this.getcurMouseisFirst()?g=b.getItemDetails(e.getcurMouseLevelName(),0):this.getcurMouseisLast()&&(g=b.getLastItem(e.getcurMouseLevelName()),i=!0),f="SEGMENT"===this.getcurMouseLevelType()?i?g.sampleStart+g.sampleDur:g.sampleStart:g.samplePoint;var j=f-this.curViewPort.sS,k=this.curViewPort.eS-f;a?(c=this.curViewPort.sS+.5*j,d=this.curViewPort.eS-.5*k):(c=this.curViewPort.sS-.5*j,d=this.curViewPort.eS+.5*k)}else a?(c=this.curViewPort.sS+~~(h/4),d=this.curViewPort.eS-~~(h/4)):(c=this.curViewPort.sS-~~(h/4),d=this.curViewPort.eS+~~(h/4));this.setViewPort(c,d)},e.shiftViewPort=function(a){var b,c;a?(b=this.curViewPort.sS+~~((this.curViewPort.eS-this.curViewPort.sS)/4),c=this.curViewPort.eS+~~((this.curViewPort.eS-this.curViewPort.sS)/4)):(b=this.curViewPort.sS-~~((this.curViewPort.eS-this.curViewPort.sS)/4),c=this.curViewPort.eS-~~((this.curViewPort.eS-this.curViewPort.sS)/4)),this.setViewPort(b,c)},e.setCurLevelAttrDefs=function(a){angular.forEach(a,function(a){g.push({levelName:a.name,curAttrDefName:a.name})})},e.setCurAttrDef=function(a,b,c){angular.forEach(g,function(d){d.levelName===a&&(d.curAttrDefName=b,d.curAttrDefIndex=c)})},e.getCurAttrDef=function(a){var b;return angular.forEach(g,function(c){c.levelName===a&&(b=c.curAttrDefName)}),b},e.getCurAttrIndex=function(a){var b;return angular.forEach(g,function(c){c.levelName===a&&(b=void 0===c.curAttrDefIndex?0:c.curAttrDefIndex)}),b},e.getX=function(a){return(a.offsetX||a.originalEvent.layerX)*(a.originalEvent.target.width/a.originalEvent.target.clientWidth)},e.getY=function(a){return(a.offsetY||a.originalEvent.layerY)*(a.originalEvent.target.height/a.originalEvent.target.clientHeight)},e.resetToInitState=function(){e.initialize()},e}]),angular.module("emuwebApp").directive("trackmouseinlevel",["viewState","LevelService","ConfigProviderService","HistoryService","Soundhandlerservice",function(a,b,c,d,e){return{restrict:"A",scope:{level:"="},link:function(f,g){function h(c){p=a.getX(c)*a.getSamplesPerPixelVal(c),b.deleteEditArea(),a.setEditing(!1),a.focusInTextField=!1,l=b.getClosestItem(p+a.curViewPort.sS,f.this.level.name,e.wavJSO.Data.length),void 0!==l.current&&void 0!==l.nearest&&(b.setlasteditArea("_"+l.current.id),b.setlasteditAreaElem(g.parent()),a.setcurClickLevel(q,r,f.$index),a.setcurClickSegment(l.current)),o=p,f.$apply()}function i(c){a.getcurClickLevelName()!==q&&h(c),p=a.getX(c)*a.getSamplesPerPixelVal(c),b.deleteEditArea(),l=b.getClosestItem(p+a.curViewPort.sS,f.this.level.name,e.wavJSO.Data.length),void 0!==l.current&&void 0!==l.nearest&&(a.setcurClickLevel(q,r,f.$index),a.setcurClickSegmentMultiple(l.current),a.selectBoundary()),o=p,f.$apply()}function j(c){p=a.getX(c)*a.getSamplesPerPixelVal(c),l=b.getClosestItem(p+a.curViewPort.sS,f.this.level.name,e.wavJSO.Data.length),void 0!==l.current&&void 0!==l.nearest&&("SEGMENT"===r?l.current.sampleStart>=a.curViewPort.sS?l.current.sampleStart+l.current.sampleDur<=a.curViewPort.eS?(a.setcurClickLevel(q,r,f.$index),a.setcurClickSegment(l.current),b.setlasteditArea("_"+l.current.id),b.setlasteditAreaElem(g.parent()),a.setEditing(!0),b.openEditArea(l.current,g.parent(),r),a.focusInTextField=!0):console.log("Editing out of right bound !"):console.log("Editing out of left bound !"):(a.setcurClickLevel(q,r,f.$index),a.setcurClickSegment(l.current),b.setlasteditArea("_"+l.current.id),b.setlasteditAreaElem(g.parent()),a.setEditing(!0),b.openEditArea(l.current,g.parent(),r),a.focusInTextField=!0)),o=p,f.$apply()}function k(c,d){p=a.getX(c)*a.getSamplesPerPixelVal(c),m=b.getClosestItem(p+a.curViewPort.sS,f.this.level.name,e.wavJSO.Data.length),d&&void 0!==m.current&&void 0!==m.nearest&&(n=b.getItemNeighboursFromLevel(f.this.level.name,m.nearest.id,m.nearest.id),a.setcurMouseSegment(m.nearest,n,o,m.isFirst,m.isLast)),a.setcurMouseLevelName(q),a.setcurMouseLevelType(r),o=p,f.$apply()}var l,m,n,o,p,q=f.level.name,r=f.level.type;g.bind("click",function(a){a.preventDefault(),k(a,!0),h(a)}),g.bind("contextmenu",function(a){a.preventDefault(),k(a,!0),i(a)}),g.bind("dblclick",function(a){k(a,!0),c.vals.restrictions.editItemName?j(a):h(a)}),g.bind("mousemove",function(g){if(!a.getdragBarActive()){var h=!0,i=a.getSamplesPerPixelVal(g);p=a.getX(g)*i;var j=p-o;if(1>=i&&f.this.level.items.length>0){var l=b.getClosestItem(p+a.curViewPort.sS,f.this.level.name,e.wavJSO.Data.length);if("SEGMENT"===f.this.level.type)if(l.isFirst===!0&&l.isLast===!1)j=Math.ceil(p+a.curViewPort.sS-b.getItemDetails(f.this.level.name,0).sampleStart);else if(l.isFirst===!1&&l.isLast===!0){var m=b.getLastItem(f.this.level.name);j=Math.ceil(p+a.curViewPort.sS-m.sampleStart-m.sampleDur)}else j=Math.ceil(p+a.curViewPort.sS-b.getItemFromLevelById(f.this.level.name,l.nearest.id).sampleStart);else j=Math.ceil(p+a.curViewPort.sS-b.getItemFromLevelById(f.this.level.name,l.nearest.id).samplePoint-.5)}else j=Math.round(p-o)}var n=0;switch(n=void 0===g.buttons?g.which:g.buttons){case 1:break;case 2:break;case 3:break;default:if(!a.getdragBarActive())if(c.vals.restrictions.editItemSize&&g.shiftKey){if(b.deleteEditArea(),void 0!==a.getcurMouseSegment()){if(a.movingBoundary=!0,"SEGMENT"===f.this.level.type){if(a.getcurMouseisFirst()||a.getcurMouseisLast()){var q;a.getcurMouseisFirst()?(q=b.getItemDetails(f.this.level.name,0),a.movingBoundarySample=q.sampleStart+j):a.getcurMouseisLast()&&(q=b.getLastItem(f.this.level.name),a.movingBoundarySample=q.sampleStart+q.sampleDur+j)}else a.movingBoundarySample=a.getcurMouseSegment().sampleStart+j,q=a.getcurMouseSegment();b.moveBoundary(f.this.level.name,q.id,j,a.getcurMouseisFirst(),a.getcurMouseisLast()),d.updateCurChangeObj({type:"ESPS",action:"MOVEBOUNDARY",name:f.this.level.name,id:q.id,movedBy:j,isFirst:a.getcurMouseisFirst(),isLast:a.getcurMouseisLast()})}else q=a.getcurMouseSegment(),a.movingBoundarySample=a.getcurMouseSegment().samplePoint+j,b.movePoint(f.this.level.name,q.id,j),d.updateCurChangeObj({type:"ESPS",action:"MOVEPOINT",name:f.this.level.name,id:q.id,movedBy:j});o=p,a.selectBoundary(),h=!1}}else c.vals.restrictions.editItemSize&&g.altKey?(b.deleteEditArea(),"SEGMENT"==f.this.level.type&&(q=a.getcurClickSegments(),b.moveSegment(f.this.level.name,q[0].id,q.length,j),d.updateCurChangeObj({type:"ESPS",action:"MOVESEGMENT",name:f.this.level.name,id:q[0].id,length:q.length,movedBy:j}),o=p,a.selectBoundary())):a.movingBoundary=!1}a.getdragBarActive()||k(g,h)}),g.bind("mousedown",function(b){a.movingBoundary=!0,k(b,!0)}),g.bind("mouseup",function(b){a.movingBoundary=!1,k(b,!0)}),g.bind("mouseout",function(b){a.movingBoundary=!1,k(b,!0)})}}}]),angular.module("emuwebApp").directive("handleglobalkeystrokes",["$timeout","viewState","Soundhandlerservice","ConfigProviderService","HistoryService","LevelService","AnagestService",function(a,b,c,d,e,f,g){return{restrict:"A",link:function(a){function h(h,i){a.$apply(function(){if(!d.vals.main.catchMouseForKeyBinding||b.mouseInEmuWebApp)if(b.focusInTextField){if(h===d.vals.keyMappings.createNewItemAtSelection&&b.isEditing()){var j=f.getItemFromLevelById(b.getcurClickLevelName(),f.getlastID()),k=b.getCurAttrIndex(b.getcurClickLevelName());e.addObjToUndoStack({type:"ESPS",action:"RENAMELABEL",name:b.getcurClickLevelName(),id:f.getlastID(),attrIndex:k,oldValue:j.labels[k].value,newValue:$("."+f.getlasteditArea()).val()}),f.renameLabel(b.getcurClickLevelName(),f.getlastID(),b.getCurAttrIndex(b.getcurClickLevelName()),$("."+f.getlasteditArea()).val()),f.deleteEditArea(),b.focusInTextField=!1}h===d.vals.keyMappings.esc&&(f.deleteEditArea(),b.focusInTextField=!1),13===h&&(i.preventDefault(),i.stopPropagation()),b.setcurClickSegment(f.getItemFromLevelById(b.getcurClickLevelName(),f.getlastID()))}else{if(f.deleteEditArea(),h===d.vals.keyMappings.zoomAll&&b.getPermission("zoom")&&b.setViewPort(0,c.wavJSO.Data.length),h===d.vals.keyMappings.zoomIn&&b.getPermission("zoom")&&b.zoomViewPort(!0,f),h===d.vals.keyMappings.zoomOut&&b.getPermission("zoom")&&b.zoomViewPort(!1,f),h===d.vals.keyMappings.shiftViewPortLeft&&b.getPermission("zoom")&&b.shiftViewPort(!1),h===d.vals.keyMappings.shiftViewPortRight&&b.getPermission("zoom")&&b.shiftViewPort(!0),h===d.vals.keyMappings.zoomSel&&b.getPermission("zoom")&&b.setViewPort(b.curViewPort.selectS,b.curViewPort.selectE),h===d.vals.keyMappings.playEntireFile&&b.getPermission("playaudio")&&d.vals.restrictions.playback&&(c.playFromTo(0,c.wavJSO.Data.length),b.animatePlayHead(0,c.wavJSO.Data.length)),h===d.vals.keyMappings.playAllInView&&b.getPermission("playaudio")&&d.vals.restrictions.playback&&(c.playFromTo(b.curViewPort.sS,b.curViewPort.eS),b.animatePlayHead(b.curViewPort.sS,b.curViewPort.eS)),h===d.vals.keyMappings.playSelected&&b.getPermission("playaudio")&&d.vals.restrictions.playback&&(c.playFromTo(b.curViewPort.selectS,b.curViewPort.selectE),b.animatePlayHead(b.curViewPort.selectS,b.curViewPort.selectE)),h===d.vals.keyMappings.selectFirstContourCorrectionTool&&b.getPermission("labelAction")&&d.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=1),h===d.vals.keyMappings.selectSecondContourCorrectionTool&&b.getPermission("labelAction")&&d.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=2),h===d.vals.keyMappings.selectThirdContourCorrectionTool&&b.getPermission("labelAction")&&d.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=3),h===d.vals.keyMappings.selectFourthContourCorrectionTool&&b.getPermission("labelAction")&&d.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=4),h===d.vals.keyMappings.selectNoContourCorrectionTool&&b.getPermission("labelAction")&&d.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=void 0),h===d.vals.keyMappings.levelUp&&b.getPermission("labelAction")&&b.selectLevel(!1,d.vals.perspectives[b.curPerspectiveIdx].levelCanvases.order,f),h===d.vals.keyMappings.levelDown&&b.getPermission("labelAction")&&b.selectLevel(!0,d.vals.perspectives[b.curPerspectiveIdx].levelCanvases.order,f),h===d.vals.keyMappings.snapBoundaryToNearestTopBoundary&&b.getPermission("labelAction")&&d.vals.restrictions.editItemSize){var l=b.getcurMouseSegment(),m=b.getcurMouseLevelName(),n=b.getcurMouseLevelType(),o=b.getcurMouseNeighbours(),p=f.snapBoundary(!0,m,l,o,n);p===!1||("EVENT"===n?e.updateCurChangeObj({type:"ESPS",action:"MOVEPOINT",name:m,id:l.id,movedBy:p}):"SEGMENT"===n&&e.updateCurChangeObj({type:"ESPS",action:"MOVEBOUNDARY",name:m,id:l.id,movedBy:p,position:0}),e.addCurChangeObjToUndoStack())}if(h===d.vals.keyMappings.snapBoundaryToNearestBottomBoundary&&b.getPermission("labelAction")&&d.vals.restrictions.editItemSize){var l=b.getcurMouseSegment(),m=b.getcurMouseLevelName(),n=b.getcurMouseLevelType(),o=b.getcurMouseNeighbours(),p=f.snapBoundary(!1,m,l,o,n);0==p||("EVENT"===n?e.updateCurChangeObj({type:"ESPS",action:"MOVEPOINT",name:m,id:l.id,movedBy:p}):"SEGMENT"===n&&e.updateCurChangeObj({type:"ESPS",action:"MOVEBOUNDARY",name:m,id:l.id,movedBy:p,position:0}),e.addCurChangeObjToUndoStack())}if(h===d.vals.keyMappings.snapBoundaryToNearestZeroCrossing&&b.getPermission("labelAction")&&d.vals.restrictions.editItemSize){var q;if(q=f.calcDistanceToNearestZeroCrossing("SEGMENT"===b.getcurMouseLevelType()?b.getcurMouseSegment().sampleStart:b.getcurMouseSegment().samplePoint),0!==q){var r=b.getcurMouseSegment(),s=(b.getcurMouseNeighbours(),b.getcurMouseLevelName());f.moveBoundary(s,r.id,q,0),e.updateCurChangeObj({type:"ESPS",action:"MOVEBOUNDARY",name:s,id:r.id,movedBy:q,position:0}),e.addCurChangeObjToUndoStack()}}if(h===d.vals.keyMappings.expandSelSegmentsRight&&b.getPermission("labelAction")&&d.vals.restrictions.editItemSize)if(void 0===b.getcurClickLevelName())a.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select a Level first");else if(0===b.getselected().length)a.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select one or more Segments first");else{var t=parseInt(d.vals.labelCanvasConfig.addTimeValue,10);"relative"===d.vals.labelCanvasConfig.addTimeMode&&(t=d.vals.labelCanvasConfig.addTimeValue*(c.wavJSO.Data.length/100)),f.expandSegment(!0,b.getcurClickSegments(),b.getcurClickLevelName(),t),e.addObjToUndoStack({type:"ESPS",action:"EXPANDSEGMENTS",levelName:b.getcurClickLevelName(),item:b.getcurClickSegments(),rightSide:!0,changeTime:t}),b.selectBoundary()}if(h===d.vals.keyMappings.expandSelSegmentsLeft&&b.getPermission("labelAction")&&d.vals.restrictions.editItemSize)if(void 0===b.getcurClickLevelName())a.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select a Level first");else if(0===b.getselected().length)a.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select one or more Segments first");else{if("absolute"===d.vals.labelCanvasConfig.addTimeMode)var t=parseInt(d.vals.labelCanvasConfig.addTimeValue,10);else if("relative"===d.vals.labelCanvasConfig.addTimeMode)var t=d.vals.labelCanvasConfig.addTimeValue*(c.wavJSO.Data.length/100);else a.dials.open("views/error.html","ModalCtrl","Expand Segements Error: Error in Configuration (Value labelCanvasConfig.addTimeMode)");f.expandSegment(!1,b.getcurClickSegments(),b.getcurClickLevelName(),t),e.addObjToUndoStack({type:"ESPS",action:"EXPANDSEGMENTS",levelName:b.getcurClickLevelName(),item:b.getcurClickSegments(),rightSide:!1,changeTime:t}),b.selectBoundary()}if(h===d.vals.keyMappings.shrinkSelSegmentsLeft&&b.getPermission("labelAction")&&d.vals.restrictions.editItemSize)if(void 0===b.getcurClickLevelName())a.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select a Level first");else if(0===b.getselected().length)a.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select one or more Segments first");else{if("absolute"===d.vals.labelCanvasConfig.addTimeMode)var t=parseInt(d.vals.labelCanvasConfig.addTimeValue,10);else if("relative"===d.vals.labelCanvasConfig.addTimeMode)var t=d.vals.labelCanvasConfig.addTimeValue*(c.wavJSO.Data.length/100);else a.dials.open("views/error.html","ModalCtrl","Expand Segements Error: Error in Configuration (Value labelCanvasConfig.addTimeMode)");f.expandSegment(!0,b.getcurClickSegments(),b.getcurClickLevelName(),-t),e.addObjToUndoStack({type:"ESPS",action:"EXPANDSEGMENTS",levelName:b.getcurClickLevelName(),item:b.getcurClickSegments(),rightSide:!0,changeTime:-t}),b.selectBoundary()}if(h===d.vals.keyMappings.shrinkSelSegmentsRight&&b.getPermission("labelAction")&&d.vals.restrictions.editItemSize)if(void 0===b.getcurClickLevelName())a.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select a Level first");
else if(0===b.getselected().length)a.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select one or more Segments first");else{if("absolute"===d.vals.labelCanvasConfig.addTimeMode)var t=parseInt(d.vals.labelCanvasConfig.addTimeValue,10);else if("relative"===d.vals.labelCanvasConfig.addTimeMode)var t=d.vals.labelCanvasConfig.addTimeValue*(c.wavJSO.Data.length/100);else a.dials.open("views/error.html","ModalCtrl","Expand Segements Error: Error in Configuration (Value labelCanvasConfig.addTimeMode)");f.expandSegment(!1,b.getcurClickSegments(),b.getcurClickLevelName(),-t),e.addObjToUndoStack({type:"ESPS",action:"EXPANDSEGMENTS",levelName:b.getcurClickLevelName(),item:b.getcurClickSegments(),rightSide:!1,changeTime:-t}),b.selectBoundary()}if(h===d.vals.keyMappings.toggleSideBarLeft&&b.getPermission("toggleSideBars")&&d.vals.activeButtons.openMenu&&b.togglesubmenuOpen(d.vals.colors.transitionTime),h===d.vals.keyMappings.toggleSideBarRight&&b.getPermission("toggleSideBars")&&d.vals.activeButtons.openMenu&&b.setRightsubmenuOpen(!b.getRightsubmenuOpen()),h===d.vals.keyMappings.selectSegmentsInSelection&&b.getPermission("labelAction")&&(void 0===b.getcurClickLevelName()?a.dials.open("views/error.html","ModalCtrl","Selection Error : Please select a Level first"):b.selectSegmentsInSelection(f.data.levels)),h===d.vals.keyMappings.selPrevItem&&b.getPermission("labelAction")&&b.getcurClickSegments().length>0){var u=b.getcurClickSegments()[0].id,v=b.getcurClickSegments()[b.getcurClickSegments().length-1].id,w=f.getItemNeighboursFromLevel(b.getcurClickLevelName(),u,v);void 0!==w.left&&(void 0!==w.left.sampleStart?w.left.sampleStart>b.curViewPort.sS&&(i.shiftKey?(b.setcurClickSegmentMultiple(w.left),f.setlasteditArea("_"+w.left.id),b.selectBoundary()):(b.setcurClickSegment(w.left),f.setlasteditArea("_"+w.left.id))):w.left.samplePoint>b.curViewPort.sS&&(i.shiftKey?(b.setcurClickSegmentMultiple(w.left),f.setlasteditArea("_"+w.left.id),b.selectBoundary()):(b.setcurClickSegment(w.left),f.setlasteditArea("_"+w.left.id))))}if(h===d.vals.keyMappings.selNextItem&&b.getPermission("labelAction")&&b.getcurClickSegments().length>0){var u=b.getcurClickSegments()[0].id,v=b.getcurClickSegments()[b.getcurClickSegments().length-1].id,w=f.getItemNeighboursFromLevel(b.getcurClickLevelName(),u,v);void 0!==w.right&&w.right.sampleStart+w.right.sampleDur<b.curViewPort.eS&&(i.shiftKey?(b.setcurClickSegmentMultiple(w.right),f.setlasteditArea("_"+w.right.id),b.selectBoundary()):(b.setcurClickSegment(w.right),f.setlasteditArea("_"+w.right.id)))}if(h===d.vals.keyMappings.selNextPrevItem&&b.getPermission("labelAction")&&b.getcurClickSegments().length>0){var u=b.getcurClickSegments()[0].id,v=b.getcurClickSegments()[b.getcurClickSegments().length-1].id,w=f.getItemNeighboursFromLevel(b.getcurClickLevelName(),u,v);i.shiftKey?void 0!==w.left&&(void 0!==w.left.sampleStart?w.left.sampleStart+w.left.sampleDur>b.curViewPort.sS&&(b.setcurClickSegment(w.left,w.left.id),f.setlasteditArea("_"+w.left.id)):w.left.samplePoint>b.curViewPort.sS&&(b.setcurClickSegment(w.left,w.left.id),f.setlasteditArea("_"+w.left.id))):void 0!==w.right&&(void 0!==w.right.sampleStart?w.right.sampleStart<b.curViewPort.eS&&(b.setcurClickSegment(w.right,w.right.id),f.setlasteditArea("_"+w.right.id)):w.right.samplePoint<b.curViewPort.eS&&(b.setcurClickSegment(w.right,w.right.id),f.setlasteditArea("_"+w.right.id)))}if(h===d.vals.keyMappings.createNewItemAtSelection&&b.getPermission("labelAction")&&d.vals.restrictions.addItem)if(b.getselectedRange().start===b.curViewPort.selectS&&b.getselectedRange().end===b.curViewPort.selectE)1===b.getcurClickSegments().length?b.getselectedRange().start>=b.curViewPort.sS&&b.getselectedRange().end<=b.curViewPort.eS&&(b.setEditing(!0),f.openEditArea(b.getcurClickSegments()[0],f.getlasteditAreaElem(),b.getcurClickLevelType()),a.cursorInTextField()):a.dials.open("views/error.html","ModalCtrl","Modify Error: Please select a single Segment.");else if(-1==b.curViewPort.selectE&&-1==b.curViewPort.selectS)a.dials.open("views/error.html","ModalCtrl","Error : Please select a Segment or Point to modify it's name. Or select a level plus a range in the viewport in order to insert a new Segment.");else if("SEGMENT"===b.getcurClickLevelType()){var r=f.getClosestItem(b.curViewPort.selectS,b.getcurClickLevelName(),c.wavJSO.Data.length).current;if(r.sampleStart===b.curViewPort.selectS&&r.sampleStart+r.sampleDur+1===b.curViewPort.selectE)b.setcurClickLevel(b.getcurClickLevelName(),b.getcurClickLevelType(),a.$index),b.setcurClickSegment(r.current),f.setlasteditArea("_"+r.id),b.setEditing(!0),f.openEditArea(r,f.getlasteditAreaElem(),b.getcurClickLevelType()),b.focusInTextField=!0;else{var x=f.insertSegment(b.getcurClickLevelName(),b.curViewPort.selectS,b.curViewPort.selectE,d.vals.labelCanvasConfig.newSegmentName);x.ret?e.addObjToUndoStack({type:"ESPS",action:"INSERTSEGMENTS",name:b.getcurClickLevelName(),start:b.curViewPort.selectS,end:b.curViewPort.selectE,ids:x.ids,segName:d.vals.labelCanvasConfig.newSegmentName}):a.dials.open("views/error.html","ModalCtrl","Error : You are not allowed to insert a Segment here.")}}else{var y=d.getLevelDefinition(b.getcurClickLevelName());if("undefined"==typeof y.anagestConfig){var z=f.insertPoint(b.getcurClickLevelName(),b.curViewPort.selectS,d.vals.labelCanvasConfig.newEventName);z.alreadyExists?a.dials.open("views/error.html","ModalCtrl","Error: You are not allowed to insert a Point here."):e.addObjToUndoStack({type:"ESPS",action:"INSERTPOINT",name:b.getcurClickLevelName(),start:b.curViewPort.selectS,id:z.id,pointName:d.vals.labelCanvasConfig.newEventName})}else g.insertAnagestEvents()}if(h===d.vals.keyMappings.undo&&b.getPermission("labelAction")&&e.undo(),h===d.vals.keyMappings.redo&&b.getPermission("labelAction")&&e.redo(),h===d.vals.keyMappings.deletePreselBoundary&&b.getPermission("labelAction"))if(i.shiftKey){if(d.vals.restrictions.deleteItem){var r=b.getcurClickSegments();if(void 0!==r&&r.length>0){var s=b.getcurClickLevelName();if("SEGMENT"===b.getcurClickLevelType()){var A=f.deleteSegments(s,r[0].id,r.length);e.addObjToUndoStack({type:"ESPS",action:"DELETESEGMENTS",name:s,id:r[0].id,length:r.length,deletedSegment:A}),b.setcurMouseSegment(void 0,void 0,void 0),b.setcurClickSegment(A.clickSeg)}else a.dials.open("views/error.html","ModalCtrl","Delete Error: You can not delete Segments on Point Levels.")}}}else if(d.vals.restrictions.deleteItemBoundary){var r=b.getcurMouseSegment(),B=b.getcurMouseisFirst(),C=b.getcurMouseisLast(),s=b.getcurMouseLevelName(),D=b.getcurMouseLevelType();if(void 0!==r)if("SEGMENT"===D){var A=f.deleteBoundary(s,r.id,B,C);e.addObjToUndoStack({type:"ESPS",action:"DELETEBOUNDARY",name:s,id:r.id,isFirst:B,isLast:C,deletedSegment:A}),b.setcurMouseSegment(void 0,void 0,void 0),b.setcurClickSegment(A.clickSeg)}else{var E=f.deletePoint(s,r.id);e.addObjToUndoStack({type:"ESPS",action:"DELETEPOINT",name:s,start:E.samplePoint,id:E.id,pointName:E.labels[0].value}),b.setcurMouseSegment(void 0,void 0,void 0)}}i.metaKey||i.ctrlKey||(i.preventDefault(),i.stopPropagation())}})}$(document).bind("keydown",function(b){if(!a.firefox){var c=b.keyCode?b.keyCode:b.which;(8==c||9==c||27==c||37==c||38==c||39==c||40==c||32==c)&&h(c,b)}}),$(document).bind("keypress",function(a){var b=a.keyCode?a.keyCode:a.which;h(b,a)}),a.safeApply=function(a){var b=this.$root.$$phase;"$apply"==b||"$digest"==b?a&&"function"==typeof a&&a():this.$apply(a)},a.$on("$destroy",function(){$(window).off("keydown")})}}}]),angular.module("emuwebApp").directive("delete",function(){return{restrict:"A",link:function(a,b,c){var d=a.this.level.name;b.bind("click",function(){a.vs.setcurClickLevelName(d,c.delete),a.dials.open("views/deleteLevel.html","ModalCtrl",d)})}}}),angular.module("emuwebApp").directive("resize",function(){return{restrict:"A",link:function(a,b){var c=b.parent().parent(),d=0,e=c.find(b.parent().children()[0]),f=(c.find(b.parent().children()[1]),c.find(b.parent().children()[2]));b.bind("click",function(){a.open?(a.open=!1,d=c.css("height"),c.css({height:"30px"}),a.cps.vals.activeButtons.deleteSingleLevel&&e.hide(),a.cps.vals.activeButtons.saveSingleLevel&&f.hide()):(a.open=!0,c.css({height:d}),a.cps.vals.activeButtons.deleteSingleLevel&&e.show(),a.cps.vals.activeButtons.saveSingleLevel&&f.show()),a.updateView()})}}}),angular.module("emuwebApp").directive("enlarge",["$rootScope","viewState","ConfigProviderService",function(a,b,c){return{restrict:"A",link:function(d,e,f){d.$watch("viewState.curPerspectiveIdx",function(){$.isEmptyObject(c.vals.perspectives)||$.isEmptyObject(b.curPerspectiveIdx)||(console.log(b.curPerspectiveIdx),1===c.vals.perspectives[b.curPerspectiveIdx].signalCanvases.order.length?e.hide():e.show())},!0);var g=!1;e.bind("click",function(){g?(g=!1,b.setenlarge(-1)):(g=!0,b.setenlarge(f.enlarge)),a.$apply()})}}}]),angular.module("emuwebApp").directive("save",["dialogService","Espsparserservice",function(a,b){return{restrict:"A",link:function(c,d,e){var f=c.this.level.name;d.bind("click",function(){c.vs.setcurClickLevelName(f,e.save),b.asyncParseJSO(f).then(function(b){a.openExport("views/export.html","ExportCtrl",b.data,f+"_esps.txt")})})}}}]),angular.module("emuwebApp").directive("previewtrack",["viewState","Soundhandlerservice",function(a,b){return{restrict:"A",scope:{},link:function(c,d){var e=-1;d.bind("click",function(d){if(!$.isEmptyObject(b.wavJSO)){var f=a.curViewPort.eS-a.curViewPort.sS;e=a.getX(d)*(b.wavJSO.Data.length/d.originalEvent.target.width),a.focusInTextField||c.$apply(function(){a.setViewPort(e-f/2,e+f/2)})}}),d.bind("mousedown",function(c){$.isEmptyObject(b.wavJSO)||(e=a.getX(c)*(b.wavJSO.Data.length/c.originalEvent.target.width))}),d.bind("mousemove",function(d){var f=0;switch(f=void 0===d.buttons?d.which:d.buttons){case 1:if(-1!==e){var g=a.curViewPort.eS-a.curViewPort.sS;e=a.getX(d)*(b.wavJSO.Data.length/d.originalEvent.target.width),a.focusInTextField||c.$apply(function(){a.setViewPort(e-g/2,e+g/2)})}}}),d.bind("mouseup",function(){e=-1}),d.bind("mouseout",function(){e=-1})}}}]),angular.module("emuwebApp").service("Iohandlerservice",["$rootScope","$http","$location","$q","HistoryService","viewState","Soundhandlerservice","Ssffparserservice","Wavparserservice","Textgridparserservice","ConfigProviderService","Espsparserservice","Ssffdataservice","Websockethandler",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o={};return o.wsH=n,o.httpGetDefaultConfig=function(){var a=b.get("configFiles/default_emuwebappConfig.json");return a},o.httpGetPath=function(a,c){var d=b.get(a,{responseType:c});return d},o.getProtocol=function(){var a;return"CORS"===k.vals.main.comMode?alert("CORS version of getProtocol not implemented"):"WS"===k.vals.main.comMode&&(a=n.getProtocol()),a},o.getDoUserManagement=function(){var a;return"CORS"===k.vals.main.comMode?alert("CORS version of getDoUserManagement not implemented"):"WS"===k.vals.main.comMode&&(a=n.getDoUserManagement()),a},o.logOnUser=function(a,b){var c;return"CORS"===k.vals.main.comMode?alert("CORS version of logOnUser not implemented"):"WS"===k.vals.main.comMode&&(c=n.logOnUser(a,b)),c},o.getDBconfigFile=function(a){var c;return"CORS"===k.vals.main.comMode?alert("CORS version of getDBconfigFile not implemented"):"WS"===k.vals.main.comMode?c=n.getDBconfigFile():"DEMO"===k.vals.main.comMode&&(c=b.get("demoDBs/"+a+"/"+a+"_DBconfig.json")),c},o.getBundleList=function(a){var c;return"CORS"===k.vals.main.comMode?alert("CORS version of getBundleList not implemented"):"WS"===k.vals.main.comMode?c=n.getBundleList():"DEMO"===k.vals.main.comMode&&(c=b.get("demoDBs/"+a+"/"+a+"_bundleList.json")),c},o.getBundle=function(a,c){var d;return"CORS"===k.vals.main.comMode?alert("CORS version of getBundle not implemented"):"WS"===k.vals.main.comMode?d=n.getBundle(a):"DEMO"===k.vals.main.comMode&&(d=b.get("demoDBs/"+c+"/"+a+"_bndl.json")),d},o.saveBundle=function(a){var b;return"CORS"===k.vals.main.comMode?alert("CORS version of saveBundle not implemented"):"WS"===k.vals.main.comMode&&(b=n.saveBundle(a)),b},o.parseLabelFile=function(a,b,c,d){var e;return"ESPS"===d?e=l.asyncParseEsps(a,k.embeddedVals.labelGetUrl,"embeddedESPS"):"TEXTGRID"===d&&(e=j.asyncParseTextGrid(a,k.embeddedVals.labelGetUrl,"embeddedTEXTGRID")),e},o}]),angular.module("emuwebApp").service("Soundhandlerservice",["$document","Binarydatamaniphelper",function(a,b){var c={};return c.wavJSO={},c.player=a[0].createElement("audio"),c.player.isPlaying=!1,c.setPlayerSrc=function(a){var c=b.arrayBufferToBase64(a);this.player.src="data:audio/wav;base64,"+c},c.resetPlayerSrcFromTo=function(a,c){var d=this.wavJSO.BitsPerSample/8,e=this.wavJSO.origArrBuf.subarray(0,44),f=this.wavJSO.origArrBuf.subarray(44,this.wavJSO.Data.length*d),g=new DataView(e);g.setUint32(40,(c-a)*d,!0);var h=f.subarray(a*d,(c-a)*d),i=new Uint8Array(e.byteLength+h.byteLength);i.set(new Uint8Array(e),0),i.set(new Uint8Array(h),e.byteLength);var j=b.arrayBufferToBase64(i.buffer);this.player.src="data:audio/wav;base64,"+j},c.playFromTo=function(a,b){this.resetPlayerSrcFromTo(a,b),this.player.isPlaying?(this.player.isPlaying=!1,this.player.pause()):(this.player.isPlaying=!0,this.player.play())},c.player.addEventListener("ended",function(){this.isPlaying=!1},!1),c}]),angular.module("emuwebApp").directive("drawssff",["viewState","ConfigProviderService","Ssffdataservice","HistoryService","fontScaleService",function(a,b,c,d,e){return{restrict:"A",scope:{},link:function(f,g,h){function i(){var d=l.getContext("2d");if(d.clearRect(0,0,l.width,l.height),$.isEmptyObject(c.data)){var d=l.getContext("2d");d.clearRect(0,0,l.width,l.height)}else if(0!==c.data.length&&(m="",b.vals.perspectives[a.curPerspectiveIdx].signalCanvases.assign.forEach(function(d){if(d.signalCanvasName===k){m=d.ssffTrackName;var e=b.getSsffTrackConfig(d.ssffTrackName),f=c.getColumnOfTrack(e.name,e.columnName),g=c.getSampleRateAndStartTimeOfTrack(e.name),h=b.getLimsOfTrack(e.name);j(a,l,b,f,g.sampleRate,g.startTime,h)}}),m="","OSCI"!==k&&"SPEC"!==k)){var e=b.getSsffTrackConfig(k),f=c.getColumnOfTrack(e.name,e.columnName),g=c.getSampleRateAndStartTimeOfTrack(e.name),h=b.getLimsOfTrack(e.name);j(a,l,b,f,g.sampleRate,g.startTime,h)}}function j(a,c,d,f,g,h,i){var j,l,n=c.getContext("2d");"SPEC"===k&&"FORMANTS"===m?(j=a.spectroSettings.rangeFrom,l=a.spectroSettings.rangeTo):(j=f._minVal,l=f._maxVal);var o=a.getViewPortStartTime(),p=a.getViewPortEndTime(),q=Math.round(o*g+h),r=Math.round(p*g+h),s=r-q,t=f.values.slice(q,q+s);if(s<c.width&&s>=2){var u,v,w,x;angular.forEach(t[0],function(d,e){if($.isEmptyObject(i)||e>=i.minContourIdx&&e<=i.maxContourIdx){if($.isEmptyObject(i))n.strokeStyle="hsl("+e*(360/t[0].length)+",80%, 50%)",n.fillStyle="hsl("+e*(360/t[0].length)+",80%, 50%)";else{var s=i.maxContourIdx-i.minContourIdx+1;n.strokeStyle="hsl("+e*(360/s)+",80%, 50%)",n.fillStyle="hsl("+e*(360/s)+",80%, 50%)"}var y=b.getContourColorsOfTrack(m);if(void 0!==y&&void 0!==y.colors[e]&&(n.strokeStyle=b.vals.perspectives[a.curPerspectiveIdx].signalCanvases.contourColors[0].colors[e],n.fillStyle=b.vals.perspectives[a.curPerspectiveIdx].signalCanvases.contourColors[0].colors[e]),a.curCorrectionToolNr-1===e&&"SPEC"===k&&"FORMANTS"===m&&(n.strokeStyle=b.vals.colors.selectedContourColor,n.fillStyle=b.vals.colors.selectedContourColor),n.beginPath(),q>=1){var z=f.values[q-1],A=z[e];w=q-1,x=1/g*w+h,u=(x-o)/(p-o)*c.width,v=c.height-(A-j)/(l-j)*c.height,n.moveTo(u,v)}if(angular.forEach(t,function(a,b){w=q+b,x=1/g*w+h,u=(x-o)/(p-o)*c.width,v=c.height-(a[e]-j)/(l-j)*c.height,n.arc(u,v-1,2,0,2*Math.PI,!1),n.lineTo(u,v)}),r<f.values.length-1){var B=f.values[r+1],C=B[e];w=r+1,x=1/g*w+h,u=(x-o)/(p-o)*c.width,v=c.height-(C-j)/(l-j)*c.height,n.lineTo(u,v)}n.stroke()}})}else{n.strokeStyle="red";var y,z;2>=s?(z=e.getTextImageTwoLines(n,"Zoom out to","see contour(s)",b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.crossHairsColor),n.drawImage(z,0,0,z.width,z.height,c.width/2-z.width/2,25,z.width,z.height)):(y="Zoom in to see contour(s)",z=e.getTextImageTwoLines(n,"Zoom in to","see contour(s)",b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.crossHairsColor),n.drawImage(z,0,0,z.width,z.height,c.width/2-z.width/2,25,z.width,z.height))}}var k,l=g[0],m="";Date.now(),f.vs=a,f.hists=d,f.ssffds=c,h.$observe("ssffTrackname",function(a){k=a}),f.$watch("vs.curViewPort",function(a,b){(b.sS!==a.sS||b.eS!==a.eS)&&i(a,b)},!0),f.$watch("vs.curPerspectiveIdx",function(a,b){i(a,b)},!0),f.$watch("vs.curCorrectionToolNr",function(a,b){i(a,b)},!0),f.$watch("hists.movesAwayFromLastSave",function(a,b){i(a,b)},!0),f.$watch("ssffds.data.length",function(a,b){i(a,b)},!0),f.$watch("vs.spectroSettings",function(a,b){i(a,b)},!0)}}}]),angular.module("emuwebApp").service("Ssffparserservice",["$q",function(a){var b,c={},d=new Worker("scripts/workers/ssffParserWorker.js");return d.addEventListener("message",function(a){"SUCCESS"===a.data.status.type?b.resolve(a.data):b.reject(a.data)},!1),c.asyncParseSsffArr=function(c){return b=a.defer(),d.postMessage({cmd:"parseArr",ssffArr:c}),b.promise},c.asyncJso2ssff=function(c){return b=a.defer(),d.postMessage({cmd:"jso2ssff",jso:JSON.stringify(c)}),b.promise},c}]),angular.module("emuwebApp").directive("mouseTrackAndCorrectionTool",["viewState","ConfigProviderService","Ssffdataservice","Drawhelperservice","HistoryService","Soundhandlerservice",function(a,b,c,d,e,f){return{restrict:"A",scope:{},link:function(g,h,i){function j(e,f){if(u.clearRect(0,0,t.width,t.height),"OSCI"==i.ssffTrackname)d.drawViewPortTimes(u,!0),d.drawCurViewPortSelected(u,!0);else if("SPEC"==i.ssffTrackname)d.drawCurViewPortSelected(u,!1),d.drawMinMaxAndName(u,"",a.spectroSettings.rangeFrom,a.spectroSettings.rangeTo,2);else{var g=b.getSsffTrackConfig(i.ssffTrackname),h=c.getColumnOfTrack(g.name,g.columnName);d.drawCurViewPortSelected(u,!1),d.drawMinMaxAndName(u,i.ssffTrackname,h._minVal,h._maxVal,2)}f!==!1&&b.vals.restrictions.drawCrossHairs&&d.drawCrossHairs(u,e,a.spectroSettings.rangeFrom,a.spectroSettings.rangeTo,"Hz",i.ssffTrackname),d.drawMovingBoundaryLine(u)}function k(b){l=Math.round(a.getX(b)*a.getSamplesPerPixelVal(b)+a.curViewPort.sS),l>m?(n=l,a.select(m,n)):(m=l,a.select(m,n)),g.$apply()}var l,m,n,o,p,q,r,s,t=h[0],u=t.getContext("2d");i.$observe("ssffTrackname",function(a){a&&(r=a)}),i.$observe("bundleName",function(a){a&&(s=a,$.isEmptyObject(c.data)||0!==c.data.length&&(o=b.getSsffTrackConfig("FORMANTS"),void 0!==o&&(p=c.getColumnOfTrack(o.name,o.columnName),q=c.getSampleRateAndStartTimeOfTrack(o.name))))}),h.bind("mousedown",function(b){m=Math.round(a.getX(b)*a.getSamplesPerPixelVal(b)+a.curViewPort.sS),n=m,a.select(m,m),j(b),g.$apply()}),h.bind("mousemove",function(d){var f=0;f=void 0===d.buttons?d.which:d.buttons;var i=a.getX(d);switch(a.curMousePosSample=Math.round(a.curViewPort.sS+i/h[0].width*(a.curViewPort.eS-a.curViewPort.sS)),f){case 0:if(a.getPermission("labelAction")&&(j(d),!($.isEmptyObject(c.data)||0===c.data.length||a.getdragBarActive()||void 0===a.curCorrectionToolNr||a.getdragBarActive()||$.isEmptyObject(b.getAssignment(r))))){void 0===o&&(o=b.getSsffTrackConfig("FORMANTS"),p=c.getColumnOfTrack(o.name,o.columnName),q=c.getSampleRateAndStartTimeOfTrack(o.name));var l=a.getViewPortStartTime(),m=a.getViewPortEndTime(),n=Math.round(l*q.sampleRate+q.startTime),s=Math.round(m*q.sampleRate+q.startTime),v=s-n,w=p.values.slice(n,n+v),x=l+a.getX(d)/d.originalEvent.target.width*(m-l),y=Math.round((x+q.startTime)*q.sampleRate)-1,z=1/q.sampleRate*y+q.startTime;if(0>y-n||y-n>=w.length)return void console.log("early return");a.curPreselColumnSample=y-n;var A=(z-l)/(m-l)*t.width,B=t.height-w[a.curPreselColumnSample][a.curCorrectionToolNr-1]/(a.spectroSettings.rangeTo-a.spectroSettings.rangeFrom)*t.height;if(u.strokeStyle="black",u.fillStyle="black",u.beginPath(),u.arc(A,B-1,2,0,2*Math.PI,!1),u.closePath(),u.stroke(),u.fill(),d.shiftKey){var C=angular.copy(w[a.curPreselColumnSample][a.curCorrectionToolNr-1]),D=a.spectroSettings.rangeTo-a.getY(d)/d.originalEvent.target.height*a.spectroSettings.rangeTo;w[a.curPreselColumnSample][a.curCorrectionToolNr-1]=a.spectroSettings.rangeTo-a.getY(d)/d.originalEvent.target.height*a.spectroSettings.rangeTo;var E=e.updateCurChangeObj({type:"SSFF",trackName:o.name,sampleBlockIdx:n+a.curPreselColumnSample,sampleIdx:a.curCorrectionToolNr-1,oldValue:C,newValue:D});for(var F in E)z=1/q.sampleRate*E[F].sampleBlockIdx+q.startTime,A=(z-l)/(m-l)*t.width,B=t.height-E[F].newValue/(a.spectroSettings.rangeTo-a.spectroSettings.rangeFrom)*t.height,u.strokeStyle="red",u.fillStyle="red",u.beginPath(),u.arc(A,B-1,2,0,2*Math.PI,!1),u.closePath(),u.stroke(),u.fill()}}break;case 1:a.getdragBarActive()||k(d)}g.$apply()}),h.bind("mouseup",function(b){a.getdragBarActive()||(k(b),j(b))}),h.bind("mouseleave",function(b){$.isEmptyObject(f)||$.isEmptyObject(f.wavJSO)||a.getdragBarActive()||a.getPermission("labelAction")&&j(b,!1)})}}}]),angular.module("emuwebApp").service("Drawhelperservice",["viewState","ConfigProviderService","Soundhandlerservice","fontScaleService","Ssffdataservice",function(a,b,c,d,e){function f(a,b,c){return a.measureText(b).width*c}function g(a,b,c,d){return b.toString().length>c.toString().length?f(a,b,d):f(a,c,d)}function h(a,b,c,d,e,f,g){var h=f.getContext("2d"),i=1,j=Math.round(c*(f.height/d)),k=b*i,l=Math.round((f.height-j)/2),m=Math.round(e*(f.height/d)),n=(b-1)*i,o=Math.round((f.height-m)/2);h.fillStyle=g.vals.colors.osciColor,h.strokeStyle=g.vals.colors.osciColor,h.moveTo(n,o),h.lineTo(k,l)}var i={};return i.osciPeaks=[],i.calculatePeaks=function(a,b,c){var d,e=(a.curViewPort.eS+1-a.curViewPort.sS)/b.width,f=1,g=[],h=1/0,i=-1/0;if(1>=e)d=0===a.curViewPort.sS?c.subarray(a.curViewPort.sS,a.curViewPort.eS+2):c.subarray(a.curViewPort.sS-1,a.curViewPort.eS+2),h=Math.min.apply(Math,d),i=Math.max.apply(Math,d),g=Array.prototype.slice.call(d);else{d=c.subarray(a.curViewPort.sS,a.curViewPort.eS);for(var j=0;j<b.width;j++){for(var k=0,l=0;f>l;l++){for(var m=d.subarray(j*e,(j+1)*e),n=0,o=0,p=m.length;p>o;o++)n+=m[o];k+=n/m.length}g[j]=k,k>i&&(i=k)}}return{peaks:g,minPeak:h,maxPeak:i,samplePerPx:e}},i.freshRedrawDrawOsciOnCanvas=function(a,b,c,d,e){var f=b.getContext("2d");if(f.clearRect(0,0,b.width,b.height),c.peaks&&c.samplePerPx>=1)f.beginPath(),c.peaks.forEach(function(d,f){0!==f&&h(a,f,d,c.maxPeak,c.peaks[f-1],b,e)}),f.stroke();else if(c.samplePerPx<1){var g=1/c.samplePerPx/2,i=a.curViewPort.sS;f.strokeStyle=e.vals.colors.osciColor,f.fillStyle=e.vals.colors.osciColor;var j;if(0===a.curViewPort.sS){for(f.moveTo(g,(c.peaks[0]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height),j=0;j<c.peaks.length;j++)f.lineTo(j/c.samplePerPx+g,(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height);for(f.stroke(),j=0;j<c.peaks.length;j++)f.beginPath(),f.arc(j/c.samplePerPx+g,(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-3,4,0,2*Math.PI,!1),f.stroke(),f.fill(),e.vals.restrictions.drawSampleNrs&&(f.strokeText(i,j/c.samplePerPx+g,(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-10),i+=1)}else{for(f.beginPath(),f.moveTo(-g,b.height-(c.peaks[0]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height),j=1;j<=c.peaks.length;j++)f.lineTo(j/c.samplePerPx-g,b.height-((c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height+3));for(f.stroke(),j=1;j<=c.peaks.length;j++)f.beginPath(),f.arc(j/c.samplePerPx-g,b.height-(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-3,4,0,2*Math.PI,!1),f.stroke(),f.fill(),e.vals.restrictions.drawSampleNrs&&(f.fillText(i,j/c.samplePerPx-g,b.height-(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-10),i+=1)}}if(e.vals.restrictions.drawZeroLine){if(f.strokeStyle=e.vals.colors.zeroLineColor,f.fillStyle=e.vals.colors.zeroLineColor,"Google Inc."===navigator.vendor&&f.setLineDash([2]),c.samplePerPx>=1)f.beginPath(),f.moveTo(0,b.height/2),f.lineTo(b.width,b.height/2),f.stroke(),f.fillText("0",5,b.height/2-5,b.width);else{var k=b.height-(0-c.minPeak)/(c.maxPeak-c.minPeak)*b.height;f.beginPath(),f.moveTo(0,k),f.lineTo(b.width,k),f.stroke(),f.fill(),f.fillText("0",5,b.height-(0-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-5,b.width)}"Google Inc."===navigator.vendor&&f.setLineDash([0])}},i.drawMovingBoundaryLine=function(c){var d,e;if(e=a.getSampleDist(c.canvas.width),d="SEGMENT"===a.getcurMouseLevelType()?0:e/2,a.movingBoundary){c.fillStyle=b.vals.colors.selectedBoundaryColor;var f=Math.round(a.getPos(c.canvas.width,a.movingBoundarySample));a.getcurMouseisLast()?c.fillRect(f+e,0,1,c.canvas.height):c.fillRect(f+d,0,1,c.canvas.height)}},i.drawCurViewPortSelected=function(e,h){var i,j,k,l,m;j=a.getSampleDist(e.canvas.width),i="seg"===a.getcurMouseLevelType()?0:j/2;var n=a.getPos(e.canvas.width,a.curViewPort.selectS),o=a.getPos(e.canvas.width,a.curViewPort.selectE);if(n===o)e.fillStyle=b.vals.colors.selectedBorderColor,e.fillRect(n+i,0,2,e.canvas.height),h&&a.curViewPort.sS!==a.curViewPort.selectS&&-1!==a.curViewPort.selectS&&(m=e.canvas.width/e.canvas.offsetWidth,k=g(e,a.curViewPort.selectS,a.round(a.curViewPort.selectS/c.wavJSO.SampleRate,6),m),l=d.getTextImageTwoLines(e,a.curViewPort.selectS,a.round(a.curViewPort.selectS/c.wavJSO.SampleRate,6),b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0),e.drawImage(l,0,0,l.width,l.height,o+5,0,l.width,l.height));else if(e.fillStyle=b.vals.colors.selectedAreaColor,e.fillRect(n,0,o-n,e.canvas.height),e.strokeStyle=b.vals.colors.selectedBorderColor,e.beginPath(),e.moveTo(n,0),e.lineTo(n,e.canvas.height),e.moveTo(o,0),e.lineTo(o,e.canvas.height),e.closePath(),e.stroke(),h&&(m=e.canvas.width/e.canvas.offsetWidth,k=g(e,a.curViewPort.selectS,a.round(a.curViewPort.selectS/c.wavJSO.SampleRate,6),m),l=d.getTextImageTwoLines(e,a.curViewPort.selectS,a.round(a.curViewPort.selectS/c.wavJSO.SampleRate,6),b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1),e.drawImage(l,0,0,l.width,l.height,n-k-5,0,l.width,l.height),l=d.getTextImageTwoLines(e,a.curViewPort.selectE,a.round(a.curViewPort.selectE/c.wavJSO.SampleRate,6),b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0),e.drawImage(l,0,0,l.width,l.height,o+5,0,l.width,l.height),k=f(e,a.round((a.curViewPort.selectE-a.curViewPort.selectS)/c.wavJSO.SampleRate,6),m),o-n>k)){var p=a.curViewPort.selectE-a.curViewPort.selectS-1,q=a.round((a.curViewPort.selectE-a.curViewPort.selectS)/c.wavJSO.SampleRate,6);k=g(e,p,q,m),l=d.getTextImageTwoLines(e,p,q,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1),e.drawImage(l,0,0,l.width,l.height,n+(o-n)/2-k/2,0,l.width,l.height)}},i.drawCrossHairs=function(c,f,g,h,i,j){if(b.vals.restrictions.drawCrossHairs){c.strokeStyle=b.vals.colors.crossHairsColor,c.fillStyle=b.vals.colors.crossHairsColor,"Google Inc."===navigator.vendor&&c.setLineDash([2]);var k=a.getX(f),l=a.getY(f);"Google Inc."===navigator.vendor&&c.setLineDash([0]),c.font=b.vals.font.fontPxSize+"px "+b.vals.font.fontType;var m=a.round(h-l/c.canvas.height*h,2),n=c.measureText(m+i).width,o=Math.round(a.curViewPort.sS+k/c.canvas.width*(a.curViewPort.eS-a.curViewPort.sS)),p=a.round(a.getViewPortStartTime()+k/c.canvas.width*(a.getViewPortEndTime()-a.getViewPortStartTime()),6),q=d.getTextImage(c,m+i,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.crossHairsColor,!0),r=d.getTextImageTwoLines(c,o,p,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.crossHairsColor,!0);if(void 0!==h||void 0!==g)if("OSCI"==j)c.beginPath(),c.moveTo(k,0),c.lineTo(k,c.canvas.height),c.stroke();else if("SPEC"==j)c.drawImage(q,0,0,q.width,q.height,5,l,q.width,q.height),c.drawImage(q,0,0,q.width,q.height,c.canvas.width-5-n*(c.canvas.width/c.canvas.offsetWidth),l,q.width,q.height),c.beginPath(),c.moveTo(0,l),c.lineTo(5,l+5),c.moveTo(0,l),c.lineTo(c.canvas.width,l),c.lineTo(c.canvas.width-5,l+5),c.moveTo(k,0),c.lineTo(k,c.canvas.height),c.stroke();else{var s=b.getSsffTrackConfig(j),t=e.getColumnOfTrack(s.name,s.columnName);m=a.round(t._maxVal-l/c.canvas.height*t._maxVal,2),q=d.getTextImage(c,m,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.crossHairsColor,!0),c.drawImage(q,0,0,q.width,q.height,5,l,q.width,q.height),c.drawImage(q,0,0,q.width,q.height,c.canvas.width-5-n*(c.canvas.width/c.canvas.offsetWidth),l,q.width,q.height),c.beginPath(),c.moveTo(0,l),c.lineTo(5,l+5),c.moveTo(0,l),c.lineTo(c.canvas.width,l),c.lineTo(c.canvas.width-5,l+5),c.moveTo(k,0),c.lineTo(k,c.canvas.height),c.stroke()}c.drawImage(r,0,0,r.width,r.height,k+5,0,r.width,r.height)}},i.drawMinMaxAndName=function(c,e,f,g,h){c.strokeStyle=b.vals.colors.labelColor,c.fillStyle=b.vals.colors.labelColor;var i=c.canvas.height/c.canvas.offsetHeight,j=3*b.vals.font.fontPxSize/4,k=j*i;if(c.beginPath(),c.moveTo(0,0),c.lineTo(5,5),c.moveTo(0,c.canvas.height),c.lineTo(5,c.canvas.height-5),c.stroke(),c.closePath(),""!==e){c.font=b.vals.font.fontPxSize+"px "+b.vals.font.fontType;var l=d.getTextImage(c,e,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0);c.drawImage(l,0,c.canvas.height/2-b.vals.font.fontPxSize*i/2)}if(void 0!==g){var m=d.getTextImage(c,"max: "+a.round(g,h),j,b.vals.font.fontType,b.vals.colors.endBoundaryColor);c.drawImage(m,5,5,m.width,m.height)}void 0!==f&&(m=d.getTextImage(c,"min: "+a.round(f,h),j,b.vals.font.fontType,b.vals.colors.endBoundaryColor),c.drawImage(m,5,c.canvas.height-k-5,m.width,m.height))},i.drawViewPortTimes=function(e){e.strokeStyle=b.vals.colors.labelColor,e.fillStyle=b.vals.colors.labelColor,e.font=b.vals.font.fontPxSize+"px "+b.vals.font.fontType,e.beginPath(),e.moveTo(0,0),e.lineTo(5,5),e.moveTo(e.canvas.width,0),e.lineTo(e.canvas.width-5,5),e.closePath(),e.stroke();var f,h,i,j,k=e.canvas.width/e.canvas.offsetWidth;e.canvas.height/e.canvas.offsetHeight,a.curViewPort&&(f=a.round(a.curViewPort.sS/c.wavJSO.SampleRate,6),h=a.round(a.curViewPort.eS/c.wavJSO.SampleRate,6),i=d.getTextImageTwoLines(e,a.curViewPort.sS,f,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0),e.drawImage(i,5,5),j=g(e,a.curViewPort.eS,h,k),i=d.getTextImageTwoLines(e,a.curViewPort.eS,h,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1),e.drawImage(i,0,0,i.width,i.height,e.canvas.width-j-5,0,i.width,i.height))},i}]),angular.module("emuwebApp").service("HistoryService",["$log","Ssffdataservice","LevelService","ConfigProviderService","viewState","Soundhandlerservice",function(a,b,c,d){function e(a,e){Object.keys(a).forEach(function(f){var g=a[f];if("SSFF"===g.type)if(e){var h=d.getSsffTrackConfig(g.trackName),i=b.getColumnOfTrack(h.name,h.columnName);i.values[g.sampleBlockIdx][g.sampleIdx]=g.oldValue}else{var h=d.getSsffTrackConfig(g.trackName),i=b.getColumnOfTrack(h.name,h.columnName);i.values[g.sampleBlockIdx][g.sampleIdx]=g.newValue}else if("ESPS"===g.type)switch(g.action){case"MOVEBOUNDARY":e?c.moveBoundary(g.name,g.id,-g.movedBy,g.isFirst,g.isLast):c.moveBoundary(g.name,g.id,g.movedBy,g.isFirst,g.isLast);break;case"MOVESEGMENT":e?c.moveSegment(g.name,g.id,g.length,-g.movedBy):c.moveSegment(g.name,g.id,g.length,g.movedBy);break;case"MOVEPOINT":e?c.movePoint(g.name,g.id,-g.movedBy):c.movePoint(g.name,g.id,g.movedBy);break;case"RENAMELABEL":e?c.renameLabel(g.name,g.id,g.attrIndex,g.oldValue):c.renameLabel(g.name,g.id,g.attrIndex,g.newValue);break;case"RENAMELEVEL":e?c.renameLevel(g.newname,g.name,g.curPerspectiveIdx):c.renameLevel(g.name,g.newname,g.curPerspectiveIdx);break;case"DELETELEVEL":e?c.addLevel(g.level,g.id,g.curPerspectiveIdx):c.deleteLevel(g.id,g.curPerspectiveIdx);break;case"ADDLEVEL":e?c.deleteLevel(g.id,g.curPerspectiveIdx):c.addLevel(g.level,g.id,g.curPerspectiveIdx);break;case"DELETEBOUNDARY":e?c.deleteBoundaryInvers(g.name,g.id,g.isFirst,g.isLast,g.deletedSegment):c.deleteBoundary(g.name,g.id,g.isFirst,g.isLast);break;case"DELETESEGMENTS":e?c.deleteSegmentsInvers(g.name,g.id,g.length,g.deletedSegment):c.deleteSegments(g.name,g.id,g.length);break;case"INSERTSEGMENTS":e?c.insertSegmentInvers(g.name,g.start,g.end,g.segName):c.insertSegment(g.name,g.start,g.end,g.segName,g.ids);break;case"INSERTPOINT":e?c.deletePoint(g.name,g.id):c.insertPoint(g.name,g.start,g.pointName,g.id);
break;case"DELETEPOINT":e?c.insertPoint(g.name,g.start,g.pointName,g.id):c.deletePoint(g.name,g.id);break;case"EXPANDSEGMENTS":e?c.expandSegment(g.rightSide,g.item,g.levelName,-g.changeTime):c.expandSegment(g.rightSide,g.item,g.levelName,g.changeTime)}})}var f={};f.movesAwayFromLastSave=0;var g=[],h=[],i={};return f.updateCurChangeObj=function(a){var b;if("SSFF"===a.type)b=String(a.type+"#"+a.trackName)+"#"+String(a.sampleBlockIdx)+"#"+String(a.sampleIdx),console.log(b),i[b]?(a.oldValue=i[b].oldValue,i[b]=a):i[b]=a;else if("ESPS"===a.type)switch(a.action){case"MOVEBOUNDARY":case"MOVEPOINT":case"MOVESEGMENT":case"INSERTPOINT":b=String(a.type+"#"+a.action+"#"+a.name+"#"+a.id),i[b]?(a.movedBy+=i[b].movedBy,i[b]=a):i[b]=a}return i},f.addCurChangeObjToUndoStack=function(){h=[],$.isEmptyObject(i)||(g.push(i),f.movesAwayFromLastSave+=1),a.info(i),i={}},f.addObjToUndoStack=function(a){h=[];var b={},c=String(a.type+"#"+a.action+"#"+a.name+"#"+a.id);b[c]=angular.copy(a),$.isEmptyObject(b)||(g.push(b),f.movesAwayFromLastSave+=1),i={}},f.undo=function(){if(g.length>0){var a=angular.copy(g[g.length-1]);h.push(a),e(a,!0),g.pop(),f.movesAwayFromLastSave-=1}},f.redo=function(){if(h.length>0){var a=angular.copy(h[h.length-1]);g.push(a),e(a,!1),h.pop(),f.movesAwayFromLastSave+=1}},f.getNrOfPossibleUndos=function(){return g.length},f.getCurrentStack=function(){return{undo:g,redo:h}},f.resetToInitState=function(){g=[],h=[],i={},f.movesAwayFromLastSave=0},f}]),angular.module("emuwebApp").service("Wavparserservice",["$q",function(a){var b,c={},d=new Worker("scripts/workers/wavParserWorker.js");return d.addEventListener("message",function(a){"SUCCESS"===a.data.status.type?b.resolve(a.data.data):b.reject(a.data)},!1),c.parseWavArrBuf=function(c){return b=a.defer(),d.postMessage({cmd:"parseBuf",buffer:c},[c]),b.promise},c}]),angular.module("emuwebApp").service("Textgridparserservice",["$q","LevelService","viewState","Soundhandlerservice",function(a,b,c,d){var e,f={},g=new Worker("scripts/workers/textGridParserWorker.js");return g.addEventListener("message",function(a){"SUCCESS"===a.data.status.type?e.resolve(a.data):e.reject(a.data)},!1),f.asyncToTextGrid=function(){return e=a.defer(),g.postMessage({cmd:"toTextGrid",levels:b.getData().levels,sampleRate:d.wavJSO.SampleRate,buffLength:d.wavJSO.Data.length}),e.promise},f.asyncParseTextGrid=function(b,c,f){return console.log(b,c,f),e=a.defer(),g.postMessage({cmd:"parseTG",textGrid:b,sampleRate:d.wavJSO.SampleRate,annotates:c,name:f}),e.promise},f}]),angular.module("emuwebApp").factory("uuid",function(){function a(a){var b=(Math.random().toString(16)+"000000000").substr(2,8);return a?"-"+b.substr(0,4)+"-"+b.substr(4,4):b}var b={};return b.new=function(){return a()+a(!0)+a(!0)+a()},b.newHash=function(){return a()+a(!0)+a(!0)+a()},b.empty=function(){return"00000000-0000-0000-0000-000000000000"},b}),angular.module("emuwebApp").service("fontScaleService",function(){var a={};return a.lastTextWidth=null,a.spaceTop=0,a.getTextImage=function(b,c,d,e,f){var g=b.canvas.height/b.canvas.offsetHeight,h=b.canvas.width/b.canvas.offsetWidth;d=Math.floor(d+2-g/2);var i=document.createElement("canvas");i.setAttribute("width",Math.round(200*h)),i.setAttribute("height",Math.round(100*g));var j=i.getContext("2d");return j.save(),j.font=d+"px "+e,j.fillStyle=f,j.scale(h,g),j.fillText(c,0,d+a.spaceTop),a.lastTextWidth=j.measureText(c).width*h,j.restore(),i},a.getLastImageWidth=function(){return a.lastTextWidth},a.getTextImageTwoLines=function(b,c,d,e,f,g,h){var i=b.canvas.height/b.canvas.offsetHeight,j=b.canvas.width/b.canvas.offsetWidth;e=Math.floor(e+2-i/2);var k=document.createElement("canvas");k.setAttribute("width",Math.round(200*j)),k.setAttribute("height",Math.round(100*i));var l=k.getContext("2d");if(l.save(),l.font=e+"px "+f,l.fillStyle=g,l.scale(j,i),a.lastTextWidth=l.measureText(c).width*j,h)l.fillText(c,0,e+a.spaceTop),l.fillText(d,0,2*e+a.spaceTop);else{var m=l.measureText(c).width,n=l.measureText(d).width;m>n?(l.fillText(c,0,e+a.spaceTop),l.fillText(d,m-n,2*e+a.spaceTop)):(l.fillText(c,n-m,e+a.spaceTop),l.fillText(d,0,2*e+a.spaceTop))}return l.restore(),k},a}),angular.module("emuwebApp").service("Espsparserservice",["$q","LevelService","Soundhandlerservice",function(a,b,c){var d,e={},f=new Worker("scripts/workers/espsParserWorker.js");return f.addEventListener("message",function(a){"SUCCESS"===a.data.status.type?d.resolve(a.data):d.reject(a.data)},!1),e.asyncParseEsps=function(b,e,g){return d=a.defer(),f.postMessage({cmd:"parseESPS",esps:b,sampleRate:c.wavJSO.SampleRate,annotates:e,name:g}),d.promise},e.asyncParseJSO=function(e){return d=a.defer(),f.postMessage({cmd:"parseJSO",level:b.getLevelDetails(e).level,sampleRate:c.wavJSO.SampleRate}),d.promise},e}]),angular.module("emuwebApp").controller("LoginCtrl",["$scope","$rootScope","$http","ConfigProviderService","Iohandlerservice","viewState","dialogService",function(a,b,c,d,e,f,g){a.loginData={username:"",password:"",errorMsg:""},a.tryLogin=function(){e.logOnUser(a.loginData.username,a.loginData.password).then(function(b){"LOGGEDON"===b?g.close(!0):a.loginData.errorMsg="ERROR: "+b})},a.cursorInTextField=function(){f.focusInTextField=!0},a.cursorOutOfTextField=function(){f.focusInTextField=!1},a.cancel=function(){g.close(!1)}}]),angular.module("emuwebApp").service("Ssffdataservice",["viewState","Soundhandlerservice",function(a,b){var c={};return c.data=[],c.getColumnOfTrack=function(a,b){var d;return c.data.forEach(function(c){c.ssffTrackName===a&&c.Columns.forEach(function(a){a.name===b&&(d=a)})}),void 0!==d?d:void alert("could not getColumnOfTrack of trackname: "+a)},c.getSampleRateAndStartTimeOfTrack=function(a){var b={};return c.data.forEach(function(c){c.ssffTrackName===a&&(b.sampleRate=c.sampleRate,b.startTime=c.startTime)}),void 0!==b?b:void alert("could not getSampleRateAndStartTimeOfTrack of trackname: "+a)},c.calculateSamplePosInVP=function(a,c,d){var e=a/c+d,f=Math.round(e*b.wavJSO.SampleRate);return f},c}]),angular.module("emuwebApp").service("LevelService",["$q","ConfigProviderService","Soundhandlerservice","viewState","Ssffdataservice","ArrayHelperService",function(a,b,c,d){function e(a,b){var c;return angular.forEach(b,function(b,d){b.name===a&&(c=d)}),c}var f={};return f.data={},f.maxItemID=0,f.lasteditArea=null,f.lasteditAreaElem=null,f.getData=function(){return f.data},f.setData=function(a){angular.copy(a,f.data),angular.forEach(f.data.levels,function(a){a.items.forEach(function(a){a.id>f.maxItemID&&(f.maxItemID=a.id)})})},f.getNewId=function(){return f.maxItemID+=1,f.maxItemID},f.raiseId=function(a){f.maxItemID+=a},f.lowerId=function(a){f.maxItemID-=a},f.getLevelDetails=function(a){var b=null,c=null;return angular.forEach(f.data.levels,function(d,e){d.name===a&&(b=d,c=e)}),{level:b,id:c}},f.getLevelsByType=function(a){var b=[];return angular.forEach(f.data.levels,function(c){var d=c.type;a.indexOf(d)>=0&&b.push(c)}),b},f.getOrderById=function(a,b){var c=void 0;return angular.forEach(f.data.levels,function(d){d.name===a&&d.items.forEach(function(a,d){a.id===b&&(c=d)})}),c},f.getIdByOrder=function(a,b){var c=null;return angular.forEach(f.data.levels,function(d){d.name===a&&d.items.forEach(function(a,d){d==b&&(c=a.id)})}),c},f.getItemDetails=function(a,b){var c=null;return angular.forEach(f.data.levels,function(d){d.name===a&&d.items.forEach(function(a,d){d==b&&(c=a)})}),c},f.getLastItem=function(a){var b=null;return angular.forEach(f.data.levels,function(c){c.name===a&&(b=c.items[c.items.length-1])}),b},f.getNextItem=function(a,b){var c=null;return angular.forEach(f.data.levels,function(d){d.name===a&&d.items.forEach(function(a,e){a.id==b&&(c=d.items[e+1])})}),c},f.getItemFromLevelById=function(a,b){var c=null;return angular.forEach(f.data.levels,function(d){d.name===a&&d.items.forEach(function(a){a.id==b&&(c=a)})}),c},f.getlasteditAreaElem=function(){return f.lasteditAreaElem},f.setlasteditAreaElem=function(a){f.lasteditAreaElem=a},f.setlasteditArea=function(a){f.lasteditArea=a},f.getlasteditArea=function(){return f.lasteditArea},f.getlastID=function(){return f.lasteditArea.substr(1)},f.deleteEditArea=function(){null!==f.getlasteditArea()&&$("."+f.getlasteditArea()).remove(),d.editing=!1},f.openEditArea=function(a,b,c){var g=d.getcurClickLevelName(),h=d.getCurAttrDef(g),i=e(h,a.labels),j=b.find("canvas").context.getContext("2d"),k=j.canvas.clientWidth,l=j.canvas.offsetLeft,m=j.canvas.offsetTop,n=j.canvas.clientHeight-1,o=10;void 0!==i&&a.labels[i].value.length>0&&(o=7*a.labels[i].value.length);var p="";if(a.labels.length>0&&(p=void 0!==a.labels[i]?a.labels[i].value:""),"SEGMENT"===c){var q=Math.floor(d.getPos(k,a.sampleStart)+l),r=Math.ceil(d.getPos(k,a.sampleStart+a.sampleDur+1)+l),s=r-q;if(2*o>s){var t=d.curViewPort.eS-d.curViewPort.sS;if(!(10>=t))return d.zoomViewPort(!0,this),void f.openEditArea(a,b,c);f.createEditArea(b,q,m,r-q,n,a.labels[i].value,a.id)}f.createEditArea(b,q,m,r-q,n,p,a.id)}else{var q=d.getPos(k,a.samplePoint)+l-o/2,r=d.getPos(k,a.samplePoint)+l+o/2,s=r-q;2*o>s&&(s=2*o),f.createEditArea(b,q,m,s,n,p,a.id)}f.createSelection(b.find("textarea")[0],0,p.length)},f.createSelection=function(a,b,c){if(a.createTextRange){var d=a.createTextRange();d.collapse(!0),d.moveStart("character",b),d.moveEnd("character",c),d.select()}else a.setSelectionRange?a.setSelectionRange(b,c):a.selectionStart&&(a.selectionStart=b,a.selectionEnd=c);a.focus()},f.createEditArea=function(a,b,c,d,e,f,g){var h="_"+g;a.prepend($("<textarea>").attr({id:h,"class":h+" emuwebapp-labelEdit","ng-model":"message",autofocus:"true"}).css({left:Math.round(b+2)+"px",top:Math.round(c)+"px",width:Math.round(d)-4+"px",height:Math.round(e)-1+"px","padding-top":Math.round(e/3+1)+"px","overflow-x":"hidden","overflow-y":"hidden"}).text(f))},f.insertItemDetails=function(a,c,e,g,h,i){var j,k=b.getLevelDefinition(c).attributeDefinitions,l=d.getCurAttrDef(c);void 0===k&&(k=[]),angular.forEach(f.data.levels,function(b){if(b.name===c){if("SEGMENT"==b.type)if(j={id:a,sampleStart:h,sampleDur:i,labels:[]},k.length>0)for(var d=0;d<k.length;d++)j.labels.push(k[d].name===l?{name:c,value:g}:{name:k[d].name,value:""});else j.labels.push({name:c,value:g});else if("EVENT"==b.type)if(j={id:a,samplePoint:h,labels:[]},k.length>0)for(var d=0;d<k.length;d++)j.labels.push(k[d].name===l?{name:c,value:g}:{name:k[d].name,value:""});else j.labels.push({name:c,value:g});b.items.splice(e,0,j)}})},f.updateSegItemInLevel=function(a,b,c,d,e,g){angular.forEach(f.data.levels,function(f){f.name===a&&f.items.forEach(function(a){a.id==b&&(void 0!==e&&(a.sampleStart=e),void 0!==g&&(a.sampleDur=g),void 0!==c&&(a.labels[d].value=c))})})},f.setPointDetails=function(a,b,c,d){angular.forEach(f.data.levels,function(e){e.name===a&&e.items.forEach(function(a){a.id==b&&(a.samplePoint=d,a.labels[0].value=c)})})},f.getItemNeighboursFromLevel=function(a,b,c){var d=void 0,e=void 0;return angular.forEach(f.data.levels,function(f){f.name===a&&f.items.forEach(function(a,g){a.id==b&&(d=f.items[g-1]),a.id==c&&(e=f.items[g+1])})}),{left:d,right:e}},f.getClosestItem=function(a,b,c){var d=f.getLevelDetails(b).level,e=void 0,g=void 0,h=void 0,i=void 0;if(d.items.length>0)if(e=g=d.items[0],h=!0,i=!1,"SEGMENT"===d.type)angular.forEach(d.items,function(b,c){a>=b.sampleStart-.5&&(a<=b.sampleStart+b.sampleDur+.5&&(a-b.sampleStart>=b.sampleDur/2?void 0!==d.items[c+1]?(e=d.items[c],g=d.items[c+1],i=!1):(i=!0,e=g=d.items[d.items.length-1]):(i=!1,e=g=d.items[c])),h=!1),a>=b.sampleStart-.5&&(a<=b.sampleStart+b.sampleDur+.5?e=b:(i=!0,e=g=d.items[d.items.length-1]))});else{var j=0,k=0;h=!1,i=!1,angular.forEach(d.items,function(b,f){k=f<d.items.length-1?b.samplePoint+(d.items[f+1].samplePoint-d.items[f].samplePoint)/2:c,j=f>0?b.samplePoint-(d.items[f].samplePoint-d.items[f-1].samplePoint)/2:0,k>=a&&a>=j&&(e=g=b)})}return{current:e,nearest:g,isFirst:h,isLast:i}},f.deleteLevel=function(a,c){var d=f.data.levels[a];return f.data.levels.splice(a,1),b.vals.perspectives[c].levelCanvases.order.splice(a,1),d},f.addLevel=function(a,c,d){void 0!==f.data.levels?(f.data.levels.splice(c,0,a),b.vals.perspectives[d].levelCanvases.order.splice(c,0,a.name)):(f.data.levels=[],f.data.levels.splice(c,0,a),b.vals.perspectives[d].levelCanvases.order.splice(c,0,a.name))},f.renameLabel=function(a,b,c,d){f.updateSegItemInLevel(a,b,d,c)},f.renameLevel=function(a,c,d){angular.forEach(f.data.levels,function(b){b.name===a&&(b.name=c,angular.forEach(b.items,function(a){a.labels[0].name=c}))}),b.vals.perspectives[d].levelCanvases.order[b.vals.perspectives[d].levelCanvases.order.indexOf(a)]=c},f.deleteSegmentsInvers=function(a,b,c,g){var h,i,j,k=d.getCurAttrDef(a);j=0,angular.forEach(f.data.levels,function(b){if(b.name===a){j=g.order;for(i in g.segments)b.items.splice(j++,0,g.segments[i])}});var l=f.getItemNeighboursFromLevel(a,g.segments[0].id,g.segments[g.segments.length-1].id);void 0!==l.left&&void 0===l.right?(h=e(k,l.left.labels),f.updateSegItemInLevel(a,l.left.id,l.left.labels[h].value,h,l.left.sampleStart,l.left.sampleDur-g.timeRight)):void 0===l.left&&void 0!==l.right?(h=e(k,l.right.labels),f.updateSegItemInLevel(a,l.right.id,l.right.labels[h].value,h,l.right.sampleStart+g.timeLeft,l.right.sampleDur-g.timeLeft)):void 0===l.left&&void 0===l.right||(h=e(k,l.left.labels),f.updateSegItemInLevel(a,l.left.id,l.left.labels[h].value,h,l.left.sampleStart,l.left.sampleDur-g.timeLeft),f.updateSegItemInLevel(a,l.right.id,l.right.labels[h].value,h,l.right.sampleStart+g.timeRight,l.right.sampleDur-g.timeRight))},f.deleteSegments=function(a,b,c){for(var g=f.getItemFromLevelById(a,b),h=f.getOrderById(a,b),i=f.getItemDetails(a,h+c-1),j=f.getItemNeighboursFromLevel(a,g.id,i.id),k=0,l=0,m=null,n=null,o=null,p=d.getCurAttrDef(a),q=e(p,g.labels),r=h;h+c>r;r++)k+=f.getItemDetails(a,r).sampleDur+1;return k%2==0?(k/=2,l=k):(k=Math.ceil(k/2),l=k-1),angular.forEach(f.data.levels,function(d){d.name===a&&angular.forEach(d.items,function(a,e){a.id==b&&(m=e,n=d.items.splice(m,c))})}),void 0!==j.left&&void 0===j.right?(f.updateSegItemInLevel(a,j.left.id,void 0,q,j.left.sampleStart,j.left.sampleDur+l),o=j.left):void 0===j.left&&void 0!==j.right?(f.updateSegItemInLevel(a,j.right.id,void 0,q,j.right.sampleStart-k,j.right.sampleDur+k),o=j.right):void 0===j.left&&void 0===j.right?d.setcurMouseSegment(void 0,void 0,void 0):(f.updateSegItemInLevel(a,j.left.id,void 0,q,j.left.sampleStart,j.left.sampleDur+k),f.updateSegItemInLevel(a,j.right.id,void 0,q,j.right.sampleStart-l,j.right.sampleDur+l),o=j.left),{order:m,segments:n,timeLeft:k,timeRight:l,clickSeg:o}},f.insertSegmentInvers=function(a,b,c){var d,e=!0;return angular.forEach(f.data.levels,function(f){if(f.name===a)if(b==c){var g=-1;if(angular.forEach(f.items,function(a,c){b==a.sampleStart&&(g=c,e=!0)}),e){var h=0;void 0!==f.items[g]&&(h=f.items[g].sampleDur+1),void 0!==f.items[g-1]&&(f.items[g-1].sampleDur+=h),f.items.splice(g,1)}}else{var g=-1;angular.forEach(f.items,function(a,c){b==a.sampleStart&&(g=c,e=!0)}),e&&(void 0===f.items[g+1]?f.items.splice(g-1,2):void 0===f.items[g-1]?f.items.splice(g,2):(h=f.items[g].sampleDur+1,d=f.items[g+1].sampleDur+1,f.items[g-1].sampleDur+=h+d,f.items.splice(g,2)))}}),e},f.insertSegment=function(a,b,c,d,e){var g=!0;return angular.forEach(f.data.levels,function(h){if(h.name===a)if(b==c){if(0==h.items.length)return{ret:!1,ids:e};void 0===e&&(e=[],e[0]=f.getNewId());var i=-1;if(b<h.items[0].sampleStart){var j=h.items[0].sampleStart-b;f.insertItemDetails(e[0],a,0,d,b,j-1)}else if(b>h.items[h.items.length-1].sampleStart+h.items[h.items.length-1].sampleDur){var k=h.items[h.items.length-1].sampleStart+h.items[h.items.length-1].sampleDur+1;f.insertItemDetails(e[0],a,h.items.length,d,k,b-k)}else if(angular.forEach(h.items,function(a,c){b>=a.sampleStart&&b<=a.sampleStart+a.sampleDur&&(i=c),a.sampleStart==b&&(g=!1),a.sampleStart+a.sampleDur+1==b&&(g=!1)}),g){var j=b-h.items[i].sampleStart-1;f.insertItemDetails(e[0],a,i+1,d,b,h.items[i].sampleDur-j-1),h.items[i].sampleDur=j}}else if(void 0===e&&(e=[],e[0]=f.getNewId(),e[1]=f.getNewId()),0==h.items.length)f.insertItemDetails(e[0],a,0,d,b,c-b-1);else if(c<h.items[0].sampleStart){var j=h.items[0].sampleStart-c-1,l=c-b-1;f.insertItemDetails(e[0],a,0,d,c,j),f.insertItemDetails(e[1],a,0,d,b,l)}else if(b>h.items[h.items.length-1].sampleStart+h.items[h.items.length-1].sampleDur){var j=b-(h.items[h.items.length-1].sampleStart+h.items[h.items.length-1].sampleDur)-1,l=c-b-1,m=h.items.length;f.insertItemDetails(e[0],a,m,d,h.items[h.items.length-1].sampleStart+h.items[h.items.length-1].sampleDur,j),f.insertItemDetails(e[1],a,m+1,d,b,l)}else{var i=-1,n=-1;if(angular.forEach(h.items,function(a,d){b>=a.sampleStart&&b<=a.sampleStart+a.sampleDur&&(i=d),c>=a.sampleStart&&c<=a.sampleStart+a.sampleDur&&(n=d)}),g=i===n,g&&-1!==i){var j=b-h.items[i].sampleStart-1,l=c-b-1;f.insertItemDetails(e[0],a,i+1,d,b,l),f.insertItemDetails(e[1],a,i+2,d,c,h.items[i].sampleDur-j-1-l-1),h.items[i].sampleDur=j}}}),{ret:g,ids:e}},f.insertPoint=function(a,b,c,d){var e=!1,g=void 0;return angular.forEach(f.data.levels,function(c){c.name===a&&"EVENT"===c.type&&(c.items[0].samplePoint,angular.forEach(c.items,function(a,c){Math.floor(b)===Math.floor(a.samplePoint)&&(e=!0),b>a.samplePoint&&(g=c+1)}))}),e||(void 0===d&&(d=f.getNewId()),f.insertItemDetails(d,a,g,c,b)),{alreadyExists:e,id:d}},f.deletePoint=function(a,b){var c=!1;return angular.forEach(f.data.levels,function(d){d.name===a&&"EVENT"==d.type&&angular.forEach(d.items,function(a,e){c||b==a.id&&(c=a,d.items.splice(e,1))})}),c},f.deleteBoundary=function(a,b,c,d){var e=f.getItemFromLevelById(a,b),g=null,h=null,i=null,j=null;return angular.forEach(f.data.levels,function(b){b.name===a&&(g=b.items[0],angular.forEach(b.items,function(a,f){"SEGMENT"===b.type&&e.sampleStart==a.sampleStart&&e.sampleDur==a.sampleDur&&(0===f&&c?(b.items.splice(f,1),h=f,i=a,j=b.items[0]):f===b.items.length-1&&d?(b.items.splice(f,1),h=f,i=a,j=b.items[b.items.length-1]):(g.labels[0].value+=a.labels[0].value,g.sampleDur+=a.sampleDur+1,b.items.splice(f,1),h=f,i=a,j=g)),g=a}),null==j&&(j=b.items[0]))}),{order:h,event:i,clickSeg:j}},f.deleteBoundaryInvers=function(a,b,c,d,e){angular.forEach(f.data.levels,function(b){if(b.name===a){b.items.splice(e.order,0,e.event);var f=e.event.labels[0].value;c||d||(f=b.items[e.order-1].labels[0].value.slice(0,b.items[e.order-1].labels[0].value.length-e.event.labels[0].value.length),b.items[e.order-1].labels[0].value=f,b.items[e.order-1].sampleDur-=e.event.sampleDur+1)}})},f.snapBoundary=function(a,b,c,d,e){var g,h,i,j,k=1/0,l=void 0;return"SEGMENT"==e?i=c.sampleStart:"EVENT"==e&&(i=c.samplePoint),angular.forEach(f.data.levels,function(c,d){if(c.name===b){if(a){if(!(d>=1))return!1;g=f.data.levels[d-1]}else{if(!(d<f.data.levels.length-1))return!1;g=f.data.levels[d+1]}g.items.forEach(function(a){"SEGMENT"==g.type?j=a.sampleStart:"EVENT"==g.type&&(j=a.samplePoint),h=Math.abs(i-j),k>h&&(k=h,l=j-i)})}}),void 0!==l?("SEGMENT"==e?this.moveBoundary(b,c.id,l,0):"EVENT"==e&&this.movePoint(b,c.id,l),l):!1},f.moveBoundary=function(a,b,g,h,i){var j=f.getItemFromLevelById(a,b),k=d.getCurAttrDef(a),l=e(k,j.labels),m=f.getItemNeighboursFromLevel(a,b,b);if(h){var n=m.right;void 0!==n?j.sampleStart+g>=0&&j.sampleStart+g<n.sampleStart&&f.updateSegItemInLevel(a,j.id,void 0,l,j.sampleStart+g,j.sampleDur-g):j.sampleStart+g>=0&&j.sampleDur-g>=0&&j.sampleStart+j.sampleDur+g<=c.wavJSO.Data.length&&f.updateSegItemInLevel(a,j.id,void 0,l,j.sampleStart+g,j.sampleDur-g)}else if(i)j.sampleDur+g>=0&&j.sampleDur+j.sampleStart+g<=c.wavJSO.Data.length&&f.updateSegItemInLevel(a,j.id,void 0,l,j.sampleStart,j.sampleDur+g);else if(void 0===m.left){var n=m.right;void 0!==n?j.sampleStart+g>=0&&j.sampleStart+g<n.sampleStart&&f.updateSegItemInLevel(a,j.id,void 0,l,j.sampleStart+g,j.sampleDur-g):j.sampleStart+g>=0&&j.sampleStart+j.sampleDur+g<=c.wavJSO.Data.length&&f.updateSegItemInLevel(a,j.id,void 0,l,j.sampleStart+g,j.sampleDur-g)}else{var o=m.left;o.sampleDur+g>=0&&j.sampleStart+g>=0&&j.sampleDur-g>=0&&(f.updateSegItemInLevel(a,m.left.id,void 0,l,o.sampleStart,o.sampleDur+g),f.updateSegItemInLevel(a,j.id,void 0,l,j.sampleStart+g,j.sampleDur-g))}},f.movePoint=function(a,b,d){var e=f.getItemFromLevelById(a,b);e.samplePoint+d>0&&e.samplePoint+d<=c.wavJSO.Data.length&&f.setPointDetails(a,e.id,e.labels[0].value,e.samplePoint+d),angular.forEach(f.data.levels,function(b){b.name===a&&b.items.sort(f.orderPoints)})},f.orderPoints=function(a,b){return a.samplePoint>b.samplePoint?1:a.samplePoint<b.samplePoint?-1:0},f.moveSegment=function(a,b,g,h){var i=f.getOrderById(a,b),j=f.getItemDetails(a,i),k=f.getItemDetails(a,i+g-1),l=f.getItemNeighboursFromLevel(a,j.id,k.id),m=d.getCurAttrDef(a),n=e(m,j.labels);if(void 0===l.left&&void 0!==l.right){var o=f.getItemFromLevelById(a,l.right.id);if(j.sampleStart+h>0&&l.right.sampleDur-h>=0){f.updateSegItemInLevel(a,o.id,void 0,n,o.sampleStart+h,o.sampleDur-h);for(var p=i;i+g>p;p++){var q=f.getItemDetails(a,p);f.updateSegItemInLevel(a,q.id,void 0,n,q.sampleStart+h,q.sampleDur)}}}else if(void 0===l.right&&void 0!==l.left){var r=f.getItemFromLevelById(a,l.left.id);if(l.left.sampleDur+h>=0&&k.sampleStart+k.sampleDur+h<c.wavJSO.Data.length){f.updateSegItemInLevel(a,r.id,void 0,n,r.sampleStart,r.sampleDur+h);for(var p=i;i+g>p;p++){var q=f.getItemDetails(a,p);f.updateSegItemInLevel(a,q.id,void 0,n,q.sampleStart+h,q.sampleDur)}}}else if(void 0!==l.right&&void 0!==l.left){var s=f.getItemFromLevelById(a,l.left.id),t=f.getItemFromLevelById(a,l.right.id);if(s.sampleDur+h>=0&&t.sampleDur-h>=0){f.updateSegItemInLevel(a,s.id,void 0,n,s.sampleStart,s.sampleDur+h),f.updateSegItemInLevel(a,t.id,void 0,n,t.sampleStart+h,t.sampleDur-h);for(var p=i;i+g>p;p++){var q=f.getItemDetails(a,p);f.updateSegItemInLevel(a,q.id,void 0,n,q.sampleStart+h,q.sampleDur)}}}else if(void 0===l.right&&void 0===l.left){var u=f.getItemDetails(a,i),v=f.getItemDetails(a,i+g-1);if(u.sampleStart+h>0&&v.sampleDur+v.sampleStart+h<c.wavJSO.Data.length)for(var p=i;i+g>p;p++){var q=f.getItemDetails(a,p);f.updateSegItemInLevel(a,q.id,void 0,n,q.sampleStart+h,q.sampleDur)}}},f.expandSegment=function(a,b,g,h){var i,j=0,k=f.getItemNeighboursFromLevel(g,b[0].id,b[b.length-1].id),l=(h*b.length,d.getCurAttrDef(g)),m=e(l,b[0].labels),n=!0;if(a)if(void 0===k.right){var o=b[b.length-1].sampleStart+b[b.length-1].sampleDur+h*b.length;o<=c.wavJSO.Data.length&&angular.forEach(b,function(a){i=f.getItemFromLevelById(g,a.id),f.updateSegItemInLevel(g,i.id,void 0,m,i.sampleStart+j,i.sampleDur+h),j+=h})}else angular.forEach(b,function(a){a.sampleDur+1+h<0&&(n=!1)}),n&&k.right.sampleDur-h*b.length>0&&(angular.forEach(b,function(a){i=f.getItemFromLevelById(g,a.id),f.updateSegItemInLevel(g,i.id,void 0,m,i.sampleStart+j,i.sampleDur+h),j+=h}),f.updateSegItemInLevel(g,k.right.id,void 0,m,k.right.sampleStart+j,k.right.sampleDur-j));else if(void 0===k.left){var p=f.getItemDetails(g,0);p.sampleStart+h*(b.length+1)>0&&angular.forEach(b,function(a){i=f.getItemFromLevelById(g,a.id),f.updateSegItemInLevel(g,i.id,void 0,i.sampleStart-h,m,i.sampleDur+h)})}else angular.forEach(b,function(a){a.sampleDur+1+h<0&&(n=!1)}),n&&k.left.sampleDur-h*b.length>0&&(j=0,angular.forEach(b,function(a,c){i=f.getItemFromLevelById(g,a.id),j=-(b.length-c)*h,f.updateSegItemInLevel(g,i.id,void 0,m,i.sampleStart+j,i.sampleDur+h)}),f.updateSegItemInLevel(g,k.left.id,void 0,m,k.left.sampleStart,k.left.sampleDur-b.length*h))},f.calcDistanceToNearestZeroCrossing=function(a){for(var b,d=a;d<c.wavJSO.Data.length-1;d++)if(c.wavJSO.Data[d]>=0&&c.wavJSO.Data[d+1]<0||c.wavJSO.Data[d]<0&&c.wavJSO.Data[d+1]>=0){b=d-a;break}for(var e,d=a;d>1;d--)if(c.wavJSO.Data[d]>=0&&c.wavJSO.Data[d-1]<0||c.wavJSO.Data[d]<0&&c.wavJSO.Data[d-1]>=0){e=d-a;break}var f;return f=Math.abs(e)<Math.abs(b)?e:b+1},f.getAllLabelsOfLevel=function(a){for(var b=d.getCurAttrDef(a.level.name),c=[],e=0;e<a.level.items.length;e++)for(var f=0;f<a.level.items[e].labels.length;f++)a.level.items[e].labels[f].name===b&&c.push(a.level.items[e].labels[f].value);return c},f.addLinkToParent=function(a,b){angular.forEach(b,function(b){f.data.links.push({fromID:a,toID:b})})},f.inverseAddLinkToParent=function(a,b){angular.forEach(f.data.links,function(c,d){c.fromID===a&&-1!==b.indexOf(c.toID)&&f.data.links.splice(d)})},f}]),angular.module("emuwebApp").service("Websockethandler",["$q","$rootScope","$location","$timeout","HistoryService","Ssffparserservice","ConfigProviderService","viewState","Wavparserservice","Soundhandlerservice","Espsparserservice","uuid","Binarydatamaniphelper","Ssffdataservice","dialogService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){function p(a){A=!0,b.$apply(z.resolve(a))}function q(a){u(angular.fromJson(a.data))}function r(a){console.error("WEBSOCKET ERROR!!!!!"),b.$apply(z.resolve(a))}function s(a){console.log(a),!a.wasClean&&A&&o.open("views/error.html","ModalCtrl","A non clean diconnect to the server occurred! This probably means that the server is down. Please check the server and reconnect!").then(function(){b.$broadcast("connectionDisrupted")}),A=!1,console.log("WEBSOCKET closed!!!!!")}function t(b){var c=a.defer(),e=v();return x[e]={time:new Date,cb:c},b.callbackID=e,y.send(angular.toJson(b)),d(function(){var a={callbackID:e,status:{type:"ERROR:TIMEOUT",message:"Sent request of type: "+b.type+" timed out after "+g.vals.main.serverTimeoutInterval+"ms!  Please check the server..."}};u(a)},g.vals.main.serverTimeoutInterval),c.promise}function u(a){var c=a;if(x.hasOwnProperty(c.callbackID)){switch(c.type){case"getESPSfile":alert("espsfile");break;case"getSSFFfile":alert("ssfffile")}"SUCCESS"===c.status.type?b.$apply(x[c.callbackID].cb.resolve(c.data)):o.open("views/error.html","ModalCtrl","Communication error with server! Error message is: "+c.status.message),delete x[c.callbackID]}else"ERROR:TIMEOUT"===c.status.type||o.open("views/error.html","ModalCtrl","What just happened? You should not be here...")}function v(){var a=l.new();return a}var w={},x={},y={},z={},A=!1;return w.initConnect=function(b){var c=a.defer();return y=new WebSocket(b),y.onopen=p,y.onmessage=q,y.onerror=r,y.onclose=s,z=c,c.promise},w.isConnected=function(){return A},w.closeConnect=function(){y.onclose=function(){},y.close()},w.getProtocol=function(){var a={type:"GETPROTOCOL"},b=t(a);return b},w.getDoUserManagement=function(){var a={type:"GETDOUSERMANAGEMENT"},b=t(a);return b},w.logOnUser=function(a,b){var c={type:"LOGONUSER",userName:a,pwd:b},d=t(c);return d},w.getDBconfigFile=function(){var a={type:"GETGLOBALDBCONFIG"},b=t(a);return b},w.getBundleList=function(){var a={type:"GETBUNDLELIST"},b=t(a);return b},w.getBundle=function(a){var b={type:"GETBUNDLE",name:a},c=t(b);return c},w.saveBundle=function(a){var b={type:"SAVEBUNDLE",data:a},c=t(b);return c},w.disconnectWarning=function(){var a={type:"DISCONNECTWARNING"},b=t(a);return b},w}]),angular.module("emuwebApp").controller("WsconnectionCtrl",["$scope","ConfigProviderService","Iohandlerservice","viewState","dialogService",function(a,b,c,d,e){a.serverInfos={},a.serverInfos.Url=b.vals.main.serverUrl,a.connectionError="",d.focusInTextField=!0,a.tryConnection=function(){e.close(a.serverInfos.Url)},a.cancel=function(){e.close(!1)}}]),angular.module("emuwebApp").service("Binarydatamaniphelper",function(){var a={};return a.base64ToArrayBuffer=function(a){for(var b=window.atob(a),c=b.length,d=new Uint8Array(c),e=0;c>e;e++){var f=b.charCodeAt(e);d[e]=f}return d.buffer},a.arrayBufferToBase64=function(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;d>e;e++)b+=String.fromCharCode(c[e]);return window.btoa(b)},a}),angular.module("emuwebApp").service("dialogService",["$modal","viewState",function(a,b){var c={},d={};return c.open=function(c,e,f){return b.setState("modalShowing"),d=a.open({backdrop:"static",keyboard:!1,templateUrl:c,controller:e,resolve:{passedInTxt:function(){return f},passedInOpts:function(){return f}}}),d.result},c.openExport=function(c,e,f,g){return b.setState("modalShowing"),d=a.open({backdrop:"static",keyboard:!1,templateUrl:c,controller:e,resolve:{exportData:function(){return f},exportName:function(){return g}}}),d.result},c.close=function(a){b.focusInTextField=!1,b.setState(b.prevState),d.close(a)},c}]),angular.module("emuwebApp").controller("WaitCtrl",["$scope","viewState",function(a,b){a.vs=b}]),angular.module("emuwebApp").service("Appcachehandler",["$http","dialogService",function(a,b){function c(){console.log("###### handleUpdatereadyEvent ##########"),b.open("views/confirmModal.html","ConfirmmodalCtrl","A new version of the EMU-WebApp is available and has already been downloaded and cached in your browser. Would you like to use it? CAUTION: A reload will delete all current changes... TIP: the next time you use the EMU-webApp you will automatically use the updated version)").then(function(a){a&&(e.swapCache(),window.location.reload())})}var d={},e=window.applicationCache;return e.addEventListener("updateready",c,!1),d.checkForNewVersion=function(){0!==e.status&&3!==e.status&&(console.log("INFO: appCache.status: "+e.status),e.update())},d}]),angular.module("emuwebApp").controller("AboutCtrl",["$scope","ConfigProviderService","dialogService",function(a,b,c){a.cps=b,a.getStrRep=function(a){var b;switch(a){case 8:b="BACKSPACE";break;case 9:b="TAB";break;case 13:b="ENTER";break;case 16:b="SHIFT";break;case 18:b="ALT";break;case 32:b="SPACE";break;case 37:b="";break;case 39:b="";break;case 38:b="";break;case 40:b="";break;case 42:b="+";break;case 43:b="+";break;case 45:b="-";break;case 95:b="-";break;default:b=String.fromCharCode(a)}return b},a.cancel=function(){c.close()}}]),angular.module("emuwebApp").controller("spectSettingsCtrl",["$scope","dialogService","viewState","LevelService",function(a,b,c,d){a.vs=c,a.options=Object.keys(a.vs.getWindowFunctions()),a.selWindowInfo={},a.selWindowInfo.name=Object.keys(a.vs.getWindowFunctions())[a.vs.spectroSettings.window-1],a.windowLengths=[32,64,128,256,512,1024,2048],a.modalVals={rangeFrom:a.vs.spectroSettings.rangeFrom,rangeTo:a.vs.spectroSettings.rangeTo,dynamicRange:a.vs.spectroSettings.dynamicRange,windowLength:a.vs.spectroSettings.windowLength,window:a.vs.spectroSettings.window,drawHeatMapColors:a.vs.spectroSettings.drawHeatMapColors,preEmphasisFilterFactor:a.vs.spectroSettings.preEmphasisFilterFactor,heatMapColorAnchors:c.spectroSettings.heatMapColorAnchors},a.cursorInTextField=function(){c.focusInTextField=!0},a.cursorOutOfTextField=function(){c.focusInTextField=!1},a.getColorOfAnchor=function(b){var c={"background-color":"rgb("+a.modalVals.heatMapColorAnchors[b][0]+","+a.modalVals.heatMapColorAnchors[b][1]+","+a.modalVals.heatMapColorAnchors[b][2]+")",width:"10px",height:"10px"};return c},a.saveSpectroSettings=function(){a.modalVals.dynamicRange%1===0?a.modalVals.rangeFrom%1===0?a.modalVals.rangeTo%1===0?a.modalVals.rangeFrom>=0?a.modalVals.rangeTo<=d.data.sampleRate/2?(c.setspectroSettings(a.modalVals.windowLength,a.modalVals.rangeFrom,a.modalVals.rangeTo,a.modalVals.dynamicRange,a.selWindowInfo.name,a.modalVals.drawHeatMapColors,a.modalVals.preEmphasisFilterFactor,a.modalVals.heatMapColorAnchors),a.cancel()):a.error("View Range (Hz) upper boundary is a value bigger than "+d.data.sampleRate/2):a.error("View Range (Hz) lower boundary is a value below zero"):a.error("View Range (Hz) upper boundary has to be an Integer value."):a.error("View Range (Hz) lower boundary has to be an Integer value."):a.error("Dynamic Range has to be an Integer value.")},a.error=function(a){b.close(),b.open("views/error.html","ModalCtrl","Sorry: "+a)},a.cancel=function(){b.close()}}]),angular.module("emuwebApp").controller("ConfirmmodalCtrl",["$scope","dialogService","passedInTxt",function(a,b,c){a.passedInTxt=c,a.confirm=function(){b.close(!0)},a.cancel=function(){b.close(!1)}}]),angular.module("emuwebApp").controller("SelectThresholdModalCtrl",["$scope","dialogService","passedInOpts","ArrayHelperService",function(a,b,c,d){a.passedInOpts=c,a.myData=d.convertArrayToXYjsoArray(c.y),a.select=function(a){b.close(a)}}]),angular.module("emuwebApp").controller("SelectLabelModalCtrl",["$scope","dialogService","passedInOpts","ArrayHelperService",function(a,b,c){a.passedInOpts=c,a.select=function(a){b.close(a)
}}]),angular.module("emuwebApp").filter("regex",function(){return function(a,b){for(var c=new RegExp(b.toLowerCase()),d=[],e=0;e<a.length;e++)c.test(a[e].name.toLowerCase())&&d.push(a[e]);return d}}),angular.module("emuwebApp").filter("levelsFilter",["ConfigProviderService","viewState",function(a,b){return function(c){if(c){for(var d,e=new RegExp("SEGMENT"),f=new RegExp("EVENT"),g=[],h=0;h<c.length;h++)(e.test(c[h].type)||f.test(c[h].type))&&void 0!==a.vals.perspectives[b.curPerspectiveIdx].levelCanvases&&(d=a.vals.perspectives[b.curPerspectiveIdx].levelCanvases.order.indexOf(c[h].name),-1!==d&&(g[d]=c[h]));return g}}}]),angular.module("emuwebApp").controller("ModalCtrl",["$scope","dialogService","passedInTxt","viewState","LevelService","HistoryService",function(a,b,c,d,e,f){a.passedInTxt=c,a.passedOutTxt={"var":null},a.cancel=function(){b.close()},a.cursorInTextField=function(){d.focusInTextField=!0},a.cursorOutOfTextField=function(){d.focusInTextField=!1},a.saveChanges=function(){b.close("saveChanges")},a.discardChanges=function(){b.close("discardChanges")},a.renameLevel=function(){e.renameLevel(a.passedInTxt,a.passedOutTxt.var,d.curPerspectiveIdx),f.addObjToUndoStack({type:"ESPS",action:"RENAMELEVEL",newname:a.passedOutTxt.var,name:a.passedInTxt,curPerspectiveIdx:d.curPerspectiveIdx}),b.close()},a.deleteLevel=function(){var a=e.getLevelDetails(d.getcurClickLevelName());e.deleteLevel(d.getcurClickLevelIndex(),d.curPerspectiveIdx),f.addObjToUndoStack({type:"ESPS",action:"DELETELEVEL",level:a.level,id:d.getcurClickLevelIndex(),curPerspectiveIdx:d.curPerspectiveIdx}),b.close()}}]),angular.module("emuwebApp").directive("showMenu",["$animate",function(a){return{restrict:"A",link:function(b,c,d){b.$watch(d.showMenu,function(b){b?a.addClass(c,"emuwebapp-expandWidthTo200px"):(a.removeClass(c,"emuwebapp-expandWidthTo200px"),a.addClass(c,"emuwebapp-shrinkWidthTo0px"))})}}}]),angular.module("emuwebApp").directive("showTwod",["$animate",function(a){return{restrict:"A",link:function(b,c,d){b.$watch(d.showTwod,function(b){b?a.addClass(c,".slideIn2dCanvases"):a.removeClass(c,".slideIn2dCanvases")})}}}]),angular.module("emuwebApp").animation(".slideIn2dCanvases",function(){return{addClass:function(a){a.addClass("slide2dCanvases")},removeClass:function(a){a.removeClass("slide2dCanvases")}}}),angular.module("emuwebApp").directive("bgSplitter",["$rootScope","viewState",function(a,b){return{restrict:"E",replace:!0,transclude:!0,scope:{showTwoDimCans:"@"},template:'<div class="emuwebapp-split-panes vertical" ng-transclude></div>',controller:["$scope",function(a){a.panes=[],a.bottomRightResizePane,this.addPane=function(b){if(a.panes.length>1)throw"splitters can only have two panes";return a.panes.push(b),a.panes.length},this.setBottomRightResizePane=function(b){a.bottomRightResizePane=b}}],link:function(c,d,e){var f=!1,g=!1,h=!1,i=angular.element('<div class="emuwebapp-split-handler"><span></span></div>'),j=c.panes[0],k=c.panes[1],l=c.bottomRightResizePane,m=angular.element('<div class="emuwebapp-bottomRightResizePaneTopResizer"></div>'),n=angular.element('<div class="emuwebapp-bottomRightResizePaneLeftResizer"></div>'),o=angular.element('<div class="emuwebapp-bottomRightResizePaneCornerResizer"></div>');l.elem.prepend(n),l.elem.prepend(m),l.elem.prepend(o);var p=j.minSize||0,q=k.minSize||0,r=!1,s=!1;j.elem.after(i),e.$observe("showTwoDimCans",function(a){"false"===a?c.bottomRightResizePane.elem.hide():c.bottomRightResizePane.elem.show()}),d.bind("mousemove",function(a){if(s){var c=d[0].getBoundingClientRect(),e=0;if(r){var m=c.bottom-c.top;if(e=a.clientY-c.top,p>e)return;if(q>m-e)return;i.css("top",e+"px"),j.elem.css("height",e+"px"),k.elem.css("top",e+"px"),b.setdragBarHeight(e)}if(f){var m=c.bottom-c.top;if(e=a.clientY-c.top,10>=e||10>=m-e)return;l.elem.css("top",e+"px");var n=m-e;l.elem.css("height",n+"px")}if(g){var o=c.right-c.left;if(e=a.clientX-c.left,10>=e||10>=o-e)return;l.elem.css("left",e+"px");var n=o-e;l.elem.css("width",n+"px")}if(h){var m=c.bottom-c.top;if(e=a.clientY-c.top,10>=e||10>=m-e)return;l.elem.css("top",e+"px");var n=m-e;l.elem.css("height",n+"px");var o=c.right-c.left;if(e=a.clientX-c.left,10>=e||10>=o-e)return;l.elem.css("left",e+"px");var n=o-e;l.elem.css("width",n+"px")}}}),i.bind("mousedown",function(c){c.preventDefault(),s=!0,r=!0,b.setdragBarActive(!0),a.$digest()}),m.bind("mousedown",function(c){c.preventDefault(),s=!0,f=!0,b.setdragBarActive(!0),a.$digest()}),n.bind("mousedown",function(c){c.preventDefault(),s=!0,g=!0,b.setdragBarActive(!0),a.$digest()}),o.bind("mousedown",function(c){c.preventDefault(),s=!0,h=!0,b.setdragBarActive(!0),a.$digest()}),angular.element(document).bind("mouseup",function(){s=!1,r=!1,f=!1,g=!1,h=!1,b.setdragBarActive(!1),a.$digest()})}}}]).directive("bgPane",function(){return{restrict:"E",require:"^bgSplitter",replace:!0,transclude:!0,scope:{minSize:"=",type:"@",showTwoDimCans:"@"},template:'<div class="{{typeclass}}" ng-transclude></div>',link:function(a,b,c,d){"emuwebapp-bottomRightResizePane"!==a.type?(a.elem=b,a.index=d.addPane(a),a.typeclass="split-pane"+a.index):(a.elem=b,a.index=3,a.typeclass="emuwebapp-bottomRightResizePane",d.setBottomRightResizePane(a))}}}),angular.module("emuwebApp").directive("ssffTrack",["$timeout","viewState","ConfigProviderService",function(a){return{templateUrl:"views/ssffTrack.html",restrict:"E",link:function(b,c,d){function e(){if(!$.isEmptyObject(b.ssffds.data)&&0!==b.ssffds.data.length){i.clearRect(0,0,i.canvas.width,i.canvas.height),b.dhs.drawMovingBoundaryLine(i),b.dhs.drawCurViewPortSelected(i,!1);var a=b.cps.getSsffTrackConfig(f),c=b.ssffds.getColumnOfTrack(a.name,a.columnName);b.dhs.drawMinMaxAndName(i,f,c._minVal,c._maxVal,2)}}var f,g=c.find("canvas").length,h=(c.find("canvas")[1],c.find("canvas")[g-1]),i=h.getContext("2d");d.$observe("trackName",function(a){a&&(f=a)}),b.order=d.order,b.$on("refreshTimeline",function(){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||e()}),b.$watch("vs.timelineSize",function(){a(b.redraw,10)}),b.$watch("vs.curViewPort",function(){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||e()},!0),b.$watch("ssffds.data.length",function(){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||e()},!0),b.$watch("vs.movingBoundary",function(){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||e()},!0),b.$watch("vs.movingBoundarySample",function(){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||e()},!0),b.redraw=function(){e()}}}}]),angular.module("emuwebApp").directive("progressThing",["$animate",function(a){return{template:'<div class="emuwebapp-progressThing">{{vs.somethingInProgressTxt}}</div>',restrict:"E",replace:!0,link:function(b,c,d){d.$observe("showThing",function(b){"true"===b?(a.removeClass(c,"emuwebapp-shrinkHeightTo0px"),a.addClass(c,"emuwebapp-expandHeightTo20px")):(a.removeClass(c,"emuwebapp-expandHeightTo20px"),a.addClass(c,"emuwebapp-shrinkHeightTo0px"))})}}}]),angular.module("emuwebApp").directive("epg",["viewState",function(){return{template:'<div class="emuwebapp-twoDimCanvasContainer"><canvas width="512" height="512"></canvas></div>',restrict:"E",replace:!0,link:function(a,b){function c(a){d=a.cps.getSsffTrackConfig("EPG"),e=a.ssffds.getColumnOfTrack(d.name,d.columnName),f=a.ssffds.getSampleRateAndStartTimeOfTrack(d.name);var b=g.getContext("2d");b.clearRect(0,0,g.width,g.height),b.fillStyle="green",b.strokeStyle=a.cps.vals.colors.osciColor,b.font=a.cps.vals.font.fontPxSize+"px "+a.cps.vals.font.fontType;var c,h=g.width/8,i=g.height/8,j=1/f.sampleRate-f.startTime,k=Math.round(a.vs.curMousePosSample/a.shs.wavJSO.SampleRate/j);angular.forEach(e.values[k],function(a,d){for(c=a.toString(2).split("").reverse();c.length<8;)c.push("0");c.forEach(function(a,c){"1"===a?(b.fillStyle="grey",b.fillRect(c*h+5,i*d+5,h-10,i-10)):(b.fillStyle="white",b.fillRect(c*h+5,i*d+5,h-10,i-10))})});var l=a.fontImage.getTextImageTwoLines(b,"EPG","Frame:"+k,a.cps.vals.font.fontPxSize,a.cps.vals.font.fontType,a.cps.vals.colors.labelColor,!0);b.drawImage(l,0,0,l.width,l.height,5,0,l.width,l.height)}var d,e,f,g=b.find("canvas")[0];a.$watch("vs.curViewPort",function(b,d){$.isEmptyObject(a.cps.vals)||$.isEmptyObject(a.ssffds.data)||0!==a.ssffds.data.length&&(d.sS!==b.sS||d.eS!==b.eS)&&c(a)},!0),a.$watch("vs.curMousePosSample",function(){$.isEmptyObject(a.cps.vals)||$.isEmptyObject(a.ssffds.data)||0!==a.ssffds.data.length&&c(a)},!0)}}}]),angular.module("emuwebApp").directive("dots",["viewState",function(){return{template:'<div class="emuwebapp-twoDimCanvasContainer"><canvas width="512" height="512"></canvas></div>',restrict:"E",replace:!0,link:function(a,b){function c(){for(var b=a.cps.vals.perspectives[a.vs.curPerspectiveIdx].twoDimCanvases.twoDimDrawingDefinitions[0],c=0;c<b.dots.length;c++){var d=a.cps.getSsffTrackConfig(b.dots[c].xSsffTrack),e=a.ssffds.getColumnOfTrack(d.name,d.columnName);e._minVal<f&&(f=e._minVal),e._maxVal>g&&(g=e._maxVal),d=a.cps.getSsffTrackConfig(b.dots[c].ySsffTrack);var j=a.ssffds.getColumnOfTrack(d.name,d.columnName);j._minVal<h&&(h=j._minVal),j._maxVal>i&&(i=j._maxVal)}}function d(){1/0===f&&c();var b=e.getContext("2d");b.clearRect(0,0,e.width,e.height);var d=b.canvas.width/b.canvas.offsetWidth,j=b.canvas.height/b.canvas.offsetHeight;b.beginPath(),b.moveTo(0,0),b.lineTo(5,5),b.moveTo(0,e.height),b.lineTo(5,e.height-5),b.moveTo(e.width,e.height),b.lineTo(e.width-5,e.height-5),b.stroke(),b.closePath();var k=3*a.cps.vals.font.fontPxSize/4,l=a.fontImage.getTextImage(b,"yMax: "+a.vs.round(i,2),k,a.cps.vals.font.fontType,a.cps.vals.colors.endBoundaryColor);b.drawImage(l,5,5,l.width,l.height),l=a.fontImage.getTextImageTwoLines(b,"yMin: "+a.vs.round(h,2),"xMin: "+a.vs.round(f,2),k,a.cps.vals.font.fontType,a.cps.vals.colors.endBoundaryColor,!0),b.drawImage(l,5,e.height-k*j*2-5,l.width,l.height);var m=b.measureText("xMax: "+a.vs.round(g,5)).width*d;l=a.fontImage.getTextImage(b,"xMax: "+a.vs.round(g,2),k,a.cps.vals.font.fontType,a.cps.vals.colors.endBoundaryColor),b.drawImage(l,e.width-m-5,e.height-k*j-5,l.width,l.height);var n,o=a.cps.vals.perspectives[a.vs.curPerspectiveIdx].twoDimCanvases.twoDimDrawingDefinitions[0],p=a.ssffds.getSampleRateAndStartTimeOfTrack(o.dots[0].xSsffTrack),q=a.ssffds.getSampleRateAndStartTimeOfTrack(o.dots[0].ySsffTrack),r=(1/p.sampleRate,a.vs.curMousePosSample/a.shs.wavJSO.SampleRate);n=Math.round(p.startTime===1/p.sampleRate/2?r*p.sampleRate:r*p.sampleRate+(p.startTime-1/p.sampleRate/2)*p.sampleRate);var s=a.cps.getSsffTrackConfig(o.dots[0].xSsffTrack),t=a.ssffds.getColumnOfTrack(s.name,s.columnName);n>t.values.length-1&&(n=t.values.length-1),m=b.measureText("frame: "+n).width*d,l=a.fontImage.getTextImage(b,"frame: "+n,a.cps.vals.font.fontPxSize-4,a.cps.vals.font.fontType,a.cps.vals.colors.endBoundaryColor);var u=90;b.save(),b.rotate(u*Math.PI/180),b.drawImage(l,e.width/2-m/2,-e.height),b.restore();for(var v=[],w=0;w<o.dots.length;w++){var s=a.cps.getSsffTrackConfig(o.dots[w].xSsffTrack),t=a.ssffds.getColumnOfTrack(s.name,s.columnName);s=a.cps.getSsffTrackConfig(o.dots[w].ySsffTrack);var x=a.ssffds.getColumnOfTrack(s.name,s.columnName);if(t.values.length!==x.values.length)return void alert("columns do not have same length or length of one not 1");var p=a.ssffds.getSampleRateAndStartTimeOfTrack(o.dots[w].xSsffTrack),q=a.ssffds.getSampleRateAndStartTimeOfTrack(o.dots[w].ySsffTrack);if(p.sampleRate!==q.sampleRate||p.startSample!==q.startSample)return void alert("xsRaSt.sampleRate !== ysRaSt.sampleRate || xsRaSt.startSample !== ysRaSt.startSample");var y=(t.values[n][o.dots[w].xContourNr]-f)/(g-f)*e.width,z=e.height-(x.values[n][o.dots[w].yContourNr]-h)/(i-h)*e.height,A=Math.PI/180*0,B=Math.PI/180*360;b.strokeStyle=o.dots[w].color,b.beginPath(),b.arc(y,z,20,A,B,!0),b.stroke(),b.closePath(),b.beginPath(),b.arc(y,z,2,A,B,!0),b.fill(),b.closePath();var l=a.fontImage.getTextImage(b,o.dots[w].name,a.cps.vals.font.fontPxSize-4,a.cps.vals.font.fontType,a.cps.vals.colors.labelColor);b.drawImage(l,y,z-5,l.width,l.height),v.push({name:o.dots[w].name,x:y,y:z})}var C,D;o.connectLines.forEach(function(a){v.forEach(function(b){b.name===a.fromDot&&(C=b),b.name===a.toDot&&(D=b)}),b.strokeStyle=a.color,b.beginPath(),b.moveTo(C.x,C.y),b.lineTo(D.x,D.y),b.stroke(),b.closePath()})}var e=b.find("canvas")[0],f=1/0,g=-1/0,h=1/0,i=-1/0;a.$watch("ssffds.data.length",function(){$.isEmptyObject(a.cps.vals)||$.isEmptyObject(a.ssffds.data)||0!==a.ssffds.data.length&&d(a)},!0),a.$watch("vs.curViewPort",function(b,c){$.isEmptyObject(a.cps.vals)||$.isEmptyObject(a.ssffds.data)||0!==a.ssffds.data.length&&(c.sS!==b.sS||c.eS!==b.eS)&&d(a)},!0),a.$watch("vs.curMousePosSample",function(){$.isEmptyObject(a.cps.vals)||$.isEmptyObject(a.ssffds.data)||0!==a.ssffds.data.length&&d(a)},!0),a.$watch("vs.curPerspectiveIdx",function(){f=1/0,g=-1/0,h=1/0,i=-1/0},!0)}}}]),angular.module("emuwebApp").directive("myDropZone",["$animate",function(){return{templateUrl:"views/myDropZone.html",restrict:"E",link:function(a,b){function c(b){b.preventDefault(),a.$apply(function(){a.dropText=a.dropDefault,a.dropClass=""})}function d(b){b.preventDefault(),a.$apply(function(){a.dropText=a.dropAllowed,a.dropClass="over"})}function e(b){b.stopPropagation(),b.preventDefault(),a.$apply(function(){if(a.dropText=a.dropParsingStarted,a.dropClass="",window.File&&window.FileReader&&window.FileList&&window.Blob)if(a.dropText=a.dropParsingStarted,a.dropClass="over",void 0!==b.originalEvent)if(a.firefox)for(var c=b.originalEvent.dataTransfer,d=c.files,e=(d.length,0);e<d.length;e++)a.traverseFileTreeFirefox(d[e]);else for(var f=b.originalEvent.dataTransfer.items,e=0;e<f.length;e++){var g=f[e].webkitGetAsEntry();g&&a.traverseFileTreeChrome(g)}else a.dropText=a.dropErrorFileType,a.dropClass="";else a.$parent.dials.open("views/error.html","ModalCtrl",a.dropErrorAPI),a.dropText=$scope.dropDefault})}a.dropDefault="Drop your files here or click here to open a file",a.dropErrorFileType="Error: Could not parse file. The following file types are supported: .WAV .TEXTGRID",a.dropErrorAPI="Sorry ! The File APIs are not fully supported in your browser.",a.dropNotAllowed="File is not allowed",a.dropAllowed="Drop files to start loading",a.dropParsingStarted="Parsing started",a.dropText=a.dropDefault,a.dropClass="",b.bind("drop",function(a){e(a)}),b.bind("dragover",function(a){d(a)}),b.bind("dragenter",function(a){c(a)}),b.bind("dragleave",function(a){c(a)}),b.bind("click",function(){b.context.children[0].children[1].click()})}}}]),angular.module("emuwebApp").directive("myDropZoneInput",["$animate",function(){return{templateUrl:"views/myDropZoneInput.html",restrict:"E",link:function(a,b){function c(){a.handler=!0;var c=b.context.children.fileDialog;if(a.firefox)for(var d=0;d<c.files.length;d++){var e=c.files[d],f=e.name.substr(e.name.lastIndexOf(".")+1).toUpperCase();"WAV"===f&&e.type.match("audio/x-wav")?(a.wav=e,a.handleLocalFiles()):"TEXTGRID"===f?a.grid=e:a.other=e}else for(var d=0;d<c.files.length;d++){var e=c.files[d],f=e.name.substr(e.name.lastIndexOf(".")+1).toUpperCase();"WAV"===f&&e.type.match("audio/wav")?(a.wav=e,a.handleLocalFiles()):"TEXTGRID"===f?a.grid=e:a.other=e}}a.handler=!1,b.bind("change",function(a){c(a)}),b.bind("click",function(){var a=angular.element("input");void 0!==a[1]&&a[1].click()})}}}]),angular.module("emuwebApp").directive("emuwebapp",["viewState","Iohandlerservice","ConfigProviderService",function(a,b,c){return{templateUrl:"views/emuwebapp.html",restrict:"E",scope:{audioGetUrl:"@",labelGetUrl:"@",labelType:"@"},link:function(b,d,e){d.bind("mouseenter",function(){a.mouseInEmuWebApp=!0}),d.bind("mouseleave",function(){a.mouseInEmuWebApp=!1}),e.$observe("audioGetUrl",function(a){void 0!==a&&""!==a&&(c.embeddedVals.audioGetUrl=a)}),e.$observe("labelGetUrl",function(a){void 0!==a&&""!==a&&(c.embeddedVals.labelGetUrl=a)}),e.$observe("labelType",function(a){void 0!==a&&""!==a&&(c.embeddedVals.labelType=a)})}}}]),angular.module("emuwebApp").service("Validationservice",["$http","$q",function(a,b){var c={},d=[],e=["annotationFileSchema","emuwebappConfigSchema","DBconfigFileSchema","bundleListSchema"];return c.loadSchemas=function(){var c=[];return angular.forEach(e,function(b){c.push(a.get("schemaFiles/"+b+".json"))}),b.all(c)},c.setSchemas=function(a){angular.forEach(a,function(a){d.push({name:a.config.url,data:a.data})})},c.validateJSO=function(a,b){var c;return angular.forEach(d,function(b){b.name==="schemaFiles/"+a+".json"&&(c=b)}),void 0!==c&&tv4.validate(b,c.data)?!0:void 0===c?"Schema: "+a+" is currently undefined! This is probably due to a misnamed schema file on the server...":tv4.error},c}]),angular.module("emuwebApp").service("ArrayHelperService",["$q","dialogService",function(){var a={};return a.convertToAbsValues=function(a){for(var b=0;b<a.length;b++)a[b]=Math.abs(a[b]);return a},a.multiplyEachElement=function(a,b){for(var c=0;c<a.length;c++)a[c]=a[c]*b;return a},a.interp2points=function(a,b,c,d,e){return b+(d-b)*((e-a)/(c-a))},a.findMinMax=function(a,b){var c,d;if("min"===b){c=1/0;for(var e=0;e<a.length;e++)a[e]<c&&(c=a[e],d=e)}else if("max"===b){c=-1/0;for(var e=0;e<a.length;e++)a[e]>c&&(c=a[e],d=e)}return{val:c,idx:d}},a.flattenArrayOfArray=function(a){var b=[];return b=b.concat.apply(b,a)},a.convertArrayToXYjsoArray=function(a){for(var b=[],c=0;c<a.length;c++)b.push({x:c,y:a[c]});return b},a}]),angular.module("emuwebApp").service("AnagestService",["$q","$log","viewState","LevelService","ConfigProviderService","Ssffdataservice","ArrayHelperService","dialogService","HistoryService",function(a,b,c,d,e,f,g,h,i){var j,k={};return k.insertAnagestEvents=function(){var j=a.defer(),l=c.getItemsInSelection(d.data.levels);if(0!==l.length)return h.open("views/error.html","ModalCtrl","There are already events in the selected area! This is not permitted...").then(function(){j.reject()}),j;var m=e.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.verticalPosSsffTrackName,n=e.getSsffTrackConfig(m),o=f.getColumnOfTrack(n.name,n.columnName),p=f.getSampleRateAndStartTimeOfTrack(n.name),q=e.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.velocitySsffTrackName,r=e.getSsffTrackConfig(q),s=f.getColumnOfTrack(r.name,r.columnName);if(f.getSampleRateAndStartTimeOfTrack(r.name),1!==o.length||1!==s.length)return h.open("views/error.html","ModalCtrl","UPS... the column length of of one of the tracks is != 1 this means something is badly configured in the DB!!!").then(function(){j.reject()}),j;var t=g.flattenArrayOfArray(o.values),u=g.flattenArrayOfArray(s.values),v=[0/0,0/0],w=[0/0,0/0],x=[0/0,0/0],y=[0/0,0/0];u=g.convertToAbsValues(u);var z=c.getSelectedStartTime(),A=c.getSelectedEndTime(),B=Math.round(z*p.sampleRate+p.startTime),C=Math.round(A*p.sampleRate+p.startTime),D=C-B,E=t.slice(B,B+D),F=u.slice(B,B+D),G=g.findMinMax(E,"max");y[0]=G.idx;var H=g.findMinMax(F.slice(0,y[0]+1),"max");w[0]=H.idx;var I=g.findMinMax(F.slice(0,w[0]+1),"min");return b.info("Looking for gesture onset"),k.interactiveFindThresholds(F.slice(0,w[0]+1),I.val,H.val,e.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.threshold,1,"Looking for gesture onset").then(function(a){var l=a;v[0]=l;var m=g.findMinMax(F.slice(w[0],y[0]+1),"min"),n=m.idx+w[0];b.info("Looking for nucleus onset"),k.interactiveFindThresholds(F.slice(w[0],n+1),m.val,H.val,e.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.threshold,-1,"Looking for nucleus onset").then(function(a){var l=a;x[0]=l+w[0];var m=g.findMinMax(F.slice(y[0]),"max");w[1]=m.idx+y[0];var o=g.findMinMax(F.slice(y[0],w[1]+1),"min");n=o.idx+y[0],b.info("Looking for nucleus offset"),k.interactiveFindThresholds(F.slice(n,w[1]+1),o.val,m.val,e.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.threshold,1,"Looking for nucleus offset").then(function(a){var l=a;x[1]=l+n;var o=g.findMinMax(F.slice(w[1]),"min");n=o.idx+w[1],b.info("Looking for gesture offset"),k.interactiveFindThresholds(F.slice(w[1],n+1),o.val,m.val,e.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.threshold,-1,"Looking for gesture offset").then(function(a){var b=a;v[1]=b+w[1];var g;v[0]=f.calculateSamplePosInVP(B+v[0],p.sampleRate,p.startTime),v[1]=f.calculateSamplePosInVP(B+v[1],p.sampleRate,p.startTime),g=e.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.gestureOnOffsetLabels[0];var k=d.insertPoint(c.getcurClickLevelName(),v[0],g);i.updateCurChangeObj({type:"ESPS",action:"INSERTPOINT",name:c.getcurClickLevelName(),start:v[0],id:k.id,pointName:g}),g=e.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.gestureOnOffsetLabels[1];var l=d.insertPoint(c.getcurClickLevelName(),v[1],g);i.updateCurChangeObj({type:"ESPS",action:"INSERTPOINT",name:c.getcurClickLevelName(),start:v[1],id:l.id,pointName:g}),w[0]=f.calculateSamplePosInVP(B+w[0],p.sampleRate,p.startTime),w[1]=f.calculateSamplePosInVP(B+w[1],p.sampleRate,p.startTime),g=e.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.maxVelocityOnOffsetLabels[0];var m=d.insertPoint(c.getcurClickLevelName(),w[0],g);i.updateCurChangeObj({type:"ESPS",action:"INSERTPOINT",name:c.getcurClickLevelName(),start:w[0],id:m.id,pointName:g}),g=e.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.maxVelocityOnOffsetLabels[1];var n=d.insertPoint(c.getcurClickLevelName(),w[1],g);i.updateCurChangeObj({type:"ESPS",action:"INSERTPOINT",name:c.getcurClickLevelName(),start:w[1],id:n.id,pointName:g}),x[0]=f.calculateSamplePosInVP(B+x[0],p.sampleRate,p.startTime),x[1]=f.calculateSamplePosInVP(B+x[1],p.sampleRate,p.startTime),g=e.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.constrictionPlateauBeginEndLabels[0];var o=d.insertPoint(c.getcurClickLevelName(),x[0],g);i.updateCurChangeObj({type:"ESPS",action:"INSERTPOINT",name:c.getcurClickLevelName(),start:x[0],id:o.id,pointName:g}),g=e.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.constrictionPlateauBeginEndLabels[1];var q=d.insertPoint(c.getcurClickLevelName(),x[1],g);i.updateCurChangeObj({type:"ESPS",action:"INSERTPOINT",name:c.getcurClickLevelName(),start:x[1],id:q.id,pointName:g}),y[0]=f.calculateSamplePosInVP(B+y[0],p.sampleRate,p.startTime),g=e.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.maxConstrictionLabel;var r=d.insertPoint(c.getcurClickLevelName(),y[0],g);i.updateCurChangeObj({type:"ESPS",action:"INSERTPOINT",name:c.getcurClickLevelName(),start:y[0],id:r.id,pointName:g});var s=e.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.autoLinkLevelName,t=d.getLevelDetails(s),u=d.getAllLabelsOfLevel(t);console.log(u),h.open("views/SelectLabelModal.html","SelectLabelModalCtrl",u).then(function(a){var b=[k.id,l.id,m.id,n.id,o.id,q.id,r.id];d.addLinkToParent(t.level.items[a].id,b),i.updateCurChangeObj({type:"ESPS",action:"LINKTOPARENT",parentID:t.level.items[a].id,childIDs:b}),i.addCurChangeObjToUndoStack()}),j.resolve()})})})},function(){console.error("rejected duuuude!!!!")}),j.promise},k.interactiveFindThresholds=function(b,c,d,e,f,i){var k=c+(d-c)*e,l=f;k*=l;for(var m=g.multiplyEachElement(b,l),n=m.length,o=m.slice(1,n),p=0,q=n-1,r=[],s=0;s<m.length;s++)o[s]>=k&&m[s]<k&&r.push(s);for(var t=[],s=0;s<r.length;s++)r[s]>=p&&r[s]<=q&&t.push(s);if(t.length>1){j=a.defer();var u={};u.description=i,u.options=[],u.y=m,u.minVal=c,u.maxVal=d,u.threshold=e;for(var s=0;s<r.length;s++)u.options.push({thresholdIdx:r[s],thresholdValue:m[s]});return h.open("views/SelectThresholdModal.html","SelectThresholdModalCtrl",u).then(function(a){var b=r[t[a]];b=g.interp2points(m[b],b,m[b+1],b+1,k),j.resolve(b)}),j.promise}if(0===t.length)return j=a.defer(),h.open("views/error.html","ModalCtrl","Could not find any values that step over the threshold!!").then(function(){j.reject("Could not find any values that step over the threshold!!")}),j.promise;j=a.defer();var v=r[t[0]];return v=g.interp2points(m[v],v,m[v+1],v+1,k),j.resolve(v),j.promise},k}]),angular.module("emuwebApp").directive("lineChart",function(){return{restrict:"E",scope:{data:"=",threshold:"="},link:function(a,b){a.$watch("data",function(){a.render(a.data)},!0);var c={top:20,right:20,bottom:20,left:40},d=400-c.left-c.right,e=200-c.top-c.bottom,f=d3.select(b[0]).append("svg").attr("width",d+c.left+c.right).attr("height",e+c.top+c.bottom).append("g").attr("transform","translate("+c.left+","+c.top+")"),g=d3.scale.linear().range([0,d]),h=d3.scale.linear().range([e,0]),i=d3.svg.axis().scale(g).tickSize(5).tickSubdivide(!0),j=d3.svg.axis().scale(h).orient("left"),k=d3.svg.line().x(function(a){return g(a.x)}).y(function(a){return h(a.y)}).interpolate("linear");a.render=function(b){g.domain([d3.min(b,function(a){return a.x}),d3.max(b,function(a){return a.x})]),h.domain([d3.min(b,function(a){return a.y}),d3.max(b,function(a){return a.y})]),f.selectAll("g.axis").remove(),f.append("g").attr("class","x axis").attr("transform","translate(0,"+e+")").call(i),f.append("g").attr("class","y axis").call(j),f.append("svg:path").attr("d",k(b)).attr("stroke","red").attr("stroke-width",1).attr("fill","none"),f.append("svg:line").attr("x1",5).attr("y1",5).attr("x2",200).attr("y2",200).attr("class","label-line"),f.append("line").attr({x1:g(a.threshold),y1:0,x2:g(a.threshold),y2:e}).attr("stroke","steelblue").attr("class","verticalLine")}}}});