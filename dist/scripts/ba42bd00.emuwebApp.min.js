"use strict";ArrayBuffer.prototype.subarray=function(a,b){for(var c=new ArrayBuffer(b),d=new Int8Array(c),e=new Int8Array(this),f=0;b>f;f++)d[f]=e[a+f];return c},angular.module("emuwebApp",["ui","ui.bootstrap","ngAnimate"]).config(["$locationProvider",function(a){a.html5Mode(!0)}]),angular.module("emuwebApp").service("ConfigProviderService",["viewState",function(a){var b={};return b.vals={},b.curDbConfig={},b.embeddedVals={audioGetUrl:"",labelGetUrl:"",labelType:"",fromUrlParams:!1},b.setVals=function(a){$.isEmptyObject(b.vals)?b.vals=a:angular.forEach(Object.keys(a),function(c){angular.isArray(b.vals[c])?(b.vals[c]=[],angular.forEach(a[c],function(a){b.vals[c].push(a)})):angular.forEach(Object.keys(a[c]),function(d){void 0!==b.vals[c][d]?b.vals[c][d]=a[c][d]:console.error("BAD ENTRY IN CONFIG! Key1: "+c+" key2: "+d)})})},b.getSsffTrackConfig=function(a){var c;return void 0!==b.curDbConfig.ssffTracks&&angular.forEach(b.curDbConfig.ssffTracks,function(b){b.name===a&&(c=b)}),c},b.getLimsOfTrack=function(c){var d={};return angular.forEach(b.vals.perspectives[a.curPerspectiveIdx].signalCanvases.contourLims,function(a){a.ssffTrackName===c&&(d.min=a.min,d.max=a.max)}),d},b.getAssignment=function(c){var d={};return angular.forEach(b.vals.perspectives[a.curPerspectiveIdx].signalCanvases.assign,function(a){a.signalCanvasName===c&&(d=a)}),d},b.getLevelDefinition=function(a){var c={};return angular.forEach(b.curDbConfig.levelDefinitions,function(b){b.name===a&&(c=b)}),c},b}]),angular.module("emuwebApp").controller("MainCtrl",["$scope","$rootScope","$modal","$log","$compile","$timeout","$q","$window","$document","$location","viewState","HistoryService","Iohandlerservice","Soundhandlerservice","ConfigProviderService","fontScaleService","Ssffdataservice","LevelService","dialogService","Textgridparserservice","Espsparserservice","Binarydatamaniphelper","Wavparserservice","Ssffparserservice","Drawhelperservice","Validationservice","Appcachehandler",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A){a.cps=o,a.hists=l,a.fontImage=p,a.levServ=r,a.vs=k,a.dials=s,a.ssffds=q,a.shs=n,a.dhs=y,a.wps=w,a.io=m,a.ach=A,a.connectBtnLabel="connect",a.tmp={},a.dbLoaded=!1,a.is2dCancasesHidden=!0,a.lastkeycode="N/A",a.bundleList=[],a.curUserName="",a.curBndl={},a.lastclickedutt=null,a.filterText="",a.windowWidth=h.outerWidth,a.demoDbName="",a.firefox=navigator.userAgent.match(/Firefox/i)?!0:!1,a.ach.checkForNewVersion(),angular.element(h).bind("resize",function(){r.deleteEditArea(),k.setWindowWidth(h.outerWidth),a.$digest()}),angular.element(h).bind("keyup",function(b){(b.keyCode===o.vals.keyMappings.shift||b.keyCode===o.vals.keyMappings.alt)&&(l.addCurChangeObjToUndoStack(),a.$digest())}),window.onbeforeunload=function(){return""===o.embeddedVals.audioGetUrl&&a.bundleList.length>0&&!o.vals.main.autoConnect?"Do you really wish to leave/reload the EMU-webApp? All unsaved changes will be lost...":void 0};var B=j.search();B.audioGetUrl&&B.labelGetUrl&&B.labelType&&(o.embeddedVals.audioGetUrl=B.audioGetUrl,o.embeddedVals.labelGetUrl=B.labelGetUrl,o.embeddedVals.labelType=B.labelType,o.embeddedVals.fromUrlParams=!0),a.loadFilesForEmbeddedApp=function(){o.embeddedVals.audioGetUrl&&m.httpGetPath(o.embeddedVals.audioGetUrl,"arraybuffer").then(function(b){k.showDropZone=!1;var c=o.embeddedVals.audioGetUrl;a.curBndl.name=c.substr(0,c.lastIndexOf(".")).substr(c.lastIndexOf("/")+1,c.length),k.getsubmenuOpen()&&a.openSubmenu(),k.somethingInProgressTxt="Loading DB config...",m.httpGetPath("configFiles/embedded_emuwebappConfig.json").then(function(a){k.curPerspectiveIdx=0,o.setVals(a.data.EMUwebAppConfig),delete a.data.EMUwebAppConfig;var c=z.validateJSO("emuwebappConfigSchema",o.vals);c===!0?(o.embeddedVals.fromUrlParams&&(o.vals.main.catchMouseForKeyBinding=!1),o.curDbConfig=a.data,c=z.validateJSO("DBconfigFileSchema",o.curDbConfig),c===!0?(k.somethingInProgress=!0,k.somethingInProgressTxt="Parsing WAV file...",w.parseWavArrBuf(b.data).then(function(a){var b=a;k.curViewPort.sS=0,k.curViewPort.eS=b.Data.length,k.resetSelect(),n.wavJSO=b,m.httpGetPath(o.embeddedVals.labelGetUrl,"utf-8").then(function(a){k.somethingInProgressTxt="Parsing "+o.embeddedVals.labelType+" file...",m.parseLabelFile(a.data,o.embeddedVals.labelGetUrl,"embeddedTextGrid",o.embeddedVals.labelType).then(function(a){var b=a.data;r.setData(b);var c=[];b.levels.forEach(function(a){c.push(a.name)}),o.vals.perspectives[k.curPerspectiveIdx].levelCanvases.order=c,k.somethingInProgressTxt="Done!",k.somethingInProgress=!1,k.setState("labeling")},function(a){s.open("views/error.html","ModalCtrl","Error parsing wav file: "+a.status.message)})},function(a){s.open("views/error.html","ModalCtrl","Could not get label file: "+o.embeddedVals.labelGetUrl+" ERROR "+JSON.stringify(a,null,4))})},function(a){s.open("views/error.html","ModalCtrl","Error parsing wav file: "+a.status.message)})):s.open("views/error.html","ModalCtrl","Error validating DBconfig: "+JSON.stringify(c,null,4))):s.open("views/error.html","ModalCtrl","Error validating ConfigProviderService.vals (emuwebappConfig data) after applying changes of newly loaded config (most likely due to wrong entry...): "+JSON.stringify(c,null,4))},function(a){s.open("views/error.html","ModalCtrl","Could not get embedded_config.json: "+a)})},function(a){s.open("views/error.html","ModalCtrl","Could not get audio file:"+o.embeddedVals.audioGetUrl+" ERROR: "+JSON.stringify(a,null,4))})},a.loadDefaultConfig=function(){k.somethingInProgress=!0,k.somethingInProgressTxt="Loading schema files",z.loadSchemas().then(function(b){z.setSchemas(b),m.httpGetDefaultConfig().success(function(b){k.somethingInProgressTxt="Validating emuwebappConfig";var c=z.validateJSO("emuwebappConfigSchema",b);c===!0?(o.setVals(b),a.handleDefaultConfigLoaded(),a.loadFilesForEmbeddedApp(),k.somethingInProgress=!1):s.open("views/error.html","ModalCtrl","Error validating emuwebappConfigSchema: "+JSON.stringify(c,null,4)).then(function(){a.resetToInitState()})}).error(function(b,c,d,e){s.open("views/error.html","ModalCtrl","Could not get defaultConfig for EMU-webApp:  status: "+c+" header: "+d+" config "+e).then(function(){a.resetToInitState()})})},function(b){s.open("views/error.html","ModalCtrl","Error loading schema file: "+JSON.stringify(b,null,4)).then(function(){a.resetToInitState()})})},a.loadDefaultConfig(),a.handleDefaultConfigLoaded=function(){k.getsubmenuOpen()||a.openSubmenu(),o.vals.main.autoConnect&&m.wsH.initConnect(o.vals.main.serverUrl).then(function(b){"error"===b.type?s.open("views/error.html","ModalCtrl","Could not connect to websocket server: "+o.vals.main.defaultServerUrl):a.handleConnectedToWSserver()}),k.setspectroSettings(o.vals.spectrogramSettings.N,o.vals.spectrogramSettings.rangeFrom,o.vals.spectrogramSettings.rangeTo,o.vals.spectrogramSettings.dynamicRange,o.vals.spectrogramSettings.window,o.vals.spectrogramSettings.drawHeatMapColors,o.vals.spectrogramSettings.preEmphasisFilterFactor,o.vals.spectrogramSettings.heatMapColorAnchors),k.setTransitionTime(o.vals.colors.transitionTime/1e3)},a.handleConnectedToWSserver=function(){k.showDropZone=!1,o.vals.main.comMode="WS",k.somethingInProgress=!0,k.somethingInProgressTxt="Checking protocol...",m.getProtocol().then(function(b){"EMU-webApp-websocket-protocol"===b.protocol&&"0.0.1"===b.version?(k.somethingInProgressTxt="Checking user management...",m.getDoUserManagement().then(function(b){"NO"===b?a.innerHandleConnectedToWSserver():s.open("views/loginModal.html","LoginCtrl").then(function(b){b?a.innerHandleConnectedToWSserver():a.resetToInitState()})})):s.open("views/error.html","ModalCtrl","Could not connect to websocket server: "+o.vals.main.serverUrl+'. It does not speak the same protocol as this client. Its protocol answer was: "'+b.protocol+'" with the version: "'+b.version+'"').then(function(){a.resetToInitState()})})},a.innerHandleConnectedToWSserver=function(){k.somethingInProgressTxt="Loading DB config...",m.getDBconfigFile().then(function(b){k.curPerspectiveIdx=0,o.setVals(b.EMUwebAppConfig),delete b.EMUwebAppConfig;var c=z.validateJSO("emuwebappConfigSchema",o.vals);c===!0?(o.curDbConfig=b,k.setCurLevelAttrDefs(o.curDbConfig.levelDefinitions),c=z.validateJSO("DBconfigFileSchema",b),c===!0?(k.somethingInProgressTxt="Loading bundle list...",m.getBundleList().then(function(b){c=z.validateJSO("bundleListSchema",b),c===!0?(a.bundleList=b,a.menuBundleClick(a.bundleList[0])):s.open("views/error.html","ModalCtrl","Error validating bundleList: "+JSON.stringify(c,null,4)).then(function(){a.resetToInitState()})})):s.open("views/error.html","ModalCtrl","Error validating DBconfig: "+JSON.stringify(c,null,4)).then(function(){a.resetToInitState()})):s.open("views/error.html","ModalCtrl","Error validating ConfigProviderService.vals (emuwebappConfig data) after applying changes of newly loaded config (most likely due to wrong entry...): "+JSON.stringify(c,null,4)).then(function(){a.resetToInitState()})})},a.menuBundleClick=function(b){0!==l.movesAwayFromLastSave&&"DEMO"!==o.vals.main.comMode?b!==a.curBndl&&(a.lastclickedutt=b,s.open("views/saveChanges.html","ModalCtrl",b.name).then(function(c){"saveChanges"===c?a.menuBundleSaveBtnClick().then(function(){a.menuBundleClick(b)}):"discardChanges"===c&&(l.resetToInitState(),a.menuBundleClick(b))})):b!==a.curBndl&&(l.resetToInitState(),k.setState("loadingSaving"),k.somethingInProgress=!0,k.somethingInProgressTxt="Loading bundle: "+b.name,q.data=[],m.getBundle(b.name,a.demoDbName).then(function(c){200===c.status&&(c=c.data);var d;d=v.base64ToArrayBuffer(c.mediaFile.data),k.somethingInProgressTxt="Parsing WAV file...",w.parseWavArrBuf(d).then(function(d){var e=d;k.curViewPort.sS=0,k.curViewPort.eS=e.Data.length,k.curViewPort.selectS=-1,k.curViewPort.selectE=-1,k.curClickSegments=[],k.curClickLevelName=void 0,k.curClickLevelType=void 0,k.resetSelect(),n.wavJSO=e,k.somethingInProgressTxt="Parsing SSFF files...",x.asyncParseSsffArr(c.ssffFiles).then(function(d){q.data=d.data;var e=z.validateJSO("annotationFileSchema",c.annotation);e===!0?(r.setData(c.annotation),a.curBndl=b,k.setState("labeling"),k.somethingInProgress=!1,k.somethingInProgressTxt="Done!"):s.open("views/error.html","ModalCtrl","Error validating annotation file: "+JSON.stringify(e,null,4)).then(function(){a.resetToInitState()})},function(b){s.open("views/error.html","ModalCtrl","Error parsing SSFF file: "+b.status.message).then(function(){a.resetToInitState()})})},function(b){s.open("views/error.html","ModalCtrl","Error parsing wav file: "+b.status.message).then(function(){a.resetToInitState()})})},function(b){b.data?s.open("views/error.html","ModalCtrl","Error loading bundle: "+b.data).then(function(){a.resetToInitState()}):s.open("views/error.html","ModalCtrl","Error loading bundle: "+b.status.message).then(function(){a.resetToInitState()})}))},a.menuBundleSaveBtnClick=function(){if(k.getPermission("saveBndlBtnClick")){var b=g.defer();k.somethingInProgress=!0,k.setState("loadingSaving");var c={};k.somethingInProgressTxt="Creating bundle json...",c.ssffFiles=[];var e={};return q.data.forEach(function(a){"FORMANTS"===a.ssffTrackName&&(e=a)}),$.isEmptyObject(e)?a.getAnnotationAndSaveBndl(c,b):x.asyncJso2ssff(e).then(function(d){c.ssffFiles.push({ssffTrackName:e.ssffTrackName,encoding:"BASE64",data:v.arrayBufferToBase64(d.data)}),a.getAnnotationAndSaveBndl(c,b)},function(a){s.open("views/error.html","ModalCtrl","Error converting javascript object to ssff file: "+a.status.message),b.reject()}),b.promise}d.info("Action: menuBundleSaveBtnClick not allowed!")},a.getAnnotationAndSaveBndl=function(b,c){b.annotation=r.getData(),k.somethingInProgressTxt="Saving bundle...",m.saveBundle(b).then(function(){k.somethingInProgressTxt="Done!",k.somethingInProgress=!1,l.movesAwayFromLastSave=0,c.resolve(),k.setState("labeling")},function(b){s.open("views/error.html","ModalCtrl","Error saving bundle: "+b.status.message).then(function(){a.resetToInitState()}),c.reject()})},a.uttIsDisabled=function(b){return b.name===a.curBndl.name?!1:!0},a.getEnlarge=function(a){var b=o.vals.perspectives[k.curPerspectiveIdx].signalCanvases.order.length;return-1==k.getenlarge()?"auto":2==b?k.getenlarge()==a?"75%":"25%":k.getenlarge()==a?Math.floor(100/b*(b-1))+"%":Math.floor(100/b/(b-1))+"%"},a.getBndlColor=function(b){var c;return c=0!==l.movesAwayFromLastSave?{"background-color":"#f00",color:"white"}:{"background-color":"#999",color:"black"},b.name===a.curBndl.name?c:void 0},a.cursorInTextField=function(){k.focusInTextField=!0},a.cursorOutOfTextField=function(){k.focusInTextField=!1},a.openSubmenu=function(){k.setsubmenuOpen(k.getsubmenuOpen()?!1:!0),f(a.refreshTimeline,o.vals.colors.transitionTime)},a.refreshTimeline=function(){a.$broadcast("refreshTimeline")},a.addLevelSegBtnClick=function(){if(k.getPermission("addLevelSegBtnClick")){var a,b;void 0===r.data.levels?(a="levelNr0",b=0):(a="levelNr"+r.data.levels.length,b=r.data.levels.length);var c={items:[{id:r.getNewId(),sampleStart:0,sampleDur:n.wavJSO.Data.length,labels:[{name:a,value:o.vals.labelCanvasConfig.newSegmentName}]}],name:a,type:"SEGMENT"};r.addLevel(c,b,k.curPerspectiveIdx),l.addObjToUndoStack({type:"ESPS",action:"addLevel",level:c,id:r.data.levels.length-1,curPerspectiveIdx:k.curPerspectiveIdx})}else console.log("action currently not allowed")},a.addLevelPointBtnClick=function(){if(k.getPermission("addLevelPointBtnClick")){var a="levelNr"+r.data.levels.length,b={items:[{id:r.getNewId(),samplePoint:n.wavJSO.Data.length/2,labels:[{name:a,value:o.vals.labelCanvasConfig.newEventName}]}],name:a,type:"EVENT"};r.addLevel(b,r.data.levels.length,k.curPerspectiveIdx),l.addObjToUndoStack({type:"ESPS",action:"addLevel",level:b,id:r.data.levels.length-1,curPerspectiveIdx:k.curPerspectiveIdx})}else console.log("action currently not allowed")},a.renameSelLevelBtnClick=function(){k.getPermission("renameSelLevelBtnClick")?void 0!==k.getcurClickLevelName()?s.open("views/renameLevel.html","ModalCtrl",k.getcurClickLevelName()):s.open("views/error.html","ModalCtrl","Rename Error : Please choose a Level first !"):console.log("action currently not allowed")},a.downloadTextGridBtnClick=function(){k.getPermission("downloadTextGridBtnClick")?t.asyncToTextGrid().then(function(b){s.openExport("views/export.html","ExportCtrl",b.data,a.curBndl.name+".TextGrid")}):console.log("action currently not allowed")},a.spectSettingsBtnClick=function(){k.getPermission("spectSettingsChange")?s.open("views/spectSettings.html","spectSettingsCtrl",""):console.log("action currently not allowed")},a.connectBtnClick=function(){k.getPermission("connectBtnClick")?s.open("views/connectModal.html","WsconnectionCtrl").then(function(b){b&&m.wsH.initConnect(b).then(function(c){"error"===c.type?s.open("views/error.html","ModalCtrl","Could not connect to websocket server: "+b):a.handleConnectedToWSserver()})}):console.log("action currently not allowed")},a.openDemoDBbtnClick=function(b){k.getPermission("openDemoBtnDBclick")&&(a.demoDbName=b,k.showDropZone=!1,k.somethingInProgress=!0,k.setState("loadingSaving"),o.vals.main.comMode="DEMO",k.somethingInProgressTxt="Loading DB config...",m.getDBconfigFile(b).then(function(c){var d=c.data;k.curPerspectiveIdx=0,o.setVals(d.EMUwebAppConfig),delete d.EMUwebAppConfig;var e=z.validateJSO("emuwebappConfigSchema",o.vals);e===!0?(o.curDbConfig=d,k.setCurLevelAttrDefs(o.curDbConfig.levelDefinitions),e=z.validateJSO("DBconfigFileSchema",o.curDbConfig),e===!0?(k.somethingInProgressTxt="Loading bundle list...",m.getBundleList(b).then(function(b){var c=b.data;e=z.validateJSO("bundleListSchema",c),e===!0?(a.bundleList=c,a.menuBundleClick(a.bundleList[0])):s.open("views/error.html","ModalCtrl","Error validating bundleList: "+JSON.stringify(e,null,4)).then(function(){a.resetToInitState()})},function(c){s.open("views/error.html","ModalCtrl","Error loading bundle list of "+b+": "+c.data+" STATUS: "+c.status).then(function(){a.resetToInitState()})})):s.open("views/error.html","ModalCtrl","Error validating DBconfig: "+JSON.stringify(e,null,4)).then(function(){a.resetToInitState()})):s.open("views/error.html","ModalCtrl","Error validating ConfigProviderService.vals (emuwebappConfig data) after applying changes of newly loaded config (most likely due to wrong entry...): "+JSON.stringify(e,null,4)).then(function(){a.resetToInitState()})},function(c){s.open("views/error.html","ModalCtrl","Error loading DB config of "+b+": "+c.data+" STATUS: "+c.status).then(function(){a.resetToInitState()})}))},a.aboutBtnClick=function(){s.open("views/about.html","AboutCtrl")},a.clearBtnClick=function(){var b;b=0!==l.movesAwayFromLastSave&&"DEMO"!==o.vals.main.comMode?"Do you wish to clear all loaded data and if connected disconnect from the server? CAUTION: YOU HAVE UNSAVED CHANGES! These will be lost if you confirm.":"Do you wish to clear all loaded data and if connected disconnect from the server? You have NO unsaved changes so no changes will be lost.",s.open("views/confirmModal.html","ConfirmmodalCtrl",b).then(function(b){b&&a.resetToInitState()})},a.resetToInitState=function(){m.wsH.isConnected()&&m.wsH.closeConnect(),a.curBndl={},a.bundleList=[],n.wavJSO={},r.data={},q.data=[],l.resetToInitState(),k.setState("noDBorFilesloaded"),a.$broadcast("resetToInitState"),k.somethingInProgress=!1,k.resetToInitState(),k.showDropZone=!0,a.loadDefaultConfig()},a.cmdZoomAll=function(){k.getPermission("zoom")?(r.deleteEditArea(),k.setViewPort(0,n.wavJSO.Data.length)):console.log("action currently not allowed")},a.cmdZoomIn=function(){k.getPermission("zoom")?(r.deleteEditArea(),k.zoomViewPort(!0)):console.log("action currently not allowed")},a.cmdZoomOut=function(){k.getPermission("zoom")?(r.deleteEditArea(),k.zoomViewPort(!1)):console.log("action currently not allowed")},a.cmdZoomLeft=function(){k.getPermission("zoom")?(r.deleteEditArea(),k.shiftViewPort(!1)):console.log("action currently not allowed")},a.cmdZoomRight=function(){k.getPermission("zoom")?(r.deleteEditArea(),k.shiftViewPort(!0)):console.log("action currently not allowed")},a.cmdZoomSel=function(){k.getPermission("zoom")?(r.deleteEditArea(),k.setViewPort(k.curViewPort.selectS,k.curViewPort.selectE)):console.log("action currently not allowed")},a.cmdPlayView=function(){k.getPermission("playaudio")?(n.playFromTo(k.curViewPort.sS,k.curViewPort.eS),k.animatePlayHead(k.curViewPort.sS,k.curViewPort.eS)):console.log("action currently not allowed")},a.cmdPlaySel=function(){k.getPermission("playaudio")?(n.playFromTo(k.curViewPort.selectS,k.curViewPort.selectE),k.animatePlayHead(k.curViewPort.selectS,k.curViewPort.selectE)):console.log("action currently not allowed")},a.cmdPlayAll=function(){k.getPermission("playaudio")?(n.playFromTo(0,n.wavJSO.Data.length),k.animatePlayHead(0,n.wavJSO.Data.length)):console.log("action currently not allowed")},a.setlastkeycode=function(b){a.lastkeycode=b},a.toggleRightSideMenuHidden=function(){k.setRightsubmenuOpen(!k.getRightsubmenuOpen())},a.changePerspective=function(b){for(var c,d=0;d<o.vals.perspectives.length;d++)b.name===o.vals.perspectives[d].name&&(c=d);k.curPerspectiveIdx=c,a.toggleRightSideMenuHidden()},a.getPerspectiveColor=function(a){var b;return b=-1===k.curPerspectiveIdx||a.name===o.vals.perspectives[k.curPerspectiveIdx].name?"emuwebapp-curSelPerspLi":"emuwebapp-perspLi"}}]),angular.module("emuwebApp").controller("FileCtrl",["$scope","Binarydatamaniphelper","Textgridparserservice","ConfigProviderService","Validationservice",function(a,b,c,d,e){a.newfiles=[],a.wav={},a.grid={},a.curBndl={},a.resetToInitState=function(){a.newfiles=[],a.wav={},a.grid={},a.curBndl={},a.dropText=a.dropDefault},a.$on("resetToInitState",function(){a.resetToInitState()}),a.handleLocalFiles=function(){a.$parent.vs.showDropZone=!1,a.$parent.cps.vals.main.comMode="FileAPI",a.$parent.vs.setState("loadingSaving"),a.$parent.hists.resetToInitState(),a.$parent.vs.somethingInProgress=!0,a.$parent.vs.somethingInProgressTxt="Loading local File: "+a.wav.name,a.$parent.ssffds.data=[],a.$parent.levServ.data={},a.$parent.vs.somethingInProgressTxt="Parsing WAV file...";var b=new FileReader;b.readAsArrayBuffer(a.wav),b.onloadend=function(b){b.target.readyState==FileReader.DONE&&a.$parent.io.httpGetPath("configFiles/standalone_emuwebappConfig.json").then(function(f){a.$parent.vs.curPerspectiveIdx=0,a.$parent.cps.setVals(f.data.EMUwebAppConfig),delete f.data.EMUwebAppConfig;var g=e.validateJSO("emuwebappConfigSchema",d.vals);if(g===!0){a.$parent.cps.curDbConfig=f.data,a.curBndl={},a.curBndl.name=a.wav.name.substr(0,a.wav.name.lastIndexOf(".")),a.$parent.bundleList.push(a.curBndl),a.$parent.curBndl=a.curBndl;var h;h=a.firefox?b.target.result:b.currentTarget.result,a.$parent.wps.parseWavArrBuf(h).then(function(b){if(a.$parent.vs.curViewPort.sS=0,a.$parent.vs.curViewPort.eS=b.Data.length,a.$parent.vs.resetSelect(),a.$parent.vs.curPerspectiveIdx=0,a.$parent.shs.wavJSO=b,$.isEmptyObject(a.grid))a.$parent.vs.setState("labeling"),a.$parent.vs.somethingInProgress=!1,a.$parent.vs.somethingInProgressTxt="Done!";else{var d=new FileReader;d.readAsText(a.grid),d.onloadend=function(b){if(b.target.readyState==FileReader.DONE){var d=a.wav.name.substr(0,a.wav.name.lastIndexOf("."));c.asyncParseTextGrid(b.currentTarget.result,a.wav.name,d).then(function(b){var c=b.data;a.$parent.levServ.setData(c);var d=[];c.levels.forEach(function(a){d.push(a.name)}),a.$parent.cps.vals.perspectives[a.$parent.vs.curPerspectiveIdx].levelCanvases.order=d,a.$parent.vs.somethingInProgressTxt="Done!",a.$parent.vs.somethingInProgress=!1,a.$parent.vs.setState("labeling")})}},function(b){a.$parent.dials.open("views/error.html","ModalCtrl","Error parsing textgrid file: "+b.status.message)}}})}else a.$parent.dials.open("views/error.html","ModalCtrl","Error validating ConfigProviderService.vals (emuwebappConfig data) : "+JSON.stringify(g,null,4))},function(b){a.$parent.dials.open("views/error.html","ModalCtrl","Error parsing wav file: "+b.status.message)})}},a.traverseFileTreeChrome=function(b,c){if(c=c||"",b.isFile)b.file(function(b){var c=b.name.substr(b.name.lastIndexOf(".")+1).toUpperCase();"WAV"===c?(a.wav=b,a.handleLocalFiles()):"TEXTGRID"===c?a.grid=b:(a.other=b,a.$parent.dials.open("views/error.html","ModalCtrl","Error: Unknown File Type for File "+a.other.name).then(function(){a.resetToInitState(),a.$parent.resetToInitState()}))});else if(b.isDirectory){var d=b.createReader();d.readEntries(function(d){for(var e=0;e<d.length;e++)a.traverseFileTreeChrome(d[e],c+b.name+"/")})}},a.traverseFileTreeFirefox=function(b,c){if(c=c||"",b.size>0){var d=b.name.substr(b.name.lastIndexOf(".")+1).toUpperCase();"WAV"===d?(a.wav=b,a.handleLocalFiles()):"TEXTGRID"===d?a.grid=b:(a.other=b,a.$parent.dials.open("views/error.html","ModalCtrl","Error: Unknown File Type for File "+a.other.name).then(function(){a.resetToInitState(),a.$parent.resetToInitState()}))}else if(b.isDirectory){var e=b.createReader();e.readEntries(function(d){for(var e=0;e<d.length;e++)a.traverseFileTreeFirefox(d[e],c+b.name+"/")})}}}]),angular.module("emuwebApp").directive("level",["$animate","viewState","ConfigProviderService","Drawhelperservice","HistoryService","fontScaleService","dialogService","LevelService",function(a,b,c,d,e,f,g,h){return{templateUrl:"views/level.html",restrict:"E",scope:{level:"=",idx:"="},link:function(i,j,k){function l(a,b,c){var d=c.vals.font.fontPxSize,e=b.getCurAttrDef(i.level.name);if($.isEmptyObject(a))return void console.log("undef levelDetails");if($.isEmptyObject(b))return void console.log("undef viewState");if($.isEmptyObject(c))return void console.log("undef config");i.open||(d-=1);var g=n[0].getContext("2d");g.clearRect(0,0,n[0].width,n[0].height);var h,j,k,l;h=b.getSampleDist(n[0].width);var m=g.canvas.height/g.canvas.offsetHeight;l=a.name===e?f.getTextImageTwoLines(g,a.name,"("+a.type+")",d,c.vals.font.fontType,c.vals.colors.labelColor,!0):f.getTextImageTwoLines(g,a.name+":"+e,"("+a.type+")",d,c.vals.font.fontType,c.vals.colors.labelColor,!0),g.drawImage(l,0,g.canvas.height/2-d*m);var o=(b.getcurMouseSegment(),b.getcurClickSegments(),b.getcurClickLevelName(),-1),p=(f.getTextImage(g,"m",d-2,c.vals.font.fontType,c.vals.colors.labelColor),f.getLastImageWidth()),q=(f.getTextImage(g,"0",d-4,c.vals.font.fontType,c.vals.colors.endBoundaryColor),f.getLastImageWidth());if("SEGMENT"===a.type){g.fillStyle=c.vals.colors.startBoundaryColor;var r=a.items;r.forEach(function(a){if(++o,a.sampleStart>=b.curViewPort.sS&&a.sampleStart<=b.curViewPort.eS||a.sampleStart+a.sampleDur>b.curViewPort.sS&&a.sampleStart+a.sampleDur<b.curViewPort.eS||a.sampleStart<b.curViewPort.sS&&a.sampleStart+a.sampleDur>b.curViewPort.eS){var h;if(a.labels.forEach(function(a){a.name===e&&(h=a.value)}),j=b.getPos(n[0].width,a.sampleStart),k=b.getPos(n[0].width,a.sampleStart+a.sampleDur),g.fillStyle=c.vals.colors.startBoundaryColor,g.fillRect(j,0,2,n[0].height/2),g.fillStyle=c.vals.colors.endBoundaryColor,g.fillRect(k,n[0].height/2,2,n[0].height),k-j>p*h.length){l=f.getTextImage(g,h,d-2,c.vals.font.fontType,c.vals.colors.labelColor);var m=f.getLastImageWidth(),r=j+(k-j)/2-m/2;i.open?g.drawImage(l,0,0,l.width,l.height,r,n[0].height/2-(d-2),l.width,l.height):g.drawImage(l,0,0,l.width,l.height,r,0,l.width,l.height)}if(i.open){var s=j+(k-j)/2,t=n[0].height/4;g.strokeStyle=c.vals.colors.startBoundaryColor,g.beginPath(),g.moveTo(j,t),g.lineTo(s,t),g.lineTo(s,t+5),g.stroke(),t=n[0].height/4*3,g.strokeStyle=c.vals.colors.endBoundaryColor,g.beginPath(),g.moveTo(k,t),g.lineTo(s,t),g.lineTo(s,t-5),g.stroke()}if(k-j>q*a.sampleStart.toString().length){var u=f.getTextImage(g,a.sampleStart,d-4,c.vals.font.fontType,c.vals.colors.endBoundaryColor);g.drawImage(u,0,0,l.width,l.height,j+3,0,l.width,l.height)}if(k-j>q*(5+a.sampleDur.toString().length)){var v=f.getTextImage(g,"dur: "+a.sampleDur,d-4,c.vals.font.fontType,c.vals.colors.endBoundaryColor),w=f.getLastImageWidth();g.drawImage(v,0,0,l.width,l.height,k-w,n[0].height/4*3,l.width,l.height)}}})}else if("EVENT"===a.type){g.fillStyle=c.vals.colors.startBoundaryColor;var s;a.items.forEach(function(a){if(a.samplePoint>b.curViewPort.sS&&a.samplePoint<b.curViewPort.eS){s=Math.round(b.getPos(n[0].width,a.samplePoint)+h/2);var i;a.labels.forEach(function(a){a.name===e&&(i=a.value)}),g.fillStyle=c.vals.colors.startBoundaryColor,g.fillRect(s,0,1,n[0].height/2-n[0].height/10),g.fillRect(s,n[0].height/2+n[0].height/10,1,n[0].height/2-n[0].height/10),l=f.getTextImage(g,i,d-2,c.vals.font.fontType,c.vals.colors.labelColor),g.drawImage(l,0,0,l.width,l.height,s-5,n[0].height/3,l.width,l.height),l=f.getTextImage(g,a.samplePoint,d-4,c.vals.font.fontType,c.vals.colors.endBoundaryColor),g.drawImage(l,0,0,l.width,l.height,s+5,0,l.width,l.height)}})}}function m(a,b,c){var e=n[1].getContext("2d");e.clearRect(0,0,n[1].width,n[1].height),a.name===b.getcurClickLevelName()&&(e.fillStyle=c.vals.colors.selectedLevelColor,e.fillRect(0,0,n[0].width,n[0].height)),d.drawMovingBoundaryLine(e),d.drawCurViewPortSelected(e);var f,g,h,i,j;f=b.getPos(n[1].width,b.curViewPort.selectS),g=b.getPos(n[1].width,b.curViewPort.selectE),h=b.getSampleDist(n[1].width);var k=b.getcurMouseSegment(),l=b.getcurClickSegments(),m=b.getcurClickLevelName();void 0!==l&&a.name===m&&l.length>0&&l.forEach(function(a){void 0!==a&&(void 0!==a.sampleStart?(f=Math.round(b.getPos(n[0].width,a.sampleStart)),g=Math.round(b.getPos(n[0].width,a.sampleStart+a.sampleDur))):(f=Math.round(b.getPos(n[0].width,a.samplePoint)+h/2),f-=5,g=f+10),e.fillStyle=c.vals.colors.selectedSegmentColor,e.fillRect(f,0,g-f,n[0].height),e.fillStyle=c.vals.colors.startBoundaryColor)}),j=b.getcurMouseSegment(),void 0!==j&&void 0!==k&&a.name===b.getcurMouseLevelName()&&(e.fillStyle=c.vals.colors.selectedBoundaryColor,k===!1?"SEGMENT"===b.getcurMouseLevelType()&&(j=a.items[0],f=Math.round(b.getPos(n[1].width,j.sampleStart)),e.fillRect(f,0,3,n[1].height)):k===!0?"SEGMENT"===b.getcurMouseLevelType()&&(j=a.items[a.items.length-1],f=Math.round(b.getPos(n[1].width,j.sampleStart+j.sampleDur)),e.fillRect(f,0,3,n[1].height)):"SEGMENT"===b.getcurMouseLevelType()?(f=Math.round(b.getPos(n[1].width,j.sampleStart)),e.fillRect(f,0,3,n[1].height)):(f=Math.round(b.getPos(n[1].width,j.samplePoint)),i=h/2,e.fillRect(f+i,0,3,n[1].height)),e.fillStyle=c.vals.colors.startBoundaryColor)}var n=j.find("canvas");i.open=k.open,i.vs=b,i.hists=e,i.cps=c,i.dials=g;var o=j.find("div");i.levelDef=c.getLevelDefinition(i.level.name),i.backgroundCanvas={background:c.vals.colors.levelColor},i.$on("refreshTimeline",function(){l(i.level,b,c),m(i.level,b,c)}),i.$watch("vs.curViewPort",function(a,d){d.sS!==a.sS||d.eS!==a.eS||d.windowWidth!==a.windowWidth?(l(i.level,b,c),m(i.level,b,c)):m(i.level,b,c)},!0),i.$watch("vs.curMouseX",function(){b.getcurMouseLevelName()===i.level.name&&(l(i.level,b,c),m(i.level,b,c))},!0),i.$watch("vs.curClickLevelName",function(a){void 0!==a&&m(i.level,b,c)},!0),i.$watch("vs.movingBoundarySample",function(){l(i.level,b,c),m(i.level,b,c)},!0),i.$watch("vs.movingBoundary",function(){m(i.level,b,c)},!0),i.$watch("hists.movesAwayFromLastSave",function(){l(i.level,b,c),m(i.level,b,c)},!0),i.changeCurAttrDef=function(c){var d=b.getCurAttrDef(i.level.name);d!==c&&(b.setCurAttrDef(i.level.name,c),j.hasClass("emuwebapp-levelCanvasContainer-animate")||(b.focusInTextField=!1,h.deleteEditArea(),a.addClass(o,"emuwebapp-levelCanvasContainer-animate",i.finishedAnim)))},i.finishedAnim=function(){a.removeClass(o,"emuwebapp-levelCanvasContainer-animate"),l(i.level,b,c),m(i.level,b,c)},i.getAttrDefBtnColor=function(a){var c,d=b.getCurAttrDef(i.level.name);return c=a===d?{background:"-webkit-radial-gradient(50% 50%, closest-corner, rgba(0, 0, 0, 1), rgba(0, 0, 0, 0) 60%)"}:{"background-color":"white"}},i.updateView=function(){return $.isEmptyObject(i.cps)?void console.log("undef viewState"):void l(i.level,i.vs,i.cps)},j.bind("mouseleave",function(){b.setcurMouseSegment(void 0,void 0,void 0),m(i.level,b,c)})}}}]),angular.module("emuwebApp").directive("osci",["$timeout","viewState","Soundhandlerservice","ConfigProviderService","Drawhelperservice",function(a,b,c,d,e){return{templateUrl:"views/osci.html",replace:!0,restrict:"E",scope:{},controller:["$scope",function(a){a.changeAttrDef=function(){alert("sadf")}}],link:function(f,g,h){function i(a,c){var e=m.getContext("2d");e.clearRect(0,0,l.width,l.height);var f=b.getPos(m.width,b.playHeadAnimationInfos.sS),g=b.getPos(m.width,b.playHeadAnimationInfos.curS);e.fillStyle=d.vals.colors.selectedAreaColor,e.fillRect(f,0,g-f,l.height),j(a,c,!1)}function j(a,b,c){var d=m.getContext("2d");c&&d.clearRect(0,0,m.width,m.height),e.drawMovingBoundaryLine(d),e.drawViewPortTimes(d,!0),e.drawCurViewPortSelected(d,!0)}var k=g.find("canvas").length,l=g.find("canvas")[0],m=g.find("canvas")[k-1];f.order=h.order,f.trackName=h.trackName,f.cps=d,f.viewState=b,f.$on("refreshTimeline",function(){$.isEmptyObject(c)||$.isEmptyObject(c.wavJSO)||j(f,d,!0)}),f.$watch("viewState.timelineSize",function(){a(f.redraw,10)}),f.$watch("viewState.curPerspectiveIdx",function(){j(f,d,!0)},!0),f.$watch("viewState.playHeadAnimationInfos",function(){$.isEmptyObject(c)||$.isEmptyObject(c.wavJSO)||i(f,d)},!0),f.$watch("viewState.movingBoundarySample",function(){$.isEmptyObject(c)||$.isEmptyObject(c.wavJSO)||j(f,d,!0)},!0),f.$watch("viewState.movingBoundary",function(){$.isEmptyObject(c)||$.isEmptyObject(c.wavJSO)||j(f,d,!0)},!0),f.$watch("viewState.curViewPort",function(a,g){if(!$.isEmptyObject(c)&&!$.isEmptyObject(c.wavJSO)){if(g.sS!==a.sS||g.eS!==a.eS){var h=e.calculatePeaks(b,l,c.wavJSO.Data);e.osciPeaks=h,e.freshRedrawDrawOsciOnCanvas(b,l,e.osciPeaks,c.wavJSO.Data,d)}j(f,d,!0)}},!0),f.redraw=function(){j(f,d,!0)}}}}]),angular.module("emuwebApp").directive("preview",["viewState","Soundhandlerservice","Drawhelperservice","ConfigProviderService",function(a,b,c,d){return{templateUrl:"views/preview.html",restrict:"E",scope:{currentBundleName:"@"},link:function(e,f){function g(){k?h(a,i,d):(c.freshRedrawDrawOsciOnCanvas(a,i,c.osciPeaks,b.wavJSO.Data,d),k=!0,h(a,i,d))
}function h(a,c,d){var e=j.getContext("2d"),f=j.width/b.wavJSO.Data.length*a.curViewPort.sS,g=j.width/b.wavJSO.Data.length*a.curViewPort.eS;e.clearRect(0,0,j.width,j.height),e.fillStyle=d.vals.colors.selectedAreaColor,e.fillRect(f,0,g-f,j.height),e.strokeStyle=d.vals.colors.selectedBorderColor,e.beginPath(),e.moveTo(f,0),e.lineTo(f,j.height),e.moveTo(g,0),e.lineTo(g,j.height),e.closePath(),e.stroke()}var i=f.find("canvas")[0],j=f.find("canvas")[1],k=!1;e.vs=a,e.shs=b,e.backgroundCanvas={background:"#eee",border:"1px solid gray",width:"100%",height:"100%"},e.$watch("vs.curViewPort",function(a,c){$.isEmptyObject(b.wavJSO)||(c.sS!==a.sS||c.eS!==a.eS)&&g()},!0),e.$watch("currentBundleName",function(){if($.isEmptyObject(b.wavJSO)||(k=!1,e.backgroundCanvas={background:d.vals.colors.levelColor,border:"1px solid gray",width:"100%",height:"100%"},g()),""===e.currentBundleName){var a=i.getContext("2d");a.clearRect(0,0,i.width,i.height)}},!0)}}}]),angular.module("emuwebApp").directive("bundleListSideBar",["$animate","viewState",function(a){return{templateUrl:"views/bundleListSideBar.html",restrict:"E",replace:!0,link:function(b,c){b.$watch("vs.submenuOpen",function(){b.vs.submenuOpen?(a.removeClass(c,"emuwebapp-shrinkWidthTo0px"),a.addClass(c,"emuwebapp-expandWidthTo240px")):a.addClass(c,"emuwebapp-shrinkWidthTo0px")},!0)}}}]),angular.module("emuwebApp").directive("spectro",["$timeout","fontScaleService",function(a,b){return{templateUrl:"views/spectro.html",restrict:"E",replace:!0,link:function(c,d,e){function f(){r=(c.vs.curViewPort.eS+1-c.vs.curViewPort.sS)/m.width}function g(a){a&&q.clearRect(0,0,n.width,n.height),c.dhs.drawMovingBoundaryLine(q),c.dhs.drawCurViewPortSelected(q,!1),c.dhs.drawMinMaxAndName(q,"",c.vs.spectroSettings.rangeFrom,c.vs.spectroSettings.rangeTo,2)}function h(){p.fillStyle=c.cps.vals.colors.levelColor,p.fillRect(0,0,m.width,m.height),c.dhs.drawCurViewPortSelected(q,!1);var a=b.getTextImage(p,"rendering...",.75*c.cps.vals.font.fontPxSize,c.cps.vals.font.fontType,c.cps.vals.colors.labelColor,!0);p.drawImage(a,10,50),null!==u&&(u.terminate(),u=null)}function i(){f();var a=p.createImageData(m.width,m.height);u.addEventListener("message",function(b){if(r===b.data.myStep){var c=new Uint8ClampedArray(b.data.img);a.data.set(c),p.putImageData(a,0,0),g()}})}function j(a){h(),k(a)}function k(a){f(),u=new Worker(t);var b;b=new Float32Array(c.vs.curViewPort.sS>=c.vs.spectroSettings.windowLength/2?a.subarray(c.vs.curViewPort.sS-c.vs.spectroSettings.windowLength/2,c.vs.curViewPort.eS+c.vs.spectroSettings.windowLength):a.subarray(c.vs.curViewPort.sS,c.vs.curViewPort.eS+c.vs.spectroSettings.windowLength)),i(),u.postMessage({cmd:"config",N:c.vs.spectroSettings.windowLength,alpha:o,freq:c.vs.spectroSettings.rangeTo,freqLow:c.vs.spectroSettings.rangeFrom,start:c.vs.curViewPort.sS,end:c.vs.curViewPort.eS,myStep:r,window:c.vs.spectroSettings.window,width:m.width,height:m.height,dynRangeInDB:c.vs.spectroSettings.dynamicRange,pixelRatio:s,sampleRate:c.shs.wavJSO.SampleRate,streamChannels:c.shs.wavJSO.NumChannels,transparency:c.cps.vals.spectrogramSettings.transparency,stream:b.buffer,drawHeatMapColors:c.vs.spectroSettings.drawHeatMapColors,preEmphasisFilterFactor:c.vs.spectroSettings.preEmphasisFilterFactor,heatMapColorAnchors:c.vs.spectroSettings.heatMapColorAnchors},[b.buffer]),u.postMessage({cmd:"render"})}c.order=e.order;var l=d.find("canvas").length,m=d.find("canvas")[0],n=d.find("canvas")[l-1],o=.16,p=m.getContext("2d"),q=n.getContext("2d"),r=0;window.URL=window.URL||window.webkitURL;var s=window.devicePixelRatio||1,t="scripts/workers/spectroWorker.js",u=new Worker(t);c.$watch("vs.timelineSize",function(){$.isEmptyObject(c.shs)||$.isEmptyObject(c.shs.wavJSO)||a(c.redraw,5)}),c.$watch("vs.curViewPort",function(a,b){$.isEmptyObject(c.shs)||$.isEmptyObject(c.shs.wavJSO)||((b.sS!==a.sS||b.eS!==a.eS)&&c.redraw(),g(!0))},!0),c.$watch("vs.movingBoundarySample",function(){$.isEmptyObject(c.shs)||$.isEmptyObject(c.shs.wavJSO)||(q.clearRect(0,0,n.width,n.height),g())},!0),c.$watch("vs.movingBoundary",function(){$.isEmptyObject(c.shs)||$.isEmptyObject(c.shs.wavJSO)||g(!0)},!0),c.$watch("vs.spectroSettings",function(){$.isEmptyObject(c.shs)||$.isEmptyObject(c.shs.wavJSO)||(i(),c.redraw())},!0),c.redraw=function(){f(),q.clearRect(0,0,n.width,n.height),j(c.shs.wavJSO.Data)}}}}]),angular.module("emuwebApp").controller("TimelineCtrl",["$scope","Drawhelperservice",function(a,b){a.dhs=b}]),angular.module("emuwebApp").controller("ExportCtrl",["$scope","dialogService","exportData","exportName","viewState","HistoryService",function(a,b,c,d,e,f){a.exportData=c,a.exportName=d,a.firefox=navigator.userAgent.match(/Firefox/i)?!0:!1,a.cancel=function(){b.close()},a.getBlob=function(){return new Blob([a.exportData],{type:"text/plain"})},a.export=function(){a.SaveToDisk(URL.createObjectURL(a.getBlob()),a.exportName),b.close()},a.updateHistoryService=function(){f.movesAwayFromLastSave=0},a.cursorInTextField=function(){e.focusInTextField=!0},a.cursorOutOfTextField=function(){e.focusInTextField=!1},a.SaveToDisk=function(b,c){var d=document.createElement("a");if(a.firefox)d.setAttribute("download",c),d.href=b,d.innerHTML="",d.style.display="none",document.body.appendChild(d),d.click();else{d.href=b,d.target="_blank",d.download=c||"unknown";var e=document.createEvent("Event");e.initEvent("click",!0,!0),d.dispatchEvent(e),(window.URL||window.webkitURL).revokeObjectURL(d.href)}a.updateHistoryService()}}]),angular.module("emuwebApp").factory("viewState",["$rootScope","$window","Soundhandlerservice",function(a,b,c){var d={},e={BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10},f=[];return d.initialize=function(){d.curViewPort={sS:0,eS:0,selectS:-1,selectE:-1,dragBarActive:!1,dragBarHeight:-1,windowWidth:void 0},d.spectroSettings={windowLength:-1,rangeFrom:-1,rangeTo:-1,dynamicRange:-1,window:-1,drawHeatMapColors:-1,preEmphasisFilterFactor:-1},d.playHeadAnimationInfos={sS:-1,eS:-1,curS:null,endFreezeSample:-1},d.timelineSize=-1,d.somethingInProgress=!1,d.somethingInProgressTxt="",d.curClickSegments=[],d.editing=!1,d.submenuOpen=!1,d.rightSubmenuOpen=!1,d.curMousePosSample=0,d.curMouseLevelName=void 0,d.curMouseLevelType=void 0,d.curClickLevelName=void 0,d.curClickLevelType=void 0,d.curPreselColumnSample=2,d.curCorrectionToolNr=void 0,d.curClickLevelIndex=void 0,d.start=null,d.TransitionTime=void 0,d.showDropZone=!0,d.movingBoundary=!1,d.movingBoundarySample=void 0,d.focusInTextField=!1,d.curTaskPercCompl=0,d.curPerspectiveIdx=-1,d.mouseInEmuWebApp=!1,d.states=[],d.states.noDBorFilesloaded={permittedActions:["connectBtnClick","openDemoBtnDBclick"]},d.states.loadingSaving={permittedActions:[]},d.states.labeling={permittedActions:["zoom","playaudio","spectSettingsChange","addLevelSegBtnClick","addLevelPointBtnClick","renameSelLevelBtnClick","downloadTextGridBtnClick","spectSettingsChange","clearBtnClick","labelAction","toggleSideBars","saveBndlBtnClick"]},d.states.modalShowing=d.states.loadingSaving,d.prevState=d.states.noDBorFilesloaded,d.curState=d.states.noDBorFilesloaded,f=[]},d.initialize(),d.getPermission=function(a){return d.curState.permittedActions.indexOf(a)>-1},d.setWindowWidth=function(a){this.curViewPort.windowWidth=a},d.setState=function(a){d.prevState=d.curState,d.curState="string"==typeof a?d.states[a]:a},d.updatePlayHead=function(e){c.player.isPlaying&&b.requestAnimationFrame(d.updatePlayHead),null===d.start&&(d.start=e);var f=Math.floor(e-d.start)/1e3*c.wavJSO.SampleRate;d.playHeadAnimationInfos.curS=Math.floor(d.playHeadAnimationInfos.sS+f),c.player.isPlaying&&d.playHeadAnimationInfos.curS<=d.playHeadAnimationInfos.eS?(-1!==d.playHeadAnimationInfos.curS&&(d.curMousePosSample=d.playHeadAnimationInfos.curS),a.$apply()):(d.curMousePosSample=d.playHeadAnimationInfos.endFreezeSample,d.playHeadAnimationInfos.sS=-1,d.playHeadAnimationInfos.eS=-1,d.playHeadAnimationInfos.curS=0,d.start=null)},d.animatePlayHead=function(a,c){d.playHeadAnimationInfos.sS=a,d.playHeadAnimationInfos.eS=c,d.playHeadAnimationInfos.endFreezeSample=c,d.playHeadAnimationInfos.curS=a,b.requestAnimationFrame(d.updatePlayHead)},d.select=function(a,b){d.curViewPort.selectS=a,d.curViewPort.selectE=b},d.resetSelect=function(){d.curViewPort.selectS=-1,d.curViewPort.selectE=-1},d.getViewPort=function(){return d.curViewPort},d.setspectroSettings=function(a,b,c,e,f,g,h,i){d.spectroSettings.windowLength=parseInt(a,10),d.spectroSettings.rangeFrom=parseInt(b,10),d.spectroSettings.rangeTo=parseInt(c,10),d.spectroSettings.dynamicRange=parseInt(e,10),d.setWindowFunction(f),d.spectroSettings.drawHeatMapColors=g,d.spectroSettings.preEmphasisFilterFactor=h,d.spectroSettings.heatMapColorAnchors=i},d.getSelect=function(){return[d.curViewPort.selectS,d.curViewPort.selectE]},d.selectDependent=function(a,b){a<this.curViewPort.selectS&&(this.curViewPort.selectS=a),b>this.curViewPort.selectE&&(this.curViewPort.selectE=b)},d.selectLevel=function(a,b,c){var e,f=d.getcurClickLevelName();if(void 0===f&&!a)return e=c.getLevelDetails(b[0]),void d.setcurClickLevel(e.level.name,e.level.type,0);if(void 0===f&&a)return e=c.getLevelDetails(b[b.length-1]),void d.setcurClickLevel(e.level.name,e.level.type,b.length-1);var g;b.forEach(function(a,b){a===f&&(g=b)}),a?g+1<b.length&&(e=c.getLevelDetails(b[g+1]),d.setcurClickLevel(e.level.name,e.level.type,b.idxOfNow+1),d.curClickSegments=[],d.selectBoundry()):g-1>=0&&(e=c.getLevelDetails(b[g-1]),d.setcurClickLevel(e.level.name,e.level.type,b.idxOfNow-1),d.curClickSegments=[],d.selectBoundry())},d.setWindowFunction=function(a){switch(a){case"BARTLETT":d.spectroSettings.window=e.BARTLETT;break;case"BARTLETTHANN":d.spectroSettings.window=e.BARTLETTHANN;break;case"BLACKMAN":d.spectroSettings.window=e.BLACKMAN;break;case"COSINE":d.spectroSettings.window=e.COSINE;break;case"GAUSS":d.spectroSettings.window=e.GAUSS;break;case"HAMMING":d.spectroSettings.window=e.HAMMING;break;case"HANN":d.spectroSettings.window=e.HANN;break;case"LANCZOS":d.spectroSettings.window=e.LANCZOS;break;case"RECTANGULAR":d.spectroSettings.window=e.RECTANGULAR;break;case"TRIANGULAR":d.spectroSettings.window=e.TRIANGULAR;break;default:d.spectroSettings.window=e.BARTLETTHANN}},d.getWindowFunctions=function(){return e},d.getdragBarActive=function(){return this.curViewPort.dragBarActive},d.setdragBarActive=function(a){this.curViewPort.dragBarActive=a},d.getdragBarHeight=function(){return this.curViewPort.dragBarHeight},d.setdragBarHeight=function(a){this.curViewPort.dragBarHeight=a},d.getPos=function(a,b){return a*(b-this.curViewPort.sS)/(this.curViewPort.eS-this.curViewPort.sS+1)},d.getSampleDist=function(a){return this.getPos(a,this.curViewPort.sS+1)-this.getPos(a,this.curViewPort.sS)},d.getsubmenuOpen=function(){return this.submenuOpen},d.setsubmenuOpen=function(a){this.submenuOpen=a},d.setenlarge=function(a){this.timelineSize=a},d.getenlarge=function(){return this.timelineSize},d.getTransitionTime=function(){return this.TransitionTime},d.setTransitionTime=function(a){this.TransitionTime=a},d.getRightsubmenuOpen=function(){return this.rightSubmenuOpen},d.setRightsubmenuOpen=function(a){this.rightSubmenuOpen=a},d.setcurClickLevel=function(a,b,c){this.setcurClickLevelName(a,c),this.setcurClickLevelType(b)},d.setcurClickLevelType=function(a){this.curClickLevelType=a},d.getcurClickLevelType=function(){return this.curClickLevelType},d.setcurClickLevelName=function(a,b){this.curClickLevelName=a,this.curClickLevelIndex=b},d.getcurClickLevelName=function(){return this.curClickLevelName},d.getcurClickLevelIndex=function(){return this.curClickLevelIndex},d.getcurClickNeighbours=function(){return this.curClickNeighbours},d.setcurMouseLevelName=function(a){this.curMouseLevelName=a},d.getcurMouseLevelName=function(){return this.curMouseLevelName},d.setcurMouseLevelType=function(a){this.curMouseLevelType=a},d.getcurMouseLevelType=function(){return this.curMouseLevelType},d.setcurMouseSegment=function(a,b,c){this.curMouseSegment=a,this.curMouseX=c,this.curMouseNeighbours=b},d.getcurMouseSegment=function(){return this.curMouseSegment},d.getcurMouseNeighbours=function(){return this.curMouseNeighbours},d.selectSegmentsInSelection=function(a){d.curClickSegments=[];var b=d.curViewPort.selectS,c=d.curViewPort.selectE,e=1/0,f=-1/0;angular.forEach(a,function(a){a.name===d.getcurClickLevelName()&&angular.forEach(a.items,function(a){a.sampleStart>=b&&a.sampleStart+a.sampleDur<=c&&(d.setcurClickSegmentMultiple(a),a.sampleStart<e&&(e=a.sampleStart),a.sampleStart+a.sampleDur>f&&(f=a.sampleStart+a.sampleDur))})}),d.curViewPort.selectS=e,d.curViewPort.selectE=f},d.setcurClickSegment=function(a){null!==a&&void 0!==a?(d.curClickSegments=[],d.curClickSegments.push(a),d.selectBoundry()):d.curClickSegments=[]},d.selectBoundry=function(){if(d.curClickSegments.length>0){var a,b;a=void 0!==d.curClickSegments[0].sampleStart?d.curClickSegments[0].sampleStart:d.curClickSegments[0].samplePoint;var b=d.curClickSegments[d.curClickSegments.length-1].sampleStart+d.curClickSegments[d.curClickSegments.length-1].sampleDur||d.curClickSegments[0].samplePoint;d.curClickSegments.forEach(function(c){c.sampleStart<=a&&(a=c.sampleStart),c.sampleStart+c.sampleDur>=b&&(b=c.sampleStart+c.sampleDur)}),d.select(a,b)}},d.setcurClickSegmentMultiple=function(a){var b=!0,c=a.sampleStart,e=c+a.sampleDur;d.curClickSegments.forEach(function(f){var g=f.sampleStart==e?!0:!1,h=f.sampleStart+f.sampleDur==c?!0:!1;(g||h)&&-1===d.curClickSegments.indexOf(a)&&(d.curClickSegments.push(a),b=!1)}),b?(d.curClickSegments=[],d.curClickSegments.push(a)):d.curClickSegments.sort(d.sortbyid)},d.sortbyid=function(a,b){return a.sampleStart>b.sampleStart?1:a.sampleStart<b.sampleStart?-1:0},d.getselectedRange=function(){return this.curClickSegments.length>1?{start:this.curClickSegments[0].sampleStart,end:this.curClickSegments[this.curClickSegments.length-1].sampleStart+this.curClickSegments[this.curClickSegments.length-1].sampleDur}:1===this.curClickSegments.length?void 0!==this.curClickSegments[0].sampleStart?{start:this.curClickSegments[0].sampleStart,end:this.curClickSegments[0].sampleStart+this.curClickSegments[0].sampleDur}:{start:this.curClickSegments[0].samplePoint,end:this.curClickSegments[0].samplePoint}:{start:-1,end:-1}},d.getcurClickSegments=function(){return this.curClickSegments},d.getfirstClickSegment=function(){return d.curClickSegments.length>0?d.curClickSegments[0]:void 0},d.getselected=function(){return this.curClickSegments},d.isEditing=function(){return this.editing},d.setEditing=function(a){this.editing=a},d.countSelected=function(){return this.curClickSegments.length},d.getCurrentSample=function(a){return this.curViewPort.sS+(this.curViewPort.eS-this.curViewPort.sS)*a},d.getCurrentPercent=function(a){return a*(100/(this.curViewPort.eS-this.curViewPort.sS)/100)},d.getPCMpp=function(a){var b=parseFloat(this.curViewPort.sS),c=parseFloat(this.curViewPort.eS);return(c-b)/a.originalEvent.target.width},d.round=function(a,b){(1>b||b>14)&&console.error("error in call of round function!!");var c=Math.pow(10,b),d=(Math.round(a*c)/c).toString();return-1===d.indexOf(".")&&(d+="."),d+=c.toString().substring(1),d.substring(0,d.indexOf(".")+b+1)},d.getViewPortStartTime=function(){return 1*this.curViewPort.sS/c.wavJSO.SampleRate-.5/c.wavJSO.SampleRate},d.getViewPortEndTime=function(){return 1*this.curViewPort.eS/c.wavJSO.SampleRate+.5/c.wavJSO.SampleRate},d.getSelectedStartTime=function(){return 1*this.curViewPort.selectS/c.wavJSO.SampleRate-.5/c.wavJSO.SampleRate},d.getSelectedEndTime=function(){return 1*this.curViewPort.selectE/c.wavJSO.SampleRate+.5/c.wavJSO.SampleRate},d.setViewPort=function(a,b){var d=this.curViewPort.sS,e=this.curViewPort.eS;void 0!==a&&(this.curViewPort.sS=Math.round(a)),void 0!==b&&(this.curViewPort.eS=Math.round(b)),d>this.curViewPort.sS&&e>this.curViewPort.eS&&this.curViewPort.sS<0&&(this.curViewPort.sS=0,this.curViewPort.eS=e+Math.abs(this.curViewPort.sS)),d<this.curViewPort.sS&&e<this.curViewPort.eS&&this.curViewPort.eS>c.wavJSO.Data.length&&(this.curViewPort.sS=d,this.curViewPort.eS=c.wavJSO.Data.length),this.curViewPort.sS<0&&(this.curViewPort.sS=0),this.curViewPort.eS>c.wavJSO.Data.length&&(this.curViewPort.eS=c.wavJSO.Data.length),this.curViewPort.eS-this.curViewPort.sS<4&&(this.curViewPort.sS=d,this.curViewPort.eS=e)},d.zoomViewPort=function(a,b){var c,e,f,g=this.getcurMouseSegment(),h=this.curViewPort.eS-this.curViewPort.sS,i=!1;if(void 0!==g){g===!1?g=b.getElementDetails(d.getcurMouseLevelName(),0):g===!0&&(g=b.getLastElement(d.getcurMouseLevelName()),i=!0),f="SEGMENT"===this.getcurMouseLevelType()?i?g.sampleStart+g.sampleDur:g.sampleStart:g.samplePoint;var j=f-this.curViewPort.sS,k=this.curViewPort.eS-f;a?(c=this.curViewPort.sS+.5*j,e=this.curViewPort.eS-.5*k):(c=this.curViewPort.sS-.5*j,e=this.curViewPort.eS+.5*k)}else a?(c=this.curViewPort.sS+~~(h/4),e=this.curViewPort.eS-~~(h/4)):(c=this.curViewPort.sS-~~(h/4),e=this.curViewPort.eS+~~(h/4));this.setViewPort(c,e)},d.shiftViewPort=function(a){var b,c;a?(b=this.curViewPort.sS+~~((this.curViewPort.eS-this.curViewPort.sS)/4),c=this.curViewPort.eS+~~((this.curViewPort.eS-this.curViewPort.sS)/4)):(b=this.curViewPort.sS-~~((this.curViewPort.eS-this.curViewPort.sS)/4),c=this.curViewPort.eS-~~((this.curViewPort.eS-this.curViewPort.sS)/4)),this.setViewPort(b,c)},d.setCurLevelAttrDefs=function(a){angular.forEach(a,function(a){f.push({levelName:a.name,curAttrDefName:a.name})})},d.setCurAttrDef=function(a,b){angular.forEach(f,function(c){c.levelName===a&&(c.curAttrDefName=b)})},d.getCurAttrDef=function(a){var b;return angular.forEach(f,function(c){c.levelName===a&&(b=c.curAttrDefName)}),b},d.resetToInitState=function(){d.initialize()},d}]),angular.module("emuwebApp").directive("trackmouseinlevel",["viewState","LevelService","ConfigProviderService","HistoryService","Soundhandlerservice",function(a,b,c,d,e){return{restrict:"A",scope:{level:"="},link:function(f,g){function h(c){q=l(c)*a.getPCMpp(c),b.deleteEditArea(),a.setEditing(!1),a.focusInTextField=!1,m=b.getEvent(q+a.curViewPort.sS,f.this.level.name,e.wavJSO.Data.length),void 0!==m.evtr&&void 0!==m.nearest&&(b.setlasteditArea("_"+m.evtr.id),b.setlasteditAreaElem(g.parent()),a.setcurClickLevel(r,s,f.$index),a.setcurClickSegment(m.evtr)),p=q,f.$apply()}function i(c){a.getcurClickLevelName()!==r&&h(c),q=l(c)*a.getPCMpp(c),b.deleteEditArea(),m=b.getEvent(q+a.curViewPort.sS,f.this.level.name,e.wavJSO.Data.length),void 0!==m.evtr&&void 0!==m.nearest&&(a.setcurClickLevel(r,s,f.$index),a.setcurClickSegmentMultiple(m.evtr),a.selectBoundry()),p=q,f.$apply()}function j(c){q=l(c)*a.getPCMpp(c),m=b.getEvent(q+a.curViewPort.sS,f.this.level.name,e.wavJSO.Data.length),void 0!==m.evtr&&void 0!==m.nearest&&("SEGMENT"===s?m.evtr.sampleStart>=a.curViewPort.sS?m.evtr.sampleStart+m.evtr.sampleDur<=a.curViewPort.eS?(a.setcurClickLevel(r,s,f.$index),a.setcurClickSegment(m.evtr),b.setlasteditArea("_"+m.evtr.id),b.setlasteditAreaElem(g.parent()),a.setEditing(!0),b.openEditArea(m.evtr,g.parent(),s),a.focusInTextField=!0):console.log("Editing out of right bound !"):console.log("Editing out of left bound !"):(a.setcurClickLevel(r,s,f.$index),a.setcurClickSegment(m.evtr),b.setlasteditArea("_"+m.evtr.id),b.setlasteditAreaElem(g.parent()),a.setEditing(!0),b.openEditArea(m.evtr,g.parent(),s),a.focusInTextField=!0)),p=q,f.$apply()}function k(c,d){q=l(c)*a.getPCMpp(c),n=b.getEvent(q+a.curViewPort.sS,f.this.level.name,e.wavJSO.Data.length),d&&void 0!==n.evtr&&void 0!==n.nearest&&(o=b.getElementNeighbourDetails(f.this.level.name,n.nearest.id,n.nearest.id),a.setcurMouseSegment(n.nearest,o,p)),a.setcurMouseLevelName(r),a.setcurMouseLevelType(s),p=q,f.$apply()}function l(a){return(a.offsetX||a.originalEvent.layerX)*(a.originalEvent.target.width/a.originalEvent.target.clientWidth)}var m,n,o,p,q,r=f.level.name,s=f.level.type;g.bind("click",function(a){a.preventDefault(),k(a,!0),h(a)}),g.bind("contextmenu",function(a){a.preventDefault(),k(a,!0),i(a)}),g.bind("dblclick",function(a){k(a,!0),c.vals.restrictions.editItemName?j(a):h(a)}),g.bind("mousemove",function(g){if(!a.getdragBarActive()){var h=!0,i=a.getPCMpp(g);q=l(g)*i;var j=q-p;if(1>=i){var m=b.getEvent(q+a.curViewPort.sS,f.this.level.name,e.wavJSO.Data.length);j=Math.floor("SEGMENT"===f.this.level.type?m.nearest===!1?q+a.curViewPort.sS-b.getElementDetails(f.this.level.name,0).sampleStart:m.nearest===!0?q+a.curViewPort.sS-b.getLastElement(f.this.level.name).sampleStart:q+a.curViewPort.sS-b.getElementDetailsById(f.this.level.name,m.nearest.id).sampleStart:q+a.curViewPort.sS-b.getElementDetailsById(f.this.level.name,m.nearest.id).samplePoint)}else j=Math.round(q-p)}var r=0;switch(r=void 0===g.buttons?g.which:g.buttons){case 1:break;case 2:break;case 3:break;default:if(!a.getdragBarActive())if(c.vals.restrictions.editItemSize&&g.shiftKey){if(b.deleteEditArea(),void 0!==a.getcurMouseSegment()){a.movingBoundary=!0;var s=0;if("SEGMENT"===f.this.level.type){if("boolean"==typeof a.getcurMouseSegment()){var t;a.getcurMouseSegment()===!1?(t=b.getElementDetails(f.this.level.name,0),a.movingBoundarySample=t.sampleStart+j,s=-1):(t=b.getLastElement(f.this.level.name),a.movingBoundarySample=t.sampleStart+t.sampleDur+j,s=1)}else a.movingBoundarySample=a.getcurMouseSegment().sampleStart+j,t=a.getcurMouseSegment();b.moveBoundary(f.this.level.name,t.id,j,s),d.updateCurChangeObj({type:"ESPS",action:"moveBoundary",name:f.this.level.name,id:t.id,movedBy:j,position:s})}else t=a.getcurMouseSegment(),a.movingBoundarySample=a.getcurMouseSegment().samplePoint+j,b.movePoint(f.this.level.name,t.id,j),d.updateCurChangeObj({type:"ESPS",action:"movePoint",name:f.this.level.name,id:t.id,movedBy:j});p=q,a.selectBoundry(),h=!1}}else c.vals.restrictions.editItemSize&&g.altKey?(b.deleteEditArea(),"SEGMENT"==f.this.level.type&&(t=a.getcurClickSegments(),b.moveSegment(f.this.level.name,t[0].id,t.length,j),d.updateCurChangeObj({type:"ESPS",action:"moveSegment",name:f.this.level.name,id:t[0].id,length:t.length,movedBy:j}),p=q,a.selectBoundry())):a.movingBoundary=!1}a.getdragBarActive()||k(g,h),void 0!==n.nearest&&a.setcurMouseSegment(n.nearest,o,p)}),g.bind("mousedown",function(b){a.movingBoundary=!0,k(b,!0)}),g.bind("mouseup",function(b){a.movingBoundary=!1,k(b,!0)}),g.bind("mouseout",function(b){a.movingBoundary=!1,k(b,!0)})}}}]),angular.module("emuwebApp").directive("handleglobalkeystrokes",["$timeout","viewState","Soundhandlerservice","ConfigProviderService","HistoryService","LevelService",function(a,b,c,d,e,f){return{restrict:"A",link:function(a){function g(g,h){a.$apply(function(){if(!d.vals.main.catchMouseForKeyBinding||b.mouseInEmuWebApp)if(a.setlastkeycode(g,h.shiftKey),b.focusInTextField){if(g===d.vals.keyMappings.createNewItemAtSelection&&b.isEditing()){var i=f.getElementDetailsById(b.getcurClickLevelName(),f.getlastID());console.error("parallel labels are not added to history service correctly!!!!!!"),e.addObjToUndoStack({type:"ESPS",action:"renameLabel",name:b.getcurClickLevelName(),id:f.getlastID(),oldValue:i.labels[0].value,newValue:$("."+f.getlasteditArea()).val()}),f.renameLabel(b.getcurClickLevelName(),f.getlastID(),$("."+f.getlasteditArea()).val()),f.deleteEditArea(),b.focusInTextField=!1}g===d.vals.keyMappings.esc&&(b.focusInTextField=!1,f.deleteEditArea()),13===g&&(h.preventDefault(),h.stopPropagation())}else{if(f.deleteEditArea(),g===d.vals.keyMappings.zoomAll&&(b.getPermission("zoom")?b.setViewPort(0,c.wavJSO.Data.length):console.log("action currently not allowed")),g===d.vals.keyMappings.zoomIn&&(b.getPermission("zoom")?b.zoomViewPort(!0,f):console.log("action currently not allowed")),g===d.vals.keyMappings.zoomOut&&(b.getPermission("zoom")?b.zoomViewPort(!1,f):console.log("action currently not allowed")),g===d.vals.keyMappings.shiftViewPortLeft&&(b.getPermission("zoom")?b.shiftViewPort(!1):console.log("action currently not allowed")),g===d.vals.keyMappings.shiftViewPortRight&&(b.getPermission("zoom")?b.shiftViewPort(!0):console.log("action currently not allowed")),g===d.vals.keyMappings.zoomSel&&(b.getPermission("zoom")?b.setViewPort(b.curViewPort.selectS,b.curViewPort.selectE):console.log("action currently not allowed")),g===d.vals.keyMappings.playEntireFile&&(b.getPermission("playaudio")?d.vals.restrictions.playback&&(c.playFromTo(0,c.wavJSO.Data.length),b.animatePlayHead(0,c.wavJSO.Data.length)):console.log("action currently not allowed")),g===d.vals.keyMappings.playAllInView&&(b.getPermission("playaudio")?d.vals.restrictions.playback&&(c.playFromTo(b.curViewPort.sS,b.curViewPort.eS),b.animatePlayHead(b.curViewPort.sS,b.curViewPort.eS)):console.log("action currently not allowed")),g===d.vals.keyMappings.playSelected&&(b.getPermission("playaudio")?d.vals.restrictions.playback&&(c.playFromTo(b.curViewPort.selectS,b.curViewPort.selectE),b.animatePlayHead(b.curViewPort.selectS,b.curViewPort.selectE)):console.log("action currently not allowed")),g===d.vals.keyMappings.selectFirstContourCorrectionTool&&b.getPermission("labelAction")&&d.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=1),g===d.vals.keyMappings.selectSecondContourCorrectionTool&&b.getPermission("labelAction")&&d.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=2),g===d.vals.keyMappings.selectThirdContourCorrectionTool&&b.getPermission("labelAction")&&d.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=3),g===d.vals.keyMappings.selectFourthContourCorrectionTool&&b.getPermission("labelAction")&&d.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=4),g===d.vals.keyMappings.selectNoContourCorrectionTool&&b.getPermission("labelAction")&&d.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=void 0),g===d.vals.keyMappings.levelUp&&b.getPermission("labelAction")&&b.selectLevel(!1,d.vals.perspectives[b.curPerspectiveIdx].levelCanvases.order,f),g===d.vals.keyMappings.levelDown&&b.getPermission("labelAction")&&b.selectLevel(!0,d.vals.perspectives[b.curPerspectiveIdx].levelCanvases.order,f),g===d.vals.keyMappings.snapBoundaryToNearestTopBoundary&&b.getPermission("labelAction")&&d.vals.restrictions.editItemSize){var j=b.getcurMouseSegment(),k=b.getcurMouseLevelName(),l=b.getcurMouseLevelType(),m=b.getcurMouseNeighbours(),n=f.snapBoundary(!0,k,j,m,l);n===!1?console.log("error msg nothing moved / nothing on top"):("EVENT"===l?e.updateCurChangeObj({type:"ESPS",action:"movePoint",name:k,id:j.id,movedBy:n}):"SEGMENT"===l&&e.updateCurChangeObj({type:"ESPS",action:"moveBoundary",name:k,id:j.id,movedBy:n,position:0}),e.addCurChangeObjToUndoStack())}if(g===d.vals.keyMappings.snapBoundaryToNearestBottomBoundary&&b.getPermission("labelAction")&&d.vals.restrictions.editItemSize){var j=b.getcurMouseSegment(),k=b.getcurMouseLevelName(),l=b.getcurMouseLevelType(),m=b.getcurMouseNeighbours(),n=f.snapBoundary(!1,k,j,m,l);0==n||("EVENT"===l?e.updateCurChangeObj({type:"ESPS",action:"movePoint",name:k,id:j.id,movedBy:n}):"SEGMENT"===l&&(console.log("seg to bottom"),e.updateCurChangeObj({type:"ESPS",action:"moveBoundary",name:k,id:j.id,movedBy:n,position:0})),e.addCurChangeObjToUndoStack())}if(g===d.vals.keyMappings.snapBoundaryToNearestZeroCrossing&&b.getPermission("labelAction")&&d.vals.restrictions.editItemSize){var o;if(o=f.calcDistanceToNearestZeroCrossing("SEGMENT"===b.getcurMouseLevelType()?b.getcurMouseSegment().sampleStart:b.getcurMouseSegment().samplePoint),0!==o){var p=b.getcurMouseSegment(),q=(b.getcurMouseNeighbours(),b.getcurMouseLevelName());f.moveBoundary(q,p.id,o,0),e.updateCurChangeObj({type:"ESPS",action:"moveBoundary",name:q,id:p.id,movedBy:o,position:0}),e.addCurChangeObjToUndoStack()}}if(g===d.vals.keyMappings.expandSelSegmentsRight&&b.getPermission("labelAction")&&d.vals.restrictions.editItemSize)if(void 0===b.getcurClickLevelName())a.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select a Level first");else if(0===b.getselected().length)a.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select one or more Segments first");else{if("absolute"===d.vals.labelCanvasConfig.addTimeMode)var r=parseInt(d.vals.labelCanvasConfig.addTimeValue,10);else if("relative"===d.vals.labelCanvasConfig.addTimeMode)var r=d.vals.labelCanvasConfig.addTimeValue*(c.wavJSO.Data.length/100);else a.dials.open("views/error.html","ModalCtrl","Expand Segements Error: Error in Configuration (Value labelCanvasConfig.addTimeMode)");f.expandSegment(!0,b.getcurClickSegments(),b.getcurClickLevelName(),r),a.hists.addObjToUndoStack({type:"ESPS",action:"expandSegments",levelName:b.getcurClickLevelName(),item:b.getcurClickSegments(),rightSide:!0,changeTime:r});var s=b.getcurClickSegments().length;1==s?b.select(b.getcurClickSegments()[0].sampleStart,b.getcurClickSegments()[0].sampleStart+b.getcurClickSegments()[0].sampleDur):b.select(b.getcurClickSegments()[0].sampleStart,b.getcurClickSegments()[s-1].sampleStart+b.getcurClickSegments()[s-1].sampleDur)}if(g===d.vals.keyMappings.expandSelSegmentsLeft&&b.getPermission("labelAction")&&d.vals.restrictions.editItemSize)if(void 0===b.getcurClickLevelName())a.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select a Level first");else if(0===b.getselected().length)a.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select one or more Segments first");else{if("absolute"===d.vals.labelCanvasConfig.addTimeMode)var r=parseInt(d.vals.labelCanvasConfig.addTimeValue,10);else if("relative"===d.vals.labelCanvasConfig.addTimeMode)var r=d.vals.labelCanvasConfig.addTimeValue*(c.wavJSO.Data.length/100);else a.dials.open("views/error.html","ModalCtrl","Expand Segements Error: Error in Configuration (Value labelCanvasConfig.addTimeMode)");f.expandSegment(!1,b.getcurClickSegments(),b.getcurClickLevelName(),r),a.hists.addObjToUndoStack({type:"ESPS",action:"expandSegments",levelName:b.getcurClickLevelName(),item:b.getcurClickSegments(),rightSide:!1,changeTime:r});var s=b.getcurClickSegments().length;1==s?b.select(b.getcurClickSegments()[0].sampleStart,b.getcurClickSegments()[0].sampleStart+b.getcurClickSegments()[0].sampleDur):b.select(b.getcurClickSegments()[0].sampleStart,b.getcurClickSegments()[s-1].sampleStart+b.getcurClickSegments()[s-1].sampleDur)}if(g===d.vals.keyMappings.shrinkSelSegmentsLeft&&b.getPermission("labelAction")&&d.vals.restrictions.editItemSize)if(void 0===b.getcurClickLevelName())a.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select a Level first");else if(0===b.getselected().length)a.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select one or more Segments first");else{if("absolute"===d.vals.labelCanvasConfig.addTimeMode)var r=parseInt(d.vals.labelCanvasConfig.addTimeValue,10);else if("relative"===d.vals.labelCanvasConfig.addTimeMode)var r=d.vals.labelCanvasConfig.addTimeValue*(c.wavJSO.Data.length/100);else a.dials.open("views/error.html","ModalCtrl","Expand Segements Error: Error in Configuration (Value labelCanvasConfig.addTimeMode)");a.hists.addObjToUndoStack({type:"ESPS",action:"expandSegments",levelName:b.getcurClickLevelName(),item:b.getcurClickSegments(),rightSide:!0,changeTime:-r}),f.expandSegment(!0,b.getcurClickSegments(),b.getcurClickLevelName(),-r);var s=b.getcurClickSegments().length;1==s?b.select(b.getcurClickSegments()[0].sampleStart,b.getcurClickSegments()[0].sampleStart+b.getcurClickSegments()[0].sampleDur):b.select(b.getcurClickSegments()[0].sampleStart,b.getcurClickSegments()[s-1].sampleStart+b.getcurClickSegments()[s-1].sampleDur)}if(g===d.vals.keyMappings.shrinkSelSegmentsRight&&b.getPermission("labelAction")&&d.vals.restrictions.editItemSize)if(void 0===b.getcurClickLevelName())a.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select a Level first");else if(0===b.getselected().length)a.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select one or more Segments first");else{if("absolute"===d.vals.labelCanvasConfig.addTimeMode)var r=parseInt(d.vals.labelCanvasConfig.addTimeValue,10);
else if("relative"===d.vals.labelCanvasConfig.addTimeMode)var r=d.vals.labelCanvasConfig.addTimeValue*(c.wavJSO.Data.length/100);else a.dials.open("views/error.html","ModalCtrl","Expand Segements Error: Error in Configuration (Value labelCanvasConfig.addTimeMode)");a.hists.addObjToUndoStack({type:"ESPS",action:"expandSegments",levelName:b.getcurClickLevelName(),item:b.getcurClickSegments(),rightSide:!1,changeTime:-r}),f.expandSegment(!1,b.getcurClickSegments(),b.getcurClickLevelName(),-r);var s=b.getcurClickSegments().length;1==s?b.select(b.getcurClickSegments()[0].sampleStart,b.getcurClickSegments()[0].sampleStart+b.getcurClickSegments()[0].sampleDur):b.select(b.getcurClickSegments()[0].sampleStart,b.getcurClickSegments()[s-1].sampleStart+b.getcurClickSegments()[s-1].sampleDur)}if(g===d.vals.keyMappings.toggleSideBarLeft&&b.getPermission("toggleSideBars")&&d.vals.activeButtons.openMenu&&a.openSubmenu(),g===d.vals.keyMappings.toggleSideBarRight&&b.getPermission("toggleSideBars")&&d.vals.activeButtons.openMenu&&a.toggleRightSideMenuHidden(),g===d.vals.keyMappings.selectSegmentsInSelection&&b.getPermission("labelAction")&&(void 0===b.getcurClickLevelName()?a.dials.open("views/error.html","ModalCtrl","Selection Error : Please select a Level first"):b.selectSegmentsInSelection(f.data.levels)),g===d.vals.keyMappings.selPrevItem&&b.getPermission("labelAction")&&b.getcurClickSegments().length>0){var t=b.getcurClickSegments()[0].id,u=b.getcurClickSegments()[b.getcurClickSegments().length-1].id,v=f.getElementNeighbourDetails(b.getcurClickLevelName(),t,u);void 0!==v.left&&(void 0!==v.left.sampleStart?v.left.sampleStart+v.left.sampleDur>b.curViewPort.sS&&(b.setcurClickSegment(v.left,v.left.id),f.setlasteditArea("_"+v.left.id)):v.left.samplePoint>b.curViewPort.sS&&(b.setcurClickSegment(v.left,v.left.id),f.setlasteditArea("_"+v.left.id)))}if(g===d.vals.keyMappings.selNextItem&&b.getPermission("labelAction")&&b.getcurClickSegments().length>0){var t=b.getcurClickSegments()[0].id,u=b.getcurClickSegments()[b.getcurClickSegments().length-1].id,v=f.getElementNeighbourDetails(b.getcurClickLevelName(),t,u);void 0!==v.right.sampleStart?v.right.sampleStart<b.curViewPort.eS&&(b.setcurClickSegment(v.right,v.right.id),f.setlasteditArea("_"+v.right.id)):v.right.samplePoint<b.curViewPort.eS&&(b.setcurClickSegment(v.right,v.right.id),f.setlasteditArea("_"+v.right.id))}if(g===d.vals.keyMappings.selNextPrevItem&&b.getPermission("labelAction")&&b.getcurClickSegments().length>0){var t=b.getcurClickSegments()[0].id,u=b.getcurClickSegments()[b.getcurClickSegments().length-1].id,v=f.getElementNeighbourDetails(b.getcurClickLevelName(),t,u);h.shiftKey?void 0!==v.left&&(void 0!==v.left.sampleStart?v.left.sampleStart+v.left.sampleDur>b.curViewPort.sS&&(b.setcurClickSegment(v.left,v.left.id),f.setlasteditArea("_"+v.left.id)):v.left.samplePoint>b.curViewPort.sS&&(b.setcurClickSegment(v.left,v.left.id),f.setlasteditArea("_"+v.left.id))):void 0!==v.right&&(void 0!==v.right.sampleStart?v.right.sampleStart<b.curViewPort.eS&&(b.setcurClickSegment(v.right,v.right.id),f.setlasteditArea("_"+v.right.id)):v.right.samplePoint<b.curViewPort.eS&&(b.setcurClickSegment(v.right,v.right.id),f.setlasteditArea("_"+v.right.id)))}if(g===d.vals.keyMappings.createNewItemAtSelection&&b.getPermission("labelAction")&&d.vals.restrictions.addItem)if(b.getselectedRange().start===b.curViewPort.selectS&&b.getselectedRange().end===b.curViewPort.selectE)1===b.getcurClickSegments().length?b.getselectedRange().start>=b.curViewPort.sS&&b.getselectedRange().end<=b.curViewPort.eS&&(b.setEditing(!0),f.openEditArea(b.getcurClickSegments()[0],f.getlasteditAreaElem(),b.getcurClickLevelType()),a.cursorInTextField()):(console.log(b.getcurClickSegments()),a.dials.open("views/error.html","ModalCtrl","Modify Error: Please select a single Segment."));else if(-1==b.curViewPort.selectE&&-1==b.curViewPort.selectS)a.dials.open("views/error.html","ModalCtrl","Error : Please select a Segment or Point to modify it's name. Or select a level plus a range in the viewport in order to insert a new Segment.");else if("SEGMENT"===b.getcurClickLevelType()){var w=f.insertSegment(b.getcurClickLevelName(),b.curViewPort.selectS,b.curViewPort.selectE,d.vals.labelCanvasConfig.newSegmentName);w.ret?a.hists.addObjToUndoStack({type:"ESPS",action:"insertSegments",name:b.getcurClickLevelName(),start:b.curViewPort.selectS,end:b.curViewPort.selectE,ids:w.ids,segName:d.vals.labelCanvasConfig.newSegmentName}):a.dials.open("views/error.html","ModalCtrl","Error : You are not allowed to insert a Segment here.")}else{var x=f.insertPoint(b.getcurClickLevelName(),b.curViewPort.selectS,d.vals.labelCanvasConfig.newEventName);x.ret?a.hists.addObjToUndoStack({type:"ESPS",action:"insertPoint",name:b.getcurClickLevelName(),start:b.curViewPort.selectS,id:x.id,pointName:d.vals.labelCanvasConfig.newEventName}):a.dials.open("views/error.html","ModalCtrl","Error: You are not allowed to insert a Point here.")}if(g===d.vals.keyMappings.undo&&(console.log(a.hists.getCurrentStack()),b.getPermission("labelAction")&&e.undo()),g===d.vals.keyMappings.redo&&(console.log(a.hists.getCurrentStack()),b.getPermission("labelAction")&&e.redo()),g===d.vals.keyMappings.deletePreselBoundary&&b.getPermission("labelAction"))if(h.shiftKey){if(d.vals.restrictions.deleteItem){var p=b.getcurClickSegments();if(void 0!==p&&p.length>0){var q=b.getcurClickLevelName();if("SEGMENT"===b.getcurClickLevelType()){var y=f.deleteSegments(q,p[0].id,p.length);a.hists.addObjToUndoStack({type:"ESPS",action:"deleteSegments",name:q,id:p[0].id,length:p.length,deletedSegment:y}),b.setcurMouseSegment(void 0,void 0,void 0),b.setcurClickSegment(y.clickSeg)}else a.dials.open("views/error.html","ModalCtrl","Delete Error: You can not delete Segments on Point Levels.")}}}else if(d.vals.restrictions.deleteItemBoundary){var p=b.getcurMouseSegment(),q=b.getcurMouseLevelName(),z=b.getcurMouseLevelType();if(void 0!==p)if(p===!1){p=f.getElementDetails(q,0);var y=f.deleteSegments(q,p.id,1);a.hists.addObjToUndoStack({type:"ESPS",action:"deleteSegments",name:q,id:p.id,length:1,deletedSegment:y}),b.setcurMouseSegment(void 0,void 0,void 0),b.setcurClickSegment(y.clickSeg)}else if(p===!0){p=f.getLastElement(q);var y=f.deleteSegments(q,p.id,1);a.hists.addObjToUndoStack({type:"ESPS",action:"deleteSegments",name:q,id:p.id,length:1,deletedSegment:y}),b.setcurMouseSegment(void 0,void 0,void 0),b.setcurClickSegment(y.clickSeg)}else if("SEGMENT"===z){var y=f.deleteBoundary(q,p.id);a.hists.addObjToUndoStack({type:"ESPS",action:"deleteBoundary",name:q,id:p.id,deletedSegment:y}),b.setcurMouseSegment(void 0,void 0,void 0),b.setcurClickSegment(y.clickSeg)}else{var A=f.deletePoint(q,p.id);a.hists.addObjToUndoStack({type:"ESPS",action:"deletePoint",name:q,start:A.samplePoint,id:A.id,pointName:A.labels[0].value}),b.setcurMouseSegment(void 0,void 0,void 0)}}h.metaKey||h.ctrlKey||(h.preventDefault(),h.stopPropagation())}})}$(document).bind("keydown",function(b){if(!a.firefox){var c=b.keyCode?b.keyCode:b.which;(8==c||9==c||27==c||37==c||38==c||39==c||40==c||32==c)&&g(c,b)}}),$(document).bind("keypress",function(a){var b=a.keyCode?a.keyCode:a.which;g(b,a)}),a.safeApply=function(a){var b=this.$root.$$phase;"$apply"==b||"$digest"==b?a&&"function"==typeof a&&a():this.$apply(a)},a.$on("$destroy",function(){$(window).off("keydown")})}}}]),angular.module("emuwebApp").directive("delete",function(){return{restrict:"A",link:function(a,b,c){var d=a.this.level.name;b.bind("click",function(){a.vs.setcurClickLevelName(d,c.delete),a.dials.open("views/deleteLevel.html","ModalCtrl",d)})}}}),angular.module("emuwebApp").directive("resize",function(){return{restrict:"A",link:function(a,b){var c=b.parent().parent(),d=0,e=c.find(b.parent().children()[0]),f=(c.find(b.parent().children()[1]),c.find(b.parent().children()[2]));b.bind("click",function(){a.open?(a.open=!1,d=c.css("height"),c.css({height:"30px"}),a.cps.vals.activeButtons.deleteSingleLevel&&e.hide(),a.cps.vals.activeButtons.saveSingleLevel&&f.hide()):(a.open=!0,c.css({height:d}),a.cps.vals.activeButtons.deleteSingleLevel&&e.show(),a.cps.vals.activeButtons.saveSingleLevel&&f.show()),a.updateView()})}}}),angular.module("emuwebApp").directive("enlarge",["$rootScope","viewState",function(a,b){return{restrict:"A",link:function(c,d,e){var f=!1;d.bind("click",function(){f?(f=!1,b.setenlarge(-1)):(f=!0,b.setenlarge(e.enlarge)),a.$apply()})}}}]),angular.module("emuwebApp").directive("save",["dialogService","Espsparserservice",function(a,b){return{restrict:"A",link:function(c,d,e){var f=c.this.level.name;d.bind("click",function(){c.vs.setcurClickLevelName(f,e.save),b.asyncParseJSO(f).then(function(b){a.openExport("views/export.html","ExportCtrl",b.data,f+"_esps.txt")})})}}}]),angular.module("emuwebApp").directive("previewtrack",["viewState","Soundhandlerservice",function(a,b){return{restrict:"A",scope:{},link:function(c,d){function e(a){return(a.offsetX||a.originalEvent.layerX)*(a.originalEvent.target.width/a.originalEvent.target.clientWidth)}var f=-1;d.bind("click",function(d){if(!$.isEmptyObject(b.wavJSO)){var g=a.curViewPort.eS-a.curViewPort.sS;f=e(d)*(b.wavJSO.Data.length/d.originalEvent.target.width),a.focusInTextField||c.$apply(function(){a.setViewPort(f-g/2,f+g/2)})}}),d.bind("mousedown",function(a){$.isEmptyObject(b.wavJSO)||(f=e(a)*(b.wavJSO.Data.length/a.originalEvent.target.width))}),d.bind("mousemove",function(d){var g=0;switch(g=void 0===d.buttons?d.which:d.buttons){case 1:if(-1!==f){var h=a.curViewPort.eS-a.curViewPort.sS;f=e(d)*(b.wavJSO.Data.length/d.originalEvent.target.width),a.focusInTextField||c.$apply(function(){a.setViewPort(f-h/2,f+h/2)})}}}),d.bind("mouseup",function(){f=-1}),d.bind("mouseout",function(){f=-1})}}}]),angular.module("emuwebApp").service("Iohandlerservice",["$rootScope","$http","$location","$q","HistoryService","viewState","Soundhandlerservice","Ssffparserservice","Wavparserservice","Textgridparserservice","ConfigProviderService","Espsparserservice","Ssffdataservice","Websockethandler",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o={};return o.wsH=n,o.httpGetDefaultConfig=function(){var a=b.get("configFiles/default_emuwebappConfig.json");return a},o.httpGetPath=function(a,c){var d=b.get(a,{responseType:c});return d},o.getProtocol=function(){var a;return"CORS"===k.vals.main.comMode?alert("CORS version of getProtocol not implemented"):"WS"===k.vals.main.comMode&&(a=n.getProtocol()),a},o.getDoUserManagement=function(){var a;return"CORS"===k.vals.main.comMode?alert("CORS version of getDoUserManagement not implemented"):"WS"===k.vals.main.comMode&&(a=n.getDoUserManagement()),a},o.logOnUser=function(a,b){var c;return"CORS"===k.vals.main.comMode?alert("CORS version of logOnUser not implemented"):"WS"===k.vals.main.comMode&&(c=n.logOnUser(a,b)),c},o.getDBconfigFile=function(a){var c;return"CORS"===k.vals.main.comMode?alert("CORS version of getDBconfigFile not implemented"):"WS"===k.vals.main.comMode?c=n.getDBconfigFile():"DEMO"===k.vals.main.comMode&&(c=b.get("demoDBs/"+a+"/"+a+"_DBconfig.json")),c},o.getBundleList=function(a){var c;return"CORS"===k.vals.main.comMode?alert("CORS version of getBundleList not implemented"):"WS"===k.vals.main.comMode?c=n.getBundleList():"DEMO"===k.vals.main.comMode&&(c=b.get("demoDBs/"+a+"/"+a+"_bundleList.json")),c},o.getBundle=function(a,c){var d;return"CORS"===k.vals.main.comMode?alert("CORS version of getBundle not implemented"):"WS"===k.vals.main.comMode?d=n.getBundle(a):"DEMO"===k.vals.main.comMode&&(d=b.get("demoDBs/"+c+"/"+a+"_bndl.json")),d},o.saveBundle=function(a){var b;return"CORS"===k.vals.main.comMode?alert("CORS version of saveBundle not implemented"):"WS"===k.vals.main.comMode&&(b=n.saveBundle(a)),b},o.parseLabelFile=function(a,b,c,d){var e;return"ESPS"===d?e=l.asyncParseEsps(a,k.embeddedVals.labelGetUrl,"embeddedESPS"):"TEXTGRID"===d&&(e=j.asyncParseTextGrid(a,k.embeddedVals.labelGetUrl,"embeddedTEXTGRID")),e},o}]),angular.module("emuwebApp").service("Soundhandlerservice",["$document","Binarydatamaniphelper",function(a,b){var c={};return c.wavJSO={},c.player=a[0].createElement("audio"),c.player.isPlaying=!1,c.setPlayerSrc=function(a){var c=b.arrayBufferToBase64(a);this.player.src="data:audio/wav;base64,"+c},c.resetPlayerSrcFromTo=function(a,c){var d=this.wavJSO.BitsPerSample/8,e=this.wavJSO.origArrBuf.subarray(0,44),f=this.wavJSO.origArrBuf.subarray(44,this.wavJSO.Data.length*d),g=new DataView(e);g.setUint32(40,(c-a)*d,!0);var h=f.subarray(a*d,(c-a)*d),i=new Uint8Array(e.byteLength+h.byteLength);i.set(new Uint8Array(e),0),i.set(new Uint8Array(h),e.byteLength);var j=b.arrayBufferToBase64(i.buffer);this.player.src="data:audio/wav;base64,"+j},c.playFromTo=function(a,b){this.resetPlayerSrcFromTo(a,b),this.player.isPlaying?(this.player.isPlaying=!1,this.player.pause()):(this.player.isPlaying=!0,this.player.play())},c.player.addEventListener("ended",function(){this.isPlaying=!1},!1),c}]),angular.module("emuwebApp").directive("drawssff",["viewState","ConfigProviderService","Ssffdataservice","HistoryService","fontScaleService",function(a,b,c,d,e){return{restrict:"A",scope:{},link:function(f,g,h){function i(){var d=l.getContext("2d");if(d.clearRect(0,0,l.width,l.height),$.isEmptyObject(c.data)){var d=l.getContext("2d");d.clearRect(0,0,l.width,l.height)}else if(0!==c.data.length&&(m="",b.vals.perspectives[a.curPerspectiveIdx].signalCanvases.assign.forEach(function(d){if(d.signalCanvasName===k){m=d.ssffTrackName;var e=b.getSsffTrackConfig(d.ssffTrackName),f=c.getColumnOfTrack(e.name,e.columnName),g=c.getSampleRateAndStartTimeOfTrack(e.name),h=b.getLimsOfTrack(e.name);j(a,l,b,f,g.sampleRate,g.startTime,h)}}),m="","OSCI"!==k&&"SPEC"!==k)){var e=b.getSsffTrackConfig(k),f=c.getColumnOfTrack(e.name,e.columnName),g=c.getSampleRateAndStartTimeOfTrack(e.name),h=b.getLimsOfTrack(e.name);j(a,l,b,f,g.sampleRate,g.startTime,h)}}function j(a,c,d,f,g,h,i){var j,l,n=c.getContext("2d");"SPEC"===k&&"FORMANTS"===m?(j=a.spectroSettings.rangeFrom,l=a.spectroSettings.rangeTo):(j=f._minVal,l=f._maxVal);var o=a.getViewPortStartTime(),p=a.getViewPortEndTime(),q=Math.round(o*g+h),r=Math.round(p*g+h),s=r-q,t=f.values.slice(q,q+s);if(s<c.width&&s>=2){var u,v,w,x;angular.forEach(t[0],function(d,e){if($.isEmptyObject(i)||e>=i.min&&e<=i.max){if($.isEmptyObject(i))n.strokeStyle="hsl("+e*(360/t[0].length)+",80%, 50%)",n.fillStyle="hsl("+e*(360/t[0].length)+",80%, 50%)";else{var s=i.max-i.min+1;n.strokeStyle="hsl("+e*(360/s)+",80%, 50%)",n.fillStyle="hsl("+e*(360/s)+",80%, 50%)"}if(a.curCorrectionToolNr-1===e&&"SPEC"===k&&"FORMANTS"===m&&(n.strokeStyle=b.vals.colors.selectedContourColor,n.fillStyle=b.vals.colors.selectedContourColor),n.beginPath(),q>=1){var y=f.values[q-1],z=y[e];w=q-1,x=1/g*w+h,u=(x-o)/(p-o)*c.width,v=c.height-(z-j)/(l-j)*c.height,n.moveTo(u,v)}if(angular.forEach(t,function(a,b){w=q+b,x=1/g*w+h,u=(x-o)/(p-o)*c.width,v=c.height-(a[e]-j)/(l-j)*c.height,n.arc(u,v-1,2,0,2*Math.PI,!1),n.lineTo(u,v)}),r<f.values.length-1){var A=f.values[r+1],B=A[e];w=r+1,x=1/g*w+h,u=(x-o)/(p-o)*c.width,v=c.height-(B-j)/(l-j)*c.height,n.lineTo(u,v)}n.stroke()}})}else{n.strokeStyle="red";var y,z;2>=s?(z=e.getTextImageTwoLines(n,"Zoom out to","see contour(s)",b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.crossHairsColor),n.drawImage(z,0,0,z.width,z.height,c.width/2-z.width/2,25,z.width,z.height)):(y="Zoom in to see contour(s)",z=e.getTextImageTwoLines(n,"Zoom in to","see contour(s)",b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.crossHairsColor),n.drawImage(z,0,0,z.width,z.height,c.width/2-z.width/2,25,z.width,z.height))}}{var k,l=g[0],m="";Date.now()}f.vs=a,f.hists=d,f.ssffds=c,h.$observe("ssffTrackname",function(a){k=a}),f.$watch("vs.curViewPort",function(a,b){(b.sS!==a.sS||b.eS!==a.eS)&&i(a,b)},!0),f.$watch("vs.curPerspectiveIdx",function(a,b){i(a,b)},!0),f.$watch("vs.curCorrectionToolNr",function(a,b){i(a,b)},!0),f.$watch("hists.movesAwayFromLastSave",function(a,b){i(a,b)},!0),f.$watch("ssffds.data.length",function(a,b){i(a,b)},!0),f.$watch("vs.spectroSettings",function(a,b){i(a,b)},!0)}}}]),angular.module("emuwebApp").service("Ssffparserservice",["$q",function(a){var b,c={},d=new Worker("scripts/workers/ssffParserWorker.js");return d.addEventListener("message",function(a){"SUCCESS"===a.data.status.type?b.resolve(a.data):b.reject(a.data)},!1),c.asyncParseSsffArr=function(c){return b=a.defer(),d.postMessage({cmd:"parseArr",ssffArr:c}),b.promise},c.asyncJso2ssff=function(c){return b=a.defer(),d.postMessage({cmd:"jso2ssff",jso:JSON.stringify(c)}),b.promise},c}]),angular.module("emuwebApp").directive("mouseTrackAndCorrectionTool",["viewState","ConfigProviderService","Ssffdataservice","Drawhelperservice","HistoryService","Soundhandlerservice",function(a,b,c,d,e,f){return{restrict:"A",scope:{},link:function(g,h,i){function j(e,f){if(u.clearRect(0,0,t.width,t.height),"OSCI"==i.ssffTrackname)d.drawViewPortTimes(u,!0),d.drawCurViewPortSelected(u,!0);else if("SPEC"==i.ssffTrackname)d.drawCurViewPortSelected(u,!1),d.drawMinMaxAndName(u,"",a.spectroSettings.rangeFrom,a.spectroSettings.rangeTo,2);else{var g=b.getSsffTrackConfig(i.ssffTrackname),h=c.getColumnOfTrack(g.name,g.columnName);d.drawCurViewPortSelected(u,!1),d.drawMinMaxAndName(u,i.ssffTrackname,h._minVal,h._maxVal,2)}f!==!1&&b.vals.restrictions.drawCrossHairs&&d.drawCrossHairs(u,e,a.spectroSettings.rangeFrom,a.spectroSettings.rangeTo,"Hz",i.ssffTrackname),d.drawMovingBoundaryLine(u)}function k(b){l=Math.round(d.getX(b)*a.getPCMpp(b)+a.curViewPort.sS),l>m?(n=l,a.select(m,n)):(m=l,a.select(m,n)),g.$apply()}var l,m,n,o,p,q,r,s,t=h[0],u=t.getContext("2d");i.$observe("ssffTrackname",function(a){a&&(r=a)}),i.$observe("bundleName",function(a){a&&(s=a,$.isEmptyObject(c.data)||0!==c.data.length&&(o=b.getSsffTrackConfig("FORMANTS"),void 0!==o&&(p=c.getColumnOfTrack(o.name,o.columnName),q=c.getSampleRateAndStartTimeOfTrack(o.name))))}),h.bind("mousedown",function(b){m=Math.round(d.getX(b)*a.getPCMpp(b)+a.curViewPort.sS),n=m,a.select(m,m),j(b),g.$apply()}),h.bind("mousemove",function(f){var i=0;i=void 0===f.buttons?f.which:f.buttons;var l=d.getX(f);switch(a.curMousePosSample=Math.round(a.curViewPort.sS+l/h[0].width*(a.curViewPort.eS-a.curViewPort.sS)),i){case 0:if(a.getPermission("labelAction")&&(j(f),!($.isEmptyObject(c.data)||0===c.data.length||a.getdragBarActive()||void 0===a.curCorrectionToolNr||a.getdragBarActive()||$.isEmptyObject(b.getAssignment(r))))){void 0===o&&(o=b.getSsffTrackConfig("FORMANTS"),p=c.getColumnOfTrack(o.name,o.columnName),q=c.getSampleRateAndStartTimeOfTrack(o.name));var m=a.getViewPortStartTime(),n=a.getViewPortEndTime(),s=Math.round(m*q.sampleRate+q.startTime),v=Math.round(n*q.sampleRate+q.startTime),w=v-s,x=p.values.slice(s,s+w),y=m+d.getX(f)/f.originalEvent.target.width*(n-m),z=Math.round((y+q.startTime)*q.sampleRate)-1,A=1/q.sampleRate*z+q.startTime;if(0>z-s||z-s>=x.length)return void console.log("early return");a.curPreselColumnSample=z-s;var B=(A-m)/(n-m)*t.width,C=t.height-x[a.curPreselColumnSample][a.curCorrectionToolNr-1]/(a.spectroSettings.rangeTo-a.spectroSettings.rangeFrom)*t.height;if(u.strokeStyle="black",u.fillStyle="black",u.beginPath(),u.arc(B,C-1,2,0,2*Math.PI,!1),u.closePath(),u.stroke(),u.fill(),f.shiftKey){var D=angular.copy(x[a.curPreselColumnSample][a.curCorrectionToolNr-1]),E=a.spectroSettings.rangeTo-d.getY(f)/f.originalEvent.target.height*a.spectroSettings.rangeTo;x[a.curPreselColumnSample][a.curCorrectionToolNr-1]=a.spectroSettings.rangeTo-d.getY(f)/f.originalEvent.target.height*a.spectroSettings.rangeTo;var F=e.updateCurChangeObj({type:"SSFF",trackName:o.name,sampleBlockIdx:s+a.curPreselColumnSample,sampleIdx:a.curCorrectionToolNr-1,oldValue:D,newValue:E});for(var G in F)A=1/q.sampleRate*F[G].sampleBlockIdx+q.startTime,B=(A-m)/(n-m)*t.width,C=t.height-F[G].newValue/(a.spectroSettings.rangeTo-a.spectroSettings.rangeFrom)*t.height,u.strokeStyle="red",u.fillStyle="red",u.beginPath(),u.arc(B,C-1,2,0,2*Math.PI,!1),u.closePath(),u.stroke(),u.fill()}}break;case 1:a.getdragBarActive()||k(f)}g.$apply()}),h.bind("mouseup",function(b){a.getdragBarActive()||(k(b),j(b))}),h.bind("mouseleave",function(b){$.isEmptyObject(f)||$.isEmptyObject(f.wavJSO)||a.getdragBarActive()||a.getPermission("labelAction")&&j(b,!1)})}}}]),angular.module("emuwebApp").service("Drawhelperservice",["viewState","ConfigProviderService","Soundhandlerservice","fontScaleService","Ssffdataservice",function(a,b,c,d,e){function f(a,b,c){return a.measureText(b).width*c}function g(a,b,c,d){return b.toString().length>c.toString().length?f(a,b,d):f(a,c,d)}function h(a,b,c,d,e,f,g){var h=f.getContext("2d"),i=1,j=Math.round(c*(f.height/d)),k=b*i,l=Math.round((f.height-j)/2),m=Math.round(e*(f.height/d)),n=(b-1)*i,o=Math.round((f.height-m)/2);h.fillStyle=g.vals.colors.osciColor,h.strokeStyle=g.vals.colors.osciColor,h.moveTo(n,o),h.lineTo(k,l)}var i={};return i.osciPeaks=[],i.getX=function(a){return(a.offsetX||a.originalEvent.layerX)*(a.originalEvent.target.width/a.originalEvent.target.clientWidth)},i.getY=function(a){return(a.offsetY||a.originalEvent.layerY)*(a.originalEvent.target.height/a.originalEvent.target.clientHeight)},i.calculatePeaks=function(a,b,c){var d,e=(a.curViewPort.eS+1-a.curViewPort.sS)/b.width,f=1,g=[],h=1/0,i=-1/0;if(1>=e)d=0===a.curViewPort.sS?c.subarray(a.curViewPort.sS,a.curViewPort.eS+2):c.subarray(a.curViewPort.sS-1,a.curViewPort.eS+2),h=Math.min.apply(Math,d),i=Math.max.apply(Math,d),g=Array.prototype.slice.call(d);else{d=c.subarray(a.curViewPort.sS,a.curViewPort.eS);for(var j=0;j<b.width;j++){for(var k=0,l=0;f>l;l++){for(var m=d.subarray(j*e,(j+1)*e),n=0,o=0,p=m.length;p>o;o++)n+=m[o];k+=n/m.length}g[j]=k,k>i&&(i=k)}}return{peaks:g,minPeak:h,maxPeak:i,samplePerPx:e}},i.freshRedrawDrawOsciOnCanvas=function(a,b,c,d,e){var f=b.getContext("2d");if(f.clearRect(0,0,b.width,b.height),c.peaks&&c.samplePerPx>=1)f.beginPath(),c.peaks.forEach(function(d,f){0!==f&&h(a,f,d,c.maxPeak,c.peaks[f-1],b,e)}),f.stroke();else if(c.samplePerPx<1){var g=1/c.samplePerPx/2,i=a.curViewPort.sS;f.strokeStyle=e.vals.colors.osciColor,f.fillStyle=e.vals.colors.osciColor;var j;if(0===a.curViewPort.sS){for(f.moveTo(g,(c.peaks[0]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height),j=0;j<c.peaks.length;j++)f.lineTo(j/c.samplePerPx+g,(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height);for(f.stroke(),j=0;j<c.peaks.length;j++)f.beginPath(),f.arc(j/c.samplePerPx+g,(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-3,4,0,2*Math.PI,!1),f.stroke(),f.fill(),e.vals.restrictions.drawSampleNrs&&(f.strokeText(i,j/c.samplePerPx+g,(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-10),i+=1)}else{for(f.beginPath(),f.moveTo(-g,b.height-(c.peaks[0]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height),j=1;j<=c.peaks.length;j++)f.lineTo(j/c.samplePerPx-g,b.height-((c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height+3));for(f.stroke(),j=1;j<=c.peaks.length;j++)f.beginPath(),f.arc(j/c.samplePerPx-g,b.height-(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-3,4,0,2*Math.PI,!1),f.stroke(),f.fill(),e.vals.restrictions.drawSampleNrs&&(f.fillText(i,j/c.samplePerPx-g,b.height-(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-10),i+=1)}}if(e.vals.restrictions.drawZeroLine){if(f.strokeStyle=e.vals.colors.zeroLineColor,f.fillStyle=e.vals.colors.zeroLineColor,"Google Inc."===navigator.vendor&&f.setLineDash([2]),c.samplePerPx>=1)f.beginPath(),f.moveTo(0,b.height/2),f.lineTo(b.width,b.height/2),f.stroke(),f.fillText("0",5,b.height/2-5,b.width);else{var k=b.height-(0-c.minPeak)/(c.maxPeak-c.minPeak)*b.height;f.beginPath(),f.moveTo(0,k),f.lineTo(b.width,k),f.stroke(),f.fill(),f.fillText("0",5,b.height-(0-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-5,b.width)}"Google Inc."===navigator.vendor&&f.setLineDash([0])}},i.drawMovingBoundaryLine=function(c){var d,e;if(e=a.getSampleDist(c.canvas.width),d="SEGMENT"===a.getcurMouseLevelType()?0:e/2,a.movingBoundary){c.fillStyle=b.vals.colors.selectedBoundaryColor;var f=Math.round(a.getPos(c.canvas.width,a.movingBoundarySample));c.fillRect(f+d,0,1,c.canvas.height)}},i.drawCurViewPortSelected=function(e,h){var i,j,k,l,m;j=a.getSampleDist(e.canvas.width),i="seg"===a.getcurMouseLevelType()?0:j/2;var n=a.getPos(e.canvas.width,a.curViewPort.selectS),o=a.getPos(e.canvas.width,a.curViewPort.selectE);if(n===o)e.fillStyle=b.vals.colors.selectedBorderColor,e.fillRect(n+i,0,2,e.canvas.height),h&&a.curViewPort.sS!==a.curViewPort.selectS&&-1!==a.curViewPort.selectS&&(m=e.canvas.width/e.canvas.offsetWidth,k=g(e,a.curViewPort.selectS,a.round(a.curViewPort.selectS/c.wavJSO.SampleRate,6),m),l=d.getTextImageTwoLines(e,a.curViewPort.selectS,a.round(a.curViewPort.selectS/c.wavJSO.SampleRate,6),b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0),e.drawImage(l,0,0,l.width,l.height,o+5,0,l.width,l.height));else if(e.fillStyle=b.vals.colors.selectedAreaColor,e.fillRect(n,0,o-n,e.canvas.height),e.strokeStyle=b.vals.colors.selectedBorderColor,e.beginPath(),e.moveTo(n,0),e.lineTo(n,e.canvas.height),e.moveTo(o,0),e.lineTo(o,e.canvas.height),e.closePath(),e.stroke(),h&&(m=e.canvas.width/e.canvas.offsetWidth,k=g(e,a.curViewPort.selectS,a.round(a.curViewPort.selectS/c.wavJSO.SampleRate,6),m),l=d.getTextImageTwoLines(e,a.curViewPort.selectS,a.round(a.curViewPort.selectS/c.wavJSO.SampleRate,6),b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1),e.drawImage(l,0,0,l.width,l.height,n-k-5,0,l.width,l.height),l=d.getTextImageTwoLines(e,a.curViewPort.selectE,a.round(a.curViewPort.selectE/c.wavJSO.SampleRate,6),b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0),e.drawImage(l,0,0,l.width,l.height,o+5,0,l.width,l.height),k=f(e,a.round((a.curViewPort.selectE-a.curViewPort.selectS)/c.wavJSO.SampleRate,6),m),o-n>k)){var p=a.curViewPort.selectE-a.curViewPort.selectS,q=a.round((a.curViewPort.selectE-a.curViewPort.selectS)/c.wavJSO.SampleRate,6);k=g(e,p,q,m),l=d.getTextImageTwoLines(e,p,q,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1),e.drawImage(l,0,0,l.width,l.height,n+(o-n)/2-k/2,0,l.width,l.height)}},i.drawCrossHairs=function(c,f,g,h,j,k){if(b.vals.restrictions.drawCrossHairs){c.strokeStyle=b.vals.colors.crossHairsColor,c.fillStyle=b.vals.colors.crossHairsColor,"Google Inc."===navigator.vendor&&c.setLineDash([2]);var l=i.getX(f),m=i.getY(f);"Google Inc."===navigator.vendor&&c.setLineDash([0]),c.font=b.vals.font.fontPxSize+"px "+b.vals.font.fontType;var n=a.round(h-m/c.canvas.height*h,2),o=c.measureText(n+j).width,p=Math.round(a.curViewPort.sS+l/c.canvas.width*(a.curViewPort.eS-a.curViewPort.sS)),q=a.round(a.getViewPortStartTime()+l/c.canvas.width*(a.getViewPortEndTime()-a.getViewPortStartTime()),6),r=d.getTextImage(c,n+j,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.crossHairsColor,!0),s=d.getTextImageTwoLines(c,p,q,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.crossHairsColor,!0);if(void 0!==h||void 0!==g)if("OSCI"==k)c.beginPath(),c.moveTo(l,0),c.lineTo(l,c.canvas.height),c.stroke();else if("SPEC"==k)c.drawImage(r,0,0,r.width,r.height,5,m,r.width,r.height),c.drawImage(r,0,0,r.width,r.height,c.canvas.width-5-o*(c.canvas.width/c.canvas.offsetWidth),m,r.width,r.height),c.beginPath(),c.moveTo(0,m),c.lineTo(5,m+5),c.moveTo(0,m),c.lineTo(c.canvas.width,m),c.lineTo(c.canvas.width-5,m+5),c.moveTo(l,0),c.lineTo(l,c.canvas.height),c.stroke();else{var t=b.getSsffTrackConfig(k),u=e.getColumnOfTrack(t.name,t.columnName);n=a.round(u._maxVal-m/c.canvas.height*u._maxVal,2),r=d.getTextImage(c,n,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.crossHairsColor,!0),c.drawImage(r,0,0,r.width,r.height,5,m,r.width,r.height),c.drawImage(r,0,0,r.width,r.height,c.canvas.width-5-o*(c.canvas.width/c.canvas.offsetWidth),m,r.width,r.height),c.beginPath(),c.moveTo(0,m),c.lineTo(5,m+5),c.moveTo(0,m),c.lineTo(c.canvas.width,m),c.lineTo(c.canvas.width-5,m+5),c.moveTo(l,0),c.lineTo(l,c.canvas.height),c.stroke()}c.drawImage(s,0,0,s.width,s.height,l+5,0,s.width,s.height)}},i.drawMinMaxAndName=function(c,e,f,g,h){c.strokeStyle=b.vals.colors.labelColor,c.fillStyle=b.vals.colors.labelColor;var i=c.canvas.height/c.canvas.offsetHeight,j=3*b.vals.font.fontPxSize/4,k=j*i;if(c.beginPath(),c.moveTo(0,0),c.lineTo(5,5),c.moveTo(0,c.canvas.height),c.lineTo(5,c.canvas.height-5),c.stroke(),c.closePath(),""!==e){c.font=b.vals.font.fontPxSize+"px "+b.vals.font.fontType;var l=d.getTextImage(c,e,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0);c.drawImage(l,0,c.canvas.height/2-b.vals.font.fontPxSize*i/2)}if(void 0!==g){var m=d.getTextImage(c,"max: "+a.round(g,h),j,b.vals.font.fontType,b.vals.colors.endBoundaryColor);c.drawImage(m,5,5,m.width,m.height)}void 0!==f&&(m=d.getTextImage(c,"min: "+a.round(f,h),j,b.vals.font.fontType,b.vals.colors.endBoundaryColor),c.drawImage(m,5,c.canvas.height-k-5,m.width,m.height))},i.drawViewPortTimes=function(e){e.strokeStyle=b.vals.colors.labelColor,e.fillStyle=b.vals.colors.labelColor,e.font=b.vals.font.fontPxSize+"px "+b.vals.font.fontType,e.beginPath(),e.moveTo(0,0),e.lineTo(5,5),e.moveTo(e.canvas.width,0),e.lineTo(e.canvas.width-5,5),e.closePath(),e.stroke();{var f,h,i,j,k=e.canvas.width/e.canvas.offsetWidth;e.canvas.height/e.canvas.offsetHeight}a.curViewPort&&(f=a.round(a.curViewPort.sS/c.wavJSO.SampleRate,6),h=a.round(a.curViewPort.eS/c.wavJSO.SampleRate,6),i=d.getTextImageTwoLines(e,a.curViewPort.sS,f,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0),e.drawImage(i,5,5),j=g(e,a.curViewPort.eS,h,k),i=d.getTextImageTwoLines(e,a.curViewPort.eS,h,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1),e.drawImage(i,0,0,i.width,i.height,e.canvas.width-j-5,0,i.width,i.height))},i}]),angular.module("emuwebApp").service("HistoryService",["$log","Ssffdataservice","LevelService","ConfigProviderService","viewState","Soundhandlerservice",function(a,b,c,d){function e(a,e){Object.keys(a).forEach(function(f){var g=a[f];if("SSFF"===g.type)if(e){var h=d.getSsffTrackConfig(g.trackName),i=b.getColumnOfTrack(h.name,h.columnName);i.values[g.sampleBlockIdx][g.sampleIdx]=g.oldValue}else{var h=d.getSsffTrackConfig(g.trackName),i=b.getColumnOfTrack(h.name,h.columnName);i.values[g.sampleBlockIdx][g.sampleIdx]=g.newValue}else if("ESPS"===g.type)switch(g.action){case"moveBoundary":e?c.moveBoundary(g.name,g.id,-g.movedBy,g.position):c.moveBoundary(g.name,g.id,g.movedBy,g.position);break;case"moveSegment":e?c.moveSegment(g.name,g.id,g.length,-g.movedBy):c.moveSegment(g.name,g.id,g.length,g.movedBy);break;case"movePoint":e?c.movePoint(g.name,g.id,-g.movedBy):c.movePoint(g.name,g.id,g.movedBy);break;case"renameLabel":e?c.renameLabel(g.name,g.id,g.oldValue):c.renameLabel(g.name,g.id,g.newValue);break;case"renameLevel":e?c.renameLevel(g.newname,g.name,g.curPerspectiveIdx):c.renameLevel(g.name,g.newname,g.curPerspectiveIdx);break;case"deleteLevel":e?c.addLevel(g.level,g.id,g.curPerspectiveIdx):c.deleteLevel(g.id,g.curPerspectiveIdx);break;case"addLevel":e?c.deleteLevel(g.id,g.curPerspectiveIdx):c.addLevel(g.level,g.id,g.curPerspectiveIdx);break;case"deleteBoundary":e?c.deleteBoundaryInvers(g.name,g.id,g.deletedSegment):c.deleteBoundary(g.name,g.id);break;case"deleteSegments":e?c.deleteSegmentsInvers(g.name,g.id,g.length,g.deletedSegment):c.deleteSegments(g.name,g.id,g.length);break;case"insertSegments":e?c.insertSegmentInvers(g.name,g.start,g.end,g.segName):c.insertSegment(g.name,g.start,g.end,g.segName,g.ids);break;case"insertPoint":e?c.deletePoint(g.name,g.id):c.insertPoint(g.name,g.start,g.pointName,g.id);break;case"deletePoint":e?c.insertPoint(g.name,g.start,g.pointName,g.id):c.deletePoint(g.name,g.id);break;case"expandSegments":e?c.expandSegment(g.rightSide,g.item,g.levelName,-g.changeTime):c.expandSegment(g.rightSide,g.item,g.levelName,g.changeTime)}})}var f={};f.movesAwayFromLastSave=0;var g=[],h=[],i={};return f.updateCurChangeObj=function(a){var b;if("SSFF"===a.type)b=String(a.type+"#"+a.trackName)+"#"+String(a.sampleBlockIdx)+"#"+String(a.sampleIdx),console.log(b),i[b]?(a.oldValue=i[b].oldValue,i[b]=a):i[b]=a;
else if("ESPS"===a.type)switch(a.action){case"moveBoundary":case"movePoint":case"moveSegment":b=String(a.type+"#"+a.action+"#"+a.name+"#"+a.id),i[b]?(a.movedBy+=i[b].movedBy,i[b]=a):i[b]=a}return i},f.addCurChangeObjToUndoStack=function(){h=[],$.isEmptyObject(i)||(g.push(i),f.movesAwayFromLastSave+=1),a.info(i),i={}},f.addObjToUndoStack=function(a){h=[];var b={},c=String(a.type+"#"+a.action+"#"+a.name+"#"+a.id);b[c]=angular.copy(a),$.isEmptyObject(b)||(g.push(b),f.movesAwayFromLastSave+=1),i={}},f.undo=function(){if(g.length>0){var a=angular.copy(g[g.length-1]);h.push(a),e(a,!0),g.pop(),f.movesAwayFromLastSave-=1}},f.redo=function(){if(h.length>0){var a=angular.copy(h[h.length-1]);g.push(a),e(a,!1),h.pop(),f.movesAwayFromLastSave+=1}},f.getNrOfPossibleUndos=function(){return g.length},f.getCurrentStack=function(){return{undo:g,redo:h}},f.resetToInitState=function(){g=[],h=[],i={},f.movesAwayFromLastSave=0},f}]),angular.module("emuwebApp").service("Wavparserservice",["$q",function(a){var b,c={},d=new Worker("scripts/workers/wavParserWorker.js");return d.addEventListener("message",function(a){"SUCCESS"===a.data.status.type?b.resolve(a.data.data):b.reject(a.data)},!1),c.parseWavArrBuf=function(c){return b=a.defer(),d.postMessage({cmd:"parseBuf",buffer:c},[c]),b.promise},c}]),angular.module("emuwebApp").service("Textgridparserservice",["$q","LevelService","viewState","Soundhandlerservice",function(a,b,c,d){var e,f={},g=new Worker("scripts/workers/textGridParserWorker.js");return g.addEventListener("message",function(a){"SUCCESS"===a.data.status.type?e.resolve(a.data):e.reject(a.data)},!1),f.asyncToTextGrid=function(){return e=a.defer(),g.postMessage({cmd:"toTextGrid",levels:b.getData().levels,sampleRate:d.wavJSO.SampleRate,buffLength:d.wavJSO.Data.length}),e.promise},f.asyncParseTextGrid=function(b,c,f){return e=a.defer(),g.postMessage({cmd:"parseTG",textGrid:b,sampleRate:d.wavJSO.SampleRate,annotates:c,name:f}),e.promise},f}]),angular.module("emuwebApp").factory("uuid",function(){function a(a){var b=(Math.random().toString(16)+"000000000").substr(2,8);return a?"-"+b.substr(0,4)+"-"+b.substr(4,4):b}var b={};return b.new=function(){return a()+a(!0)+a(!0)+a()},b.newHash=function(){return a()+a(!0)+a(!0)+a()},b.empty=function(){return"00000000-0000-0000-0000-000000000000"},b}),angular.module("emuwebApp").service("fontScaleService",function(){var a={};return a.lastTextWidth=null,a.spaceTop=0,a.getTextImage=function(b,c,d,e,f){var g=b.canvas.height/b.canvas.offsetHeight,h=b.canvas.width/b.canvas.offsetWidth;d=Math.floor(d+2-g/2);var i=document.createElement("canvas");i.setAttribute("width",Math.round(200*h)),i.setAttribute("height",Math.round(100*g));var j=i.getContext("2d");return j.save(),j.font=d+"px "+e,j.fillStyle=f,j.scale(h,g),j.fillText(c,0,d+a.spaceTop),a.lastTextWidth=j.measureText(c).width*h,j.restore(),i},a.getLastImageWidth=function(){return a.lastTextWidth},a.getTextImageTwoLines=function(b,c,d,e,f,g,h){var i=b.canvas.height/b.canvas.offsetHeight,j=b.canvas.width/b.canvas.offsetWidth;e=Math.floor(e+2-i/2);var k=document.createElement("canvas");k.setAttribute("width",Math.round(200*j)),k.setAttribute("height",Math.round(100*i));var l=k.getContext("2d");if(l.save(),l.font=e+"px "+f,l.fillStyle=g,l.scale(j,i),a.lastTextWidth=l.measureText(c).width*j,h)l.fillText(c,0,e+a.spaceTop),l.fillText(d,0,2*e+a.spaceTop);else{var m=l.measureText(c).width,n=l.measureText(d).width;m>n?(l.fillText(c,0,e+a.spaceTop),l.fillText(d,m-n,2*e+a.spaceTop)):(l.fillText(c,n-m,e+a.spaceTop),l.fillText(d,0,2*e+a.spaceTop))}return l.restore(),k},a}),angular.module("emuwebApp").service("Espsparserservice",["$q","LevelService","Soundhandlerservice",function(a,b,c){var d,e={},f=new Worker("scripts/workers/espsParserWorker.js");return f.addEventListener("message",function(a){"SUCCESS"===a.data.status.type?d.resolve(a.data):d.reject(a.data)},!1),e.asyncParseEsps=function(b,e,g){return d=a.defer(),f.postMessage({cmd:"parseESPS",textGrid:b,sampleRate:c.wavJSO.SampleRate,annotates:e,name:g}),d.promise},e.asyncParseJSO=function(e){return d=a.defer(),f.postMessage({cmd:"parseJSO",level:b.getLevelDetails(e).level,sampleRate:c.wavJSO.SampleRate}),d.promise},e}]),angular.module("emuwebApp").controller("LoginCtrl",["$scope","$rootScope","$http","ConfigProviderService","Iohandlerservice","viewState","dialogService",function(a,b,c,d,e,f,g){a.loginData={username:"",password:"",errorMsg:""},a.tryLogin=function(){e.logOnUser(a.loginData.username,a.loginData.password).then(function(b){"LOGGEDON"===b?g.close(!0):a.loginData.errorMsg="ERROR: "+b})},a.cursorInTextField=function(){f.focusInTextField=!0},a.cursorOutOfTextField=function(){f.focusInTextField=!1},a.cancel=function(){g.close(!1)}}]),angular.module("emuwebApp").service("Ssffdataservice",function(){var a={};return a.data=[],a.getColumnOfTrack=function(b,c){var d;return a.data.forEach(function(a){a.ssffTrackName===b&&a.Columns.forEach(function(a){a.name===c&&(d=a)})}),void 0!==d?d:void alert("could not getColumnOfTrack of trackname: "+b)},a.getSampleRateAndStartTimeOfTrack=function(b){var c={};return a.data.forEach(function(a){a.ssffTrackName===b&&(c.sampleRate=a.sampleRate,c.startTime=a.startTime)}),void 0!==c?c:void alert("could not getSampleRateAndStartTimeOfTrack of trackname: "+b)},a}),angular.module("emuwebApp").service("LevelService",["ConfigProviderService","Soundhandlerservice","viewState",function(a,b,c){function d(a,b){var c;return angular.forEach(b,function(b,d){b.name===a&&(c=d)}),c}var e={};return e.data={},e.maxElementID=0,e.lasteditArea=null,e.lasteditAreaElem=null,e.getData=function(){return e.data},e.setData=function(a){angular.copy(a,e.data),angular.forEach(e.data.levels,function(a){a.items.forEach(function(a){a.id>e.maxElementID&&(e.maxElementID=a.id)})})},e.getNewId=function(){return e.maxElementID+=1,e.maxElementID},e.raiseId=function(a){e.maxElementID+=a},e.lowerId=function(a){e.maxElementID-=a},e.getLevelDetails=function(a){var b=null,c=null;return angular.forEach(e.data.levels,function(d,e){d.name===a&&(b=d,c=e)}),{level:b,id:c}},e.getOrderById=function(a,b){var c=void 0;return angular.forEach(e.data.levels,function(d){d.name===a&&d.items.forEach(function(a,d){a.id===b&&(c=d)})}),c},e.getIdByOrder=function(a,b){var c=null;return angular.forEach(e.data.levels,function(d){d.name===a&&d.items.forEach(function(a,d){d==b&&(c=a.id)})}),c},e.getElementDetails=function(a,b){var c=null;return angular.forEach(e.data.levels,function(d){d.name===a&&d.items.forEach(function(a,d){d==b&&(c=a)})}),c},e.getLastElement=function(a){var b=null;return angular.forEach(e.data.levels,function(c){c.name===a&&(b=c.items[c.items.length-1])}),b},e.getNextElement=function(a,b){var c=null;return angular.forEach(e.data.levels,function(d){d.name===a&&d.items.forEach(function(a,e){a.id==b&&(c=d.items[e+1])})}),c},e.getElementDetailsById=function(a,b){var c=null;return angular.forEach(e.data.levels,function(d){d.name===a&&d.items.forEach(function(a){a.id==b&&(c=a)})}),c},e.getlasteditAreaElem=function(){return e.lasteditAreaElem},e.setlasteditAreaElem=function(a){e.lasteditAreaElem=a},e.setlasteditArea=function(a){e.lasteditArea=a},e.getlasteditArea=function(){return e.lasteditArea},e.getlastID=function(){return e.lasteditArea.substr(1)},e.deleteEditArea=function(){null!==e.getlasteditArea()&&$("."+e.getlasteditArea()).remove(),c.editing=!1},e.openEditArea=function(a,b,f){var g=c.getcurClickLevelName(),h=c.getCurAttrDef(g),i=d(h,a.labels),j=b.find("canvas").context.getContext("2d"),k=j.canvas.clientWidth,l=j.canvas.offsetLeft,m=j.canvas.offsetTop,n=j.canvas.clientHeight;if("SEGMENT"===f){var o=c.getPos(k,a.sampleStart)+l,p=c.getPos(k,a.sampleStart+a.sampleDur)+l,q=p-o;if(20>q)return c.zoomViewPort(!0),void e.openEditArea(a,b,f);e.createEditArea(b,o,m,p-o,n,a.labels[i].value,a.id)}else{var r=10*a.labels[i].value.length,o=c.getPos(k,a.samplePoint)+l-r/2,p=c.getPos(k,a.samplePoint)+l+r/2,q=p-o;20>q&&(q=20),e.createEditArea(b,o+(p-o)/3,m,q,n,a.labels[i].value,a.id)}e.createSelection(b.find("textarea")[0],0,a.labels[i].value.length)},e.createSelection=function(a,b,c){if(a.createTextRange){var d=a.createTextRange();d.collapse(!0),d.moveStart("character",b),d.moveEnd("character",c),d.select()}else a.setSelectionRange?a.setSelectionRange(b,c):a.selectionStart&&(a.selectionStart=b,a.selectionEnd=c);a.focus()},e.createEditArea=function(a,b,c,d,e,f,g){var h="_"+g;a.prepend($("<textarea>").attr({id:h,"class":h+" emuwebapp-labelEdit","ng-model":"message",autofocus:"true"}).css({left:Math.round(b+2)+"px",top:Math.round(c)+"px",width:Math.round(d)-4+"px",height:Math.round(e)-1+"px","padding-top":Math.round(e/3+1)+"px"}).text(f))},e.insertElementDetails=function(b,d,f,g,h,i){var j,k=a.getLevelDefinition(d).attributeDefinitions,l=c.getCurAttrDef(d);angular.forEach(e.data.levels,function(a){if(a.name===d){if("SEGMENT"==a.type){j={id:b,sampleStart:h,sampleDur:i,labels:[]};for(var c=0;c<k.length;c++)j.labels.push(k[c].name===l?{name:d,value:g}:{name:k[c].name,value:""})}else if("EVENT"==a.type){j={id:b,samplePoint:h,labels:[]};for(var c=0;c<k.length;c++)j.labels.push(k[c].name===l?{name:d,value:g}:{name:k[c].name,value:""})}a.items.splice(f,0,j)}})},e.setElementDetails=function(a,b,c,d,f,g){angular.forEach(e.data.levels,function(e){e.name===a&&e.items.forEach(function(a){a.id==b&&(void 0!==f&&(a.sampleStart=f),void 0!==g&&(a.sampleDur=g),void 0!==c&&(a.labels[d].value=c))})})},e.setPointDetails=function(a,b,c,d){angular.forEach(e.data.levels,function(e){e.name===a&&e.items.forEach(function(a){a.id==b&&(a.samplePoint=d,a.labels[0].value=c)})})},e.getElementNeighbourDetails=function(a,b,c){var d=void 0,f=void 0;return angular.forEach(e.data.levels,function(e){e.name===a&&e.items.forEach(function(a,g){a.id==b&&(d=e.items[g-1]),a.id==c&&(f=e.items[g+1])})}),{left:d,right:f}},e.getEvent=function(a,b,c){var d=e.getLevelDetails(b).level,f=d.items[0],g=!1;if(0==d.items.length)return{evtr:void 0,nearest:void 0};if("SEGMENT"===d.type)angular.forEach(d.items,function(b,c){a>=b.sampleStart&&a<=b.sampleStart+b.sampleDur&&(a-b.sampleStart>=b.sampleDur/2?void 0!==d.items[c+1]?g=d.items[c+1]:(g=!0,f=d.items[d.items.length-1]):g=d.items[c]),a>=b.sampleStart&&(a<=b.sampleStart+b.sampleDur?f=b:(g=!0,f=d.items[d.items.length-1]))});else{var h=0,i=0;angular.forEach(d.items,function(b,e){i=e<d.items.length-1?b.samplePoint+(d.items[e+1].samplePoint-d.items[e].samplePoint)/2:c,h=e>0?b.samplePoint-(d.items[e].samplePoint-d.items[e-1].samplePoint)/2:0,i>=a&&a>=h&&(f=b,g=b)})}return{evtr:f,nearest:g}},e.deleteLevel=function(b,c){var d=e.data.levels[b];return e.data.levels.splice(b,1),a.vals.perspectives[c].levelCanvases.order.splice(b,1),d},e.addLevel=function(b,c,d){void 0!==e.data.levels?(e.data.levels.splice(c,0,b),a.vals.perspectives[d].levelCanvases.order.splice(c,0,b.name)):(e.data.levels=[],e.data.levels.splice(c,0,b),a.vals.perspectives[d].levelCanvases.order.splice(c,0,b.name))},e.renameLabel=function(a,b,f){var g=c.getCurAttrDef(a),h=e.getElementDetailsById(a,b),i=d(g,h.labels);e.setElementDetails(a,b,f,i)},e.renameLevel=function(b,c,d){angular.forEach(e.data.levels,function(a){a.name===b&&(a.name=c,angular.forEach(a.items,function(a){a.labels[0].name=c}))}),a.vals.perspectives[d].levelCanvases.order[a.vals.perspectives[d].levelCanvases.order.indexOf(b)]=c},e.deleteSegmentsInvers=function(a,b,f,g){var h,i,j,k=c.getCurAttrDef(a);j=0,angular.forEach(e.data.levels,function(b){if(b.name===a){j=g.order;for(i in g.segments)b.items.splice(j++,0,g.segments[i])}});var l=e.getElementNeighbourDetails(a,g.segments[0].id,g.segments[g.segments.length-1].id);void 0!==l.left&&void 0===l.right?(h=d(k,l.left.labels),e.setElementDetails(a,l.left.id,l.left.labels[h].value,h,l.left.sampleStart,l.left.sampleDur-g.timeRight)):void 0===l.left&&void 0!==l.right?(h=d(k,l.right.labels),e.setElementDetails(a,l.right.id,l.right.labels[h].value,h,l.right.sampleStart+g.timeLeft,l.right.sampleDur-g.timeLeft)):void 0===l.left&&void 0===l.right||(h=d(k,l.left.labels),e.setElementDetails(a,l.left.id,l.left.labels[h].value,h,l.left.sampleStart,l.left.sampleDur-g.timeLeft),e.setElementDetails(a,l.right.id,l.right.labels[h].value,h,l.right.sampleStart+g.timeRight,l.right.sampleDur-g.timeRight))},e.deleteSegments=function(a,b,f){for(var g=e.getElementDetailsById(a,b),h=e.getOrderById(a,b),i=e.getElementDetails(a,h+f-1),j=e.getElementNeighbourDetails(a,g.id,i.id),k=0,l=0,m=null,n=null,o=null,p=c.getCurAttrDef(a),q=d(p,g.labels),r=h;h+f>r;r++)k+=e.getElementDetails(a,r).sampleDur;return k%2==0?(k/=2,l=k):(k=Math.ceil(k/2),l=k-1),angular.forEach(e.data.levels,function(c){c.name===a&&angular.forEach(c.items,function(a,d){a.id==b&&(m=d,n=c.items.splice(m,f))})}),void 0!==j.left&&void 0===j.right?(e.setElementDetails(a,j.left.id,void 0,q,j.left.sampleStart,j.left.sampleDur+l),o=j.left):void 0===j.left&&void 0!==j.right?(e.setElementDetails(a,j.right.id,void 0,q,j.right.sampleStart-k,j.right.sampleDur+k),o=j.right):void 0===j.left&&void 0===j.right?c.setcurMouseSegment(void 0,void 0,void 0):(e.setElementDetails(a,j.left.id,void 0,q,j.left.sampleStart,j.left.sampleDur+k),e.setElementDetails(a,j.right.id,void 0,q,j.right.sampleStart-l,j.right.sampleDur+l),o=j.left),{order:m,segments:n,timeLeft:k,timeRight:l,clickSeg:o}},e.insertSegmentInvers=function(a,b,c){var d,f=!0;return angular.forEach(e.data.levels,function(e){if(e.name===a)if(b==c){var g=-1;if(angular.forEach(e.items,function(a,c){b==a.sampleStart&&(g=c,f=!0)}),f){var h=0;void 0!==e.items[g]&&(h=e.items[g].sampleDur),void 0!==e.items[g-1]&&(e.items[g-1].sampleDur+=h),e.items.splice(g,1)}}else{var g=-1;angular.forEach(e.items,function(a,c){b==a.sampleStart&&(g=c,f=!0)}),f&&(void 0===e.items[g+1]?e.items.splice(g-1,2):void 0===e.items[g-1]?e.items.splice(g,2):(h=e.items[g].sampleDur,d=e.items[g+1].sampleDur,e.items[g-1].sampleDur+=h+d,e.items.splice(g,2)))}}),f},e.insertSegment=function(a,b,c,d,f){var g=!0;return angular.forEach(e.data.levels,function(h){if(h.name===a)if(b==c){if(0==h.items.length)return{ret:!1,ids:f};void 0===f&&(f=[],f[0]=e.getNewId());var i=-1;if(b<h.items[0].sampleStart){var j=h.items[0].sampleStart-b;e.insertElementDetails(f[0],a,0,d,b,j)}else if(b>h.items[h.items.length-1].sampleStart+h.items[h.items.length-1].sampleDur){var k=h.items[h.items.length-1].sampleStart+h.items[h.items.length-1].sampleDur;e.insertElementDetails(f[0],a,h.items.length,d,k,b-k)}else if(angular.forEach(h.items,function(a,c){b>=a.sampleStart&&b<=a.sampleStart+a.sampleDur&&(i=c),a.sampleStart==b&&(g=!1),a.sampleStart+a.sampleDur==b&&(g=!1)}),g){var j=b-h.items[i].sampleStart;e.insertElementDetails(f[0],a,i+1,d,b,h.items[i].sampleDur-j),h.items[i].sampleDur=j}}else if(void 0===f&&(f=[],f[0]=e.getNewId(),f[1]=e.getNewId()),0==h.items.length)e.insertElementDetails(f[0],a,0,d,b,c-b);else if(c<h.items[0].sampleStart){var j=h.items[0].sampleStart-c,l=c-b;e.insertElementDetails(f[0],a,0,d,c,j),e.insertElementDetails(f[1],a,0,d,b,l)}else if(b>h.items[h.items.length-1].sampleStart+h.items[h.items.length-1].sampleDur){var j=b-(h.items[h.items.length-1].sampleStart+h.items[h.items.length-1].sampleDur),l=c-b,m=h.items.length;e.insertElementDetails(f[0],a,m,d,h.items[h.items.length-1].sampleStart+h.items[h.items.length-1].sampleDur,j),e.insertElementDetails(f[1],a,m+1,d,b,l)}else{var i=-1,n=-1;if(angular.forEach(h.items,function(a,d){b>=a.sampleStart&&b<=a.sampleStart+a.sampleDur&&(i=d),c>=a.sampleStart&&c<=a.sampleStart+a.sampleDur&&(n=d)}),g=i===n,i===n&&-1!==i){var j=b-h.items[i].sampleStart,l=c-b;e.insertElementDetails(f[0],a,i+1,d,b,l),e.insertElementDetails(f[1],a,i+2,d,c,h.items[i].sampleDur-j-l),h.items[i].sampleDur=j}}}),{ret:g,ids:f}},e.insertPoint=function(a,b,c,d){var f=!1,g=void 0;return angular.forEach(e.data.levels,function(h){if(h.name===a&&"EVENT"===h.type){{h.items[0].samplePoint}angular.forEach(h.items,function(a,c){Math.floor(b)===Math.floor(a.samplePoint)&&(f=!0),b>a.samplePoint&&(g=c+1)}),f||(void 0===d&&(d=e.getNewId()),e.insertElementDetails(d,a,g,c,b))}}),{ret:!f,id:d}},e.deletePoint=function(a,b){var c=!1;return angular.forEach(e.data.levels,function(d){if(d.name===a&&"EVENT"==d.type){angular.forEach(d.items,function(a,e){c||b==a.id&&(c=a,d.items.splice(e,1))})}}),c},e.deleteBoundary=function(a,b){var c=null,d=null,f=null,g=null,h=e.getElementDetailsById(a,b);return angular.forEach(e.data.levels,function(b){b.name===a&&(angular.forEach(b.items,function(a,e){"SEGMENT"===b.type&&h.sampleStart==a.sampleStart&&h.sampleDur==a.sampleDur&&(c.labels[0].value+=a.labels[0].value,c.sampleDur+=a.sampleDur,b.items.splice(e,1),d=e,f=a,g=c),c=a}),null==g&&(g=b.items[0]))}),{order:d,event:f,clickSeg:g}},e.deleteBoundaryInvers=function(a,b,c){angular.forEach(e.data.levels,function(b){if(b.name===a){b.items.splice(c.order,0,c.event);var d=b.items[c.order-1].labels[0].value.slice(0,b.items[c.order-1].labels[0].value.length-c.event.labels[0].value.length);b.items[c.order-1].labels[0].value=d,b.items[c.order-1].sampleDur-=c.event.sampleDur}})},e.snapBoundary=function(a,b,c,d,f){var g,h,i,j,k=1/0,l=void 0;return"SEGMENT"==f?i=c.sampleStart:"EVENT"==f&&(i=c.samplePoint),angular.forEach(e.data.levels,function(c,d){if(c.name===b){if(a){if(!(d>=1))return!1;g=e.data.levels[d-1]}else{if(!(d<e.data.levels.length-1))return!1;g=e.data.levels[d+1]}g.items.forEach(function(a){"SEGMENT"==g.type?j=a.sampleStart:"EVENT"==g.type&&(j=a.samplePoint),h=Math.abs(i-j),k>h&&(k=h,l=j-i)})}}),void 0!==l?("SEGMENT"==f?this.moveBoundary(b,c.id,l,0):"EVENT"==f&&this.movePoint(b,c.id,l),l):!1},e.moveBoundary=function(a,f,g,h){var i=e.getElementDetailsById(a,f),j=c.getCurAttrDef(a),k=d(j,i.labels),l=e.getElementNeighbourDetails(a,f,f);if(-1===h){var m=l.right;void 0!==m?i.sampleStart+g>0&&i.sampleStart+g<m.sampleStart&&e.setElementDetails(a,i.id,void 0,k,i.sampleStart+g,i.sampleDur-g):i.sampleStart+g>0&&i.sampleDur-g>=0&&i.sampleStart+i.sampleDur+g<=b.wavJSO.Data.length&&e.setElementDetails(a,i.id,void 0,k,i.sampleStart+g,i.sampleDur-g)}else if(1===h)i.sampleDur+g>=1&&i.sampleDur+i.sampleStart+g<=b.wavJSO.Data.length&&e.setElementDetails(a,i.id,void 0,k,i.sampleStart,i.sampleDur+g);else if(void 0===l.left){var m=l.right;void 0!==m?i.sampleStart+g>0&&i.sampleStart+g<m.sampleStart&&e.setElementDetails(a,i.id,void 0,k,i.sampleStart+g,i.sampleDur-g):i.sampleStart+g>0&&i.sampleStart+i.sampleDur+g<=b.wavJSO.Data.length&&e.setElementDetails(a,i.id,void 0,k,i.sampleStart+g,i.sampleDur-g)}else{var n=l.left;n.sampleDur+g>=0&&i.sampleStart+g>0&&i.sampleDur-g>0&&(e.setElementDetails(a,l.left.id,void 0,k,n.sampleStart,n.sampleDur+g),e.setElementDetails(a,i.id,void 0,k,i.sampleStart+g,i.sampleDur-g))}},e.movePoint=function(a,c,d){var f=e.getElementDetailsById(a,c);f.samplePoint+d>0&&f.samplePoint+d<=b.wavJSO.Data.length&&e.setPointDetails(a,f.id,f.labels[0].value,f.samplePoint+d)},e.moveSegment=function(a,f,g,h){var i=e.getOrderById(a,f),j=e.getElementDetails(a,i),k=e.getElementDetails(a,i+g-1),l=e.getElementNeighbourDetails(a,j.id,k.id),m=c.getCurAttrDef(a),n=d(m,j.labels);if(void 0===l.left&&void 0!==l.right){var o=e.getElementDetailsById(a,l.right.id);if(j.sampleStart+h>=1&&l.right.sampleDur-h>=1){e.setElementDetails(a,o.id,void 0,n,o.sampleStart+h,o.sampleDur-h);for(var p=i;i+g>p;p++){var q=e.getElementDetails(a,p);e.setElementDetails(a,q.id,void 0,n,q.sampleStart+h,q.sampleDur)}}}else if(void 0===l.right&&void 0!==l.left){var r=e.getElementDetailsById(a,l.left.id);if(l.left.sampleDur+h>=1&&k.sampleStart+k.sampleDur+h<b.wavJSO.Data.length){e.setElementDetails(a,r.id,void 0,n,r.sampleStart,r.sampleDur+h);for(var p=i;i+g>p;p++){var q=e.getElementDetails(a,p);e.setElementDetails(a,q.id,void 0,n,q.sampleStart+h,q.sampleDur)}}}else if(void 0!==l.right&&void 0!==l.left){var s=e.getElementDetailsById(a,l.left.id),t=e.getElementDetailsById(a,l.right.id);if(s.sampleDur+h>0&&t.sampleDur-h>0){e.setElementDetails(a,s.id,void 0,n,s.sampleStart,s.sampleDur+h),e.setElementDetails(a,t.id,void 0,n,t.sampleStart+h,t.sampleDur-h);for(var p=i;i+g>p;p++){var q=e.getElementDetails(a,p);e.setElementDetails(a,q.id,void 0,n,q.sampleStart+h,q.sampleDur)}}}else if(void 0===l.right&&void 0===l.left){var u=e.getElementDetails(a,i),v=e.getElementDetails(a,i+g-1);if(u.sampleStart+h>0&&v.sampleDur+v.sampleStart+h<b.wavJSO.Data.length)for(var p=i;i+g>p;p++){var q=e.getElementDetails(a,p);e.setElementDetails(a,q.id,void 0,n,q.sampleStart+h,q.sampleDur)}}},e.expandSegment=function(a,f,g,h){var i=0,j=e.getElementNeighbourDetails(g,f[0].id,f[f.length-1].id),k=h*f.length,l=c.getCurAttrDef(g),m=d(l,f[0].labels);if(a)if(void 0===j.right){var n=f[f.length-1].sampleStart+f[f.length-1].sampleDur+h*f.length;n<b.wavJSO.Data.length&&angular.forEach(f,function(a){e.setElementDetails(g,a.id,void 0,m,a.sampleStart+i,a.sampleDur+h),i+=h})}else angular.forEach(f,function(a){k+=a.sampleDur}),k>0&&j.right.sampleDur-h*f.length>0&&(angular.forEach(f,function(a){e.setElementDetails(g,a.id,void 0,m,a.sampleStart+i,a.sampleDur+h),i+=h}),e.setElementDetails(g,j.right.id,void 0,m,j.right.sampleStart+i,j.right.sampleDur-i));else if(void 0===j.left){var o=e.getElementDetails(g,0);o.sampleStart+h*(f.length+1)>0&&angular.forEach(f,function(a){e.setElementDetails(g,a.id,void 0,a.sampleStart-h,m,a.sampleDur+h)})}else angular.forEach(f,function(a){k+=a.sampleDur}),k>0&&j.left.sampleDur-h*f.length>0&&(i=0,angular.forEach(f,function(a,b){i=-(f.length-b)*h,e.setElementDetails(g,a.id,void 0,m,a.sampleStart+i,a.sampleDur+h)}),e.setElementDetails(g,j.left.id,void 0,m,j.left.sampleStart,j.left.sampleDur-f.length*h))},e.calcDistanceToNearestZeroCrossing=function(a){for(var c,d=a;d<b.wavJSO.Data.length-1;d++)if(b.wavJSO.Data[d]>=0&&b.wavJSO.Data[d+1]<0||b.wavJSO.Data[d]<0&&b.wavJSO.Data[d+1]>=0){c=d-a;break}for(var e,d=a;d>1;d--)if(b.wavJSO.Data[d]>=0&&b.wavJSO.Data[d-1]<0||b.wavJSO.Data[d]<0&&b.wavJSO.Data[d-1]>=0){e=d-a;break}var f;return f=Math.abs(e)<Math.abs(c)?e:c+1},e}]),angular.module("emuwebApp").service("Websockethandler",["$q","$rootScope","$location","$timeout","HistoryService","Ssffparserservice","ConfigProviderService","viewState","Wavparserservice","Soundhandlerservice","Espsparserservice","uuid","Binarydatamaniphelper","Ssffdataservice","dialogService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){function p(a){A=!0,b.$apply(z.resolve(a))}function q(a){u(angular.fromJson(a.data))}function r(a){console.error("WEBSOCKET ERROR!!!!!"),b.$apply(z.resolve(a))}function s(){A=!1,console.log("WEBSOCKET closed!!!!!")}function t(b){var c=a.defer(),e=v();return x[e]={time:new Date,cb:c},b.callbackID=e,y.send(angular.toJson(b)),d(function(){var a={callbackID:e,status:{type:"ERROR:TIMEOUT",message:"Sent request of type: "+b.type+" timed out after "+g.vals.main.serverTimeoutInterval+"ms!  Please check the server..."}};u(a)},g.vals.main.serverTimeoutInterval),c.promise}function u(a){var c=a;if(x.hasOwnProperty(c.callbackID)){switch(c.type){case"getESPSfile":handleReceivedESPS(c.fileName,c.data);break;case"getSSFFfile":alert("esps"),handleReceivedSSFF(c.fileName,c.data)}"SUCCESS"===c.status.type?b.$apply(x[c.callbackID].cb.resolve(c.data)):o.open("views/error.html","ModalCtrl","Communication error with server! Error message is: "+c.status.message),delete x[c.callbackID]}else"ERROR:TIMEOUT"===c.status.type||o.open("views/error.html","ModalCtrl","What just happened? You should not be here...")}function v(){var a=l.new();return a}var w={},x={},y={},z={},A=!1;return w.initConnect=function(b){var c=a.defer();return y=new WebSocket(b),y.onopen=p,y.onmessage=q,y.onerror=r,y.onclose=s,z=c,c.promise},w.isConnected=function(){return A},w.closeConnect=function(){y.onclose=function(){},y.close()},w.getProtocol=function(){var a={type:"GETPROTOCOL"},b=t(a);return b},w.getDoUserManagement=function(){var a={type:"GETDOUSERMANAGEMENT"},b=t(a);return b},w.logOnUser=function(a,b){var c={type:"LOGONUSER",userName:a,pwd:b},d=t(c);return d},w.getDBconfigFile=function(){var a={type:"GETGLOBALDBCONFIG"},b=t(a);return b},w.getBundleList=function(){var a={type:"GETBUNDLELIST"},b=t(a);return b},w.getBundle=function(a){var b={type:"GETBUNDLE",name:a},c=t(b);return c},w.saveBundle=function(a){var b={type:"SAVEBUNDLE",data:a},c=t(b);return c},w}]),angular.module("emuwebApp").controller("WsconnectionCtrl",["$scope","ConfigProviderService","Iohandlerservice","viewState","dialogService",function(a,b,c,d,e){a.serverInfos={},a.serverInfos.Url=b.vals.main.serverUrl,a.connectionError="",d.focusInTextField=!0,a.tryConnection=function(){e.close(a.serverInfos.Url)},a.cancel=function(){e.close(!1)}}]),angular.module("emuwebApp").service("Binarydatamaniphelper",function(){var a={};return a.base64ToArrayBuffer=function(a){for(var b=window.atob(a),c=b.length,d=new Uint8Array(c),e=0;c>e;e++){var f=b.charCodeAt(e);d[e]=f}return d.buffer},a.arrayBufferToBase64=function(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;d>e;e++)b+=String.fromCharCode(c[e]);return window.btoa(b)},a}),angular.module("emuwebApp").service("dialogService",["$modal","viewState",function(a,b){var c={},d={};return c.open=function(c,e,f){return b.setState("modalShowing"),d=a.open({backdrop:"static",keyboard:!1,templateUrl:c,controller:e,resolve:{passedInTxt:function(){return f}}}),d.result},c.openExport=function(c,e,f,g){return b.setState("modalShowing"),d=a.open({backdrop:"static",keyboard:!1,templateUrl:c,controller:e,resolve:{exportData:function(){return f},exportName:function(){return g}}}),d.result},c.close=function(a){b.focusInTextField=!1,b.setState(b.prevState),d.close(a)},c}]),angular.module("emuwebApp").controller("WaitCtrl",["$scope","viewState",function(a,b){a.vs=b}]),angular.module("emuwebApp").service("Appcachehandler",["$http","dialogService",function(a,b){function c(){console.log("###### handleUpdatereadyEvent ##########"),b.open("views/confirmModal.html","ConfirmmodalCtrl","A new version of the EMU-WebApp is available and has already been downloaded and cached in your browser. Would you like to use it? CAUTION: A reload will delete all current changes... TIP: the next time you use the EMU-webApp you will automatically use the updated version)").then(function(a){a&&(e.swapCache(),window.location.reload())})}var d={},e=window.applicationCache;return e.addEventListener("updateready",c,!1),d.checkForNewVersion=function(){0!==e.status&&3!==e.status&&(console.log("INFO: appCache.status: "+e.status),e.update())},d}]),angular.module("emuwebApp").controller("AboutCtrl",["$scope","ConfigProviderService","dialogService",function(a,b,c){a.cps=b,a.getStrRep=function(a){var b;switch(a){case 8:b="BACKSPACE";break;case 9:b="TAB";break;case 13:b="ENTER";break;case 16:b="SHIFT";break;case 18:b="ALT";break;case 32:b="SPACE";break;case 37:b="";break;case 39:b="";break;case 38:b="";break;case 40:b="";break;case 42:b="+";break;case 43:b="+";break;case 45:b="-";break;case 95:b="-";break;default:b=String.fromCharCode(a)}return b},a.cancel=function(){c.close()}}]),angular.module("emuwebApp").controller("spectSettingsCtrl",["$scope","dialogService","viewState","LevelService",function(a,b,c,d){a.vs=c,a.options=Object.keys(a.vs.getWindowFunctions()),a.selWindowInfo={},a.selWindowInfo.name=Object.keys(a.vs.getWindowFunctions())[a.vs.spectroSettings.window-1],a.windowLengths=[32,64,128,256,512,1024,2048],a.modalVals={rangeFrom:a.vs.spectroSettings.rangeFrom,rangeTo:a.vs.spectroSettings.rangeTo,dynamicRange:a.vs.spectroSettings.dynamicRange,windowLength:a.vs.spectroSettings.windowLength,window:a.vs.spectroSettings.window,drawHeatMapColors:a.vs.spectroSettings.drawHeatMapColors,preEmphasisFilterFactor:a.vs.spectroSettings.preEmphasisFilterFactor,heatMapColorAnchors:c.spectroSettings.heatMapColorAnchors},a.cursorInTextField=function(){c.focusInTextField=!0},a.cursorOutOfTextField=function(){c.focusInTextField=!1},a.getColorOfAnchor=function(b){var c={"background-color":"rgb("+a.modalVals.heatMapColorAnchors[b][0]+","+a.modalVals.heatMapColorAnchors[b][1]+","+a.modalVals.heatMapColorAnchors[b][2]+")",width:"10px",height:"10px"};return c},a.saveSpectroSettings=function(){a.modalVals.dynamicRange%1===0?a.modalVals.rangeFrom%1===0?a.modalVals.rangeTo%1===0?a.modalVals.rangeFrom>=0?a.modalVals.rangeTo<=d.data.sampleRate/2?(c.setspectroSettings(a.modalVals.windowLength,a.modalVals.rangeFrom,a.modalVals.rangeTo,a.modalVals.dynamicRange,a.selWindowInfo.name,a.modalVals.drawHeatMapColors,a.modalVals.preEmphasisFilterFactor,a.modalVals.heatMapColorAnchors),a.cancel()):a.error("View Range (Hz) upper boundary is a value bigger than "+d.data.sampleRate/2):a.error("View Range (Hz) lower boundary is a value below zero"):a.error("View Range (Hz) upper boundary has to be an Integer value."):a.error("View Range (Hz) lower boundary has to be an Integer value."):a.error("Dynamic Range has to be an Integer value.")},a.error=function(a){b.close(),b.open("views/error.html","ModalCtrl","Sorry: "+a)},a.cancel=function(){b.close()}}]),angular.module("emuwebApp").controller("ConfirmmodalCtrl",["$scope","dialogService","passedInTxt",function(a,b,c){a.passedInTxt=c,a.confirm=function(){b.close(!0)},a.cancel=function(){b.close(!1)}}]),angular.module("emuwebApp").filter("regex",function(){return function(a,b){for(var c=new RegExp(b.toLowerCase()),d=[],e=0;e<a.length;e++)c.test(a[e].name.toLowerCase())&&d.push(a[e]);return d}}),angular.module("emuwebApp").filter("levelsFilter",["ConfigProviderService","viewState",function(a,b){return function(c){if(c){for(var d,e=new RegExp("SEGMENT"),f=new RegExp("EVENT"),g=[],h=0;h<c.length;h++)(e.test(c[h].type)||f.test(c[h].type))&&void 0!==a.vals.perspectives[b.curPerspectiveIdx].levelCanvases&&(d=a.vals.perspectives[b.curPerspectiveIdx].levelCanvases.order.indexOf(c[h].name),-1!==d&&(g[d]=c[h]));return g}}}]),angular.module("emuwebApp").controller("ModalCtrl",["$scope","dialogService","passedInTxt","viewState","LevelService","HistoryService",function(a,b,c,d,e,f){a.passedInTxt=c,a.passedOutTxt={"var":null},a.cancel=function(){b.close()},a.cursorInTextField=function(){d.focusInTextField=!0},a.cursorOutOfTextField=function(){d.focusInTextField=!1},a.saveChanges=function(){b.close("saveChanges")},a.discardChanges=function(){b.close("discardChanges")},a.renameLevel=function(){e.renameLevel(a.passedInTxt,a.passedOutTxt.var,d.curPerspectiveIdx),f.addObjToUndoStack({type:"ESPS",action:"renameLevel",newname:a.passedOutTxt.var,name:a.passedInTxt,curPerspectiveIdx:d.curPerspectiveIdx}),b.close()},a.deleteLevel=function(){var a=e.getLevelDetails(d.getcurClickLevelName());e.deleteLevel(d.getcurClickLevelIndex(),d.curPerspectiveIdx),f.addObjToUndoStack({type:"ESPS",action:"deleteLevel",level:a.level,id:d.getcurClickLevelIndex(),curPerspectiveIdx:d.curPerspectiveIdx}),b.close()}}]),angular.module("emuwebApp").directive("showMenu",["$animate",function(a){return{restrict:"A",link:function(b,c,d){b.$watch(d.showMenu,function(b){b?a.addClass(c,"emuwebapp-expandWidthTo200px"):(a.removeClass(c,"emuwebapp-expandWidthTo200px"),a.addClass(c,"emuwebapp-shrinkWidthTo0px"))})}}}]),angular.module("emuwebApp").directive("showTwod",["$animate",function(a){return{restrict:"A",link:function(b,c,d){b.$watch(d.showTwod,function(b){b?a.addClass(c,".slideIn2dCanvases"):a.removeClass(c,".slideIn2dCanvases")})}}}]),angular.module("emuwebApp").animation(".slideIn2dCanvases",function(){return{addClass:function(a){a.addClass("slide2dCanvases")},removeClass:function(a){a.removeClass("slide2dCanvases")}}}),angular.module("emuwebApp").directive("bgSplitter",["$rootScope","viewState",function(a,b){return{restrict:"E",replace:!0,transclude:!0,scope:{showTwoDimCans:"@"},template:'<div class="emuwebapp-split-panes vertical" ng-transclude></div>',controller:["$scope",function(a){a.panes=[],a.bottomRightResizePane,this.addPane=function(b){if(a.panes.length>1)throw"splitters can only have two panes";return a.panes.push(b),a.panes.length},this.setBottomRightResizePane=function(b){a.bottomRightResizePane=b}}],link:function(c,d,e){var f=!1,g=!1,h=!1,i=angular.element('<div class="emuwebapp-split-handler"><span></span></div>'),j=c.panes[0],k=c.panes[1],l=c.bottomRightResizePane,m=angular.element('<div class="emuwebapp-bottomRightResizePaneTopResizer"></div>'),n=angular.element('<div class="emuwebapp-bottomRightResizePaneLeftResizer"></div>'),o=angular.element('<div class="emuwebapp-bottomRightResizePaneCornerResizer"></div>');
l.elem.prepend(n),l.elem.prepend(m),l.elem.prepend(o);var p=j.minSize||0,q=k.minSize||0,r=!1,s=!1;j.elem.after(i),e.$observe("showTwoDimCans",function(a){"false"===a?c.bottomRightResizePane.elem.hide():c.bottomRightResizePane.elem.show()}),d.bind("mousemove",function(a){if(s){var c=d[0].getBoundingClientRect(),e=0;if(r){var m=c.bottom-c.top;if(e=a.clientY-c.top,p>e)return;if(q>m-e)return;i.css("top",e+"px"),j.elem.css("height",e+"px"),k.elem.css("top",e+"px"),b.setdragBarHeight(e)}if(f){var m=c.bottom-c.top;if(e=a.clientY-c.top,10>=e||10>=m-e)return;l.elem.css("top",e+"px");var n=m-e;l.elem.css("height",n+"px")}if(g){var o=c.right-c.left;if(e=a.clientX-c.left,10>=e||10>=o-e)return;l.elem.css("left",e+"px");var n=o-e;l.elem.css("width",n+"px")}if(h){var m=c.bottom-c.top;if(e=a.clientY-c.top,10>=e||10>=m-e)return;l.elem.css("top",e+"px");var n=m-e;l.elem.css("height",n+"px");var o=c.right-c.left;if(e=a.clientX-c.left,10>=e||10>=o-e)return;l.elem.css("left",e+"px");var n=o-e;l.elem.css("width",n+"px")}}}),i.bind("mousedown",function(c){c.preventDefault(),s=!0,r=!0,b.setdragBarActive(!0),a.$digest()}),m.bind("mousedown",function(c){c.preventDefault(),s=!0,f=!0,b.setdragBarActive(!0),a.$digest()}),n.bind("mousedown",function(c){c.preventDefault(),s=!0,g=!0,b.setdragBarActive(!0),a.$digest()}),o.bind("mousedown",function(c){c.preventDefault(),s=!0,h=!0,b.setdragBarActive(!0),a.$digest()}),angular.element(document).bind("mouseup",function(){s=!1,r=!1,f=!1,g=!1,h=!1,b.setdragBarActive(!1),a.$digest()})}}}]).directive("bgPane",function(){return{restrict:"E",require:"^bgSplitter",replace:!0,transclude:!0,scope:{minSize:"=",type:"@",showTwoDimCans:"@"},template:'<div class="{{typeclass}}" ng-transclude></div>',link:function(a,b,c,d){"emuwebapp-bottomRightResizePane"!==a.type?(a.elem=b,a.index=d.addPane(a),a.typeclass="split-pane"+a.index):(a.elem=b,a.index=3,a.typeclass="emuwebapp-bottomRightResizePane",d.setBottomRightResizePane(a))}}}),angular.module("emuwebApp").directive("ssffTrack",["$timeout","viewState","ConfigProviderService",function(a){return{templateUrl:"views/ssffTrack.html",restrict:"E",link:function(b,c,d){function e(){if(!$.isEmptyObject(b.ssffds.data)&&0!==b.ssffds.data.length){i.clearRect(0,0,i.canvas.width,i.canvas.height),b.dhs.drawMovingBoundaryLine(i),b.dhs.drawCurViewPortSelected(i,!1);var a=b.cps.getSsffTrackConfig(f),c=b.ssffds.getColumnOfTrack(a.name,a.columnName);b.dhs.drawMinMaxAndName(i,f,c._minVal,c._maxVal,2)}}var f,g=c.find("canvas").length,h=(c.find("canvas")[1],c.find("canvas")[g-1]),i=h.getContext("2d");d.$observe("trackName",function(a){a&&(f=a)}),b.order=d.order,b.$on("refreshTimeline",function(){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||e()}),b.$watch("vs.timelineSize",function(){a(b.redraw,10)}),b.$watch("vs.curViewPort",function(){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||e()},!0),b.$watch("ssffds.data.length",function(){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||e()},!0),b.$watch("vs.movingBoundary",function(){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||e()},!0),b.$watch("vs.movingBoundarySample",function(){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||e()},!0),b.redraw=function(){e()}}}}]),angular.module("emuwebApp").directive("progressThing",["$animate",function(a){return{template:'<div class="emuwebapp-progressThing">{{vs.somethingInProgressTxt}}</div>',restrict:"E",replace:!0,link:function(b,c,d){d.$observe("showThing",function(b){"true"===b?(a.removeClass(c,"emuwebapp-shrinkHeightTo0px"),a.addClass(c,"emuwebapp-expandHeightTo20px")):(a.removeClass(c,"emuwebapp-expandHeightTo20px"),a.addClass(c,"emuwebapp-shrinkHeightTo0px"))})}}}]),angular.module("emuwebApp").directive("epg",["viewState",function(){return{template:'<div class="emuwebapp-twoDimCanvasContainer"><canvas width="512" height="512"></canvas></div>',restrict:"E",replace:!0,link:function(a,b){function c(a){d=a.cps.getSsffTrackConfig("EPG"),e=a.ssffds.getColumnOfTrack(d.name,d.columnName),f=a.ssffds.getSampleRateAndStartTimeOfTrack(d.name);var b=g.getContext("2d");b.clearRect(0,0,g.width,g.height),b.fillStyle="green",b.strokeStyle=a.cps.vals.colors.osciColor,b.font=a.cps.vals.font.fontPxSize+"px "+a.cps.vals.font.fontType;var c,h=g.width/8,i=g.height/8,j=1/f.sampleRate-f.startTime,k=Math.round(a.vs.curMousePosSample/a.shs.wavJSO.SampleRate/j);angular.forEach(e.values[k],function(a,d){for(c=a.toString(2).split("").reverse();c.length<8;)c.push("0");c.forEach(function(a,c){"1"===a?(b.fillStyle="grey",b.fillRect(c*h+5,i*d+5,h-10,i-10)):(b.fillStyle="white",b.fillRect(c*h+5,i*d+5,h-10,i-10))})});var l=a.fontImage.getTextImageTwoLines(b,"EPG","Frame:"+k,a.cps.vals.font.fontPxSize,a.cps.vals.font.fontType,a.cps.vals.colors.labelColor,!0);b.drawImage(l,0,0,l.width,l.height,5,0,l.width,l.height)}var d,e,f,g=b.find("canvas")[0];a.$watch("vs.curViewPort",function(b,d){$.isEmptyObject(a.cps.vals)||$.isEmptyObject(a.ssffds.data)||0!==a.ssffds.data.length&&(d.sS!==b.sS||d.eS!==b.eS)&&c(a)},!0),a.$watch("vs.curMousePosSample",function(){$.isEmptyObject(a.cps.vals)||$.isEmptyObject(a.ssffds.data)||0!==a.ssffds.data.length&&c(a)},!0)}}}]),angular.module("emuwebApp").directive("dots",["viewState",function(){return{template:'<div class="emuwebapp-twoDimCanvasContainer"><canvas width="512" height="512"></canvas></div>',restrict:"E",replace:!0,link:function(a,b){function c(){for(var b=a.cps.vals.perspectives[a.vs.curPerspectiveIdx].twoDimCanvases.twoDimDrawingDefinitions[0],c=0;c<b.dots.length;c++){var d=a.cps.getSsffTrackConfig(b.dots[c].xSsffTrack),e=a.ssffds.getColumnOfTrack(d.name,d.columnName);e._minVal<f&&(f=e._minVal),e._maxVal>g&&(g=e._maxVal),d=a.cps.getSsffTrackConfig(b.dots[c].ySsffTrack);var j=a.ssffds.getColumnOfTrack(d.name,d.columnName);j._minVal<h&&(h=j._minVal),j._maxVal>i&&(i=j._maxVal)}}function d(){1/0===f&&c();var b=e.getContext("2d");b.clearRect(0,0,e.width,e.height);var d=b.canvas.width/b.canvas.offsetWidth,j=b.canvas.height/b.canvas.offsetHeight;b.beginPath(),b.moveTo(0,0),b.lineTo(5,5),b.moveTo(0,e.height),b.lineTo(5,e.height-5),b.moveTo(e.width,e.height),b.lineTo(e.width-5,e.height-5),b.stroke(),b.closePath();var k=3*a.cps.vals.font.fontPxSize/4,l=a.fontImage.getTextImage(b,"yMax: "+a.vs.round(i,2),k,a.cps.vals.font.fontType,a.cps.vals.colors.endBoundaryColor);b.drawImage(l,5,5,l.width,l.height),l=a.fontImage.getTextImageTwoLines(b,"yMin: "+a.vs.round(h,2),"xMin: "+a.vs.round(f,2),k,a.cps.vals.font.fontType,a.cps.vals.colors.endBoundaryColor,!0),b.drawImage(l,5,e.height-k*j*2-5,l.width,l.height);var m=b.measureText("xMax: "+a.vs.round(g,5)).width*d;l=a.fontImage.getTextImage(b,"xMax: "+a.vs.round(g,2),k,a.cps.vals.font.fontType,a.cps.vals.colors.endBoundaryColor),b.drawImage(l,e.width-m-5,e.height-k*j-5,l.width,l.height);var n,o=a.cps.vals.perspectives[a.vs.curPerspectiveIdx].twoDimCanvases.twoDimDrawingDefinitions[0],p=a.ssffds.getSampleRateAndStartTimeOfTrack(o.dots[0].xSsffTrack),q=a.ssffds.getSampleRateAndStartTimeOfTrack(o.dots[0].ySsffTrack),r=(1/p.sampleRate,a.vs.curMousePosSample/a.shs.wavJSO.SampleRate);n=Math.round(p.startTime===1/p.sampleRate/2?r*p.sampleRate:r*p.sampleRate+(p.startTime-1/p.sampleRate/2)*p.sampleRate);var s=a.cps.getSsffTrackConfig(o.dots[0].xSsffTrack),t=a.ssffds.getColumnOfTrack(s.name,s.columnName);n>t.values.length-1&&(n=t.values.length-1),m=b.measureText("frame: "+n).width*d,l=a.fontImage.getTextImage(b,"frame: "+n,a.cps.vals.font.fontPxSize-4,a.cps.vals.font.fontType,a.cps.vals.colors.endBoundaryColor);var u=90;b.save(),b.rotate(u*Math.PI/180),b.drawImage(l,e.width/2-m/2,-e.height),b.restore();for(var v=[],w=0;w<o.dots.length;w++){var s=a.cps.getSsffTrackConfig(o.dots[w].xSsffTrack),t=a.ssffds.getColumnOfTrack(s.name,s.columnName);s=a.cps.getSsffTrackConfig(o.dots[w].ySsffTrack);var x=a.ssffds.getColumnOfTrack(s.name,s.columnName);if(t.values.length!==x.values.length)return void alert("columns do not have same length or length of one not 1");var p=a.ssffds.getSampleRateAndStartTimeOfTrack(o.dots[w].xSsffTrack),q=a.ssffds.getSampleRateAndStartTimeOfTrack(o.dots[w].ySsffTrack);if(p.sampleRate!==q.sampleRate||p.startSample!==q.startSample)return void alert("xsRaSt.sampleRate !== ysRaSt.sampleRate || xsRaSt.startSample !== ysRaSt.startSample");var y=(t.values[n][o.dots[w].xContourNr]-f)/(g-f)*e.width,z=e.height-(x.values[n][o.dots[w].yContourNr]-h)/(i-h)*e.height,A=Math.PI/180*0,B=Math.PI/180*360;b.strokeStyle=o.dots[w].color,b.beginPath(),b.arc(y,z,20,A,B,!0),b.stroke(),b.closePath(),b.beginPath(),b.arc(y,z,2,A,B,!0),b.fill(),b.closePath();var l=a.fontImage.getTextImage(b,o.dots[w].name,a.cps.vals.font.fontPxSize-4,a.cps.vals.font.fontType,a.cps.vals.colors.labelColor);b.drawImage(l,y,z-5,l.width,l.height),v.push({name:o.dots[w].name,x:y,y:z})}var C,D;o.connectLines.forEach(function(a){v.forEach(function(b){b.name===a.fromDot&&(C=b),b.name===a.toDot&&(D=b)}),b.strokeStyle=a.color,b.beginPath(),b.moveTo(C.x,C.y),b.lineTo(D.x,D.y),b.stroke(),b.closePath()})}var e=b.find("canvas")[0],f=1/0,g=-1/0,h=1/0,i=-1/0;a.$watch("ssffds.data.length",function(){$.isEmptyObject(a.cps.vals)||$.isEmptyObject(a.ssffds.data)||0!==a.ssffds.data.length&&d(a)},!0),a.$watch("vs.curViewPort",function(b,c){$.isEmptyObject(a.cps.vals)||$.isEmptyObject(a.ssffds.data)||0!==a.ssffds.data.length&&(c.sS!==b.sS||c.eS!==b.eS)&&d(a)},!0),a.$watch("vs.curMousePosSample",function(){$.isEmptyObject(a.cps.vals)||$.isEmptyObject(a.ssffds.data)||0!==a.ssffds.data.length&&d(a)},!0),a.$watch("vs.curPerspectiveIdx",function(){f=1/0,g=-1/0,h=1/0,i=-1/0},!0)}}}]),angular.module("emuwebApp").directive("myDropZone",["$animate",function(){return{templateUrl:"views/myDropZone.html",restrict:"E",link:function(a,b){function c(b){b.preventDefault(),a.$apply(function(){a.dropText=a.dropDefault,a.dropClass=""})}function d(b){b.preventDefault(),a.$apply(function(){a.dropText=a.dropAllowed,a.dropClass="over"})}function e(b){b.stopPropagation(),b.preventDefault(),a.$apply(function(){if(a.dropText=a.dropParsingStarted,a.dropClass="",window.File&&window.FileReader&&window.FileList&&window.Blob)if(a.dropText=a.dropParsingStarted,a.dropClass="over",void 0!==b.originalEvent)if(a.firefox)for(var c=b.originalEvent.dataTransfer,d=c.files,e=(d.length,0);e<d.length;e++)a.traverseFileTreeFirefox(d[e]);else for(var f=b.originalEvent.dataTransfer.items,e=0;e<f.length;e++){var g=f[e].webkitGetAsEntry();g&&a.traverseFileTreeChrome(g)}else a.dropText=a.dropErrorFileType,a.dropClass="";else a.$parent.dials.open("views/error.html","ModalCtrl",a.dropErrorAPI),a.dropText=$scope.dropDefault})}a.dropDefault="Drop your files here or click here to open a file",a.dropErrorFileType="Error: Could not parse file. The following file types are supported: .WAV .TEXTGRID",a.dropErrorAPI="Sorry ! The File APIs are not fully supported in your browser.",a.dropNotAllowed="File is not allowed",a.dropAllowed="Drop files to start loading",a.dropParsingStarted="Parsing started",a.dropText=a.dropDefault,a.dropClass="",b.bind("drop",function(a){e(a)}),b.bind("dragover",function(a){d(a)}),b.bind("dragenter",function(a){c(a)}),b.bind("dragleave",function(a){c(a)}),b.bind("click",function(){b.context.children[0].children[1].click()})}}}]),angular.module("emuwebApp").directive("myDropZoneInput",["$animate",function(){return{templateUrl:"views/myDropZoneInput.html",restrict:"E",link:function(a,b){function c(){a.handler=!0;var c=b.context.children.fileDialog;if(a.firefox)for(var d=0;d<c.files.length;d++){var e=c.files[d],f=e.name.substr(e.name.lastIndexOf(".")+1).toUpperCase();"WAV"===f&&e.type.match("audio/x-wav")?(a.wav=e,a.handleLocalFiles()):"TEXTGRID"===f?a.grid=e:a.other=e}else for(var d=0;d<c.files.length;d++){var e=c.files[d],f=e.name.substr(e.name.lastIndexOf(".")+1).toUpperCase();"WAV"===f&&e.type.match("audio/wav")?(a.wav=e,a.handleLocalFiles()):"TEXTGRID"===f?a.grid=e:a.other=e}}a.handler=!1,b.bind("change",function(a){c(a)}),b.bind("click",function(){var a=angular.element("input");void 0!==a[1]&&a[1].click()})}}}]),angular.module("emuwebApp").directive("emuwebapp",["viewState","Iohandlerservice","ConfigProviderService",function(a,b,c){return{templateUrl:"views/emuwebapp.html",restrict:"E",scope:{audioGetUrl:"@",labelGetUrl:"@",labelType:"@"},link:function(b,d,e){d.bind("mouseenter",function(){a.mouseInEmuWebApp=!0}),d.bind("mouseleave",function(){a.mouseInEmuWebApp=!1}),e.$observe("audioGetUrl",function(a){void 0!==a&&""!==a&&(c.embeddedVals.audioGetUrl=a)}),e.$observe("labelGetUrl",function(a){void 0!==a&&""!==a&&(c.embeddedVals.labelGetUrl=a)}),e.$observe("labelType",function(a){void 0!==a&&""!==a&&(c.embeddedVals.labelType=a)})}}}]),angular.module("emuwebApp").service("Validationservice",["$http","$q",function(a,b){var c={},d=[],e=["annotationFileSchema","emuwebappConfigSchema","DBconfigFileSchema","bundleListSchema"];return c.loadSchemas=function(){var c=[];return angular.forEach(e,function(b){c.push(a.get("schemaFiles/"+b+".json"))}),b.all(c)},c.setSchemas=function(a){angular.forEach(a,function(a){d.push({name:a.config.url,data:a.data})})},c.validateJSO=function(a,b){var c;return angular.forEach(d,function(b){b.name==="schemaFiles/"+a+".json"&&(c=b)}),void 0!==c&&tv4.validate(b,c.data)?!0:void 0===c?"Schema: "+a+" is currently undefined! This is probably due to a misnamed schema file on the server...":tv4.error},c}]);