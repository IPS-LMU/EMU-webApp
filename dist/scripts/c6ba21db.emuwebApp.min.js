"use strict";ArrayBuffer.prototype.subarray=function(a,b){for(var c=new ArrayBuffer(b),d=new Int8Array(c),e=new Int8Array(this),f=0;b>f;f++)d[f]=e[a+f];return c},angular.module("emuwebApp",["ui","ui.bootstrap","ngAnimate"]).config(["$locationProvider",function(a){a.html5Mode(!0)}]),angular.module("emuwebApp").service("ConfigProviderService",["viewState",function(a){var b={};return b.vals={},b.curDbConfig={},b.embeddedVals={audioGetUrl:"",labelGetUrl:""},b.setVals=function(a){$.isEmptyObject(b.vals)?b.vals=a:angular.forEach(Object.keys(a),function(c){angular.isArray(b.vals[c])?(b.vals[c]=[],angular.forEach(a[c],function(a){b.vals[c].push(a)})):angular.forEach(Object.keys(a[c]),function(d){void 0!==b.vals[c][d]?b.vals[c][d]=a[c][d]:console.error("BAD ENTRY IN CONFIG! Key1: "+c+" key2: "+d)})})},b.getSsffTrackConfig=function(a){var c;return void 0!==b.curDbConfig.ssffTracks&&angular.forEach(b.curDbConfig.ssffTracks,function(b){b.name===a&&(c=b)}),c},b.getLimsOfTrack=function(c){var d={};return angular.forEach(b.vals.perspectives[a.curPerspectiveIdx].signalCanvases.contourLims,function(a){a.ssffTrackName===c&&(d.min=a.min,d.max=a.max)}),d},b.getAssignment=function(c){var d={};return angular.forEach(b.vals.perspectives[a.curPerspectiveIdx].signalCanvases.assign,function(a){a.signalCanvasName===c&&(d=a)}),d},b}]),angular.module("emuwebApp").controller("MainCtrl",["$scope","$rootScope","$modal","$log","$compile","$timeout","$q","$window","$document","viewState","HistoryService","Iohandlerservice","Soundhandlerservice","ConfigProviderService","fontScaleService","Ssffdataservice","Levelservice","dialogService","Textgridparserservice","Binarydatamaniphelper","Wavparserservice","Ssffparserservice","Drawhelperservice",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w){a.cps=n,a.hists=k,a.fontImage=o,a.tds=q,a.vs=j,a.dials=r,a.ssffds=p,a.shs=m,a.dhs=w,a.wps=u,a.io=l,a.connectBtnLabel="connect",a.tmp={},a.dbLoaded=!1,a.isRightSideMenuHidden=!0,a.is2dCancasesHidden=!0,a.showDropZone=!0,a.lastkeycode="N/A",a.bundleList=[],a.curUserName="",a.curBndl={},a.lastclickedutt=null,a.shortcut=null,a.filterText="",a.windowWidth=h.outerWidth,a.demoDbName="",angular.element(h).bind("resize",function(){j.deleteEditArea(),j.setWindowWidth(h.outerWidth),a.$digest()}),angular.element(h).bind("keyup",function(b){(b.keyCode===n.vals.keyMappings.shift||b.keyCode===n.vals.keyMappings.alt)&&(k.addCurChangeObjToUndoStack(),a.$digest())}),a.$watch("cps.embeddedVals.audioGetUrl",function(b){void 0!==b&&""!==b&&(console.log("fasdkfjadsklfjasldkfj"),console.log(b),a.loadFilesForEmbeddedApp())},!0),a.loadFilesForEmbeddedApp=function(){l.httpGetPath(n.embeddedVals.audioGetUrl,"arraybuffer").then(function(b){return"TextGrid"!==n.embeddedVals.labelGetUrl.split(".")[1]?void alert("File extention of embedded mode has to be .TextGrid"):(j.showDropZone=!1,j.getsubmenuOpen()&&a.openSubmenu(),j.somethingInProgressTxt="Loading DB config...",void l.httpGetPath("configFiles/embedded_config.json").then(function(a){j.curPerspectiveIdx=0,n.setVals(a.data.EMUwebAppConfig),delete a.data.EMUwebAppConfig,n.curDbConfig=a.data,j.somethingInProgress=!0,j.somethingInProgressTxt="Parsing WAV file...",u.parseWavArrBuf(b.data).then(function(a){var b=a;j.curViewPort.sS=0,j.curViewPort.eS=b.Data.length,j.curViewPort.bufferLength=b.Data.length,j.resetSelect(),m.wavJSO=b,l.httpGetPath(n.embeddedVals.labelGetUrl,"utf-8").then(function(a){j.somethingInProgressTxt="Parsing TextGrid file...",s.asyncParseTextGrid(a.data,n.embeddedVals.labelGetUrl,"embeddedTextGrid").then(function(a){var b=a.data;q.setData(b);var c=[];b.levels.forEach(function(a){c.push(a.name)}),n.vals.perspectives[j.curPerspectiveIdx].levelCanvases.order=c,j.somethingInProgressTxt="Done!",j.somethingInProgress=!1,j.setState("labeling")},function(a){console.error(a),r.open("views/error.html","ModalCtrl","Error parsing wav file: "+a.status.message)})},function(a){r.open("views/error.html","ModalCtrl","Could not get label file: "+n.embeddedVals.labelGetUrl+" ERROR "+a)})},function(a){r.open("views/error.html","ModalCtrl","Error parsing wav file: "+a.status.message)})},function(a){r.open("views/error.html","ModalCtrl","Could not get embedded_config.json: "+a)}))},function(a){r.open("views/error.html","ModalCtrl","Could not get audio file:"+n.embeddedVals.audioGetUrl+" ERROR: "+a)})},a.loadDefaultConfig=function(){l.httpGetDefaultConfig().success(function(b){n.setVals(b),a.handleDefaultConfigLoaded()}).error(function(a,b,c,d){r.open("views/error.html","ModalCtrl","Could not get defaultConfig for EMU-webApp:  status: "+b+" header: "+c+" config "+d)})},a.loadDefaultConfig(),a.handleDefaultConfigLoaded=function(){j.getsubmenuOpen()||a.openSubmenu(),a.shortcut=Object.create(n.vals.keyMappings);for(var b in a.shortcut)8===a.shortcut[b]?a.shortcut[b]="BACKSPACE":9===a.shortcut[b]?a.shortcut[b]="TAB":13===a.shortcut[b]?a.shortcut[b]="ENTER":16===a.shortcut[b]?a.shortcut[b]="SHIFT":18===a.shortcut[b]?a.shortcut[b]="ALT":27===a.shortcut[b]?a.shortcut[b]="ESC":32===a.shortcut[b]?a.shortcut[b]="SPACE":-1===a.shortcut[b]?a.shortcut[b]="NONE":38===a.shortcut[b]?a.shortcut[b]="ARROW UP":40===a.shortcut[b]?a.shortcut[b]="ARROW DOWN":187===a.shortcut[b]?a.shortcut[b]="+":189===a.shortcut[b]?a.shortcut[b]="-":a.shortcut[b.toString()]=String.fromCharCode(a.shortcut[b]);n.vals.main.autoConnect&&l.wsH.initConnect(n.vals.main.wsServerUrl).then(function(b){"error"===b.type?r.open("views/error.html","ModalCtrl","Could not connect to websocket server: "+n.vals.main.wsServerUrl):a.handleConnectedToWSserver()}),j.setspectroSettings(n.vals.spectrogramSettings.N,n.vals.spectrogramSettings.rangeFrom,n.vals.spectrogramSettings.rangeTo,n.vals.spectrogramSettings.dynamicRange,n.vals.spectrogramSettings.window),j.setTransitionTime(n.vals.colors.transitionTime/1e3),n.vals.restrictions.sortLabels},a.handleConnectedToWSserver=function(){a.showDropZone=!1,n.vals.main.comMode="WS",j.somethingInProgress=!0,j.somethingInProgressTxt="Checking protocol...",l.getProtocol().then(function(b){"EMU-webApp-websocket-protocol"===b.protocol&&"0.0.1"===b.version?(j.somethingInProgressTxt="Checking user management...",l.getDoUserManagement().then(function(b){"NO"===b?(j.somethingInProgressTxt="Loading DB config...",l.getDBconfigFile().then(function(b){j.curPerspectiveIdx=0,n.setVals(b.EMUwebAppConfig),delete b.EMUwebAppConfig,n.curDbConfig=b,j.somethingInProgressTxt="Loading bundle list...",l.getBundleList().then(function(b){a.bundleList=b,a.menuBundleClick(a.bundleList[0])})})):r.open("views/error.html","ModalCtrl","We are sorry but the EMU-webApp does not support user management yet...").then(function(){a.resetToInitState()})})):r.open("views/error.html","ModalCtrl","Could not connect to websocket server: "+n.vals.main.wsServerUrl+'. It does not speak the same protocol as this client. Its protocol answer was: "'+b.protocol+'" with the version: "'+b.version+'"').then(function(){a.resetToInitState()})})},a.downloadTextGrid=function(){console.log(l.toTextGrid())},a.getShortCut=function(b){return null!==a.shortcut?null!==a.shortcut[b]&&""!==a.shortcut[b]?a.shortcut[b]:"NONE":"NOT SET"},a.menuBundleClick=function(b){0!==k.movesAwayFromLastSave?b!==a.curBndl&&(a.lastclickedutt=b,r.open("views/saveChanges.html","ModalCtrl",b.name).then(function(c){"saveChanges"===c?a.menuBundleSaveBtnClick().then(function(){a.menuBundleClick(b)}):"discardChanges"===c&&(k.resetToInitState(),a.menuBundleClick(b))})):b!==a.curBndl&&(k.resetToInitState(),j.somethingInProgress=!0,j.somethingInProgressTxt="Loading bundle: "+b.name,p.data=[],l.getBundle(b.name,a.demoDbName).then(function(c){200===c.status&&(c=c.data);var d;d=t.base64ToArrayBuffer(c.mediaFile.data),j.somethingInProgressTxt="Parsing WAV file...",u.parseWavArrBuf(d).then(function(d){var e=d;j.curViewPort.sS=0,j.curViewPort.eS=e.Data.length,j.curViewPort.selectS=-1,j.curViewPort.selectE=-1,j.curClickSegments=[],j.curClickLevelName=void 0,j.curClickLevelType=void 0,j.curViewPort.bufferLength=e.Data.length,j.resetSelect(),m.wavJSO=e,j.somethingInProgressTxt="Parsing SSFF files...",v.asyncParseSsffArr(c.ssffFiles).then(function(d){p.data=d.data,q.setData(c.annotation),a.curBndl=b,j.setState("labeling"),j.somethingInProgress=!1,j.somethingInProgressTxt="Done!"},function(a){r.open("views/error.html","ModalCtrl","Error parsing SSFF file: "+a.status.message)})},function(a){r.open("views/error.html","ModalCtrl","Error parsing wav file: "+a.status.message)})},function(a){a.data?r.open("views/error.html","ModalCtrl","Error loading bundle: "+a.data):r.open("views/error.html","ModalCtrl","Error loading bundle: "+a.status.message)}))},a.menuBundleSaveBtnClick=function(){var b=g.defer();j.somethingInProgress=!0;var c={};j.somethingInProgressTxt="Creating bundle json...",c.ssffFiles=[];var d={};return p.data.forEach(function(a){"FORMANTS"===a.ssffTrackName&&(d=a)}),$.isEmptyObject()?a.getAnnotationAndSaveBndl(c,b):v.asyncJso2ssff(el).then(function(d){c.ssffFiles.push({ssffTrackName:el.ssffTrackName,encoding:"BASE64",data:t.arrayBufferToBase64(d.data)}),a.getAnnotationAndSaveBndl(c,b)},function(a){r.open("views/error.html","ModalCtrl","Error converting javascript object to ssff file: "+a.status.message),b.reject()}),b.promise},a.getAnnotationAndSaveBndl=function(a,b){a.annotation=q.getData(),j.somethingInProgressTxt="Saving bundle...",l.saveBundle(a).then(function(){j.somethingInProgressTxt="Done!",j.somethingInProgress=!1,k.movesAwayFromLastSave=0,b.resolve()},function(a){r.open("views/error.html","ModalCtrl","Error saving bundle: "+a.status.message),b.reject()})},a.uttIsDisabled=function(b){return b.name===a.curBndl.name?!1:!0},a.getBndlColor=function(b){var c;return c=0!==k.movesAwayFromLastSave?{"background-color":"#f00",color:"white"}:{"background-color":"#999",color:"black"},b.name===a.curBndl.name?c:void 0},a.cursorInTextField=function(){j.focusInTextField=!0},a.cursorOutOfTextField=function(){j.focusInTextField=!1},a.openSubmenu=function(){j.setsubmenuOpen(j.getsubmenuOpen()?!1:!0)},a.addLevelSegBtnClick=function(){j.getPermission("addLevelSegBtnClick")?alert("not implemented yet"):console.log("action currently not allowed")},a.addLevelPointBtnClick=function(){j.getPermission("addLevelPointBtnClick")?alert("not implemented yet"):console.log("action currently not allowed")},a.renameSelLevelBtnClick=function(){j.getPermission("renameSelLevelBtnClick")?void 0!==j.getcurClickLevelName()?r.open("views/renameLevel.html","ModalCtrl",j.getcurClickLevelName()):r.open("views/error.html","ModalCtrl","Rename Error : Please choose a Level first !"):console.log("action currently not allowed")},a.downloadTextGridBtnClick=function(){j.getPermission("downloadTextGridBtnClick")?r.openExport("views/export.html","ExportCtrl",s.toTextGrid(q.data),"textgrid.txt"):console.log("action currently not allowed")},a.spectSettingsBtnClick=function(){j.getPermission("spectSettingsChange")?r.open("views/spectroSettings.html","SpectsettingsCtrl"):console.log("action currently not allowed")},a.connectBtnClick=function(){j.getPermission("connectBtnClick")?r.open("views/connectModal.html","WsconnectionCtrl").then(function(b){b&&l.wsH.initConnect(b).then(function(b){"error"===b.type?r.open("views/error.html","ModalCtrl","Could not connect to websocket server: "+n.vals.main.wsServerUrl):a.handleConnectedToWSserver()})}):console.log("action currently not allowed")},a.openDemoDBbtnClick=function(b){j.getPermission("openDemoBtnDBclick")&&(a.demoDbName=b,a.showDropZone=!1,j.somethingInProgress=!0,j.setState("loadingSaving"),n.vals.main.comMode="DEMO",j.somethingInProgressTxt="Loading DB config...",l.getDBconfigFile(b).then(function(c){var d=c.data;j.curPerspectiveIdx=0,n.setVals(d.EMUwebAppConfig),delete d.EMUwebAppConfig,n.curDbConfig=d,j.somethingInProgressTxt="Loading bundle list...",l.getBundleList(b).then(function(b){var c=b.data;a.bundleList=c,a.menuBundleClick(a.bundleList[0])},function(a){r.open("views/error.html","ModalCtrl","Error loading bundle list of "+b+": "+a.data+" STATUS: "+a.status)})},function(a){r.open("views/error.html","ModalCtrl","Error loading DB config of "+b+": "+a.data+" STATUS: "+a.status)}))},a.aboutBtnClick=function(){r.open("views/about.html","AboutCtrl")},a.clearBtnClick=function(){r.open("views/confirmModal.html","ConfirmmodalCtrl","Do you wish to clear all loaded data and if connected disconnect from the server? This will also delete any unsaved changes...").then(function(b){b&&a.resetToInitState()})},a.resetToInitState=function(){l.wsH.isConnected()&&l.wsH.closeConnect(),a.bundleList=[],m.wavJSO={},q.data={},p.data=[],k.resetToInitState(),j.somethingInProgress=!1,j.resetToInitState(),a.showDropZone=!0,a.loadDefaultConfig(),j.setState("noDBorFilesloaded")},a.cmdZoomAll=function(){j.getPermission("zoom")?(j.deleteEditArea(),j.setViewPort(0,j.curViewPort.bufferLength)):console.log("action currently not allowed")},a.cmdZoomIn=function(){j.getPermission("zoom")?(j.deleteEditArea(),j.zoomViewPort(!0)):console.log("action currently not allowed")},a.cmdZoomOut=function(){j.getPermission("zoom")?(j.deleteEditArea(),j.zoomViewPort(!1)):console.log("action currently not allowed")},a.cmdZoomLeft=function(){j.getPermission("zoom")?(j.deleteEditArea(),j.shiftViewPort(!1)):console.log("action currently not allowed")},a.cmdZoomRight=function(){j.getPermission("zoom")?(j.deleteEditArea(),j.shiftViewPort(!0)):console.log("action currently not allowed")},a.cmdZoomSel=function(){j.getPermission("zoom")?(j.deleteEditArea(),j.setViewPort(j.curViewPort.selectS,j.curViewPort.selectE)):console.log("action currently not allowed")},a.cmdPlayView=function(){j.getPermission("playaudio")?(m.playFromTo(j.curViewPort.sS,j.curViewPort.eS),j.animatePlayHead(j.curViewPort.sS,j.curViewPort.eS)):console.log("action currently not allowed")},a.cmdPlaySel=function(){j.getPermission("playaudio")?(m.playFromTo(j.curViewPort.selectS,j.curViewPort.selectE),j.animatePlayHead(j.curViewPort.selectS,j.curViewPort.selectE)):console.log("action currently not allowed")},a.cmdPlayAll=function(){j.getPermission("playaudio")?(m.playFromTo(0,m.wavJSO.Data.length),j.animatePlayHead(0,m.wavJSO.Data.length)):console.log("action currently not allowed")},a.setlastkeycode=function(b){a.lastkeycode=b},a.toggleRightSideMenuHidden=function(){a.isRightSideMenuHidden=!a.isRightSideMenuHidden},a.changePerspective=function(b){for(var c,d=0;d<n.vals.perspectives.length;d++)console.log(n.vals.perspectives[d].name),b.name===n.vals.perspectives[d].name&&(c=d);j.curPerspectiveIdx=c,a.toggleRightSideMenuHidden()},a.getPerspectiveColor=function(a){var b;return b=-1===j.curPerspectiveIdx||a.name===n.vals.perspectives[j.curPerspectiveIdx].name?"curSelPerspLi":"perspLi"}}]),angular.module("emuwebApp").controller("FileCtrl",["$scope","Binarydatamaniphelper","Textgridparserservice","ConfigProviderService",function(a,b,c){function d(){for(var b=!1,c=a.fileInput,d=0;d<c.files.length;d++){var e=c.files[d],f=e.name.substr(e.name.lastIndexOf(".")+1).toUpperCase();"WAV"===f&&e.type.match("audio/wav")&&(b=!0,a.newfiles.wav=e),"TEXTGRID"===f&&(a.newfiles.textgrid=e)}}function e(b){b.preventDefault();b.target.files||b.dataTransfer.files;a.$apply(function(){a.dropText=a.dropDefault,a.dropClass=""})}function f(b){b.preventDefault();var c=b.dataTransfer&&b.dataTransfer.types&&b.dataTransfer.types.indexOf("Files")>=0;a.$apply(function(){a.dropClass=c?"over":"not-available"})}a.dropzone=document.getElementById("dropzone"),a.fileInput=document.getElementById("fileDialog"),a.dropDefault="Drop your files here or click here to open a file",a.dropErrorFileType="Error: Could not parse file. You can drop multiple files, but you have to select at least one .WAV file. The following file types are supported: .WAV .TEXTGRID",a.dropErrorAPI="Sorry ! The File APIs are not fully supported in your browser.",a.dropNotAllowed="File is not allowed",a.dropAllowed="Drop files to start loading",a.dropParsingStarted="Parsing started",a.wavLoaded=0,a.txtGridLoaded=0,a.labelLoaded=0,a.newfiles={},a.dropText=a.dropDefault,a.dropzone.addEventListener("dragenter",e,!1),a.dropzone.addEventListener("dragleave",e,!1),a.dropzone.addEventListener("dragover",f,!1),a.fileInput.addEventListener("change",d,!1),a.loadFiles=function(){setTimeout(function(){a.fileInput.click()},0)},a.$watch("newfiles",function(){$.isEmptyObject(a.newfiles.wav)||a.handleLocalFiles()},!0),a.handleLocalFiles=function(){a.$parent.showDropZone=!1,a.$parent.cps.vals.main.comMode="FileAPI",a.$parent.vs.setState("loadingSaving"),a.$parent.hists.resetToInitState(),a.$parent.vs.somethingInProgress=!0,a.$parent.vs.somethingInProgressTxt="Loading local File: "+a.newfiles.wav.name,a.$parent.ssffds.data=[],a.$parent.tds.data={},a.$parent.vs.somethingInProgressTxt="Parsing WAV file...";var b=new FileReader;b.readAsArrayBuffer(a.newfiles.wav),b.onloadend=function(b){b.target.readyState==FileReader.DONE&&a.$parent.io.httpGetPath("configFiles/standalone_config.json").then(function(d){a.$parent.vs.curPerspectiveIdx=0,a.$parent.cps.setVals(d.data.EMUwebAppConfig),delete d.data.EMUwebAppConfig,a.$parent.cps.curDbConfig=d.data,a.$parent.wps.parseWavArrBuf(b.currentTarget.result).then(function(b){if(console.log(b),a.$parent.vs.curViewPort.sS=0,a.$parent.vs.curViewPort.eS=b.Data.length,a.$parent.vs.curViewPort.bufferLength=b.Data.length,a.$parent.vs.resetSelect(),a.$parent.vs.curPerspectiveIdx=0,a.$parent.shs.wavJSO=b,void 0!==a.newfiles.textgrid){var d=new FileReader;d.readAsText(a.newfiles.textgrid),d.onloadend=function(b){if(b.target.readyState==FileReader.DONE){var d=a.newfiles.wav.name.substr(0,a.newfiles.wav.name.lastIndexOf("."));c.asyncParseTextGrid(b.currentTarget.result,a.newfiles.wav.name,d).then(function(b){var c=b.data;a.$parent.tds.setData(c);var d=[];c.levels.forEach(function(a){d.push(a.name)}),console.log(a.$parent.cps.vals.perspectives[a.$parent.vs.curPerspectiveIdx]),a.$parent.cps.vals.perspectives[a.$parent.vs.curPerspectiveIdx].levelCanvases.order=d,a.$parent.vs.somethingInProgressTxt="Done!",a.$parent.vs.somethingInProgress=!1,a.$parent.vs.setState("labeling"),a.$parent.openSubmenu()})}},function(b){a.$parent.dials.open("views/error.html","ModalCtrl","Error parsing textgrid file: "+b.status.message)}}else a.$parent.vs.setState("labeling"),a.$parent.vs.somethingInProgress=!1,a.$parent.vs.somethingInProgressTxt="Done!",a.$parent.openSubmenu()})},function(b){a.$parent.dials.open("views/error.html","ModalCtrl","Error parsing wav file: "+b.status.message)})}},a.dropzone.addEventListener("drop",function(b){if(b.stopPropagation(),b.preventDefault(),a.$apply(function(){a.dropText=a.dropParsingStarted,a.dropClass=""}),window.File&&window.FileReader&&window.FileList&&window.Blob)for(var c=b.dataTransfer.items,d=0;d<c.length;d++){var e=c[d].webkitGetAsEntry();e&&a.traverseFileTree(e)}else a.$parent.dials.open("views/error.html","ModalCtrl",a.dropErrorAPI),a.dropText=a.dropDefault},!1),a.traverseFileTree=function(b,c){c=c||"";var d=!1;if(b.isFile)b.file(function(b){var c=b.name.substr(b.name.lastIndexOf(".")+1).toUpperCase();"WAV"===c&&b.type.match("audio/wav")&&(a.newfiles.wav=b,d=!0,a.$apply()),"TEXTGRID"===c&&(a.newfiles.textgrid=b,a.$apply()),("LAB"===c||"TONE"===c)&&(a.newfiles.lab=b,a.$apply())});else if(b.isDirectory){var e=b.createReader();e.readEntries(function(d){for(var e=0;e<d.length;e++)a.traverseFileTree(d[e],c+b.name+"/")})}}}]),angular.module("emuwebApp").directive("level",function(){return{templateUrl:"views/level.html",restrict:"E",link:function(a,b,c){function d(b,c,d){var e=d.vals.font.fontPxSize;if(!$.isEmptyObject(b)&&!$.isEmptyObject(c)&&!$.isEmptyObject(d)){a.open||(e-=1);var g=f[0].getContext("2d");g.clearRect(0,0,f[0].width,f[0].height);var h,i,j,k;h=c.getSampleDist(f[0].width);var l=g.canvas.height/g.canvas.offsetHeight;k=a.fontImage.getTextImageTwoLines(g,b.name,"("+b.type+")",e,d.vals.font.fontType,d.vals.colors.labelColor,!0),g.drawImage(k,0,g.canvas.height/2-e*l);var m=(c.getcurMouseSegment(),c.getcurClickSegments(),c.getcurClickLevelName(),-1);if("SEGMENT"===b.type){g.fillStyle=d.vals.colors.startBoundaryColor;var n=b.items;n.forEach(function(h){if(++m,h.sampleStart>=c.curViewPort.sS&&h.sampleStart<=c.curViewPort.eS||h.sampleStart+h.sampleDur>c.curViewPort.sS&&h.sampleStart+h.sampleDur<c.curViewPort.eS||h.sampleStart<c.curViewPort.sS&&h.sampleStart+h.sampleDur>c.curViewPort.eS){var l;h.labels.forEach(function(a){a.name===b.name&&(l=a.value)}),i=c.getPos(f[0].width,h.sampleStart),j=c.getPos(f[0].width,h.sampleStart+h.sampleDur),g.fillStyle=d.vals.colors.startBoundaryColor,g.fillRect(i,0,2,f[0].height/2),g.fillStyle=d.vals.colors.endBoundaryColor,g.fillRect(j,f[0].height/2,2,f[0].height),k=a.fontImage.getTextImage(g,l,e-2,d.vals.font.fontType,d.vals.colors.labelColor);var n=a.fontImage.getLastImageWidth(),o=i+(j-i)/2-n/2;j-i>n&&(a.open?g.drawImage(k,0,0,k.width,k.height,o,f[0].height/2-(e-2),k.width,k.height):g.drawImage(k,0,0,k.width,k.height,o,0,k.width,k.height));var p=a.fontImage.getTextImage(g,h.sampleStart,e-4,d.vals.font.fontType,d.vals.colors.endBoundaryColor),q=a.fontImage.getLastImageWidth(),r=i+(j-i)/2-q/2,s=a.fontImage.getTextImage(g,"dur: "+h.sampleDur,e-4,d.vals.font.fontType,d.vals.colors.endBoundaryColor),t=a.fontImage.getLastImageWidth();a.open&&(g.strokeStyle=d.vals.colors.startBoundaryColor,g.beginPath(),g.moveTo(i,f[0].height/4),g.lineTo(r+q/2,f[0].height/4),g.lineTo(r+q/2,f[0].height/4+10),g.stroke(),g.strokeStyle=d.vals.colors.endBoundaryColor,g.beginPath(),g.moveTo(j,f[0].height/4*3),g.lineTo(r+q/2,f[0].height/4*3),g.lineTo(r+q/2,f[0].height/4*3-10),g.stroke()),n>=j-i&&(g.strokeStyle=d.vals.colors.startBoundaryColor,g.beginPath(),g.moveTo(r+q/2,f[0].height/4+10),g.lineTo(r+q/2,f[0].height/4+30),g.stroke()),j-i>q&&g.drawImage(p,0,0,k.width,k.height,i+3,0,k.width,k.height),j-i>t&&g.drawImage(s,0,0,k.width,k.height,j-t,f[0].height/4*3,k.width,k.height)}})}else if("EVENT"===b.type){g.fillStyle=d.vals.colors.startBoundaryColor;var o;b.items.forEach(function(i){if(i.samplePoint>c.curViewPort.sS&&i.samplePoint<c.curViewPort.eS){o=Math.round(c.getPos(f[0].width,i.samplePoint)+h/2);var j;i.labels.forEach(function(a){a.name===b.name&&(j=a.value)}),g.fillStyle=d.vals.colors.startBoundaryColor,g.fillRect(o,0,1,f[0].height/2-f[0].height/10),g.fillRect(o,f[0].height/2+f[0].height/10,1,f[0].height/2-f[0].height/10),k=a.fontImage.getTextImage(g,j,e-2,d.vals.font.fontType,d.vals.colors.labelColor),g.drawImage(k,0,0,k.width,k.height,o-5,f[0].height/3,k.width,k.height),k=a.fontImage.getTextImage(g,i.samplePoint,e-4,d.vals.font.fontType,d.vals.colors.endBoundaryColor),g.drawImage(k,0,0,k.width,k.height,o+5,0,k.width,k.height)}})}}}function e(b,c,d){var e=f[1].getContext("2d");e.clearRect(0,0,f[1].width,f[1].height),b.name===c.getcurClickLevelName()&&(e.fillStyle=d.vals.colors.selectedLevelColor,e.fillRect(0,0,f[0].width,f[0].height)),a.dhs.drawMovingBoundaryLine(e),a.dhs.drawCurViewPortSelected(e);var g,h,i,j,k;g=c.getPos(f[1].width,c.curViewPort.selectS),h=c.getPos(f[1].width,c.curViewPort.selectE),i=c.getSampleDist(f[1].width);var l=c.getcurMouseSegment(),m=c.getcurClickSegments(),n=c.getcurClickLevelName();void 0!==m&&b.name===n&&m.length>0&&m.forEach(function(a){void 0!==a&&(g=Math.round(c.getPos(f[0].width,a.sampleStart)),h=Math.round(c.getPos(f[0].width,a.sampleStart+a.sampleDur)),e.fillStyle=d.vals.colors.selectedSegmentColor,e.fillRect(g,0,h-g,f[0].height),e.fillStyle=d.vals.colors.startBoundaryColor)}),k=c.getcurMouseSegment(),void 0!==k&&void 0!==l&&b.name===c.getcurMouseLevelName()&&(e.fillStyle=d.vals.colors.selectedBoundaryColor,l===!1?"SEGMENT"===c.getcurMouseLevelType()&&(k=b.items[0],g=Math.round(c.getPos(f[1].width,k.sampleStart)),e.fillRect(g,0,3,f[1].height)):l===!0?"SEGMENT"===c.getcurMouseLevelType()&&(k=b.items[b.items.length-1],g=Math.round(c.getPos(f[1].width,k.sampleStart+k.sampleDur)),e.fillRect(g,0,3,f[1].height)):"SEGMENT"===c.getcurMouseLevelType()?(g=Math.round(c.getPos(f[1].width,k.sampleStart)),e.fillRect(g,0,3,f[1].height)):(g=Math.round(c.getPos(f[1].width,k.samplePoint)),j=i/2,e.fillRect(g+j,0,3,f[1].height)),e.fillStyle=d.vals.colors.startBoundaryColor)}var f=b.find("canvas");a.open=c.open,a.$watch("vs.curViewPort",function(){d(a.level,a.vs,a.cps),e(a.level,a.vs,a.cps)},!0),a.$watch("vs.curMouseSegment",function(){d(a.level,a.vs,a.cps),e(a.level,a.vs,a.cps)},!0),a.$watch("hists.movesAwayFromLastSave",function(){d(a.level,a.vs,a.cps),e(a.level,a.vs,a.cps)},!0),b.bind("mouseleave",function(){a.vs.setcurMouseSegment(void 0),e(a.level,a.vs,a.cps)}),a.updateView=function(){d(a.level,a.vs,a.cps)}}}}),angular.module("emuwebApp").directive("osci",["viewState","Soundhandlerservice","ConfigProviderService","Drawhelperservice",function(a,b,c,d){return{templateUrl:"views/osci.html",replace:!0,restrict:"E",link:function(e,f,g){function h(b,d){var e=l.getContext("2d");e.clearRect(0,0,k.width,k.height);var f=a.getPos(l.width,a.playHeadAnimationInfos.sS),g=a.getPos(l.width,a.playHeadAnimationInfos.curS);e.fillStyle=c.vals.colors.selectedAreaColor,e.fillRect(f,0,g-f,k.height),i(b,d,!1)}function i(b,c,e){var f=l.getContext("2d");e&&f.clearRect(0,0,l.width,l.height);var g;g=a.getSampleDist(l.width),d.drawMovingBoundaryLine(f),d.drawCurViewPortSelected(f,!0),d.drawViewPortTimes(f,!0)}var j=f.find("canvas").length,k=f.find("canvas")[0],l=f.find("canvas")[j-1];e.order=g.order,e.enlargeCanvas={height:100/c.vals.perspectives[a.curPerspectiveIdx].signalCanvases.order.length+"%"},e.cpi=a.curPerspectiveIdx,e.phai=a.playHeadAnimationInfos,e.cvp=a.curViewPort,e.mb=a.movingBoundary,e.$watch("cpi",function(){e.updateCSS()},!0),e.$watch("phai",function(){$.isEmptyObject(b)||$.isEmptyObject(b.wavJSO)||h(e,c)},!0),e.$watch("mb",function(){$.isEmptyObject(b)||$.isEmptyObject(b.wavJSO)||i(e,c,!0)},!0),e.$watch("cvp",function(f,g){if(!$.isEmptyObject(b)&&!$.isEmptyObject(b.wavJSO)){if(g.sS!==f.sS||g.sE!==f.sE||-1===f.selectS){var h=d.calculatePeaks(a,k,b.wavJSO.Data);d.osciPeaks=h,d.freshRedrawDrawOsciOnCanvas(a,k,d.osciPeaks,b.wavJSO.Data,c)}i(e,c,!0),e.updateCSS()}},!0),e.redraw=function(){i(e,c,!0),e.updateCSS()},e.updateCSS=function(){var b=c.vals.perspectives[a.curPerspectiveIdx].signalCanvases.order.length;e.enlargeCanvas=-1==a.getenlarge()?{height:100/b+"%"}:a.getenlarge()==e.order?{height:300/(b+2)+"%"}:{height:100/(b+2)+"%"}}}}}]),angular.module("emuwebApp").directive("preview",function(){return{templateUrl:"views/preview.html",restrict:"E",link:function(a,b){function c(){f?d(a.vs,e,a.cps,g):(a.dhs.freshRedrawDrawOsciOnCanvas(a.vs,e,a.dhs.osciPeaks,a.shs.wavJSO.Data,a.cps),g.src=e.toDataURL("image/png"),f=!0,d(a.vs,e,a.cps,g))}function d(b,c,d,e){var f=c.getContext("2d"),g=new Image,h=c.width/a.shs.wavJSO.Data.length*b.curViewPort.sS,i=c.width/a.shs.wavJSO.Data.length*b.curViewPort.eS;g.onload=function(){f.clearRect(0,0,c.width,c.height),f.drawImage(g,0,0),f.fillStyle=d.vals.colors.selectedAreaColor,f.fillRect(h,0,i-h,c.height),f.strokeStyle=d.vals.colors.selectedBorderColor,f.beginPath(),f.moveTo(h,0),f.lineTo(h,c.height),f.moveTo(i,0),f.lineTo(i,c.height),f.closePath(),f.stroke()},g.src=e.src}var e=b.find("canvas")[0],f=!1,g=new Image;a.$watch("vs.curViewPort",function(){$.isEmptyObject(a.shs.wavJSO)||c()},!0),a.$watch("shs.wavJSO",function(){if($.isEmptyObject(a.shs.wavJSO)){var b=e.getContext("2d");b.clearRect(0,0,e.width,e.height)}},!0)}}}),angular.module("emuwebApp").directive("bundleListSideBar",["$animate","viewState",function(a){return{templateUrl:"views/bundleListSideBar.html",restrict:"E",replace:!0,link:function(b,c){b.$watch("vs.submenuOpen",function(){b.vs.submenuOpen?(a.removeClass(c,"shrinkWidthTo0px"),a.addClass(c,"expandWidthTo240px")):a.addClass(c,"shrinkWidthTo0px")},!0)}}}]),angular.module("emuwebApp").animation(".slideInSubmenu",function(){return{addClass:function(a){a.addClass("cbp-spmenu-open")},removeClass:function(a){a.removeClass("cbp-spmenu-open")}}}),angular.module("emuwebApp").animation(".slideInBody",function(){return{addClass:function(a){a.addClass("cbp-spmenu-left-toright")},removeClass:function(a){a.removeClass("cbp-spmenu-left-toright")}}}),angular.module("emuwebApp").directive("spectro",function(){return{templateUrl:"views/spectro.html",restrict:"E",replace:!0,link:function(a,b,c){function d(){x=null,y=0,x=[]}function e(a,b,c,d){x[y]=[],x[y][0]=a,x[y][1]=b,x[y][2]=c,x[y][3]=d,++y}function f(a,b,c){for(var d=0;d<x.length;++d)if(x[d][0]===a&&x[d][1]===b&&x[d][2]===c)return d;return null}function g(){a.dhs.drawMovingBoundaryLine(r),a.dhs.drawCurViewPortSelected(r,!1),a.dhs.drawMinMaxAndName(r,"",a.vs.spectroSettings.rangeFrom,a.vs.spectroSettings.rangeTo,2)}function h(a){var b=q.createImageData(n.width,n.height);b.data.set(x[a][3]),q.putImageData(b,0,0)}function i(){q.fillStyle="#222",q.fillRect(0,0,n.width,n.height),q.font=a.cps.vals.font.fontPxSize+"px "+a.cps.vals.font.fontType,q.fillStyle="#333",q.fillText("loading...",10,25),null!==w&&(w.terminate(),w=null)}function j(){s=Math.round((a.vs.curViewPort.eS-a.vs.curViewPort.sS)/n.width);var b=q.createImageData(n.width,n.height);w.addEventListener("message",function(c){s===c.data.myStep&&(b.data.set(c.data.img),q.putImageData(b,0,0),e(a.vs.curViewPort.sS,a.vs.curViewPort.eS,s,c.data.img),g())})}function k(a){i(),l(a)}function l(b){s=Math.round((a.vs.curViewPort.eS-a.vs.curViewPort.sS)/n.width),w=new Worker(v);var c=b.subarray(a.vs.curViewPort.sS,a.vs.curViewPort.eS+3*s*a.vs.spectroSettings.windowLength),d=new Float32Array(c);j(),w.postMessage({cmd:"config",N:a.vs.spectroSettings.windowLength}),w.postMessage({cmd:"config",alpha:p}),w.postMessage({cmd:"config",freq:a.vs.spectroSettings.rangeTo}),w.postMessage({cmd:"config",freqLow:a.vs.spectroSettings.rangeFrom}),w.postMessage({cmd:"config",start:Math.round(a.vs.curViewPort.sS)}),w.postMessage({cmd:"config",end:Math.round(a.vs.curViewPort.eS)}),w.postMessage({cmd:"config",myStep:s}),w.postMessage({cmd:"config",window:a.vs.spectroSettings.window}),w.postMessage({cmd:"config",width:n.width}),w.postMessage({cmd:"config",height:n.height}),w.postMessage({cmd:"config",dynRangeInDB:a.vs.spectroSettings.dynamicRange}),w.postMessage({cmd:"config",pixelRatio:u}),w.postMessage({cmd:"config",sampleRate:a.shs.wavJSO.SampleRate}),w.postMessage({cmd:"config",streamChannels:a.shs.wavJSO.NumChannels}),w.postMessage({cmd:"pcm",stream:d}),w.postMessage({cmd:"render"})}a.order=c.order,a.enlargeCanvas={height:100/a.cps.vals.perspectives[a.vs.curPerspectiveIdx].signalCanvases.order.length+"%"};var m=b.find("canvas").length,n=b.find("canvas")[0],o=b.find("canvas")[m-1],p=.16,q=n.getContext("2d"),r=o.getContext("2d"),s=0;window.URL=window.URL||window.webkitURL;var t,u=window.devicePixelRatio||1,v="scripts/workers/spectroWorker.js",w=new Worker(v),x=null,y=0;a.updateCSS=function(){var b=a.cps.vals.perspectives[a.vs.curPerspectiveIdx].signalCanvases.order.length;a.enlargeCanvas=-1==a.vs.getenlarge()?{height:100/b+"%"}:a.vs.getenlarge()==a.order?{height:300/(b+2)+"%"}:{height:100/(b+2)+"%"}},b.bind("mousemove",function(){$.isEmptyObject(a.shs)||!$.isEmptyObject(a.shs.wavJSO)}),b.bind("mouseleave",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||(r.clearRect(0,0,o.width,o.height),g())}),a.$watch("vs.curPerspectiveIdx",function(){a.updateCSS()},!0),a.$watch("vs.curViewPort",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||(a.redraw(),a.updateCSS())},!0),a.$watch("vs.movingBoundary",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||a.redraw()},!0),a.$on("newlyLoadedAudioFile",function(){console.log("clearing spectro image cache..."),d()}),a.$watch("vs.spectroSettings",function(){$.isEmptyObject(a.shs)||$.isEmptyObject(a.shs.wavJSO)||(j(),d(),a.redraw())},!0),a.redraw=function(){s=Math.round((a.vs.curViewPort.eS-a.vs.curViewPort.sS)/n.width),t=f(a.vs.curViewPort.sS,a.vs.curViewPort.eS,s),null!==t?(r.clearRect(0,0,o.width,o.height),h(t),g()):k(a.shs.wavJSO.Data)},d()}}}),angular.module("emuwebApp").controller("HandleLevelsCtrl",["$scope","$http","$injector","Drawhelperservice",function(a,b,c,d){a.dhs=d,a.$on("loadingNewUtt",function(){a.tds.data={}
}),a.$on("errorMessage",function(a,b){dialogService.open("views/error.html","ModalCtrl",b)}),a.cursorInTextField=function(){a.vs.focusInTextField=!0},a.cursorOutOfTextField=function(){a.vs.focusInTextField=!1}}]),angular.module("emuwebApp").controller("TimelineCtrl",["$scope","Drawhelperservice",function(a,b){a.dhs=b}]),angular.module("emuwebApp").controller("ExportCtrl",["$scope","dialogService","exportData","exportName","viewState","Levelservice","HistoryService",function(a,b,c,d,e){a.exportData=c,a.exportName=d,a.cancel=function(){b.close()},a.getBlob=function(){return new Blob([a.exportData],{type:"text/plain"})},a.cursorInTextField=function(){e.focusInTextField=!0},a.cursorOutOfTextField=function(){e.focusInTextField=!1}}]),angular.module("emuwebApp").factory("viewState",["$rootScope","Soundhandlerservice","$window","Levelservice",function(a,b,c,d){var e={},f={BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10};return e.curViewPort={sS:0,eS:0,selectS:-1,selectE:-1,bufferLength:-1,enlargeTimeline:-1,dragBarActive:!1,dragBarHeight:-1,windowWidth:void 0},e.spectroSettings={windowLength:-1,rangeFrom:-1,rangeTo:-1,dynamicRange:-1,window:-1},e.playHeadAnimationInfos={sS:-1,eS:-1,curS:null},e.somethingInProgress=!1,e.somethingInProgressTxt="",e.curClickSegments=[],e.lasteditArea=null,e.editing=!1,e.submenuOpen=!1,e.rightSubmenuOpen=!1,e.modalOpen=!1,e.levelLength=0,e.curMousePosSample=0,e.curMouseLevelName=void 0,e.curMouseLevelType=void 0,e.curClickLevelName=void 0,e.curClickLevelType=void 0,e.curPreselColumnSample=2,e.curCorrectionToolNr=1,e.curClickLevelIndex=void 0,e.start=null,e.loadingUtt=!1,e.curMouseSegmentId=void 0,e.TransitionTime=void 0,e.showDropZone=void 0,e.movingBoundary=!1,e.gotUnsavedDataChanges=!1,e.focusInTextField=!1,e.curTaskPercCompl=0,e.curPerspectiveIdx=-1,e.mouseInEmuWebApp=!1,e.states=[],e.states.noDBorFilesloaded={permittedActions:["connectBtnClick","openDemoBtnDBclick"]},e.states.loadingSaving={permittedActions:[]},e.states.labeling={permittedActions:["zoom","playaudio","spectSettingsChange","addLevelSegBtnClick","addLevelPointBtnClick","renameSelLevelBtnClick","downloadTextGridBtnClick","spectSettingsChange","clearBtnClick"]},e.states.modalShowing={permittedActions:[]},e.prevState=e.states.noDBorFilesloaded,e.curState=e.states.noDBorFilesloaded,e.getPermission=function(a){return e.curState.permittedActions.indexOf(a)>-1},e.setWindowWidth=function(a){this.curViewPort.windowWidth=a},e.setState=function(a){e.prevState=e.curState,e.curState="string"==typeof a?e.states[a]:a},e.updatePlayHead=function(d){b.player.isPlaying&&c.requestAnimationFrame(e.updatePlayHead),null===e.start&&(e.start=d);var f=Math.ceil(d-e.start)/1e3*b.wavJSO.SampleRate;e.playHeadAnimationInfos.curS=Math.round(e.playHeadAnimationInfos.sS+f),b.player.isPlaying&&e.playHeadAnimationInfos.curS<=e.playHeadAnimationInfos.eS?a.$apply():(e.playHeadAnimationInfos.sS=-1,e.playHeadAnimationInfos.eS=-1,e.playHeadAnimationInfos.curS=0,e.start=null)},e.animatePlayHead=function(a,b){e.playHeadAnimationInfos.sS=a,e.playHeadAnimationInfos.eS=b,e.playHeadAnimationInfos.curS=a,c.requestAnimationFrame(e.updatePlayHead)},e.select=function(a,b){e.curViewPort.selectS=a,e.curViewPort.selectE=b},e.resetSelect=function(){e.curViewPort.selectS=-1,e.curViewPort.selectE=-1},e.getViewPort=function(){return e.curViewPort},e.setspectroSettings=function(a,b,c,d,f){e.spectroSettings.windowLength=parseInt(a,10),e.spectroSettings.rangeFrom=parseInt(b,10),e.spectroSettings.rangeTo=parseInt(c,10),e.spectroSettings.dynamicRange=parseInt(d,10),e.setWindowFunction(f)},e.getSelect=function(){return[e.curViewPort.selectS,e.curViewPort.selectE]},e.selectDependent=function(a,b){a<this.curViewPort.selectS&&(this.curViewPort.selectS=a),b>this.selectE&&(this.curViewPort.selectE=b)},e.selectLevel=function(a){var b,c=e.getcurClickLevelName(),f=$("li").children()[0].id;if(void 0===c)e.setcurClickLevelName(f);else{a?(b=$("li."+c).next().children()[0],void 0===b?e.setcurClickLevelName(f):(f=b.id,e.setcurClickLevelName(f))):(b=$("li."+c).prev().children()[0],void 0===b?e.setcurClickLevelName(f):(f=b.id,e.setcurClickLevelName(f)));var g=e.getcurClickSegments();if(void 0!==g&&g.length>0){var h=g[0].sampleStart+g[0].sampleDur/2,i=d.getLevelDetails(f),j=d.getEvent(h,i.level,!1);console.log(j),e.setlasteditArea("_"+j.id),e.setcurClickLevelType(i.level.type),e.setcurClickSegment(j),e.setLevelLength(i.level.items.length)}}},e.setWindowFunction=function(a){switch(a){case"BARTLETT":e.spectroSettings.window=f.BARTLETT;break;case"BARTLETTHANN":e.spectroSettings.window=f.BARTLETTHANN;break;case"BLACKMAN":e.spectroSettings.window=f.BLACKMAN;break;case"COSINE":e.spectroSettings.window=f.COSINE;break;case"GAUSS":e.spectroSettings.window=f.GAUSS;break;case"HAMMING":e.spectroSettings.window=f.HAMMING;break;case"HANN":e.spectroSettings.window=f.HANN;break;case"LANCZOS":e.spectroSettings.window=f.LANCZOS;break;case"RECTANGULAR":e.spectroSettings.window=f.RECTANGULAR;break;case"TRIANGULAR":e.spectroSettings.window=f.TRIANGULAR;break;default:e.spectroSettings.window=f.BARTLETTHANN}},e.getWindowFunctions=function(){return f},e.getdragBarActive=function(){return this.curViewPort.dragBarActive},e.setdragBarActive=function(a){this.curViewPort.dragBarActive=a},e.getdragBarHeight=function(){return this.curViewPort.dragBarHeight},e.setdragBarHeight=function(a){this.curViewPort.dragBarHeight=a},e.getPos=function(a,b){return a*(b-this.curViewPort.sS)/(this.curViewPort.eS-this.curViewPort.sS+1)},e.getSampleDist=function(a){return this.getPos(a,this.curViewPort.sS+1)-this.getPos(a,this.curViewPort.sS)},e.getsubmenuOpen=function(){return this.submenuOpen},e.setsubmenuOpen=function(a){this.submenuOpen=a},e.setenlarge=function(a){this.curViewPort.enlargeTimeline=a},e.getenlarge=function(){return this.curViewPort.enlargeTimeline},e.getTransitionTime=function(){return this.TransitionTime},e.setTransitionTime=function(a){this.TransitionTime=a},e.getRightsubmenuOpen=function(){return this.rightSubmenuOpen},e.setRightsubmenuOpen=function(a){this.rightSubmenuOpen=a},e.getmodalOpen=function(){return this.modalOpen},e.setmodalOpen=function(a){this.modalOpen=a},e.setcurClickLevel=function(a,b,c,d){this.setLevelLength(d),this.setcurClickLevelName(a,c),this.setcurClickLevelType(b),this.setLevelLength(d)},e.setcurClickLevelType=function(a){this.curClickLevelType=a},e.getcurClickLevelType=function(){return this.curClickLevelType},e.setcurClickLevelName=function(a,b){this.curClickLevelName=a,this.curClickLevelIndex=b},e.getcurClickLevelName=function(){return this.curClickLevelName},e.getcurClickNeighbours=function(){return this.curClickNeighbours},e.setcurMouseLevelName=function(a){this.curMouseLevelName=a},e.getcurMouseLevelName=function(){return this.curMouseLevelName},e.setcurMouseLevelType=function(a){this.curMouseLevelType=a},e.getcurMouseLevelType=function(){return this.curMouseLevelType},e.setcurMouseSegment=function(a,b){this.curMouseSegment=a,this.curMouseNeighbours=b},e.getcurMouseSegment=function(){return this.curMouseSegment},e.getcurMouseNeighbours=function(){return this.curMouseNeighbours},e.selectSegmentsInSelection=function(){var a=e.curViewPort.selectS,b=e.curViewPort.selectE;angular.forEach(d.data.levels,function(c){c.name===e.getcurClickLevelName()&&angular.forEach(c.items,function(c){c.sampleStart>=a&&c.sampleStart+c.sampleDur<=b&&e.setcurClickSegmentMultiple(c)})})},e.setcurClickSegment=function(a){e.curClickSegments=[],e.curClickSegments.push(a),e.selectBoundry()},e.selectBoundry=function(){if(e.curClickSegments.length>0){var a=this.curClickSegments[0].sampleStart||this.curClickSegments[0].samplePoint,b=this.curClickSegments[this.curClickSegments.length-1].sampleStart+this.curClickSegments[this.curClickSegments.length-1].sampleDur||this.curClickSegments[0].samplePoint;e.curClickSegments.forEach(function(c){c.sampleStart<=a&&(a=c.sampleStart),c.sampleStart+c.sampleDur>=b&&(b=c.sampleStart+c.sampleDur)}),e.select(a,b)}},e.setcurClickSegmentMultiple=function(a){var b=!0,c=a.sampleStart,d=c+a.sampleDur;e.curClickSegments.forEach(function(f){var g=f.sampleStart==d?!0:!1,h=f.sampleStart+f.sampleDur==c?!0:!1;(g||h)&&-1===e.curClickSegments.indexOf(a)&&(e.curClickSegments.push(a),b=!1)}),b?(e.curClickSegments=[],e.curClickSegments.push(a)):e.curClickSegments.sort(e.sortbyid)},e.sortbyid=function(a,b){return a.id>b.id?1:a.id<b.id?-1:0},e.getselectedRange=function(){return this.curClickSegments.length>1?{start:this.curClickSegments[0].sampleStart,end:this.curClickSegments[this.curClickSegments.length-1].sampleStart+this.curClickSegments[this.curClickSegments.length-1].sampleDur}:1==this.curClickSegments.length?{start:this.curClickSegments[0].sampleStart,end:this.curClickSegments[0].sampleStart+this.curClickSegments[0].sampleDur}:{start:-1,end:-1}},e.getcurClickSegments=function(){return this.curClickSegments},e.getselected=function(){return this.curClickSegments},e.getlasteditAreaElem=function(){return this.lasteditAreaElem},e.isEditing=function(){return this.editing},e.setEditing=function(a){this.editing=a},e.setlasteditArea=function(a,b){this.lasteditArea=a,this.lasteditAreaElem=b},e.getlastID=function(){return this.lasteditArea.substr(1)},e.getlasteditArea=function(){return this.lasteditArea},e.deleteEditArea=function(){null!==this.getlasteditArea()&&$("."+this.getlasteditArea()).remove(),this.editing=!1},e.countSelected=function(){return this.curClickSegments.length},e.setLevelLength=function(a){this.levelLength=a},e.getLevelLength=function(){return this.levelLength},e.getCurrentSample=function(a){return this.curViewPort.sS+(this.curViewPort.eS-this.curViewPort.sS)*a},e.getCurrentPercent=function(a){return a*(100/(this.curViewPort.eS-this.curViewPort.sS)/100)},e.getPCMpp=function(a){var b=parseFloat(this.curViewPort.sS),c=parseFloat(this.curViewPort.eS);return(c-b)/a.originalEvent.srcElement.width},e.round=function(a,b){(1>b||b>14)&&console.error("error in call of round function!!");var c=Math.pow(10,b),d=(Math.round(a*c)/c).toString();return-1===d.indexOf(".")&&(d+="."),d+=c.toString().substring(1),d.substring(0,d.indexOf(".")+b+1)},e.openEditArea=function(a,b,c){console.log(a),console.log(b);var d=b.find("canvas").context.getContext("2d"),f=d.canvas.clientWidth,g=d.canvas.offsetLeft;if("SEGMENT"===c)var h=e.getPos(f,a.sampleStart)+g,i=e.getPos(f,a.sampleStart+a.sampleDur)+g;else var h=e.getPos(f,a.samplePoint)+g-f/50,i=e.getPos(f,a.samplePoint)+g+f/50;var j=d.canvas.offsetTop,k=d.canvas.clientHeight;e.createEditArea(b,h,j,i-h,k,a.labels[0].value,a.id),e.createSelection(b.find("textarea")[0],0,a.labels[0].value.length)},e.createSelection=function(a,b,c){if(a.createTextRange){var d=a.createTextRange();d.collapse(!0),d.moveStart("character",b),d.moveEnd("character",c),d.select()}else a.setSelectionRange?a.setSelectionRange(b,c):a.selectionStart&&(a.selectionStart=b,a.selectionEnd=c);a.focus()},e.createEditArea=function(a,b,c,d,e,f,g){var h="_"+g;a.prepend($("<textarea>").attr({id:h,"class":h+" Label_Edit","ng-model":"message",autofocus:"true"}).css({position:"absolute","z-index":"9999",left:b+2+"px",top:c+1+"px",width:Math.round(d)+"px",height:Math.round(e)+"px","padding-top":Math.round(e/3+1)+"px"}).text(f))},e.getViewPortStartTime=function(){return 1*this.curViewPort.sS/b.wavJSO.SampleRate-.5/b.wavJSO.SampleRate},e.getViewPortEndTime=function(){return 1*this.curViewPort.eS/b.wavJSO.SampleRate+.5/b.wavJSO.SampleRate},e.getSelectedStartTime=function(){return 1*this.curViewPort.selectS/b.wavJSO.SampleRate-.5/b.wavJSO.SampleRate},e.getSelectedEndTime=function(){return 1*this.curViewPort.selectE/b.wavJSO.SampleRate+.5/b.wavJSO.SampleRate},e.setViewPort=function(a,c){var d=this.curViewPort.sS,e=this.curViewPort.eS;void 0!==a&&(this.curViewPort.sS=Math.round(a)),void 0!==c&&(this.curViewPort.eS=Math.round(c)),d>this.curViewPort.sS&&e>this.curViewPort.eS&&this.curViewPort.sS<0&&(this.curViewPort.sS=0,this.curViewPort.eS=e+Math.abs(this.curViewPort.sS)),d<this.curViewPort.sS&&e<this.curViewPort.eS&&this.curViewPort.eS>b.wavJSO.Data.length&&(this.curViewPort.sS=d,this.curViewPort.eS=b.wavJSO.Data.length),this.curViewPort.sS<0&&(this.curViewPort.sS=0),this.curViewPort.eS>b.wavJSO.Data.length&&(this.curViewPort.eS=b.wavJSO.Data.length),this.curViewPort.eS-this.curViewPort.sS<4&&(this.curViewPort.sS=d,this.curViewPort.eS=e)},e.zoomViewPort=function(a){var b,c,d=this.getcurMouseSegment(),e=this.curViewPort.eS-this.curViewPort.sS;if(void 0!==d){var f=d.sampleStart,g=f-this.curViewPort.sS,h=this.curViewPort.eS-f;a?(b=this.curViewPort.sS+.5*g,c=this.curViewPort.eS-.5*h):(b=this.curViewPort.sS-.5*g,c=this.curViewPort.eS+.5*h)}else a?(b=this.curViewPort.sS+~~(e/4),c=this.curViewPort.eS-~~(e/4)):(b=this.curViewPort.sS-~~(e/4),c=this.curViewPort.eS+~~(e/4));this.setViewPort(b,c)},e.shiftViewPort=function(a){var b,c;a?(b=this.curViewPort.sS+~~((this.curViewPort.eS-this.curViewPort.sS)/4),c=this.curViewPort.eS+~~((this.curViewPort.eS-this.curViewPort.sS)/4)):(b=this.curViewPort.sS-~~((this.curViewPort.eS-this.curViewPort.sS)/4),c=this.curViewPort.eS-~~((this.curViewPort.eS-this.curViewPort.sS)/4)),this.setViewPort(b,c)},e.resetToInitState=function(){f={BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10},e.curViewPort={sS:0,eS:0,selectS:-1,selectE:-1,bufferLength:-1,enlargeTimeline:-1,dragBarActive:!1,dragBarHeight:-1,windowWidth:void 0},e.spectroSettings={windowLength:-1,rangeFrom:-1,rangeTo:-1,dynamicRange:-1,window:-1},e.playHeadAnimationInfos={sS:-1,eS:-1,curS:null},e.somethingInProgress=!1,e.somethingInProgressTxt="",e.curClickSegments=[],e.lasteditArea=null,e.editing=!1,e.submenuOpen=!1,e.rightSubmenuOpen=!1,e.modalOpen=!1,e.levelLength=0,e.curMousePosSample=0,e.curMouseLevelName=void 0,e.curMouseLevelType=void 0,e.curClickLevelName=void 0,e.curClickLevelType=void 0,e.curPreselColumnSample=2,e.curCorrectionToolNr=1,e.curClickLevelIndex=void 0,e.start=null,e.loadingUtt=!1,e.curMouseSegmentId=void 0,e.TransitionTime=void 0,e.showDropZone=void 0,e.movingBoundary=!1,e.gotUnsavedDataChanges=!1,e.focusInTextField=!1,e.curTaskPercCompl=0,e.curPerspectiveIdx=-1,e.mouseInEmuWebApp=!1,e.prevState=e.states.noDBorFilesloaded,e.curState=e.states.noDBorFilesloaded},e}]),angular.module("emuwebApp").directive("trackmouseinlevel",function(){return{restrict:"A",link:function(a,b){function c(c){l=g(c)*a.vs.getPCMpp(c),a.vs.deleteEditArea(),a.vs.setEditing(!1),a.vs.focusInTextField=!1,h=a.tds.getEvent(l+a.vs.curViewPort.sS,a.this.level,a.vs.curViewPort.bufferLength),a.vs.setlasteditArea("_"+h.evtr.id,b.parent()),a.vs.setcurClickLevel(m,n,a.$index,a.this.level.items.length),a.vs.setcurClickSegment(h.evtr),k=l,a.$apply()}function d(b){a.vs.getcurClickLevelName()!==m&&c(b),l=g(b)*a.vs.getPCMpp(b),a.vs.deleteEditArea(),h=a.tds.getEvent(l+a.vs.curViewPort.sS,a.this.level,a.vs.curViewPort.bufferLength),a.vs.setcurClickLevel(m,n,a.$index,a.this.level.items.length),a.vs.setcurClickSegmentMultiple(h.evtr),k=l,a.$apply()}function e(c){l=g(c)*a.vs.getPCMpp(c),h=a.tds.getEvent(l+a.vs.curViewPort.sS,a.this.level,a.vs.curViewPort.bufferLength),a.vs.setcurClickLevel(m,n,a.$index,a.this.level.items.length),a.vs.setcurClickSegment(h.evtr),a.vs.setlasteditArea("_"+h.evtr.id,b.parent()),a.vs.setEditing(!0),a.vs.openEditArea(h.evtr,b.parent(),n),a.cursorInTextField(),k=l,a.$apply()}function f(b,c){l=g(b)*a.vs.getPCMpp(b),i=a.tds.getEvent(l+a.vs.curViewPort.sS,a.this.level,a.vs.curViewPort.bufferLength),c&&(j=a.tds.getElementNeighbourDetails(a.this.level.name,i.nearest.id,i.nearest.id),a.vs.setcurMouseSegment(i.nearest,j)),a.vs.setcurMouseLevelName(m),a.vs.setcurMouseLevelType(n),a.vs.selectBoundry(),k=l,a.$apply()}function g(a){return a.offsetX*(a.originalEvent.srcElement.width/a.originalEvent.srcElement.clientWidth)}var h,i,j,k,l,m=a.level.name,n=a.level.type;b.bind("click",function(a){f(a,!0),c(a)}),b.bind("contextmenu",function(a){a.preventDefault(),f(a,!0),d(a)}),b.bind("dblclick",function(b){f(b,!0),a.cps.vals.restrictions.editItemName?e(b):c(b)}),b.bind("mousemove",function(b){if(!a.vs.getdragBarActive()){var c=!0,d=a.vs.getPCMpp(b);l=g(b)*d;var e=l-k;e=1>=d?Math.floor(l+a.vs.curViewPort.sS-a.tds.getElementDetails(a.this.level.name,a.vs.getcurMouseSegment().id).sampleStart):Math.round(l-k)}switch(b.which){case 1:break;case 2:break;case 3:break;default:if(!a.vs.getdragBarActive())if(a.cps.vals.restrictions.editItemSize&&b.shiftKey)a.vs.deleteEditArea(),void 0!==a.vs.getcurMouseSegment()&&(a.vs.movingBoundary=!0,"SEGMENT"==a.this.level.type?(a.tds.moveBoundry(e,a.this.level.name,a.vs.getcurMouseSegment(),a.vs.getcurMouseNeighbours()),a.hists.updateCurChangeObj({type:"ESPS",action:"moveBoundary",name:a.this.level.name,neighbours:a.vs.getcurMouseNeighbours(),itemIdx:a.vs.getcurMouseSegment(),movedBy:e})):(a.tds.movePoint(e,a.this.level.name,a.vs.getcurMouseSegment()),a.hists.updateCurChangeObj({type:"ESPS",action:"movePoint",name:a.this.level.name,itemIdx:a.vs.getcurMouseSegment(),movedBy:e})),k=l,c=!1);else if(a.cps.vals.restrictions.editItemSize&&b.altKey){if(a.vs.deleteEditArea(),"SEGMENT"==a.this.level.type){var h=a.tds.getElementNeighbourDetails(a.this.level.name,a.vs.getcurClickSegments()[0].id,a.vs.getcurClickSegments()[a.vs.getcurClickSegments().length-1].id);a.tds.moveSegment(e,a.this.level.name,a.vs.getcurClickSegments(),h),a.hists.updateCurChangeObj({type:"ESPS",action:"moveSegment",name:a.this.level.name,neighbours:h,itemIdx:a.vs.getcurClickSegments(),movedBy:e}),k=l}}else a.vs.movingBoundary=!1}a.vs.getdragBarActive()||f(b,c)}),b.bind("mousedown",function(b){a.vs.movingBoundary=!0,f(b,!0)}),b.bind("mouseup",function(b){a.vs.movingBoundary=!1,f(b,!0)}),b.bind("mouseout",function(b){a.vs.movingBoundary=!1,f(b,!0)})}}}),angular.module("emuwebApp").directive("trackmouse",["viewState","ConfigProviderService","Ssffdataservice","Drawhelperservice",function(a,b,c,d){return{restrict:"A",scope:{},link:function(e,f,g){function h(b){i=Math.round(d.getX(b)*a.getPCMpp(b)+a.curViewPort.sS),i>j?(k=i,a.select(j,k)):(j=i,a.select(j,k)),e.$apply()}var i,j,k,l,m,n,o,p,q,r,s,t,u=f[0],v=u.getContext("2d");g.$observe("ssffTrackname",function(a){a&&(l=a)}),f.bind("mousedown",function(b){j=Math.round(d.getX(b)*a.getPCMpp(b)+a.curViewPort.sS),k=j,a.select(j,j),e.$apply()}),f.bind("mousemove",function(g){switch(g.which){case 0:if(!$.isEmptyObject(c.data)&&0!==c.data.length&&!a.getdragBarActive()){switch(void 0===m&&"OSCI"!==l&&(m=b.getSsffTrackConfig(l),n=c.getColumnOfTrack(m.name,m.columnName),o=c.getSampleRateAndStartTimeOfTrack(m.name)),l){case"OSCI":p=void 0,q=void 0,r=void 0,s=!0,t="";break;case"SPEC":p=a.spectroSettings.rangeFrom,q=a.spectroSettings.rangeTo,r="Hz",s=!1,t=l;break;default:p=n._minVal,q=n._maxVal,r="",s=!1,t=l}var i=d.getX(g);a.curMousePosSample=Math.round(a.curViewPort.sS+i/f[0].width*(a.curViewPort.eS-a.curViewPort.sS)),v.clearRect(0,0,u.width,u.height),b.vals.restrictions.drawCrossHairs&&d.drawCrossHairs(v,g,p,q,r),d.drawMovingBoundaryLine(v),d.drawCurViewPortSelected(v,s),d.drawMinMaxAndName(v,t,p,q,2),s&&d.drawViewPortTimes(v),e.$apply()}break;case 1:a.getdragBarActive()||h(g)}}),f.bind("mouseleave",function(){v.clearRect(0,0,u.width,u.height),d.drawMovingBoundaryLine(v),d.drawCurViewPortSelected(v,s),d.drawMinMaxAndName(v,t,p,q,2),s&&d.drawViewPortTimes(v)}),f.bind("mouseup",function(b){a.getdragBarActive()||h(b)})}}}]),angular.module("emuwebApp").directive("handleglobalkeystrokes",["$timeout","viewState","Soundhandlerservice","ConfigProviderService","HistoryService","Levelservice",function(a,b,c,d,e,f){return{restrict:"A",link:function(a){$(document).bind("keydown",function(g){var h=g.keyCode?g.keyCode:g.which;a.$apply(function(){if(!d.vals.main.catchMouseForKeyBinding||b.mouseInEmuWebApp)if(a.setlastkeycode(h,g.shiftKey),b.focusInTextField){if(h===d.vals.keyMappings.enter&&b.isEditing()){var i=f.getElementDetailsById(b.getcurClickLevelName(),b.getlastID());e.addObjToUndoStack({type:"ESPS",action:"renameLabel",name:b.getcurClickLevelName(),itemIdx:b.getlastID(),oldValue:i.labels[0].value,newValue:$("."+b.getlasteditArea()).val()}),f.renameLabel(b.getcurClickLevelName(),b.getlastID(),$("."+b.getlasteditArea()).val()),b.deleteEditArea(),b.focusInTextField=!1}h===d.vals.keyMappings.esc&&(b.focusInTextField=!1,b.deleteEditArea()),13===h&&(g.preventDefault(),g.stopPropagation())}else{if(b.deleteEditArea(),h===d.vals.keyMappings.zoomAll&&(b.getPermission("zoom")?b.setViewPort(0,b.curViewPort.bufferLength):console.log("action currently not allowed")),h===d.vals.keyMappings.zoomIn&&(b.getPermission("zoom")?b.zoomViewPort(!0):console.log("action currently not allowed")),h===d.vals.keyMappings.zoomOut&&(b.getPermission("zoom")?b.zoomViewPort(!1):console.log("action currently not allowed")),h===d.vals.keyMappings.shiftViewPortLeft&&(b.getPermission("zoom")?b.shiftViewPort(!1):console.log("action currently not allowed")),h===d.vals.keyMappings.shiftViewPortRight&&(b.getPermission("zoom")?b.shiftViewPort(!0):console.log("action currently not allowed")),h===d.vals.keyMappings.zoomSel&&(b.getPermission("zoom")?b.setViewPort(b.curViewPort.selectS,b.curViewPort.selectE):console.log("action currently not allowed")),h===d.vals.keyMappings.playEntireFile&&(b.getPermission("zoom")?d.vals.restrictions.playback&&(c.playFromTo(0,c.wavJSO.Data.length),b.animatePlayHead(0,c.wavJSO.Data.length)):console.log("action currently not allowed")),h===d.vals.keyMappings.playAllInView&&(b.getPermission("zoom")?d.vals.restrictions.playback&&(c.playFromTo(b.curViewPort.sS,b.curViewPort.eS),b.animatePlayHead(b.curViewPort.sS,b.curViewPort.eS)):console.log("action currently not allowed")),h===d.vals.keyMappings.playSelected&&(b.getPermission("zoom")?d.vals.restrictions.playback&&(c.playFromTo(b.curViewPort.selectS,b.curViewPort.selectE),b.animatePlayHead(b.curViewPort.selectS,b.curViewPort.selectE)):console.log("action currently not allowed")),h===d.vals.keyMappings.selectFirstContourCorrectionTool&&d.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=1),h===d.vals.keyMappings.selectSecondContourCorrectionTool&&d.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=2),h===d.vals.keyMappings.selectThirdContourCorrectionTool&&d.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=3),h===d.vals.keyMappings.selectFourthContourCorrectionTool&&d.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=4),h===d.vals.keyMappings.selectNoContourCorrectionTool&&d.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=void 0),h===d.vals.keyMappings.levelUp&&b.selectLevel(!1),h===d.vals.keyMappings.levelDown&&b.selectLevel(!0),h===d.vals.keyMappings.snapBoundaryToTop&&d.vals.restrictions.editItemSize){var j=b.getcurMouseSegmentId(),k=b.getcurMouseLevelName(),l=f.snapBoundary(!0,b.getcurMouseSegment().sampleStart,k,j);a.hists.addObjToUndoStack({type:"ESPS",action:"snapBoundary",levelName:k,itemIdx:j,movedBy:l})}if(h===d.vals.keyMappings.snapBoundaryToBottom&&d.vals.restrictions.editItemSize){var j=b.getcurMouseSegmentId(),k=b.getcurMouseLevelName(),l=f.snapBoundary(!1,b.getcurMouseSegment().sampleStart,k,j);a.hists.addObjToUndoStack({type:"ESPS",action:"snapBoundary",levelName:k,itemIdx:j,movedBy:l})}if(h===d.vals.keyMappings.plus&&d.vals.restrictions.editItemSize)if(void 0===b.getcurClickLevelName())a.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select a Level first");else if(0===b.getselected().length)a.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select one or more Segments first");else{if("absolute"===d.vals.labelCanvasConfig.addTimeMode)var m=parseInt(d.vals.labelCanvasConfig.addTimeValue,10);else if("relative"===d.vals.labelCanvasConfig.addTimeMode)var m=d.vals.labelCanvasConfig.addTimeValue*(b.curViewPort.bufferLength/100);else a.dials.open("views/error.html","ModalCtrl","Expand Segements Error: Error in Configuration (Value labelCanvasConfig.addTimeMode)");f.expandSegment(!0,b.getcurClickSegments(),b.getcurClickLevelName(),m),a.hists.addObjToUndoStack({type:"ESPS",action:"expandSegments",name:b.getcurClickLevelName(),itemIdx:b.getcurClickSegments(),rightSide:!0,changeTime:m});var n=b.getcurClickSegments().length;1==n?b.select(b.getcurClickSegments()[0].sampleStart,b.getcurClickSegments()[0].sampleStart+b.getcurClickSegments()[0].sampleDur):b.select(b.getcurClickSegments()[0].sampleStart,b.getcurClickSegments()[n-1].sampleStart+b.getcurClickSegments()[n-1].sampleDur)}if(h===d.vals.keyMappings.plusShift&&d.vals.restrictions.editItemSize)if(void 0===b.getcurClickLevelName())a.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select a Level first");else if(0===b.getselected().length)a.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select one or more Segments first");else{if("absolute"===d.vals.labelCanvasConfig.addTimeMode)var m=parseInt(d.vals.labelCanvasConfig.addTimeValue,10);else if("relative"===d.vals.labelCanvasConfig.addTimeMode)var m=d.vals.labelCanvasConfig.addTimeValue*(b.curViewPort.bufferLength/100);else a.dials.open("views/error.html","ModalCtrl","Expand Segements Error: Error in Configuration (Value labelCanvasConfig.addTimeMode)");f.expandSegment(!1,b.getcurClickSegments(),b.getcurClickLevelName(),m),a.hists.addObjToUndoStack({type:"ESPS",action:"expandSegments",name:b.getcurClickLevelName(),itemIdx:b.getcurClickSegments(),rightSide:!1,changeTime:m});var n=b.getcurClickSegments().length;1==n?b.select(b.getcurClickSegments()[0].sampleStart,b.getcurClickSegments()[0].sampleStart+b.getcurClickSegments()[0].sampleDur):b.select(b.getcurClickSegments()[0].sampleStart,b.getcurClickSegments()[n-1].sampleStart+b.getcurClickSegments()[n-1].sampleDur)}if(h===d.vals.keyMappings.minus&&d.vals.restrictions.editItemSize)if(void 0===b.getcurClickLevelName())a.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select a Level first");else if(0===b.getselected().length)a.dials.open("views/error.html","ModalCtrl","Expand Segments Error: Please select one or more Segments first");else{if("absolute"===d.vals.labelCanvasConfig.addTimeMode)var m=parseInt(d.vals.labelCanvasConfig.addTimeValue,10);else if("relative"===d.vals.labelCanvasConfig.addTimeMode)var m=d.vals.labelCanvasConfig.addTimeValue*(b.curViewPort.bufferLength/100);else a.dials.open("views/error.html","ModalCtrl","Expand Segements Error: Error in Configuration (Value labelCanvasConfig.addTimeMode)");if(g.shiftKey){a.hists.addObjToUndoStack({type:"ESPS",action:"expandSegments",name:b.getcurClickLevelName(),itemIdx:b.getcurClickSegments(),rightSide:!1,changeTime:-m}),f.expandSegment(!1,b.getcurClickSegments(),b.getcurClickLevelName(),-m);var n=b.getcurClickSegments().length;1==n?b.select(b.getcurClickSegments()[0].sampleStart,b.getcurClickSegments()[0].sampleStart+b.getcurClickSegments()[0].sampleDur):b.select(b.getcurClickSegments()[0].sampleStart,b.getcurClickSegments()[n-1].sampleStart+b.getcurClickSegments()[n-1].sampleDur)}else{a.hists.addObjToUndoStack({type:"ESPS",action:"expandSegments",name:b.getcurClickLevelName(),itemIdx:b.getcurClickSegments(),rightSide:!0,changeTime:-m}),f.expandSegment(!0,b.getcurClickSegments(),b.getcurClickLevelName(),-m);var n=b.getcurClickSegments().length;1==n?b.select(b.getcurClickSegments()[0].sampleStart,b.getcurClickSegments()[0].sampleStart+b.getcurClickSegments()[0].sampleDur):b.select(b.getcurClickSegments()[0].sampleStart,b.getcurClickSegments()[n-1].sampleStart+b.getcurClickSegments()[n-1].sampleDur)}}if(h===d.vals.keyMappings.openSubmenu&&d.vals.activeButtons.openMenu&&(g.shiftKey?a.toggleRightSideMenuHidden():a.openSubmenu()),h===d.vals.keyMappings.openRightSubmenu&&a.openRightSubmenu(),h===d.vals.keyMappings.spectroSettings&&a.dials.open("views/spectroSettings.html","dialog"),h===d.vals.keyMappings.selectSegmentsInSelection&&(void 0===b.getcurClickLevelName()?a.dials.open("views/error.html","ModalCtrl","Selection Error : Please select a Level first"):b.selectSegmentsInSelection()),h===d.vals.keyMappings.left&&b.getcurClickSegments().length>0){var o=b.getcurClickSegments()[0].id,p=b.getcurClickSegments()[b.getcurClickSegments().length-1].id,q=f.getElementNeighbourDetails(b.getcurClickLevelName(),o,p);void 0!==q.left&&(b.setcurClickSegment(q.left,q.left.id),b.setlasteditArea("_"+q.left.id))}if(h===d.vals.keyMappings.right&&b.getcurClickSegments().length>0){var o=b.getcurClickSegments()[0].id,p=b.getcurClickSegments()[b.getcurClickSegments().length-1].id,q=f.getElementNeighbourDetails(b.getcurClickLevelName(),o,p);void 0!==q.right&&(b.setcurClickSegment(q.right,q.right.id),b.setlasteditArea("_"+q.right.id))}if(h===d.vals.keyMappings.tab&&b.getcurClickSegments().length>0){var o=b.getcurClickSegments()[0].id,p=b.getcurClickSegments()[b.getcurClickSegments().length-1].id,q=f.getElementNeighbourDetails(b.getcurClickLevelName(),o,p);g.shiftKey?void 0!==q.left&&(b.setcurClickSegment(q.left,q.left.id),b.setlasteditArea("_"+q.left.id)):void 0!==q.right&&(b.setcurClickSegment(q.right,q.right.id),b.setlasteditArea("_"+q.right.id))}if(h===d.vals.keyMappings.enter&&d.vals.restrictions.addItem)if(b.getselectedRange().start==b.curViewPort.selectS&&b.getselectedRange().end==b.curViewPort.selectE)1==b.getcurClickSegments().length?(b.setEditing(!0),b.openEditArea(b.getcurClickSegments()[0],b.getlasteditAreaElem(),b.getcurClickLevelType()),a.cursorInTextField()):a.dials.open("views/error.html","ModalCtrl","Modify Error: Please select a single Segment.");else if(-1==b.curViewPort.selectE&&-1==b.curViewPort.selectS)a.dials.open("views/error.html","ModalCtrl","Error : Please select a Segment or Point to modify it's name. Or select a level plus a range in the viewport in order to insert a new Segment.");else if("SEGMENT"==b.getcurClickLevelType()){var r=f.insertSegment(b.curViewPort.selectS,b.curViewPort.selectE,b.getcurClickLevelName(),d.vals.labelCanvasConfig.newSegmentName);r?a.hists.addObjToUndoStack({type:"ESPS",action:"insertSegments",levelName:b.getcurClickLevelName(),start:b.curViewPort.selectS,end:b.curViewPort.selectE,segname:d.vals.labelCanvasConfig.newSegmentName}):a.dials.open("views/error.html","ModalCtrl","Error : You are not allowed to insert a Segment here.")}else{var s=f.insertPoint(b.curViewPort.selectS,b.getcurClickLevelName(),d.vals.labelCanvasConfig.newPointName);s?a.hists.addObjToUndoStack({type:"ESPS",action:"insertPoint",levelName:b.getcurClickLevelName(),start:b.curViewPort.selectS,pointName:d.vals.labelCanvasConfig.newPointName}):a.dials.open("views/error.html","ModalCtrl","Error : You are not allowed to insert a Point here.")}if(h===d.vals.keyMappings.history&&(g.shiftKey?e.redo():e.undo()),h===d.vals.keyMappings.backspace)if(g.shiftKey){if(d.vals.restrictions.deleteItem){var t=b.getcurClickSegments();if(void 0!==t){var u=b.getcurClickSegments(),v=f.getElementNeighbourDetails(b.getcurClickLevelName(),u[0].id,u[u.length-1].id);"SEGMENT"===b.getcurClickLevelType()?(f.deleteSegments(b.getcurClickLevelName(),u,v),b.setcurClickSegment(v.left,v.left.id),a.hists.addObjToUndoStack({type:"ESPS",action:"deleteSegments",name:b.getcurClickLevelName(),selected:u,neighbours:v})):a.dials.open("views/error.html","ModalCtrl","Delete Error: You can not delete Segments on Point Levels.")}}}else if(d.vals.restrictions.deleteItem){var t=b.getcurMouseSegment(),w=b.getcurMouseLevelName();void 0!==t?(a.hists.addObjToUndoStack({type:"ESPS",action:"deleteBoundary",name:w,levelType:b.getcurMouseLevelType(),seg:t}),f.deleteBoundary(b.getcurMouseSegment(),b.getcurMouseLevelName(),b.getcurMouseLevelType())):a.dials.open("views/error.html","ModalCtrl","Delete Error: Please select a Boundary first.")}g.metaKey||(g.preventDefault(),g.stopPropagation())}})}),a.safeApply=function(a){var b=this.$root.$$phase;"$apply"==b||"$digest"==b?a&&"function"==typeof a&&a():this.$apply(a)},a.$on("$destroy",function(){$(window).off("keydown")})}}}]),angular.module("emuwebApp").directive("delete",function(){return{restrict:"A",link:function(a,b){var c=a.this.level.LevelName;
b.bind("click",function(){a.vs.setcurClickLevelName(c),a.dials.open("views/deleteLevel.html","ModalCtrl",c)})}}}),angular.module("emuwebApp").directive("resize",function(){return{restrict:"A",link:function(a,b){var c=b.parent().parent(),d=0,e=c.find(b.parent().children()[0]),f=(c.find(b.parent().children()[1]),c.find(b.parent().children()[2]));b.bind("click",function(){a.open?(a.open=!1,d=c.css("height"),c.css({height:"30px"}),a.cps.vals.activeButtons.deleteSingleLevel&&e.hide(),a.cps.vals.activeButtons.saveSingleLevel&&f.hide()):(a.open=!0,c.css({height:d}),a.cps.vals.activeButtons.deleteSingleLevel&&e.show(),a.cps.vals.activeButtons.saveSingleLevel&&f.show()),a.updateView()})}}}),angular.module("emuwebApp").directive("enlarge",["$rootScope","viewState",function(a,b){return{restrict:"A",link:function(c,d,e){var f=!1;d.bind("click",function(){f?(f=!1,b.setenlarge(-1)):(f=!0,b.setenlarge(e.enlarge)),c.redraw(),a.$digest()})}}}]),angular.module("emuwebApp").directive("save",["dialogService","Espsparserservice",function(a,b){return{restrict:"A",link:function(c,d){var e=c.this.level.LevelName;d.bind("click",function(){c.vs.setcurClickLevelName(e),a.openExport("views/export.html","ExportCtrl",b.toESPS(c.this.level),"level.txt")})}}}]),angular.module("emuwebApp").directive("export",["$compile",function(a){return{restrict:"E",scope:{getUrlData:"&getData"},link:function(b,c,d){var e=URL.createObjectURL(b.getUrlData());console.log(d),c.append(a('<a id="dialogExport" download="'+d.filename+'" href="'+e+'">Export</a>')(b))}}}]),angular.module("emuwebApp").directive("previewtrack",function(){return{restrict:"A",link:function(a,b){function c(a){return a.offsetX*(a.originalEvent.srcElement.width/a.originalEvent.srcElement.clientWidth)}var d=-1;b.bind("click",function(b){if(!$.isEmptyObject(a.shs.wavJSO)){var e=a.vs.curViewPort.eS-a.vs.curViewPort.sS;d=c(b)*(a.shs.wavJSO.Data.length/b.originalEvent.srcElement.width),a.vs.setViewPort(d-e/2,d+e/2),a.$apply()}}),b.bind("mousedown",function(b){$.isEmptyObject(a.shs.wavJSO)||(d=c(b)*(a.shs.wavJSO.Data.length/b.originalEvent.srcElement.width))}),b.bind("mousemove",function(b){switch(event.which){case 1:if(-1!==d){var e=a.vs.curViewPort.eS-a.vs.curViewPort.sS;d=c(b)*(a.shs.wavJSO.Data.length/b.originalEvent.srcElement.width),a.vs.setViewPort(d-e/2,d+e/2),a.$apply()}}}),b.bind("mouseup",function(){d=-1}),b.bind("mouseout",function(){d=-1})}}}),angular.module("emuwebApp").service("Iohandlerservice",["$rootScope","$http","$location","$q","HistoryService","viewState","Soundhandlerservice","Ssffparserservice","Wavparserservice","Textgridparserservice","ConfigProviderService","Espsparserservice","Ssffdataservice","Websockethandler","Httphandler",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o={};return o.wsH=n,o.httpGetDefaultConfig=function(){var a=b.get("configFiles/defaultConfig.json");return a},o.httpGetPath=function(a,c){var d=b.get(a,{responseType:c});return d},o.getProtocol=function(){var a;return"CORS"===k.vals.main.comMode?alert("CORS version of getProtocol not implemented"):"WS"===k.vals.main.comMode&&(a=n.getProtocol()),a},o.getDoUserManagement=function(){var a;return"CORS"===k.vals.main.comMode?alert("CORS version of getDoUserManagement not implemented"):"WS"===k.vals.main.comMode&&(a=n.getDoUserManagement()),a},o.getDBconfigFile=function(a){var c;return"CORS"===k.vals.main.comMode?alert("CORS version of getDBconfigFile not implemented"):"WS"===k.vals.main.comMode?c=n.getDBconfigFile():"DEMO"===k.vals.main.comMode&&(c=b.get("demoDBs/"+a+"/"+a+"_DBconfig.json")),c},o.getBundleList=function(a){var c;return"CORS"===k.vals.main.comMode?alert("CORS version of getBundleList not implemented"):"WS"===k.vals.main.comMode?c=n.getBundleList():"DEMO"===k.vals.main.comMode&&(c=b.get("demoDBs/"+a+"/"+a+"_bundleList.json")),c},o.getBundle=function(a,c){var d;return"CORS"===k.vals.main.comMode?alert("CORS version of getBundle not implemented"):"WS"===k.vals.main.comMode?d=n.getBundle(a):"DEMO"===k.vals.main.comMode&&(d=b.get("demoDBs/"+c+"/"+a+"_bndl.json")),d},o.saveBundle=function(a){var b;return"CORS"===k.vals.main.comMode?alert("CORS version of saveBundle not implemented"):"WS"===k.vals.main.comMode&&(b=n.saveBundle(a)),b},o.toTextGrid=function(a){return j.toTextGrid(a)},o}]),angular.module("emuwebApp").service("Soundhandlerservice",["$document","Binarydatamaniphelper",function(a,b){var c={};return c.wavJSO={},c.player=a[0].createElement("audio"),c.player.isPlaying=!1,c.setPlayerSrc=function(a){var c=b.arrayBufferToBase64(a);this.player.src="data:audio/wav;base64,"+c},c.resetPlayerSrcFromTo=function(a,c){var d=this.wavJSO.BitsPerSample/8,e=this.wavJSO.origArrBuf.subarray(0,44),f=this.wavJSO.origArrBuf.subarray(44,this.wavJSO.Data.length*d),g=new DataView(e);g.setUint32(40,(c-a)*d,!0);var h=f.subarray(a*d,(c-a)*d),i=new Uint8Array(e.byteLength+h.byteLength);i.set(new Uint8Array(e),0),i.set(new Uint8Array(h),e.byteLength);var j=b.arrayBufferToBase64(i.buffer);this.player.src="data:audio/wav;base64,"+j},c.playFromTo=function(a,b){this.resetPlayerSrcFromTo(a,b),this.player.isPlaying?(this.player.isPlaying=!1,this.player.pause()):(this.player.isPlaying=!0,this.player.play())},c.player.addEventListener("ended",function(){this.isPlaying=!1},!1),c}]),angular.module("emuwebApp").directive("drawssff",["viewState","ConfigProviderService","Ssffdataservice","HistoryService",function(a,b,c,d){return{restrict:"A",scope:{},link:function(e,f,g){function h(){if($.isEmptyObject(c.data)){var d=k.getContext("2d");d.clearRect(0,0,k.width,k.height)}else if(0!==c.data.length&&(l="",b.vals.perspectives[a.curPerspectiveIdx].signalCanvases.assign.forEach(function(d){if(d.signalCanvasName===j){l=d.ssffTrackName;var e=b.getSsffTrackConfig(d.ssffTrackName),f=c.getColumnOfTrack(e.name,e.columnName),g=c.getSampleRateAndStartTimeOfTrack(e.name),h=b.getLimsOfTrack(e.name);i(a,k,b,f,g.sampleRate,g.startTime,h)}}),l="","OSCI"!==j&&"SPEC"!==j)){var e=b.getSsffTrackConfig(j),f=c.getColumnOfTrack(e.name,e.columnName),g=c.getSampleRateAndStartTimeOfTrack(e.name),h=b.getLimsOfTrack(e.name);i(a,k,b,f,g.sampleRate,g.startTime,h)}}function i(a,c,d,f,g,h,i){var k=c.getContext("2d");k.clearRect(0,0,c.width,c.height);var m,n;"SPEC"===j&&"FORMANTS"===l?(m=a.spectroSettings.rangeFrom,n=a.spectroSettings.rangeTo):(m=f._minVal,n=f._maxVal);var o=a.getViewPortStartTime(),p=a.getViewPortEndTime(),q=Math.round(o*g+h),r=Math.round(p*g+h),s=r-q,t=f.values.slice(q,q+s);if(s<c.width&&s>=2){var u,v,w,x,y,z,A;t.forEach(function(b,d){b.forEach(function(e,s){if($.isEmptyObject(i)||s>=i.min&&s<=i.max){if(z=q+d,A=1/g*z+h,u=(A-o)/(p-o)*c.width,v=c.height-(e-m)/(n-m)*c.height,$.isEmptyObject(i))k.strokeStyle="hsl("+s*(360/b.length)+",80%, 50%)",k.fillStyle="hsl("+s*(360/b.length)+",80%, 50%)";else{var B=i.max-i.min+1;k.strokeStyle="hsl("+s*(360/B)+",80%, 50%)",k.fillStyle="hsl("+s*(360/B)+",80%, 50%)"}if(null!==e&&(k.beginPath(),k.arc(u,v-1,2,0,2*Math.PI,!1),k.closePath(),k.stroke(),k.fill()),0!==d){if(z=q+d-1,A=1/g*z+h,w=(A-o)/(p-o)*c.width,x=c.height-(t[d-1][s]-m)/(n-m)*c.height,a.curCorrectionToolNr-1===s&&"SPEC"===j&&"FORMANTS"===l&&(k.strokeStyle="white",k.fillStyle="white"),null!==e&&null!==y&&(k.beginPath(),k.moveTo(w,x),k.lineTo(u,v),k.stroke(),k.fill()),y=e,d===t.length-1&&r!==f.values.length-1){var C=f.values[r+1];e=C[s],z=r+1,A=1/g*z+h;var D=(A-o)/(p-o)*c.width,E=c.height-(e-m)/(n-m)*c.height;k.beginPath(),k.moveTo(u,v),k.lineTo(D,E),k.stroke(),k.fill()}}else if(0!==q){var F=f.values[q-1];e=F[s],z=q-1,A=1/g*z+h,w=(A-o)/(p-o)*c.width,x=c.height-(e-m)/(n-m)*c.height,a.curCorrectionToolNr-1===s&&"SPEC"===j&&"FORMANTS"===l&&(k.strokeStyle="white",k.fillStyle="white"),k.beginPath(),k.moveTo(w,x),k.lineTo(u,v),k.stroke(),k.fill()}}})})}else{k.strokeStyle="red";var B;if(2>=s){B="Zoom out to see contour(s)";var C=e.fontImage.getTextImage(k,B,b.vals.font.fontPxSize,b.vals.font.fontType,"red");k.drawImage(C,0,0,C.width,C.height,c.width/2-C.width/2,c.height/2-C.height/2,C.width,C.height)}else{B="Zoom in to see contour(s)";var C=e.fontImage.getTextImage(k,B,b.vals.font.fontPxSize,b.vals.font.fontType,"red");k.drawImage(C,0,0,C.width,C.height,c.width/2-C.width/2,c.height/2-C.height/2,C.width,C.height)}}}var j,k=f[0],l="";g.$observe("ssffTrackname",function(a){j=a}),e.curViewPort=a.curViewPort,e.curPerspectiveIdx=a.curPerspectiveIdx,e.movesAwayFromLastSave=d.movesAwayFromLastSave,e.curCorrectionToolNr=a.curCorrectionToolNr,e.ssffds=c,e.spectroSettings=a.spectroSettings,e.$watch("curViewPort",function(a,b){(a.sS!==b.sS||a.eS!==b.eS)&&h(a,b)},!0),e.$watch("curPerspectiveIdx",function(a,b){h(a,b)},!0),e.$watch("movesAwayFromLastSave",function(a,b){h(a,b)},!0),e.$watch("curCorrectionToolNr",function(a,b){h(a,b)},!0),e.$watch("ssffds.data",function(a,b){h(a,b)},!0),e.$watch("spectroSettings",function(a,b){h(a,b)},!0)}}}]),angular.module("emuwebApp").service("Ssffparserservice",["$q",function(a){var b,c={},d=new Worker("scripts/workers/ssffParserWorker.js");return d.addEventListener("message",function(a){"SUCCESS"===a.data.status.type?b.resolve(a.data):b.reject(a.data)},!1),c.asyncParseSsffArr=function(c){return b=a.defer(),d.postMessage({cmd:"parseArr",ssffArr:c}),b.promise},c.asyncJso2ssff=function(c){return b=a.defer(),d.postMessage({cmd:"jso2ssff",jso:c}),b.promise},c}]),angular.module("emuwebApp").directive("correctiontool",function(){return{restrict:"A",link:function(a,b,c){function d(b){e=Math.round(a.dhs.getX(b)*a.vs.getPCMpp(b)+a.vs.curViewPort.sS),e>f?(g=e,a.vs.select(f,g)):(f=e,a.vs.select(f,g)),a.$apply()}var e,f,g,h,i,j,k,l=b[0],m=l.getContext("2d");c.$observe("ssffTrackname",function(a){a&&(k=a)}),b.bind("mousedown",function(b){f=Math.round(a.dhs.getX(b)*a.vs.getPCMpp(b)+a.vs.curViewPort.sS),g=f,a.vs.select(f,f),a.$apply()}),b.bind("mousemove",function(c){switch(c.which){case 0:if(!$.isEmptyObject(a.ssffds.data)&&0!==a.ssffds.data.length&&!a.vs.getdragBarActive()){var e=a.dhs.getX(c);if(a.vs.curMousePosSample=Math.round(a.vs.curViewPort.sS+e/b[0].width*(a.vs.curViewPort.eS-a.vs.curViewPort.sS)),m.clearRect(0,0,l.width,l.height),a.cps.vals.restrictions.drawCrossHairs&&a.dhs.drawCrossHairs(m,c,a.vs.spectroSettings.rangeFrom,a.vs.spectroSettings.rangeTo,"Hz"),a.dhs.drawMovingBoundaryLine(m),a.dhs.drawCurViewPortSelected(m,!1),a.dhs.drawMinMaxAndName(m,"",a.vs.spectroSettings.rangeFrom,a.vs.spectroSettings.rangeTo,2),void 0!==a.vs.curCorrectionToolNr&&!a.vs.getdragBarActive()&&!$.isEmptyObject(a.cps.getAssignment(k))){void 0===h&&(h=a.cps.getSsffTrackConfig("FORMANTS"),i=a.ssffds.getColumnOfTrack(h.name,h.columnName),j=a.ssffds.getSampleRateAndStartTimeOfTrack(h.name));var f=a.vs.getViewPortStartTime(),g=a.vs.getViewPortEndTime(),n=Math.round(f*j.sampleRate+j.startTime),o=Math.round(g*j.sampleRate+j.startTime),p=o-n,q=i.values.slice(n,n+p),r=f+a.dhs.getX(c)/c.originalEvent.srcElement.width*(g-f),s=Math.round((r+j.startTime)*j.sampleRate)-1,t=1/j.sampleRate*s+j.startTime;if(0>s-n||s-n>=q.length)return void console.log("early return");a.vs.curPreselColumnSample=s-n;var u=(t-f)/(g-f)*l.width,v=l.height-q[a.vs.curPreselColumnSample][a.vs.curCorrectionToolNr-1]/(a.vs.spectroSettings.rangeTo-a.vs.spectroSettings.rangeFrom)*l.height;if(m.strokeStyle="#0DC5FF",m.fillStyle="white",m.beginPath(),m.arc(u,v-1,2,0,2*Math.PI,!1),m.closePath(),m.stroke(),m.fill(),c.shiftKey){var w=angular.copy(q[a.vs.curPreselColumnSample][a.vs.curCorrectionToolNr-1]),x=a.vs.spectroSettings.rangeTo-a.dhs.getY(c)/c.originalEvent.srcElement.height*a.vs.spectroSettings.rangeTo;q[a.vs.curPreselColumnSample][a.vs.curCorrectionToolNr-1]=a.vs.spectroSettings.rangeTo-a.dhs.getY(c)/c.originalEvent.srcElement.height*a.vs.spectroSettings.rangeTo;var y=a.hists.updateCurChangeObj({type:"SSFF",trackName:h.name,sampleBlockIdx:n+a.vs.curPreselColumnSample,sampleIdx:a.vs.curCorrectionToolNr-1,oldValue:w,newValue:x});for(var z in y)t=1/j.sampleRate*y[z].sampleBlockIdx+j.startTime,u=(t-f)/(g-f)*l.width,v=l.height-y[z].newValue/(a.vs.spectroSettings.rangeTo-a.vs.spectroSettings.rangeFrom)*l.height,m.strokeStyle="red",m.fillStyle="red",m.beginPath(),m.arc(u,v-1,2,0,2*Math.PI,!1),m.closePath(),m.stroke(),m.fill()}}}break;case 1:a.vs.getdragBarActive()||d(c)}a.$apply()}),b.bind("mouseup",function(b){a.vs.getdragBarActive()||d(b)})}}}),angular.module("emuwebApp").service("Drawhelperservice",["viewState","ConfigProviderService","Soundhandlerservice","fontScaleService","Levelservice",function(a,b,c,d,e){function f(a,b,c){return a.measureText(b).width*c}function g(a,b,c,d){return b.toString().length>c.toString().length?f(a,b,d):f(a,c,d)}function h(a,b,c,d,e,f,g){var h=f.getContext("2d"),i=a.curViewPort.eS-a.curViewPort.sS,j=a.curCursorPosInPercent*a.bufferLength-a.curViewPort.sS,k=j/i,l=f.width*k,m=1,n=Math.round(c*(f.height/d)),o=b*m,p=Math.round((f.height-n)/2),q=Math.round(e*(f.height/d)),r=(b-1)*m,s=Math.round((f.height-q)/2);l>=o?(h.fillStyle=g.vals.colors.playProgressColor,h.strokeStyle=g.vals.colors.playProgressColor):(h.fillStyle=g.vals.colors.osciColor,h.strokeStyle=g.vals.colors.osciColor),h.beginPath(),h.moveTo(r,s),h.lineTo(o,p),h.stroke()}var i={};return i.osciPeaks=[],i.getX=function(a){return a.offsetX*(a.originalEvent.srcElement.width/a.originalEvent.srcElement.clientWidth)},i.getY=function(a){return a.offsetY*(a.originalEvent.srcElement.height/a.originalEvent.srcElement.clientHeight)},i.calculatePeaks=function(a,b,c){var d,e=(a.curViewPort.eS+1-a.curViewPort.sS)/b.width,f=1,g=[],h=1/0,i=-1/0;if(1>=e)d=0===a.curViewPort.sS?c.subarray(a.curViewPort.sS,a.curViewPort.eS+2):c.subarray(a.curViewPort.sS-1,a.curViewPort.eS+2),h=Math.min.apply(Math,d),i=Math.max.apply(Math,d),g=Array.prototype.slice.call(d);else{d=c.subarray(a.curViewPort.sS,a.curViewPort.eS);for(var j=0;j<b.width;j++){for(var k=0,l=0;f>l;l++){for(var m=d.subarray(j*e,(j+1)*e),n=-1/0,o=0,p=0,q=m.length;q>p;p++)m[p]>n&&(n=m[p]),o+=m[p];k+=o/m.length}g[j]=k,k>i&&(i=k)}}return{peaks:g,minPeak:h,maxPeak:i,samplePerPx:e}},i.freshRedrawDrawOsciOnCanvas=function(a,b,c,d,e){var f=b.getContext("2d");if(f.clearRect(0,0,b.width,b.height),c.peaks&&c.samplePerPx>=1)c.peaks.forEach(function(d,f){0!==f&&h(a,f,d,c.maxPeak,c.peaks[f-1],b,e)});else if(c.samplePerPx<1){var g=1/c.samplePerPx/2,i=a.curViewPort.sS;f.strokeStyle=e.vals.colors.osciColor,f.fillStyle=e.vals.colors.osciColor;var j;if(0===a.curViewPort.sS){for(f.moveTo(g,(c.peaks[0]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height),j=0;j<c.peaks.length;j++)f.lineTo(j/c.samplePerPx+g,(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height);for(f.stroke(),j=0;j<c.peaks.length;j++)f.beginPath(),f.arc(j/c.samplePerPx+g,(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-3,4,0,2*Math.PI,!1),f.stroke(),f.fill(),e.vals.restrictions.drawSampleNrs&&(f.strokeText(i,j/c.samplePerPx+g,(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-10),i+=1)}else{for(f.beginPath(),f.moveTo(-g,b.height-(c.peaks[0]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height),j=1;j<=c.peaks.length;j++)f.lineTo(j/c.samplePerPx-g,b.height-((c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height+3));for(f.stroke(),j=1;j<=c.peaks.length;j++)f.beginPath(),f.arc(j/c.samplePerPx-g,b.height-(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-3,4,0,2*Math.PI,!1),f.stroke(),f.fill(),e.vals.restrictions.drawSampleNrs&&(f.fillText(i,j/c.samplePerPx-g,b.height-(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-10),i+=1)}}if(e.vals.restrictions.drawZeroLine){if(f.strokeStyle=e.vals.colors.zeroLineColor,f.fillStyle=e.vals.colors.zeroLineColor,"Google Inc."===navigator.vendor&&f.setLineDash([2]),c.samplePerPx>=1)f.beginPath(),f.moveTo(0,b.height/2),f.lineTo(b.width,b.height/2),f.stroke(),f.fillText("0",5,b.height/2-5,b.width);else{var k=b.height-(0-c.minPeak)/(c.maxPeak-c.minPeak)*b.height;f.beginPath(),f.moveTo(0,k),f.lineTo(b.width,k),f.stroke(),f.fill(),f.fillText("0",5,b.height-(0-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-5,b.width)}"Google Inc."===navigator.vendor&&f.setLineDash([0])}},i.drawMovingBoundaryLine=function(c){var d,f;if(f=a.getSampleDist(c.canvas.width),d="SEGMENT"===a.getcurMouseLevelType()?0:f/2,a.movingBoundary){c.fillStyle=b.vals.colors.selectedBoundaryColor;var g=e.getLevelDetails(a.getcurMouseLevelName()).level,h=a.getcurMouseSegment(),i=e.getElementDetailsById(a.getcurMouseLevelName(),h.id);if(h!==!1&&h!==!0){if("SEGMENT"==g.type)var j=Math.round(a.getPos(c.canvas.width,i.sampleStart));else var j=Math.round(a.getPos(c.canvas.width,i.samplePoint));c.fillRect(j+d,0,1,c.canvas.height)}}},i.drawCurViewPortSelected=function(e,h){var i,j,k,l,m;j=a.getSampleDist(e.canvas.width),i="seg"===a.getcurMouseLevelType()?0:j/2;var n=a.getPos(e.canvas.width,a.curViewPort.selectS),o=a.getPos(e.canvas.width,a.curViewPort.selectE);if(n===o)e.fillStyle=b.vals.colors.selectedBorderColor,e.fillRect(n+i,0,2,e.canvas.height),h&&a.curViewPort.sS!==a.curViewPort.selectS&&-1!==a.curViewPort.selectS&&(m=e.canvas.width/e.canvas.offsetWidth,k=g(e,a.curViewPort.selectS,a.round(a.curViewPort.selectS/c.wavJSO.SampleRate,6),m),l=d.getTextImageTwoLines(e,a.curViewPort.selectS,a.round(a.curViewPort.selectS/c.wavJSO.SampleRate,6),b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0),e.drawImage(l,0,0,l.width,l.height,o+5,0,l.width,l.height));else if(e.fillStyle=b.vals.colors.selectedAreaColor,e.fillRect(n,0,o-n,e.canvas.height),e.strokeStyle=b.vals.colors.selectedBorderColor,e.beginPath(),e.moveTo(n,0),e.lineTo(n,e.canvas.height),e.moveTo(o,0),e.lineTo(o,e.canvas.height),e.closePath(),e.stroke(),h&&(m=e.canvas.width/e.canvas.offsetWidth,k=g(e,a.curViewPort.selectS,a.round(a.curViewPort.selectS/c.wavJSO.SampleRate,6),m),l=d.getTextImageTwoLines(e,a.curViewPort.selectS,a.round(a.curViewPort.selectS/c.wavJSO.SampleRate,6),b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1),e.drawImage(l,0,0,l.width,l.height,n-k-5,0,l.width,l.height),l=d.getTextImageTwoLines(e,a.curViewPort.selectE,a.round(a.curViewPort.selectE/c.wavJSO.SampleRate,6),b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0),e.drawImage(l,0,0,l.width,l.height,o+5,0,l.width,l.height),k=f(e,a.round((a.curViewPort.selectE-a.curViewPort.selectS)/c.wavJSO.SampleRate,6),m),o-n>k)){var p=a.curViewPort.selectE-a.curViewPort.selectS,q=a.round((a.curViewPort.selectE-a.curViewPort.selectS)/c.wavJSO.SampleRate,6);k=g(e,p,q,m),l=d.getTextImageTwoLines(e,p,q,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1),e.drawImage(l,0,0,l.width,l.height,n+(o-n)/2-k/2,0,l.width,l.height)}},i.drawCrossHairs=function(c,e,f,g,h){if(b.vals.restrictions.drawCrossHairs){c.strokeStyle=b.vals.colors.crossHairsColor,c.fillStyle=b.vals.colors.crossHairsColor,"Google Inc."===navigator.vendor&&c.setLineDash([2]);var j=i.getX(e),k=i.getY(e);c.beginPath(),c.moveTo(0,k),c.lineTo(5,k+5),c.moveTo(0,k),c.lineTo(c.canvas.width,k),c.lineTo(c.canvas.width-5,k+5),c.moveTo(j,0),c.lineTo(j,c.canvas.height),c.stroke(),c.font=b.vals.font.fontPxSize+"px "+b.vals.font.fontType;var l=a.round(g-k/c.canvas.height*g,2),m=c.measureText(l+h).width,n=Math.round(a.curViewPort.sS+j/c.canvas.width*(a.curViewPort.eS-a.curViewPort.sS)),o=a.round(a.getViewPortStartTime()+j/c.canvas.width*(a.getViewPortEndTime()-a.getViewPortStartTime()),6),p=d.getTextImage(c,l+h,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.crossHairsColor,!0),q=d.getTextImageTwoLines(c,n,o,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.crossHairsColor,!0);(void 0!==g||void 0!==f)&&(c.drawImage(p,0,0,p.width,p.height,5,k,p.width,p.height),c.drawImage(p,0,0,p.width,p.height,c.canvas.width-5-m*(c.canvas.width/c.canvas.offsetWidth),k,p.width,p.height)),c.drawImage(q,0,0,q.width,q.height,j+5,0,q.width,q.height),"Google Inc."===navigator.vendor&&c.setLineDash([0])}},i.drawMinMaxAndName=function(c,e,f,g,h){var i=c.canvas.height/c.canvas.offsetHeight,j=3*b.vals.font.fontPxSize/4,k=j*i;if(c.beginPath(),c.moveTo(0,0),c.lineTo(5,5),c.moveTo(0,c.canvas.height),c.lineTo(5,c.canvas.height-5),c.stroke(),c.closePath(),""!==e){c.font=b.vals.font.fontPxSize+"px "+b.vals.font.fontType;var l=d.getTextImage(c,e,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0);c.drawImage(l,0,c.canvas.height/2-b.vals.font.fontPxSize*i/2)}if(void 0!==g){var m=d.getTextImage(c,"max: "+a.round(g,h),j,b.vals.font.fontType,b.vals.colors.endBoundaryColor);c.drawImage(m,5,5,m.width,m.height)}void 0!==f&&(m=d.getTextImage(c,"min: "+a.round(f,h),j,b.vals.font.fontType,b.vals.colors.endBoundaryColor),c.drawImage(m,5,c.canvas.height-k-5,m.width,m.height))},i.drawViewPortTimes=function(e){e.strokeStyle=b.vals.colors.labelColor,e.fillStyle=b.vals.colors.labelColor,e.font=b.vals.font.fontPxSize+"px "+b.vals.font.fontType,e.beginPath(),e.moveTo(0,0),e.lineTo(5,5),e.moveTo(e.canvas.width,0),e.lineTo(e.canvas.width-5,5),e.closePath(),e.stroke();{var f,h,i,j,k=e.canvas.width/e.canvas.offsetWidth;e.canvas.height/e.canvas.offsetHeight}a.curViewPort&&(f=a.round(a.curViewPort.sS/c.wavJSO.SampleRate,6),h=a.round(a.curViewPort.eS/c.wavJSO.SampleRate,6),i=d.getTextImageTwoLines(e,a.curViewPort.sS,f,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0),e.drawImage(i,5,5),j=g(e,a.curViewPort.eS,h,k),i=d.getTextImageTwoLines(e,a.curViewPort.eS,h,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1),e.drawImage(i,0,0,i.width,i.height,e.canvas.width-j-5,0,i.width,i.height))},i}]),angular.module("emuwebApp").service("HistoryService",["Ssffdataservice","Levelservice","ConfigProviderService",function(a,b,c){function d(d,e){Object.keys(d).forEach(function(f){var g=d[f];if("SSFF"===g.type)if(e){var h=c.getSsffTrackConfig(g.trackName),i=a.getColumnOfTrack(h.name,h.columnName);i.values[g.sampleBlockIdx][g.sampleIdx]=g.oldValue}else{var h=c.getSsffTrackConfig(g.trackName),i=a.getColumnOfTrack(h.name,h.columnName);i.values[g.sampleBlockIdx][g.sampleIdx]=g.newValue}else if("ESPS"===g.type)switch(g.action){case"moveBoundary":e?b.moveBoundry(-g.movedBy,g.name,g.itemIdx,g.neighbours):b.moveBoundry(g.movedBy,g.name,g.itemIdx,g.neighbours);break;case"snapBoundary":if(e){var j=b.getLevelDetails(g.name);b.moveBoundry(-g.movedBy,j.level,g.itemIdx,g.max)}else{var j=b.getLevelDetails(g.name);b.moveBoundry(g.movedBy,j.level,g.itemIdx,g.max)}break;case"moveSegment":e?b.moveSegment(-g.movedBy,g.name,g.itemIdx,g.neighbours):b.moveSegment(g.movedBy,g.name,g.itemIdx,g.neighbours);break;case"movePoint":e?b.movePoint(-g.movedBy,g.name,g.itemIdx):b.movePoint(g.movedBy,g.name,g.itemIdx);break;case"renameLabel":e?b.renameLabel(g.name,g.itemIdx,g.oldValue):b.renameLabel(g.name,g.itemIdx,g.newValue);break;case"renameLevel":e?b.renameLevel(g.name,g.oldName):b.renameLevel(g.oldName,g.name);break;case"deleteLevel":e?b.data.levels.splice(g.itemIdx,0,g.level):b.data.levels.splice(g.itemIdx,1);break;case"deleteBoundary":e?b.insertSegment(g.seg.sampleStart,g.seg.sampleStart,g.levelName,c.vals.labelCanvasConfig.newSegmentName):b.deleteBoundary(g.seg,g.levelName,g.levelType);break;case"deleteSegments":e?b.deleteSegmentsInvers(g.name,g.selected,g.neighbours):b.deleteSegments(g.name,g.selected,g.neighbours);break;case"insertSegments":e?b.insertSegmentInvers(g.start,g.end,g.levelName,g.segname):b.insertSegment(g.start,g.end,g.levelName,g.segname);break;case"insertPoint":e?b.insertPointInvers(g.start,g.levelName,g.pointName):b.insertPoint(g.start,g.levelName,g.pointName);break;case"expandSegments":e?b.expandSegment(g.rightSide,g.itemIdx,g.name,-g.changeTime):b.expandSegment(g.rightSide,g.itemIdx,g.name,g.changeTime)}})}var e={};e.movesAwayFromLastSave=0;var f=[],g=[],h={};return e.updateCurChangeObj=function(a){var b;if("SSFF"===a.type)b=String(a.type+"#"+a.ssffIdx)+"#"+String(a.colIdx)+"#"+String(a.sampleBlockIdx)+"#"+String(a.sampleIdx),h[b]?(a.oldValue=h[b].oldValue,h[b]=a):h[b]=a;else if("ESPS"===a.type)switch(a.action){case"moveBoundary":case"movePoint":case"moveSegment":b=String(a.type+"#"+a.action+"#"+a.levelName+"#"+a.itemIdx),h[b]?(a.movedBy+=h[b].movedBy,h[b]=a):h[b]=a}return h},e.addCurChangeObjToUndoStack=function(){g=[],$.isEmptyObject(h)||(f.push(h),e.movesAwayFromLastSave+=1),h={}},e.addObjToUndoStack=function(a){g=[];var b={};b[String(a.type)+"#"+String(a.ssffIdx)+"#"+String(a.itemIdx)]=a,$.isEmptyObject(b)||f.push(b),h={}},e.undo=function(){if(f.length>0){var a=angular.copy(f[f.length-1]);g.push(a),d(a,!0),f.pop(),e.movesAwayFromLastSave-=1}},e.redo=function(){if(g.length>0){var a=angular.copy(g[g.length-1]);f.push(a),d(a,!1),g.pop(),e.movesAwayFromLastSave+=1}},e.getNrOfPossibleUndos=function(){return f.length},e.resetToInitState=function(){f=[],g=[],h={},e.movesAwayFromLastSave=0},e}]),angular.module("emuwebApp").service("Wavparserservice",["$q",function(a){var b,c={},d=new Worker("scripts/workers/wavParserWorker.js");return d.addEventListener("message",function(a){"SUCCESS"===a.data.status.type?b.resolve(a.data.data):b.reject(a.data)},!1),c.parseWavArrBuf=function(c){return b=a.defer(),d.postMessage({cmd:"parseBuf",buffer:c}),b.promise},c}]),angular.module("emuwebApp").service("Textgridparserservice",["$q","Soundhandlerservice",function(a,b){var c,d={},e=new Worker("scripts/workers/textGridParserWorker.js");return e.addEventListener("message",function(a){"SUCCESS"===a.data.status.type?c.resolve(a.data):c.reject(a.data)},!1),d.asyncParseTextGrid=function(d,f,g){return c=a.defer(),e.postMessage({cmd:"parseTG",textGrid:d,sampleRate:b.wavJSO.SampleRate,annotates:f,name:g}),c.promise},d}]),angular.module("emuwebApp").factory("uuid",function(){function a(a){var b=(Math.random().toString(16)+"000000000").substr(2,8);return a?"-"+b.substr(0,4)+"-"+b.substr(4,4):b}var b={};return b.new=function(){return a()+a(!0)+a(!0)+a()},b.newHash=function(){return a()+a(!0)+a(!0)+a()},b.empty=function(){return"00000000-0000-0000-0000-000000000000"},b}),angular.module("emuwebApp").service("fontScaleService",function(){var a={};return a.lastTextWidth=null,a.spaceTop=0,a.getTextImage=function(b,c,d,e,f){var g=b.canvas.height/b.canvas.offsetHeight,h=b.canvas.width/b.canvas.offsetWidth,i=document.createElement("canvas"),j=i.getContext("2d");return j.save(),j.font=d+"px "+e,j.fillStyle=f,j.scale(h,g),j.fillText(c,0,d+a.spaceTop),a.lastTextWidth=j.measureText(c).width*h,j.restore(),i},a.getLastImageWidth=function(){return a.lastTextWidth},a.getTextImageTwoLines=function(b,c,d,e,f,g,h){var i=b.canvas.height/b.canvas.offsetHeight,j=b.canvas.width/b.canvas.offsetWidth,k=document.createElement("canvas"),l=k.getContext("2d");if(l.save(),l.font=e+"px "+f,l.fillStyle=g,l.scale(j,i),a.lastTextWidth=l.measureText(c).width*j,h)l.fillText(c,0,e+a.spaceTop),l.fillText(d,0,2*e+a.spaceTop);else{var m=l.measureText(c).width,n=l.measureText(d).width;m>n?(l.fillText(c,0,e+a.spaceTop),l.fillText(d,m-n,2*e+a.spaceTop)):(l.fillText(c,n-m,e+a.spaceTop),l.fillText(d,0,2*e+a.spaceTop))}return l.restore(),k},a}),angular.module("emuwebApp").directive("draggable",["$rootScope","uuid",function(a,b){return{restrict:"A",link:function(c,d){var e=angular.element(d).attr("id");e||(e=b.new(),angular.element(d).attr("id",e)),d.bind("dragstart",function(b){b.originalEvent.dataTransfer.setData("text",e),angular.element(d).addClass("dragDragging"),a.$emit("dragStart")}),d.bind("dragend",function(){angular.element(d).removeClass("dragDragging"),a.$emit("dragEnd")})}}}]),angular.module("emuwebApp").directive("dropable",["$rootScope","uuid",function(a,b){return{restrict:"A",scope:{onDrop:"&"},link:function(c,d){var e=angular.element(d).attr("id");e||(e=b.new(),angular.element(d).attr("id",e)),d.bind("dragover",function(a){return a.preventDefault&&a.preventDefault(),a.originalEvent.dataTransfer.dropEffect="move",!1}),d.bind("dragenter",function(a){angular.element(a.target).addClass("dragOver")}),d.bind("dragleave",function(a){angular.element(a.target).removeClass("dragOver")}),d.bind("drop",function(a){a.preventDefault&&a.preventDefault(),a.stopPropogation&&a.stopPropogation();var b=a.originalEvent.dataTransfer.getData("text"),d=document.getElementById(e),f=document.getElementById(b);angular.element(a.target).removeClass("dragTarget"),angular.element(a.target).removeClass("dragOver"),c.drop(f,d)}),a.$on("dragStart",function(){var a=document.getElementById(e);angular.element(a).addClass("dragTarget")}),a.$on("dragEnd",function(){var a=document.getElementById(e);angular.element(a).removeClass("dragTarget"),angular.element(a).removeClass("dragOver")})}}}]),angular.module("emuwebApp").service("Espsparserservice",["Soundhandlerservice",function(a){var b={};return b.toJSO=function(b,c){var d="_"+c.split(".")[c.split(".").length-1];b=b.replace(/([ \t]*\r?\n)+/g,"\n"),b=b.replace(/[ \t]+/g," ");for(var e,f=b.split("\n"),g=0;g<f.length;g++)if("#"===f[g]){e=g;break}var h={fileInfos:[{fileURI:c,fileType:"esps",associatedLevelNames:[d]}],levels:[]};h.levels.push({LevelName:d,type:"",items:[]});var i,j=f[e+1].split(/\s+/);if(h.levels[0].type="H#"!==j[j.length-1]?"point":"seg","point"===h.levels[0].type)for(g=e+1;g<f.length-1;g++)j=f[g].split(/\s+/),h.levels[0].items.push({label:j[j.length-1],sampleStart:Math.round(j[1]*a.wavJSO.SampleRate)});else for(j=f[e+1].split(/\s+/),h.levels[0].items.push({label:"",sampleStart:0,sampleDur:Math.round(j[1]*a.wavJSO.SampleRate)}),g=e+2;g<f.length-1;g++)j=f[g].split(/\s+/),i=f[g-1].split(/\s+/),h.levels[0].items.push({label:j[j.length-1],sampleStart:Math.round(i[1]*a.wavJSO.SampleRate),sampleDur:Math.round((j[1]-i[1])*a.wavJSO.SampleRate)});return h},b.toESPS=function(b){var c=b.LevelName.substring(1),d="";d+="signal "+c+"\n",d+="nfields 1\n",d+="#\n";var e;return b.items.forEach(function(b,c){e=""===b.label&&0===c?"H#":b.label,d+="	"+String((b.sampleStart+b.sampleDur)/a.wavJSO.SampleRate)+"	125	"+e+"\n"}),d},b}]),angular.module("emuwebApp").controller("LoginCtrl",["$scope","$rootScope","$http","ConfigProviderService","Iohandlerservice","viewState","dialogService",function(a,b,c,d,e,f,g){a.loginData={username:"",accesscode:"",errorMsg:""},a.tryLogin=function(){e.wsH.checkAccessCode(a.loginData.accesscode).then(function(c){"CORRECT"===c?(console.log("u are the champion"),e.wsH.getUsrUttList(a.loginData.username).then(function(c){"USER NOT FOUND"===c?a.loginData.errorMsg=c:(a.loginData.errorMsg="USER FOUND",b.$broadcast("newUserLoggedOn",a.loginData.username),a.cancel())})):a.loginData.errorMsg="Error wrong access code!!"})},a.cursorInTextField=function(){f.focusInTextField=!0},a.cursorOutOfTextField=function(){f.focusInTextField=!1},a.cancel=function(){g.close()}}]),angular.module("emuwebApp").service("Ssffdataservice",function(){var a={};return a.data=[],a.getColumnOfTrack=function(b,c){var d;return a.data.forEach(function(a){a.ssffTrackName===b&&a.Columns.forEach(function(a){a.name===c&&(d=a)})}),void 0!==d?d:void alert("could not getColumnOfTrack of trackname: "+b)},a.getSampleRateAndStartTimeOfTrack=function(b){var c={};return a.data.forEach(function(a){a.ssffTrackName===b&&(c.sampleRate=a.sampleRate,c.startTime=a.startTime)}),void 0!==c?c:void alert("could not getSampleRateAndStartTimeOfTrack of trackname: "+b)},a}),angular.module("emuwebApp").service("Levelservice",["uuid","Soundhandlerservice",function(a,b){var c={};return c.data={},c.maxElementID=0,c.getData=function(){return c.data},c.setData=function(a){angular.copy(a,c.data),angular.forEach(c.data.levels,function(a){a.items.forEach(function(a){c.maxElementID=a.id})})},c.getLevelDetails=function(a){var b=null,d=null;return angular.forEach(c.data.levels,function(c,e){c.name===a&&(b=c,d=e)}),{level:b,id:d}},c.getOrderById=function(a,b){var d=null;return angular.forEach(c.data.levels,function(c){c.name===a&&c.items.forEach(function(a,c){a.id==b&&(d=c)})}),d},c.getIdByOrder=function(a,b){var d=null;return angular.forEach(c.data.levels,function(c){c.name===a&&c.items.forEach(function(a,c){c==b&&(details=a.id)})}),d},c.getElementDetails=function(a,b){var d=null;return angular.forEach(c.data.levels,function(c){c.name===a&&c.items.forEach(function(a,c){c==b&&(d=a)})}),d},c.getLastElement=function(a){var b=null;
return angular.forEach(c.data.levels,function(c){c.name===a&&(b=c.items[c.items.length-1])}),b},c.getElementDetailsById=function(a,b){return c.getElementDetails(a,c.getOrderById(a,b))},c.insertElementDetails=function(a,b,d,e,f){var g=++c.maxElementID;angular.forEach(c.data.levels,function(c){if(c.name===a){var h=angular.copy(c.items[0]);"SEGMENT"==c.type?(h.id=g,h.sampleStart=e,h.sampleDur=f,h.labels[0].value=d,c.items.splice(b,0,h)):"EVENT"==c.type&&(h.id=g,h.samplePoint=e,h.labels[0].value=d,c.items.splice(b,0,h))}})},c.setElementDetails=function(a,b,d,e,f){angular.forEach(c.data.levels,function(c){c.name===a&&c.items.forEach(function(a){a.id==b&&(void 0!==e&&(a.sampleStart=e),void 0!==f&&(a.sampleDur=f),void 0!==d&&(a.labels[0].value=d))})})},c.setPointDetails=function(a,b,d,e){angular.forEach(c.data.levels,function(c){c.name===a&&c.items.forEach(function(a){a.id==b&&(a.samplePoint=e,a.labels[0].value=d)})})},c.getElementNeighbourDetails=function(a,b,d){var e=null,f=null;return angular.forEach(c.data.levels,function(c){c.name===a&&c.items.forEach(function(a,g){a.id==b&&(e=c.items[g-1]),a.id==d&&(f=c.items[g+1])})}),{left:e,right:f}},c.getEvent=function(a,b,c){var d=b.items[0],e=!1;if("SEGMENT"===b.type)angular.forEach(b.items,function(c,f){a>=c.sampleStart&&a<=c.sampleStart+c.sampleDur&&(a-c.sampleStart>=c.sampleDur/2?void 0!==b.items[f+1]?e=b.items[f+1]:(e=!0,d=b.items[b.items.length-1]):e=b.items[f]),a>=c.sampleStart&&(a<=c.sampleStart+c.sampleDur?d=c:(e=!0,d=b.items[b.items.length-1]))});else{var f=0,g=0;angular.forEach(b.items,function(h,i){g=i<b.items.length-1?h.samplePoint+(b.items[i+1].samplePoint-b.items[i].samplePoint)/2:c,f=i>0?h.samplePoint-(b.items[i].samplePoint-b.items[i-1].samplePoint)/2:0,g>=a&&a>=f&&(d=h,e=h)})}return{evtr:d,nearest:e}},c.deleteLevel=function(a){var b,d=0;return angular.forEach(c.data.levels,function(e,f){e.name===a&&(b=e,d=f,c.data.levels.splice(f,1))}),{level:b,id:d,name:a}},c.renameLabel=function(a,b,d){c.setElementDetails(a,b,d)},c.renameLevel=function(a,b){angular.forEach(c.data.levels,function(c){c.name===a&&(c.name=b)})},c.deleteSegmentsInvers=function(a,b,d){var e=0,f=0;for(var g in b)e+=b[g].sampleDur;e%2==0?(e/=2,f=e):(e=Math.ceil(e/2),f=e-1),c.setElementDetails(a,d.left.id,d.left.labels[0].value,d.left.sampleStart,d.left.sampleDur-e),c.setElementDetails(a,d.right.id,d.right.labels[0].value,d.right.sampleStart+f,d.right.sampleDur-f);var h=0;angular.forEach(c.data.levels,function(c){if(c.name===a&&"SEGMENT"===c.type){angular.forEach(c.items,function(a,b){a.id==d.left.id&&(h=b+1)});for(g in b)c.items.splice(h++,0,b[g])}})},c.deleteSegments=function(a,b,d){var e=0,f=0,g=0;for(var h in b)g+=b[h].sampleDur;e%2==0?(e=g/2,f=e):(e=Math.ceil(g/2),f=e-1),angular.forEach(c.data.levels,function(c){c.name===a&&angular.forEach(c.items,function(a,d){a.id==b[0].id&&c.items.splice(d,b.length)})}),void 0!==d.left&&c.setElementDetails(a,d.left.id,d.left.labels[0].value,d.left.sampleStart,d.left.sampleDur+e),void 0!==d.right&&c.setElementDetails(a,d.right.id,d.right.labels[0].value,d.right.sampleStart-f,d.right.sampleDur+f)},c.insertSegmentInvers=function(a,b,d){var e=!0;return angular.forEach(c.data.levels,function(c){if(c.name===d)if(a==b){var f=-1;if(angular.forEach(c.items,function(b,c){a==b.sampleStart&&(f=c,e=!0)}),e){var g=c.items[f].sampleDur;c.items[f-1].sampleDur+=g,c.items.splice(f,1)}}else{var f=-1;if(angular.forEach(c.items,function(b,c){a==b.sampleStart&&(f=c,e=!0)}),e){var g=c.items[f].sampleDur,h=c.items[f+1].sampleDur;c.items[f-1].sampleDur+=g+h,c.items.splice(f,2)}}}),e},c.insertSegment=function(a,b,d,e){var f=!0;return angular.forEach(c.data.levels,function(g){if(g.name===d)if(a==b){var h=-1;if(a<g.items[0].sampleStart){var i=g.items[0].sampleStart-a;c.insertElementDetails(d,0,e,a,i)}else if(a>g.items[g.items.length-1].sampleStart+g.items[g.items.length-1].sampleDur){var j=g.items[g.items.length-1].sampleStart+g.items[g.items.length-1].sampleDur+1;c.insertElementDetails(d,g.items.length,e,j,a-j)}else if(angular.forEach(g.items,function(b,c){a>=b.sampleStart&&a<=b.sampleStart+b.sampleDur&&(h=c),b.sampleStart==a&&(f=!1),b.sampleStart+b.sampleDur==a&&(f=!1)}),f){var i=a-g.items[h].sampleStart;c.insertElementDetails(d,h+1,e,a,g.items[h].sampleDur-i),g.items[h].sampleDur=i}}else if(b<g.items[0].sampleStart){var i=g.items[0].sampleStart-b,k=b-a;c.insertElementDetails(d,0,e,b,i),c.insertElementDetails(d,0,e,a,k)}else if(a>g.items[g.items.length-1].sampleStart+g.items[g.items.length-1].sampleDur){var i=a-(g.items[g.items.length-1].sampleStart+g.items[g.items.length-1].sampleDur),k=b-a,l=g.items.length;c.insertElementDetails(d,l,e,g.items[g.items.length-1].sampleStart+g.items[g.items.length-1].sampleDur,i),c.insertElementDetails(d,l+1,e,a,k)}else{var h=-1,m=-1;if(angular.forEach(g.items,function(c,d){a>=c.sampleStart&&a<=c.sampleStart+c.sampleDur&&(h=d),b>=c.sampleStart&&b<=c.sampleStart+c.sampleDur&&(m=d)}),f=h===m,h===m){var i=a-g.items[h].sampleStart,k=b-a;c.insertElementDetails(d,h+1,e,a,k),c.insertElementDetails(d,h+2,e,b,g.items[h].sampleDur-i-k),g.items[h].sampleDur=i}}}),f},c.insertPoint=function(a,b,d){var e=!1;return angular.forEach(c.data.levels,function(f){if(f.name===b&&"EVENT"==f.type){var g=f.items[0].samplePoint;angular.forEach(f.items,function(f,h){e||(g>a&&Math.floor(a)!=Math.floor(f.samplePoint)&&(c.insertElementDetails(b,h-1,d,a),e=!0),g=f.samplePoint)})}}),e},c.insertPointInvers=function(a,b){var d=!1;return angular.forEach(c.data.levels,function(c){if(c.name===b&&"EVENT"==c.type){angular.forEach(c.items,function(b,e){d||a==b.samplePoint&&(c.items.splice(e,1),d=!0)})}}),d},c.deleteBoundary=function(a,b){var d=null;angular.forEach(c.data.levels,function(c){c.name===b&&angular.forEach(c.items,function(b,e){"SEGMENT"===c.type?a.sampleStart==b.sampleStart&&a.sampleDur==b.sampleDur&&(d.labels[0].value+=b.labels[0].value,d.sampleDur+=b.sampleDur,c.items.splice(e,1)):b.samplePoint==a.samplePoint&&c.items.splice(e,1),d=b})})},c.snapBoundary=function(a,b,d,e){var f,g,h,i,j=1/0;return angular.forEach(c.data.levels,function(e,k){if(e.name===d){if(g=e,a){if(!(k>=1))return!1;f=c.data.levels[k-1]}else{if(!(k<c.data.levels.length-1))return!1;f=c.data.levels[k+1]}f.items.forEach(function(a){h=Math.abs(b-a.sampleStart),j>h&&(j=h,i=a.sampleStart-b)})}}),void 0!==i?(this.moveBoundry(i,g,e),i):!1},c.moveBoundry=function(a,d,e,f){if(e===!1)e=c.getElementDetails(d,0),c.setElementDetails(d,e.id,e.labels[0].value,e.sampleStart+a,e.sampleDur-a);else if(e===!0)e=c.getLastElement(d),e.sampleDur+a>=1&&e.sampleDur+e.sampleStart+a<=b.wavJSO.Data.length&&c.setElementDetails(d,e.id,e.labels[0].value,e.sampleStart,e.sampleDur+a);else{var g=c.getElementDetailsById(d,e.id);if(void 0!==f.left){var h=c.getElementDetailsById(d,f.left.id);f.left.sampleDur+a>0&&e.sampleStart+a>0&&e.sampleDur-a>0&&(c.setElementDetails(d,f.left.id,h.labels[0].value,h.sampleStart,h.sampleDur+a),c.setElementDetails(d,e.id,g.labels[0].value,g.sampleStart+a,g.sampleDur-a))}else e.sampleStart+a>0&&e.sampleDur-a>0&&c.setElementDetails(d,e.id,g.labels[0].value,g.sampleStart+a,g.sampleDur-a)}},c.movePoint=function(a,b,d){c.setPointDetails(b,d.id,d.labels[0].value,d.samplePoint+a)},c.moveSegment=function(a,d,e,f){void 0===f.left?e[0].sampleStart+a>=1&&f.right.sampleDur-a>=1&&(c.setElementDetails(d,f.right.id,f.right.labels[0].value,f.right.sampleStart+a,f.right.sampleDur-a),angular.forEach(e,function(b){c.setElementDetails(d,b.id,b.labels[0].value,b.sampleStart+a,b.sampleDur)})):void 0===f.right?f.left.sampleDur+a>=1&&e[e.length-1].sampleStart+e[e.length-1].sampleDur+a<b.wavJSO.Data.length&&(c.setElementDetails(d,f.left.id,f.left.labels[0].value,f.left.sampleStart,f.left.sampleDur+a),angular.forEach(e,function(b){c.getElementDetails(d,b.id);c.setElementDetails(d,b.id,b.labels[0].value,b.sampleStart+a,b.sampleDur)})):f.left.sampleDur+a>0&&f.right.sampleDur-a>0&&(c.setElementDetails(d,f.left.id,f.left.labels[0].value,f.left.sampleStart,f.left.sampleDur+a),c.setElementDetails(d,f.right.id,f.right.labels[0].value,f.right.sampleStart+a,f.right.sampleDur-a),angular.forEach(e,function(b){c.setElementDetails(d,b.id,b.labels[0].value,b.sampleStart+a,b.sampleDur)}))},c.expandSegment=function(a,d,e,f){var g=0,h=c.getElementNeighbourDetails(e,d[0].id,d[d.length-1].id);if(a)if(void 0===h.right){var i=d[d.length-1].sampleStart+d[d.length-1].sampleDur+f*d.length;i<b.wavJSO.Data.length&&angular.forEach(d,function(a){c.setElementDetails(e,a.id,a.labels[0].value,a.sampleStart+g,a.sampleDur+f),g+=f})}else h.right.sampleDur-f*d.length>0&&(angular.forEach(d,function(a){c.setElementDetails(e,a.id,a.labels[0].value,a.sampleStart+g,a.sampleDur+f),g+=f}),c.setElementDetails(e,h.right.id,h.right.labels[0].value,h.right.sampleStart+g,h.right.sampleDur-g));else if(void 0===h.left){var j=c.getElementDetails(e,0);j.sampleStart+f*(d.length+1)>0&&angular.forEach(d,function(a){c.setElementDetails(e,a.id,a.labels[0].value,a.sampleStart-f,a.sampleDur+f)})}else h.left.sampleDur-f*d.length>0&&(g=0,angular.forEach(d,function(a,b){g=-(d.length-b)*f,c.setElementDetails(e,a.id,a.labels[0].value,a.sampleStart+g,a.sampleDur+f)}),c.setElementDetails(e,h.left.id,h.left.labels[0].value,h.left.sampleStart,h.left.sampleDur-d.length*f))},c}]),angular.module("emuwebApp").service("Websockethandler",["$q","$rootScope","$location","$timeout","HistoryService","Ssffparserservice","Levelservice","ConfigProviderService","viewState","Wavparserservice","Soundhandlerservice","Espsparserservice","uuid","Binarydatamaniphelper","Ssffdataservice","dialogService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){function q(a){B=!0,b.$apply(A.resolve(a))}function r(a){v(angular.fromJson(a.data))}function s(a){console.error("WEBSOCKET ERROR!!!!!"),b.$apply(A.resolve(a))}function t(){B=!1,console.log("WEBSOCKET closed!!!!!")}function u(b){var c=a.defer(),e=w();return y[e]={time:new Date,cb:c},b.callbackID=e,z.send(angular.toJson(b)),d(function(){var a={callbackID:e,status:{type:"ERROR:TIMEOUT",message:"Sent request of type: "+b.type+" timed out after "+h.vals.main.wsTimeoutInterval+"ms!  Please check the server..."}};v(a)},h.vals.main.wsTimeoutInterval),c.promise}function v(a){var c=a;if(y.hasOwnProperty(c.callbackID)){switch(c.type){case"getESPSfile":handleReceivedESPS(c.fileName,c.data);break;case"getSSFFfile":alert("esps"),handleReceivedSSFF(c.fileName,c.data)}"SUCCESS"===c.status.type?b.$apply(y[c.callbackID].cb.resolve(c.data)):p.open("views/error.html","ModalCtrl","Communication error with server! Error message is: "+c.status.message),delete y[c.callbackID]}else"ERROR:TIMEOUT"===c.status.type||p.open("views/error.html","ModalCtrl","What just happened? You should not be here...")}function w(){var a=m.new();return a}var x={},y={},z={},A={},B=!1;return x.initConnect=function(b){var c=a.defer();return z=new WebSocket(b),z.onopen=q,z.onmessage=r,z.onerror=s,z.onclose=t,A=c,c.promise},x.isConnected=function(){return B},x.closeConnect=function(){z.onclose=function(){},z.close()},x.getProtocol=function(){var a={type:"GETPROTOCOL"},b=u(a);return b},x.getDoUserManagement=function(){var a={type:"GETDOUSERMANAGEMENT"},b=u(a);return b},x.getDBconfigFile=function(){var a={type:"GETGLOBALDBCONFIG"},b=u(a);return b},x.getBundleList=function(){var a={type:"GETBUNDLELIST"},b=u(a);return b},x.getBundle=function(a){var b={type:"GETBUNDLE",name:a},c=u(b);return c},x.saveBundle=function(a){var b={type:"SAVEBUNDLE",data:a},c=u(b);return c},x}]),angular.module("emuwebApp").controller("WsconnectionCtrl",["$scope","ConfigProviderService","Iohandlerservice","viewState","dialogService",function(a,b,c,d,e){a.wsServerUrl=b.vals.main.wsServerUrl,a.connectionError="",d.focusInTextField=!0,a.tryConnection=function(){e.close(a.wsServerUrl)},a.cancel=function(){e.close(!1)}}]),angular.module("emuwebApp").service("Httphandler",["$rootScope","$http","$q","HistoryService","viewState","ConfigProviderService","Soundhandlerservice","Ssffparserservice","Wavparserservice","Espsparserservice",function(a,b,c,d,e,f,g,h,i,j){var k={};return k.findFileInUtt=function(a,b){var c;return a.files.forEach(function(a){-1!==a.indexOf(b,a.length-a.length)&&(c=a)}),c},k.getUttList=function(a){var c=b.get(a);return c},k.getSSFFfile=function(c){b.get(c,{responseType:"arraybuffer"}).success(function(b){var d=h.ssff2jso(b);d.fileURL=document.URL+c,a.$broadcast("newlyLoadedSSFFfile",d,c.replace(/^.*[\\\/]/,""))})},k.getESPS=function(c){b.get(c).success(function(b){var d=j.toJSO(b,c);a.$broadcast("newlyLoadedLabelJson",d)}).error(function(a,b){console.log("Request failed with status: "+b)})},k.getUtt=function(h){var j,l,m=[],n=c.defer();return l=k.findFileInUtt(h,f.vals.signalsCanvasConfig.extensions.audio),b.get(l,{responseType:"arraybuffer"}).then(function(a){var b=i.wav2jso(a.data);return b}).then(function(b){e.curViewPort.sS=0,e.curViewPort.eS=b.Data.length,e.curViewPort.bufferLength=b.Data.length,e.setscrollOpen(0),e.resetSelect(),g.wavJSO=b,a.$broadcast("cleanPreview")}).then(function(){f.vals.signalsCanvasConfig.extensions.signals.forEach(function(a){l=k.findFileInUtt(h,a),j=k.getSSFFfile(l),m.push(j)})}).then(function(){f.vals.labelCanvasConfig.order.forEach(function(a){l=k.findFileInUtt(h,a),console.log(l),j=k.getESPS(l),m.push(j)})}),c.all(m).then(function(){console.log("history"),d.history(),n.resolve("finishedLoadingUtt")}),n.promise},k}]),angular.module("emuwebApp").service("Binarydatamaniphelper",function(){var a={};return a.base64ToArrayBuffer=function(a){for(var b=window.atob(a),c=b.length,d=new Uint8Array(c),e=0;c>e;e++){var f=b.charCodeAt(e);d[e]=f}return d.buffer},a.arrayBufferToBase64=function(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;d>e;e++)b+=String.fromCharCode(c[e]);return window.btoa(b)},a.stringToArrayBuffer=function(a){for(var b=new ArrayBuffer(a.length),c=new Uint8Array(b),d=0;d<a.length;++d)c[d]=a.charCodeAt(d);return b},a}),angular.module("emuwebApp").service("dialogService",["$modal","viewState",function(a,b){var c={},d={};return c.open=function(c,e,f){return b.setState("modalShowing"),d=a.open({backdrop:"static",keyboard:!1,templateUrl:c,controller:e,resolve:{passedInTxt:function(){return f}}}),d.result},c.openExport=function(c,e,f,g){return b.setState("modalShowing"),d=a.open({backdrop:"static",keyboard:!1,templateUrl:c,controller:e,resolve:{exportData:function(){return f},exportName:function(){return g}}}),d.result},c.close=function(a){b.focusInTextField=!1,b.setState(b.prevState),d.close(a)},c}]),angular.module("emuwebApp").controller("WaitCtrl",["$scope","viewState",function(a,b){a.vs=b}]),angular.module("emuwebApp").service("Appcachehandler",["$http","dialogService",function(){var a={};return a}]),angular.module("emuwebApp").controller("AboutCtrl",["$scope","ConfigProviderService","dialogService",function(a,b,c){a.cps=b,a.getStrRep=function(a){var b;switch(a){case 8:b="BACKSPACE";break;case 9:b="TAB";break;case 13:b="ENTER";break;case 16:b="SHIFT";break;case 18:b="ALT";break;case 32:b="SPACE";break;case 38:b="";break;case 40:b="";break;case 187:b="+";break;case 189:b="-";break;default:b=String.fromCharCode(a)}return b},a.cancel=function(){c.close()}}]),angular.module("emuwebApp").controller("SpectsettingsCtrl",["$scope","dialogService","viewState",function(a,b,c){a.vs=c,a.options=Object.keys(a.vs.getWindowFunctions()),a.selWindowInfo={},a.selWindowInfo.name=Object.keys(a.vs.getWindowFunctions())[a.vs.spectroSettings.window-1],console.log(Object.keys(a.vs.getWindowFunctions())[a.vs.spectroSettings.window-1]),a.modalVals={rangeFrom:a.vs.spectroSettings.rangeFrom,rangeTo:a.vs.spectroSettings.rangeTo,dynamicRange:a.vs.spectroSettings.dynamicRange,windowLength:a.vs.spectroSettings.windowLength,window:a.vs.spectroSettings.window},a.cursorInTextField=function(){c.focusInTextField=!0},a.cursorOutOfTextField=function(){c.focusInTextField=!1},a.saveSpectroSettings=function(){console.log(a.modalVals),console.log(a.selWindowInfo.name),c.setspectroSettings(a.modalVals.windowLength,a.modalVals.rangeFrom,a.modalVals.rangeTo,a.modalVals.dynamicRange,a.selWindowInfo.name),a.cancel()},a.cancel=function(){b.close()}}]),angular.module("emuwebApp").controller("ConfirmmodalCtrl",["$scope","dialogService","passedInTxt",function(a,b,c){a.passedInTxt=c,a.confirm=function(){b.close(!0)},a.cancel=function(){b.close(!1)}}]),angular.module("emuwebApp").filter("regex",function(){return function(a,b){for(var c=new RegExp(b.toLowerCase()),d=[],e=0;e<a.length;e++)c.test(a[e].name.toLowerCase())&&d.push(a[e]);return d}}),angular.module("emuwebApp").filter("levelsFilter",["ConfigProviderService","viewState",function(a,b){return function(c){if(c){for(var d,e=new RegExp("SEGMENT"),f=new RegExp("EVENT"),g=[],h=0;h<c.length;h++)(e.test(c[h].type)||f.test(c[h].type))&&void 0!==a.vals.perspectives[b.curPerspectiveIdx].levelCanvases&&(d=a.vals.perspectives[b.curPerspectiveIdx].levelCanvases.order.indexOf(c[h].name),-1!==d&&(g[d]=c[h]));return g}}}]),angular.module("emuwebApp").controller("ModalCtrl",["$scope","dialogService","passedInTxt","viewState","Levelservice","HistoryService",function(a,b,c,d,e,f){a.passedInTxt=c,a.passedOutTxt={"var":null},a.cancel=function(){b.close()},a.cursorInTextField=function(){d.focusInTextField=!0},a.cursorOutOfTextField=function(){d.focusInTextField=!1},a.renameLevel=function(){e.renameLevel(a.passedInTxt,a.passedOutTxt.var),f.addObjToUndoStack({type:"ESPS",action:"renameLevel",levelName:a.passedOutTxt.var,oldName:a.passedInTxt}),b.close()},a.saveChanges=function(){b.close("saveChanges")},a.discardChanges=function(){b.close("discardChanges")},a.deleteLevel=function(){var a;a=e.deleteLevel(d.getcurClickLevelName()),f.addObjToUndoStack({type:"ESPS",action:"deleteLevel",levelName:a.name,itemIdx:a.id,level:a.level}),b.close()}}]),angular.module("emuwebApp").directive("showMenu",["$animate",function(a){return{restrict:"A",link:function(b,c,d){b.$watch(d.showMenu,function(b){b?a.addClass(c,"expandWidthTo200px"):(a.removeClass(c,"expandWidthTo200px"),a.addClass(c,"shrinkWidthTo0px"))})}}}]),angular.module("emuwebApp").animation(".slideInMenu",function(){return{addClass:function(a){a.addClass("slideLeft")},removeClass:function(a){a.removeClass("slideLeft")}}}),angular.module("emuwebApp").directive("showTwod",["$animate",function(a){return{restrict:"A",link:function(b,c,d){b.$watch(d.showTwod,function(b){b?a.addClass(c,".slideIn2dCanvases"):a.removeClass(c,".slideIn2dCanvases")})}}}]),angular.module("emuwebApp").animation(".slideIn2dCanvases",function(){return{addClass:function(a){a.addClass("slide2dCanvases")},removeClass:function(a){a.removeClass("slide2dCanvases")}}}),angular.module("emuwebApp").directive("horizSplitter",function(){return{template:'<div class="horizSplitter"></div>',restrict:"E",replace:!0,link:function(a,b,c,d){var e=0,f=0,g=!1;b.on("mousedown",function(a){a.preventDefault(),console.log(e),g=!0}),b.on("mouseup",function(){g=!1}),b.on("mousemove",function(a){g&&(console.log("###############"),console.log(a),console.log(a.clientY),console.log(a.pageY),f=a.pageY-e,b.css({top:a.pageY-44+"px"}))})}}}),angular.module("emuwebApp").directive("bgSplitter",["$rootScope","viewState",function(a,b){return{restrict:"E",replace:!0,transclude:!0,scope:{showTwoDimCans:"@"},template:'<div class="split-panes vertical" ng-transclude></div>',controller:["$scope",function(a){a.panes=[],a.bottomRightResizePane,this.addPane=function(b){if(a.panes.length>1)throw"splitters can only have two panes";return a.panes.push(b),a.panes.length},this.setBottomRightResizePane=function(b){a.bottomRightResizePane=b}}],link:function(c,d,e){var f=!1,g=!1,h=!1,i=angular.element('<div class="split-handler"><span></span></div>'),j=c.panes[0],k=c.panes[1],l=c.bottomRightResizePane,m=angular.element('<div class="bottomRightResizePaneTopResizer"></div>'),n=angular.element('<div class="bottomRightResizePaneLeftResizer"></div>'),o=angular.element('<div class="bottomRightResizePaneCornerResizer"></div>');l.elem.prepend(n),l.elem.prepend(m),l.elem.prepend(o);var p=j.minSize||0,q=k.minSize||0,r=!1,s=!1;j.elem.after(i),e.$observe("showTwoDimCans",function(a){"false"===a?c.bottomRightResizePane.elem.hide():c.bottomRightResizePane.elem.show()}),d.bind("mousemove",function(a){if(s){var c=d[0].getBoundingClientRect(),e=0;if(r){var m=c.bottom-c.top;if(e=a.clientY-c.top,p>e)return;if(q>m-e)return;i.css("top",e+"px"),j.elem.css("height",e+"px"),k.elem.css("top",e+"px"),b.setdragBarHeight(e)}if(f){var m=c.bottom-c.top;if(e=a.clientY-c.top,10>=e||10>=m-e)return;l.elem.css("top",e+"px");var n=m-e;l.elem.css("height",n+"px")}if(g){var o=c.right-c.left;if(e=a.clientX-c.left,10>=e||10>=o-e)return;l.elem.css("left",e+"px");var n=o-e;l.elem.css("width",n+"px")}if(h){var m=c.bottom-c.top;if(e=a.clientY-c.top,10>=e||10>=m-e)return;l.elem.css("top",e+"px");var n=m-e;l.elem.css("height",n+"px");var o=c.right-c.left;if(e=a.clientX-c.left,10>=e||10>=o-e)return;l.elem.css("left",e+"px");var n=o-e;l.elem.css("width",n+"px")}}}),i.bind("mousedown",function(c){c.preventDefault(),s=!0,r=!0,b.setdragBarActive(!0),a.$digest()}),m.bind("mousedown",function(c){c.preventDefault(),s=!0,f=!0,b.setdragBarActive(!0),a.$digest()}),n.bind("mousedown",function(c){c.preventDefault(),s=!0,g=!0,b.setdragBarActive(!0),a.$digest()}),o.bind("mousedown",function(c){c.preventDefault(),s=!0,h=!0,b.setdragBarActive(!0),a.$digest()}),angular.element(document).bind("mouseup",function(){s=!1,r=!1,f=!1,g=!1,h=!1,b.setdragBarActive(!1),a.$digest()})}}}]).directive("bgPane",function(){return{restrict:"E",require:"^bgSplitter",replace:!0,transclude:!0,scope:{minSize:"=",type:"@",showTwoDimCans:"@"},template:'<div class="{{typeclass}}" ng-transclude></div>',link:function(a,b,c,d){"bottomRightResizePane"!==a.type?(a.elem=b,a.index=d.addPane(a),a.typeclass="split-pane"+a.index):(a.elem=b,a.index=3,a.typeclass="bottomRightResizePane",d.setBottomRightResizePane(a))}}}),angular.module("emuwebApp").directive("ssffTrack",["ConfigProviderService","viewState",function(a,b){return{templateUrl:"views/ssffTrack.html",restrict:"E",link:function(c,d,e){function f(){if(!$.isEmptyObject(c.ssffds.data)&&0!==c.ssffds.data.length){j.clearRect(0,0,j.canvas.width,j.canvas.height),c.dhs.drawMovingBoundaryLine(j),c.dhs.drawCurViewPortSelected(j,!1);var a=c.cps.getSsffTrackConfig(g),b=c.ssffds.getColumnOfTrack(a.name,a.columnName);c.dhs.drawMinMaxAndName(j,g,b._minVal,b._maxVal,2)}}var g,h=d.find("canvas").length,i=(d.find("canvas")[1],d.find("canvas")[h-1]),j=i.getContext("2d");e.$observe("trackName",function(a){a&&(g=a)}),c.order=e.order,c.enlargeCanvas={height:100/a.vals.perspectives[b.curPerspectiveIdx].signalCanvases.order.length+"%"},c.$watch("vs.curPerspectiveIdx",function(){c.updateCSS()},!0),c.redraw=function(){f(!0),c.updateCSS()},c.$watch("vs.curViewPort",function(){$.isEmptyObject(c.shs)||$.isEmptyObject(c.shs.wavJSO)||(f(!0),c.updateCSS())},!0),c.$watch("ssffds.data.length",function(){$.isEmptyObject(c.shs)||$.isEmptyObject(c.shs.wavJSO)||(f(!0),c.updateCSS())},!0),c.updateCSS=function(){var d=a.vals.perspectives[b.curPerspectiveIdx].signalCanvases.order.length;c.enlargeCanvas=-1===b.getenlarge()?{height:100/d+"%"}:b.getenlarge()===c.order?{height:300/(d+2)+"%"}:{height:100/(d+2)+"%"}}}}}]),angular.module("emuwebApp").directive("progressThing",["$animate",function(a){return{template:"<div class=progressThing>{{vs.somethingInProgressTxt}}</div>",restrict:"E",replace:!0,link:function(b,c,d){d.$observe("showThing",function(b){"true"===b?(a.removeClass(c,"shrinkHeightTo0px"),a.addClass(c,"expandHeightTo20px")):(a.removeClass(c,"expandHeightTo20px"),a.addClass(c,"shrinkHeightTo0px"))})}}}]),angular.module("emuwebApp").directive("epg",["viewState",function(){return{template:'<div class="twoDimCanvasContainer"><canvas width="256" height="256"></canvas></div>',restrict:"E",replace:!0,link:function(a,b){function c(a){d=a.cps.getSsffTrackConfig("EPG"),e=a.ssffds.getColumnOfTrack(d.name,d.columnName),f=a.ssffds.getSampleRateAndStartTimeOfTrack(d.name);var b=g.getContext("2d");b.clearRect(0,0,g.width,g.height),b.fillStyle="green",b.strokeStyle=a.cps.vals.colors.osciColor,b.font=a.cps.vals.font.fontPxSize+"px "+a.cps.vals.font.fontType;var c,h=g.width/8,i=g.height/8,j=1/f.sampleRate-f.startTime,k=Math.round(a.vs.curMousePosSample/a.shs.wavJSO.SampleRate/j);e.values[k].forEach(function(a,d){for(c=a.toString(2).split("").reverse();c.length<8;)c.push("0");c.forEach(function(a,c){"1"===a?(b.fillStyle="grey",b.fillRect(c*h+5,i*d+5,h-10,i-10)):(b.fillStyle="white",b.fillRect(c*h+5,i*d+5,h-10,i-10))})});var l=a.fontImage.getTextImageTwoLines(b,"EPG","Frame:"+k,a.cps.vals.font.fontPxSize,a.cps.vals.font.fontType,a.cps.vals.colors.labelColor,!0);b.drawImage(l,0,0,l.width,l.height,5,0,l.width,l.height)}var d,e,f,g=b.find("canvas")[0];a.$watch("vs.curViewPort",function(){$.isEmptyObject(a.cps.vals)||$.isEmptyObject(a.ssffds.data)||0!==a.ssffds.data.length&&c(a)},!0),a.$watch("vs.curMousePosSample",function(){$.isEmptyObject(a.cps.vals)||$.isEmptyObject(a.ssffds.data)||0!==a.ssffds.data.length&&c(a)},!0)}}}]),angular.module("emuwebApp").directive("dots",["viewState",function(){return{template:'<div class="twoDimCanvasContainer"><canvas width="512" height="512"></canvas></div>',restrict:"E",replace:!0,link:function(a,b){function c(){for(var b=a.cps.vals.perspectives[a.vs.curPerspectiveIdx].twoDimCanvases.twoDimDrawingDefinitions[0],c=0;c<b.dots.length;c++){var d=a.cps.getSsffTrackConfig(b.dots[c].xSsffTrack),e=a.ssffds.getColumnOfTrack(d.name,d.columnName);e._minVal<f&&(f=e._minVal),e._maxVal>g&&(g=e._maxVal),d=a.cps.getSsffTrackConfig(b.dots[c].ySsffTrack);var j=a.ssffds.getColumnOfTrack(d.name,d.columnName);j._minVal<h&&(h=j._minVal),j._maxVal>i&&(i=j._maxVal)}}function d(){1/0===f&&c();var b=e.getContext("2d");b.clearRect(0,0,e.width,e.height);var d=b.canvas.width/b.canvas.offsetWidth,j=b.canvas.height/b.canvas.offsetHeight;b.beginPath(),b.moveTo(0,0),b.lineTo(5,5),b.moveTo(0,e.height),b.lineTo(5,e.height-5),b.moveTo(e.width,e.height),b.lineTo(e.width-5,e.height-5),b.stroke(),b.closePath();var k=3*a.cps.vals.font.fontPxSize/4,l=a.fontImage.getTextImage(b,"yMax: "+a.vs.round(i,2),k,a.cps.vals.font.fontType,a.cps.vals.colors.endBoundaryColor);b.drawImage(l,5,5,l.width,l.height),l=a.fontImage.getTextImageTwoLines(b,"yMin: "+a.vs.round(h,2),"xMin: "+a.vs.round(f,2),k,a.cps.vals.font.fontType,a.cps.vals.colors.endBoundaryColor,!0),b.drawImage(l,5,e.height-k*j*2-5,l.width,l.height);var m=b.measureText("xMax: "+a.vs.round(g,5)).width*d;l=a.fontImage.getTextImage(b,"xMax: "+a.vs.round(g,2),k,a.cps.vals.font.fontType,a.cps.vals.colors.endBoundaryColor),b.drawImage(l,e.width-m-5,e.height-k*j-5,l.width,l.height);var n=a.cps.vals.perspectives[a.vs.curPerspectiveIdx].twoDimCanvases.twoDimDrawingDefinitions[0],o=a.ssffds.getSampleRateAndStartTimeOfTrack(n.dots[0].xSsffTrack),p=a.ssffds.getSampleRateAndStartTimeOfTrack(n.dots[0].ySsffTrack),q=1/o.sampleRate-o.startTime,r=Math.round(a.vs.curMousePosSample/a.shs.wavJSO.SampleRate/q);m=b.measureText("frame: "+r).width*d,l=a.fontImage.getTextImage(b,"frame: "+r,a.cps.vals.font.fontPxSize-4,a.cps.vals.font.fontType,a.cps.vals.colors.endBoundaryColor);var s=90;b.save(),b.rotate(s*Math.PI/180),b.drawImage(l,e.width/2-m/2,-e.height),b.restore();for(var t=[],u=0;u<n.dots.length;u++){var v=a.cps.getSsffTrackConfig(n.dots[u].xSsffTrack),w=a.ssffds.getColumnOfTrack(v.name,v.columnName);v=a.cps.getSsffTrackConfig(n.dots[u].ySsffTrack);var x=a.ssffds.getColumnOfTrack(v.name,v.columnName);if(w.length!==x.length||1!==w.length||1!==x.length)return void alert("colomns do not have same length or length of one not 1");var o=a.ssffds.getSampleRateAndStartTimeOfTrack(n.dots[u].xSsffTrack),p=a.ssffds.getSampleRateAndStartTimeOfTrack(n.dots[u].ySsffTrack);if(o.sampleRate!==p.sampleRate||o.startSample!==p.startSample)return void alert("xsRaSt.sampleRate !== ysRaSt.sampleRate || xsRaSt.startSample !== ysRaSt.startSample");var q=1/o.sampleRate-o.startTime,r=Math.round(a.vs.curMousePosSample/a.shs.wavJSO.SampleRate/q),y=(w.values[r]-f)/(g-f)*e.width,z=e.height-(x.values[r]-h)/(i-h)*e.height,A=Math.PI/180*0,B=Math.PI/180*360;b.strokeStyle=n.dots[u].color,b.beginPath(),b.arc(y,z,20,A,B,!0),b.stroke(),b.closePath(),b.beginPath(),b.arc(y,z,2,A,B,!0),b.fill(),b.closePath();var l=a.fontImage.getTextImage(b,n.dots[u].name,a.cps.vals.font.fontPxSize-4,a.cps.vals.font.fontType,a.cps.vals.colors.labelColor);b.drawImage(l,y,z-5,l.width,l.height),t.push({name:n.dots[u].name,x:y,y:z})}var C,D;n.connectLines.forEach(function(a){t.forEach(function(b){b.name===a.fromDot&&(C=b),b.name===a.toDot&&(D=b)}),b.strokeStyle=a.color,b.beginPath(),b.moveTo(C.x,C.y),b.lineTo(D.x,D.y),b.stroke(),b.closePath()})}var e=b.find("canvas")[0],f=1/0,g=-1/0,h=1/0,i=-1/0;a.$watch("ssffds.data.length",function(){$.isEmptyObject(a.cps.vals)||$.isEmptyObject(a.ssffds.data)||0!==a.ssffds.data.length&&d(a)},!0),a.$watch("vs.curViewPort",function(){$.isEmptyObject(a.cps.vals)||$.isEmptyObject(a.ssffds.data)||0!==a.ssffds.data.length&&d(a)},!0),a.$watch("vs.curMousePosSample",function(){$.isEmptyObject(a.cps.vals)||$.isEmptyObject(a.ssffds.data)||0!==a.ssffds.data.length&&d(a)},!0)}}}]),angular.module("emuwebApp").directive("myDropZone",["$animate",function(){return{templateUrl:"views/myDropZone.html",restrict:"E",link:function(){}}}]),angular.module("emuwebApp").directive("emuwebapp",["viewState","Iohandlerservice","ConfigProviderService",function(a,b,c){return{templateUrl:"views/emuwebapp.html",restrict:"E",scope:{audioGetUrl:"@",labelGetUrl:"@",labelDataType:"@"},link:function(b,d,e){d.bind("mouseenter",function(){a.mouseInEmuWebApp=!0}),d.bind("mouseleave",function(){a.mouseInEmuWebApp=!1}),e.$observe("labelDataType",function(a){void 0!==a&&""!==a&&(console.log("VALUE!!!!! labelDataType"),console.log(a))}),e.$observe("audioGetUrl",function(a){void 0!==a&&""!==a&&(console.log("VALUE!!!!! audioData"),console.log(a),c.embeddedVals.audioGetUrl=a)}),e.$observe("labelGetUrl",function(a){void 0!==a&&""!==a&&(c.embeddedVals.labelGetUrl=a)})}}}]);