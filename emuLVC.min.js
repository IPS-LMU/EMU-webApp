var EmuLabeller={init:function(a){"use strict";var b=this;switch(b.USAGEMODE={SERVER:{value:0,name:"Server"},STANDALONE:{value:1,name:"Standalone"},NOT_CONFIGURED:{value:2,name:"NotConfigured"}},b.EDITMODE={STANDARD:{value:0,name:"StandardMode"},LABEL_RENAME:{value:1,name:"LabelRenameMode"},LABEL_MOVE:{value:2,name:"LabelRenameMode"},LABEL_RESIZE:{value:3,name:"DragingTierMode"},DRAGING_TIMELINE:{value:4,name:"DragingTimelineMode"},DRAGING_MINIMAP:{value:5,name:"DragingMinimapMode"},DRAGING_BAR:{value:6,name:"DragingBarMode"},DRAGING_TIER:{value:7,name:"DragingTierMode"}},this.internalMode=b.EDITMODE.STANDARD,this.externalMode=b.USAGEMODE.NOT_CONFIGURED,"server"===a.mode&&(this.externalMode=b.USAGEMODE.SERVER),"standalone"===a.mode&&(this.externalMode=b.USAGEMODE.STANDALONE),this.fileSelect=a.fileSelect,this.menuLeft=a.menuLeft,this.menuMain=a.menuMain,this.draggableBar=a.draggableBar,this.timeline=a.timeline,this.tiers=a.tiers,this.showLeftPush=a.showLeftPush,this.osciCanvas=a.osciCanvas,this.viewPort=Object.create(EmuLabeller.ViewPort),this.backend=Object.create(EmuLabeller.WebAudio),this.backend.init(a),this.drawer=Object.create(EmuLabeller.Drawer),this.drawer.init(a),this.labParser=Object.create(EmuLabeller.LabFileParser),this.iohandler=Object.create(EmuLabeller.IOhandler),this.iohandler.init(44100,this.externalMode),this.ssffParser=Object.create(EmuLabeller.SSFFparser),this.ssffParser.init(),this.JSONval=Object.create(EmuLabeller.JSONvalidator),this.JSONval.init(),this.tierHandler=Object.create(EmuLabeller.tierHandler),this.tierHandler.init(a),this.subMenuOpen=!1,this.dragingStart=0,this.resizeTierStart=0,this.relativeY=0,this.newFileType=-1,this.playMode="vP",this.clickedOn=0,this.selectedSegments=[],this.lastX=0,this.ssffInfos={data:[],canvases:[]},b.externalMode){case b.USAGEMODE.STANDALONE:b.showLeftPush.style.display="none";break;case b.USAGEMODE.SERVER:b.fileSelect.style.display="none";break;default:alert("Please specify Usage mode 'server' or 'standalone' in main.js !"),b.fileSelect.style.display="none",b.showLeftPush.style.display="none"}this.backend.bindUpdate(function(){b.backend.isPaused()||b.onAudioProcess()}),document.addEventListener("mousedown",function(c){switch(null!=b.getElement(c)&&(b.clickedOn=b.getElement(c).id),b.clickedOn){case a.showLeftPush.id:b.openSubmenu();break;case"cmd_addTierSeg":b.tierHandler.addTier();break;case"cmd_addTierPoint":b.tierHandler.addTier(!0);break;case"cmd_removeTier":case"cmd_showHideTier":b.tierHandler.showHideTierDial();break;case"cmd_download":b.prepDownload();break;case"cmd_download":b.prepDownload();break;case"cmd_viewZoomAll":b.setView(-1/0,1/0);break;case"cmd_viewZoomIn":b.zoomViewPort(1);break;case"cmd_viewZoomOut":b.zoomViewPort(0);break;case"cmd_viewMoveLeft":b.shiftViewP(0);break;case"cmd_viewMoveRight":b.shiftViewP(1);break;case"cmd_viewZoomSelect":b.zoomSel();break;case"cmd_playPause":b.playPause();break;case"cmd_playSelected":b.playInMode("sel");break;case"cmd_playAll":b.playInMode("all");break;case"cmd_changeLabel":b.editLabel();break;case"cmd_dropBoxOpen":b.iohandler.dropBoxOpen();break;case a.scrollCanvas.id:b.internalMode=b.EDITMODE.DRAGING_MINIMAP,b.removeLabelDoubleClick();var d=b.backend.currentBuffer.length,e=b.getX(c)*d,f=b.viewPort.eS-b.viewPort.sS;b.setView(e-f/2,e+f/2);break;case a.osciCanvas.id:case a.specCanvas.id:b.internalMode=b.EDITMODE.DRAGING_TIMELINE,b.viewPort.selectS=b.viewPort.sS+(b.viewPort.eS-b.viewPort.sS)*b.getX(c),b.viewPort.selectE=b.viewPort.selectS,b.drawer.uiDrawUpdate();break;case a.draggableBar.id:b.internalMode=b.EDITMODE.DRAGING_BAR,b.dragingStartY=event.clientY,b.offsetTimeline=b.timeline.offsetHeight,b.offsetTiers=b.tiers.offsetHeight}}),document.addEventListener("mouseup",function(a){if(b.internalMode==b.EDITMODE.DRAGING_TIMELINE&&(b.viewPort.selectE=b.viewPort.sS+(b.viewPort.eS-b.viewPort.sS)*b.getX(a),b.drawer.uiDrawUpdate()),b.internalMode==b.EDITMODE.DRAGING_BAR&&(b.dragingStartY=event.clientY,b.offsetTimeline=b.timeline.offsetHeight,b.offsetTiers=b.tiers.offsetHeight),b.internalMode==b.EDITMODE.DRAGING_MINIMAP){var c=b.backend.currentBuffer.length,d=b.getX(a)*c,e=b.viewPort.eS-b.viewPort.sS;b.setView(d-e/2,d+e/2)}}),document.addEventListener("mousemove",function(a){if(1==a.which){if(b.internalMode==b.EDITMODE.DRAGING_TIMELINE&&(b.viewPort.selectE=b.viewPort.sS+(b.viewPort.eS-b.viewPort.sS)*b.getX(a),b.drawer.uiDrawUpdate()),b.internalMode==b.EDITMODE.DRAGING_MINIMAP){var c=b.backend.currentBuffer.length,d=b.getX(a)*c,e=b.viewPort.eS-b.viewPort.sS;b.setView(d-e/2,d+e/2),b.drawer.uiDrawUpdate()}if(b.internalMode==b.EDITMODE.DRAGING_BAR){var f=event.clientY-b.dragingStartY,g=$("#spacer").height()+Math.floor(1.12*Math.floor(f))+"px";$("#wave").css("height","+="+f/2+"px"),$("#spectrogram").css("height","+="+f/2+"px"),$("#spacer").height(g),b.dragingStartY=event.clientY}}else b.internalMode==b.EDITMODE.STANDARD;var h;a.shiftKey&&(b.internalMode=b.EDITMODE.LABEL_MOVE,h=b.viewPort.sS+(b.viewPort.eS-b.viewPort.sS)*b.getX(a),b.tierHandler.moveBoundary(h),b.viewPort.selectS=h,b.viewPort.selectE=h,b.drawer.uiDrawUpdate()),b.lastX=b.getX(a)}),document.addEventListener("contextmenu",function(a){a.preventDefault()}),$(window).resize(function(){b.tierHandler.removeLabelDoubleClick()}),$("#wave").css("height","80px"),$("#spectrogram").css("height","80px"),$("#cans").sortable({tolerance:"pointer",cursor:"move",delay:10,dropOnEmpty:!0,connectWith:"ul.sortable",start:function(){b.internalMode=b.EDITMODE.DRAGING_TIER,b.tierHandler.removeLabelDoubleClick()},stop:function(){b.internalMode=b.EDITMODE.STANDARD},update:function(a,b){"sortable-delete"==this.id&&jQuery("#"+b.item.attr("id")).remove()}}),$("#cans").disableSelection()},drawBuffer:function(){this.drawer.uiDrawUpdate()},onAudioProcess:function(){var a=this,b=0,c=this.backend.getPlayedPercents();this.viewPort.curCursorPosInPercent=c,"sel"==this.playMode&&(b=this.viewPort.selectE/this.backend.currentBuffer.length),"vP"==this.playMode&&this.backend.currentBuffer&&(b=this.viewPort.eS/this.backend.currentBuffer.length),"all"==this.playMode&&(b=1),this.backend.isPaused()||a.drawer.uiDrawUpdate(),c>b&&(a.drawer.uiDrawUpdate(),this.pause())},playInMode:function(a){var b,c;("vP"==a||null===a)&&(this.playMode="vP",b=this.viewPort.sS/this.backend.currentBuffer.length,c=this.viewPort.eS/this.backend.currentBuffer.length,this.backend.play(this.backend.getDuration()*b,this.backend.getDuration()*c)),("sel"==a||null===a)&&(this.playMode="sel",b=this.viewPort.selectS/this.backend.currentBuffer.length,c=this.viewPort.selectE/this.backend.currentBuffer.length,this.backend.play(this.backend.getDuration()*b,this.backend.getDuration()*c)),("all"==a||null===a)&&(this.playMode="all",this.backend.play(0,this.backend.getDuration()))},pause:function(){this.backend.pause()},playPauseInView:function(){this.backend.paused?this.playInMode("vP"):this.pause()},newlyLoadedBufferReady:function(){this.viewPort.init(0,this.backend.currentBuffer.length-1,this.backend.currentBuffer.length),this.drawer.uiWaveDrawUpdate(),this.drawer.uiSpectroDrawUpdate(),this.drawer.uiMiniMapDraw(),this.drawer.uiAllTierDrawUpdate()},load:function(a){var b=this,c=new XMLHttpRequest;c.responseType="arraybuffer",c.addEventListener("load",function(a){b.backend.loadData(a.target.response,b.newlyLoadedBufferReady.bind(b))},!1),c.open("GET",a,!0),c.send()},setView:function(a,b){var c=this.viewPort.sS,d=this.viewPort.eS;a&&(this.viewPort.sS=a),b&&(this.viewPort.eS=b),c>this.viewPort.sS&&d>this.viewPort.eS&&this.viewPort.sS<0&&(this.viewPort.sS=0,this.viewPort.eS=d+Math.abs(this.viewPort.sS)),c<this.viewPort.sS&&d<this.viewPort.eS&&this.viewPort.eS>this.backend.currentBuffer.length-1&&(this.viewPort.sS=c,this.viewPort.eS=this.backend.currentBuffer.length-1),this.viewPort.sS<0&&(this.viewPort.sS=0),this.viewPort.eS>this.backend.currentBuffer.length-1&&(this.viewPort.eS=this.backend.currentBuffer.length-1),this.viewPort.eS-this.viewPort.sS<4&&(this.viewPort.sS=c,this.viewPort.eS=d),this.drawBuffer()},zoomViewPort:function(a){this.tierHandler.removeLabelDoubleClick();var b,c;a?(b=this.viewPort.sS+~~((this.viewPort.eS-this.viewPort.sS)/4),c=this.viewPort.eS-~~((this.viewPort.eS-this.viewPort.sS)/4)):(b=this.viewPort.sS-~~((this.viewPort.eS-this.viewPort.sS)/4),c=this.viewPort.eS+~~((this.viewPort.eS-this.viewPort.sS)/4)),this.setView(b,c)},shiftViewP:function(a){var b,c;a?(b=this.viewPort.sS+~~((this.viewPort.eS-this.viewPort.sS)/4),c=this.viewPort.eS+~~((this.viewPort.eS-this.viewPort.sS)/4)):(b=this.viewPort.sS-~~((this.viewPort.eS-this.viewPort.sS)/4),c=this.viewPort.eS-~~((this.viewPort.eS-this.viewPort.sS)/4)),this.setView(b,c)},zoomSel:function(){this.setView(this.viewPort.selectS,this.viewPort.selectE)},getX:function(a){var b=a.offsetX;return null===b&&(b=a.layerX),b/a.srcElement.clientWidth},getY:function(a){var b=a.offsetY;return null===b&&(relX=a.layerY),b/a.srcElement.clientHeight},getTierID:function(a){return document.getElementById(a.srcElement.id).getAttribute("tier-id")},getTierName:function(a){return a.srcElement.id},getElement:function(a){return document.getElementById(a.srcElement.id)},parseNewFile:function(a){var b=this,c=emulabeller.newFileType;if(0===c)b.backend.loadData(a,b.newlyLoadedBufferReady.bind(b));else if(1==c){var d=emulabeller.labParser.parseFile(a,emulabeller.tierHandler.getLength());this.tierHandler.addLoadedTiers(d[0])}else if(2==c){var e="F0";b.tierHandler.addTiertoHtml(e,"-1","tierSettings","#signalcans");var f=emulabeller.ssffParser.parseSSFF(a);emulabeller.ssffInfos.data.push(f),emulabeller.ssffInfos.canvases.push($("#"+e)[0])}else 3==c&&this.tierHandler.addLoadedTiers(emulabeller.iohandler.parseTextGrid(a))},fileAPIread:function(a){var b=a.target.files[0],c=new FileReader;c.onload=function(){emulabeller.parseNewFile(c.result)},b.type.match("audio.*")?(console.log("is audio"),emulabeller.newFileType=0,c.readAsArrayBuffer(b)):b.name.match(".*lab")||b.name.match(".*tone")?(console.log("is lab file"),emulabeller.newFileType=1,c.readAsText(b)):b.name.match(".*f0")||b.name.match(".*fms")?(console.log("is f0"),emulabeller.newFileType=2,c.readAsArrayBuffer(b)):b.name.match(".*TextGrid")?(console.log("is TextGrid"),emulabeller.newFileType=3,c.readAsText(b)):alert("File type not supported.... sorry!")},openSubmenu:function(){this.subMenuOpen?(this.subMenuOpen=!1,$("#serverSelect").html("Open Menu"),$("#menuLeft").removeClass("cbp-spmenu-open"),$("#timeline").removeClass("cbp-spmenu-push-toright"),$("#tierPush").removeClass("cbp-spmenu-push-toright"),$("#menu-bottom").removeClass("cbp-spmenu-push-toright")):(this.subMenuOpen=!0,$("#serverSelect").html("Close Menu"),$("#menuLeft").addClass("cbp-spmenu-open"),$("#timeline").addClass("cbp-spmenu-push-toright"),$("#tierPush").addClass("cbp-spmenu-push-toright"),$("#menu-bottom").addClass("cbp-spmenu-push-toright"))},countSelected:function(a){var b=0;if(0==this.viewPort.length)return 0;if(0==this.viewPort.selectedSegments.length)return 0;if(null==a){var a=0;$.each(this.viewPort.selectedSegments,function(){++a,$.each(this.viewPort.selectedSegments[a],function(){++b})})}else{if(0==this.viewPort.selectedSegments.length)return 0;if(0==this.viewPort.selectedSegments[a].length)return 0;$.each(this.viewPort.selectedSegments[a],function(){++b})}return b},getSelectedSegmentDoubleClick:function(a){return this.viewPort.selectedSegments[a].indexOf(!0)},editLabel:function(){var a=this;this.isModalShowing=!0,$("#dialLabelInput")[0].value=this.tierHandler.tierInfos.tiers[this.viewPort.selTier].events[this.viewPort.selSegment].label,$("#dialog-messageSetLabel").dialog({modal:!0,close:function(){console.log("closing"),emulabeller.isModalShowing=!1},buttons:{Ok:function(){$(this).dialog("close");var b=$("#dialLabelInput")[0].value;a.tierHandler.tierInfos.tiers[a.viewPort.selTier].events[a.viewPort.selSegment].label=b,a.drawBuffer()}}})},sendTierinfosToServer:function(){var a=this.tierHandler.tierInfos.tiers[this.viewPort.selTier];$.ajax({url:"http://127.0.0.1:8001/",type:"POST",contentType:"application/json",data:JSON.stringify(a),dataType:"json"})},addSegmentAtSelection:function(){this.resetAllSelSegments(),this.resetAllSelBoundariesInTierInfos();var a=this.tierHandler.getSelectedTier();emulabeller.viewPort.selectS==emulabeller.viewPort.selectE?a.events.push({label:"newSegment",startSample:this.viewPort.selectS,sampleDur:0,uiInfos:{selSeg:!1,selBoundryStart:!0,selBoundryEnd:!1,lastValues:[]}}):(a.events.push({label:"newSegment",startSample:this.viewPort.selectS,sampleDur:this.viewPort.selectE-this.viewPort.selectS,uiInfos:{selSeg:!1,selBoundryStart:!0,selBoundryEnd:!1,lastValues:[]}}),a.events.push({label:"emptyAfterNew",startSample:this.viewPort.selectS+1,sampleDur:0,uiInfos:{selSeg:!1,selBoundryStart:!1,selBoundryEnd:!1,lastValues:[]}})),a.events.sort(function(a,b){return parseFloat(a.startSample)-parseFloat(b.startSample)});var b=this.getSelBoundaryEventsWithSurroundingEvtsAndTiers();emulabeller.viewPort.selectS==emulabeller.viewPort.selectE?(b.evts[0].sampleDur=b.evts[1].startSample-b.evts[0].startSample,b.evts[1].sampleDur=b.evts[2].startSample-b.evts[1].startSample):(b.evts[2].startSample=b.evts[1].startSample+b.evts[1].sampleDur,b.evts[2].sampleDur=b.evts[0].sampleDur-(b.evts[1].startSample-b.evts[0].startSample+b.evts[1].sampleDur),b.evts[0].sampleDur=b.evts[1].startSample-b.evts[0].startSample),emulabeller.drawBuffer()},validateTierInfos:function(){this.JSONval.validateTierInfos(this.tierHandler.tierInfos)},prepDownload:function(){var a="text/plain",b=document.querySelector("#downLinkDiv");window.URL=window.webkitURL||window.URL;var c;try{c=b.querySelector("a")}catch(d){console.log("no link")}c&&(window.URL.revokeObjectURL(c.href),b.innerHTML="");var e=new Blob([JSON.stringify(this.tierHandler.tierInfos.tiers,void 0,2)],{type:a}),f=document.createElement("a");f.download="emulabellerjsOutput.txt",f.href=window.URL.createObjectURL(e),f.textContent="Download ready",f.dataset.downloadurl=[a,f.download,f.href].join(":"),f.draggable=!0,f.classList.add("dragout"),b.appendChild(f),f.onclick=function(){return"disabled"in this.dataset?!1:(f.textContent="Downloaded",f.dataset.disabled=!0,void 0)}},moveMultipleSegments:function(a,b){var c=0;$.each(a.events,function(){var a=my.viewPort.selectedSegments[my.viewPort.selTier][c+1],d=my.viewPort.selectedSegments[my.viewPort.selTier][c];a&&(this.time+=b),a!=d&&d&&(this.time+=b),++c})},snapSelectedSegmentToNearestTop:function(){for(var a,b=this.getSelBoundaryEventsWithSurroundingEvtsAndTiers(),c=b.evts[1],d=1/0,e=0;e<b.tiers[0].events.length;e++){var f=b.tiers[0].events[e];Math.abs(f.startSample-c.startSample)<d&&(d=Math.abs(f.startSample-c.startSample),a=e)}var g=c.startSample,h=b.tiers[0].events[a].startSample,i=evts[0].startSample,j=evts[1].startSample+evts[1].sampleDur;c.startSample=h,h>i&&j>h&&(evts[1].startSample=h,evts[1].sampleDur=h>g?evts[1].sampleDur+(g-h):evts[1].sampleDur-(h-g),evts[0].sampleDur=evts[1].startSample-evts[0].startSample),this.drawer.uiAllTierDrawUpdate(this.viewPort,this.tierHandler.tierInfos)},snapSelectedSegmentToNearestBottom:function(){for(var a,b=this.getSelBoundaryEventsWithSurroundingEvtsAndTiers(),c=b.evts[1],d=1/0,e=0;e<b.tiers[2].events.length;e++){var f=b.tiers[2].events[e];Math.abs(f.startSample-c.startSample)<d&&(d=Math.abs(f.startSample-c.startSample),a=e)}var g=c.startSample,h=b.tiers[2].events[a].startSample,i=evts[0].startSample,j=evts[1].startSample+evts[1].sampleDur;c.startSample=h,h>i&&j>h&&(evts[1].startSample=h,evts[1].sampleDur=h>g?evts[1].sampleDur+(g-h):evts[1].sampleDur-(h-g),evts[0].sampleDur=evts[1].startSample-evts[0].startSample),this.drawer.uiAllTierDrawUpdate(this.viewPort,this.tierHandler.tierInfos)},requestFromServer:function(a){console.log("sending message: ",a),this.socketIOhandler.doSend(a),"stopServer"==a&&window.close()}};EmuLabeller.WebAudio={Defaults:{fftSize:512,smoothingTimeConstant:0},ac:new window.webkitAudioContext,init:function(a){a=a||{},this.fftSize=a.fftSize||this.Defaults.fftSize,this.destination=a.destination||this.ac.destination,this.analyser=this.ac.createAnalyser(),this.analyser.smoothingTimeConstant=a.smoothingTimeConstant||this.Defaults.smoothingTimeConstant,this.analyser.fftSize=this.fftSize,this.analyser.connect(this.destination),this.proc=this.ac.createJavaScriptNode(this.fftSize/2,1,1),this.proc.connect(this.destination),this.dataArray=new Uint8Array(this.analyser.fftSize),this.paused=!0},bindUpdate:function(a){this.proc.onaudioprocess=a},setSource:function(a){this.source=a,this.source.connect(this.analyser),this.source.connect(this.proc),this.source.connect(this.destination)},loadData:function(a,b){var c=this;this.pause(),this.ac.decodeAudioData(a,function(a){c.currentBuffer=a,c.lastStart=0,c.lastPause=0,c.startTime=null,b(a)},Error)},isPaused:function(){return this.paused},getDuration:function(){return this.currentBuffer&&this.currentBuffer.duration},play:function(a,b,c){this.currentBuffer&&(this.pause(),this.setSource(this.ac.createBufferSource()),this.source.buffer=this.currentBuffer,this.lastStart=a,this.startTime=this.ac.currentTime,this.source.start(c,a,b-a),this.paused=!1)},pause:function(a){this.currentBuffer&&!this.paused&&(this.lastPause=this.getCurrentTime(),this.source.stop(a||0),this.paused=!0)},getPlayedPercents:function(){return this.getCurrentTime()/this.getDuration()>1&&this.pause(),this.getCurrentTime()/this.getDuration()},getCurrentTime:function(){return this.isPaused()?this.lastPause:this.lastStart+(this.ac.currentTime-this.startTime)},waveform:function(){return this.analyser.getByteTimeDomainData(this.dataArray),this.dataArray},frequency:function(){return this.analyser.getByteFrequencyData(this.dataArray),this.dataArray},loadBuffer:function(a,b,c){var d=new XMLHttpRequest;d.open("GET",b,!0),d.responseType="arraybuffer",d.onload=function(){var b=a.createBuffer(d.response,!1);c(b)},d.send()}},EmuLabeller.Drawer={defaultParams:{waveColor:"#333",progressColor:"#777",cursorWidth:1,loadingColor:"#333",loadingBackground:"#fff",loadingText:"calculating fft ...",loadingBars:20,barHeight:1,barMargin:10,selectedArea:"rgba(0, 0, 255, 0.2)",selectedBorder:"rgba(0, 255, 0, 0.5)"},init:function(a){var b=this;this.params=Object.create(a),Object.keys(this.defaultParams).forEach(function(c){c in a||(a[c]=b.defaultParams[c])}),this.osciDrawer=Object.create(EmuLabeller.Drawer.OsciDrawer),this.osciDrawer.init(a),this.spectogramDrawer=Object.create(EmuLabeller.Drawer.SpectogramDrawer),this.spectogramDrawer.init({specCanvas:a.specCanvas,spectroworker:a.spectroworker,font:a.font,defaultParams:this.defaultParams}),this.SSFFDrawer=Object.create(EmuLabeller.Drawer.SSFFDrawer),this.SSFFDrawer.init(),this.tierDrawer=Object.create(EmuLabeller.Drawer.TierDrawer),this.tierDrawer.init(),this.osciCanvas=a.osciCanvas,this.specCanvas=a.specCanvas,this.scrollCanvas=a.scrollCanvas,this.osciWidth=this.osciCanvas.width,this.osciHeight=this.osciCanvas.height,this.start=0,this.end=this.osciWidth,this.specWidth=this.specCanvas.width,this.specHeight=this.specCanvas.height,this.scrollWidth=this.scrollCanvas.width,this.scrollHeight=8,this.inMemoryMiniMapCanvas=document.createElement("canvas"),this.inMemoryMiniMapCanvas.width=this.scrollWidth,this.inMemoryMiniMapCanvas.height=this.scrollCanvas.clientHeight,this.cc=this.osciCanvas.getContext("2d"),this.scc=this.specCanvas.getContext("2d"),this.scrollcc=this.scrollCanvas.getContext("2d"),this.cacheImage=new Image,this.isInitDraw=!0,a.image&&this.loadImage(a.image,this.drawImage.bind(this)),this.osciWidth&&this.osciHeight||console.error("Canvas size is zero.")},uiDrawUpdate:function(){this.uiWaveDrawUpdate(),this.uiSpectroDrawUpdate(),this.uiMiniMapDraw(),this.uiAllTierDrawUpdate()},uiMiniMapDraw:function(){this.isInitDraw&&(this.osciDrawer.redrawOsciOnCanvas(this.inMemoryMiniMapCanvas),this.isInitDraw=!1),this.osciDrawer.drawScrollMarkup(this.inMemoryMiniMapCanvas)},uiWaveDrawUpdate:function(){this.osciDrawer.drawCurOsciOnCanvas(),this.osciDrawer.drawVpOsciMarkup()},uiSpectroDrawUpdate:function(){this.spectogramDrawer.uiDraw()},uiAllTierDrawUpdate:function(){var a=emulabeller.tierHandler.getTiers();for(var b in a)this.tierDrawer.drawSingleTier(a[b]),this.tierDrawer.drawVpMarkupSingleTier(a[b])},updateSingleTier:function(a,b){null!=a&&(this.tierDrawer.drawSingleTier(a,b),this.tierDrawer.drawVpMarkupSingleTier(a,b))}},EmuLabeller.Drawer.OsciDrawer={init:function(a){this.waveColor="black",this.progressColor="grey",this.scrollSegMarkerColor="rgba(100, 100, 100, 0.6)",this.selMarkerColor="rgba(0, 0, 255, 0.2)",this.selBoundColor="black",this.cursorColor="red",this.cursorWidth=1,this.peaks=[],this.maxPeak=-1/0,this.minPeak=1/0,this.osciCanvas=a.osciCanvas,this.scrollCanvas=a.scrollCanvas,this.forTesting=1,this.sR=44100},getPeaks:function(){var a=(emulabeller.viewPort.eS-emulabeller.viewPort.sS)/this.osciCanvas.width;this.peaks=[],this.minPeak=1/0,this.maxPeak=-1/0;var b=emulabeller.backend.currentBuffer.getChannelData(f),c=b.subarray(emulabeller.viewPort.sS,emulabeller.viewPort.eS);if(1>=a)console.log("over sample exact!!!"),c=b.subarray(emulabeller.viewPort.sS,emulabeller.viewPort.eS+1),this.minPeak=Math.min.apply(Math,c),this.maxPeak=Math.max.apply(Math,c),this.peaks=Array.prototype.slice.call(c);else for(var d=0;d<this.osciCanvas.width;d++){for(var e=0,f=0;f<emulabeller.backend.currentBuffer.numberOfChannels;f++){for(var g=c.subarray(d*a,(d+1)*a),h=-1/0,i=0,j=0,k=g.length;k>j;j++)g[j]>h&&(h=g[j]),i+=g[j];e+=i/g.length}this.peaks[d]=e,e>this.maxPeak&&(this.maxPeak=e)}},drawOsciOnCanvas:function(){var a=this,b=this.osciCanvas.getContext("2d"),c=(emulabeller.viewPort.eS-emulabeller.viewPort.sS)/this.osciCanvas.width;if(this.peaks&&c>=1)this.peaks.forEach(function(b,c){0!==c&&a.drawFrame(c,b,a.maxPeak,a.peaks[c-1],a.osciCanvas,emulabeller.backend.currentBuffer)});else if(1>c){b.strokeStyle=this.waveColor,b.beginPath(),b.moveTo(0,(this.peaks[0]-a.minPeak)/(a.maxPeak-a.minPeak)*canvas.height);for(var d=1;d<this.peaks.length;d++)b.lineTo(d/c,(this.peaks[d]-a.minPeak)/(a.maxPeak-a.minPeak)*canvas.height);b.lineTo(this.osciWidth,(this.peaks[d]-a.minPeak)/(a.maxPeak-a.minPeak)*canvas.height),b.stroke()}},drawFrame:function(a,b,c,d,e){var f=e.getContext("2d"),g=emulabeller.viewPort.eS-emulabeller.viewPort.sS,h=emulabeller.viewPort.curCursorPosInPercent*emulabeller.viewPort.bufferLength-emulabeller.viewPort.sS,i=h/g,j=e.width*i,k=1,l=Math.round(b*(e.height/c)),m=a*k,n=Math.round((e.height-l)/2),o=Math.round(d*(e.height/c)),p=(a-1)*k,q=Math.round((e.height-o)/2);j>=m?(f.fillStyle=this.progressColor,f.strokeStyle=this.progressColor):(f.fillStyle=this.waveColor,f.strokeStyle=this.waveColor),f.beginPath(),f.moveTo(p,q),f.lineTo(m,n),f.stroke()},drawVpOsciMarkup:function(){var a=this.osciCanvas.getContext("2d");a.strokeStyle=this.waveColor,a.beginPath(),a.moveTo(0,0),a.lineTo(5,5),a.moveTo(this.osciCanvas.width,0),a.lineTo(this.osciCanvas.width-5,5),a.moveTo(0,this.osciCanvas.height/2),a.lineTo(this.osciCanvas.width,this.osciCanvas.height/2),a.closePath(),a.stroke();var b,c;if(emulabeller.viewPort){a.font="12px Verdana",b=emulabeller.viewPort.round(emulabeller.viewPort.sS/this.sR,6),c=emulabeller.viewPort.round(emulabeller.viewPort.eS/this.sR,6);var d=a.measureText(b);a.strokeText(c,5,13),a.strokeText(c,this.osciCanvas.width-d.width-5,13)}if(0!==emulabeller.viewPort.selectS&&0!==emulabeller.viewPort.selectE){var e=emulabeller.viewPort.getPos(this.osciCanvas.width,emulabeller.viewPort.selectS),f=emulabeller.viewPort.getPos(this.osciCanvas.width,emulabeller.viewPort.selectE);if(a.fillStyle=this.selMarkerColor,a.fillRect(e,0,f-e,this.osciCanvas.height),a.strokeStyle=this.selBoundColor,a.beginPath(),a.moveTo(e,0),a.lineTo(e,this.osciCanvas.height),a.moveTo(f,0),a.lineTo(f,this.osciCanvas.height),a.closePath(),a.stroke(),a.strokeStyle=this.waveColor,emulabeller.viewPort.selectS==emulabeller.viewPort.selectE)a.strokeText(emulabeller.viewPort.selectS/this.sR,e+5,13);else{var g=a.measureText(emulabeller.viewPort.round(emulabeller.viewPort.selectS/this.sR,6)).width;a.strokeText(emulabeller.viewPort.round(emulabeller.viewPort.selectS/this.sR,6),e-g-4,13),a.strokeText(emulabeller.viewPort.round(emulabeller.viewPort.selectE/this.sR,6),f+5,13),g=a.measureText(emulabeller.viewPort.round((emulabeller.viewPort.selectE-emulabeller.viewPort.selectS)/this.sR,6)).width,a.strokeText(emulabeller.viewPort.round((emulabeller.viewPort.selectE-emulabeller.viewPort.selectS)/this.sR,6),e+(f-e)/2-g/2,13)}}if(emulabeller.viewPort.curCursorPosInPercent>0){var h=emulabeller.viewPort.eS-emulabeller.viewPort.sS,i=emulabeller.viewPort.curCursorPosInPercent*emulabeller.viewPort.emulabeller.backend.currentBufferLength-emulabeller.viewPort.sS,j=i/h,k=canvas.width*j;a.fillStyle=this.cursorColor,a.fillRect(k,0,this.cursorWidth,canvas.height)}},redrawOsciOnCanvas:function(a){var b=this.osciCanvas.height,c=this.osciCanvas.width,d=a.height,e=a.width;canvascc=a.getContext("2d"),canvascc.clearRect(0,0,e,d),canvascc.drawImage(this.osciCanvas,0,0,c,b,0,0,e,d)},drawCurOsciOnCanvas:function(){var a=this.osciCanvas.height,b=this.osciCanvas.width;canvascc=this.osciCanvas.getContext("2d"),canvascc.clearRect(0,0,b,a),osciWidth=this.osciCanvas.width,osciHeight=this.osciCanvas.height,this.getPeaks(),this.drawOsciOnCanvas()},drawScrollMarkup:function(a){var b=this.scrollCanvas.height,c=this.scrollCanvas.width;canvascc=this.scrollCanvas.getContext("2d"),canvascc.clearRect(0,0,c,b),canvascc.drawImage(a,0,0,c,b);var d=3,e=(emulabeller.viewPort.eS-emulabeller.viewPort.sS)/emulabeller.backend.currentBufferLength*c/2+2*d,f=emulabeller.viewPort.sS/emulabeller.backend.currentBufferLength*c+e;canvascc.fillStyle=this.scrollSegMarkerColor,canvascc.fillRect(f-e,0,2*e,b)}},EmuLabeller.Drawer.SpectogramDrawer={init:function(a){var b=this;b.myWindow={BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10},b.PI=3.141592653589793,b.TWO_PI=6.283185307179586,b.OCTAVE_FACTOR=3.321928094887363,b.emphasisPerOctave=3.9810717055349722,b.dynamicRange=5e3,b.dynRangeInDB=50,b.N=512,b.alpha=.16,b.windowFunction=b.myWindow.BARTLETTHANN,b.sampleRate=44100,b.channels=1,b.freq_lower=0,b.freq=8e3,b.canvas=a.specCanvas,b.context=a.specCanvas.getContext("2d"),b.pcmperpixel=0,b.myImage=new Image,b.font=a.font,b.params=a.defaultParams,window.URL=window.URL||window.webkitURL,b.devicePixelRatio=window.devicePixelRatio||1,b.response=spectroworker.textContent,b.blob;try{b.blob=new Blob([b.response],{type:"text/javascript"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,b.blob.append(b.response),b.blob=b.blob.getBlob()}b.primeWorker=new Worker(URL.createObjectURL(b.blob)),b.setupEvent(),b.clearImageCache(),$("#specDialog").dialog({bgiframe:!0,autoOpen:!1,width:500,closeOnEscape:!0,show:"fade",hide:"fade",position:"center",stack:!1,buttons:{OK:function(){var a=$("#windowLength").val(),c=$("#viewrange_from").val(),d=$("#viewrange_to").val(),e=$("#dynamicRange").val(),f=$("#windowFunction").val();isNaN(a)||isNaN(c)||isNaN(d)||isNaN(e)?alert("Please enter valid numbers !"):(b.N=parseInt(a,10),b.freq=parseInt(d,10),b.freq_lower=parseInt(c,10),b.dynRangeInDB=parseInt(e,10),b.windowFunction=parseInt(f,10),b.clearImageCache(),b.killSpectroRenderingThread(),b.uiDraw(),b.drawTimeLine(),$(this).dialog("close"))},Cancel:function(){$(this).dialog("close")}}})},setupEvent:function(){var a=this;a.primeWorker.addEventListener("message",function(b){a.worker_img=b.data.img,a.worker_start=b.data.start,a.worker_end=b.data.end,a.worker_cache_width=b.data.cacheWidth,a.worker_cache_side=b.data.cacheSide,a.render_width=a.canvas.width-a.worker_cache_width,a.myImage.onload=function(){0==a.worker_cache_side&&a.context.drawImage(a.myImage,0,0,a.canvas.width,a.canvas.height,0,0,a.canvas.width,a.canvas.height),1==a.worker_cache_side&&a.context.drawImage(a.myImage,0,0,a.render_width,a.canvas.height,0,0,a.render_width,a.canvas.height),2==a.worker_cache_side&&a.context.drawImage(a.myImage,a.worker_cache_width,0,a.render_width,a.canvas.height,a.worker_cache_width,0,a.render_width,a.canvas.height),a.buildImageCache(a.worker_start,a.worker_end,a.canvas.toDataURL("image/png")),a.drawTimeLineContext()},a.myImage.src=a.worker_img})},buildImageCache:function(a,b,c){var d=this;null==d.imageCache[d.pcmperpixel]&&(d.imageCache[d.pcmperpixel]=new Array),null==d.imageCacheCounter[d.pcmperpixel]&&(d.imageCacheCounter[d.pcmperpixel]=0),null==d.imageCache[d.pcmperpixel][d.imageCacheCounter[d.pcmperpixel]]&&(d.imageCache[d.pcmperpixel][d.imageCacheCounter[d.pcmperpixel]]=new Array,d.imageCache[d.pcmperpixel][d.imageCacheCounter[d.pcmperpixel]][0]=a,d.imageCache[d.pcmperpixel][d.imageCacheCounter[d.pcmperpixel]][1]=b,d.imageCache[d.pcmperpixel][d.imageCacheCounter[d.pcmperpixel]][2]=c,++d.imageCacheCounter[d.pcmperpixel])},drawTimeLineContext:function(){var a=this,b=emulabeller.viewPort.percent*emulabeller.backend.currentBuffer.length,c=emulabeller.viewPort.getPos(a.canvas.width,emulabeller.viewPort.selectS),d=emulabeller.viewPort.getPos(a.canvas.width,emulabeller.viewPort.selectE);a.cursorPos=~~(a.canvas.width*(b-emulabeller.viewPort.sS)/(emulabeller.viewPort.eS-emulabeller.viewPort.sS)),0!=a.cursorPos&&(a.context.fillStyle=a.params.progressColor,a.context.fillRect(a.cursorPos,0,1,a.canvas.height)),0!=emulabeller.viewPort.selectS&&0!=emulabeller.viewPort.selectE&&(a.context.fillStyle=a.params.selectedArea,a.context.fillRect(c,0,d-c,a.canvas.height),a.context.strokeStyle=a.params.selectedBorder,a.context.beginPath(),a.context.moveTo(c,0),a.context.lineTo(c,a.canvas.height),a.context.moveTo(d,0),a.context.lineTo(d,a.canvas.height),a.context.closePath(),a.context.stroke())},drawTimeLine:function(){var a=this,b=new Image;b.onload=function(){a.context.drawImage(b,0,0),a.drawTimeLineContext()},b.src=this.myImage.src},killSpectroRenderingThread:function(){var a=this;a.context.fillStyle=a.params.loadingBackground,a.context.fillRect(0,0,a.canvas.width,a.canvas.height),a.context.font=a.font,a.context.fillStyle=a.params.loadingColor,a.context.fillText(a.params.loadingText,10,25),null!=a.primeWorker&&(a.primeWorker.terminate(),a.primeWorker=null)},clearImageCache:function(){var a=this;a.imageCache=null,a.imageCacheCounter=null,a.imageCache=new Array,a.imageCacheCounter=new Array},uiDraw:function(){var a=this;if(a.newpcmperpixel=Math.round((emulabeller.viewPort.eS-emulabeller.viewPort.sS)/a.canvas.width),null!=a.imageCache)if(null!=a.imageCache[a.newpcmperpixel]){for(var b=0;b<a.imageCache[a.newpcmperpixel].length;++b)if(a.imageCache[a.newpcmperpixel][b][0]==emulabeller.viewPort.sS&&a.imageCache[a.newpcmperpixel][b][1]==emulabeller.viewPort.eS)return a.myImage.src=a.imageCache[a.newpcmperpixel][b][2],a.drawTimeLine(),void 0;a.killSpectroRenderingThread(),a.startSpectroRenderingThread()}else a.killSpectroRenderingThread(),a.startSpectroRenderingThread();else a.killSpectroRenderingThread(),a.startSpectroRenderingThread()},startSpectroRenderingThread:function(){var a=this;a.pcmperpixel=Math.round((emulabeller.viewPort.eS-emulabeller.viewPort.sS)/a.canvas.width),a.primeWorker=new Worker(URL.createObjectURL(a.blob)),a.setupEvent(),a.primeWorker.postMessage({cmd:"config",N:a.N}),a.primeWorker.postMessage({cmd:"config",alpha:a.alpha}),a.primeWorker.postMessage({cmd:"config",freq:a.freq}),a.primeWorker.postMessage({cmd:"config",freq_low:a.freq_lower}),a.primeWorker.postMessage({cmd:"config",start:Math.round(emulabeller.viewPort.sS)}),a.primeWorker.postMessage({cmd:"config",end:Math.round(emulabeller.viewPort.eS)}),a.primeWorker.postMessage({cmd:"config",myStep:a.pcmperpixel}),a.primeWorker.postMessage({cmd:"config",window:a.windowFunction}),a.primeWorker.postMessage({cmd:"config",cacheSide:0}),a.primeWorker.postMessage({cmd:"config",width:a.canvas.width}),a.primeWorker.postMessage({cmd:"config",height:a.canvas.height}),a.primeWorker.postMessage({cmd:"config",cacheWidth:0}),a.primeWorker.postMessage({cmd:"config",dynRangeInDB:a.dynRangeInDB}),a.primeWorker.postMessage({cmd:"config",pixelRatio:a.devicePixelRatio}),a.primeWorker.postMessage({cmd:"pcm",config:JSON.stringify(emulabeller.backend.currentBuffer)}),a.primeWorker.postMessage({cmd:"pcm",stream:emulabeller.backend.currentBuffer.getChannelData(0).subarray(emulabeller.viewPort.sS,emulabeller.viewPort.eS+2*a.N)}),a.primeWorker.postMessage({cmd:"render"})
}},EmuLabeller.Drawer.TierDrawer={init:function(){this.markColor="rgba(255, 255, 0, 0.7)",this.startBoundaryColor="green",this.endBoundaryColor="red",this.curSelBoundColor="#0DC5FF",this.selMarkerColor="rgba(0, 0, 255, 0.2)",this.selBoundColor="black",this.cursorColor="red",this.cursorWidth=1,this.deleteImage="data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAA3NCSVQICAjb4U/gAAAAn1BMVEX////4YmT/dnnyTE//dnn9bnH6am34YmT3XWD2WVv2VVjsOj3oMDLlJyrjICL2VVjzUVTwR0ruPT/iHB72WVvwR0rzUVT/h4r/gob/foH/eXv/dnn/cnT9bnH/bG76am3/Zmb6ZGf4YmT3XWD/WFv2WVv/VFf2VVj0TVDyTE/2SkzwR0rvREfuQUPuPT/sOj3rNDboMDLnLTDlJyrjICIhCpwnAAAANXRSTlMAESIiMzMzMzMzMzMzMzNERERERHd3qv///////////////////////////////////////0mgXpwAAAAJcEhZcwAAHngAAB54AcurAx8AAAAYdEVYdFNvZnR3YXJlAEFkb2JlIEZpcmV3b3Jrc0+zH04AAACVSURBVBiVbczXFoIwDAbguHGi4mqbWugQZInj/Z9NSuXAhblJvuTkB+jV4NeHY9e9g+/M2KSxFKdRY0JwWltxoo72gvRMxcxTgqrM/Qp2QWmdt+kRJ5SyzgCGao09zw3TN8yWnSNEfo3LVWdTPJIwqdbWCyN5XABUeZi+NvViG0trgHeRPgM77O6l+/04A+zb9AD+1Bf6lg3jQQJJTgAAAABJRU5ErkJggg==",this.selTierColor="#C8C8C8"},drawSingleTier:function(a,b){var c=this,d=a.uiInfos.canvas,e=d.getContext("2d"),f=d.width*b;if(f>d.width-32){var g=new Image;g.onload=function(){e.drawImage(g,0,0,16,16,d.width-40,10,32,32)},g.src=c.deleteImage,$("body").css("cursor","pointer")}else if($("body").css("cursor","auto"),a.TierName==emulabeller.viewPort.getSelectTier()?(e.fillStyle=this.selTierColor,e.fillRect(0,0,d.width,d.height)):e.clearRect(0,0,d.width,d.height),e.strokeStyle="black",e.font="12px Verdana",e.strokeText(a.TierName,5,13),e.strokeText("("+a.type+")",5,28),"seg"==a.type){e.fillStyle=this.boundaryColor;var h=a.events;for(var i in h){var j=h[i];if(j.startSample>emulabeller.viewPort.sS&&j.startSample<emulabeller.viewPort.eS||j.startSample+j.sampleDur>emulabeller.viewPort.sS&&j.startSample+j.sampleDur<emulabeller.viewPort.eS){var k=(j.startSample-emulabeller.viewPort.sS)/(emulabeller.viewPort.eS-emulabeller.viewPort.sS);j.uiInfos.selBoundryStart?(e.fillStyle=this.curSelBoundColor,e.fillRect(d.width*k,0,1,d.height)):(e.fillStyle=this.startBoundaryColor,e.fillRect(d.width*k,0,1,d.height/2));var l=(j.startSample+j.sampleDur-emulabeller.viewPort.sS)/(emulabeller.viewPort.eS-emulabeller.viewPort.sS);j.uiInfos.selBoundryEnd?(e.fillStyle=this.curSelBoundColor,e.fillRect(d.width*l,d.height/2,1,d.height)):(e.fillStyle=this.endBoundaryColor,e.fillRect(d.width*l,d.height/2,1,d.height)),emulabeller.viewPort.isSelected(a,j.label,j.startSample)&&(e.fillStyle=this.markColor,e.fillRect(d.width*k,0,l*d.width-k*d.width,d.height)),e.strokeStyle="black",e.fillStyle="white",tW=e.measureText(j.label).width,tX=d.width*(k+(l-k)/2)-tW/2,e.strokeText(j.label,tX,d.height/2+3),e.strokeStyle="rgba(0,255,0,0.5)",e.beginPath(),e.moveTo(k*d.width,d.height/4),e.lineTo(tX+tW/2,d.height/4),e.lineTo(tX+tW/2,d.height/4+10),e.stroke(),e.strokeStyle="rgba(255,0,0,0.2)",e.beginPath(),e.moveTo(l*d.width,3*(d.height/4)),e.lineTo(tX+tW/2,3*(d.height/4)),e.lineTo(tX+tW/2,3*(d.height/4)-10),e.stroke()}}}else if("point"==a.type)for(e.fillStyle=this.startBoundaryColor,curEvtNr=0;curEvtNr<a.events.length;curEvtNr++){var j=a.events[curEvtNr];a.events[curEvtNr].startSample>emulabeller.viewPort.sS&&a.events[curEvtNr].startSample<emulabeller.viewPort.eS&&(perc=(a.events[curEvtNr].startSample-emulabeller.viewPort.sS)/(emulabeller.viewPort.eS-emulabeller.viewPort.sS),e.fillStyle=j.uiInfos.selBoundryStart?this.curSelBoundColor:this.startBoundaryColor,e.fillRect(d.width*perc,0,1,d.height/2-d.height/10),tW=e.measureText(a.events[curEvtNr].label).width,e.strokeText(a.events[curEvtNr].label,d.width*perc-tW/2+1,d.height/2),e.fillRect(d.width*perc,d.height/2+d.height/10,1,d.height/2-d.height/10))}},drawVpMarkupSingleTier:function(a){var b=a.uiInfos.canvas;cc=b.getContext("2d");var c=emulabeller.viewPort.getPos(b.width,emulabeller.viewPort.selectS),d=emulabeller.viewPort.getPos(b.width,emulabeller.viewPort.selectE);cc.strokeStyle=this.selBoundColor,cc.fillStyle=this.selBoundColor,emulabeller.viewPort.selectS==emulabeller.viewPort.selectE?(cc.beginPath(),cc.arc(c,5,5,0,2*Math.PI,!1),cc.stroke(),cc.fill(),cc.beginPath(),cc.moveTo(c,10),cc.lineTo(c,b.height),cc.stroke()):(cc.fillStyle=this.selMarkerColor,cc.fillRect(c,0,d-c,b.height),cc.beginPath(),cc.moveTo(c,0),cc.lineTo(c,b.height),cc.moveTo(d,0),cc.lineTo(d,b.height),cc.stroke());var e=emulabeller.viewPort.curCursorPosInPercent*emulabeller.viewPort.bufferLength-emulabeller.viewPort.sS,f=e/(emulabeller.viewPort.eS-emulabeller.viewPort.sS),g=b.width*f;cc.strokeStyle=this.cursorColor;var h=this.cursorWidth,i=b.height;cc.fillStyle=this.cursorColor,g>0&&cc.fillRect(g,0,h,i)}},EmuLabeller.Drawer.SSFFDrawer={init:function(){this.markColor="rgba(255, 255, 0, 0.7)",this.boundaryColor="white",this.selBoundColor="red"},drawSSFF:function(a,b){var c=a.canvases[0].getContext("2d");if(!a.data[0].maxF0){console.log("calculating max f0"),a.data[0].maxF0=-1/0;for(var d=0;d<a.data[0].Columns[0].values.length;d++)a.data[0].Columns[0].values[d][0]>a.data[0].maxF0&&(a.data[0].maxF0=a.data[0].Columns[0].values[d][0])}var e=1/a.data[0].Record_Freq;a.data[0].Start_Time;var f=a.data[0].maxF0,g=a.canvases[0].clientHeight,h=a.canvases[0].clientWidth;c.clearRect(0,0,h,g),(b.eS-b.sS)/this.osciWidth;var i=Math.floor(b.sS/44100/e)+1,j=Math.ceil(b.eS/44100/e),k=(j-i)/this.osciWidth;c.strokeStyle=this.params.waveColor,c.font="12px Verdana",c.strokeText(a.data[0].Columns[0].name,5,13),c.strokeStyle="rgba(0,0,255,0.5)",c.fillStyle="rgba(0,0,255,0.5)";for(var d=1;j-i>d;d++)c.beginPath(),c.moveTo((d-1)/k,g-a.data[0].Columns[0].values[i+d-1][0]/f*g),c.lineTo(d/k,g-a.data[0].Columns[0].values[i+d][0]/f*g),c.stroke(),c.beginPath(),c.arc(d/k,g-a.data[0].Columns[0].values[i+d][0]/f*g,1,0,2*Math.PI,!0),c.closePath(),c.fill()}},EmuLabeller.ViewPort={init:function(a,b,c){this.sS=a,this.eS=b,this.selectS=0,this.selectE=0,this.bufferLength=c,this.percent=-1,this.uiInfo=[],this.resetSelection(),this.MouseTierName="",this.curMouseTierName="",this.curMouseSegmentName="",this.curMouseSegmentStart="",this.curMouseSegmentDuration="",this.selectSPixel=0,this.selectEPixel=0,this.curCursorPosInPercent=0},getPos:function(a,b){return a*(b-this.sS)/(this.eS-this.sS)},setSelectTier:function(a){this.MouseTierName=a},getSelectTier:function(){return this.MouseTierName},setSelectSegment:function(a,b,c,d){this.uiInfo[this.getId(a,b,c)]=d},isSelected:function(a,b,c){return a.TierName==this.getSelectTier()?this.uiInfo[this.getId(a,b,c)]:!1},getId:function(a,b,c){var d=0;for(var e in a.events){if(a.events[e].label==b&&a.events[e].startSample==c)return d;d++}},resetSelection:function(a){for(var b=0;a>b;b++)this.uiInfo[b]=!1},round:function(a,b){(1>b||b>14)&&alert("error in call of round function!!");var c=Math.pow(10,b),d=(Math.round(a*c)/c).toString();return-1==d.indexOf(".")&&(d+="."),d+=c.toString().substring(1),d.substring(0,d.indexOf(".")+b+1)}},EmuLabeller.LabFileParser={parseFile:function(a,b){var c=44100,d=a.split("\n"),e=[];e.push({TierName:"Tier"+b,type:"seg",events:[]});var f=d[3].split(/\s+/);"H#"!=f[3]&&(e[e.length-1].type="point");for(var g=3;g<d.length;g++)f=d[g].split(/\s+/),e[e.length-1].events.push({label:f[3],time:f[1]*c});return e},load:function(a){var b=new XMLHttpRequest;b.responseType="text",b.addEventListener("load",function(a){emulabeller.newFileType=1,emulabeller.parseNewFile(a.target.response)},!1),b.open("GET",a,!0),b.send()}},EmuLabeller.TextGridParser={toJSO:function(a){var b,c,d,e,f=44100,g=a.split("\n"),h='File type= "ooTextFile"',i='Object class = "TextGrid"',j={origSamplerate:44100,labelEncoding:"UTF-8",tiers:[]};if(g[0]==h&&g[1]==i){for(var k=8;k<g.length;k++){var l=g[k].split(/\s+/)[1];l&&("item"==l&&(b='"IntervalTier"'==g[k+1].split(/\s+/)[3]?"seg":"point",c=g[k+2].split(/\s+/)[3].replace(/"/g,""),j.tiers.push({TierName:c,type:b,events:[],uiInfos:{sel:!1,canvas:null}})),j.tiers.length>0&&"seg"==j.tiers[j.tiers.length-1].type&&0===l.indexOf("intervals[")?(eSt=g[k+1].split(/\s+/)[3]*f,eEt=g[k+2].split(/\s+/)[3]*f,e=g[k+3].split(/\s+/)[3].replace(/"/g,""),j.tiers[j.tiers.length-1].events.push({label:e,startSample:Math.round(eSt),sampleDur:Math.round(eEt-eSt),uiInfos:{selSeg:!1,selBoundryStart:!1,selBoundryEnd:!1,lastValues:[]}})):j.tiers.length>0&&"point"==j.tiers[j.tiers.length-1].type&&0===l.indexOf("points[")&&(d=g[k+1].split(/\s+/)[3]*f,e=g[k+2].split(/\s+/)[3].replace(/"/g,""),j.tiers[j.tiers.length-1].events.push({label:e,startSample:Math.round(d),uiInfos:{selBoundryStart:!1,lastValues:[]}})))}return j}alert("bad header in textgrid file!!!")},toTextGrid:function(){console.log("not implemented yet")}},EmuLabeller.SSFFparser={init:function(){this.ssffData={},this.ssffData.headID="SSFF -- (c) SHLRC\n",this.ssffData.machineID="Machine IBM-PC\n",this.ssffData.sepString="-----------------\n",this.ssffData.Record_Freq=-1,this.ssffData.Start_Time=-1,this.ssffData.Columns=[]},parseSSFF:function(a){var b=this,c=new Uint8Array(a),d=String.fromCharCode.apply(null,c),e=d.split(/^/m);(e[0]!=b.ssffData.headID||e[1]!=b.ssffData.machineID)&&alert("no ssff file... or missing fields"),"Record_Freq "!=e[2].split(/[ ,]+/)[0]||"Start_Time "!=e[3].split(/[ ,]+/)[0]?(this.ssffData.Record_Freq=e[2].split(/[ ,]+/)[1],this.ssffData.Start_Time=e[3].split(/[ ,]+/)[1]):alert("no ssff file... or missing fields ");for(var f=4;f<e.length&&e[f]!=this.ssffData.sepString;f++){var g=e[f].split(/[ ]+/);"Column"==g[0]&&this.ssffData.Columns.push({name:g[1],type:g[2],length:g[3],values:[]})}var h=e.slice(0,f+1).join("").length;console.log(c[h]);for(var i,j,k;h<=c.length;)for(f=0;f<this.ssffData.Columns.length;f++)"DOUBLE"==this.ssffData.Columns[f].type?(k=8*this.ssffData.Columns[f].length,j=a.subarray(h,k),i=new Float64Array(j),this.ssffData.Columns[f].values.push(i),h+=k):"FLOAT"==this.ssffData.Columns[f].type?(k=4*this.ssffData.Columns[f].length,j=a.subarray(h,k),i=new Float32Array(j),this.ssffData.Columns[f].values.push(i),h+=k):alert("not supported... only doubles for now");return this.ssffData},load:function(a){var b=new XMLHttpRequest;b.responseType="arraybuffer",b.addEventListener("load",function(a){emulabeller.newFileType=2,emulabeller.parseNewFile(a.target.response)},!1),b.open("GET",a,!0),b.send()}},ArrayBuffer.prototype.subarray=function(a,b){for(var c=new ArrayBuffer(b),d=new Int8Array(c),e=new Int8Array(this),f=0;b>f;f++)d[f]=e[a+f];return c},EmuLabeller.JSONvalidator={init:function(){this.successObj={foo:"bar"},this.failureObj={f:1234},this.schema={$schema:"http://json-schema.org/draft-03/schema#",title:"tierInfos",description:"JSON representation of tier information containing sample times of events with label information",type:"object",properties:{origSamplerate:{description:"sample rate of audio file that this JSON contains the label information of",type:"integer"},labelEncoding:{description:"encoding of labels given. Only UTF-8 is supported. So anything else will not work",type:"string"},tiers:{description:"array containing tier information of multiple tiers",type:"array",items:{type:"object",properties:{tierName:{description:"name of tier which should uniquely specify the tier from others in view",type:"string"},tierType:{description:"type of tier can either be 'seg' to mark a segment tier or 'point' to mark a point/event tier",type:{"enum":["seg","point"]}},events:{description:"array containing containing label information of multiple labels",type:"array",items:{type:"object",properties:{label:{description:"an arbitrary UTF-8 string that describes the label",type:"string"},atSample:{description:"sample that marks the start/point of the event dependent on the type of tier",type:"integer"},dur:{description:"duration of segment (in tierType seg) where atSample+dur marks the end sample of the segment",type:"integer"}}}}},required:["tierName","tierType","events"],additionalProperties:!1}}},required:["origSamplerate","labelEncoding"],additionalProperties:!1}},validateTierInfos:function(){var a=JSV.createEnvironment("json-schema-draft-03");this.successObj;var b=a.validate("{foo:'barâ€˜}",this.schema);if(console.log(b),console.log(this.failureObj),0===b.errors.length)console.log("Object is valid! Length of errors: "+b.errors.length);else{var c=b.errors;console.log("uri : "+c[0].uri+"\nmessage :  "+c[0].message)}}},EmuLabeller.socketIOhandler={init:function(){my=this,console.log("init sockets");var a="ws://localhost:7681/";websocket=new WebSocket(a),websocket.onopen=function(a){my.onOpen(a)},websocket.onclose=function(a){my.onClose(a)},websocket.onmessage=function(a){my.onMessage(a)},websocket.onerror=function(a){my.onError(a)}},onOpen:function(){console.log("ON OPEN")},onClose:function(){console.log("ON CLOSE")},onMessage:function(a){console.log("ON MESSAGE with message: ",a.data)},onError:function(){console.log("ON ERROR")},doSend:function(a){websocket.send(a)}},EmuLabeller.IOhandler={init:function(a,b){this.textGridHandler=Object.create(EmuLabeller.TextGridParser),this.DropBoxHandler=Object.create(EmuLabeller.DropBoxHandler),0==b.value&&(this.socketIOhandler=Object.create(EmuLabeller.socketIOhandler),this.socketIOhandler.init())},websocketLoad:function(a){console.log(a,"requested! Websockets not implemented yet")},websocketSave:function(){console.log("supposed to save stuff to websocket! Websockets not implemented yet")},xhrLoad:function(a,b){var c=new XMLHttpRequest;c.responseType="text",c.addEventListener("load",function(a){emulabeller.newFileType=b,emulabeller.parseNewFile(a.target.response)},!1),c.open("GET",a,!0),c.send()},parseTextGrid:function(a){return res=this.textGridHandler.toJSO(a)},addUiInfosToTierInfosObj:function(){},removeUiInfosToTierInfosObj:function(){},dropBoxOpen:function(){this.DropBoxHandler.openDropBox()}},EmuLabeller.tierHandler={init:function(a){this.internalCanvasWidth=a.internalCanvasWidth,this.internalCanvasHeightSmall=a.internalCanvasHeightSmall,this.internalCanvasHeightBig=a.internalCanvasHeightBig,this.isModalShowing=!1,this.tierInfos=a.tierInfos},addTier:function(a){var b="Tier"+(this.getLength()+1);if(a)var c={TierName:b,type:"point",events:[],uiInfos:[]};else var c={TierName:b,type:"seg",events:[],uiInfos:[]};this.addTiertoHtml(b,"tierSettings","#cans"),this.tierInfos.tiers[b]=c,this.tierInfos.tiers[b].uiInfos.canvas=$("#"+b)[0],emulabeller.viewPort.addTiertoSelection(b),emulabeller.drawer.updateSingleTier(this.tierInfos.tiers[b])},addLoadedTiers:function(a){var b=this;$.each(a.tiers,function(){b.addTiertoHtml(this.TierName,"tierSettings","#cans"),b.tierInfos.tiers[this.TierName]=this,b.tierInfos.tiers[this.TierName].uiInfos.canvas=$("#"+this.TierName)[0]})},getLength:function(){var a=0,b=this.tierInfos.tiers;for(var c in b)a++;return a},showHideTierDial:function(){emulabeller.isModalShowing=!0,$("#dialog-messageSh").dialog({modal:!0,close:function(){console.log("closing"),emulabeller.isModalShowing=!1},buttons:{Ok:function(){$(this).dialog("close");var a=$("#dialShInput")[0].value;$("#"+a).slideToggle(),emulabeller.isModalShowing=!1}}})},addTiertoHtml:function(a,b,c){$("<canvas>").attr({id:a,width:this.internalCanvasWidth,height:this.internalCanvasHeightSmall}).addClass(b).appendTo(c),$("#"+a).bind("click",function(b){emulabeller.tierHandler.handleTierClick(emulabeller.getX(b.originalEvent),emulabeller.getY(b.originalEvent),emulabeller.tierHandler.getSelectTierDetailsFromTierWithName(a))}),$("#"+a).bind("dblclick",function(a){emulabeller.tierHandler.handleTierDoubleClick(a.originalEvent)}),$("#"+a).bind("contextmenu",function(b){emulabeller.tierHandler.handleTierClickMulti(emulabeller.getX(b.originalEvent),emulabeller.getY(b.originalEvent),emulabeller.tierHandler.getSelectTierDetailsFromTierWithName(a))}),$("#"+a).bind("mousemove",function(b){emulabeller.tierHandler.trackMouseInTiers(b,emulabeller.getX(b.originalEvent),a)}),$("#"+a).bind("mouseout",function(){emulabeller.drawer.updateSingleTier(emulabeller.tierHandler.getSelectTierDetailsFromTierWithName(a))}),$("#"+a).bind("mouseup",function(){}),$("#"+a).bind("mousedown",function(){})},trackMouseInTiers:function(a,b,c){if(!a.shiftKey){var d=this.getSelectTierDetailsFromTierWithName(c),e=emulabeller.viewPort.sS+(emulabeller.viewPort.eS-emulabeller.viewPort.sS)*b,a=this.findAndMarkNearestSegmentBoundry(d,e);null!=a&&(emulabeller.viewPort.curMouseSegmentName=a.label,emulabeller.viewPort.curMouseSegmentStart=a.startSample,emulabeller.viewPort.curMouseSegmentDuration=a.sampleDur),emulabeller.drawer.updateSingleTier(d,b)}},findAndMarkNearestSegmentBoundry:function(a,b){var c=null,d=null,e=a.events;for(var f in e)(null===c||Math.abs(e[f].startSample-b)<Math.abs(c-b))&&(c=e[f].startSample,d=e[f]);return d},getSelectTierDetailsFromTierWithName:function(a){return this.tierInfos.tiers[a]},removeTier:function(a){$("#"+a).remove(),delete this.tierInfos.tiers[a]},handleTierClick:function(a,b,c){this.removeLabelDoubleClick(),emulabeller.viewPort.setSelectTier(c.TierName),emulabeller.viewPort.resetSelection(c.events.length),this.handleTierClickMulti(a,b,c)},handleTierClickMulti:function(a,b,c){this.removeLabelDoubleClick();var d=c.uiInfos.canvas;if(d.getContext("2d"),emulabeller.viewPort.getSelectTier()!=c.TierName&&(emulabeller.viewPort.setSelectTier(c.TierName),emulabeller.viewPort.resetSelection(c.events.length)),c.uiInfos.canvas.width*a,c.uiInfos.canvas.height*b,c.uiInfos.canvas.width*(emulabeller.viewPort.selectS/(emulabeller.viewPort.eS-emulabeller.viewPort.sS)),"seg"==c.type){var e=emulabeller.viewPort.sS+(emulabeller.viewPort.eS-emulabeller.viewPort.sS)*a,f=this.findNearestSegment(c,e);emulabeller.viewPort.selectS=f.startSample,emulabeller.viewPort.selectE=f.startSample+f.sampleDur,null!=f&&(emulabeller.viewPort.curMouseSegmentName=f.label,emulabeller.viewPort.curMouseSegmentStart=f.startSample,emulabeller.viewPort.curMouseSegmentDuration=f.sampleDur,emulabeller.viewPort.setSelectSegment(c,f.label,f.startSample,!0))}emulabeller.drawBuffer()},findNearestSegment:function(a,b){var c=a.events,d=null;for(var e in c)b>c[e].startSample&&b<c[e].startSample+c[e].sampleDur&&(d=c[e]);return d},getSelectedTier:function(){return this.tierInfos.tiers[emulabeller.viewPort.getSelectTier()]},getTiers:function(){return this.tierInfos.tiers},getTier:function(a){return this.tierInfos.tiers[a]},getSelectedSegmentInTier:function(a){var b=a.events;for(var c in b)if(b[c].uiInfos.selSeg)return b[c]},handleTierDoubleClick:function(){var a=this;if(0===$("#textAreaPopUp").length){var b=this.getSelectedTier();if("seg"==b.type){var c=this.getSelectedSegmentInTier(b),d=emulabeller.viewPort.getPos(b.uiInfos.canvas.clientWidth,emulabeller.viewPort.selectS),e=emulabeller.viewPort.getPos(b.uiInfos.canvas.clientWidth,emulabeller.viewPort.selectE),f=Math.round(d)+b.uiInfos.canvas.offsetLeft+2,g=b.uiInfos.canvas.offsetTop+2,h=Math.floor(e-d-5),i=Math.floor(b.uiInfos.canvas.height/2-5),j="<div id='textAreaPopUp' class='textAreaPopUp' style='top:"+g+"px;left:"+f+"px;'><textarea id='editArea' class='editArea'  wrap='off' style='width:"+h+"px;height:"+i+"px;'>"+c.label+"</textarea>",k="<input type='button' value='save' id='saveText' class='mini-btn saveText'></div>",l=j+k;$("#tiers").append(l),emulabeller.internalMode=emulabeller.EDITMODE.LABEL_RENAME,$("#saveText")[0].addEventListener("click",function(){a.saveLabelDoubleClick()}),$("#editArea")[0].onkeyup=function(b){b=b||window.event,13==b.keyCode&&(a.saveLabelDoubleClick(),a.removeLabelDoubleClick())},a.createSelection(document.getElementById("editArea"),0,c.label.length)}else"point"==b.type&&alert("no point editing yet! Sorry...")}else a.removeLabelDoubleClick()},isSelectNeighbour:function(a,b){return this.isRightSelectNeighbour(a,b)||this.isLeftSelectNeighbour(a,b)},isRightSelectNeighbour:function(a,b){return b==this.viewPort.selectedSegments[a].length?!1:this.viewPort.selectedSegments[a][b+1]},isLeftSelectNeighbour:function(a,b){return 0===b?!1:this.viewPort.selectedSegments[a][b-1]},createSelection:function(a,b,c){if(a.createTextRange){var d=a.createTextRange();d.collapse(!0),d.moveStart("character",b),d.moveEnd("character",c),d.select()}else a.setSelectionRange?a.setSelectionRange(b,c):a.selectionStart&&(a.selectionStart=b,a.selectionEnd=c);a.focus()},saveLabelDoubleClick:function(){var a=this.getSelectedTier(),b=this.getSelectedSegmentInTier(a),c=$("#editArea").val();b.label=c.replace(/[\n\r]/g,""),emulabeller.drawer.updateSingleTier(a)},removeLabelDoubleClick:function(){$("textarea#editArea").remove(),$("#saveText").remove(),$("#textAreaPopUp").remove()},getSelBoundaryEventsWithSurroundingEvtsAndTiers:function(){var a,b=this.tierInfos.tiers;for(var c in b)for(var d in b[c].events)b[c].events[d].uiInfos.selBoundryStart===!0&&(a={tiers:[this.tierInfos.tiers[i-1],this.tierInfos.tiers[i],this.tierInfos.tiers[i+1]],evts:[this.tierInfos.tiers[i].events[d-1],this.tierInfos.tiers[i].events[d],this.tierInfos.tiers[i].events[d+1]]});return a},moveBoundary:function(a){var b=this.getSelBoundaryEventsWithSurroundingEvtsAndTiers();evts=b.events;var c=b.tiers[1];a=Math.round(a);var d,e,f;"seg"==c.type?(d=evts[1].startSample,e=evts[0].startSample,f=evts[1].startSample+evts[1].sampleDur,a>e&&f>a&&(evts[1].startSample=a,evts[1].sampleDur=a>d?evts[1].sampleDur+(d-a):evts[1].sampleDur-(a-d),evts[0].sampleDur=evts[1].startSample-evts[0].startSample)):(d=evts[1].startSample,e=evts[0].startSample,f=evts[2].startSample,a>e&&f>a&&(evts[1].startSample=a))}},EmuLabeller.DropBoxHandler={readDropbox:function(a){var b=this,c=new XMLHttpRequest;c.open("GET",a,!1),c.onreadystatechange=function(a){4===c.readyState&&(200===c.status?(console.log("here..."),console.log(a.target.response),emulabeller.newFileType=0,emulabeller.parseNewFile(b.str2ab(a.target.response))):console.log("Error",c.statusText))};try{c.send(null)}catch(d){alert(d)}return 200==c.status?c.responseText:(alert("Error - File not found in Dropbox public folder"),null)},openDropBox:function(){var a=this;console.log("open from dropbox"),Dropbox.choose({linkType:"direct",success:function(b){console.log("Here's the file link:"+b[0].link),a.readDropbox(b[0].link)}})},str2ab:function(a){for(var b=new ArrayBuffer(2*a.length),c=new Uint16Array(b),d=0,e=a.length;e>d;d++)c[d]=a.charCodeAt(d);return b}};var emulabeller=function(){"use strict";var a=!0,b={tiers:[],canvases:[]},c=document.querySelector("#wave"),d=document.querySelector("#spectrogram"),e=document.querySelector("#scrollbar"),f=document.querySelector("#resizer"),g=document.querySelector("#timeline"),h=document.querySelector("#tiers"),i=document.querySelector("#fileSelect"),j=document.getElementById("serverSelect"),k=document.querySelector("#spectroworker"),l=Object.create(EmuLabeller);l.init({osciCanvas:c,specCanvas:d,scrollCanvas:e,waveColor:"white",progressColor:"grey",loadingColor:"purple",cursorColor:"red",tierInfos:b,draggableBar:f,timeline:g,tiers:h,fileSelect:i,showLeftPush:j,spectroworker:k,font:"12px Verdana",internalCanvasWidth:"2048",internalCanvasHeightSmall:"128",internalCanvasHeightBig:"64",mode:"standalone"});var m=null!==navigator.userAgent.match(/iPad/i);return(m||a)&&(l.iohandler.xhrLoad("data/msajc003.TextGrid",3),l.load("data/msajc003.wav")),$("#fileGetterBtn")[0].addEventListener("change",l.fileAPIread,!1),$("#dialog-messageSh").hide(),$("#dialog-messageSetLabel").hide(),$("#specSettings").click(function(){var a=$("#specDialog").dialog("isOpen");a?($("#specDialog").dialog("close"),a=!1):($("#specDialog").dialog("open"),$("#specDialog").dialog("moveToTop"),a=!0)}),document.querySelector("#fileSelect").addEventListener("click",function(){document.querySelector("#fileGetterBtn").click()},!1),document.addEventListener("keyup",function(a){if(!emulabeller.isModalShowing&&emulabeller.internalMode==l.EDITMODE.LABEL_RENAME){var b=a.keyCode?a.keyCode:a.which;27==b&&emulabeller.tierHandler.removeLabelDoubleClick()}}),document.addEventListener("keypress",function(a){emulabeller.isModalShowing||emulabeller.internalMode==l.EDITMODE.LABEL_RENAME||(32==a.keyCode&&(a.preventDefault(),emulabeller.playPauseInView()),114==a.keyCode&&emulabeller.playInMode("sel"),102==a.keyCode&&emulabeller.playInMode("all"),119==a.keyCode&&emulabeller.zoomViewPort(1),115==a.keyCode&&emulabeller.zoomViewPort(0),100==a.keyCode&&emulabeller.shiftViewP(1),97==a.keyCode&&emulabeller.shiftViewP(0),113==a.keyCode&&emulabeller.setView(-1/0,1/0),101==a.keyCode&&emulabeller.zoomSel(),116==a.keyCode&&emulabeller.snapSelectedSegmentToNearestTop(),98==a.keyCode&&emulabeller.snapSelectedSegmentToNearestBottom(),111==a.keyCode&&(emulabeller.externalMode==l.USAGEMODE.STANDALONE&&$("#fileGetterBtn").click(),emulabeller.externalMode==l.USAGEMODE.SERVER&&emulabeller.openSubmenu()),99==a.keyCode&&emulabeller.editLabel(),13==a.keyCode&&emulabeller.addSegmentAtSelection(),console.log(a.keyCode))}),l}();
/*
//@ sourceMappingURL=emuLVC.min.map
*/